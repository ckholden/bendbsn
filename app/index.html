<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com https://cdn.emailjs.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; connect-src 'self' https://script.google.com https://*.firebaseio.com https://*.googleapis.com https://formsubmit.co https://en.wikipedia.org wss://*.firebaseio.com; img-src 'self' data: blob: https:;">
    <script>if(location.protocol !== 'https:' && location.hostname !== 'localhost'){location.replace('https:' + location.href.substring(location.protocol.length));}</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="theme-color" content="#1f4e79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSN9B">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="icon" type="image/png" href="/favicon.png?v=3">
    <link rel="shortcut icon" href="/favicon.png?v=3">
    <!-- Preconnect hints for faster external resource loading -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="stylesheet" href="/shared/header.css">
    <title>BSN9B Nursing Documentation</title>
    <script>
        if (localStorage.getItem('bsn9b_auth') !== 'true') {
            window.location.href = '/';
        }
    </script>
    <!-- Export libraries loaded on-demand via lazy loading (see loadExportLibrary function) -->
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-page: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #fafafa;
            --bg-input: #fafafa;
            --bg-input-focus: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #666666;
            --text-muted: #888888;
            --accent: #1f4e79;
            --accent-light: #2d5a87;
            --accent-hover: #f8fafc;
            --border: #e0e0e0;
            --border-light: #ddd;
            --border-focus: #1f4e79;
            --shadow: rgba(0,0,0,0.4);
            --shadow-light: rgba(0,0,0,0.15);
            --warning-bg: #fff5f5;
            --warning-border: #e53e3e;
            --warning-text: #c53030;
            --info-bg: #fffbeb;
            --info-border: #d69e2e;
            --btn-clear-bg: #f0f0f0;
            --btn-clear-text: #333333;
            --card-active-bg: #1f4e79;
            --card-active-text: #ffffff;
            --nanda-bg: #f8fafc;
            --nanda-border: #e2e8f0;
            --chat-msg-other-bg: #e2e8f0;
            --chat-msg-other-text: #333333;
        }

        [data-theme="dark"] {
            --bg-page: linear-gradient(135deg, #0a0a14 0%, #0d1117 50%, #161b22 100%);
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #1e2a3a;
            --bg-input: #16213e;
            --bg-input-focus: #1e2a3a;
            --text-primary: #e6e6e6;
            --text-secondary: #aaaaaa;
            --text-muted: #888888;
            --accent: #4a90d9;
            --accent-light: #5a9fe8;
            --accent-hover: #1e2a3a;
            --border: #2d3748;
            --border-light: #3d4758;
            --border-focus: #4a90d9;
            --shadow: rgba(0,0,0,0.6);
            --shadow-light: rgba(0,0,0,0.3);
            --warning-bg: #2d1f1f;
            --warning-border: #e53e3e;
            --warning-text: #fc8181;
            --info-bg: #2d2a1f;
            --info-border: #d69e2e;
            --btn-clear-bg: #2d3748;
            --btn-clear-text: #e6e6e6;
            --card-active-bg: #4a90d9;
            --card-active-text: #ffffff;
            --nanda-bg: #16213e;
            --nanda-border: #2d3748;
            --chat-msg-other-bg: #2d3748;
            --chat-msg-other-text: #e6e6e6;
        }

        /* Status indicator colors for presence */
        .status-online { background: #22c55e; }  /* Green */
        .status-away { background: #eab308; }    /* Yellow */
        .status-offline { background: #6b7280; } /* Gray */

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* Loading state for buttons */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: btn-spin 0.8s linear infinite;
        }
        @keyframes btn-spin {
            to { transform: rotate(360deg); }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-page);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
            transition: background 0.3s ease;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 16px;
            box-shadow: 0 20px 60px var(--shadow);
            overflow: hidden;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        .header {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 13px; }
        .form-container { padding: 30px; background: var(--bg-primary); transition: background 0.3s ease; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; font-size: 13px; transition: color 0.3s ease; }
        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--bg-input);
            color: var(--text-primary);
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(31, 78, 121, 0.1);
            background: var(--bg-input-focus);
        }
        textarea { min-height: 80px; resize: vertical; }
        textarea.large { min-height: 120px; }
        .note-type-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .note-type-card {
            padding: 14px 8px;
            border: 2px solid var(--border);
            background: var(--bg-primary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: var(--text-primary);
        }
        .note-type-card:hover { border-color: var(--accent); background: var(--accent-hover); }
        .note-type-card.active {
            border-color: var(--accent);
            background: var(--card-active-bg);
            color: var(--card-active-text);
        }
        .note-type-card h3 { font-size: 15px; margin-bottom: 3px; }
        .note-type-card p { font-size: 9px; opacity: 0.8; }
        .section-title {
            font-size: 16px;
            color: var(--accent);
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent);
        }
        .note-fields { display: none; }
        .note-fields.active { display: block; }
        .field-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .field-letter {
            width: 28px; height: 28px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
        }
        .field-info h4 { font-size: 13px; color: var(--text-primary); }
        .field-info p { font-size: 11px; color: var(--text-secondary); }
        .btn-container { display: flex; gap: 12px; margin-top: 25px; }
        .btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-pdf { background: var(--accent); color: white; }
        .btn-word { background: var(--accent-light); color: white; }
        .btn-clear { background: var(--btn-clear-bg); color: var(--btn-clear-text); flex: 0.4; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px var(--shadow-light); }
        .warning-box {
            background: var(--warning-bg);
            border: 1px solid var(--warning-border);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 12px;
            color: var(--warning-text);
        }
        .info-box {
            background: var(--info-bg);
            border: 1px solid var(--info-border);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 12px;
            color: var(--text-primary);
        }
        .info-box ul { margin: 8px 0 0 18px; }
        .info-box li { margin-bottom: 3px; }
        /* NANDA Search */
        .nanda-section { margin: 20px 0; padding: 15px; background: var(--nanda-bg); border-radius: 10px; border: 1px solid var(--nanda-border); transition: background 0.3s ease, border-color 0.3s ease; }
        .nanda-search { position: relative; }
        .nanda-search input { padding-right: 35px; }
        .nanda-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-light);
            z-index: 100;
            display: none;
        }
        .nanda-dropdown.show { display: block; }
        .nanda-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-primary);
        }
        .nanda-item:hover { background: var(--accent-hover); }
        .nanda-item .category { font-size: 10px; color: var(--accent); font-weight: 600; }
        .selected-diagnoses { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .diagnosis-tag {
            background: var(--accent);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .diagnosis-tag .remove { cursor: pointer; opacity: 0.8; }
        .diagnosis-tag .remove:hover { opacity: 1; }
        /* H2T Assessment */
        .h2t-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .h2t-section { background: var(--nanda-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--nanda-border); transition: background 0.3s ease, border-color 0.3s ease; }
        .h2t-section h4 { font-size: 13px; color: var(--accent); margin-bottom: 8px; border-bottom: 1px solid var(--nanda-border); padding-bottom: 5px; }
        .quick-fills { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
        .quick-fill {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }
        .quick-fill:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .h2t-section textarea { min-height: 60px; font-size: 12px; }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 10px;
            transition: color 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .toolbar-item:hover { color: var(--accent); }
        .toolbar-item.active { color: var(--accent); }
        .toolbar-item .icon { font-size: 24px; margin-bottom: 2px; }
        .toolbar-item .label { font-weight: 600; }

        .mobile-action-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 60px;
            display: none;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(255,255,255,0.96);
            border-top: 1px solid #e2e8f0;
            box-shadow: 0 -6px 20px rgba(0,0,0,0.08);
            z-index: 1001;
            backdrop-filter: blur(8px);
        }

        .mobile-action-btn {
            flex: 1;
            border: none;
            border-radius: 10px;
            padding: 10px 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            color: white;
        }

        .mobile-action-btn.save { background: linear-gradient(135deg, #10b981, #059669); }
        .mobile-action-btn.copy { background: linear-gradient(135deg, #0f766e, #0d9488); }
        .mobile-action-btn.pdf { background: linear-gradient(135deg, #1f4e79, #2d5a87); }
        .mobile-action-btn.word { background: linear-gradient(135deg, #7c3aed, #8b5cf6); }

        .mobile-action-status {
            display: none;
            position: fixed;
            right: 12px;
            bottom: 120px;
            background: #0f172a;
            color: white;
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 999px;
            z-index: 1002;
            opacity: 0.9;
        }

        .section-jump-btn {
            position: fixed;
            right: 12px;
            bottom: 130px;
            z-index: 1002;
            display: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #1f4e79, #2d5a87);
            color: white;
            font-size: 18px;
            box-shadow: 0 8px 20px rgba(31,78,121,0.35);
            cursor: pointer;
        }

        .section-jump-panel {
            position: fixed;
            right: 12px;
            bottom: 180px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
            width: 220px;
            max-height: 50vh;
            overflow-y: auto;
            display: none;
            z-index: 1003;
        }

        .section-jump-item {
            padding: 10px 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
            cursor: pointer;
        }
        .section-jump-item:hover { background: #f8fafc; }

        /* More Menu */
        .more-menu {
            position: fixed;
            bottom: 70px;
            right: 10px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 8px 0;
            display: none;
            z-index: 1001;
            min-width: 160px;
            border: 1px solid var(--border);
        }

        .more-menu.show { display: block; }

        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
        }

        .more-menu-item:hover { background: var(--bg-secondary); }
        .more-menu-item .menu-icon { font-size: 18px; }
        /* ========== MOBILE RESPONSIVE STYLES ========== */

        /* Smooth scrolling for all elements */
        html { scroll-behavior: smooth; }

        /* Touch-friendly scrolling */
        .form-container {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* Minimum touch target size (44px recommended by Apple/Google) */
        @media (pointer: coarse) {
            button, .btn, .toolbar-item, .more-menu-item, .note-type-card {
                min-height: 44px;
            }
            select, input[type="checkbox"], input[type="radio"] {
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* Tablet breakpoint (768px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .container { max-width: 90%; }
            .note-type-grid { grid-template-columns: repeat(3, 1fr); }
        }

        /* Tablet/Large phone (max-width: 768px) */
        @media (max-width: 768px) {
            .note-type-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row, .form-row.three-col, .h2t-grid { grid-template-columns: 1fr; }
            .btn-container { flex-direction: column; }

            /* Better spacing for toolbar */
            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            .mobile-action-bar { display: flex; }
            .mobile-action-status { display: block; }
            .section-jump-btn { display: block; }
        }

        /* Mobile: Large phones (max-width: 640px) */
        @media (max-width: 640px) {
            body {
                padding: 10px;
                padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px));
            }
            .container { border-radius: 12px; }
            .header { padding: 20px; }
            .header h1 { font-size: 22px; }
            .form-container { padding: 20px; }

            /* Modal adjustments */
            #phrasesModal > div,
            #feedbackModal > div {
                max-width: calc(100vw - 30px) !important;
                max-height: calc(100vh - 40px) !important;
                margin: 15px !important;
            }

            /* Better textarea sizing */
            textarea {
                min-height: 120px;
            }
        }

        /* Mobile: Standard phones (max-width: 480px) */
        @media (max-width: 480px) {
            body { padding: 8px; }
            .header { padding: 15px; }
            .header h1 { font-size: 20px; }
            .header p { font-size: 11px; }
            .form-container { padding: 15px; }

            .note-type-grid { grid-template-columns: 1fr !important; gap: 8px; }
            .note-type-card { padding: 12px; min-height: 60px; }
            .note-type-card h3 { font-size: 14px; }

            /* Prevent iOS zoom on input focus (minimum 16px) */
            input, select, textarea {
                font-size: 16px !important;
            }

            .btn {
                padding: 16px !important;
                font-size: 15px !important;
                min-height: 50px;
            }

            /* Better form field spacing */
            .form-group {
                margin-bottom: 16px;
            }

            label {
                margin-bottom: 8px;
                display: block;
            }
        }

        /* Mobile: Small phones (max-width: 320px) */
        @media (max-width: 320px) {
            body { padding: 5px; }
            .header h1 { font-size: 18px; }
            .form-container { padding: 12px; }

            .section-title { font-size: 14px; }
            label { font-size: 12px; }

        }

        /* Enhanced mobile styles for quick entry panels */
        @media (max-width: 768px) {
            .vitals-panel, .med-panel {
                padding: 12px 15px;
            }

            .vitals-panel h3, .med-panel h3 {
                font-size: 14px;
            }

            /* Stack buttons vertically on mobile */
            .vitals-panel > div:first-child,
            .med-panel > div:first-child {
                flex-direction: column;
                gap: 10px;
            }

            .vitals-panel > div:first-child > div,
            .med-panel > div:first-child > div {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }

            /* Make quick entry buttons full width on small screens */
            .vitals-panel button,
            .med-panel button {
                flex: 1 1 auto;
                min-width: 120px;
                padding: 12px 14px;
                font-size: 13px;
            }

            /* Better grid for vitals on mobile */
            #vitalsContent > div:first-child {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Better grid for medication fields on mobile */
            #medContent > div:first-child {
                grid-template-columns: 1fr !important;
            }

            /* Larger touch targets for saved entries */
            #savedVitalsEntries > div,
            #savedMedsEntries > div {
                padding: 12px 14px;
            }

            #savedVitalsEntries button,
            #savedMedsEntries button {
                padding: 8px 12px;
                min-height: 36px;
            }
        }

        /* Tablet-specific improvements */
        @media (min-width: 769px) and (max-width: 1024px) {
            /* Better grid layout for vitals on tablet */
            #vitalsContent > div:first-child {
                grid-template-columns: repeat(4, 1fr) !important;
            }

            /* Better form layout on tablets */
            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row.three-col {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Landscape phone orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .header { padding: 10px 20px; }
            .header h1 { font-size: 18px; }
            .header p { display: none; }
            .bottom-toolbar { height: 50px; }
            .toolbar-item .label { display: none; }
        }

        /* Safe area insets for bottom toolbar */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(60px + env(safe-area-inset-bottom));
            }
            body {
                padding-bottom: calc(120px + env(safe-area-inset-bottom));
            }
        }

        /* Drug Autocomplete */
        .drug-autocomplete-wrapper {
            position: relative;
        }
        .drug-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 2px solid #1976d2;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 200;
            display: none;
        }
        .drug-dropdown.show { display: block; }
        .drug-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            color: #333;
        }
        .drug-item:hover { background: #e3f2fd; }
        .drug-item:last-child { border-bottom: none; }
        .drug-loading {
            padding: 10px 12px;
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
        /* Pulse animation for RN Resources button */
        @keyframes pulse-btn {
            0% { box-shadow: 0 4px 15px rgba(255,107,53,0.4); }
            50% { box-shadow: 0 4px 25px rgba(255,107,53,0.7); }
            100% { box-shadow: 0 4px 15px rgba(255,107,53,0.4); }
        }

        /* Focus visible styles for keyboard navigation */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        button:focus-visible, a:focus-visible, .note-type-card:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; max-width: 380px; }
        .toast { padding: 14px 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); display: flex; align-items: flex-start; gap: 12px; animation: toastSlideIn 0.3s ease; color: white; font-size: 14px; line-height: 1.4; }
        .toast.hiding { animation: toastSlideOut 0.3s ease forwards; }
        .toast-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .toast-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .toast-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .toast-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .toast-icon { font-size: 18px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-message { opacity: 0.95; }
        .toast-close { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; font-size: 18px; padding: 0; line-height: 1; }
        .toast-close:hover { opacity: 1; }
        @keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @media (max-width: 480px) { .toast-container { left: 10px; right: 10px; max-width: none; } }
    </style>
</head>
<body>
    <header class="site-header">
        <a href="/home/" class="logo-link"><img src="/logo.png" alt="BendBSN" class="site-logo"></a>
    </header>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
        <div class="header">
            <div id="userDisplayContainer" style="position: absolute; top: 15px; right: 20px;">
                <span id="userDisplay" style="color: rgba(255,255,255,0.8); font-size: 12px;"></span>
            </div>
            <h1>BendBSN Nursing Documentation</h1>
            <p>Progress Notes | Head-to-Toe | NANDA Diagnoses</p>
            <a href="/resources/" style="display: inline-block; margin-top: 15px; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; text-decoration: none; padding: 14px 30px; border-radius: 25px; font-size: 16px; font-weight: 700; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,107,53,0.4); animation: pulse-btn 2s infinite;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(255,107,53,0.6)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(255,107,53,0.4)'">üìö RN Resources - Click Here!</a>
        </div>
        <div class="form-container">
            <div class="warning-box">
                <strong>HIPAA Notice:</strong> Do NOT enter any real patient information including names, initials, DOB, or MRN. Use fictional identifiers only (e.g., "Patient A", "Room 302", "Sim Patient").
            </div>
            <div class="info-box">
                <strong>Quick Start:</strong> Enter info ‚Üí Select format ‚Üí Document ‚Üí Export PDF/Word. Use <strong>Smart Phrases</strong> (üìù button) for shortcuts. <strong>Chat</strong> with classmates (üí¨ bottom-right). Ask the <strong>AI Nursing Companion</strong> (ü©∫ bottom-left) for drug info, care plans, and NCLEX help!
            </div>
            <div id="autoSaveStatus" style="margin-top: 10px; font-size: 12px; color: #64748b;">Draft not saved</div>
            <style>
                @keyframes pulse {
                    0%, 100% { box-shadow: -4px 4px 15px rgba(0,0,0,0.4); }
                    50% { box-shadow: -4px 4px 25px rgba(255,152,0,0.6); }
                }
                .phrase-item { position: relative; cursor: help; padding: 4px 6px; border-radius: 4px; transition: background 0.2s; }
                .phrase-item:hover { background: #e3f2fd; }
                .phrase-item .tooltip {
                    display: none; position: absolute; top: 100%; left: 0;
                    background: #333; color: #fff; padding: 10px 12px; border-radius: 6px;
                    font-size: 12px; white-space: normal; word-wrap: break-word;
                    width: 220px; z-index: 9999;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.5); line-height: 1.5;
                    text-align: left; margin-top: 5px;
                }
                .phrase-item:hover .tooltip { display: block; }
            </style>

            <!-- Smart Phrases Modal with Tooltips -->
            <div id="phrasesModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) this.classList.add('hidden')">
                <div style="background: white; border-radius: 12px; padding: 20px; max-width: 550px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #1f4e79; padding-bottom: 10px;">
                        <h3 style="color: #1f4e79; margin: 0;">üìù Smart Phrases Reference</h3>
                        <button onclick="document.getElementById('phrasesModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Type shortcut + <strong>space</strong> to expand. <em>Hover over any phrase to preview.</em></p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.vs</code> Vital Signs<span class="tooltip">BP: __ | HR: __ | O2: __% | RR: __ | T: __ | Pain: __/10</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.neuro</code> Neuro<span class="tooltip">A&Ox4. PERRLA. GCS 15. MAE x4.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.resp</code> Respiratory<span class="tooltip">CTA bilat. No adventitious sounds. Unlabored. O2: __% on __.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.cv</code> Cardiovascular<span class="tooltip">S1S2 RRR. No murmurs. Pulses 2+ x4. Cap refill <3s. No edema.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.gi</code> GI<span class="tooltip">BS active x4 quads. Abdomen soft, NT, ND. Last BM: __.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.gu</code> GU<span class="tooltip">Voiding without difficulty. Urine clear yellow.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.skin</code> Skin<span class="tooltip">Warm, dry, intact. No breakdown or pressure injuries.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.pain</code> Pain<span class="tooltip">Pain __/10 at __. Quality: __. Duration: __. Interventions: __.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.nkda</code> NKDA<span class="tooltip">NKDA (No Known Drug Allergies).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.denies</code> Denies<span class="tooltip">Patient denies pain, nausea, SOB, dizziness, chest pain.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.aox4</code> A&Ox4<span class="tooltip">Alert and oriented x4 (person, place, time, situation).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.aox3</code> A&Ox3<span class="tooltip">Alert and oriented x3 (person, place, time).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.perrla</code> PERRLA<span class="tooltip">PERRLA (Pupils Equal, Round, Reactive to Light and Accommodation).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.mae</code> MAE<span class="tooltip">MAE x4 (Moving All Extremities).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.cta</code> CTA<span class="tooltip">CTA bilat (Clear to Auscultation bilaterally).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.rrr</code> RRR<span class="tooltip">S1S2 RRR (Regular Rate and Rhythm). No murmurs, rubs, or gallops.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.bsax4</code> BS x4<span class="tooltip">BS active x4 quadrants.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.ntnd</code> NTND<span class="tooltip">Non-tender, non-distended.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.ivp</code> IV Patent<span class="tooltip">IV patent, no redness/swelling at site. Flushed with 10mL NS.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.fs</code> Foley<span class="tooltip">Foley catheter patent, draining clear yellow urine. Secured to thigh.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.medadmin</code> Med Admin<span class="tooltip">Medication administered as ordered. Patient tolerated without adverse effects.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.amb</code> Ambulation<span class="tooltip">Assisted patient with ambulation in hallway. Gait steady, tolerated well.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.fall</code> Fall Risk<span class="tooltip">Fall precautions in place. Bed in low position. Call light within reach.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.safe</code> Safety<span class="tooltip">Side rails up x2. Bed alarm on. Call light in reach. Non-skid socks on.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.wdta</code> Monitor<span class="tooltip">Will continue to monitor. Patient tolerated well. No adverse effects noted.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.wnl</code> WNL<span class="tooltip">Within normal limits.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.nad</code> NAD<span class="tooltip">No acute distress.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.edu</code> Education<span class="tooltip">Patient educated on __. Patient verbalized understanding.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.dc</code> Discharge<span class="tooltip">Discharge instructions reviewed with patient. Patient verbalized understanding.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.tcdb</code> TCDB<span class="tooltip">Encouraged to turn, cough, and deep breathe.</span></div>
                    </div>
                </div>
            </div>

            <!-- Feedback Modal -->
            <div id="feedbackModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) this.classList.add('hidden')">
                <div style="background: white; border-radius: 16px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #4caf50; padding-bottom: 15px;">
                        <h3 style="color: #388e3c; margin: 0;">üí° Feedback & Suggestions</h3>
                        <button onclick="document.getElementById('feedbackModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #888;">√ó</button>
                    </div>
                    <p style="color: #555; font-size: 14px; margin-bottom: 20px;">Help us improve! Report issues, suggest new features, or request new smart phrases.</p>
                    <form action="https://formsubmit.co/christiankholden@gmail.com" method="POST" target="_blank">
                        <input type="hidden" name="_subject" value="BendBSN Feedback/Suggestion">
                        <input type="hidden" name="_captcha" value="false">
                        <input type="hidden" name="_template" value="table">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; color: #333; margin-bottom: 6px; font-size: 13px;">Type</label>
                            <select name="type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                <option value="Bug/Issue">Bug or Issue</option>
                                <option value="Feature Request">Feature Request</option>
                                <option value="Smart Phrase Suggestion">Smart Phrase Suggestion</option>
                                <option value="General Feedback">General Feedback</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; color: #333; margin-bottom: 6px; font-size: 13px;">Your Name (optional)</label>
                            <input type="text" name="name" placeholder="Your name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; color: #333; margin-bottom: 6px; font-size: 13px;">Message</label>
                            <textarea name="message" placeholder="Describe the issue, feature, or suggestion..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; min-height: 120px; resize: vertical;" required></textarea>
                        </div>
                        <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Submit Feedback</button>
                    </form>
                </div>
            </div>

            <h2 class="section-title">Patient & Nurse Information</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Nurse Name</label>
                    <input type="text" id="nurseName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Credentials</label>
                    <select id="credentials">
                        <option value="Student RN">Student RN</option>
                        <option value="RN">RN</option>
                        <option value="BSN, RN">BSN, RN</option>
                        <option value="LPN">LPN</option>
                    </select>
                </div>
            </div>
            <div class="form-row three-col">
                <div class="form-group">
                    <label>Date <span style="font-weight: normal; font-size: 10px; color: #666;">(t=today, t-2, t+1)</span></label>
                    <input type="text" id="noteDate">
                </div>
                <div class="form-group">
                    <label>Time <span style="font-weight: normal; font-size: 10px; color: #666;">(HHMM: n=now, n-30, n+15)</span></label>
                    <input type="text" id="noteTime" placeholder="e.g., 1430">
                </div>
                <div class="form-group">
                    <label>Unit</label>
                    <input type="text" id="unit" placeholder="e.g., Med-Surg 3B">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Patient ID</label>
                    <input type="text" id="patientId" placeholder="e.g., J.D. / Room 302">
                </div>
                <div class="form-group">
                    <label>Demographics</label>
                    <input type="text" id="patientDemo" placeholder="e.g., 42yom">
                </div>
            </div>

            <h2 class="section-title">Documentation Format</h2>
            <div class="note-type-grid">
                <div class="note-type-card active" data-note-type="dar">
                    <h3>DAR</h3>
                    <p>Data, Action, Response</p>
                </div>
                <div class="note-type-card" data-note-type="darp">
                    <h3>DARP</h3>
                    <p>DAR + Plan</p>
                </div>
                <div class="note-type-card" data-note-type="soap">
                    <h3>SOAP</h3>
                    <p>Subj, Obj, Assess, Plan</p>
                </div>
                <div class="note-type-card" data-note-type="sbar">
                    <h3>SBAR</h3>
                    <p>Situation, Background</p>
                </div>
                <div class="note-type-card" data-note-type="pie">
                    <h3>PIE</h3>
                    <p>Problem, Intervention</p>
                </div>
                <div class="note-type-card" data-note-type="h2t">
                    <h3>H2T</h3>
                    <p>Head-to-Toe Assessment</p>
                </div>
                <div class="note-type-card" data-note-type="soapie">
                    <h3>SOAPIE</h3>
                    <p>SOAP + I, E</p>
                </div>
                <div class="note-type-card" data-note-type="narrative">
                    <h3>Narrative</h3>
                    <p>Free-form Note</p>
                </div>
            </div>

            <!-- NANDA Diagnosis Section -->
            <div class="nanda-section">
                <label>NANDA Nursing Diagnoses (optional - search to add)</label>
                <div class="nanda-search">
                    <input type="text" id="nandaSearch" placeholder="Search diagnoses... (e.g., pain, anxiety, mobility)" oninput="searchNanda()" onfocus="searchNanda()">
                    <div class="nanda-dropdown" id="nandaDropdown"></div>
                </div>
                <div class="selected-diagnoses" id="selectedDiagnoses"></div>
            </div>

            <!-- Quick Entry Panels -->
            <h2 class="section-title">Quick Entry Tools</h2>

            <!-- Vitals Quick-Entry Panel -->
            <div class="vitals-panel" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 10px; padding: 15px 20px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="togglePanel('vitalsContent', this)">
                    <h3 style="color: #2e7d32; margin: 0;">ü©∫ Quick Vitals Entry <span style="font-size: 12px; opacity: 0.7;">‚ñ∂</span></h3>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="event.stopPropagation(); saveVitals()" style="background: #1565c0; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;" title="Save to include in export">Save for Export</button>
                        <button onclick="event.stopPropagation(); insertVitals()" style="background: #4caf50; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">Insert Now ‚ûú</button>
                    </div>
                </div>
                <div id="vitalsContent" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">BP (sys/dia)</label>
                        <div style="display: flex; gap: 4px;">
                            <input type="text" id="vsBpSys" placeholder="120" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                            <span style="line-height: 36px;">/</span>
                            <input type="text" id="vsBpDia" placeholder="80" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">HR</label>
                        <input type="text" id="vsHr" placeholder="72" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">RR</label>
                        <input type="text" id="vsRr" placeholder="16" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="2">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">Temp ¬∞F</label>
                        <input type="text" id="vsTemp" placeholder="98.6" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="5">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">O2%</label>
                        <input type="text" id="vsO2" placeholder="98" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">O2 Delivery</label>
                        <select id="vsO2Source" style="width: 100%; padding: 8px; font-size: 11px;">
                            <option value="RA">RA (Room Air)</option>
                            <optgroup label="Nasal Cannula">
                                <option value="1L NC">1L NC</option>
                                <option value="2L NC">2L NC</option>
                                <option value="3L NC">3L NC</option>
                                <option value="4L NC">4L NC</option>
                                <option value="5L NC">5L NC</option>
                                <option value="6L NC">6L NC</option>
                            </optgroup>
                            <optgroup label="Masks">
                                <option value="Simple Mask">Simple Mask</option>
                                <option value="Venturi Mask">Venturi Mask</option>
                                <option value="NRB">Non-Rebreather</option>
                                <option value="Partial Rebreather">Partial Rebreather</option>
                            </optgroup>
                            <optgroup label="High Flow / Advanced">
                                <option value="HFNC">High Flow NC (HFNC)</option>
                                <option value="CPAP">CPAP</option>
                                <option value="BiPAP">BiPAP</option>
                                <option value="Trach Collar">Trach Collar</option>
                                <option value="T-Piece">T-Piece</option>
                                <option value="Vent">Ventilator</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">Pain (0-10)</label>
                        <input type="text" id="vsPain" placeholder="0" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="2">
                    </div>
                </div>
                <p style="margin-top: 8px; font-size: 11px; color: #558b2f;">Click "Save for Export" to save vitals to include in PDF/Word export, or "Insert Now" to add directly to your current text field.</p>
                </div>
                <!-- Saved Vitals List -->
                <div id="savedVitalsList" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #4caf50;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; font-weight: 600; color: #2e7d32;">Saved Vitals (will be included in export):</span>
                        <button onclick="clearSavedVitals()" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 11px; text-decoration: underline;">Clear All</button>
                    </div>
                    <div id="savedVitalsEntries"></div>
                </div>
            </div>

            <!-- Medication Administration Panel -->
            <div class="med-panel" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #1976d2; border-radius: 10px; padding: 15px 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="togglePanel('medContent', this)">
                    <h3 style="color: #1565c0; margin: 0;">üíä Medication Administration <span style="font-size: 12px; opacity: 0.7;">‚ñ∂</span></h3>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="event.stopPropagation(); saveMedication()" style="background: #2e7d32; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;" title="Save to include in export">Save for Export</button>
                        <button onclick="event.stopPropagation(); insertMedication()" style="background: #1976d2; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">Insert Now ‚ûú</button>
                    </div>
                </div>
                <div id="medContent" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                    <div class="drug-autocomplete-wrapper">
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Medication Name</label>
                        <input type="text" id="medName" placeholder="Start typing drug name..." style="width: 100%; padding: 8px; font-size: 13px;" autocomplete="off">
                        <div id="drugDropdown" class="drug-dropdown"></div>
                        <div id="medRecents" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;"></div>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Dose</label>
                        <input type="text" id="medDose" placeholder="e.g., 4mg" style="width: 100%; padding: 8px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Frequency</label>
                        <select id="medFreq" style="width: 100%; padding: 8px; font-size: 12px;">
                            <option value="">‚Äî</option>
                            <option value="Once">Once</option>
                            <option value="Daily">Daily</option>
                            <option value="BID">BID</option>
                            <option value="TID">TID</option>
                            <option value="QID">QID</option>
                            <option value="q4h">q4h</option>
                            <option value="q6h">q6h</option>
                            <option value="q8h">q8h</option>
                            <option value="q12h">q12h</option>
                            <option value="PRN">PRN</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Route</label>
                        <select id="medRoute" style="width: 100%; padding: 8px; font-size: 12px;">
                            <option value="PO">PO (by mouth)</option>
                            <option value="IV">IV (intravenous)</option>
                            <option value="IV Push">IV Push</option>
                            <option value="IVPB">IVPB (piggyback)</option>
                            <option value="IM">IM (intramuscular)</option>
                            <option value="SubQ">SubQ (subcutaneous)</option>
                            <option value="SL">SL (sublingual)</option>
                            <option value="PR">PR (rectal)</option>
                            <option value="Topical">Topical</option>
                            <option value="Inhaled">Inhaled</option>
                            <option value="Nasal">Nasal</option>
                            <option value="Ophthalmic">Ophthalmic</option>
                            <option value="Otic">Otic</option>
                            <option value="Transdermal">Transdermal</option>
                            <option value="GT">GT (gastrostomy)</option>
                            <option value="NGT">NGT (nasogastric)</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Site (if applicable)</label>
                        <select id="medSite" style="width: 100%; padding: 8px; font-size: 12px;">
                            <option value="">N/A</option>
                            <optgroup label="IV Sites">
                                <option value="R hand">R hand</option>
                                <option value="L hand">L hand</option>
                                <option value="R forearm">R forearm</option>
                                <option value="L forearm">L forearm</option>
                                <option value="R AC">R AC (antecubital)</option>
                                <option value="L AC">L AC (antecubital)</option>
                                <option value="PICC">PICC line</option>
                                <option value="Central line">Central line</option>
                                <option value="Port">Port</option>
                            </optgroup>
                            <optgroup label="IM/SubQ Sites">
                                <option value="R deltoid">R deltoid</option>
                                <option value="L deltoid">L deltoid</option>
                                <option value="R vastus lateralis">R vastus lateralis</option>
                                <option value="L vastus lateralis">L vastus lateralis</option>
                                <option value="R ventrogluteal">R ventrogluteal</option>
                                <option value="L ventrogluteal">L ventrogluteal</option>
                                <option value="Abdomen">Abdomen</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Time Given</label>
                        <input type="text" id="medTimeText" placeholder="N=now" style="display:none; width: 100%; padding: 8px; font-size: 13px;">
                        <input type="time" id="medTime" style="width: 100%; padding: 8px; font-size: 13px;" onfocus="showMedTimeShortcut()" onblur="hideMedTimeShortcut()">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Indication</label>
                        <input type="text" id="medIndication" placeholder="e.g., pain, HTN" style="width: 100%; padding: 8px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">PRN Parameters</label>
                        <input type="text" id="medPrnParams" placeholder="e.g., pain >6/10, SBP >160" style="width: 100%; padding: 8px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Effect / Response</label>
                        <input type="text" id="medEffect" placeholder="e.g., pain improved to 3/10" style="width: 100%; padding: 8px; font-size: 13px;">
                    </div>
                </div>
                <p style="margin-top: 8px; font-size: 11px; color: #1565c0;">Click "Save for Export" to save medications to include in PDF/Word export, or "Insert Now" to add directly to your current text field.</p>
                </div>
                <!-- Saved Medications List -->
                <div id="savedMedsList" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #1976d2;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; font-weight: 600; color: #1565c0;">Saved Medications (will be included in export):</span>
                        <button onclick="clearSavedMedications()" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 11px; text-decoration: underline;">Clear All</button>
                    </div>
                    <div id="savedMedsEntries"></div>
                </div>
            </div>

            <!-- Lines/Drains/Airways Structured Panel -->
            <div class="lines-panel" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800; border-radius: 10px; padding: 15px 20px; margin-top: 15px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="togglePanel('linesContent', this)">
                    <h3 style="color: #e65100; margin: 0;">üîó Lines / Drains / Airways <span style="font-size: 12px; opacity: 0.7;">‚ñ∂</span></h3>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="event.stopPropagation(); saveLine()" style="background: #1565c0; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;" title="Save to include in export">Save for Export</button>
                        <button onclick="event.stopPropagation(); insertLine()" style="background: #ff9800; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">Insert Now ‚ûú</button>
                    </div>
                </div>
                <div id="linesContent" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;">
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: #e65100;">Type</label>
                            <select id="lineType" style="width:100%; padding:8px; border:1px solid #ffcc80; border-radius:6px; font-size:13px;">
                                <optgroup label="IV Access">
                                    <option value="PIV">PIV (Peripheral IV)</option>
                                    <option value="PICC">PICC Line</option>
                                    <option value="Central Line">Central Line</option>
                                    <option value="Midline">Midline</option>
                                    <option value="Port">Port-a-Cath</option>
                                </optgroup>
                                <optgroup label="Drains">
                                    <option value="Foley">Foley Catheter</option>
                                    <option value="JP Drain">JP Drain</option>
                                    <option value="Hemovac">Hemovac</option>
                                    <option value="Chest Tube">Chest Tube</option>
                                    <option value="NG Tube">NG Tube</option>
                                    <option value="Wound Vac">Wound Vac</option>
                                </optgroup>
                                <optgroup label="GI Tubes">
                                    <option value="G-Tube">G-Tube</option>
                                    <option value="PEG Tube">PEG Tube</option>
                                    <option value="Dobhoff">Dobhoff</option>
                                </optgroup>
                                <optgroup label="Airway">
                                    <option value="NC">Nasal Cannula</option>
                                    <option value="Simple Mask">Simple Mask</option>
                                    <option value="Non-Rebreather">Non-Rebreather</option>
                                    <option value="Trach">Tracheostomy</option>
                                    <option value="ETT">ETT (Intubated)</option>
                                    <option value="CPAP/BiPAP">CPAP/BiPAP</option>
                                    <option value="High-Flow NC">High-Flow NC</option>
                                </optgroup>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: #e65100;">Location / Site</label>
                            <input type="text" id="lineLocation" placeholder="e.g. R forearm, L subclavian" style="width:100%; padding:8px; border:1px solid #ffcc80; border-radius:6px; font-size:13px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: #e65100;">Size / Gauge</label>
                            <input type="text" id="lineSize" placeholder="e.g. 20g, 18g, 7Fr" style="width:100%; padding:8px; border:1px solid #ffcc80; border-radius:6px; font-size:13px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: #e65100;">Status</label>
                            <select id="lineStatus" style="width:100%; padding:8px; border:1px solid #ffcc80; border-radius:6px; font-size:13px;">
                                <option value="Patent">Patent</option>
                                <option value="Infusing">Infusing</option>
                                <option value="Capped/Saline locked">Capped/Saline locked</option>
                                <option value="Clamped">Clamped</option>
                                <option value="To suction">To suction</option>
                                <option value="To gravity">To gravity</option>
                                <option value="Discontinued">Discontinued</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: #e65100;">Output / Appearance</label>
                            <input type="text" id="lineOutput" placeholder="e.g. clear yellow, serosanguinous 50mL" style="width:100%; padding:8px; border:1px solid #ffcc80; border-radius:6px; font-size:13px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; color: #e65100;">Dressing</label>
                            <input type="text" id="lineDressing" placeholder="e.g. CDI, transparent, dated" style="width:100%; padding:8px; border:1px solid #ffcc80; border-radius:6px; font-size:13px;">
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="font-size: 12px; font-weight: 600; color: #e65100;">Notes</label>
                        <input type="text" id="lineNotes" placeholder="Additional details..." style="width:100%; padding:8px; border:1px solid #ffcc80; border-radius:6px; font-size:13px;">
                    </div>
                </div>
                <div id="savedLinesList" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #ff9800;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; font-weight: 600; color: #e65100;">Saved Lines/Drains/Airways (will be included in export):</span>
                        <button onclick="clearSavedLines()" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 11px; text-decoration: underline;">Clear All</button>
                    </div>
                    <div id="savedLinesEntries"></div>
                </div>
            </div>


            <h2 class="section-title">Documentation</h2>

            <div class="form-group" id="focusGroup">
                <label>FOCUS</label>
                <input type="text" id="focus" placeholder="e.g., Pain management, Fall risk, Post-op care">
            </div>

            <!-- DAR -->
            <div id="darFields" class="note-fields active">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">D</span><div class="field-info"><h4>Data</h4></div></div>
                    <textarea id="darData" class="large" placeholder="Subjective & objective data..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Action</h4></div></div>
                    <textarea id="darAction" class="large" placeholder="Nursing interventions..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">R</span><div class="field-info"><h4>Response/Recommendations</h4></div></div>
                    <textarea id="darResponse" placeholder="Patient response and recommendations..."></textarea>
                </div>
            </div>

            <!-- DARP -->
            <div id="darpFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">D</span><div class="field-info"><h4>Data</h4></div></div>
                    <textarea id="darpData" class="large" placeholder="Subjective & objective data..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Action</h4></div></div>
                    <textarea id="darpAction" placeholder="Nursing interventions..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">R</span><div class="field-info"><h4>Response/Recommendations</h4></div></div>
                    <textarea id="darpResponse" placeholder="Patient response and recommendations..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Plan</h4></div></div>
                    <textarea id="darpPlan" placeholder="Care plan..."></textarea>
                </div>
            </div>

            <!-- SOAP -->
            <div id="soapFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">S</span><div class="field-info"><h4>Subjective</h4></div></div>
                    <textarea id="soapSubjective" class="large" placeholder="Patient statements..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">O</span><div class="field-info"><h4>Objective</h4></div></div>
                    <textarea id="soapObjective" class="large" placeholder="Vital signs, observations..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Assessment</h4></div></div>
                    <textarea id="soapAssessment" placeholder="Nursing diagnosis..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Plan</h4></div></div>
                    <textarea id="soapPlan" placeholder="Care plan..."></textarea>
                </div>
            </div>

            <!-- SOAPIE -->
            <div id="soapieFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">S</span><div class="field-info"><h4>Subjective</h4></div></div>
                    <textarea id="soapieSubjective" placeholder="Patient statements..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">O</span><div class="field-info"><h4>Objective</h4></div></div>
                    <textarea id="soapieObjective" placeholder="VS, observations..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Assessment</h4></div></div>
                    <textarea id="soapieAssessment" placeholder="Nursing diagnosis..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Plan</h4></div></div>
                    <textarea id="soapiePlan" placeholder="Care plan..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">I</span><div class="field-info"><h4>Intervention</h4></div></div>
                    <textarea id="soapieIntervention" placeholder="Actions taken..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">E</span><div class="field-info"><h4>Evaluation</h4></div></div>
                    <textarea id="soapieEvaluation" placeholder="Effectiveness..."></textarea>
                </div>
            </div>

            <!-- SBAR -->
            <div id="sbarFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">S</span><div class="field-info"><h4>Situation</h4></div></div>
                    <textarea id="sbarSituation" class="large" placeholder="What is happening now?"></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">B</span><div class="field-info"><h4>Background</h4></div></div>
                    <textarea id="sbarBackground" class="large" placeholder="Relevant history..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Assessment</h4></div></div>
                    <textarea id="sbarAssessment" placeholder="What do you think is the problem?"></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">R</span><div class="field-info"><h4>Recommendation</h4></div></div>
                    <textarea id="sbarRecommendation" placeholder="What do you need?"></textarea>
                </div>
            </div>

            <!-- PIE -->
            <div id="pieFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Problem</h4></div></div>
                    <textarea id="pieProblem" class="large" placeholder="Nursing diagnosis or problem..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">I</span><div class="field-info"><h4>Intervention</h4></div></div>
                    <textarea id="pieIntervention" class="large" placeholder="Actions taken..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">E</span><div class="field-info"><h4>Evaluation</h4></div></div>
                    <textarea id="pieEvaluation" placeholder="Effectiveness, outcomes..."></textarea>
                </div>
            </div>

            <!-- Narrative -->
            <div id="narrativeFields" class="note-fields">
                <div class="form-group">
                    <label>Narrative Note</label>
                    <textarea id="narrativeText" class="large" style="min-height:200px" placeholder="Document in free-form narrative format..."></textarea>
                </div>
            </div>

            <!-- Head-to-Toe Assessment -->
            <div id="h2tFields" class="note-fields">
                <p style="font-size:12px;color:#666;margin-bottom:15px;">Click quick-fill buttons to insert common findings, then edit as needed.</p>
                <div class="h2t-grid">
                    <div class="h2t-section">
                        <h4>Mental Status</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tMental', 'Alert. ')">Alert</span>
                            <span class="quick-fill" onclick="appendToField('h2tMental', 'A&O x4. ')">A&O x4</span>
                            <span class="quick-fill" onclick="appendToField('h2tMental', 'A&O x3. ')">A&O x3</span>
                            <span class="quick-fill" onclick="appendToField('h2tMental', 'Speech clear. ')">Speech clear</span>
                            <span class="quick-fill" onclick="appendToField('h2tMental', 'Mood euthymic. ')">Mood euthymic</span>
                            <span class="quick-fill" onclick="appendToField('h2tMental', 'Cooperative. ')">Cooperative</span>
                            <span class="quick-fill" onclick="appendToField('h2tMental', 'Memory intact. ')">Memory intact</span>
                        </div>
                        <textarea id="h2tMental" placeholder="LOC (alert/drowsy/lethargic/stuporous), orientation (person/place/time/situation), mood/affect, memory..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>HEENT</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'Head normocephalic and atraumatic. ')">NC/AT</span>
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'Hair/scalp WNL. ')">Hair/Scalp WNL</span>
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'PERRLA. ')">PERRLA</span>
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'EOM intact. ')">EOM intact</span>
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'No nystagmus. ')">No nystagmus</span>
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'Ears clear bilat. ')">Ears clear</span>
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'Nose patent. ')">Nose patent</span>
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'Oral mucosa moist, pink. ')">Mucosa moist</span>
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'Dentation intact. ')">Dentation intact</span>
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'Sinuses non-tender. ')">Sinuses NT</span>
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'Smile symmetric. ')">Smile symmetric</span>
                            <span class="quick-fill" onclick="appendToField('h2tHeent', 'Tongue midline. ')">Tongue midline</span>
                        </div>
                        <textarea id="h2tHeent" placeholder="Hair/scalp, eyes (pupils, EOM, nystagmus), ears, nose/smell, mouth, tongue, mucous membranes, dentation, sinuses..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Neck</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tNeck', 'Lymph nodes non-palpable. ')">Lymph nodes NP</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeck', 'Thyroid midline, non-enlarged. ')">Thyroid WNL</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeck', 'No JVD. ')">No JVD</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeck', 'Trachea midline. ')">Trachea midline</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeck', 'Carotid pulses equal bilat. ')">Carotid equal</span>
                        </div>
                        <textarea id="h2tNeck" placeholder="Lymph nodes, thyroid, JVD, trachea midline, carotid pulses..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Neurological</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'GCS 15. ')">GCS 15</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'MAE x4, strength 5/5. ')">MAE</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'No focal deficits. ')">No deficits</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'Sensation intact bilat. ')">Sensation intact</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'CN II-XII grossly intact. ')">CN intact</span>
                        </div>
                        <textarea id="h2tNeuro" placeholder="LOC, orientation, pupils, EOM, cranial nerves, motor/sensory, GCS, sensation..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Cardiovascular</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'S1S2, RRR, no murmur. ')">S1S2 RRR</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Radial pulses 2+ bilat. ')">Radial 2+</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Cap refill <3 sec. ')">Cap refill <3s</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'No peripheral edema. ')">No edema</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Pedal pulses palpable bilat. ')">Pedal pulses</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Apical pulse regular. ')">Apical regular</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'No murmur, gallop, or rub. ')">No MGR</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Brachial pulses 2+ bilat. ')">Brachial 2+</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Extremities warm bilat. ')">Warm bilat</span>
                        </div>
                        <textarea id="h2tCardio" placeholder="Heart sounds (aortic/pulmonic/Erb's/tricuspid/mitral), apical pulse, radial/brachial/pedal pulses, edema, cap refill, extremity temp..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Respiratory</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'CTA bilat. ')">CTA bilat</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'Unlabored, regular. ')">Unlabored</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'RA, SpO2 WNL. ')">RA</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'O2 via NC _L/min. ')">O2 NC</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'No cough, no SOB. ')">No cough/SOB</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'Chest expansion symmetric. ')">Chest symmetric</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'No sputum production. ')">No sputum</span>
                        </div>
                        <textarea id="h2tResp" placeholder="Breath sounds (front/back, upper/mid/lower), effort, O2, cough/sputum, chest symmetry, skin turgor..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Gastrointestinal</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'BS active x4 quads. ')">BS active x4</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'Soft, non-tender, non-distended. ')">Soft NT ND</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'Last BM: ___. ')">Last BM</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'Tolerating diet. ')">Tolerating diet</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'No N/V. ')">No N/V</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'Tympanic to percussion. ')">Tympanic</span>
                        </div>
                        <textarea id="h2tGI" placeholder="Inspection, auscultation (LUQ/LLQ/RUQ/RLQ), palpation, percussion, BM, diet, N/V..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Genitourinary</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'Voiding without difficulty. ')">Voiding WNL</span>
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'Foley patent, clear yellow urine. ')">Foley patent</span>
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'Last void: ___. ')">Last void</span>
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'I&O balanced. ')">I&O balanced</span>
                        </div>
                        <textarea id="h2tGU" placeholder="Voiding, Foley, output, color..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Skin/Integumentary</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'Warm, dry, intact. ')">WDI</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'Color appropriate. ')">Color WNL</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'Turgor elastic. ')">Turgor elastic</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'No breakdown, no pressure areas. ')">No breakdown</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'IV site: ___. ')">IV site</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'No rashes or lesions. ')">No rashes</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'Hair distribution WNL. ')">Hair WNL</span>
                        </div>
                        <textarea id="h2tSkin" placeholder="Description, color, temp, turgor (clavicle), wounds, IV sites, rashes, hair distribution, Braden score..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Musculoskeletal</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'ROM intact bilat. ')">ROM intact</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Gait steady. ')">Gait steady</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Ambulating independently. ')">Ambulating</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Bed rest. ')">Bed rest</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Grip strength equal bilat. ')">Grip equal</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Muscle strength 5/5 bilat. ')">Strength 5/5</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Romberg negative. ')">Romberg neg</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Balance steady. ')">Balance steady</span>
                        </div>
                        <textarea id="h2tMSK" placeholder="ROM (active/passive, upper/lower), gait, grip strength, muscle strength, Romberg, balance, fall risk..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Pain/Comfort</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Pain 0/10. ')">Pain 0/10</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Pain ___/10 at ___. ')">Pain __/10</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Denies pain. ')">Denies pain</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Medicated for pain. ')">Medicated</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Acute onset. ')">Acute</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Chronic. ')">Chronic</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Non-pharmacological measures. ')">Non-pharm</span>
                        </div>
                        <textarea id="h2tPain" placeholder="Acute/chronic, intensity (0-10), location, duration, characteristics, precipitating factors, non-verbal cues, better/worse, affects sleep..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Safety / Risk</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tSafety', 'Fall risk precautions in place. ')">Fall risk</span>
                            <span class="quick-fill" onclick="appendToField('h2tSafety', 'Bed low, call light within reach. ')">Call light</span>
                            <span class="quick-fill" onclick="appendToField('h2tSafety', 'Denies SI/HI. ')">Denies SI/HI</span>
                        </div>
                        <textarea id="h2tSafety" placeholder="Fall risk, suicide risk, restraints, safety measures..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Lines/Drains/Airway</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tLines', 'PIV patent, dressing CDI. ')">PIV</span>
                        </div>
                        <textarea id="h2tLines" placeholder="IV/lines, drains, O2/airway devices... (Use Lines/Drains panel in Quick Entry above for structured entry)"></textarea>
                    </div>
                </div>


                <!-- PHQ-9 Collapsible Panel -->
                <div class="phq9-panel" style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); border: 2px solid #e91e63; border-radius: 10px; padding: 15px 20px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="togglePanel('phq9Content', this)">
                        <h3 style="color: #880e4f; margin: 0;">üß† PHQ-9 Depression Screening <span style="font-size: 12px; opacity: 0.7;">‚ñ∂</span></h3>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="event.stopPropagation(); saveScreening('phq9')" style="background: #1565c0; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;" title="Save to include in export">Save for Export</button>
                            <button onclick="event.stopPropagation(); insertScreening('phq9')" style="background: #e91e63; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">Insert Now ‚ûú</button>
                        </div>
                    </div>
                    <div id="phq9Content" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 80px; gap: 6px; font-size: 12px; margin-top: 12px;">
                            <div>1. Little interest or pleasure</div>
                            <select id="phq1" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>2. Feeling down, depressed, hopeless</div>
                            <select id="phq2" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>3. Trouble sleeping</div>
                            <select id="phq3" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>4. Feeling tired or low energy</div>
                            <select id="phq4" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>5. Poor appetite or overeating</div>
                            <select id="phq5" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>6. Feeling bad about self</div>
                            <select id="phq6" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>7. Trouble concentrating</div>
                            <select id="phq7" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>8. Psychomotor changes</div>
                            <select id="phq8" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>9. Thoughts of self-harm</div>
                            <select id="phq9" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        </div>
                        <div style="margin-top: 8px; font-size: 13px; font-weight: 600; color: #880e4f;">PHQ-9 Total: <strong id="phq9Score">0</strong> <span id="phq9Severity" style="font-weight:400; font-size:12px;"></span></div>
                    </div>
                    <div id="savedPhq9List" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e91e63;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 12px; font-weight: 600; color: #880e4f;">Saved PHQ-9 Screenings (will be included in export):</span>
                            <button onclick="clearSavedScreenings('phq9')" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 11px; text-decoration: underline;">Clear All</button>
                        </div>
                        <div id="savedPhq9Entries"></div>
                    </div>
                </div>

                <!-- GAD-7 Collapsible Panel -->
                <div class="gad7-panel" style="background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%); border: 2px solid #7c4dff; border-radius: 10px; padding: 15px 20px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="togglePanel('gad7Content', this)">
                        <h3 style="color: #4a148c; margin: 0;">üí≠ GAD-7 Anxiety Screening <span style="font-size: 12px; opacity: 0.7;">‚ñ∂</span></h3>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="event.stopPropagation(); saveScreening('gad7')" style="background: #1565c0; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;" title="Save to include in export">Save for Export</button>
                            <button onclick="event.stopPropagation(); insertScreening('gad7')" style="background: #7c4dff; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">Insert Now ‚ûú</button>
                        </div>
                    </div>
                    <div id="gad7Content" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 80px; gap: 6px; font-size: 12px; margin-top: 12px;">
                            <div>1. Feeling nervous or on edge</div>
                            <select id="gad1" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>2. Not able to stop worrying</div>
                            <select id="gad2" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>3. Worrying too much</div>
                            <select id="gad3" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>4. Trouble relaxing</div>
                            <select id="gad4" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>5. Restless</div>
                            <select id="gad5" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>6. Easily annoyed</div>
                            <select id="gad6" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                            <div>7. Afraid something awful</div>
                            <select id="gad7" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        </div>
                        <div style="margin-top: 8px; font-size: 13px; font-weight: 600; color: #4a148c;">GAD-7 Total: <strong id="gad7Score">0</strong> <span id="gad7Severity" style="font-weight:400; font-size:12px;"></span></div>
                    </div>
                    <div id="savedGad7List" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #7c4dff;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 12px; font-weight: 600; color: #4a148c;">Saved GAD-7 Screenings (will be included in export):</span>
                            <button onclick="clearSavedScreenings('gad7')" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 11px; text-decoration: underline;">Clear All</button>
                        </div>
                        <div id="savedGad7Entries"></div>
                    </div>
                </div>

                <div class="form-group" style="margin-top:15px;">
                    <label>Psychosocial/Additional Notes</label>
                    <textarea id="h2tPsych" placeholder="Mood, behavior, support system, safety concerns, plan..."></textarea>
                    <button type="button" onclick="insertMentalHealthSummary()" style="margin-top: 6px; background: #1f4e79; color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 11px; cursor: pointer;">Insert MH Summary</button>
                </div>
            </div>

            <div class="btn-container">
                <button class="btn btn-clear" onclick="clearForm()">Clear</button>
                <button class="btn btn-word" id="btnExportWord" onclick="generateWord(this)">Export Word</button>
                <button class="btn btn-pdf" id="btnExportPdf" onclick="generatePDF(this)">Export PDF</button>
            </div>

            <!-- Document History Section -->
            <div style="margin-top: 20px; padding: 15px; background: var(--nanda-bg); border-radius: 10px; border: 1px solid var(--nanda-border); transition: background 0.3s ease, border-color 0.3s ease;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <h3 style="color: var(--accent); margin: 0; font-size: 14px;">üìÅ Document History</h3>
                        <p style="color: var(--text-secondary); font-size: 11px; margin-top: 4px;">Save notes to your account for later retrieval</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="saveToHistory()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;">
                            üíæ Save to History
                        </button>
                        <button onclick="openHistoryModal()" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;">
                            üìÇ View History
                        </button>
                    </div>
                </div>
            </div>

                    </div>
    </div>

    <!-- Document History Modal -->
    <div id="historyModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) this.classList.add('hidden')">
        <div style="background: var(--bg-primary); border-radius: 16px; padding: 25px; max-width: 700px; width: 90%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px var(--shadow);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--accent); padding-bottom: 15px;">
                <h3 style="color: var(--accent); margin: 0;">üìÇ Saved Documents</h3>
                <button onclick="document.getElementById('historyModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">√ó</button>
            </div>

            <!-- Search/Filter -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="historySearch" placeholder="Search by patient name or note type..." oninput="filterHistory()" style="width: 100%; padding: 10px 14px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-primary);">
            </div>

            <!-- Documents List -->
            <div id="historyList" style="flex: 1; overflow-y: auto; min-height: 200px;">
                <p style="text-align: center; color: var(--text-secondary); padding: 40px;">Loading saved documents...</p>
            </div>
        </div>
    </div>

    <!-- Lock Screen Overlay -->
    <div id="lockScreenOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); z-index: 99999; align-items: center; justify-content: center; flex-direction: column;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px;">üîí</div>
            <h1 style="font-size: 42px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">BSN9B</h1>
            <p style="font-size: 18px; opacity: 0.8; margin-bottom: 40px;">Portal Locked</p>
            <button onclick="unlockScreen()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 18px 50px; border-radius: 30px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 12px 40px rgba(59, 130, 246, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 8px 30px rgba(59, 130, 246, 0.4)'">
                üîì Unlock Portal
            </button>
            <p style="margin-top: 30px; font-size: 12px; opacity: 0.5;">Click unlock to return to your session</p>
        </div>
    </div>

    <!-- Alert/FYI Banners - Fixed at top -->
    <div id="alertBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 10000; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5); animation: softFlashAlert 2s ease-in-out infinite;">
        <span id="alertText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.8;">‚ö†Ô∏è ALERT</span>
    </div>
    <div id="fyiBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a1a2e; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 9999; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); animation: softFlashFyi 2s ease-in-out infinite;">
        <span id="fyiText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.7;">‚ÑπÔ∏è FYI</span>
    </div>
    <style>
        @keyframes softFlashAlert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        @keyframes softFlashFyi {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        body.has-alert { padding-top: 50px; }
        body.has-fyi { padding-top: 50px; }
        body.has-alert.has-fyi { padding-top: 100px; }
    </style>

    <footer style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6); font-size: 12px;">
        BSN9B Nursing Documentation Tool
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            If you'd like to contribute to the cost of this service, please <a href="https://venmo.com/ChristianKSHolden" target="_blank" style="color: #3d95ce; text-decoration: none;">donate here</a>.
        </div>
    </footer>

    <style>
        /* Dark mode support for modals and dynamic elements */
        [data-theme="dark"] #phrasesModal > div,
        [data-theme="dark"] #feedbackModal > div {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        [data-theme="dark"] #phrasesModal input,
        [data-theme="dark"] #phrasesModal select,
        [data-theme="dark"] #phrasesModal textarea,
        [data-theme="dark"] #feedbackModal input,
        [data-theme="dark"] #feedbackModal select,
        [data-theme="dark"] #feedbackModal textarea {
            background: var(--bg-input);
            color: var(--text-primary);
            border-color: var(--border-light);
        }
        [data-theme="dark"] .phrase-item:hover {
            background: var(--accent-hover);
        }
        [data-theme="dark"] .phrase-item .tooltip {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        [data-theme="dark"] .vitals-panel,
        [data-theme="dark"] .med-panel,
        [data-theme="dark"] .lines-panel,
        [data-theme="dark"] .phq9-panel,
        [data-theme="dark"] .gad7-panel {
            background: var(--bg-secondary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] .vitals-panel input,
        [data-theme="dark"] .vitals-panel select,
        [data-theme="dark"] .med-panel input,
        [data-theme="dark"] .med-panel select,
        [data-theme="dark"] .lines-panel input,
        [data-theme="dark"] .lines-panel select,
        [data-theme="dark"] .phq9-panel select,
        [data-theme="dark"] .gad7-panel select {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-light) !important;
        }
        [data-theme="dark"] .lines-panel h3,
        [data-theme="dark"] .lines-panel label { color: var(--text-primary) !important; }
        [data-theme="dark"] .phq9-panel h3,
        [data-theme="dark"] .phq9-panel div { color: var(--text-primary) !important; }
        [data-theme="dark"] .gad7-panel h3,
        [data-theme="dark"] .gad7-panel div { color: var(--text-primary) !important; }
        [data-theme="dark"] .drug-dropdown {
            background: var(--bg-primary) !important;
            border-color: var(--accent) !important;
        }
        [data-theme="dark"] .drug-item {
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] .drug-item:hover {
            background: var(--accent-hover) !important;
        }
        [data-theme="dark"] #historyModal > div {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #historyList > div {
            background: var(--bg-secondary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #historySearch {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
        }
    </style>

    <!-- Chat and AI widgets removed - now at /chat/ and /ai/ -->
    <div class="mobile-action-bar" id="mobileActionBar">
        <button class="mobile-action-btn save" onclick="saveToHistory()">Save</button>
        <button class="mobile-action-btn copy" onclick="copyNoteToClipboard()">Copy</button>
        <button class="mobile-action-btn pdf" onclick="generatePDF(document.getElementById('btnExportPdf'))">PDF</button>
        <button class="mobile-action-btn word" onclick="generateWord(document.getElementById('btnExportWord'))">Word</button>
    </div>
    <div class="mobile-action-status" id="mobileActionStatus">Draft saved</div>
    <button class="section-jump-btn" id="sectionJumpBtn" onclick="toggleSectionJump()">‚ò∞</button>
    <div class="section-jump-panel" id="sectionJumpPanel"></div>

    <!-- Bottom Toolbar -->
    <nav class="bottom-toolbar" role="navigation" aria-label="Main navigation">
        <a href="/home/" class="toolbar-item" aria-label="Home">
            <span class="icon" aria-hidden="true">üè†</span>
            <span class="label">Home</span>
        </a>
        <a href="/app/" class="toolbar-item active" aria-label="RN Notes" aria-current="page">
            <span class="icon" aria-hidden="true">üìù</span>
            <span class="label">RN Notes</span>
        </a>
        <a href="/chat/" class="toolbar-item" aria-label="Chat" target="_blank">
            <span class="icon" aria-hidden="true">üí¨</span>
            <span class="label">Chat</span>
        </a>
        <a href="/ai/" class="toolbar-item" aria-label="AI Assistant" target="_blank">
            <span class="icon" aria-hidden="true">ü©∫</span>
            <span class="label">AI</span>
        </a>
        <a href="/community/" class="toolbar-item" aria-label="Community">
            <span class="icon" aria-hidden="true">üë•</span>
            <span class="label">Community</span>
        </a>
        <a href="/resources/" class="toolbar-item" aria-label="Resources">
            <span class="icon" aria-hidden="true">üìö</span>
            <span class="label">Resources</span>
        </a>
        <button class="toolbar-item" onclick="toggleMoreMenu()" aria-label="More options" aria-expanded="false" aria-controls="moreMenu">
            <span class="icon" aria-hidden="true">‚ãØ</span>
            <span class="label">More</span>
        </button>
    </nav>

    <!-- More Menu -->
    <div id="moreMenu" class="more-menu" role="menu" aria-label="Additional options">
        <button class="more-menu-item" role="menuitem" onclick="toggleDarkMode(); toggleMoreMenu();">
            <span class="menu-icon" id="themeMenuIcon" aria-hidden="true">üåô</span>
            <span id="themeMenuText">Dark Mode</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="document.getElementById('phrasesModal').classList.remove('hidden'); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">üìù</span>
            <span>Smart Phrases</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="lockScreen(); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">üîí</span>
            <span>Lock Screen</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="toggleFullscreen(); toggleMoreMenu();" id="fullscreenBtn">
            <span class="menu-icon" aria-hidden="true" id="fullscreenIcon">‚õ∂</span>
            <span id="fullscreenText">Full Screen</span>
        </button>
        <a href="/labsched/" class="more-menu-item" role="menuitem" aria-label="Lab Schedule Generator" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">üìÖ</span>
            <span>Sched Generator</span>
        </a>
        <a href="/apa/" class="more-menu-item" role="menuitem" aria-label="APA Paper Generator" id="apaMenuLink" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">üìÑ</span>
            <span>APA Generator</span>
        </a>
        <a href="/clinical/" class="more-menu-item" role="menuitem" aria-label="Clinical Packet Builder" id="clinicalMenuLink" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">üìã</span>
            <span>Clinical Packet</span>
        </a>
        <button class="more-menu-item" role="menuitem" onclick="document.getElementById('feedbackModal').classList.remove('hidden'); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">üí°</span>
            <span>Feedback</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="logout();">
            <span class="menu-icon" aria-hidden="true">üö™</span>
            <span>Logout</span>
        </button>
    </div>

    <!-- Firebase SDK - must load before inline scripts that use Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ========== FULLSCREEN MODE ==========
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                // Enter fullscreen
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                }
                updateFullscreenUI(true);
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                updateFullscreenUI(false);
            }
        }

        function updateFullscreenUI(isFullscreen) {
            const icon = document.getElementById('fullscreenIcon');
            const text = document.getElementById('fullscreenText');
            if (icon) icon.textContent = isFullscreen ? '‚õ∂' : '‚õ∂';
            if (text) text.textContent = isFullscreen ? 'Exit Full Screen' : 'Full Screen';
        }

        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', () => {
            updateFullscreenUI(!!document.fullscreenElement);
        });
        document.addEventListener('webkitfullscreenchange', () => {
            updateFullscreenUI(!!document.webkitFullscreenElement);
        });

        // ========== TOAST NOTIFICATION SYSTEM ==========
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content"><div class="toast-message">${message.replace(/\n/g, '<br>')}</div></div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, duration);
        }

        // ========== DARK MODE ==========
        function initTheme() {
            const saved = localStorage.getItem('bsn9b_theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcon();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('bsn9b_theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const themeMenuIcon = document.getElementById('themeMenuIcon');
            const themeMenuText = document.getElementById('themeMenuText');
            if (themeMenuIcon) {
                themeMenuIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            }
            if (themeMenuText) {
                themeMenuText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            }
        }

        // More menu toggle
        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const isExpanded = menu.classList.toggle('show');
            if (moreBtn) {
                moreBtn.setAttribute('aria-expanded', isExpanded);
            }
        }

        // Close more menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const moreBtnClicked = e.target.closest('.toolbar-item');
            if (!menu.contains(e.target) && (!moreBtnClicked || !moreBtnClicked.onclick?.toString().includes('toggleMoreMenu'))) {
                menu.classList.remove('show');
                if (moreBtn) {
                    moreBtn.setAttribute('aria-expanded', 'false');
                }
            }
        });

        // Initialize theme immediately before page renders
        initTheme();

        // ========== DOCUMENT HISTORY ==========
        let savedDocuments = [];

        function getUserDocsRef() {
            const uid = getCurrentUserUid();
            if (!uid) return null;
            return database.ref('userDocuments/' + uid);
        }

        async function migrateLegacyDocumentsIfNeeded() {
            try {
                const uid = getCurrentUserUid();
                const email = localStorage.getItem('bsn9b_user');
                if (!uid || !email) return;

                const legacyKey = email.replace(/[.@]/g, '_');
                const newRef = database.ref('userDocuments/' + uid);
                const legacyRef = database.ref('userDocuments/' + legacyKey);

                const newSnap = await newRef.once('value');
                if (newSnap.exists()) return;

                const legacySnap = await legacyRef.once('value');
                if (legacySnap.exists()) {
                    await newRef.set(legacySnap.val());
                    await legacyRef.remove();
                }
            } catch (e) {
                console.warn('Legacy document migration skipped:', e);
            }
        }

        // Save current form to history
        async function saveToHistory() {
            const uid = getCurrentUserUid();
            if (!uid) {
                showToast('Please log in to save documents.', 'warning');
                return;
            }

            const formData = getFormData();
            const noteContent = getNoteContent();

            if (noteContent.length === 0) {
                showToast('Please fill in some documentation before saving.', 'warning');
                return;
            }

            // Get all form field values for the current note type
            const fullContent = {};
            const t = currentNoteType;
            if (t === 'dar') {
                fullContent.darData = document.getElementById('darData').value;
                fullContent.darAction = document.getElementById('darAction').value;
                fullContent.darResponse = document.getElementById('darResponse').value;
            } else if (t === 'darp') {
                fullContent.darpData = document.getElementById('darpData').value;
                fullContent.darpAction = document.getElementById('darpAction').value;
                fullContent.darpResponse = document.getElementById('darpResponse').value;
                fullContent.darpPlan = document.getElementById('darpPlan').value;
            } else if (t === 'soap') {
                fullContent.soapSubjective = document.getElementById('soapSubjective').value;
                fullContent.soapObjective = document.getElementById('soapObjective').value;
                fullContent.soapAssessment = document.getElementById('soapAssessment').value;
                fullContent.soapPlan = document.getElementById('soapPlan').value;
            } else if (t === 'soapie') {
                fullContent.soapieSubjective = document.getElementById('soapieSubjective').value;
                fullContent.soapieObjective = document.getElementById('soapieObjective').value;
                fullContent.soapieAssessment = document.getElementById('soapieAssessment').value;
                fullContent.soapiePlan = document.getElementById('soapiePlan').value;
                fullContent.soapieIntervention = document.getElementById('soapieIntervention').value;
                fullContent.soapieEvaluation = document.getElementById('soapieEvaluation').value;
            } else if (t === 'sbar') {
                fullContent.sbarSituation = document.getElementById('sbarSituation').value;
                fullContent.sbarBackground = document.getElementById('sbarBackground').value;
                fullContent.sbarAssessment = document.getElementById('sbarAssessment').value;
                fullContent.sbarRecommendation = document.getElementById('sbarRecommendation').value;
            } else if (t === 'pie') {
                fullContent.pieProblem = document.getElementById('pieProblem').value;
                fullContent.pieIntervention = document.getElementById('pieIntervention').value;
                fullContent.pieEvaluation = document.getElementById('pieEvaluation').value;
            } else if (t === 'narrative') {
                fullContent.narrativeText = document.getElementById('narrativeText').value;
            } else if (t === 'h2t') {
                fullContent.h2tNeuro = document.getElementById('h2tNeuro').value;
                fullContent.h2tCardio = document.getElementById('h2tCardio').value;
                fullContent.h2tResp = document.getElementById('h2tResp').value;
                fullContent.h2tGI = document.getElementById('h2tGI').value;
                fullContent.h2tGU = document.getElementById('h2tGU').value;
                fullContent.h2tSkin = document.getElementById('h2tSkin').value;
                fullContent.h2tMSK = document.getElementById('h2tMSK').value;
                fullContent.h2tPain = document.getElementById('h2tPain').value;
                fullContent.h2tMental = document.getElementById('h2tMental').value;
                fullContent.h2tSafety = document.getElementById('h2tSafety').value;
                fullContent.h2tLines = document.getElementById('h2tLines').value;
                fullContent.h2tPsych = document.getElementById('h2tPsych').value;
                for (let i = 1; i <= 9; i++) {
                    const el = document.getElementById('phq' + i);
                    if (el) fullContent['phq' + i] = el.value;
                }
                for (let i = 1; i <= 7; i++) {
                    const el = document.getElementById('gad' + i);
                    if (el) fullContent['gad' + i] = el.value;
                }
            }

            // Also save header info
            fullContent.nurseName = formData.nurseName;
            fullContent.credentials = document.getElementById('credentials').value;
            fullContent.noteDate = document.getElementById('noteDate').value;
            fullContent.noteTime = document.getElementById('noteTime').value;
            fullContent.unit = formData.unit;
            fullContent.patientId = formData.patientId;
            fullContent.patientDemo = formData.patientDemo;
            fullContent.focus = formData.focus;
            fullContent.selectedDiagnoses = selectedDiagnoses;

            const docData = {
                noteType: currentNoteType,
                content: fullContent,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                patientName: formData.patientId || 'Unknown Patient'
            };

            try {
                const userDocsRef = getUserDocsRef();
                if (!userDocsRef) {
                    showToast('Please log in to save documents.', 'warning');
                    return;
                }
                await userDocsRef.push(docData);
                clearDraft(currentNoteType);
                updateAutoSaveStatus('Draft cleared after save');
                showToast('Document saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving document:', error);
                showToast('Failed to save document: ' + error.message, 'error');
            }
        }

        // Open history modal and load documents
        function openHistoryModal() {
            document.getElementById('historyModal').classList.remove('hidden');
            loadDocumentHistory();
        }

        // Load document history list
        async function loadDocumentHistory() {
            const uid = getCurrentUserUid();
            if (!uid) {
                document.getElementById('historyList').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Please log in to view saved documents.</p>';
                return;
            }

            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Loading...</p>';

            try {
                const userDocsRef = getUserDocsRef();
                if (!userDocsRef) {
                    document.getElementById('historyList').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Please log in to view saved documents.</p>';
                    return;
                }
                const snapshot = await userDocsRef.orderByChild('createdAt').once('value');

                if (!snapshot.exists()) {
                    historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No saved documents yet. Save a document to see it here!</p>';
                    return;
                }

                savedDocuments = [];
                snapshot.forEach((child) => {
                    savedDocuments.push({
                        id: child.key,
                        ...child.val()
                    });
                });

                // Sort by most recent first
                savedDocuments.sort((a, b) => b.createdAt - a.createdAt);

                renderHistoryList(savedDocuments);
            } catch (error) {
                console.error('Error loading history:', error);
                const errorP = document.createElement('p');
                errorP.style.cssText = 'text-align: center; color: var(--warning-text); padding: 40px;';
                errorP.textContent = 'Error loading documents: ' + error.message;
                historyList.innerHTML = '';
                historyList.appendChild(errorP);
            }
        }

        // Render the history list
        function renderHistoryList(docs) {
            const historyList = document.getElementById('historyList');
            const noteTypeNames = {dar:'DAR', darp:'DARP', soap:'SOAP', soapie:'SOAPIE', sbar:'SBAR', pie:'PIE', h2t:'Head-to-Toe', narrative:'Narrative'};

            if (docs.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No documents match your search.</p>';
                return;
            }

            let html = '';
            docs.forEach((doc) => {
                const date = new Date(doc.createdAt);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                html += `
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 12px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="background: var(--accent); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">${noteTypeNames[doc.noteType] || doc.noteType}</span>
                                    <span style="color: var(--text-secondary); font-size: 12px;">${dateStr} at ${timeStr}</span>
                                </div>
                                <div style="color: var(--text-primary); font-weight: 600; font-size: 14px; margin-bottom: 4px;">
                                    ${doc.patientName || 'Unknown Patient'}
                                </div>
                                ${doc.content && doc.content.unit ? `<div style="color: var(--text-secondary); font-size: 12px;">Unit: ${doc.content.unit}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="loadDocument('${doc.id}')" style="background: var(--accent); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    üì• Load
                                </button>
                                <button onclick="deleteDocument('${doc.id}')" style="background: #ef4444; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            historyList.innerHTML = html;
        }

        // Filter history by search term
        function filterHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const filtered = savedDocuments.filter(doc => {
                const patientName = (doc.patientName || '').toLowerCase();
                const noteType = (doc.noteType || '').toLowerCase();
                const unit = (doc.content && doc.content.unit || '').toLowerCase();
                return patientName.includes(searchTerm) || noteType.includes(searchTerm) || unit.includes(searchTerm);
            });
            renderHistoryList(filtered);
        }

        // Load a specific document into the form
        function loadDocument(docId) {
            try {
                const doc = savedDocuments.find(d => d.id === docId);
                if (!doc || !doc.content) {
                    showToast('Document not found.', 'error');
                    return;
                }

                // Confirm before overwriting current form
                if (!confirm('This will replace your current form data. Continue?')) {
                    return;
                }

                const content = doc.content;

                // Set the note type first - need to simulate click for proper activation
                const noteTypeCard = document.querySelector(`.note-type-card[onclick*="${doc.noteType}"]`);
                if (noteTypeCard) {
                    noteTypeCard.click();
                } else {
                    // Fallback: manually set the note type
                    currentNoteType = doc.noteType;
                    document.querySelectorAll('.note-type-card').forEach(c => c.classList.remove('active'));
                    document.querySelectorAll('.note-fields').forEach(f => f.classList.remove('active'));
                    const fields = document.getElementById(doc.noteType + 'Fields');
                    if (fields) fields.classList.add('active');
                    document.getElementById('focusGroup').style.display = ['dar', 'darp'].includes(doc.noteType) ? 'block' : 'none';
                }

            // Load header info
            if (content.nurseName) document.getElementById('nurseName').value = content.nurseName;
            if (content.credentials) document.getElementById('credentials').value = content.credentials;
            if (content.noteDate) document.getElementById('noteDate').value = content.noteDate;
            if (content.noteTime) document.getElementById('noteTime').value = content.noteTime;
            if (content.unit) document.getElementById('unit').value = content.unit;
            if (content.patientId) document.getElementById('patientId').value = content.patientId;
            if (content.patientDemo) document.getElementById('patientDemo').value = content.patientDemo;
            if (content.focus) document.getElementById('focus').value = content.focus;

            // Load diagnoses
            if (content.selectedDiagnoses && Array.isArray(content.selectedDiagnoses)) {
                selectedDiagnoses = content.selectedDiagnoses;
                renderDiagnoses();
            }

            // Load note-specific fields
            const t = doc.noteType;
            if (t === 'dar') {
                if (content.darData) document.getElementById('darData').value = content.darData;
                if (content.darAction) document.getElementById('darAction').value = content.darAction;
                if (content.darResponse) document.getElementById('darResponse').value = content.darResponse;
            } else if (t === 'darp') {
                if (content.darpData) document.getElementById('darpData').value = content.darpData;
                if (content.darpAction) document.getElementById('darpAction').value = content.darpAction;
                if (content.darpResponse) document.getElementById('darpResponse').value = content.darpResponse;
                if (content.darpPlan) document.getElementById('darpPlan').value = content.darpPlan;
            } else if (t === 'soap') {
                if (content.soapSubjective) document.getElementById('soapSubjective').value = content.soapSubjective;
                if (content.soapObjective) document.getElementById('soapObjective').value = content.soapObjective;
                if (content.soapAssessment) document.getElementById('soapAssessment').value = content.soapAssessment;
                if (content.soapPlan) document.getElementById('soapPlan').value = content.soapPlan;
            } else if (t === 'soapie') {
                if (content.soapieSubjective) document.getElementById('soapieSubjective').value = content.soapieSubjective;
                if (content.soapieObjective) document.getElementById('soapieObjective').value = content.soapieObjective;
                if (content.soapieAssessment) document.getElementById('soapieAssessment').value = content.soapieAssessment;
                if (content.soapiePlan) document.getElementById('soapiePlan').value = content.soapiePlan;
                if (content.soapieIntervention) document.getElementById('soapieIntervention').value = content.soapieIntervention;
                if (content.soapieEvaluation) document.getElementById('soapieEvaluation').value = content.soapieEvaluation;
            } else if (t === 'sbar') {
                if (content.sbarSituation) document.getElementById('sbarSituation').value = content.sbarSituation;
                if (content.sbarBackground) document.getElementById('sbarBackground').value = content.sbarBackground;
                if (content.sbarAssessment) document.getElementById('sbarAssessment').value = content.sbarAssessment;
                if (content.sbarRecommendation) document.getElementById('sbarRecommendation').value = content.sbarRecommendation;
            } else if (t === 'pie') {
                if (content.pieProblem) document.getElementById('pieProblem').value = content.pieProblem;
                if (content.pieIntervention) document.getElementById('pieIntervention').value = content.pieIntervention;
                if (content.pieEvaluation) document.getElementById('pieEvaluation').value = content.pieEvaluation;
            } else if (t === 'narrative') {
                if (content.narrativeText) document.getElementById('narrativeText').value = content.narrativeText;
            } else if (t === 'h2t') {
                if (content.h2tNeuro) document.getElementById('h2tNeuro').value = content.h2tNeuro;
                if (content.h2tCardio) document.getElementById('h2tCardio').value = content.h2tCardio;
                if (content.h2tResp) document.getElementById('h2tResp').value = content.h2tResp;
                if (content.h2tGI) document.getElementById('h2tGI').value = content.h2tGI;
                if (content.h2tGU) document.getElementById('h2tGU').value = content.h2tGU;
                if (content.h2tSkin) document.getElementById('h2tSkin').value = content.h2tSkin;
                if (content.h2tMSK) document.getElementById('h2tMSK').value = content.h2tMSK;
                if (content.h2tPain) document.getElementById('h2tPain').value = content.h2tPain;
                if (content.h2tMental) document.getElementById('h2tMental').value = content.h2tMental;
                if (content.h2tSafety) document.getElementById('h2tSafety').value = content.h2tSafety;
                if (content.h2tLines) document.getElementById('h2tLines').value = content.h2tLines;
                if (content.h2tPsych) document.getElementById('h2tPsych').value = content.h2tPsych;
                for (let i = 1; i <= 9; i++) {
                    const key = 'phq' + i;
                    if (content[key] !== undefined && document.getElementById(key)) {
                        document.getElementById(key).value = content[key];
                    }
                }
                for (let i = 1; i <= 7; i++) {
                    const key = 'gad' + i;
                    if (content[key] !== undefined && document.getElementById(key)) {
                        document.getElementById(key).value = content[key];
                    }
                }
                updatePhq9Score();
                updateGad7Score();
            }

            // Close the modal
            document.getElementById('historyModal').classList.add('hidden');
            showToast('Document loaded successfully!', 'success');
            } catch (e) {
                console.error('Error loading document:', e);
                showToast('Error loading document. Please try again.', 'error');
            }
        }

        // Delete a document
        async function deleteDocument(docId) {
            if (!confirm('Are you sure you want to delete this document? This cannot be undone.')) {
                return;
            }

            const uid = getCurrentUserUid();
            if (!uid) {
                showToast('Please log in to delete documents.', 'warning');
                return;
            }

            try {
                const docRef = database.ref('userDocuments/' + uid + '/' + docId);
                await docRef.remove();
                showToast('Document deleted.', 'success');
                loadDocumentHistory(); // Refresh the list
            } catch (error) {
                console.error('Error deleting document:', error);
                showToast('Failed to delete document: ' + error.message, 'error');
            }
        }

        // Initialize Firebase
        console.log('Initializing Firebase...');
        const firebaseConfig = {
            apiKey: "AIzaSyAmr2W8mekSPJ2pXM3gz1FvarfSBddpfLM",
            authDomain: "bendbsn-17377.firebaseapp.com",
            databaseURL: "https://bendbsn-17377-default-rtdb.firebaseio.com",
            projectId: "bendbsn-17377",
            storageBucket: "bendbsn-17377.firebasestorage.app",
            messagingSenderId: "762882187702",
            appId: "1:762882187702:web:81c97c9eae005666796117"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const SESSION_KEY = 'bsn9b_session_key';
        const SESSION_START_KEY = 'bsn9b_session_start';
        const SESSION_HEARTBEAT_MS = 60000;
        let sessionHeartbeatTimer = null;

        // Presence/Activity timeout constants
        const IDLE_TIMEOUT = 10 * 60 * 1000;   // 10 minutes ‚Üí Away
        const LOGOUT_TIMEOUT = 30 * 60 * 1000; // 30 minutes ‚Üí Logout
        const LOGOUT_WARNING_TIMEOUT = 25 * 60 * 1000; // 25 minutes ‚Üí Show warning
        const ACTIVITY_DEBOUNCE = 30000;       // Debounce Firebase updates
        let idleTimer = null;
        let logoutTimer = null;
        let logoutWarningTimer = null;
        let activityDebounceTimer = null;
        let lastActivityTime = Date.now();
        let currentPresenceStatus = 'online';
        let myPresenceRef = null;

        let sessionValidated = false;

        function updateSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey) return;

            // Only update if session is validated (exists in Firebase)
            if (!sessionValidated) return;

            database.ref('loginHistory/' + sessionKey).update({
                lastSeen: Date.now()
            }).catch(() => {});
        }

        function startSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey) return;

            // Validate session exists in Firebase before starting heartbeat
            database.ref('loginHistory/' + sessionKey).once('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val().timestamp) {
                    sessionValidated = true;
                    updateSessionHeartbeat();
                    if (sessionHeartbeatTimer) clearInterval(sessionHeartbeatTimer);
                    sessionHeartbeatTimer = setInterval(updateSessionHeartbeat, SESSION_HEARTBEAT_MS);
                } else {
                    // Invalid session key - clear it
                    console.warn('Invalid session key, clearing');
                    clearSessionTracking();
                }
            }).catch(() => {
                // Can't validate, don't start heartbeat
            });
        }

        function endSessionTracking(reason) {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey) return;
            if (localStorage.getItem('bsn9b_session_end_sent') === 'true') return;
            if (!sessionValidated) return; // Don't end invalid sessions

            const start = parseInt(localStorage.getItem(SESSION_START_KEY) || '0', 10);
            const end = Date.now();
            const durationSeconds = start ? Math.max(0, Math.round((end - start) / 1000)) : null;
            const durationMinutes = durationSeconds !== null ? Math.round(durationSeconds / 60) : null;
            localStorage.setItem('bsn9b_session_end_sent', 'true');
            database.ref('loginHistory/' + sessionKey).update({
                sessionEnd: end,
                durationSeconds: durationSeconds,
                durationMinutes: durationMinutes,
                endReason: reason || 'logout'
            }).catch(() => {});
        }

        function clearSessionTracking() {
            localStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(SESSION_START_KEY);
            localStorage.removeItem('bsn9b_session_end_sent');
        }

        // End session when user closes tab/browser
        window.addEventListener('pagehide', function(e) {
            endSessionTracking('tab_close');
        });
        window.addEventListener('beforeunload', function(e) {
            endSessionTracking('tab_close');
        });
        // Also end session after inactivity (5 min without heartbeat = session ended)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                // User switched away - record potential end time
                updateSessionHeartbeat();
            }
        });

        const presenceRef = database.ref('chat/presence');
        const bannedRef = database.ref('banned');
        const announcementsRef = database.ref('announcements');
        const userProfilesRef = database.ref('userProfiles');

        // Listen for announcements (alert/fyi banners - inside header)
        function setupAnnouncementListener() {
            announcementsRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                const alertBanner = document.getElementById('alertBanner');
                const fyiBanner = document.getElementById('fyiBanner');
                const alertText = document.getElementById('alertText');
                const fyiText = document.getElementById('fyiText');

                // Handle alert banner
                if (data.alert && data.alert.message) {
                    alertText.textContent = data.alert.message;
                    alertBanner.style.display = 'block';
                    document.body.classList.add('has-alert');
                } else {
                    alertBanner.style.display = 'none';
                    document.body.classList.remove('has-alert');
                }

                // Handle FYI banner (offset if alert is showing)
                if (data.fyi && data.fyi.message) {
                    fyiText.textContent = data.fyi.message;
                    fyiBanner.style.display = 'block';
                    fyiBanner.style.top = (data.alert && data.alert.message) ? '50px' : '0';
                    document.body.classList.add('has-fyi');
                } else {
                    fyiBanner.style.display = 'none';
                    document.body.classList.remove('has-fyi');
                }
            });
        }
        setupAnnouncementListener();

        // Get display name (first name) - stored when user logs in
        let currentUsername = localStorage.getItem('bsn9b_user') || 'Anonymous';
        let displayName = localStorage.getItem('bsn9b_displayName') || currentUsername;
        let currentUserUid = localStorage.getItem('bsn9b_uid') || '';

        function getCurrentUserEmail() {
            return currentUsername || auth.currentUser?.email || localStorage.getItem('bsn9b_user') || '';
        }

        function getCurrentUserUid() {
            return currentUserUid || auth.currentUser?.uid || localStorage.getItem('bsn9b_uid') || '';
        }

        function syncUserProfile(user) {
            if (!user) return;
            const email = user.email || getCurrentUserEmail();
            const name = displayName || user.displayName || (email ? email.split('@')[0] : 'User');
            const firstName = name.split(' ')[0] || name;
            userProfilesRef.child(user.uid).update({
                email: email,
                displayName: name,
                firstName: firstName,
                updatedAt: Date.now()
            });
        }

        // Verify Firebase Auth state and re-authenticate if needed
        let firebaseAuthReady = false;
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Firebase Auth: Logged in as', user.email);
                firebaseAuthReady = true;
                currentUserUid = user.uid;
                currentUsername = user.email || currentUsername;
                if (user.displayName) {
                    displayName = user.displayName;
                }
                localStorage.setItem('bsn9b_uid', currentUserUid);
                localStorage.setItem('bsn9b_user', currentUsername);
                localStorage.setItem('bsn9b_displayName', displayName);
                syncUserProfile(user);
                migrateLegacyDocumentsIfNeeded();

                // Check user role and hide APA link for instructors
                userProfilesRef.child(user.uid).once('value').then((snap) => {
                    const profile = snap.val();
                    if (profile && profile.role === 'Instructor') {
                        const apaLink = document.getElementById('apaMenuLink');
                        if (apaLink) apaLink.style.display = 'none';
                    }
                });
            } else {
                console.log('Firebase Auth: Not logged in, attempting silent re-auth...');
                // If we have session but no Firebase auth, redirect to login
                // This can happen if Firebase auth expired
                if (localStorage.getItem('bsn9b_auth') === 'true') {
                    console.warn('Session exists but Firebase auth lost - may need to re-login');
                }
            }
        });

        // Check if current user is banned
        function checkIfBanned() {
            bannedRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const banned = child.val();
                    if (banned.username === currentUsername || banned.username === displayName) {
                        showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                        localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                        setTimeout(() => { window.location.href = '/'; }, 2000);
                    }
                });
            });
        }
        checkIfBanned();

        // Listen for bans in real-time
        bannedRef.on('child_added', (snapshot) => {
            const banned = snapshot.val();
            if (banned.username === currentUsername || banned.username === displayName) {
                showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                setTimeout(() => { window.location.href = '/'; }, 2000);
            }
        });

        // ========== PRESENCE SYSTEM ==========
        // Set presence using UID as key (prevents duplicates across tabs)
        function setPresence(status = 'online') {
            const uid = getCurrentUserUid();
            if (!uid) return;

            myPresenceRef = presenceRef.child(uid);
            myPresenceRef.set({
                user: displayName,
                username: currentUsername,
                uid: uid,
                status: status,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
            myPresenceRef.onDisconnect().remove();
            currentPresenceStatus = status;
        }

        // Update status without full rewrite
        function updatePresenceStatus(status) {
            const uid = getCurrentUserUid();
            if (!uid) return;
            presenceRef.child(uid).update({
                status: status,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            }).catch(() => {});
            currentPresenceStatus = status;
        }

        // Activity detection - reset idle timers (debounced)
        function recordActivity() {
            lastActivityTime = Date.now();

            // Reset idle/logout/warning timers immediately (local)
            clearTimeout(idleTimer);
            clearTimeout(logoutTimer);
            clearTimeout(logoutWarningTimer);

            // Set idle timer (10 min)
            idleTimer = setTimeout(() => {
                updatePresenceStatus('away');

                // Set logout timer (additional 20 min = 30 min total)
                logoutTimer = setTimeout(() => {
                    logout(); // Full logout
                }, LOGOUT_TIMEOUT - IDLE_TIMEOUT);
            }, IDLE_TIMEOUT);

            // Set warning timer (25 min = 5 min before logout)
            logoutWarningTimer = setTimeout(() => {
                showToast('You will be logged out in 5 minutes due to inactivity. Move your mouse or press a key to stay logged in.', 'warning', 10000);
            }, LOGOUT_WARNING_TIMEOUT);

            // Debounce Firebase updates (don't spam on every mouse move)
            if (activityDebounceTimer) return;

            // If was away, go back online immediately
            if (currentPresenceStatus === 'away') {
                updatePresenceStatus('online');
            }

            activityDebounceTimer = setTimeout(() => {
                activityDebounceTimer = null;
                // Update lastActive timestamp periodically while active
                const uid = getCurrentUserUid();
                if (currentPresenceStatus === 'online' && uid) {
                    presenceRef.child(uid).update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    }).catch(() => {});
                }
            }, ACTIVITY_DEBOUNCE);
        }

        // Initialize activity listeners
        function initActivityTracking() {
            const events = ['mousedown', 'keydown', 'scroll', 'touchstart', 'mousemove'];
            events.forEach(event => {
                document.addEventListener(event, recordActivity, { passive: true });
            });

            // Also track visibility
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    recordActivity();
                }
            });

            // Start initial timer
            recordActivity();
        }

        // Initialize presence (called after auth check)
        setPresence('online');
        initActivityTracking();

        // Re-establish presence on reconnect (handles multi-tab onDisconnect conflicts)
        database.ref('.info/connected').on('value', (snap) => {
            if (snap.val() === true && currentUsername) setPresence(currentPresenceStatus || 'online');
        });

    </script>

    <script>
        // Lazy loading utility for export libraries
        const exportLibraries = {
            jspdf: { url: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', loaded: false },
            docx: { url: 'https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js', loaded: false },
            filesaver: { url: 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js', loaded: false }
        };

        function loadExportLibrary(name) {
            return new Promise((resolve, reject) => {
                const lib = exportLibraries[name];
                if (!lib) {
                    reject(new Error(`Unknown library: ${name}`));
                    return;
                }
                if (lib.loaded) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = lib.url;
                script.onload = () => {
                    lib.loaded = true;
                    resolve();
                };
                script.onerror = () => reject(new Error(`Failed to load ${name}`));
                document.head.appendChild(script);
            });
        }

        // Loading state utility for buttons
        function setButtonLoading(button, loading, originalText = null) {
            if (loading) {
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = '<span style="opacity:0.7">Loading...</span>';
                button.classList.add('btn-loading');
                button.disabled = true;
            } else {
                button.innerHTML = originalText || button.dataset.originalText || button.innerHTML;
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }

        let currentNoteType = 'dar';
        let selectedDiagnoses = [];

        // Google Apps Script API URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec?token=bsn_k7x9m2p4';

        // Display current user (use displayName for friendly name)
        const userDisplayName = localStorage.getItem('bsn9b_displayName') || localStorage.getItem('bsn9b_user') || '';
        if (userDisplayName) {
            document.getElementById('userDisplay').textContent = 'Logged in as: ' + userDisplayName;
        }

        // Logout function
        function logout() {
            endSessionTracking('logout');
            cleanupFirebaseListeners();
            // Clean presence before signing out
            const uid = getCurrentUserUid();
            if (uid) {
                presenceRef.child(uid).remove().catch(() => {});
            }
            // Clear idle/logout/warning timers
            clearTimeout(idleTimer);
            clearTimeout(logoutTimer);
            clearTimeout(logoutWarningTimer);
            clearTimeout(activityDebounceTimer);

            auth.signOut().then(() => {
                localStorage.removeItem('bsn9b_auth');
                localStorage.removeItem('bsn9b_user');
                localStorage.removeItem('bsn9b_displayName');
                localStorage.removeItem('bsn9b_uid');
                clearSessionTracking();
                window.location.href = '/';
            });
        }

        // Lock screen - shows privacy overlay without logging out
        function lockScreen() {
            const overlay = document.getElementById('lockScreenOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        // Unlock screen - hides the privacy overlay
        function unlockScreen() {
            const overlay = document.getElementById('lockScreenOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Persistent login - users stay logged in until they click logout
        // (removed beforeunload auto-logout to enable persistent sessions)

        // Fetch all users from Google Sheet
        async function fetchAllUsers() {
            try {
                const response = await fetch(API_URL + '&action=getUsers');
                const data = await response.json();
                if (data.success) {
                    return data.users;
                }
            } catch (e) {
                console.error('Error fetching users:', e);
            }
            return [];
        }

        // Refresh and display pending users
        async function refreshPendingUsers() {
            const pendingContainer = document.getElementById('pendingUsersList');
            const approvedContainer = document.getElementById('approvedUsersList');

            if (pendingContainer) pendingContainer.innerHTML = '<p style="color: #666; font-style: italic;">Loading...</p>';
            if (approvedContainer) approvedContainer.innerHTML = '<p style="color: #666; font-style: italic;">Loading...</p>';

            const users = await fetchAllUsers();

            const pendingUsers = users.filter(u => u.status === 'pending');
            const approvedUsers = users.filter(u => u.status === 'approved');

            // Render pending users
            if (pendingContainer) {
                if (pendingUsers.length === 0) {
                    pendingContainer.innerHTML = '<p style="color: #666; font-style: italic;">No pending registrations.</p>';
                } else {
                    let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
                    html += '<tr style="background: #ffe0b2;"><th style="padding: 8px; text-align: left;">Name</th><th style="padding: 8px; text-align: left;">Username</th><th style="padding: 8px; text-align: left;">Email</th><th style="padding: 8px; text-align: left;">Date</th><th style="padding: 8px; width: 140px;">Actions</th></tr>';

                    for (const user of pendingUsers) {
                        html += '<tr style="border-bottom: 1px solid #ffcc80;">';
                        html += '<td style="padding: 8px;">' + (user.name || '-') + '</td>';
                        html += '<td style="padding: 8px;"><strong>' + user.username + '</strong></td>';
                        html += '<td style="padding: 8px;">' + (user.email || '-') + '</td>';
                        html += '<td style="padding: 8px;">' + (user.date || '-') + '</td>';
                        html += '<td style="padding: 8px;">';
                        html += '<button onclick="approveUser(\'' + user.username + '\')" style="background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Approve</button>';
                        html += '<button onclick="denyUser(\'' + user.username + '\')" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Deny</button>';
                        html += '</td></tr>';
                    }
                    html += '</table>';
                    pendingContainer.innerHTML = html;
                }
            }

            // Render approved users
            if (approvedContainer) {
                if (approvedUsers.length === 0) {
                    approvedContainer.innerHTML = '<p style="color: #666; font-style: italic;">No approved users yet.</p>';
                } else {
                    let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
                    html += '<tr style="background: #c8e6c9;"><th style="padding: 8px; text-align: left;">Name</th><th style="padding: 8px; text-align: left;">Username</th><th style="padding: 8px; text-align: left;">Email</th><th style="padding: 8px; width: 80px;">Actions</th></tr>';

                    for (const user of approvedUsers) {
                        html += '<tr style="border-bottom: 1px solid #a5d6a7;">';
                        html += '<td style="padding: 8px;">' + (user.name || '-') + '</td>';
                        html += '<td style="padding: 8px;"><strong>' + user.username + '</strong></td>';
                        html += '<td style="padding: 8px;">' + (user.email || '-') + '</td>';
                        html += '<td style="padding: 8px;">';
                        html += '<button onclick="revokeUser(\'' + user.username + '\')" style="background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Revoke</button>';
                        html += '</td></tr>';
                    }
                    html += '</table>';
                    approvedContainer.innerHTML = html;
                }
            }
        }

        // Approve a pending user
        async function approveUser(username) {
            if (!confirm('Approve user "' + username + '"?')) return;

            try {
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    username: username,
                    status: 'approved'
                });
                await fetch(API_URL + '&' + params.toString(), { method: 'POST', mode: 'no-cors' });
                showToast('User "' + username + '" approved!', 'success');
                setTimeout(refreshPendingUsers, 1000); // Refresh after a short delay
            } catch (e) {
                showToast('Error approving user. Please try again.', 'error');
            }
        }

        // Deny/delete a pending user
        async function denyUser(username) {
            if (!confirm('Deny and remove user "' + username + '"?')) return;

            try {
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    username: username,
                    status: 'denied'
                });
                await fetch(API_URL + '&' + params.toString(), { method: 'POST', mode: 'no-cors' });
                showToast('User "' + username + '" denied.', 'info');
                setTimeout(refreshPendingUsers, 1000);
            } catch (e) {
                showToast('Error denying user. Please try again.', 'error');
            }
        }

        // Revoke an approved user
        async function revokeUser(username) {
            if (!confirm('Revoke access for "' + username + '"?')) return;

            try {
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    username: username,
                    status: 'revoked'
                });
                await fetch(API_URL + '&' + params.toString(), { method: 'POST', mode: 'no-cors' });
                showToast('User "' + username + '" access revoked.', 'warning');
                setTimeout(refreshPendingUsers, 1000);
            } catch (e) {
                showToast('Error revoking user. Please try again.', 'error');
            }
        }

        // Add user directly to sheet
        async function addUserToSheet() {
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const password = document.getElementById('newUserPassword').value;

            if (!username || !password) {
                showToast('Please enter at least username and password.', 'warning');
                return;
            }

            try {
                const params = new URLSearchParams({
                    action: 'addUser',
                    username: username,
                    password: password,
                    status: 'approved',
                    name: name,
                    email: ''
                });
                await fetch(API_URL + '&' + params.toString(), { method: 'POST', mode: 'no-cors' });

                // Clear inputs
                document.getElementById('newUserName').value = '';
                document.getElementById('newUsername').value = '';
                document.getElementById('newUserPassword').value = '';

                showToast('User "' + username + '" added and approved!', 'success');
                setTimeout(refreshPendingUsers, 1000);
            } catch (e) {
                showToast('Error adding user. Please try again.', 'error');
            }
        }

        // Smart Phrases - type shortcut and it auto-expands
        let smartPhrases = {
            // Vital Signs
            '.vs': 'BP: __ | HR: __ | O2: __% | RR: __ | T: __ | Pain: __/10',
            // Neuro
            '.neuro': 'A&Ox4. PERRLA. GCS 15. MAE x4. ',
            '.aox4': 'Alert and oriented x4 (person, place, time, situation). ',
            '.aox3': 'Alert and oriented x3 (person, place, time). ',
            '.perrla': 'PERRLA (Pupils Equal, Round, Reactive to Light and Accommodation). ',
            '.mae': 'MAE x4 (Moving All Extremities). ',
            '.gcs15': 'GCS 15 (E4V5M6). ',
            // Respiratory
            '.resp': 'CTA bilat. No adventitious sounds. Unlabored. O2: __% on __. ',
            '.cta': 'CTA bilat (Clear to Auscultation bilaterally). ',
            '.lungs': 'Lung sounds clear bilaterally, no wheezes, crackles, or rhonchi. ',
            '.sob': 'Patient denies shortness of breath. Respirations unlabored. ',
            // Cardiovascular
            '.cv': 'S1S2 RRR. No murmurs. Pulses 2+ x4. Cap refill <3s. No edema. ',
            '.rrr': 'S1S2 RRR (Regular Rate and Rhythm). No murmurs, rubs, or gallops. ',
            '.pulses': 'Peripheral pulses 2+ bilaterally, cap refill <3 seconds. ',
            '.noedema': 'No peripheral edema noted. ',
            // GI
            '.gi': 'BS active x4 quads. Abdomen soft, NT, ND. Last BM: __. ',
            '.bsax4': 'BS active x4 quadrants. ',
            '.ntnd': 'Non-tender, non-distended. ',
            '.npo': 'Patient NPO. ',
            '.tolerated': 'Diet tolerated without nausea or vomiting. ',
            // GU
            '.gu': 'Voiding without difficulty. Urine clear yellow. ',
            '.fs': 'Foley catheter patent, draining clear yellow urine. Secured to thigh. ',
            '.voidclear': 'Voiding clear yellow urine without difficulty. ',
            // Skin
            '.skin': 'Warm, dry, intact. No breakdown or pressure injuries. ',
            '.wdi': 'Skin warm, dry, intact. ',
            '.turgor': 'Skin turgor elastic, no tenting. ',
            '.ivsite': 'IV site clean, dry, intact. No redness, swelling, or drainage. ',
            // Pain
            '.pain': 'Pain __/10 at __. Quality: __. Duration: __. Interventions: __. ',
            '.pain0': 'Patient denies pain. Pain 0/10. ',
            '.painmed': 'Pain medication administered as ordered. Will reassess in 30-60 min. ',
            // Allergies
            '.nkda': 'NKDA (No Known Drug Allergies). ',
            '.nka': 'NKA (No Known Allergies). ',
            // General Assessment
            '.denies': 'Patient denies pain, nausea, SOB, dizziness, chest pain. ',
            '.wnl': 'Within normal limits. ',
            '.nad': 'No acute distress. ',
            '.wdta': 'Will continue to monitor. Patient tolerated well. No adverse effects noted. ',
            // Interventions
            '.medadmin': 'Medication administered as ordered. Patient tolerated without adverse effects. ',
            '.ivp': 'IV patent, no redness/swelling at site. Flushed with 10mL NS. ',
            '.repos': 'Patient repositioned for comfort and pressure relief. ',
            '.amb': 'Assisted patient with ambulation in hallway. Gait steady, tolerated well. ',
            '.tcdb': 'Encouraged to turn, cough, and deep breathe. ',
            '.is': 'Incentive spirometer use encouraged. Patient demonstrated proper technique. ',
            '.scd': 'SCDs applied and functioning bilaterally. ',
            // Safety
            '.fall': 'Fall precautions in place. Bed in low position. Call light within reach. ',
            '.safe': 'Side rails up x2. Bed alarm on. Call light in reach. Non-skid socks on. ',
            '.idbands': 'ID bands verified x2. Patient confirmed identity. ',
            '.safeenv': 'Safe environment maintained: bed low, locked, call light in reach, side rails x2. ',
            // Communication
            '.mdnotify': 'MD notified of findings. Awaiting orders. ',
            '.neworders': 'New orders received from MD and implemented. ',
            '.handoff': 'Bedside handoff report given to oncoming nurse. ',
            // Education/Discharge
            '.edu': 'Patient educated on __. Patient verbalized understanding. ',
            '.dc': 'Discharge instructions reviewed with patient. Patient verbalized understanding. ',
            '.teachback': 'Patient able to teach back key information. ',
            '.dcteach': 'Discharge teaching completed. Patient/family verbalized understanding of medications, follow-up, and return precautions. '
        };

        // Smart phrase expansion function
        function expandSmartPhrases(e) {
            const textarea = e.target;
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;

            // Look for phrase shortcuts (words starting with .)
            for (const [shortcut, expansion] of Object.entries(smartPhrases)) {
                const regex = new RegExp(shortcut.replace('.', '\\.') + '(?=\\s|$)', 'gi');
                if (regex.test(text)) {
                    textarea.value = text.replace(regex, expansion);
                    // Adjust cursor position
                    const diff = expansion.length - shortcut.length;
                    textarea.selectionStart = textarea.selectionEnd = cursorPos + diff;
                    break;
                }
            }
        }

        // Track last active textarea for vitals insertion
        let lastActiveTextarea = null;
        document.addEventListener('focusin', function(e) {
            if (e.target.tagName === 'TEXTAREA') {
                lastActiveTextarea = e.target;
            }
        });

        // Insert formatted vitals into the last active textarea
        function insertVitals() {
            if (!lastActiveTextarea) {
                showToast('Please click in a text field first, then click "Insert Vitals".', 'warning');
                return;
            }

            const bpSys = document.getElementById('vsBpSys').value.trim();
            const bpDia = document.getElementById('vsBpDia').value.trim();
            const hr = document.getElementById('vsHr').value.trim();
            const rr = document.getElementById('vsRr').value.trim();
            const temp = document.getElementById('vsTemp').value.trim();
            const o2 = document.getElementById('vsO2').value.trim();
            const o2Source = document.getElementById('vsO2Source').value;
            const pain = document.getElementById('vsPain').value.trim();

            // Build vitals string, only include fields that have values
            let parts = [];
            if (bpSys && bpDia) parts.push(`BP ${bpSys}/${bpDia}`);
            if (hr) parts.push(`HR ${hr}`);
            if (rr) parts.push(`RR ${rr}`);
            if (temp) parts.push(`T ${temp}¬∞F`);
            if (o2) parts.push(`O2 ${o2}% ${o2Source}`);
            if (pain) parts.push(`Pain ${pain}/10`);

            if (parts.length === 0) {
                showToast('Please enter at least one vital sign.', 'warning');
                return;
            }

            const vitalsStr = 'VS: ' + parts.join(' | ') + '. ';

            // Insert at cursor position in textarea
            const start = lastActiveTextarea.selectionStart;
            const end = lastActiveTextarea.selectionEnd;
            const text = lastActiveTextarea.value;
            lastActiveTextarea.value = text.substring(0, start) + vitalsStr + text.substring(end);

            // Move cursor to end of inserted text
            lastActiveTextarea.selectionStart = lastActiveTextarea.selectionEnd = start + vitalsStr.length;
            lastActiveTextarea.focus();

            // Clear vitals fields
            document.getElementById('vsBpSys').value = '';
            document.getElementById('vsBpDia').value = '';
            document.getElementById('vsHr').value = '';
            document.getElementById('vsRr').value = '';
            document.getElementById('vsTemp').value = '';
            document.getElementById('vsO2').value = '';
            document.getElementById('vsPain').value = '';
        }

        // Insert formatted medication into the last active textarea
        function insertMedication() {
            if (!lastActiveTextarea) {
                showToast('Please click in a text field first, then click "Insert Med".', 'warning');
                return;
            }

            const name = document.getElementById('medName').value.trim();
            const dose = document.getElementById('medDose').value.trim();
            const freq = document.getElementById('medFreq').value;
            const route = document.getElementById('medRoute').value;
            const site = document.getElementById('medSite').value;
            const time = document.getElementById('medTime').value;
            const indication = document.getElementById('medIndication').value.trim();
            const prnParams = document.getElementById('medPrnParams').value.trim();
            const effect = document.getElementById('medEffect').value.trim();

            if (!name) {
                showToast('Please enter at least a medication name.', 'warning');
                return;
            }

            // Format time to 24hr
            let timeStr = '';
            if (time) {
                timeStr = time.replace(':', '');
            }

            // Build medication string
            let medStr = name;
            if (dose) medStr += ' ' + dose;
            medStr += ' ' + route;
            if (freq) medStr += ' ' + freq;
            if (site) medStr += ' to ' + site;
            if (timeStr) medStr += ' @ ' + timeStr;
            if (indication) medStr += ' for ' + indication;
            if (prnParams) medStr += ' (PRN: ' + prnParams + ')';
            if (effect) medStr += '. Response: ' + effect;
            medStr += '. Patient tolerated without adverse reaction. ';

            // Insert at cursor position in textarea
            const start = lastActiveTextarea.selectionStart;
            const end = lastActiveTextarea.selectionEnd;
            const text = lastActiveTextarea.value;
            lastActiveTextarea.value = text.substring(0, start) + medStr + text.substring(end);

            // Move cursor to end of inserted text
            lastActiveTextarea.selectionStart = lastActiveTextarea.selectionEnd = start + medStr.length;
            lastActiveTextarea.focus();

            // Clear med fields
            document.getElementById('medName').value = '';
            document.getElementById('medDose').value = '';
            document.getElementById('medFreq').value = '';
            document.getElementById('medSite').value = '';
            document.getElementById('medTime').value = '';
            document.getElementById('medIndication').value = '';
            document.getElementById('medPrnParams').value = '';
            document.getElementById('medEffect').value = '';
            // Also hide the dropdown
            document.getElementById('drugDropdown').classList.remove('show');

            if (name) {
                saveMedRecent(name);
                renderMedRecents();
            }
        }

        // ========== SAVED VITALS & MEDICATIONS FOR EXPORT ==========
        let savedVitals = [];
        let savedMedications = [];

        function saveVitals() {
            const bpSys = document.getElementById('vsBpSys').value.trim();
            const bpDia = document.getElementById('vsBpDia').value.trim();
            const hr = document.getElementById('vsHr').value.trim();
            const rr = document.getElementById('vsRr').value.trim();
            const temp = document.getElementById('vsTemp').value.trim();
            const o2 = document.getElementById('vsO2').value.trim();
            const o2Source = document.getElementById('vsO2Source').value;
            const pain = document.getElementById('vsPain').value.trim();

            // Build vitals object
            let parts = [];
            if (bpSys && bpDia) parts.push(`BP ${bpSys}/${bpDia}`);
            if (hr) parts.push(`HR ${hr}`);
            if (rr) parts.push(`RR ${rr}`);
            if (temp) parts.push(`T ${temp}¬∞F`);
            if (o2) parts.push(`O2 ${o2}% ${o2Source}`);
            if (pain) parts.push(`Pain ${pain}/10`);

            if (parts.length === 0) {
                showToast('Please enter at least one vital sign.', 'warning');
                return;
            }

            const vitalsStr = 'VS: ' + parts.join(' | ');
            const time = formatTimeDisplay(new Date());

            savedVitals.push({
                display: vitalsStr,
                time: time,
                timestamp: Date.now()
            });

            // Clear fields
            document.getElementById('vsBpSys').value = '';
            document.getElementById('vsBpDia').value = '';
            document.getElementById('vsHr').value = '';
            document.getElementById('vsRr').value = '';
            document.getElementById('vsTemp').value = '';
            document.getElementById('vsO2').value = '';
            document.getElementById('vsPain').value = '';

            renderSavedVitals();
            showToast('Vitals saved! Will be included in PDF/Word export.', 'success');
        }

        function renderSavedVitals() {
            const list = document.getElementById('savedVitalsList');
            const entries = document.getElementById('savedVitalsEntries');

            if (savedVitals.length === 0) {
                list.style.display = 'none';
                return;
            }

            list.style.display = 'block';
            entries.innerHTML = savedVitals.map((v, i) => `
                <div style="display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 6px; padding: 8px 12px; margin-bottom: 6px; font-size: 12px;">
                    <div>
                        <span style="color: #2e7d32; font-weight: 600;">${v.time}</span>
                        <span style="margin-left: 8px; color: #333;">${v.display}</span>
                    </div>
                    <button onclick="removeSavedVitals(${i})" style="background: #ffebee; border: none; color: #d32f2f; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Remove</button>
                </div>
            `).join('');
        }

        function removeSavedVitals(index) {
            savedVitals.splice(index, 1);
            renderSavedVitals();
        }

        function clearSavedVitals() {
            if (!confirm('Clear all saved vitals?')) return;
            savedVitals = [];
            renderSavedVitals();
        }

        function saveMedication() {
            const name = document.getElementById('medName').value.trim();
            const dose = document.getElementById('medDose').value.trim();
            const freq = document.getElementById('medFreq').value;
            const route = document.getElementById('medRoute').value;
            const site = document.getElementById('medSite').value;
            const time = document.getElementById('medTime').value;
            const indication = document.getElementById('medIndication').value.trim();
            const prnParams = document.getElementById('medPrnParams').value.trim();
            const effect = document.getElementById('medEffect').value.trim();

            if (!name) {
                showToast('Please enter at least a medication name.', 'warning');
                return;
            }

            // Format time
            let timeStr = '';
            if (time) {
                timeStr = time.replace(':', '');
            }

            // Build medication string
            let medStr = name;
            if (dose) medStr += ' ' + dose;
            medStr += ' ' + route;
            if (freq) medStr += ' ' + freq;
            if (site) medStr += ' to ' + site;
            if (timeStr) medStr += ' @ ' + timeStr;
            if (indication) medStr += ' for ' + indication;
            if (prnParams) medStr += ' (PRN: ' + prnParams + ')';
            if (effect) medStr += ' ‚Üí ' + effect;

            savedMedications.push({
                display: medStr,
                name: name,
                time: timeStr || formatTimeDisplay(new Date()),
                timestamp: Date.now()
            });

            // Clear fields
            document.getElementById('medName').value = '';
            document.getElementById('medDose').value = '';
            document.getElementById('medFreq').value = '';
            document.getElementById('medSite').value = '';
            document.getElementById('medTime').value = '';
            document.getElementById('medIndication').value = '';
            document.getElementById('medPrnParams').value = '';
            document.getElementById('medEffect').value = '';
            document.getElementById('drugDropdown').classList.remove('show');

            if (name) {
                saveMedRecent(name);
                renderMedRecents();
            }

            renderSavedMedications();
            showToast('Medication saved! Will be included in PDF/Word export.', 'success');
        }

        function renderSavedMedications() {
            const list = document.getElementById('savedMedsList');
            const entries = document.getElementById('savedMedsEntries');

            if (savedMedications.length === 0) {
                list.style.display = 'none';
                return;
            }

            list.style.display = 'block';
            entries.innerHTML = savedMedications.map((m, i) => `
                <div style="display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 6px; padding: 8px 12px; margin-bottom: 6px; font-size: 12px;">
                    <div>
                        <span style="color: #1565c0; font-weight: 600;">${m.time}</span>
                        <span style="margin-left: 8px; color: #333;">${m.display}</span>
                    </div>
                    <button onclick="removeSavedMedication(${i})" style="background: #e3f2fd; border: none; color: #d32f2f; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Remove</button>
                </div>
            `).join('');
        }

        function removeSavedMedication(index) {
            savedMedications.splice(index, 1);
            renderSavedMedications();
        }

        function clearSavedMedications() {
            if (!confirm('Clear all saved medications?')) return;
            savedMedications = [];
            renderSavedMedications();
        }

        function getSavedVitalsText() {
            if (savedVitals.length === 0) return '';
            return savedVitals.map(v => `${v.time}: ${v.display}`).join('\n');
        }

        function getSavedMedicationsText() {
            if (savedMedications.length === 0) return '';
            return savedMedications.map(m => `${m.time}: ${m.display}`).join('\n');
        }

        // ========== SAVED SCREENINGS (PHQ-9 / GAD-7) FOR EXPORT ==========
        let savedScreenings = [];

        function saveScreening(type) {
            let total, severity, label;
            if (type === 'phq9') {
                total = getPhq9Total();
                severity = getPhq9Severity(total);
                label = 'PHQ-9';
            } else {
                total = getGad7Total();
                severity = getGad7Severity(total);
                label = 'GAD-7';
            }
            if (total === 0) { showToast('Please complete the screening before saving.', 'warning'); return; }
            const time = formatTimeDisplay(new Date());
            savedScreenings.push({ type, label, total, severity, display: `${label}: ${total} (${severity})`, time, timestamp: Date.now() });
            renderSavedScreenings(type);
            showToast(`${label} screening saved! Will be included in PDF/Word export.`, 'success');
        }

        function insertScreening(type) {
            let total, severity, label;
            if (type === 'phq9') { total = getPhq9Total(); severity = getPhq9Severity(total); label = 'PHQ-9'; }
            else { total = getGad7Total(); severity = getGad7Severity(total); label = 'GAD-7'; }
            if (total === 0) { showToast('Please complete the screening before inserting.', 'warning'); return; }
            const text = `${label} Score: ${total}/` + (type === 'phq9' ? '27' : '21') + ` (${severity})`;
            appendToField('h2tPsych', text + '. ');
            showToast(`${label} score inserted into Psychosocial notes.`, 'success');
        }

        function renderSavedScreenings(type) {
            const listId = type === 'phq9' ? 'savedPhq9List' : 'savedGad7List';
            const entriesId = type === 'phq9' ? 'savedPhq9Entries' : 'savedGad7Entries';
            const list = document.getElementById(listId);
            const entries = document.getElementById(entriesId);
            const filtered = savedScreenings.filter(s => s.type === type);
            if (filtered.length === 0) { list.style.display = 'none'; return; }
            list.style.display = 'block';
            entries.innerHTML = filtered.map((s, i) => {
                const idx = savedScreenings.indexOf(s);
                return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:rgba(255,255,255,0.6);border-radius:6px;margin-bottom:4px;font-size:12px;">
                    <div><span style="color:${type==='phq9'?'#880e4f':'#4a148c'};font-weight:600;">${s.time}</span> <span style="margin-left:8px;">${s.display}</span></div>
                    <button onclick="removeSavedScreening(${idx},'${type}')" style="background:none;border:none;color:#d32f2f;cursor:pointer;font-size:11px;">Remove</button>
                </div>`;
            }).join('');
        }

        function removeSavedScreening(index, type) { savedScreenings.splice(index, 1); renderSavedScreenings(type); }
        function clearSavedScreenings(type) {
            if (!confirm('Clear all saved ' + (type === 'phq9' ? 'PHQ-9' : 'GAD-7') + ' screenings?')) return;
            savedScreenings = savedScreenings.filter(s => s.type !== type);
            renderSavedScreenings(type);
        }

        // ========== SAVED LINES/DRAINS/AIRWAYS FOR EXPORT ==========
        let savedLinesDA = [];

        function saveLine() {
            const type = document.getElementById('lineType').value;
            const location = document.getElementById('lineLocation').value.trim();
            const size = document.getElementById('lineSize').value.trim();
            const status = document.getElementById('lineStatus').value;
            const output = document.getElementById('lineOutput').value.trim();
            const dressing = document.getElementById('lineDressing').value.trim();
            const notes = document.getElementById('lineNotes').value.trim();
            if (!type) { showToast('Please select a type.', 'warning'); return; }
            let parts = [type];
            if (size) parts.push(size);
            if (location) parts.push('to ' + location);
            parts.push('- ' + status);
            if (output) parts.push('output: ' + output);
            if (dressing) parts.push('dressing: ' + dressing);
            if (notes) parts.push('(' + notes + ')');
            const display = parts.join(', ');
            const time = formatTimeDisplay(new Date());
            savedLinesDA.push({ display, time, timestamp: Date.now() });
            // Also update hidden textarea for export compatibility
            const h2tLines = document.getElementById('h2tLines');
            if (h2tLines) h2tLines.value = savedLinesDA.map(l => l.display).join('\n');
            renderSavedLines();
            showToast('Line/Drain/Airway saved! Will be included in export.', 'success');
            // Clear form fields
            document.getElementById('lineLocation').value = '';
            document.getElementById('lineSize').value = '';
            document.getElementById('lineOutput').value = '';
            document.getElementById('lineDressing').value = '';
            document.getElementById('lineNotes').value = '';
        }

        function insertLine() {
            const type = document.getElementById('lineType').value;
            const location = document.getElementById('lineLocation').value.trim();
            const size = document.getElementById('lineSize').value.trim();
            const status = document.getElementById('lineStatus').value;
            const output = document.getElementById('lineOutput').value.trim();
            const dressing = document.getElementById('lineDressing').value.trim();
            const notes = document.getElementById('lineNotes').value.trim();
            if (!type) { showToast('Please select a type.', 'warning'); return; }
            let parts = [type];
            if (size) parts.push(size);
            if (location) parts.push('to ' + location);
            parts.push('- ' + status);
            if (output) parts.push('output: ' + output);
            if (dressing) parts.push('dressing: ' + dressing);
            if (notes) parts.push('(' + notes + ')');
            if (!lastActiveTextarea) {
                showToast('Please click in a text field first, then click "Insert Now".', 'warning');
                return;
            }
            const lineStr = parts.join(', ') + '. ';
            const lStart = lastActiveTextarea.selectionStart;
            const lEnd = lastActiveTextarea.selectionEnd;
            const lText = lastActiveTextarea.value;
            lastActiveTextarea.value = lText.substring(0, lStart) + lineStr + lText.substring(lEnd);
            lastActiveTextarea.selectionStart = lastActiveTextarea.selectionEnd = lStart + lineStr.length;
            lastActiveTextarea.focus();
            showToast('Line/Drain/Airway inserted into note.', 'success');
        }

        function renderSavedLines() {
            const list = document.getElementById('savedLinesList');
            const entries = document.getElementById('savedLinesEntries');
            if (savedLinesDA.length === 0) { list.style.display = 'none'; return; }
            list.style.display = 'block';
            entries.innerHTML = savedLinesDA.map((l, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:rgba(255,255,255,0.6);border-radius:6px;margin-bottom:4px;font-size:12px;">
                    <div><span style="color:#e65100;font-weight:600;">${l.time}</span> <span style="margin-left:8px;">${l.display}</span></div>
                    <button onclick="removeSavedLine(${i})" style="background:none;border:none;color:#d32f2f;cursor:pointer;font-size:11px;">Remove</button>
                </div>
            `).join('');
        }

        function removeSavedLine(index) { savedLinesDA.splice(index, 1); renderSavedLines(); }
        function clearSavedLines() {
            if (!confirm('Clear all saved lines/drains/airways?')) return;
            savedLinesDA = [];
            renderSavedLines();
        }

        const MED_RECENTS_KEY = 'bsn9b_med_recents';

        function getMedRecents() {
            try {
                const raw = localStorage.getItem(MED_RECENTS_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                return [];
            }
        }

        function saveMedRecent(name) {
            const recents = getMedRecents().filter(n => n.toLowerCase() !== name.toLowerCase());
            recents.unshift(name);
            localStorage.setItem(MED_RECENTS_KEY, JSON.stringify(recents.slice(0, 8)));
        }

        function renderMedRecents() {
            const container = document.getElementById('medRecents');
            if (!container) return;
            const recents = getMedRecents();
            if (recents.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = recents.map(n =>
                `<button onclick="selectDrug('${n.replace(/'/g, "\\'")}')" style="border: 1px solid #cbd5e1; background: #f8fafc; color: #1f4e79; padding: 3px 8px; border-radius: 999px; font-size: 11px; cursor: pointer;">${n}</button>`
            ).join('');
        }

        // Drug Autocomplete using NIH RxNav API
        let drugSearchTimeout = null;
        const drugDropdown = document.getElementById('drugDropdown');
        const medNameInput = document.getElementById('medName');

        if (medNameInput && drugDropdown) medNameInput.addEventListener('input', function() {
            const query = this.value.trim();

            // Clear previous timeout
            if (drugSearchTimeout) {
                clearTimeout(drugSearchTimeout);
            }

            // Hide dropdown if query is too short
            if (query.length < 2) {
                drugDropdown.classList.remove('show');
                return;
            }

            // Show loading
            drugDropdown.innerHTML = '<div class="drug-loading">Searching...</div>';
            drugDropdown.classList.add('show');

            // Debounce the search (wait 300ms after typing stops)
            drugSearchTimeout = setTimeout(() => {
                searchDrugs(query);
            }, 300);
        });

        async function searchDrugs(query) {
            try {
                const results = new Map();

                // 1. Spelling suggestions (handles typos)
                const spellResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/spellingsuggestions.json?name=${encodeURIComponent(query)}`);
                const spellData = await spellResponse.json();

                if (spellData.suggestionGroup?.suggestionList?.suggestion) {
                    spellData.suggestionGroup.suggestionList.suggestion.slice(0, 8).forEach(s => {
                        results.set(s.toLowerCase(), { name: s, type: 'suggestion' });
                    });
                }

                // 2. Approximate term matching (fuzzy search)
                const approxResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/approximateTerm.json?term=${encodeURIComponent(query)}&maxEntries=10`);
                const approxData = await approxResponse.json();

                if (approxData.approximateGroup?.candidate) {
                    approxData.approximateGroup.candidate.forEach(c => {
                        if (c.name && !results.has(c.name.toLowerCase())) {
                            results.set(c.name.toLowerCase(), { name: c.name, type: 'match' });
                        }
                    });
                }

                // Build dropdown
                const suggestions = Array.from(results.values()).slice(0, 12);

                if (suggestions.length === 0) {
                    drugDropdown.innerHTML = '<div class="drug-loading">No matches found. You can still type manually.</div>';
                } else {
                    drugDropdown.innerHTML = suggestions.map(drug => {
                        return `<div class="drug-item" onclick="selectDrug('${drug.name.replace(/'/g, "\\'")}')">${drug.name}</div>`;
                    }).join('');
                }
                drugDropdown.classList.add('show');
            } catch (error) {
                console.error('Drug search error:', error);
                drugDropdown.innerHTML = '<div class="drug-loading">Search unavailable. Type manually.</div>';
            }
        }

        function selectDrug(drugName) {
            medNameInput.value = drugName;
            drugDropdown.classList.remove('show');
            saveMedRecent(drugName);
            renderMedRecents();
            // Focus the dose field after selecting
            document.getElementById('medDose').focus();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.drug-autocomplete-wrapper')) {
                drugDropdown.classList.remove('show');
            }
        });

        renderMedRecents();

        // Load custom phrases from localStorage and global phrases from Firebase
        function loadCustomPhrases() {
            // Load local custom phrases
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            if (custom) {
                const customPhrases = JSON.parse(custom);
                Object.assign(smartPhrases, customPhrases);
            }

            // Load global phrases from Firebase (admin-managed)
            const globalPhrasesRef = database.ref('globalPhrases');
            globalPhrasesRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const phrase = child.val();
                        smartPhrases[phrase.shortcut] = phrase.text;
                    });
                }
            });
        }

        // Save custom phrases to localStorage
        function saveCustomPhrases() {
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            const customPhrases = custom ? JSON.parse(custom) : {};
            localStorage.setItem('bsn9b_custom_phrases', JSON.stringify(customPhrases));
        }

        // Add a new custom phrase (admin only)
        function addCustomPhrase() {
            let shortcut = document.getElementById('newPhraseShortcut').value.trim().toLowerCase();
            const text = document.getElementById('newPhraseText').value.trim();

            if (!shortcut || !text) {
                showToast('Please enter both a shortcut and expansion text.', 'warning');
                return;
            }

            // Ensure shortcut starts with .
            if (!shortcut.startsWith('.')) {
                shortcut = '.' + shortcut;
            }

            // Add to smartPhrases
            smartPhrases[shortcut] = text;

            // Save to localStorage
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            const customPhrases = custom ? JSON.parse(custom) : {};
            customPhrases[shortcut] = text;
            localStorage.setItem('bsn9b_custom_phrases', JSON.stringify(customPhrases));

            // Clear inputs
            document.getElementById('newPhraseShortcut').value = '';
            document.getElementById('newPhraseText').value = '';

            // Refresh list
            renderCustomPhrases();
            showToast('Smart phrase added: ' + shortcut, 'success');
        }

        // Delete a custom phrase
        function deleteCustomPhrase(shortcut) {
            delete smartPhrases[shortcut];

            const custom = localStorage.getItem('bsn9b_custom_phrases');
            if (custom) {
                const customPhrases = JSON.parse(custom);
                delete customPhrases[shortcut];
                localStorage.setItem('bsn9b_custom_phrases', JSON.stringify(customPhrases));
            }

            renderCustomPhrases();
        }

        // Render custom phrases list
        function renderCustomPhrases() {
            const container = document.getElementById('customPhrasesList');
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            const customPhrases = custom ? JSON.parse(custom) : {};

            if (Object.keys(customPhrases).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No custom phrases added yet.</p>';
                return;
            }

            let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
            html += '<tr style="background: #ffe0b2;"><th style="padding: 8px; text-align: left;">Shortcut</th><th style="padding: 8px; text-align: left;">Expansion</th><th style="padding: 8px; width: 60px;"></th></tr>';

            for (const [shortcut, text] of Object.entries(customPhrases)) {
                html += `<tr style="border-bottom: 1px solid #ffcc80;">
                    <td style="padding: 8px;"><code style="background:#e65100;color:#fff;padding:2px 6px;border-radius:4px;">${shortcut}</code></td>
                    <td style="padding: 8px;">${text.substring(0, 60)}${text.length > 60 ? '...' : ''}</td>
                    <td style="padding: 8px;"><button onclick="deleteCustomPhrase('${shortcut}')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button></td>
                </tr>`;
            }
            html += '</table>';
            container.innerHTML = html;
        }

        // Simple hash for user passwords (same as login page)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Add a new custom user (admin only)
        function addCustomUser() {
            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const password = document.getElementById('newUserPassword').value;

            if (!username || !password) {
                showToast('Please enter both username and password.', 'warning');
                return;
            }

            // Reserved usernames
            const reserved = ['sumner', 'holdenc', 'np', 'instructor', 'admin'];
            if (reserved.includes(username)) {
                showToast('This username is reserved. Please choose a different one.', 'error');
                return;
            }

            // Get existing custom users
            const stored = localStorage.getItem('bsn9b_custom_users');
            const customUsers = stored ? JSON.parse(stored) : {};

            // Add new user with hashed password
            customUsers[username] = { password: simpleHash(password) };
            localStorage.setItem('bsn9b_custom_users', JSON.stringify(customUsers));

            // Clear inputs
            document.getElementById('newUsername').value = '';
            document.getElementById('newUserPassword').value = '';

            renderCustomUsers();
            showToast('User "' + username + '" added successfully!', 'success');
        }

        // Delete a custom user
        function deleteCustomUser(username) {
            if (!confirm('Delete user "' + username + '"?')) return;

            const stored = localStorage.getItem('bsn9b_custom_users');
            if (stored) {
                const customUsers = JSON.parse(stored);
                delete customUsers[username];
                localStorage.setItem('bsn9b_custom_users', JSON.stringify(customUsers));
            }
            renderCustomUsers();
        }

        // Render custom users list
        function renderCustomUsers() {
            const container = document.getElementById('customUsersList');
            if (!container) return;

            const stored = localStorage.getItem('bsn9b_custom_users');
            const customUsers = stored ? JSON.parse(stored) : {};

            if (Object.keys(customUsers).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No custom users added yet.</p>';
                return;
            }

            let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
            html += '<tr style="background: #ffe0b2;"><th style="padding: 8px; text-align: left;">Username</th><th style="padding: 8px; width: 60px;"></th></tr>';

            for (const username of Object.keys(customUsers)) {
                html += '<tr style="border-bottom: 1px solid #ffcc80;">';
                html += '<td style="padding: 8px;"><strong>' + username + '</strong></td>';
                html += '<td style="padding: 8px;"><button onclick="deleteCustomUser(\'' + username + '\')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button></td>';
                html += '</tr>';
            }
            html += '</table>';
            container.innerHTML = html;
        }

        // Attach smart phrase listener to all textareas on load
        document.addEventListener('DOMContentLoaded', function() {
            // Load custom phrases
            loadCustomPhrases();

            // Attach listeners
            document.querySelectorAll('textarea').forEach(ta => {
                ta.addEventListener('input', expandSmartPhrases);
            });

            });

        // NANDA Database
        const nandaDatabase = [
            // Activity/Rest
            {name: "Activity intolerance", category: "Activity/Rest", def: "Insufficient physiological or psychological energy to endure or complete daily activities"},
            {name: "Activity intolerance, risk for", category: "Activity/Rest", def: "At risk for insufficient energy to complete daily activities"},
            {name: "Fatigue", category: "Activity/Rest", def: "Overwhelming sustained sense of exhaustion and decreased capacity for work"},
            {name: "Insomnia", category: "Activity/Rest", def: "Disruption in amount and quality of sleep that impairs functioning"},
            {name: "Mobility: physical, impaired", category: "Activity/Rest", def: "Limitation in independent, purposeful physical movement"},
            {name: "Mobility: bed, impaired", category: "Activity/Rest", def: "Limitation of independent movement from one bed position to another"},
            {name: "Sleep deprivation", category: "Activity/Rest", def: "Prolonged periods without sleep"},
            {name: "Sleep pattern disturbed", category: "Activity/Rest", def: "Time-limited interruptions of sleep amount and quality"},
            {name: "Walking, impaired", category: "Activity/Rest", def: "Limitation of independent movement within environment on foot"},
            // Circulation
            {name: "Bleeding, risk for", category: "Circulation", def: "At risk for decrease in blood volume that may compromise health"},
            {name: "Cardiac output, decreased", category: "Circulation", def: "Inadequate blood pumped by heart to meet metabolic demands"},
            {name: "Tissue perfusion, ineffective peripheral", category: "Circulation", def: "Decrease in blood circulation to peripheries that may compromise health"},
            {name: "Tissue perfusion, ineffective cerebral, risk for", category: "Circulation", def: "Risk for decrease in cerebral tissue circulation"},
            {name: "Shock, risk for", category: "Circulation", def: "At risk for inadequate blood flow to body tissues"},
            // Ego Integrity
            {name: "Anxiety", category: "Ego Integrity", def: "Vague uneasy feeling of discomfort or dread with autonomic response"},
            {name: "Anxiety, death", category: "Ego Integrity", def: "Vague uneasy feeling generated by perceptions of threat to existence"},
            {name: "Body image, disturbed", category: "Ego Integrity", def: "Confusion in mental picture of one's physical self"},
            {name: "Coping, ineffective", category: "Ego Integrity", def: "Inability to form valid appraisal of stressors or access resources"},
            {name: "Fear", category: "Ego Integrity", def: "Response to perceived threat consciously recognized as danger"},
            {name: "Grieving", category: "Ego Integrity", def: "Normal complex process incorporating actual or anticipated loss"},
            {name: "Grieving, complicated", category: "Ego Integrity", def: "Disorder where bereavement distress manifests in functional impairment"},
            {name: "Hopelessness", category: "Ego Integrity", def: "State where individual sees limited alternatives and unable to mobilize energy"},
            {name: "Powerlessness", category: "Ego Integrity", def: "Perception that one's actions will not significantly affect outcome"},
            {name: "Self-esteem, chronic low", category: "Ego Integrity", def: "Long-standing negative self-evaluation/feelings about self"},
            {name: "Self-esteem, situational low", category: "Ego Integrity", def: "Development of negative perception of self-worth in response to situation"},
            // Elimination
            {name: "Bowel incontinence", category: "Elimination", def: "Change in bowel habits characterized by involuntary passage of stool"},
            {name: "Constipation", category: "Elimination", def: "Decrease in frequency of defecation with difficult or incomplete passage"},
            {name: "Constipation, risk for", category: "Elimination", def: "At risk for decrease in normal frequency of defecation"},
            {name: "Diarrhea", category: "Elimination", def: "Passage of loose, unformed stools"},
            {name: "Urinary elimination, impaired", category: "Elimination", def: "Disturbance in urine elimination"},
            {name: "Urinary incontinence, functional", category: "Elimination", def: "Inability to reach toilet in time to avoid unintentional loss of urine"},
            {name: "Urinary incontinence, stress", category: "Elimination", def: "Sudden leakage with activities that increase intra-abdominal pressure"},
            {name: "Urinary incontinence, urge", category: "Elimination", def: "Involuntary passage soon after strong sense of urgency"},
            {name: "Urinary retention", category: "Elimination", def: "Incomplete emptying of the bladder"},
            // Food/Fluid
            {name: "Fluid volume, deficient", category: "Food/Fluid", def: "Decreased intravascular, interstitial and/or intracellular fluid"},
            {name: "Fluid volume, deficient, risk for", category: "Food/Fluid", def: "At risk for vascular, cellular, or intracellular dehydration"},
            {name: "Fluid volume, excess", category: "Food/Fluid", def: "Increased isotonic fluid retention"},
            {name: "Electrolyte imbalance, risk for", category: "Food/Fluid", def: "At risk for change in serum electrolyte levels"},
            {name: "Nutrition: imbalanced, less than body requirements", category: "Food/Fluid", def: "Intake of nutrients insufficient to meet metabolic needs"},
            {name: "Nutrition: imbalanced, more than body requirements", category: "Food/Fluid", def: "Intake of nutrients that exceeds metabolic needs"},
            {name: "Nausea", category: "Food/Fluid", def: "Subjective unpleasant wave-like sensation that may lead to vomiting"},
            {name: "Swallowing, impaired", category: "Food/Fluid", def: "Abnormal functioning of swallowing mechanism"},
            // Neurosensory
            {name: "Confusion, acute", category: "Neurosensory", def: "Abrupt onset of reversible disturbances of consciousness and cognition"},
            {name: "Confusion, chronic", category: "Neurosensory", def: "Irreversible progressive deterioration of intellect and personality"},
            {name: "Communication, impaired verbal", category: "Neurosensory", def: "Decreased ability to receive, process, transmit, and use symbols"},
            {name: "Memory, impaired", category: "Neurosensory", def: "Inability to remember or recall bits of information"},
            {name: "Sensory perception, disturbed", category: "Neurosensory", def: "Change in amount or patterning of incoming stimuli"},
            // Pain/Discomfort
            {name: "Pain, acute", category: "Pain/Discomfort", def: "Unpleasant sensory experience from actual or potential tissue damage, <6 months"},
            {name: "Pain, chronic", category: "Pain/Discomfort", def: "Unpleasant sensory experience without predictable end, >6 months"},
            {name: "Comfort, impaired", category: "Pain/Discomfort", def: "Perceived lack of ease, relief in physical/psychospiritual dimensions"},
            // Respiration
            {name: "Airway clearance, ineffective", category: "Respiration", def: "Inability to clear secretions or obstructions from respiratory tract"},
            {name: "Aspiration, risk for", category: "Respiration", def: "At risk for entry of secretions into tracheobronchial passages"},
            {name: "Breathing pattern, ineffective", category: "Respiration", def: "Inspiration/expiration that does not provide adequate ventilation"},
            {name: "Gas exchange, impaired", category: "Respiration", def: "Excess or deficit in oxygenation at alveolar-capillary membrane"},
            // Safety
            {name: "Falls, risk for", category: "Safety", def: "Increased susceptibility to falling that may cause physical harm"},
            {name: "Infection, risk for", category: "Safety", def: "At increased risk for being invaded by pathogenic organisms"},
            {name: "Injury, risk for", category: "Safety", def: "At risk of injury from environmental conditions"},
            {name: "Skin integrity, impaired", category: "Safety", def: "Altered epidermis and/or dermis"},
            {name: "Skin integrity, impaired, risk for", category: "Safety", def: "At risk for skin being adversely altered"},
            {name: "Hypothermia", category: "Safety", def: "Body temperature below normal range"},
            {name: "Hyperthermia", category: "Safety", def: "Body temperature elevated above normal range"},
            {name: "Trauma, risk for", category: "Safety", def: "Accentuated risk of accidental tissue injury"},
            // Hygiene
            {name: "Self-care deficit, bathing", category: "Hygiene", def: "Impaired ability to perform bathing activities"},
            {name: "Self-care deficit, dressing", category: "Hygiene", def: "Impaired ability to perform dressing activities"},
            {name: "Self-care deficit, feeding", category: "Hygiene", def: "Impaired ability to perform feeding activities"},
            {name: "Self-care deficit, toileting", category: "Hygiene", def: "Impaired ability to perform toileting activities"},
            // Knowledge
            {name: "Knowledge deficient", category: "Health Promotion", def: "Absence of cognitive information related to specific topic"},
            {name: "Noncompliance", category: "Health Promotion", def: "Behavior that fails to coincide with therapeutic plan"}
        ];

        // Epic-style Date/Time Shortcut Functions
        // Parses shortcuts like t, t-2, t+1 for dates and n, n-30, n+15 for times

        function formatDateDisplay(date) {
            // Format as MM/DD/YYYY for display
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        }

        function formatTimeDisplay(date) {
            // Format as HHMM (24hr military time without colon) for display
            const hours = String(date.getHours()).padStart(2, '0');
            const mins = String(date.getMinutes()).padStart(2, '0');
            return `${hours}${mins}`;
        }

        function parseDateInput(input) {
            // Parse Epic-style date shortcuts: t, t-2, t+1, etc.
            const val = input.trim().toLowerCase();
            const today = new Date();

            if (val === 't' || val === 'today') {
                return formatDateDisplay(today);
            }

            // Match t-2, t+1, t-10, etc.
            const match = val.match(/^t\s*([\+\-])\s*(\d+)$/);
            if (match) {
                const sign = match[1] === '+' ? 1 : -1;
                const days = parseInt(match[2]);
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + (sign * days));
                return formatDateDisplay(targetDate);
            }

            // If not a shortcut, return as-is (user may have entered a date directly)
            return input;
        }

        function parseTimeInput(input) {
            // Parse Epic-style time shortcuts: n, n-30, n+15, etc.
            // Also handles various time formats and normalizes to HHMM
            const val = input.trim().toLowerCase();
            const now = new Date();

            if (val === 'n' || val === 'now') {
                return formatTimeDisplay(now);
            }

            // Match n-30, n+15, n-5, etc.
            const match = val.match(/^n\s*([\+\-])\s*(\d+)$/);
            if (match) {
                const sign = match[1] === '+' ? 1 : -1;
                const minutes = parseInt(match[2]);
                const targetTime = new Date(now);
                targetTime.setMinutes(now.getMinutes() + (sign * minutes));
                return formatTimeDisplay(targetTime);
            }

            // Handle HH:MM format (with colon) - convert to HHMM
            const colonMatch = val.match(/^(\d{1,2}):(\d{2})$/);
            if (colonMatch) {
                const hours = String(parseInt(colonMatch[1])).padStart(2, '0');
                const mins = colonMatch[2];
                return `${hours}${mins}`;
            }

            // Handle plain 4-digit HHMM format - validate and normalize
            const fourDigitMatch = val.match(/^(\d{4})$/);
            if (fourDigitMatch) {
                const hours = parseInt(val.substring(0, 2));
                const mins = parseInt(val.substring(2, 4));
                if (hours >= 0 && hours <= 23 && mins >= 0 && mins <= 59) {
                    return val; // Already valid HHMM format
                }
            }

            // Handle 3-digit format like 830 -> 0830
            const threeDigitMatch = val.match(/^(\d{3})$/);
            if (threeDigitMatch) {
                return '0' + val;
            }

            // If not a recognized format, return as-is
            return input;
        }

        function setupDateTimeShortcuts() {
            const dateInput = document.getElementById('noteDate');
            const timeInput = document.getElementById('noteTime');

            if (dateInput) {
                // Set initial value to today
                dateInput.value = formatDateDisplay(new Date());

                // Parse on blur
                dateInput.addEventListener('blur', function() {
                    this.value = parseDateInput(this.value);
                });

                // Parse on Enter
                dateInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.value = parseDateInput(this.value);
                        this.blur();
                    }
                });
            }

            if (timeInput) {
                // Set initial value to now
                timeInput.value = formatTimeDisplay(new Date());

                // Parse on blur
                timeInput.addEventListener('blur', function() {
                    this.value = parseTimeInput(this.value);
                });

                // Parse on Enter
                timeInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.value = parseTimeInput(this.value);
                        this.blur();
                    }
                });
            }
        }

        // Med Time shortcuts (same logic as note time)
        function setupMedTimeShortcut() {
            const medTimeInput = document.getElementById('medTime');
            if (medTimeInput) {
                medTimeInput.addEventListener('blur', function() {
                    this.value = parseTimeInput(this.value);
                });
                medTimeInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.value = parseTimeInput(this.value);
                        this.blur();
                    }
                });
            }
        }

        // Toggle collapsible panels
        function togglePanel(panelId, headerEl) {
            const panel = document.getElementById(panelId);
            const arrow = headerEl.querySelector('h3 span');
            const isHidden = panel.style.display === 'none';

            if (isHidden) {
                panel.style.display = 'block';
                if (arrow) arrow.textContent = '‚ñº';
            } else {
                panel.style.display = 'none';
                if (arrow) arrow.textContent = '‚ñ∂';
            }
        }

        // Note sections for jump list (must be defined before setNoteType)
        const NOTE_SECTIONS = {
            dar: [
                { id: 'darData', label: 'Data' },
                { id: 'darAction', label: 'Action' },
                { id: 'darResponse', label: 'Response' }
            ],
            darp: [
                { id: 'darpData', label: 'Data' },
                { id: 'darpAction', label: 'Action' },
                { id: 'darpResponse', label: 'Response' },
                { id: 'darpPlan', label: 'Plan' }
            ],
            soap: [
                { id: 'soapSubjective', label: 'Subjective' },
                { id: 'soapObjective', label: 'Objective' },
                { id: 'soapAssessment', label: 'Assessment' },
                { id: 'soapPlan', label: 'Plan' }
            ],
            soapie: [
                { id: 'soapieSubjective', label: 'Subjective' },
                { id: 'soapieObjective', label: 'Objective' },
                { id: 'soapieAssessment', label: 'Assessment' },
                { id: 'soapiePlan', label: 'Plan' },
                { id: 'soapieIntervention', label: 'Intervention' },
                { id: 'soapieEvaluation', label: 'Evaluation' }
            ],
            sbar: [
                { id: 'sbarSituation', label: 'Situation' },
                { id: 'sbarBackground', label: 'Background' },
                { id: 'sbarAssessment', label: 'Assessment' },
                { id: 'sbarRecommendation', label: 'Recommendation' }
            ],
            pie: [
                { id: 'pieProblem', label: 'Problem' },
                { id: 'pieIntervention', label: 'Intervention' },
                { id: 'pieEvaluation', label: 'Evaluation' }
            ],
            narrative: [
                { id: 'narrativeText', label: 'Narrative' }
            ],
            h2t: [
                { id: 'h2tNeuro', label: 'Neuro' },
                { id: 'h2tCardio', label: 'Cardio' },
                { id: 'h2tResp', label: 'Resp' },
                { id: 'h2tGI', label: 'GI' },
                { id: 'h2tGU', label: 'GU' },
                { id: 'h2tSkin', label: 'Skin' },
                { id: 'h2tMSK', label: 'MSK' },
                { id: 'h2tPain', label: 'Pain' },
                { id: 'h2tMental', label: 'Mental' },
                { id: 'h2tSafety', label: 'Safety' },
                { id: 'h2tLines', label: 'Lines/Drains' },
                { id: 'h2tPsych', label: 'Psych' }
            ]
        };

        function toggleSectionJump() {
            const panel = document.getElementById('sectionJumpPanel');
            if (!panel) return;
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function updateSectionJumpList() {
            const panel = document.getElementById('sectionJumpPanel');
            if (!panel) return;
            const sections = NOTE_SECTIONS[currentNoteType] || [];
            panel.innerHTML = sections.map(s => `<div class="section-jump-item" onclick="scrollToSection('${s.id}')">${s.label}</div>`).join('');
        }

        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            const panel = document.getElementById('sectionJumpPanel');
            if (panel) panel.style.display = 'none';
        }

        document.addEventListener('click', (e) => {
            const panel = document.getElementById('sectionJumpPanel');
            const btn = document.getElementById('sectionJumpBtn');
            if (panel && btn && panel.style.display === 'block' && !panel.contains(e.target) && e.target !== btn) {
                panel.style.display = 'none';
            }
        });

        function setNoteType(type, cardEl = null) {
            currentNoteType = type;
            document.querySelectorAll('.note-type-card').forEach(c => c.classList.remove('active'));
            const targetCard = cardEl || document.querySelector(`.note-type-card[data-note-type="${type}"]`);
            if (targetCard) targetCard.classList.add('active');
            document.querySelectorAll('.note-fields').forEach(f => f.classList.remove('active'));
            const fields = document.getElementById(type + 'Fields');
            if (fields) fields.classList.add('active');
            document.getElementById('focusGroup').style.display = ['dar', 'darp'].includes(type) ? 'block' : 'none';
            updateSectionJumpList();
        }

        function selectNoteType(type, cardEl = null) {
            saveDraft();
            setNoteType(type, cardEl && cardEl.classList ? cardEl : null);
            loadDraft(type);
        }

        const DRAFT_PREFIX = 'bsn9b_draft_';
        const AUTOSAVE_DELAY = 800;
        let autosaveTimer = null;

        function collectDraftFields() {
            const container = document.querySelector('.form-container');
            if (!container) return {};
            const data = {};
            container.querySelectorAll('input, textarea, select').forEach(el => {
                if (!el.id) return;
                if (el.type === 'checkbox' || el.type === 'radio') {
                    data[el.id] = el.checked;
                } else {
                    data[el.id] = el.value;
                }
            });
            return data;
        }

        function updateAutoSaveStatus(text) {
            const el = document.getElementById('autoSaveStatus');
            const mobile = document.getElementById('mobileActionStatus');
            if (el) el.textContent = text;
            if (mobile) mobile.textContent = text;
        }

        function saveDraft() {
            try {
                const key = DRAFT_PREFIX + currentNoteType;
                const payload = {
                    noteType: currentNoteType,
                    timestamp: Date.now(),
                    fields: collectDraftFields()
                };
                localStorage.setItem(key, JSON.stringify(payload));
                const time = new Date(payload.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                updateAutoSaveStatus('Draft saved ' + time);
            } catch (e) {
                console.warn('Autosave failed:', e);
            }
        }

        function loadDraft(type) {
            try {
                const key = DRAFT_PREFIX + type;
                const raw = localStorage.getItem(key);
                if (!raw) {
                    updateAutoSaveStatus('Draft not saved');
                    return;
                }
                const payload = JSON.parse(raw);
                if (!payload || !payload.fields) return;
                Object.keys(payload.fields).forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = !!payload.fields[id];
                    } else {
                        el.value = payload.fields[id];
                    }
                });
                updatePhq9Score();
                updateGad7Score();
                const time = new Date(payload.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                updateAutoSaveStatus('Draft restored ' + time);
            } catch (e) {
                console.warn('Draft load failed:', e);
            }
        }

        function scheduleAutoSave() {
            updateAutoSaveStatus('Saving...');
            clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(saveDraft, AUTOSAVE_DELAY);
        }

        function setupAutoSave() {
            const container = document.querySelector('.form-container');
            if (!container) return;
            container.querySelectorAll('input, textarea, select').forEach(el => {
                if (!el.id) return;
                el.addEventListener('input', scheduleAutoSave);
                el.addEventListener('change', scheduleAutoSave);
            });
        }

        function clearDraft(type) {
            try { localStorage.removeItem(DRAFT_PREFIX + type); } catch (e) {}
        }

        // Initialize the app
        setupDateTimeShortcuts();
        setupMedTimeShortcut();
        document.querySelectorAll('.note-type-card').forEach(card => {
            card.addEventListener('click', () => {
                const type = card.dataset.noteType;
                if (type) selectNoteType(type, card);
            });
        });
        const storedName = localStorage.getItem('bsn9b_displayName');
        const nurseNameInput = document.getElementById('nurseName');
        if (nurseNameInput && storedName && !nurseNameInput.value) {
            nurseNameInput.value = storedName;
        }
        setNoteType(currentNoteType);
        setupAutoSave();
        loadDraft(currentNoteType);
        startSessionHeartbeat();
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') updateSessionHeartbeat();
        });

        // Debounce utility for search functions (reduces CPU usage)
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function searchNandaImpl() {
            const query = document.getElementById('nandaSearch').value.toLowerCase();
            const dropdown = document.getElementById('nandaDropdown');
            if (query.length < 2) { dropdown.classList.remove('show'); return; }
            const results = nandaDatabase.filter(d =>
                d.name.toLowerCase().includes(query) ||
                d.category.toLowerCase().includes(query) ||
                d.def.toLowerCase().includes(query)
            ).slice(0, 10);
            if (results.length === 0) { dropdown.classList.remove('show'); return; }
            dropdown.innerHTML = results.map(d =>
                `<div class="nanda-item" onclick="addDiagnosis('${d.name.replace(/'/g, "\\'")}')">
                    <div class="category">${d.category}</div>
                    <div>${d.name}</div>
                </div>`
            ).join('');
            dropdown.classList.add('show');
        }

        // Debounced version (300ms delay for better performance)
        const searchNanda = debounce(searchNandaImpl, 300);

        function addDiagnosis(name) {
            if (!selectedDiagnoses.includes(name)) {
                selectedDiagnoses.push(name);
                renderDiagnoses();
            }
            document.getElementById('nandaSearch').value = '';
            document.getElementById('nandaDropdown').classList.remove('show');
        }

        function removeDiagnosis(name) {
            selectedDiagnoses = selectedDiagnoses.filter(d => d !== name);
            renderDiagnoses();
        }

        function renderDiagnoses() {
            document.getElementById('selectedDiagnoses').innerHTML = selectedDiagnoses.map(d =>
                `<div class="diagnosis-tag">${d}<span class="remove" onclick="removeDiagnosis('${d.replace(/'/g, "\\'")}')">&times;</span></div>`
            ).join('');
        }

        function appendToField(fieldId, text) {
            const field = document.getElementById(fieldId);
            field.value += text;
            field.focus();
        }

        function getSelectValue(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            const val = parseInt(el.value || '0', 10);
            return Number.isFinite(val) ? val : 0;
        }

        function hasScreeningResponses(prefix, count) {
            for (let i = 1; i <= count; i++) {
                const el = document.getElementById(prefix + i);
                if (el && el.value && el.value !== '0') return true;
            }
            return false;
        }

        function getPhq9Total() {
            let total = 0;
            for (let i = 1; i <= 9; i++) total += getSelectValue('phq' + i);
            return total;
        }

        function getGad7Total() {
            let total = 0;
            for (let i = 1; i <= 7; i++) total += getSelectValue('gad' + i);
            return total;
        }

        function getPhq9Severity(score) {
            if (score >= 20) return 'Severe';
            if (score >= 15) return 'Moderately severe';
            if (score >= 10) return 'Moderate';
            if (score >= 5) return 'Mild';
            return 'Minimal';
        }

        function getGad7Severity(score) {
            if (score >= 15) return 'Severe';
            if (score >= 10) return 'Moderate';
            if (score >= 5) return 'Mild';
            return 'Minimal';
        }

        function updatePhq9Score() {
            const total = getPhq9Total();
            const el = document.getElementById('phq9Score');
            if (el) el.textContent = total;
            return total;
        }

        function updateGad7Score() {
            const total = getGad7Total();
            const el = document.getElementById('gad7Score');
            if (el) el.textContent = total;
            return total;
        }

        function getScreeningSummary() {
            const hasPhq = hasScreeningResponses('phq', 9);
            const hasGad = hasScreeningResponses('gad', 7);
            if (!hasPhq && !hasGad) return '';
            const lines = [];
            if (hasPhq) {
                const phq = getPhq9Total();
                lines.push(`PHQ-9 Total: ${phq} (${getPhq9Severity(phq)})`);
            }
            if (hasGad) {
                const gad = getGad7Total();
                lines.push(`GAD-7 Total: ${gad} (${getGad7Severity(gad)})`);
            }
            return lines.join('\n');
        }

        function insertMentalHealthSummary() {
            const mental = (document.getElementById('h2tMental') || {}).value || '';
            const safety = (document.getElementById('h2tSafety') || {}).value || '';
            const screening = getScreeningSummary();
            const lines = [];
            if (mental.trim()) lines.push(`Mental status: ${mental.trim()}`);
            if (safety.trim()) lines.push(`Safety/Risk: ${safety.trim()}`);
            if (screening) lines.push(`Screening: ${screening}`);
            if (lines.length === 0) {
                showToast('Add mental status or screening scores first.', 'warning');
                return;
            }
            const target = document.getElementById('h2tPsych');
            if (!target) return;
            const existing = target.value.trim();
            target.value = existing ? `${existing}\n${lines.join('\n')}` : lines.join('\n');
            target.focus();
        }

        function clearForm() {
            if (!confirm('Clear all fields?')) return;
            document.querySelectorAll('input:not([type="date"]):not([type="time"]), textarea').forEach(el => el.value = '');
            // Reset select elements to first option
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
            document.getElementById('noteDate').value = formatDateDisplay(new Date());
            document.getElementById('noteTime').value = formatTimeDisplay(new Date());
            selectedDiagnoses = [];
            renderDiagnoses();
            // Clear saved medications display
            savedMedications = [];
            renderSavedMedications();
            // Clear saved screenings
            savedScreenings = [];
            renderSavedScreenings('phq9');
            renderSavedScreenings('gad7');
            // Clear saved lines/drains/airways
            savedLinesDA = [];
            renderSavedLines();
        }

        function formatTimeForFilename(t) { return t ? t.replace(':', '') : ''; }

        function getFormData() {
            // Handle date - format is MM/DD/YYYY from the input field
            let noteDate = 'N/A';
            let noteDateForFilename = '';
            const dateValue = document.getElementById('noteDate').value.trim();
            if (dateValue) {
                // Date field uses MM/DD/YYYY format - parse it correctly
                const parts = dateValue.split('/');
                if (parts.length === 3) {
                    const month = parseInt(parts[0], 10);
                    const day = parseInt(parts[1], 10);
                    const year = parseInt(parts[2], 10);
                    if (!isNaN(month) && !isNaN(day) && !isNaN(year)) {
                        // Format for display: M/D/YY
                        noteDate = `${month}/${day}/${String(year).slice(-2)}`;
                        // Format for filename: MMDDYYYY (no slashes)
                        noteDateForFilename = `${String(month).padStart(2,'0')}${String(day).padStart(2,'0')}${year}`;
                    }
                }
            }
            // Fallback to current date if empty or invalid
            if (noteDate === 'N/A') {
                const now = new Date();
                noteDate = now.toLocaleDateString('en-US', {month:'numeric',day:'numeric',year:'2-digit'});
                noteDateForFilename = `${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}${now.getFullYear()}`;
            }

            return {
                nurseName: document.getElementById('nurseName').value || 'N/A',
                credentials: document.getElementById('credentials').value,
                noteDate: noteDate,
                noteDateForFilename: noteDateForFilename,
                noteTime: formatTimeForFilename(document.getElementById('noteTime').value) || new Date().toTimeString().slice(0, 5).replace(':', ''),
                unit: document.getElementById('unit').value || '',
                patientId: document.getElementById('patientId').value || 'N/A',
                patientDemo: document.getElementById('patientDemo').value || '',
                focus: document.getElementById('focus').value || ''
            };
        }

        function getNoteContent() {
            const c = [], t = currentNoteType;
            if (t === 'dar') {
                c.push({l:'D',t:'Data',x:document.getElementById('darData').value});
                c.push({l:'A',t:'Action',x:document.getElementById('darAction').value});
                c.push({l:'R',t:'Response/Recommendations',x:document.getElementById('darResponse').value});
            } else if (t === 'darp') {
                c.push({l:'D',t:'Data',x:document.getElementById('darpData').value});
                c.push({l:'A',t:'Action',x:document.getElementById('darpAction').value});
                c.push({l:'R',t:'Response/Recommendations',x:document.getElementById('darpResponse').value});
                c.push({l:'P',t:'Plan',x:document.getElementById('darpPlan').value});
            } else if (t === 'soap') {
                c.push({l:'S',t:'Subjective',x:document.getElementById('soapSubjective').value});
                c.push({l:'O',t:'Objective',x:document.getElementById('soapObjective').value});
                c.push({l:'A',t:'Assessment',x:document.getElementById('soapAssessment').value});
                c.push({l:'P',t:'Plan',x:document.getElementById('soapPlan').value});
            } else if (t === 'soapie') {
                c.push({l:'S',t:'Subjective',x:document.getElementById('soapieSubjective').value});
                c.push({l:'O',t:'Objective',x:document.getElementById('soapieObjective').value});
                c.push({l:'A',t:'Assessment',x:document.getElementById('soapieAssessment').value});
                c.push({l:'P',t:'Plan',x:document.getElementById('soapiePlan').value});
                c.push({l:'I',t:'Intervention',x:document.getElementById('soapieIntervention').value});
                c.push({l:'E',t:'Evaluation',x:document.getElementById('soapieEvaluation').value});
            } else if (t === 'sbar') {
                c.push({l:'S',t:'Situation',x:document.getElementById('sbarSituation').value});
                c.push({l:'B',t:'Background',x:document.getElementById('sbarBackground').value});
                c.push({l:'A',t:'Assessment',x:document.getElementById('sbarAssessment').value});
                c.push({l:'R',t:'Recommendation',x:document.getElementById('sbarRecommendation').value});
            } else if (t === 'pie') {
                c.push({l:'P',t:'Problem',x:document.getElementById('pieProblem').value});
                c.push({l:'I',t:'Intervention',x:document.getElementById('pieIntervention').value});
                c.push({l:'E',t:'Evaluation',x:document.getElementById('pieEvaluation').value});
            } else if (t === 'narrative') {
                c.push({l:'',t:'Narrative',x:document.getElementById('narrativeText').value});
            } else if (t === 'h2t') {
                c.push({l:'',t:'HEENT',x:(document.getElementById('h2tHeent')||{}).value||''});
                c.push({l:'',t:'Neck',x:(document.getElementById('h2tNeck')||{}).value||''});
                c.push({l:'',t:'Neurological',x:document.getElementById('h2tNeuro').value});
                c.push({l:'',t:'Cardiovascular',x:document.getElementById('h2tCardio').value});
                c.push({l:'',t:'Respiratory',x:document.getElementById('h2tResp').value});
                c.push({l:'',t:'Gastrointestinal',x:document.getElementById('h2tGI').value});
                c.push({l:'',t:'Genitourinary',x:document.getElementById('h2tGU').value});
                c.push({l:'',t:'Skin/Integumentary',x:document.getElementById('h2tSkin').value});
                c.push({l:'',t:'Musculoskeletal',x:document.getElementById('h2tMSK').value});
                c.push({l:'',t:'Pain/Comfort',x:document.getElementById('h2tPain').value});
                c.push({l:'',t:'Mental Status',x:document.getElementById('h2tMental').value});
                c.push({l:'',t:'Safety/Risk',x:document.getElementById('h2tSafety').value});
                c.push({l:'',t:'Lines/Drains/Airway',x:document.getElementById('h2tLines').value});
                const screeningSummary = getScreeningSummary();
                if (screeningSummary) {
                    c.push({l:'',t:'Mental Health Screening',x:screeningSummary});
                }
                c.push({l:'',t:'Psychosocial/Notes',x:document.getElementById('h2tPsych').value});
            }
            return c.filter(i => i.x);
        }

        function buildNoteText() {
            const d = getFormData();
            const nc = getNoteContent();
            if (nc.length === 0) return '';
            const tn = {dar:'DAR',darp:'DARP',soap:'SOAP',soapie:'SOAPIE',sbar:'SBAR',pie:'PIE',h2t:'Head-to-Toe',narrative:'Narrative'};
            let out = [];
            out.push(`Note Type: ${tn[currentNoteType] || currentNoteType}`);
            out.push(`Nurse: ${d.nurseName} ${d.credentials || ''}`.trim());
            out.push(`Date: ${d.noteDate}  Time: ${d.noteTime}`);
            if (d.unit) out.push(`Unit: ${d.unit}`);
            if (d.patientId) out.push(`Patient: ${d.patientId}`);
            if (d.patientDemo) out.push(`Demographics: ${d.patientDemo}`);
            if (d.focus && ['dar','darp'].includes(currentNoteType)) out.push(`Focus: ${d.focus}`);
            out.push('');
            nc.forEach(item => {
                const label = item.l ? `${item.l} - ${item.t}` : item.t;
                out.push(label + ':');
                out.push(item.x);
                out.push('');
            });
            return out.join('\n').trim();
        }

        async function copyNoteToClipboard() {
            const text = buildNoteText();
            if (!text) {
                showToast('Add content before copying.', 'warning');
                return;
            }
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                }
                showToast('Copied to clipboard.', 'success');
            } catch (e) {
                console.error('Copy failed:', e);
                showToast('Copy failed. Try manual select.', 'error');
            }
        }

        async function generatePDF(btn) {
            if (btn) setButtonLoading(btn, true);
            try {
                // Lazy load jsPDF library
                await loadExportLibrary('jspdf');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
            const pw = doc.internal.pageSize.getWidth();
            const m = 18;
            const cw = pw - m*2;
            let y = 15;
            const d = getFormData();
            const nc = getNoteContent();
            const tn = {dar:'DAR',darp:'DARP',soap:'SOAP',soapie:'SOAPIE',sbar:'SBAR',pie:'PIE',h2t:'Head-to-Toe Assessment',narrative:'Narrative Note'};

            // Header
            doc.setFillColor(31, 78, 121);
            doc.rect(0, 0, pw, 28, 'F');
            doc.setTextColor(255);
            doc.setFontSize(18);
            doc.setFont('helvetica','bold');
            doc.text('Nursing Progress Note', pw/2, 12, {align:'center'});
            doc.setFontSize(11);
            doc.setFont('helvetica','normal');
            doc.text(tn[currentNoteType], pw/2, 22, {align:'center'});

            y = 36;
            doc.setTextColor(0);

            // Info box
            doc.setFillColor(248, 250, 252);
            doc.setDrawColor(31, 78, 121);
            doc.setLineWidth(0.3);
            doc.roundedRect(m, y, cw, 24, 2, 2, 'FD');
            doc.setFontSize(9);
            y += 8;
            doc.setFont('helvetica','bold');
            doc.text('Nurse:', m+4, y);
            doc.setFont('helvetica','normal');
            doc.text(`${d.nurseName}, ${d.credentials}`, m+18, y);
            doc.setFont('helvetica','bold');
            doc.text('Date/Time:', m+85, y);
            doc.setFont('helvetica','normal');
            doc.text(`${d.noteDate} @ ${d.noteTime}`, m+108, y);
            y += 8;
            doc.setFont('helvetica','bold');
            doc.text('Patient:', m+4, y);
            doc.setFont('helvetica','normal');
            doc.text(d.patientDemo ? `${d.patientId} (${d.patientDemo})` : d.patientId, m+22, y);
            if(d.unit){doc.setFont('helvetica','bold');doc.text('Unit:',m+85,y);doc.setFont('helvetica','normal');doc.text(d.unit,m+98,y);}
            y += 14;

            // NANDA diagnoses
            if (selectedDiagnoses.length > 0) {
                doc.setFillColor(240, 249, 255);
                doc.setDrawColor(31, 78, 121);
                const dxText = 'Nursing Dx: ' + selectedDiagnoses.join('; ');
                const dxLines = doc.splitTextToSize(dxText, cw - 8);
                const dxH = 8 + dxLines.length * 4;
                doc.roundedRect(m, y, cw, dxH, 2, 2, 'FD');
                doc.setFontSize(9);
                doc.setTextColor(31, 78, 121);
                doc.setFont('helvetica','normal');
                let dy = y + 6;
                dxLines.forEach(line => { doc.text(line, m + 4, dy); dy += 4; });
                y += dxH + 4;
                doc.setTextColor(0);
            }

            // Saved Vitals
            if (savedVitals.length > 0) {
                doc.setFillColor(232, 245, 233);
                doc.setDrawColor(76, 175, 80);
                const vitalsTitle = 'Vital Signs:';
                const vitalsContent = savedVitals.map(v => `${v.time}: ${v.display}`).join('\n');
                const vitalsLines = doc.splitTextToSize(vitalsContent, cw - 12);
                const vitalsH = 10 + vitalsLines.length * 4;
                doc.roundedRect(m, y, cw, vitalsH, 2, 2, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica','bold');
                doc.setTextColor(46, 125, 50);
                doc.text(vitalsTitle, m + 4, y + 6);
                doc.setFont('helvetica','normal');
                doc.setTextColor(0);
                let vy = y + 10;
                vitalsLines.forEach(line => { doc.text(line, m + 4, vy); vy += 4; });
                y += vitalsH + 4;
            }

            // Saved Medications
            if (savedMedications.length > 0) {
                doc.setFillColor(227, 242, 253);
                doc.setDrawColor(25, 118, 210);
                const medsTitle = 'Medications Administered:';
                const medsContent = savedMedications.map(m => `${m.time}: ${m.display}`).join('\n');
                const medsLines = doc.splitTextToSize(medsContent, cw - 12);
                const medsH = 10 + medsLines.length * 4;
                doc.roundedRect(m, y, cw, medsH, 2, 2, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica','bold');
                doc.setTextColor(21, 101, 192);
                doc.text(medsTitle, m + 4, y + 6);
                doc.setFont('helvetica','normal');
                doc.setTextColor(0);
                let my = y + 10;
                medsLines.forEach(line => { doc.text(line, m + 4, my); my += 4; });
                y += medsH + 4;
            }

            // Saved Screenings (PHQ-9 / GAD-7)
            if (savedScreenings.length > 0) {
                doc.setFillColor(252, 228, 236);
                doc.setDrawColor(233, 30, 99);
                const scrTitle = 'Mental Health Screenings:';
                const scrContent = savedScreenings.map(s => `${s.time}: ${s.display}`).join('\n');
                const scrLines = doc.splitTextToSize(scrContent, cw - 12);
                const scrH = 10 + scrLines.length * 4;
                if (y + scrH > 280) { doc.addPage(); y = 15; }
                doc.roundedRect(m, y, cw, scrH, 2, 2, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica','bold');
                doc.setTextColor(136, 14, 79);
                doc.text(scrTitle, m + 4, y + 6);
                doc.setFont('helvetica','normal');
                doc.setTextColor(0);
                let sy = y + 10;
                scrLines.forEach(line => { doc.text(line, m + 4, sy); sy += 4; });
                y += scrH + 4;
            }

            // Saved Lines/Drains/Airways
            if (savedLinesDA.length > 0) {
                doc.setFillColor(255, 243, 224);
                doc.setDrawColor(255, 152, 0);
                const ldaTitle = 'Lines / Drains / Airways:';
                const ldaContent = savedLinesDA.map(l => `${l.time}: ${l.display}`).join('\n');
                const ldaLines = doc.splitTextToSize(ldaContent, cw - 12);
                const ldaH = 10 + ldaLines.length * 4;
                if (y + ldaH > 280) { doc.addPage(); y = 15; }
                doc.roundedRect(m, y, cw, ldaH, 2, 2, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica','bold');
                doc.setTextColor(230, 81, 0);
                doc.text(ldaTitle, m + 4, y + 6);
                doc.setFont('helvetica','normal');
                doc.setTextColor(0);
                let ly = y + 10;
                ldaLines.forEach(line => { doc.text(line, m + 4, ly); ly += 4; });
                y += ldaH + 4;
            }

            // Focus
            if (['dar','darp'].includes(currentNoteType) && d.focus) {
                doc.setFillColor(31, 78, 121);
                doc.roundedRect(m, y, cw, 10, 2, 2, 'F');
                doc.setTextColor(255);
                doc.setFontSize(10);
                doc.setFont('helvetica','bold');
                doc.text('FOCUS: ' + d.focus, m + 4, y + 7);
                y += 14;
                doc.setTextColor(0);
            }

            // Content
            nc.forEach(s => {
                const lines = doc.splitTextToSize(s.x, cw - 4);
                const sh = 12 + lines.length * 4.5;
                if (y + sh > 280) { doc.addPage(); y = 15; }

                // Section header - inline bold label
                doc.setFontSize(10);
                doc.setFont('helvetica','bold');
                doc.setTextColor(31, 78, 121);
                const label = s.l ? (s.l + ' - ' + s.t + ':') : (s.t + ':');
                doc.text(label, m, y + 5);

                y += 9;
                doc.setFont('helvetica','normal');
                doc.setFontSize(9);
                doc.setTextColor(50);
                lines.forEach(line => {
                    if (y > 280) { doc.addPage(); y = 15; }
                    doc.text(line, m + 2, y);
                    y += 4.5;
                });
                y += 4;
            });

            // Signature
            y += 8;
            if (y > 265) { doc.addPage(); y = 15; }
            doc.setDrawColor(180);
            doc.setLineWidth(0.2);
            doc.line(m, y, m + 70, y);
            doc.setFontSize(9);
            doc.setTextColor(0);
            doc.text(`${d.nurseName}, ${d.credentials}`, m, y + 6);
            doc.text(`${d.noteDate} @ ${d.noteTime}`, m, y + 11);

            // Disclaimer
            doc.setFontSize(7);
            doc.setTextColor(140);
            doc.text('*Patient demographics are simulated for educational purposes. No real patient information.', pw/2, 290, {align:'center'});

            // Get last name from nurse name (last word)
            const nameParts = d.nurseName.trim().split(' ');
            const lastName = nameParts[nameParts.length - 1] || 'Student';
            doc.save(`${d.noteDateForFilename}_${d.noteTime}_${currentNoteType.toUpperCase()}_${lastName}.pdf`);

            // Log export to Firebase for admin tracking
            logExportHistory('PDF', currentNoteType, d.patientId);
            } catch(e) {
                console.error('PDF export error:', e);
                showToast('Error generating PDF: ' + e.message, 'error');
            } finally {
                if (btn) setButtonLoading(btn, false);
            }
        }

        async function generateWord(btn) {
            if (btn) setButtonLoading(btn, true);
            try {
                // Lazy load docx and FileSaver libraries
                await Promise.all([
                    loadExportLibrary('docx'),
                    loadExportLibrary('filesaver')
                ]);

                const d = getFormData();
                const nc = getNoteContent();
                const tn = {dar:'DAR',darp:'DARP',soap:'SOAP',soapie:'SOAPIE',sbar:'SBAR',pie:'PIE',h2t:'Head-to-Toe Assessment',narrative:'Narrative Note'};

                const { Document, Packer, Paragraph, TextRun, AlignmentType } = docx;
                const ch = [];

                // Title
                ch.push(new Paragraph({
                    children: [new TextRun({text: 'Nursing Progress Note', bold: true, size: 32, color: '1f4e79'})],
                    alignment: AlignmentType.CENTER,
                    spacing: {after: 100}
                }));

                // Note type
                ch.push(new Paragraph({
                    children: [new TextRun({text: tn[currentNoteType], size: 22, color: '1f4e79'})],
                    alignment: AlignmentType.CENTER,
                    spacing: {after: 200}
                }));

                // Nurse and date info
                ch.push(new Paragraph({
                    children: [
                        new TextRun({text: 'Nurse: ', bold: true}),
                        new TextRun(d.nurseName + ', ' + d.credentials),
                        new TextRun({text: '    Date/Time: ', bold: true}),
                        new TextRun(d.noteDate + ' @ ' + d.noteTime)
                    ],
                    spacing: {after: 80}
                }));

                // Patient info
                const patientChildren = [
                    new TextRun({text: 'Patient: ', bold: true}),
                    new TextRun(d.patientDemo ? d.patientId + ' (' + d.patientDemo + ')' : d.patientId)
                ];
                if (d.unit) {
                    patientChildren.push(new TextRun({text: '    Unit: ', bold: true}));
                    patientChildren.push(new TextRun(d.unit));
                }
                ch.push(new Paragraph({children: patientChildren, spacing: {after: 150}}));

                // NANDA diagnoses
                if (selectedDiagnoses.length > 0) {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: 'Nursing Dx: ' + selectedDiagnoses.join('; '), color: '1f4e79'})],
                        spacing: {after: 150}
                    }));
                }

                // Saved Vitals
                if (savedVitals.length > 0) {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: 'Vital Signs:', bold: true, color: '2e7d32'})],
                        spacing: {before: 100, after: 50}
                    }));
                    savedVitals.forEach(v => {
                        ch.push(new Paragraph({
                            children: [
                                new TextRun({text: v.time + ': ', bold: true, color: '2e7d32'}),
                                new TextRun(v.display)
                            ],
                            spacing: {after: 40}
                        }));
                    });
                }

                // Saved Medications
                if (savedMedications.length > 0) {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: 'Medications Administered:', bold: true, color: '1565c0'})],
                        spacing: {before: 100, after: 50}
                    }));
                    savedMedications.forEach(m => {
                        ch.push(new Paragraph({
                            children: [
                                new TextRun({text: m.time + ': ', bold: true, color: '1565c0'}),
                                new TextRun(m.display)
                            ],
                            spacing: {after: 40}
                        }));
                    });
                }

                // Saved Screenings (PHQ-9 / GAD-7)
                if (savedScreenings.length > 0) {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: 'Mental Health Screenings:', bold: true, color: '880e4f'})],
                        spacing: {before: 100, after: 50}
                    }));
                    savedScreenings.forEach(s => {
                        ch.push(new Paragraph({
                            children: [
                                new TextRun({text: s.time + ': ', bold: true, color: '880e4f'}),
                                new TextRun(s.display)
                            ],
                            spacing: {after: 40}
                        }));
                    });
                }

                // Saved Lines/Drains/Airways
                if (savedLinesDA.length > 0) {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: 'Lines / Drains / Airways:', bold: true, color: 'e65100'})],
                        spacing: {before: 100, after: 50}
                    }));
                    savedLinesDA.forEach(l => {
                        ch.push(new Paragraph({
                            children: [
                                new TextRun({text: l.time + ': ', bold: true, color: 'e65100'}),
                                new TextRun(l.display)
                            ],
                            spacing: {after: 40}
                        }));
                    });
                }

                // Focus (for DAR/DARP)
                if (['dar','darp'].includes(currentNoteType) && d.focus) {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: 'FOCUS: ' + d.focus, bold: true, color: '1f4e79'})],
                        spacing: {after: 150}
                    }));
                }

                // Note content
                nc.forEach(s => {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: (s.l ? s.l + ' - ' : '') + s.t, bold: true, size: 22, color: '1f4e79'})],
                        spacing: {before: 150, after: 80}
                    }));
                    ch.push(new Paragraph({
                        children: [new TextRun(s.x)],
                        spacing: {after: 120}
                    }));
                });

                // Disclaimer
                ch.push(new Paragraph({text: '', spacing: {before: 200}}));
                ch.push(new Paragraph({
                    children: [new TextRun({text: '*Patient demographics are simulated for educational purposes. No real patient information.', italics: true, size: 18, color: '666666'})],
                    spacing: {after: 200}
                }));

                // Signature line
                ch.push(new Paragraph({children: [new TextRun('________________________________')]}));
                ch.push(new Paragraph({children: [new TextRun(d.nurseName + ', ' + d.credentials)], spacing: {after: 40}}));
                ch.push(new Paragraph({children: [new TextRun(d.noteDate + ' @ ' + d.noteTime)]}));

                const doc = new Document({sections: [{children: ch}]});
                const blob = await Packer.toBlob(doc);
                // Get last name from nurse name (last word)
                const nameParts = d.nurseName.trim().split(' ');
                const lastName = nameParts[nameParts.length - 1] || 'Student';
                saveAs(blob, d.noteDateForFilename + '_' + d.noteTime + '_' + currentNoteType.toUpperCase() + '_' + lastName + '.docx');

                // Log export to Firebase for admin tracking
                logExportHistory('Word', currentNoteType, d.patientId);

            } catch(e) {
                console.error('Word export error:', e);
                showToast('Error generating Word document: ' + e.message + '. Please try PDF export instead.', 'error');
            } finally {
                if (btn) setButtonLoading(btn, false);
            }
        }

        document.addEventListener('click', e => {
            if (!e.target.closest('.nanda-search')) document.getElementById('nandaDropdown').classList.remove('show');
        });

        // ========== EXPORT HISTORY TRACKING ==========
        function logExportHistory(exportFormat, noteType, patientId) {
            const uid = localStorage.getItem('bsn9b_uid');
            const userEmail = localStorage.getItem('bsn9b_user') || 'anonymous';
            const displayName = localStorage.getItem('bsn9b_displayName') || userEmail;

            if (!uid) {
                console.log('No UID for export logging');
                return;
            }

            try {
                database.ref('userExportHistory/' + uid).push({
                    timestamp: Date.now(),
                    date: new Date().toLocaleString(),
                    exportFormat: exportFormat,
                    noteType: noteType,
                    patientId: patientId || 'N/A',
                    userEmail: userEmail,
                    displayName: displayName
                });
            } catch (e) {
                console.log('Export logging failed:', e);
            }
        }

        // ========== FIREBASE LISTENER CLEANUP ==========
        function cleanupFirebaseListeners() {
            try {
                if (typeof announcementsRef !== 'undefined') announcementsRef.off();
                if (typeof bannedRef !== 'undefined') bannedRef.off();
                if (typeof presenceRef !== 'undefined') presenceRef.off();
                console.log('Firebase listeners cleaned up');
            } catch (e) {
                console.log('Error cleaning up listeners:', e);
            }
        }

        window.addEventListener('beforeunload', cleanupFirebaseListeners);
        window.addEventListener('pagehide', cleanupFirebaseListeners);

        // ========== KEYBOARD NAVIGATION ==========
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close modals
                document.querySelectorAll('.modal:not(.hidden)').forEach(m => m.classList.add('hidden'));
                // Close more menu
                const moreMenu = document.getElementById('moreMenu');
                if (moreMenu) moreMenu.classList.remove('show');
                // Close NANDA dropdown
                const nandaDropdown = document.getElementById('nandaDropdown');
                if (nandaDropdown) nandaDropdown.classList.remove('show');
            }
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>
    <script src="/shared/header.js"></script>
</body>
</html>
