<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>if(location.protocol !== 'https:' && location.hostname !== 'localhost'){location.replace('https:' + location.href.substring(location.protocol.length));}</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="theme-color" content="#1f4e79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSN9B">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <!-- Preconnect hints for faster external resource loading -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <title>BSN9B Nursing Documentation</title>
    <script>
        if (localStorage.getItem('bsn9b_auth') !== 'true') {
            window.location.href = '/';
        }
    </script>
    <!-- Export libraries loaded on-demand via lazy loading (see loadExportLibrary function) -->
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-page: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #fafafa;
            --bg-input: #fafafa;
            --bg-input-focus: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #666666;
            --text-muted: #888888;
            --accent: #1f4e79;
            --accent-light: #2d5a87;
            --accent-hover: #f8fafc;
            --border: #e0e0e0;
            --border-light: #ddd;
            --border-focus: #1f4e79;
            --shadow: rgba(0,0,0,0.4);
            --shadow-light: rgba(0,0,0,0.15);
            --warning-bg: #fff5f5;
            --warning-border: #e53e3e;
            --warning-text: #c53030;
            --info-bg: #fffbeb;
            --info-border: #d69e2e;
            --btn-clear-bg: #f0f0f0;
            --btn-clear-text: #333333;
            --card-active-bg: #1f4e79;
            --card-active-text: #ffffff;
            --nanda-bg: #f8fafc;
            --nanda-border: #e2e8f0;
            --chat-msg-other-bg: #e2e8f0;
            --chat-msg-other-text: #333333;
        }

        [data-theme="dark"] {
            --bg-page: linear-gradient(135deg, #0a0a14 0%, #0d1117 50%, #161b22 100%);
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #1e2a3a;
            --bg-input: #16213e;
            --bg-input-focus: #1e2a3a;
            --text-primary: #e6e6e6;
            --text-secondary: #aaaaaa;
            --text-muted: #888888;
            --accent: #4a90d9;
            --accent-light: #5a9fe8;
            --accent-hover: #1e2a3a;
            --border: #2d3748;
            --border-light: #3d4758;
            --border-focus: #4a90d9;
            --shadow: rgba(0,0,0,0.6);
            --shadow-light: rgba(0,0,0,0.3);
            --warning-bg: #2d1f1f;
            --warning-border: #e53e3e;
            --warning-text: #fc8181;
            --info-bg: #2d2a1f;
            --info-border: #d69e2e;
            --btn-clear-bg: #2d3748;
            --btn-clear-text: #e6e6e6;
            --card-active-bg: #4a90d9;
            --card-active-text: #ffffff;
            --nanda-bg: #16213e;
            --nanda-border: #2d3748;
            --chat-msg-other-bg: #2d3748;
            --chat-msg-other-text: #e6e6e6;
        }

        /* Dark mode chat widget styles */
        [data-theme="dark"] #chatBox {
            background: var(--bg-primary) !important;
        }
        [data-theme="dark"] #chatMessages,
        [data-theme="dark"] #dmMessages,
        [data-theme="dark"] #dmConversationList {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #chatInput,
        [data-theme="dark"] #dmInput {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #mentionDropdown {
            background: var(--bg-primary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #dmHeader,
        [data-theme="dark"] #newDMSelector > div:first-child {
            background: var(--bg-tertiary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #dmHeader span,
        [data-theme="dark"] #newDMSelector span {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #dmPartnerStatus {
            background: var(--bg-secondary) !important;
            color: var(--text-secondary) !important;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* Loading state for buttons */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: btn-spin 0.8s linear infinite;
        }
        @keyframes btn-spin {
            to { transform: rotate(360deg); }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-page);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
            transition: background 0.3s ease;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 16px;
            box-shadow: 0 20px 60px var(--shadow);
            overflow: hidden;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        .header {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 13px; }
        .form-container { padding: 30px; background: var(--bg-primary); transition: background 0.3s ease; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; font-size: 13px; transition: color 0.3s ease; }
        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--bg-input);
            color: var(--text-primary);
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(31, 78, 121, 0.1);
            background: var(--bg-input-focus);
        }
        textarea { min-height: 80px; resize: vertical; }
        textarea.large { min-height: 120px; }
        .note-type-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .note-type-card {
            padding: 14px 8px;
            border: 2px solid var(--border);
            background: var(--bg-primary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: var(--text-primary);
        }
        .note-type-card:hover { border-color: var(--accent); background: var(--accent-hover); }
        .note-type-card.active {
            border-color: var(--accent);
            background: var(--card-active-bg);
            color: var(--card-active-text);
        }
        .note-type-card h3 { font-size: 15px; margin-bottom: 3px; }
        .note-type-card p { font-size: 9px; opacity: 0.8; }
        .section-title {
            font-size: 16px;
            color: var(--accent);
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent);
        }
        .note-fields { display: none; }
        .note-fields.active { display: block; }
        .field-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .field-letter {
            width: 28px; height: 28px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
        }
        .field-info h4 { font-size: 13px; color: var(--text-primary); }
        .field-info p { font-size: 11px; color: var(--text-secondary); }
        .btn-container { display: flex; gap: 12px; margin-top: 25px; }
        .btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-pdf { background: var(--accent); color: white; }
        .btn-word { background: var(--accent-light); color: white; }
        .btn-clear { background: var(--btn-clear-bg); color: var(--btn-clear-text); flex: 0.4; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px var(--shadow-light); }
        .warning-box {
            background: var(--warning-bg);
            border: 1px solid var(--warning-border);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 12px;
            color: var(--warning-text);
        }
        .info-box {
            background: var(--info-bg);
            border: 1px solid var(--info-border);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 12px;
            color: var(--text-primary);
        }
        .info-box ul { margin: 8px 0 0 18px; }
        .info-box li { margin-bottom: 3px; }
        /* NANDA Search */
        .nanda-section { margin: 20px 0; padding: 15px; background: var(--nanda-bg); border-radius: 10px; border: 1px solid var(--nanda-border); transition: background 0.3s ease, border-color 0.3s ease; }
        .nanda-search { position: relative; }
        .nanda-search input { padding-right: 35px; }
        .nanda-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-light);
            z-index: 100;
            display: none;
        }
        .nanda-dropdown.show { display: block; }
        .nanda-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-primary);
        }
        .nanda-item:hover { background: var(--accent-hover); }
        .nanda-item .category { font-size: 10px; color: var(--accent); font-weight: 600; }
        .selected-diagnoses { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .diagnosis-tag {
            background: var(--accent);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .diagnosis-tag .remove { cursor: pointer; opacity: 0.8; }
        .diagnosis-tag .remove:hover { opacity: 1; }
        /* H2T Assessment */
        .h2t-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .h2t-section { background: var(--nanda-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--nanda-border); transition: background 0.3s ease, border-color 0.3s ease; }
        .h2t-section h4 { font-size: 13px; color: var(--accent); margin-bottom: 8px; border-bottom: 1px solid var(--nanda-border); padding-bottom: 5px; }
        .quick-fills { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
        .quick-fill {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }
        .quick-fill:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .h2t-section textarea { min-height: 60px; font-size: 12px; }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 10px;
            transition: color 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .toolbar-item:hover { color: var(--accent); }
        .toolbar-item.active { color: var(--accent); }
        .toolbar-item .icon { font-size: 24px; margin-bottom: 2px; }
        .toolbar-item .label { font-weight: 600; }

        .mobile-action-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 60px;
            display: none;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(255,255,255,0.96);
            border-top: 1px solid #e2e8f0;
            box-shadow: 0 -6px 20px rgba(0,0,0,0.08);
            z-index: 1001;
            backdrop-filter: blur(8px);
        }

        .mobile-action-btn {
            flex: 1;
            border: none;
            border-radius: 10px;
            padding: 10px 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            color: white;
        }

        .mobile-action-btn.save { background: linear-gradient(135deg, #10b981, #059669); }
        .mobile-action-btn.copy { background: linear-gradient(135deg, #0f766e, #0d9488); }
        .mobile-action-btn.pdf { background: linear-gradient(135deg, #1f4e79, #2d5a87); }
        .mobile-action-btn.word { background: linear-gradient(135deg, #7c3aed, #8b5cf6); }

        .mobile-action-status {
            display: none;
            position: fixed;
            right: 12px;
            bottom: 120px;
            background: #0f172a;
            color: white;
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 999px;
            z-index: 1002;
            opacity: 0.9;
        }

        .section-jump-btn {
            position: fixed;
            right: 12px;
            bottom: 130px;
            z-index: 1002;
            display: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #1f4e79, #2d5a87);
            color: white;
            font-size: 18px;
            box-shadow: 0 8px 20px rgba(31,78,121,0.35);
            cursor: pointer;
        }

        .section-jump-panel {
            position: fixed;
            right: 12px;
            bottom: 180px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
            width: 220px;
            max-height: 50vh;
            overflow-y: auto;
            display: none;
            z-index: 1003;
        }

        .section-jump-item {
            padding: 10px 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
            cursor: pointer;
        }
        .section-jump-item:hover { background: #f8fafc; }

        /* More Menu */
        .more-menu {
            position: fixed;
            bottom: 70px;
            right: 10px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 8px 0;
            display: none;
            z-index: 1001;
            min-width: 160px;
            border: 1px solid var(--border);
        }

        .more-menu.show { display: block; }

        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
        }

        .more-menu-item:hover { background: var(--bg-secondary); }
        .more-menu-item .menu-icon { font-size: 18px; }
        /* ========== MOBILE RESPONSIVE STYLES ========== */

        /* Smooth scrolling for all elements */
        html { scroll-behavior: smooth; }

        /* Touch-friendly scrolling */
        .form-container, #chatMessages, #dmMessages, #aiMessages {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* Minimum touch target size (44px recommended by Apple/Google) */
        @media (pointer: coarse) {
            button, .btn, .toolbar-item, .more-menu-item, .note-type-card {
                min-height: 44px;
            }
            select, input[type="checkbox"], input[type="radio"] {
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* Tablet breakpoint (768px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .container { max-width: 90%; }
            .note-type-grid { grid-template-columns: repeat(3, 1fr); }
        }

        /* Tablet/Large phone (max-width: 768px) */
        @media (max-width: 768px) {
            .note-type-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row, .form-row.three-col, .h2t-grid { grid-template-columns: 1fr; }
            .btn-container { flex-direction: column; }

            /* Better spacing for toolbar */
            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            .mobile-action-bar { display: flex; }
            .mobile-action-status { display: block; }
            .section-jump-btn { display: block; }
        }

        /* Mobile: Large phones (max-width: 640px) */
        @media (max-width: 640px) {
            body {
                padding: 10px;
                padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px));
            }
            .container { border-radius: 12px; }
            .header { padding: 20px; }
            .header h1 { font-size: 22px; }
            .form-container { padding: 20px; }

            /* Chat widget - full screen overlay on mobile */
            #chatBox, #aiBox {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: none !important;
                border-radius: 0 !important;
                z-index: 10000 !important;
                /* Safe area for notched phones */
                padding-top: env(safe-area-inset-top, 0px);
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            /* Larger touch targets for toggle buttons */
            #chatToggle, #aiToggle {
                width: 56px !important;
                height: 56px !important;
            }

            /* Modal adjustments */
            #phrasesModal > div,
            #feedbackModal > div {
                max-width: calc(100vw - 30px) !important;
                max-height: calc(100vh - 40px) !important;
                margin: 15px !important;
            }

            /* Better textarea sizing */
            textarea {
                min-height: 120px;
            }
        }

        /* Mobile: Standard phones (max-width: 480px) */
        @media (max-width: 480px) {
            body { padding: 8px; }
            .header { padding: 15px; }
            .header h1 { font-size: 20px; }
            .header p { font-size: 11px; }
            .form-container { padding: 15px; }

            .note-type-grid { grid-template-columns: 1fr !important; gap: 8px; }
            .note-type-card { padding: 12px; min-height: 60px; }
            .note-type-card h3 { font-size: 14px; }

            /* Prevent iOS zoom on input focus (minimum 16px) */
            input, select, textarea {
                font-size: 16px !important;
            }

            .btn {
                padding: 16px !important;
                font-size: 15px !important;
                min-height: 50px;
            }

            /* Widget toggle buttons */
            #chatToggle, #aiToggle {
                width: 50px !important;
                height: 50px !important;
                font-size: 20px !important;
            }

            /* Chat input area */
            #chatInput, #aiInput, #dmInput {
                font-size: 16px !important;
                padding: 12px !important;
            }

            /* Better form field spacing */
            .form-group {
                margin-bottom: 16px;
            }

            label {
                margin-bottom: 8px;
                display: block;
            }
        }

        /* Mobile: Small phones (max-width: 320px) */
        @media (max-width: 320px) {
            body { padding: 5px; }
            .header h1 { font-size: 18px; }
            .form-container { padding: 12px; }

            .section-title { font-size: 14px; }
            label { font-size: 12px; }

            #chatToggle, #aiToggle {
                width: 46px !important;
                height: 46px !important;
                font-size: 18px !important;
            }
        }

        /* Prevent widget overlap on narrow screens */
        @media (max-width: 400px) {
            #aiWidget {
                bottom: 80px !important;
            }
        }

        /* Landscape phone orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .header { padding: 10px 20px; }
            .header h1 { font-size: 18px; }
            .header p { display: none; }
            .bottom-toolbar { height: 50px; }
            .toolbar-item .label { display: none; }
        }

        /* Safe area insets for bottom toolbar */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(60px + env(safe-area-inset-bottom));
            }
            body {
                padding-bottom: calc(120px + env(safe-area-inset-bottom));
            }
        }

        /* Drug Autocomplete */
        .drug-autocomplete-wrapper {
            position: relative;
        }
        .drug-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 2px solid #1976d2;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 200;
            display: none;
        }
        .drug-dropdown.show { display: block; }
        .drug-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            color: #333;
        }
        .drug-item:hover { background: #e3f2fd; }
        .drug-item:last-child { border-bottom: none; }
        .drug-loading {
            padding: 10px 12px;
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
        /* Pulse animation for RN Resources button */
        @keyframes pulse-btn {
            0% { box-shadow: 0 4px 15px rgba(255,107,53,0.4); }
            50% { box-shadow: 0 4px 25px rgba(255,107,53,0.7); }
            100% { box-shadow: 0 4px 15px rgba(255,107,53,0.4); }
        }

        /* Focus visible styles for keyboard navigation */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        button:focus-visible, a:focus-visible, .note-type-card:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; max-width: 380px; }
        .toast { padding: 14px 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); display: flex; align-items: flex-start; gap: 12px; animation: toastSlideIn 0.3s ease; color: white; font-size: 14px; line-height: 1.4; }
        .toast.hiding { animation: toastSlideOut 0.3s ease forwards; }
        .toast-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .toast-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .toast-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .toast-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .toast-icon { font-size: 18px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-message { opacity: 0.95; }
        .toast-close { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; font-size: 18px; padding: 0; line-height: 1; }
        .toast-close:hover { opacity: 1; }
        @keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @media (max-width: 480px) { .toast-container { left: 10px; right: 10px; max-width: none; } }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
        <div class="header">
            <div id="userDisplayContainer" style="position: absolute; top: 15px; right: 20px;">
                <span id="userDisplay" style="color: rgba(255,255,255,0.8); font-size: 12px;"></span>
            </div>
            <h1>Sumner BSN9B Nursing Documentation</h1>
            <p>Progress Notes | Head-to-Toe | NANDA Diagnoses</p>
            <a href="/resources/" style="display: inline-block; margin-top: 15px; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; text-decoration: none; padding: 14px 30px; border-radius: 25px; font-size: 16px; font-weight: 700; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,107,53,0.4); animation: pulse-btn 2s infinite;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(255,107,53,0.6)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(255,107,53,0.4)'">üìö RN Resources - Click Here!</a>
        </div>
        <div class="form-container">
            <div class="warning-box">
                <strong>HIPAA Notice:</strong> Do NOT enter any real patient information including names, initials, DOB, or MRN. Use fictional identifiers only (e.g., "Patient A", "Room 302", "Sim Patient").
            </div>
            <div class="info-box">
                <strong>Quick Start:</strong> Enter info ‚Üí Select format ‚Üí Document ‚Üí Export PDF/Word. Use <strong>Smart Phrases</strong> (üìù button) for shortcuts. <strong>Chat</strong> with classmates (üí¨ bottom-right). Ask the <strong>AI Nursing Companion</strong> (ü©∫ bottom-left) for drug info, care plans, and NCLEX help!
            </div>
            <div id="autoSaveStatus" style="margin-top: 10px; font-size: 12px; color: #64748b;">Draft not saved</div>
            <style>
                @keyframes pulse {
                    0%, 100% { box-shadow: -4px 4px 15px rgba(0,0,0,0.4); }
                    50% { box-shadow: -4px 4px 25px rgba(255,152,0,0.6); }
                }
                .phrase-item { position: relative; cursor: help; padding: 4px 6px; border-radius: 4px; transition: background 0.2s; }
                .phrase-item:hover { background: #e3f2fd; }
                .phrase-item .tooltip {
                    display: none; position: absolute; top: 100%; left: 0;
                    background: #333; color: #fff; padding: 10px 12px; border-radius: 6px;
                    font-size: 12px; white-space: normal; word-wrap: break-word;
                    width: 220px; z-index: 9999;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.5); line-height: 1.5;
                    text-align: left; margin-top: 5px;
                }
                .phrase-item:hover .tooltip { display: block; }
            </style>

            <!-- Smart Phrases Modal with Tooltips -->
            <div id="phrasesModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) this.classList.add('hidden')">
                <div style="background: white; border-radius: 12px; padding: 20px; max-width: 550px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #1f4e79; padding-bottom: 10px;">
                        <h3 style="color: #1f4e79; margin: 0;">üìù Smart Phrases Reference</h3>
                        <button onclick="document.getElementById('phrasesModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Type shortcut + <strong>space</strong> to expand. <em>Hover over any phrase to preview.</em></p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.vs</code> Vital Signs<span class="tooltip">BP: __ | HR: __ | O2: __% | RR: __ | T: __ | Pain: __/10</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.neuro</code> Neuro<span class="tooltip">A&Ox4. PERRLA. GCS 15. MAE x4.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.resp</code> Respiratory<span class="tooltip">CTA bilat. No adventitious sounds. Unlabored. O2: __% on __.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.cv</code> Cardiovascular<span class="tooltip">S1S2 RRR. No murmurs. Pulses 2+ x4. Cap refill <3s. No edema.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.gi</code> GI<span class="tooltip">BS active x4 quads. Abdomen soft, NT, ND. Last BM: __.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.gu</code> GU<span class="tooltip">Voiding without difficulty. Urine clear yellow.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.skin</code> Skin<span class="tooltip">Warm, dry, intact. No breakdown or pressure injuries.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.pain</code> Pain<span class="tooltip">Pain __/10 at __. Quality: __. Duration: __. Interventions: __.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.nkda</code> NKDA<span class="tooltip">NKDA (No Known Drug Allergies).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.denies</code> Denies<span class="tooltip">Patient denies pain, nausea, SOB, dizziness, chest pain.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.aox4</code> A&Ox4<span class="tooltip">Alert and oriented x4 (person, place, time, situation).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.aox3</code> A&Ox3<span class="tooltip">Alert and oriented x3 (person, place, time).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.perrla</code> PERRLA<span class="tooltip">PERRLA (Pupils Equal, Round, Reactive to Light and Accommodation).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.mae</code> MAE<span class="tooltip">MAE x4 (Moving All Extremities).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.cta</code> CTA<span class="tooltip">CTA bilat (Clear to Auscultation bilaterally).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.rrr</code> RRR<span class="tooltip">S1S2 RRR (Regular Rate and Rhythm). No murmurs, rubs, or gallops.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.bsax4</code> BS x4<span class="tooltip">BS active x4 quadrants.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.ntnd</code> NTND<span class="tooltip">Non-tender, non-distended.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.ivp</code> IV Patent<span class="tooltip">IV patent, no redness/swelling at site. Flushed with 10mL NS.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.fs</code> Foley<span class="tooltip">Foley catheter patent, draining clear yellow urine. Secured to thigh.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.medadmin</code> Med Admin<span class="tooltip">Medication administered as ordered. Patient tolerated without adverse effects.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.amb</code> Ambulation<span class="tooltip">Assisted patient with ambulation in hallway. Gait steady, tolerated well.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.fall</code> Fall Risk<span class="tooltip">Fall precautions in place. Bed in low position. Call light within reach.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.safe</code> Safety<span class="tooltip">Side rails up x2. Bed alarm on. Call light in reach. Non-skid socks on.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.wdta</code> Monitor<span class="tooltip">Will continue to monitor. Patient tolerated well. No adverse effects noted.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.wnl</code> WNL<span class="tooltip">Within normal limits.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.nad</code> NAD<span class="tooltip">No acute distress.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.edu</code> Education<span class="tooltip">Patient educated on __. Patient verbalized understanding.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.dc</code> Discharge<span class="tooltip">Discharge instructions reviewed with patient. Patient verbalized understanding.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.tcdb</code> TCDB<span class="tooltip">Encouraged to turn, cough, and deep breathe.</span></div>
                    </div>
                </div>
            </div>

            <!-- Feedback Modal -->
            <div id="feedbackModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) this.classList.add('hidden')">
                <div style="background: white; border-radius: 16px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #4caf50; padding-bottom: 15px;">
                        <h3 style="color: #388e3c; margin: 0;">üí° Feedback & Suggestions</h3>
                        <button onclick="document.getElementById('feedbackModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #888;">√ó</button>
                    </div>
                    <p style="color: #555; font-size: 14px; margin-bottom: 20px;">Help us improve! Report issues, suggest new features, or request new smart phrases.</p>
                    <form action="https://formsubmit.co/christiankholden@gmail.com" method="POST" target="_blank">
                        <input type="hidden" name="_subject" value="BendBSN Feedback/Suggestion">
                        <input type="hidden" name="_captcha" value="false">
                        <input type="hidden" name="_template" value="table">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; color: #333; margin-bottom: 6px; font-size: 13px;">Type</label>
                            <select name="type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                <option value="Bug/Issue">Bug or Issue</option>
                                <option value="Feature Request">Feature Request</option>
                                <option value="Smart Phrase Suggestion">Smart Phrase Suggestion</option>
                                <option value="General Feedback">General Feedback</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; color: #333; margin-bottom: 6px; font-size: 13px;">Your Name (optional)</label>
                            <input type="text" name="name" placeholder="Your name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; color: #333; margin-bottom: 6px; font-size: 13px;">Message</label>
                            <textarea name="message" placeholder="Describe the issue, feature, or suggestion..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; min-height: 120px; resize: vertical;" required></textarea>
                        </div>
                        <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Submit Feedback</button>
                    </form>
                </div>
            </div>

            <h2 class="section-title">Patient & Nurse Information</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Nurse Name</label>
                    <input type="text" id="nurseName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Credentials</label>
                    <select id="credentials">
                        <option value="Student RN">Student RN</option>
                        <option value="RN">RN</option>
                        <option value="BSN, RN">BSN, RN</option>
                        <option value="LPN">LPN</option>
                    </select>
                </div>
            </div>
            <div class="form-row three-col">
                <div class="form-group">
                    <label>Date <span style="font-weight: normal; font-size: 10px; color: #666;">(T=today, T+1, T-3)</span></label>
                    <input type="text" id="noteDateText" placeholder="T for today" style="display:none;">
                    <input type="date" id="noteDate" onfocus="showDateShortcut()" onblur="hideDateShortcut()">
                </div>
                <div class="form-group">
                    <label>Time <span style="font-weight: normal; font-size: 10px; color: #666;">(N=now, N-30, N+15)</span></label>
                    <input type="text" id="noteTimeText" placeholder="N for now" style="display:none;">
                    <input type="time" id="noteTime" onfocus="showTimeShortcut()" onblur="hideTimeShortcut()">
                </div>
                <div class="form-group">
                    <label>Unit</label>
                    <input type="text" id="unit" placeholder="e.g., Med-Surg 3B">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Patient ID</label>
                    <input type="text" id="patientId" placeholder="e.g., J.D. / Room 302">
                </div>
                <div class="form-group">
                    <label>Demographics</label>
                    <input type="text" id="patientDemo" placeholder="e.g., 42yom">
                </div>
            </div>

            <h2 class="section-title">Documentation Format</h2>
            <div class="note-type-grid">
                <div class="note-type-card active" onclick="selectNoteType('dar')">
                    <h3>DAR</h3>
                    <p>Data, Action, Response</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('darp')">
                    <h3>DARP</h3>
                    <p>DAR + Plan</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('soap')">
                    <h3>SOAP</h3>
                    <p>Subj, Obj, Assess, Plan</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('sbar')">
                    <h3>SBAR</h3>
                    <p>Situation, Background</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('pie')">
                    <h3>PIE</h3>
                    <p>Problem, Intervention</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('h2t')">
                    <h3>H2T</h3>
                    <p>Head-to-Toe Assessment</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('soapie')">
                    <h3>SOAPIE</h3>
                    <p>SOAP + I, E</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('narrative')">
                    <h3>Narrative</h3>
                    <p>Free-form Note</p>
                </div>
            </div>

            <!-- NANDA Diagnosis Section -->
            <div class="nanda-section">
                <label>NANDA Nursing Diagnoses (optional - search to add)</label>
                <div class="nanda-search">
                    <input type="text" id="nandaSearch" placeholder="Search diagnoses... (e.g., pain, anxiety, mobility)" oninput="searchNanda()" onfocus="searchNanda()">
                    <div class="nanda-dropdown" id="nandaDropdown"></div>
                </div>
                <div class="selected-diagnoses" id="selectedDiagnoses"></div>
            </div>

            <!-- Quick Entry Panels -->
            <h2 class="section-title">Quick Entry Tools</h2>

            <!-- Vitals Quick-Entry Panel -->
            <div class="vitals-panel" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 10px; padding: 15px 20px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="togglePanel('vitalsContent', this)">
                    <h3 style="color: #2e7d32; margin: 0;">ü©∫ Quick Vitals Entry <span style="font-size: 12px; opacity: 0.7;">‚ñ∂</span></h3>
                    <button onclick="event.stopPropagation(); insertVitals()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Insert Vitals ‚ûú</button>
                </div>
                <div id="vitalsContent" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">BP (sys/dia)</label>
                        <div style="display: flex; gap: 4px;">
                            <input type="text" id="vsBpSys" placeholder="120" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                            <span style="line-height: 36px;">/</span>
                            <input type="text" id="vsBpDia" placeholder="80" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">HR</label>
                        <input type="text" id="vsHr" placeholder="72" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">RR</label>
                        <input type="text" id="vsRr" placeholder="16" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="2">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">Temp ¬∞F</label>
                        <input type="text" id="vsTemp" placeholder="98.6" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="5">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">O2%</label>
                        <input type="text" id="vsO2" placeholder="98" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">O2 Delivery</label>
                        <select id="vsO2Source" style="width: 100%; padding: 8px; font-size: 11px;">
                            <option value="RA">RA (Room Air)</option>
                            <optgroup label="Nasal Cannula">
                                <option value="1L NC">1L NC</option>
                                <option value="2L NC">2L NC</option>
                                <option value="3L NC">3L NC</option>
                                <option value="4L NC">4L NC</option>
                                <option value="5L NC">5L NC</option>
                                <option value="6L NC">6L NC</option>
                            </optgroup>
                            <optgroup label="Masks">
                                <option value="Simple Mask">Simple Mask</option>
                                <option value="Venturi Mask">Venturi Mask</option>
                                <option value="NRB">Non-Rebreather</option>
                                <option value="Partial Rebreather">Partial Rebreather</option>
                            </optgroup>
                            <optgroup label="High Flow / Advanced">
                                <option value="HFNC">High Flow NC (HFNC)</option>
                                <option value="CPAP">CPAP</option>
                                <option value="BiPAP">BiPAP</option>
                                <option value="Trach Collar">Trach Collar</option>
                                <option value="T-Piece">T-Piece</option>
                                <option value="Vent">Ventilator</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">Pain (0-10)</label>
                        <input type="text" id="vsPain" placeholder="0" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="2">
                    </div>
                </div>
                <p style="margin-top: 8px; font-size: 11px; color: #558b2f;">Click in a text field first, then click "Insert Vitals" to add formatted vitals.</p>
                </div>
            </div>

            <!-- Medication Administration Panel -->
            <div class="med-panel" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #1976d2; border-radius: 10px; padding: 15px 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="togglePanel('medContent', this)">
                    <h3 style="color: #1565c0; margin: 0;">üíä Medication Administration <span style="font-size: 12px; opacity: 0.7;">‚ñ∂</span></h3>
                    <button onclick="event.stopPropagation(); insertMedication()" style="background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Insert Med ‚ûú</button>
                </div>
                <div id="medContent" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                    <div class="drug-autocomplete-wrapper">
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Medication Name</label>
                        <input type="text" id="medName" placeholder="Start typing drug name..." style="width: 100%; padding: 8px; font-size: 13px;" autocomplete="off">
                        <div id="drugDropdown" class="drug-dropdown"></div>
                        <div id="medRecents" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;"></div>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Dose</label>
                        <input type="text" id="medDose" placeholder="e.g., 4mg" style="width: 100%; padding: 8px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Frequency</label>
                        <select id="medFreq" style="width: 100%; padding: 8px; font-size: 12px;">
                            <option value="">‚Äî</option>
                            <option value="Once">Once</option>
                            <option value="Daily">Daily</option>
                            <option value="BID">BID</option>
                            <option value="TID">TID</option>
                            <option value="QID">QID</option>
                            <option value="q4h">q4h</option>
                            <option value="q6h">q6h</option>
                            <option value="q8h">q8h</option>
                            <option value="q12h">q12h</option>
                            <option value="PRN">PRN</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Route</label>
                        <select id="medRoute" style="width: 100%; padding: 8px; font-size: 12px;">
                            <option value="PO">PO (by mouth)</option>
                            <option value="IV">IV (intravenous)</option>
                            <option value="IV Push">IV Push</option>
                            <option value="IVPB">IVPB (piggyback)</option>
                            <option value="IM">IM (intramuscular)</option>
                            <option value="SubQ">SubQ (subcutaneous)</option>
                            <option value="SL">SL (sublingual)</option>
                            <option value="PR">PR (rectal)</option>
                            <option value="Topical">Topical</option>
                            <option value="Inhaled">Inhaled</option>
                            <option value="Nasal">Nasal</option>
                            <option value="Ophthalmic">Ophthalmic</option>
                            <option value="Otic">Otic</option>
                            <option value="Transdermal">Transdermal</option>
                            <option value="GT">GT (gastrostomy)</option>
                            <option value="NGT">NGT (nasogastric)</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Site (if applicable)</label>
                        <select id="medSite" style="width: 100%; padding: 8px; font-size: 12px;">
                            <option value="">N/A</option>
                            <optgroup label="IV Sites">
                                <option value="R hand">R hand</option>
                                <option value="L hand">L hand</option>
                                <option value="R forearm">R forearm</option>
                                <option value="L forearm">L forearm</option>
                                <option value="R AC">R AC (antecubital)</option>
                                <option value="L AC">L AC (antecubital)</option>
                                <option value="PICC">PICC line</option>
                                <option value="Central line">Central line</option>
                                <option value="Port">Port</option>
                            </optgroup>
                            <optgroup label="IM/SubQ Sites">
                                <option value="R deltoid">R deltoid</option>
                                <option value="L deltoid">L deltoid</option>
                                <option value="R vastus lateralis">R vastus lateralis</option>
                                <option value="L vastus lateralis">L vastus lateralis</option>
                                <option value="R ventrogluteal">R ventrogluteal</option>
                                <option value="L ventrogluteal">L ventrogluteal</option>
                                <option value="Abdomen">Abdomen</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Time Given</label>
                        <input type="text" id="medTimeText" placeholder="N=now" style="display:none; width: 100%; padding: 8px; font-size: 13px;">
                        <input type="time" id="medTime" style="width: 100%; padding: 8px; font-size: 13px;" onfocus="showMedTimeShortcut()" onblur="hideMedTimeShortcut()">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Indication</label>
                        <input type="text" id="medIndication" placeholder="e.g., pain, HTN" style="width: 100%; padding: 8px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">PRN Parameters</label>
                        <input type="text" id="medPrnParams" placeholder="e.g., pain >6/10, SBP >160" style="width: 100%; padding: 8px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Effect / Response</label>
                        <input type="text" id="medEffect" placeholder="e.g., pain improved to 3/10" style="width: 100%; padding: 8px; font-size: 13px;">
                    </div>
                </div>
                <p style="margin-top: 8px; font-size: 11px; color: #1565c0;">Click in a text field first, then click "Insert Med" to add medication documentation. Time: N=now, N+15, N-30</p>
                </div>
            </div>

            <h2 class="section-title">Documentation</h2>

            <div class="form-group" id="focusGroup">
                <label>FOCUS</label>
                <input type="text" id="focus" placeholder="e.g., Pain management, Fall risk, Post-op care">
            </div>

            <!-- DAR -->
            <div id="darFields" class="note-fields active">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">D</span><div class="field-info"><h4>Data</h4></div></div>
                    <textarea id="darData" class="large" placeholder="Subjective & objective data..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Action</h4></div></div>
                    <textarea id="darAction" class="large" placeholder="Nursing interventions..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">R</span><div class="field-info"><h4>Response/Recommendations</h4></div></div>
                    <textarea id="darResponse" placeholder="Patient response and recommendations..."></textarea>
                </div>
            </div>

            <!-- DARP -->
            <div id="darpFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">D</span><div class="field-info"><h4>Data</h4></div></div>
                    <textarea id="darpData" class="large" placeholder="Subjective & objective data..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Action</h4></div></div>
                    <textarea id="darpAction" placeholder="Nursing interventions..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">R</span><div class="field-info"><h4>Response/Recommendations</h4></div></div>
                    <textarea id="darpResponse" placeholder="Patient response and recommendations..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Plan</h4></div></div>
                    <textarea id="darpPlan" placeholder="Care plan..."></textarea>
                </div>
            </div>

            <!-- SOAP -->
            <div id="soapFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">S</span><div class="field-info"><h4>Subjective</h4></div></div>
                    <textarea id="soapSubjective" class="large" placeholder="Patient statements..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">O</span><div class="field-info"><h4>Objective</h4></div></div>
                    <textarea id="soapObjective" class="large" placeholder="Vital signs, observations..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Assessment</h4></div></div>
                    <textarea id="soapAssessment" placeholder="Nursing diagnosis..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Plan</h4></div></div>
                    <textarea id="soapPlan" placeholder="Care plan..."></textarea>
                </div>
            </div>

            <!-- SOAPIE -->
            <div id="soapieFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">S</span><div class="field-info"><h4>Subjective</h4></div></div>
                    <textarea id="soapieSubjective" placeholder="Patient statements..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">O</span><div class="field-info"><h4>Objective</h4></div></div>
                    <textarea id="soapieObjective" placeholder="VS, observations..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Assessment</h4></div></div>
                    <textarea id="soapieAssessment" placeholder="Nursing diagnosis..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Plan</h4></div></div>
                    <textarea id="soapiePlan" placeholder="Care plan..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">I</span><div class="field-info"><h4>Intervention</h4></div></div>
                    <textarea id="soapieIntervention" placeholder="Actions taken..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">E</span><div class="field-info"><h4>Evaluation</h4></div></div>
                    <textarea id="soapieEvaluation" placeholder="Effectiveness..."></textarea>
                </div>
            </div>

            <!-- SBAR -->
            <div id="sbarFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">S</span><div class="field-info"><h4>Situation</h4></div></div>
                    <textarea id="sbarSituation" class="large" placeholder="What is happening now?"></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">B</span><div class="field-info"><h4>Background</h4></div></div>
                    <textarea id="sbarBackground" class="large" placeholder="Relevant history..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Assessment</h4></div></div>
                    <textarea id="sbarAssessment" placeholder="What do you think is the problem?"></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">R</span><div class="field-info"><h4>Recommendation</h4></div></div>
                    <textarea id="sbarRecommendation" placeholder="What do you need?"></textarea>
                </div>
            </div>

            <!-- PIE -->
            <div id="pieFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Problem</h4></div></div>
                    <textarea id="pieProblem" class="large" placeholder="Nursing diagnosis or problem..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">I</span><div class="field-info"><h4>Intervention</h4></div></div>
                    <textarea id="pieIntervention" class="large" placeholder="Actions taken..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">E</span><div class="field-info"><h4>Evaluation</h4></div></div>
                    <textarea id="pieEvaluation" placeholder="Effectiveness, outcomes..."></textarea>
                </div>
            </div>

            <!-- Narrative -->
            <div id="narrativeFields" class="note-fields">
                <div class="form-group">
                    <label>Narrative Note</label>
                    <textarea id="narrativeText" class="large" style="min-height:200px" placeholder="Document in free-form narrative format..."></textarea>
                </div>
            </div>

            <!-- Head-to-Toe Assessment -->
            <div id="h2tFields" class="note-fields">
                <p style="font-size:12px;color:#666;margin-bottom:15px;">Click quick-fill buttons to insert common findings, then edit as needed.</p>
                <div class="h2t-grid">
                    <div class="h2t-section">
                        <h4>Mental Status</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tMental', 'A&O x4. ')">A&O x4</span>
                            <span class="quick-fill" onclick="appendToField('h2tMental', 'Speech clear. ')">Speech clear</span>
                            <span class="quick-fill" onclick="appendToField('h2tMental', 'Mood euthymic. ')">Mood euthymic</span>
                            <span class="quick-fill" onclick="appendToField('h2tMental', 'Cooperative. ')">Cooperative</span>
                        </div>
                        <textarea id="h2tMental" placeholder="Appearance, behavior, mood/affect, thought process, orientation..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Neurological</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'A&O x4. ')">A&O x4</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'PERRLA 3mm. ')">PERRLA</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'GCS 15. ')">GCS 15</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'MAE x4, strength 5/5. ')">MAE</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'No focal deficits. ')">No deficits</span>
                        </div>
                        <textarea id="h2tNeuro" placeholder="LOC, orientation, pupils, motor/sensory..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Cardiovascular</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'S1S2, RRR, no murmur. ')">S1S2 RRR</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Radial pulses 2+ bilat. ')">Pulses 2+</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Cap refill <3 sec. ')">Cap refill <3s</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'No peripheral edema. ')">No edema</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Pedal pulses palpable bilat. ')">Pedal pulses</span>
                        </div>
                        <textarea id="h2tCardio" placeholder="Heart sounds, pulses, edema, cap refill..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Respiratory</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'CTA bilat. ')">CTA bilat</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'Unlabored, regular. ')">Unlabored</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'RA, SpO2 WNL. ')">RA</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'O2 via NC _L/min. ')">O2 NC</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'No cough, no SOB. ')">No cough/SOB</span>
                        </div>
                        <textarea id="h2tResp" placeholder="Breath sounds, effort, O2, cough..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Gastrointestinal</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'BS active x4 quads. ')">BS active</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'Soft, non-tender, non-distended. ')">Soft NT ND</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'Last BM: ___. ')">Last BM</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'Tolerating diet. ')">Tolerating diet</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'No N/V. ')">No N/V</span>
                        </div>
                        <textarea id="h2tGI" placeholder="Bowel sounds, abdomen, N/V, diet, BM..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Genitourinary</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'Voiding without difficulty. ')">Voiding WNL</span>
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'Foley patent, clear yellow urine. ')">Foley patent</span>
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'Last void: ___. ')">Last void</span>
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'I&O balanced. ')">I&O balanced</span>
                        </div>
                        <textarea id="h2tGU" placeholder="Voiding, Foley, output, color..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Skin/Integumentary</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'Warm, dry, intact. ')">WDI</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'Color appropriate. ')">Color WNL</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'Turgor elastic. ')">Turgor elastic</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'No breakdown, no pressure areas. ')">No breakdown</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'IV site: ___. ')">IV site</span>
                        </div>
                        <textarea id="h2tSkin" placeholder="Color, temp, turgor, wounds, IV sites..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Musculoskeletal</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'ROM intact. ')">ROM intact</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Gait steady. ')">Gait steady</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Ambulating independently. ')">Ambulating</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Bed rest. ')">Bed rest</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Fall risk precautions. ')">Fall risk</span>
                        </div>
                        <textarea id="h2tMSK" placeholder="Mobility, ROM, strength, gait, fall risk..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Pain/Comfort</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Pain 0/10. ')">Pain 0/10</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Pain ___/10 at ___. ')">Pain __/10</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Denies pain. ')">Denies pain</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Medicated for pain. ')">Medicated</span>
                        </div>
                        <textarea id="h2tPain" placeholder="Pain level, location, quality, interventions..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Safety / Risk</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tSafety', 'Fall risk precautions in place. ')">Fall risk</span>
                            <span class="quick-fill" onclick="appendToField('h2tSafety', 'Bed low, call light within reach. ')">Call light</span>
                            <span class="quick-fill" onclick="appendToField('h2tSafety', 'Denies SI/HI. ')">Denies SI/HI</span>
                        </div>
                        <textarea id="h2tSafety" placeholder="Fall risk, suicide risk, restraints, safety measures..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Lines/Drains/Airway</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tLines', 'PIV patent, dressing CDI. ')">PIV</span>
                            <span class="quick-fill" onclick="appendToField('h2tLines', 'Foley patent, draining clear yellow. ')">Foley</span>
                            <span class="quick-fill" onclick="appendToField('h2tLines', 'O2 via NC __ L/min. ')">O2 NC</span>
                        </div>
                        <textarea id="h2tLines" placeholder="IV/lines, drains, O2/airway devices..."></textarea>
                    </div>
                </div>
                <div class="form-group" style="margin-top:15px;">
                    <label>Psychosocial/Additional Notes</label>
                    <textarea id="h2tPsych" placeholder="Mood, behavior, support system, safety concerns, plan..."></textarea>
                    <button type="button" onclick="insertMentalHealthSummary()" style="margin-top: 6px; background: #1f4e79; color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 11px; cursor: pointer;">Insert MH Summary</button>
                </div>
                <div style="margin-top: 10px; background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; color: #1f4e79;">Mental Health Screening (PHQ-9 / GAD-7)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 80px; gap: 6px; font-size: 12px;">
                        <div>PHQ-9: Little interest or pleasure</div>
                        <select id="phq1" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>PHQ-9: Feeling down, depressed, hopeless</div>
                        <select id="phq2" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>PHQ-9: Trouble sleeping</div>
                        <select id="phq3" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>PHQ-9: Feeling tired or low energy</div>
                        <select id="phq4" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>PHQ-9: Poor appetite or overeating</div>
                        <select id="phq5" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>PHQ-9: Feeling bad about self</div>
                        <select id="phq6" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>PHQ-9: Trouble concentrating</div>
                        <select id="phq7" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>PHQ-9: Psychomotor changes</div>
                        <select id="phq8" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>PHQ-9: Thoughts of self-harm</div>
                        <select id="phq9" onchange="updatePhq9Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                    </div>
                    <div style="margin-top: 6px; font-size: 12px;">PHQ-9 Total: <strong id="phq9Score">0</strong></div>

                    <div style="margin-top: 12px; display: grid; grid-template-columns: 1fr 80px; gap: 6px; font-size: 12px;">
                        <div>GAD-7: Feeling nervous or on edge</div>
                        <select id="gad1" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>GAD-7: Not able to stop worrying</div>
                        <select id="gad2" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>GAD-7: Worrying too much</div>
                        <select id="gad3" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>GAD-7: Trouble relaxing</div>
                        <select id="gad4" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>GAD-7: Restless</div>
                        <select id="gad5" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>GAD-7: Easily annoyed</div>
                        <select id="gad6" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        <div>GAD-7: Afraid something awful</div>
                        <select id="gad7" onchange="updateGad7Score()"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                    </div>
                    <div style="margin-top: 6px; font-size: 12px;">GAD-7 Total: <strong id="gad7Score">0</strong></div>
                </div>
            </div>

            <div class="btn-container">
                <button class="btn btn-clear" onclick="clearForm()">Clear</button>
                <button class="btn btn-word" id="btnExportWord" onclick="generateWord(this)">Export Word</button>
                <button class="btn btn-pdf" id="btnExportPdf" onclick="generatePDF(this)">Export PDF</button>
            </div>

            <!-- Document History Section -->
            <div style="margin-top: 20px; padding: 15px; background: var(--nanda-bg); border-radius: 10px; border: 1px solid var(--nanda-border); transition: background 0.3s ease, border-color 0.3s ease;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <h3 style="color: var(--accent); margin: 0; font-size: 14px;">üìÅ Document History</h3>
                        <p style="color: var(--text-secondary); font-size: 11px; margin-top: 4px;">Save notes to your account for later retrieval</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="saveToHistory()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;">
                            üíæ Save to History
                        </button>
                        <button onclick="openHistoryModal()" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;">
                            üìÇ View History
                        </button>
                    </div>
                </div>
            </div>

                    </div>
    </div>

    <!-- Document History Modal -->
    <div id="historyModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) this.classList.add('hidden')">
        <div style="background: var(--bg-primary); border-radius: 16px; padding: 25px; max-width: 700px; width: 90%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px var(--shadow);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--accent); padding-bottom: 15px;">
                <h3 style="color: var(--accent); margin: 0;">üìÇ Saved Documents</h3>
                <button onclick="document.getElementById('historyModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">√ó</button>
            </div>

            <!-- Search/Filter -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="historySearch" placeholder="Search by patient name or note type..." oninput="filterHistory()" style="width: 100%; padding: 10px 14px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-primary);">
            </div>

            <!-- Documents List -->
            <div id="historyList" style="flex: 1; overflow-y: auto; min-height: 200px;">
                <p style="text-align: center; color: var(--text-secondary); padding: 40px;">Loading saved documents...</p>
            </div>
        </div>
    </div>

    <!-- Lock Screen Overlay -->
    <div id="lockScreenOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); z-index: 99999; align-items: center; justify-content: center; flex-direction: column;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px;">üîí</div>
            <h1 style="font-size: 42px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">BSN9B</h1>
            <p style="font-size: 18px; opacity: 0.8; margin-bottom: 40px;">Portal Locked</p>
            <button onclick="unlockScreen()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 18px 50px; border-radius: 30px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 12px 40px rgba(59, 130, 246, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 8px 30px rgba(59, 130, 246, 0.4)'">
                üîì Unlock Portal
            </button>
            <p style="margin-top: 30px; font-size: 12px; opacity: 0.5;">Click unlock to return to your session</p>
        </div>
    </div>

    <!-- Alert/FYI Banners - Fixed at top -->
    <div id="alertBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 10000; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5); animation: softFlashAlert 2s ease-in-out infinite;">
        <span id="alertText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.8;">‚ö†Ô∏è ALERT</span>
    </div>
    <div id="fyiBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a1a2e; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 9999; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); animation: softFlashFyi 2s ease-in-out infinite;">
        <span id="fyiText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.7;">‚ÑπÔ∏è FYI</span>
    </div>
    <style>
        @keyframes softFlashAlert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        @keyframes softFlashFyi {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        body.has-alert { padding-top: 50px; }
        body.has-fyi { padding-top: 50px; }
        body.has-alert.has-fyi { padding-top: 100px; }
    </style>

    <footer style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6); font-size: 12px;">
        BSN9B Nursing Documentation Tool
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            If you'd like to contribute to the cost of this service, please <a href="https://venmo.com/ChristianKSHolden" target="_blank" style="color: #3d95ce; text-decoration: none;">donate here</a>.
        </div>
    </footer>

    <style>
        /* Dark mode support for modals and dynamic elements */
        [data-theme="dark"] #phrasesModal > div,
        [data-theme="dark"] #feedbackModal > div {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        [data-theme="dark"] #phrasesModal input,
        [data-theme="dark"] #phrasesModal select,
        [data-theme="dark"] #phrasesModal textarea,
        [data-theme="dark"] #feedbackModal input,
        [data-theme="dark"] #feedbackModal select,
        [data-theme="dark"] #feedbackModal textarea {
            background: var(--bg-input);
            color: var(--text-primary);
            border-color: var(--border-light);
        }
        [data-theme="dark"] .phrase-item:hover {
            background: var(--accent-hover);
        }
        [data-theme="dark"] .phrase-item .tooltip {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        [data-theme="dark"] #chatMessages {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #aiMessages {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #chatBox,
        [data-theme="dark"] #aiBox {
            background: var(--bg-primary) !important;
        }
        [data-theme="dark"] #chatInput,
        [data-theme="dark"] #aiInput {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-light) !important;
        }
        [data-theme="dark"] #userList {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #mentionDropdown {
            background: var(--bg-primary) !important;
            border-color: var(--border-light) !important;
        }
        [data-theme="dark"] .mention-item:hover {
            background: var(--accent-hover) !important;
        }
        [data-theme="dark"] .vitals-panel,
        [data-theme="dark"] .med-panel {
            background: var(--bg-secondary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] .vitals-panel input,
        [data-theme="dark"] .vitals-panel select,
        [data-theme="dark"] .med-panel input,
        [data-theme="dark"] .med-panel select {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-light) !important;
        }
        [data-theme="dark"] .drug-dropdown {
            background: var(--bg-primary) !important;
            border-color: var(--accent) !important;
        }
        [data-theme="dark"] .drug-item {
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] .drug-item:hover {
            background: var(--accent-hover) !important;
        }
        /* DM View dark mode */
        [data-theme="dark"] #dmConversationList,
        [data-theme="dark"] #dmConversations > div,
        [data-theme="dark"] #dmUserList > div {
            background: var(--bg-secondary) !important;
            border-color: var(--border) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #dmConversations > div div,
        [data-theme="dark"] #dmUserList > div div {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #dmHeader {
            background: var(--bg-secondary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #dmPartnerName {
            color: var(--accent) !important;
        }
        [data-theme="dark"] #dmMessages {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #dmInput,
        [data-theme="dark"] #dmUserSearch {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-light) !important;
        }
        [data-theme="dark"] #historyModal > div {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #historyList > div {
            background: var(--bg-secondary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #historySearch {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
        }
    </style>

    <!-- AI Nursing Companion Widget -->
    <div id="aiWidget" style="position: fixed; bottom: 80px; left: 20px; z-index: 999; font-family: 'Segoe UI', sans-serif;">
        <!-- AI Toggle Button -->
        <button id="aiToggle" onclick="toggleAI()" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 24px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;">
            ü©∫
        </button>
        <span style="position: absolute; top: -2px; left: -2px; background: #8b5cf6; color: white; border-radius: 4px; padding: 2px 5px; font-size: 9px; font-weight: bold;">AI</span>

        <!-- AI Chat Box -->
        <div id="aiBox" style="display: none; flex-direction: column; position: absolute; bottom: 70px; left: 0; width: 380px; height: 500px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden;">
            <!-- AI Header -->
            <div style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong style="font-size: 16px;">ü©∫ Nursing AI Assistant</strong>
                    <div style="font-size: 11px; opacity: 0.9;">AI-Powered Study Helper</div>
                </div>
                <button onclick="toggleAI()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 16px;">√ó</button>
            </div>

            <!-- Disclaimer -->
            <div style="background: #fef3c7; color: #92400e; padding: 8px 12px; font-size: 11px; border-bottom: 1px solid #fcd34d;">
                ‚ö†Ô∏è Educational purposes only. Not medical advice. Do not enter patient data.
            </div>

            <!-- Quick Actions -->
            <div style="padding: 10px; background: #f0fdfa; border-bottom: 1px solid #e2e8f0; display: flex; gap: 6px; flex-wrap: wrap;">
                <button onclick="aiQuickAction('drug')" style="background: #0d9488; color: white; border: none; padding: 5px 10px; border-radius: 12px; font-size: 11px; cursor: pointer;">üíä Drug Info</button>
                <button onclick="aiQuickAction('careplan')" style="background: #0d9488; color: white; border: none; padding: 5px 10px; border-radius: 12px; font-size: 11px; cursor: pointer;">üìã Care Plan</button>
                <button onclick="aiQuickAction('nclex')" style="background: #0d9488; color: white; border: none; padding: 5px 10px; border-radius: 12px; font-size: 11px; cursor: pointer;">üìù NCLEX Q</button>
                <button onclick="aiQuickAction('labs')" style="background: #0d9488; color: white; border: none; padding: 5px 10px; border-radius: 12px; font-size: 11px; cursor: pointer;">üî¨ Labs</button>
            </div>

            <!-- AI Messages -->
            <div id="aiMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
                <div style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 12px 16px; border-radius: 16px 16px 16px 4px; margin-bottom: 10px; font-size: 14px;">
                    Hi! I'm your nursing AI assistant. I can help with:
                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px;">
                        <li>Drug information & nursing considerations</li>
                        <li>Care plan development (NANDA, NIC, NOC)</li>
                        <li>NCLEX practice questions</li>
                        <li>Lab values & clinical concepts</li>
                        <li>Nursing procedures & assessments</li>
                    </ul>
                </div>
            </div>

            <!-- AI Input -->
            <div style="padding: 12px; border-top: 1px solid #e2e8f0; background: white;">
                <form onsubmit="sendAIMessage(event)" style="display: flex; gap: 8px;">
                    <input type="text" id="aiInput" placeholder="Ask a nursing question..." style="flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none;" maxlength="1000">
                    <button type="submit" id="aiSendBtn" style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 16px;">‚û§</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Peer Chat Widget -->
    <div id="chatWidget" style="position: fixed; bottom: 80px; right: 20px; z-index: 999; font-family: 'Segoe UI', sans-serif;">
        <!-- Chat Toggle Button -->
        <button id="chatToggle" onclick="toggleChat()" aria-label="Open chat" aria-expanded="false" aria-controls="chatBox" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 24px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;">
            <span aria-hidden="true">üí¨</span>
        </button>
        <span id="chatBadge" aria-live="polite" style="display: none; position: absolute; top: -5px; right: -5px; background: #e94560; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center;">0</span>
        <!-- DM Badge (separate from group chat) -->
        <span id="dmBadge" aria-live="polite" style="display: none; position: absolute; top: -5px; left: -5px; background: #8b5cf6; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center;">0</span>

        <!-- Chat Box -->
        <div id="chatBox" role="dialog" aria-label="Chat window" aria-modal="false" style="display: none; flex-direction: column; position: absolute; bottom: 70px; right: 0; width: 350px; height: 500px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden;">
            <!-- Chat Header -->
            <div style="background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; padding: 12px 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong id="chatTitle" style="font-size: 16px;">BSN9B Chat</strong>
                        <div id="onlineCount" onclick="toggleUserList()" style="font-size: 11px; opacity: 0.8; cursor: pointer;">Connecting...</div>
                    </div>
                    <div style="display: flex; gap: 6px; align-items: center;">
                        <button id="soundToggleBtn" onclick="toggleChatSound()" aria-label="Toggle sound notifications" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 14px;"><span aria-hidden="true">üîî</span></button>
                        <button id="notificationToggleBtn" onclick="toggleBrowserNotifications()" aria-label="Toggle browser notifications" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 14px;"><span aria-hidden="true">üìµ</span></button>
                        <button onclick="toggleChat()" aria-label="Close chat" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 16px;"><span aria-hidden="true">√ó</span></button>
                    </div>
                </div>
                <!-- Chat Mode Tabs -->
                <div role="tablist" aria-label="Chat mode" style="display: flex; gap: 8px; margin-top: 10px;">
                    <button id="tabGroupChat" role="tab" aria-selected="true" aria-controls="groupChatView" onclick="switchChatMode('group')" style="flex: 1; padding: 8px; border: none; border-radius: 8px; background: rgba(255,255,255,0.3); color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <span aria-hidden="true">üë•</span> Group
                    </button>
                    <button id="tabDM" role="tab" aria-selected="false" aria-controls="dmView" onclick="switchChatMode('dm')" style="flex: 1; padding: 8px; border: none; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <span aria-hidden="true">‚úâÔ∏è</span> Direct <span id="dmTabBadge" style="display: none; background: #8b5cf6; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 4px;">0</span>
                    </button>
                </div>
            </div>

            <!-- Online Users List (toggleable) -->
            <div id="userList" style="display: none; background: #1a3d5c; color: white; padding: 10px 15px; font-size: 12px; max-height: 100px; overflow-y: auto;">
                <div style="opacity: 0.7; margin-bottom: 5px;">Online now:</div>
                <div id="userListNames"></div>
            </div>

            <!-- GROUP CHAT VIEW -->
            <div id="groupChatView" role="tabpanel" aria-labelledby="tabGroupChat" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div style="padding: 10px 12px; background: #eef2f7; border-bottom: 1px solid #e2e8f0; display: flex; gap: 8px; align-items: center;">
                    <select id="channelSelect" onchange="handleChannelChange(this.value)" style="flex: 1; padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 12px; background: white;">
                        <option value="general">General</option>
                    </select>
                    <button id="createChannelBtn" onclick="createChannel()" title="Create channel" style="width: 32px; height: 32px; border-radius: 8px; border: none; background: #1f4e79; color: white; font-size: 16px; cursor: pointer;">+</button>
                    <button id="deleteChannelBtn" onclick="deleteChannel()" title="Delete channel" style="width: 32px; height: 32px; border-radius: 8px; border: none; background: #ef4444; color: white; font-size: 14px; cursor: pointer; display: none;">üóë</button>
                </div>
                <!-- Chat Messages -->
                <div id="chatMessages" role="log" aria-live="polite" aria-label="Chat messages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
                    <p style="text-align: center; color: #888; font-size: 12px;">Loading messages...</p>
                </div>

                <!-- Chat Input -->
                <div style="padding: 12px; border-top: 1px solid #e2e8f0; background: white; position: relative;">
                    <!-- @Mention Autocomplete Dropdown -->
                    <div id="mentionDropdown" role="listbox" aria-label="Mention suggestions" style="display: none; position: absolute; bottom: 100%; left: 12px; right: 60px; background: white; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 -4px 15px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; z-index: 100;"></div>
                    <form onsubmit="sendMessage(event)" style="display: flex; gap: 8px;">
                        <input type="text" id="chatInput" aria-label="Chat message input" placeholder="Type @ to mention someone..." style="flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none;" maxlength="500" autocomplete="off">
                        <button type="submit" aria-label="Send message" style="background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 16px;"><span aria-hidden="true">‚û§</span></button>
                    </form>
                </div>
            </div>

            <!-- DM VIEW -->
            <div id="dmView" role="tabpanel" aria-labelledby="tabDM" style="flex: 1; display: none; flex-direction: column; overflow: hidden;">
                <!-- DM Conversation List (shows when no conversation selected) -->
                <div id="dmConversationList" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
                    <div style="margin-bottom: 15px;">
                        <button onclick="showNewDMSelector()" aria-label="Start new direct message" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            <span aria-hidden="true">‚úèÔ∏è</span> New Message
                        </button>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <button onclick="runDMSelfTest()" aria-label="Run DM self test" style="width: 100%; padding: 10px; background: #f1f5f9; color: #1f4e79; border: 1px dashed #cbd5e1; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                            DM Self-Test (safe)
                        </button>
                    </div>
                    <div id="dmConversations" style="color: #888; font-size: 12px; text-align: center;">
                        Loading conversations...
                    </div>
                </div>

                <!-- DM Messages View (shows when conversation selected) -->
                <div id="dmMessageView" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                    <!-- DM Header with back button -->
                    <div id="dmHeader" style="padding: 10px 15px; background: #f0f7ff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px;">
                        <button onclick="closeDMConversation()" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px;">‚Üê</button>
                        <span id="dmPartnerName" style="font-weight: 600; color: #1f4e79;">Partner Name</span>
                        <span id="dmPartnerStatus" style="font-size: 10px; padding: 2px 8px; border-radius: 10px; background: #e2e8f0; color: #666;">offline</span>
                    </div>
                    <!-- DM Messages -->
                    <div id="dmMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
                    </div>
                    <!-- DM Input -->
                    <div style="padding: 12px; border-top: 1px solid #e2e8f0; background: white;">
                        <form onsubmit="sendDM(event)" style="display: flex; gap: 8px;">
                            <input type="text" id="dmInput" placeholder="Type a message..." style="flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none;" maxlength="500" autocomplete="off">
                            <button type="submit" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 16px;">‚û§</button>
                        </form>
                    </div>
                </div>

                <!-- New DM User Selector -->
                <div id="newDMSelector" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                    <div style="padding: 10px 15px; background: #f0f7ff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px;">
                        <button onclick="hideNewDMSelector()" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px;">‚Üê</button>
                        <span style="font-weight: 600; color: #1f4e79;">New Message</span>
                    </div>
                    <div style="padding: 15px;">
                        <input type="text" id="dmUserSearch" placeholder="Search users..." oninput="filterDMUsers()" style="width: 100%; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none; margin-bottom: 15px;">
                    </div>
                    <div id="dmUserList" style="flex: 1; overflow-y: auto; padding: 0 15px 15px 15px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-action-bar" id="mobileActionBar">
        <button class="mobile-action-btn save" onclick="saveToHistory()">Save</button>
        <button class="mobile-action-btn copy" onclick="copyNoteToClipboard()">Copy</button>
        <button class="mobile-action-btn pdf" onclick="generatePDF(document.getElementById('btnExportPdf'))">PDF</button>
        <button class="mobile-action-btn word" onclick="generateWord(document.getElementById('btnExportWord'))">Word</button>
    </div>
    <div class="mobile-action-status" id="mobileActionStatus">Draft saved</div>
    <button class="section-jump-btn" id="sectionJumpBtn" onclick="toggleSectionJump()">‚ò∞</button>
    <div class="section-jump-panel" id="sectionJumpPanel"></div>

    <!-- Bottom Toolbar -->
    <nav class="bottom-toolbar" role="navigation" aria-label="Main navigation">
        <a href="/home/" class="toolbar-item" aria-label="Home">
            <span class="icon" aria-hidden="true">üè†</span>
            <span class="label">Home</span>
        </a>
        <a href="/app/" class="toolbar-item active" aria-label="RN Notes" aria-current="page">
            <span class="icon" aria-hidden="true">üìù</span>
            <span class="label">RN Notes</span>
        </a>
        <a href="/community/" class="toolbar-item" aria-label="Community">
            <span class="icon" aria-hidden="true">üë•</span>
            <span class="label">Community</span>
        </a>
        <a href="/resources/" class="toolbar-item" aria-label="Resources">
            <span class="icon" aria-hidden="true">üìö</span>
            <span class="label">Resources</span>
        </a>
        <button class="toolbar-item" onclick="toggleMoreMenu()" aria-label="More options" aria-expanded="false" aria-controls="moreMenu">
            <span class="icon" aria-hidden="true">‚ãØ</span>
            <span class="label">More</span>
        </button>
    </nav>

    <!-- More Menu -->
    <div id="moreMenu" class="more-menu" role="menu" aria-label="Additional options">
        <button class="more-menu-item" role="menuitem" onclick="toggleDarkMode(); toggleMoreMenu();">
            <span class="menu-icon" id="themeMenuIcon" aria-hidden="true">üåô</span>
            <span id="themeMenuText">Dark Mode</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="document.getElementById('phrasesModal').classList.remove('hidden'); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">üìù</span>
            <span>Smart Phrases</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="lockScreen(); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">üîí</span>
            <span>Lock Screen</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="toggleFullscreen(); toggleMoreMenu();" id="fullscreenBtn">
            <span class="menu-icon" aria-hidden="true" id="fullscreenIcon">‚õ∂</span>
            <span id="fullscreenText">Full Screen</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="document.getElementById('feedbackModal').classList.remove('hidden'); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">üí°</span>
            <span>Feedback</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="logout();">
            <span class="menu-icon" aria-hidden="true">üö™</span>
            <span>Logout</span>
        </button>
    </div>

    <!-- Firebase SDK - must load before inline scripts that use Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ========== FULLSCREEN MODE ==========
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                // Enter fullscreen
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                }
                updateFullscreenUI(true);
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                updateFullscreenUI(false);
            }
        }

        function updateFullscreenUI(isFullscreen) {
            const icon = document.getElementById('fullscreenIcon');
            const text = document.getElementById('fullscreenText');
            if (icon) icon.textContent = isFullscreen ? '‚õ∂' : '‚õ∂';
            if (text) text.textContent = isFullscreen ? 'Exit Full Screen' : 'Full Screen';
        }

        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', () => {
            updateFullscreenUI(!!document.fullscreenElement);
        });
        document.addEventListener('webkitfullscreenchange', () => {
            updateFullscreenUI(!!document.webkitFullscreenElement);
        });

        // ========== TOAST NOTIFICATION SYSTEM ==========
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content"><div class="toast-message">${message.replace(/\n/g, '<br>')}</div></div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, duration);
        }

        // ========== DARK MODE ==========
        function initTheme() {
            const saved = localStorage.getItem('bsn9b_theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcon();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('bsn9b_theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const themeMenuIcon = document.getElementById('themeMenuIcon');
            const themeMenuText = document.getElementById('themeMenuText');
            if (themeMenuIcon) {
                themeMenuIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            }
            if (themeMenuText) {
                themeMenuText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            }
        }

        // More menu toggle
        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const isExpanded = menu.classList.toggle('show');
            if (moreBtn) {
                moreBtn.setAttribute('aria-expanded', isExpanded);
            }
        }

        // Close more menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const moreBtnClicked = e.target.closest('.toolbar-item');
            if (!menu.contains(e.target) && (!moreBtnClicked || !moreBtnClicked.onclick?.toString().includes('toggleMoreMenu'))) {
                menu.classList.remove('show');
                if (moreBtn) {
                    moreBtn.setAttribute('aria-expanded', 'false');
                }
            }
        });

        // Initialize theme immediately before page renders
        initTheme();

        // ========== DOCUMENT HISTORY ==========
        let savedDocuments = [];

        function getUserDocsRef() {
            const uid = getCurrentUserUid();
            if (!uid) return null;
            return database.ref('userDocuments/' + uid);
        }

        async function migrateLegacyDocumentsIfNeeded() {
            try {
                const uid = getCurrentUserUid();
                const email = localStorage.getItem('bsn9b_user');
                if (!uid || !email) return;

                const legacyKey = email.replace(/[.@]/g, '_');
                const newRef = database.ref('userDocuments/' + uid);
                const legacyRef = database.ref('userDocuments/' + legacyKey);

                const newSnap = await newRef.once('value');
                if (newSnap.exists()) return;

                const legacySnap = await legacyRef.once('value');
                if (legacySnap.exists()) {
                    await newRef.set(legacySnap.val());
                    await legacyRef.remove();
                }
            } catch (e) {
                console.warn('Legacy document migration skipped:', e);
            }
        }

        // Save current form to history
        async function saveToHistory() {
            const uid = getCurrentUserUid();
            if (!uid) {
                showToast('Please log in to save documents.', 'warning');
                return;
            }

            const formData = getFormData();
            const noteContent = getNoteContent();

            if (noteContent.length === 0) {
                showToast('Please fill in some documentation before saving.', 'warning');
                return;
            }

            // Get all form field values for the current note type
            const fullContent = {};
            const t = currentNoteType;
            if (t === 'dar') {
                fullContent.darData = document.getElementById('darData').value;
                fullContent.darAction = document.getElementById('darAction').value;
                fullContent.darResponse = document.getElementById('darResponse').value;
            } else if (t === 'darp') {
                fullContent.darpData = document.getElementById('darpData').value;
                fullContent.darpAction = document.getElementById('darpAction').value;
                fullContent.darpResponse = document.getElementById('darpResponse').value;
                fullContent.darpPlan = document.getElementById('darpPlan').value;
            } else if (t === 'soap') {
                fullContent.soapSubjective = document.getElementById('soapSubjective').value;
                fullContent.soapObjective = document.getElementById('soapObjective').value;
                fullContent.soapAssessment = document.getElementById('soapAssessment').value;
                fullContent.soapPlan = document.getElementById('soapPlan').value;
            } else if (t === 'soapie') {
                fullContent.soapieSubjective = document.getElementById('soapieSubjective').value;
                fullContent.soapieObjective = document.getElementById('soapieObjective').value;
                fullContent.soapieAssessment = document.getElementById('soapieAssessment').value;
                fullContent.soapiePlan = document.getElementById('soapiePlan').value;
                fullContent.soapieIntervention = document.getElementById('soapieIntervention').value;
                fullContent.soapieEvaluation = document.getElementById('soapieEvaluation').value;
            } else if (t === 'sbar') {
                fullContent.sbarSituation = document.getElementById('sbarSituation').value;
                fullContent.sbarBackground = document.getElementById('sbarBackground').value;
                fullContent.sbarAssessment = document.getElementById('sbarAssessment').value;
                fullContent.sbarRecommendation = document.getElementById('sbarRecommendation').value;
            } else if (t === 'pie') {
                fullContent.pieProblem = document.getElementById('pieProblem').value;
                fullContent.pieIntervention = document.getElementById('pieIntervention').value;
                fullContent.pieEvaluation = document.getElementById('pieEvaluation').value;
            } else if (t === 'narrative') {
                fullContent.narrativeText = document.getElementById('narrativeText').value;
            } else if (t === 'h2t') {
                fullContent.h2tNeuro = document.getElementById('h2tNeuro').value;
                fullContent.h2tCardio = document.getElementById('h2tCardio').value;
                fullContent.h2tResp = document.getElementById('h2tResp').value;
                fullContent.h2tGI = document.getElementById('h2tGI').value;
                fullContent.h2tGU = document.getElementById('h2tGU').value;
                fullContent.h2tSkin = document.getElementById('h2tSkin').value;
                fullContent.h2tMSK = document.getElementById('h2tMSK').value;
                fullContent.h2tPain = document.getElementById('h2tPain').value;
                fullContent.h2tMental = document.getElementById('h2tMental').value;
                fullContent.h2tSafety = document.getElementById('h2tSafety').value;
                fullContent.h2tLines = document.getElementById('h2tLines').value;
                fullContent.h2tPsych = document.getElementById('h2tPsych').value;
                for (let i = 1; i <= 9; i++) {
                    const el = document.getElementById('phq' + i);
                    if (el) fullContent['phq' + i] = el.value;
                }
                for (let i = 1; i <= 7; i++) {
                    const el = document.getElementById('gad' + i);
                    if (el) fullContent['gad' + i] = el.value;
                }
            }

            // Also save header info
            fullContent.nurseName = formData.nurseName;
            fullContent.credentials = document.getElementById('credentials').value;
            fullContent.noteDate = document.getElementById('noteDate').value;
            fullContent.noteTime = document.getElementById('noteTime').value;
            fullContent.unit = formData.unit;
            fullContent.patientId = formData.patientId;
            fullContent.patientDemo = formData.patientDemo;
            fullContent.focus = formData.focus;
            fullContent.selectedDiagnoses = selectedDiagnoses;

            const docData = {
                noteType: currentNoteType,
                content: fullContent,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                patientName: formData.patientId || 'Unknown Patient'
            };

            try {
                const userDocsRef = getUserDocsRef();
                if (!userDocsRef) {
                    showToast('Please log in to save documents.', 'warning');
                    return;
                }
                await userDocsRef.push(docData);
                clearDraft(currentNoteType);
                updateAutoSaveStatus('Draft cleared after save');
                showToast('Document saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving document:', error);
                showToast('Failed to save document: ' + error.message, 'error');
            }
        }

        // Open history modal and load documents
        function openHistoryModal() {
            document.getElementById('historyModal').classList.remove('hidden');
            loadDocumentHistory();
        }

        // Load document history list
        async function loadDocumentHistory() {
            const uid = getCurrentUserUid();
            if (!uid) {
                document.getElementById('historyList').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Please log in to view saved documents.</p>';
                return;
            }

            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Loading...</p>';

            try {
                const userDocsRef = getUserDocsRef();
                if (!userDocsRef) {
                    document.getElementById('historyList').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Please log in to view saved documents.</p>';
                    return;
                }
                const snapshot = await userDocsRef.orderByChild('createdAt').once('value');

                if (!snapshot.exists()) {
                    historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No saved documents yet. Save a document to see it here!</p>';
                    return;
                }

                savedDocuments = [];
                snapshot.forEach((child) => {
                    savedDocuments.push({
                        id: child.key,
                        ...child.val()
                    });
                });

                // Sort by most recent first
                savedDocuments.sort((a, b) => b.createdAt - a.createdAt);

                renderHistoryList(savedDocuments);
            } catch (error) {
                console.error('Error loading history:', error);
                historyList.innerHTML = '<p style="text-align: center; color: var(--warning-text); padding: 40px;">Error loading documents: ' + error.message + '</p>';
            }
        }

        // Render the history list
        function renderHistoryList(docs) {
            const historyList = document.getElementById('historyList');
            const noteTypeNames = {dar:'DAR', darp:'DARP', soap:'SOAP', soapie:'SOAPIE', sbar:'SBAR', pie:'PIE', h2t:'Head-to-Toe', narrative:'Narrative'};

            if (docs.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No documents match your search.</p>';
                return;
            }

            let html = '';
            docs.forEach((doc) => {
                const date = new Date(doc.createdAt);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                html += `
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 12px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="background: var(--accent); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">${noteTypeNames[doc.noteType] || doc.noteType}</span>
                                    <span style="color: var(--text-secondary); font-size: 12px;">${dateStr} at ${timeStr}</span>
                                </div>
                                <div style="color: var(--text-primary); font-weight: 600; font-size: 14px; margin-bottom: 4px;">
                                    ${doc.patientName || 'Unknown Patient'}
                                </div>
                                ${doc.content && doc.content.unit ? `<div style="color: var(--text-secondary); font-size: 12px;">Unit: ${doc.content.unit}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="loadDocument('${doc.id}')" style="background: var(--accent); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    üì• Load
                                </button>
                                <button onclick="deleteDocument('${doc.id}')" style="background: #ef4444; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            historyList.innerHTML = html;
        }

        // Filter history by search term
        function filterHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const filtered = savedDocuments.filter(doc => {
                const patientName = (doc.patientName || '').toLowerCase();
                const noteType = (doc.noteType || '').toLowerCase();
                const unit = (doc.content && doc.content.unit || '').toLowerCase();
                return patientName.includes(searchTerm) || noteType.includes(searchTerm) || unit.includes(searchTerm);
            });
            renderHistoryList(filtered);
        }

        // Load a specific document into the form
        function loadDocument(docId) {
            try {
                const doc = savedDocuments.find(d => d.id === docId);
                if (!doc || !doc.content) {
                    showToast('Document not found.', 'error');
                    return;
                }

                // Confirm before overwriting current form
                if (!confirm('This will replace your current form data. Continue?')) {
                    return;
                }

                const content = doc.content;

                // Set the note type first - need to simulate click for proper activation
                const noteTypeCard = document.querySelector(`.note-type-card[onclick*="${doc.noteType}"]`);
                if (noteTypeCard) {
                    noteTypeCard.click();
                } else {
                    // Fallback: manually set the note type
                    currentNoteType = doc.noteType;
                    document.querySelectorAll('.note-type-card').forEach(c => c.classList.remove('active'));
                    document.querySelectorAll('.note-fields').forEach(f => f.classList.remove('active'));
                    const fields = document.getElementById(doc.noteType + 'Fields');
                    if (fields) fields.classList.add('active');
                    document.getElementById('focusGroup').style.display = ['dar', 'darp'].includes(doc.noteType) ? 'block' : 'none';
                }

            // Load header info
            if (content.nurseName) document.getElementById('nurseName').value = content.nurseName;
            if (content.credentials) document.getElementById('credentials').value = content.credentials;
            if (content.noteDate) document.getElementById('noteDate').value = content.noteDate;
            if (content.noteTime) document.getElementById('noteTime').value = content.noteTime;
            if (content.unit) document.getElementById('unit').value = content.unit;
            if (content.patientId) document.getElementById('patientId').value = content.patientId;
            if (content.patientDemo) document.getElementById('patientDemo').value = content.patientDemo;
            if (content.focus) document.getElementById('focus').value = content.focus;

            // Load diagnoses
            if (content.selectedDiagnoses && Array.isArray(content.selectedDiagnoses)) {
                selectedDiagnoses = content.selectedDiagnoses;
                renderDiagnoses();
            }

            // Load note-specific fields
            const t = doc.noteType;
            if (t === 'dar') {
                if (content.darData) document.getElementById('darData').value = content.darData;
                if (content.darAction) document.getElementById('darAction').value = content.darAction;
                if (content.darResponse) document.getElementById('darResponse').value = content.darResponse;
            } else if (t === 'darp') {
                if (content.darpData) document.getElementById('darpData').value = content.darpData;
                if (content.darpAction) document.getElementById('darpAction').value = content.darpAction;
                if (content.darpResponse) document.getElementById('darpResponse').value = content.darpResponse;
                if (content.darpPlan) document.getElementById('darpPlan').value = content.darpPlan;
            } else if (t === 'soap') {
                if (content.soapSubjective) document.getElementById('soapSubjective').value = content.soapSubjective;
                if (content.soapObjective) document.getElementById('soapObjective').value = content.soapObjective;
                if (content.soapAssessment) document.getElementById('soapAssessment').value = content.soapAssessment;
                if (content.soapPlan) document.getElementById('soapPlan').value = content.soapPlan;
            } else if (t === 'soapie') {
                if (content.soapieSubjective) document.getElementById('soapieSubjective').value = content.soapieSubjective;
                if (content.soapieObjective) document.getElementById('soapieObjective').value = content.soapieObjective;
                if (content.soapieAssessment) document.getElementById('soapieAssessment').value = content.soapieAssessment;
                if (content.soapiePlan) document.getElementById('soapiePlan').value = content.soapiePlan;
                if (content.soapieIntervention) document.getElementById('soapieIntervention').value = content.soapieIntervention;
                if (content.soapieEvaluation) document.getElementById('soapieEvaluation').value = content.soapieEvaluation;
            } else if (t === 'sbar') {
                if (content.sbarSituation) document.getElementById('sbarSituation').value = content.sbarSituation;
                if (content.sbarBackground) document.getElementById('sbarBackground').value = content.sbarBackground;
                if (content.sbarAssessment) document.getElementById('sbarAssessment').value = content.sbarAssessment;
                if (content.sbarRecommendation) document.getElementById('sbarRecommendation').value = content.sbarRecommendation;
            } else if (t === 'pie') {
                if (content.pieProblem) document.getElementById('pieProblem').value = content.pieProblem;
                if (content.pieIntervention) document.getElementById('pieIntervention').value = content.pieIntervention;
                if (content.pieEvaluation) document.getElementById('pieEvaluation').value = content.pieEvaluation;
            } else if (t === 'narrative') {
                if (content.narrativeText) document.getElementById('narrativeText').value = content.narrativeText;
            } else if (t === 'h2t') {
                if (content.h2tNeuro) document.getElementById('h2tNeuro').value = content.h2tNeuro;
                if (content.h2tCardio) document.getElementById('h2tCardio').value = content.h2tCardio;
                if (content.h2tResp) document.getElementById('h2tResp').value = content.h2tResp;
                if (content.h2tGI) document.getElementById('h2tGI').value = content.h2tGI;
                if (content.h2tGU) document.getElementById('h2tGU').value = content.h2tGU;
                if (content.h2tSkin) document.getElementById('h2tSkin').value = content.h2tSkin;
                if (content.h2tMSK) document.getElementById('h2tMSK').value = content.h2tMSK;
                if (content.h2tPain) document.getElementById('h2tPain').value = content.h2tPain;
                if (content.h2tMental) document.getElementById('h2tMental').value = content.h2tMental;
                if (content.h2tSafety) document.getElementById('h2tSafety').value = content.h2tSafety;
                if (content.h2tLines) document.getElementById('h2tLines').value = content.h2tLines;
                if (content.h2tPsych) document.getElementById('h2tPsych').value = content.h2tPsych;
                for (let i = 1; i <= 9; i++) {
                    const key = 'phq' + i;
                    if (content[key] !== undefined && document.getElementById(key)) {
                        document.getElementById(key).value = content[key];
                    }
                }
                for (let i = 1; i <= 7; i++) {
                    const key = 'gad' + i;
                    if (content[key] !== undefined && document.getElementById(key)) {
                        document.getElementById(key).value = content[key];
                    }
                }
                updatePhq9Score();
                updateGad7Score();
            }

            // Close the modal
            document.getElementById('historyModal').classList.add('hidden');
            showToast('Document loaded successfully!', 'success');
            } catch (e) {
                console.error('Error loading document:', e);
                showToast('Error loading document. Please try again.', 'error');
            }
        }

        // Delete a document
        async function deleteDocument(docId) {
            if (!confirm('Are you sure you want to delete this document? This cannot be undone.')) {
                return;
            }

            const uid = getCurrentUserUid();
            if (!uid) {
                showToast('Please log in to delete documents.', 'warning');
                return;
            }

            try {
                const docRef = database.ref('userDocuments/' + uid + '/' + docId);
                await docRef.remove();
                showToast('Document deleted.', 'success');
                loadDocumentHistory(); // Refresh the list
            } catch (error) {
                console.error('Error deleting document:', error);
                showToast('Failed to delete document: ' + error.message, 'error');
            }
        }

        // Initialize Firebase
        console.log('Initializing Firebase...');
        const firebaseConfig = {
            apiKey: "AIzaSyAmr2W8mekSPJ2pXM3gz1FvarfSBddpfLM",
            authDomain: "bendbsn-17377.firebaseapp.com",
            databaseURL: "https://bendbsn-17377-default-rtdb.firebaseio.com",
            projectId: "bendbsn-17377",
            storageBucket: "bendbsn-17377.firebasestorage.app",
            messagingSenderId: "762882187702",
            appId: "1:762882187702:web:81c97c9eae005666796117"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const SESSION_KEY = 'bsn9b_session_key';
        const SESSION_START_KEY = 'bsn9b_session_start';
        const SESSION_HEARTBEAT_MS = 60000;
        let sessionHeartbeatTimer = null;

        function updateSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey) return;
            database.ref('loginHistory/' + sessionKey).update({
                lastSeen: Date.now()
            }).catch(() => {});
        }

        function startSessionHeartbeat() {
            updateSessionHeartbeat();
            if (sessionHeartbeatTimer) clearInterval(sessionHeartbeatTimer);
            sessionHeartbeatTimer = setInterval(updateSessionHeartbeat, SESSION_HEARTBEAT_MS);
        }

        function endSessionTracking(reason) {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey) return;
            if (localStorage.getItem('bsn9b_session_end_sent') === 'true') return;
            const start = parseInt(localStorage.getItem(SESSION_START_KEY) || '0', 10);
            const end = Date.now();
            const durationSeconds = start ? Math.max(0, Math.round((end - start) / 1000)) : null;
            const durationMinutes = durationSeconds !== null ? Math.round(durationSeconds / 60) : null;
            localStorage.setItem('bsn9b_session_end_sent', 'true');
            database.ref('loginHistory/' + sessionKey).update({
                sessionEnd: end,
                durationSeconds: durationSeconds,
                durationMinutes: durationMinutes,
                endReason: reason || 'logout'
            }).catch(() => {});
        }

        function clearSessionTracking() {
            localStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(SESSION_START_KEY);
            localStorage.removeItem('bsn9b_session_end_sent');
        }
        const channelsRef = database.ref('chat/channels');
        const chatRootRef = database.ref('chat/messages');
        let chatRef = null;
        let chatListenerAttached = false;
        let currentChannelId = localStorage.getItem('bsn9b_chat_channel') || 'general';
        let channelsCache = {};
        const presenceRef = database.ref('chat/presence');
        const bannedRef = database.ref('banned');
        const announcementsRef = database.ref('announcements');
        const userProfilesRef = database.ref('userProfiles');

        // Listen for announcements (alert/fyi banners - inside header)
        function setupAnnouncementListener() {
            announcementsRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                const alertBanner = document.getElementById('alertBanner');
                const fyiBanner = document.getElementById('fyiBanner');
                const alertText = document.getElementById('alertText');
                const fyiText = document.getElementById('fyiText');

                // Handle alert banner
                if (data.alert && data.alert.message) {
                    alertText.textContent = data.alert.message;
                    alertBanner.style.display = 'block';
                    document.body.classList.add('has-alert');
                } else {
                    alertBanner.style.display = 'none';
                    document.body.classList.remove('has-alert');
                }

                // Handle FYI banner (offset if alert is showing)
                if (data.fyi && data.fyi.message) {
                    fyiText.textContent = data.fyi.message;
                    fyiBanner.style.display = 'block';
                    fyiBanner.style.top = (data.alert && data.alert.message) ? '50px' : '0';
                    document.body.classList.add('has-fyi');
                } else {
                    fyiBanner.style.display = 'none';
                    document.body.classList.remove('has-fyi');
                }
            });
        }
        setupAnnouncementListener();
        console.log('Firebase initialized, chatRef path:', chatRef.toString());

        // Get display name (first name) - stored when user logs in
        let currentUsername = localStorage.getItem('bsn9b_user') || 'Anonymous';
        let displayName = localStorage.getItem('bsn9b_displayName') || currentUsername;
        let currentUserUid = localStorage.getItem('bsn9b_uid') || '';

        function getCurrentUserEmail() {
            return currentUsername || auth.currentUser?.email || localStorage.getItem('bsn9b_user') || '';
        }

        function getCurrentUserUid() {
            return currentUserUid || auth.currentUser?.uid || localStorage.getItem('bsn9b_uid') || '';
        }

        function syncUserProfile(user) {
            if (!user) return;
            const email = user.email || getCurrentUserEmail();
            const name = displayName || user.displayName || (email ? email.split('@')[0] : 'User');
            const firstName = name.split(' ')[0] || name;
            userProfilesRef.child(user.uid).update({
                email: email,
                displayName: name,
                firstName: firstName,
                updatedAt: Date.now()
            });
        }

        // Verify Firebase Auth state and re-authenticate if needed
        let firebaseAuthReady = false;
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Firebase Auth: Logged in as', user.email);
                firebaseAuthReady = true;
                currentUserUid = user.uid;
                currentUsername = user.email || currentUsername;
                if (user.displayName) {
                    displayName = user.displayName;
                }
                localStorage.setItem('bsn9b_uid', currentUserUid);
                localStorage.setItem('bsn9b_user', currentUsername);
                localStorage.setItem('bsn9b_displayName', displayName);
                syncUserProfile(user);
                migrateLegacyDocumentsIfNeeded();
            } else {
                console.log('Firebase Auth: Not logged in, attempting silent re-auth...');
                // If we have session but no Firebase auth, redirect to login
                // This can happen if Firebase auth expired
                if (localStorage.getItem('bsn9b_auth') === 'true') {
                    console.warn('Session exists but Firebase auth lost - may need to re-login');
                }
            }
        });

        // Check if current user is banned
        function checkIfBanned() {
            bannedRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const banned = child.val();
                    if (banned.username === currentUsername || banned.username === displayName) {
                        showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                        localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                        setTimeout(() => { window.location.href = '/'; }, 2000);
                    }
                });
            });
        }
        checkIfBanned();

        // Listen for bans in real-time
        bannedRef.on('child_added', (snapshot) => {
            const banned = snapshot.val();
            if (banned.username === currentUsername || banned.username === displayName) {
                showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                setTimeout(() => { window.location.href = '/'; }, 2000);
            }
        });

        // Chat state
        let chatOpen = false;
        let unreadCount = 0;
        let lastReadByChannel = JSON.parse(localStorage.getItem('chatLastReadByChannel') || '{}');

        function getLastReadTimestamp(channelId) {
            return parseInt(lastReadByChannel[channelId] || '0');
        }

        function setLastReadTimestamp(channelId, value) {
            lastReadByChannel[channelId] = value.toString();
            localStorage.setItem('chatLastReadByChannel', JSON.stringify(lastReadByChannel));
        }

        function isAdminUser() {
            const adminEmails = ['christiankholden@gmail.com', 'holdenc'];
            return adminEmails.includes((currentUsername || '').toLowerCase());
        }

        // Notification preferences (sound ON by default, browser notifications OFF by default)
        let soundEnabled = localStorage.getItem('chatSoundEnabled') !== 'false';
        let notificationsEnabled = localStorage.getItem('chatNotificationsEnabled') === 'true';

        // Audio notification using Web Audio API
        function playNotificationSound() {
            if (!soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio notification not available:', e);
            }
        }

        // Toggle sound notifications
        function toggleChatSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('chatSoundEnabled', soundEnabled.toString());
            updateSoundToggleUI();
        }

        function updateSoundToggleUI() {
            const btn = document.getElementById('soundToggleBtn');
            if (btn) {
                btn.innerHTML = soundEnabled ? 'üîî' : 'üîï';
                btn.title = soundEnabled ? 'Sound ON (click to mute)' : 'Sound OFF (click to unmute)';
            }
        }

        // Browser Notifications
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Browser does not support notifications');
                return false;
            }

            if (Notification.permission === 'granted') {
                notificationsEnabled = true;
                localStorage.setItem('chatNotificationsEnabled', 'true');
                updateNotificationToggleUI();
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationsEnabled = true;
                    localStorage.setItem('chatNotificationsEnabled', 'true');
                    updateNotificationToggleUI();
                    return true;
                }
            }

            notificationsEnabled = false;
            localStorage.setItem('chatNotificationsEnabled', 'false');
            updateNotificationToggleUI();
            return false;
        }

        function sendBrowserNotification(message) {
            if (!notificationsEnabled || Notification.permission !== 'granted') return;
            if (document.hasFocus() && chatOpen) return;

            try {
                const notification = new Notification('BSN9B Chat', {
                    body: `${message.user}: ${message.text.substring(0, 100)}${message.text.length > 100 ? '...' : ''}`,
                    tag: 'bsn9b-chat',
                    requireInteraction: false
                });

                notification.onclick = function() {
                    window.focus();
                    if (!chatOpen) toggleChat();
                    notification.close();
                };

                setTimeout(() => notification.close(), 5000);
            } catch (e) {
                console.log('Notification error:', e);
            }
        }

        function toggleBrowserNotifications() {
            if (notificationsEnabled) {
                notificationsEnabled = false;
                localStorage.setItem('chatNotificationsEnabled', 'false');
                updateNotificationToggleUI();
            } else {
                requestNotificationPermission();
            }
        }

        function updateNotificationToggleUI() {
            const btn = document.getElementById('notificationToggleBtn');
            if (btn) {
                btn.innerHTML = notificationsEnabled ? 'üì≤' : 'üìµ';
                btn.title = notificationsEnabled ? 'Browser notifications ON' : 'Browser notifications OFF (click to enable)';
            }
        }

        // Initialize notification UI on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSoundToggleUI();
            updateNotificationToggleUI();
        });

        function sanitizeChannelName(name) {
            return (name || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/(^-|-$)/g, '')
                .slice(0, 24);
        }

        function updateChatTitle() {
            const title = document.getElementById('chatTitle');
            if (title) {
                const channelName = channelsCache[currentChannelId]?.name || 'General';
                title.textContent = `BSN9B Chat ¬∑ #${channelName}`;
            }
        }

        function updateChannelSelect() {
            const select = document.getElementById('channelSelect');
            if (!select) return;
            const entries = Object.entries(channelsCache);
            const list = entries.length ? entries : [['general', { name: 'General' }]];
            select.innerHTML = list
                .sort((a, b) => a[1].name.localeCompare(b[1].name))
                .map(([id, ch]) => `<option value="${id}">${ch.name}</option>`)
                .join('');
            select.value = currentChannelId;

            const deleteBtn = document.getElementById('deleteChannelBtn');
            if (deleteBtn) {
                deleteBtn.style.display = isAdminUser() && currentChannelId !== 'general' ? 'inline-flex' : 'none';
            }
            const createBtn = document.getElementById('createChannelBtn');
            if (createBtn) {
                createBtn.style.display = isAdminUser() ? 'inline-flex' : 'none';
            }
        }

        function attachChatRef() {
            if (chatRef && chatListenerAttached) {
                chatRef.off();
                chatListenerAttached = false;
            }
            chatRef = chatRootRef.child(currentChannelId);
        }

        function setChannel(channelId) {
            if (!channelId) return;
            currentChannelId = channelId;
            localStorage.setItem('bsn9b_chat_channel', currentChannelId);
            attachChatRef();
            updateChatTitle();
            updateChannelSelect();
            setupChatListener();
            cleanupOldMessages();
            debugReadMessages();
        }

        function handleChannelChange(value) {
            setChannel(value);
        }

        function createChannel() {
            if (!isAdminUser()) {
                showToast('Only admins can create channels.', 'warning');
                return;
            }
            const name = prompt('Channel name (e.g., meds, clinical, nclex):');
            if (!name) return;
            const id = sanitizeChannelName(name);
            if (!id) {
                showToast('Invalid channel name.', 'warning');
                return;
            }
            channelsRef.child(id).set({
                name: name.trim(),
                createdAt: Date.now(),
                createdBy: currentUsername
            }).then(() => {
                setChannel(id);
            }).catch(err => {
                console.error('Create channel failed:', err);
                showToast('Failed to create channel.', 'error');
            });
        }

        function deleteChannel() {
            if (!isAdminUser()) return;
            if (currentChannelId === 'general') {
                showToast('General cannot be deleted.', 'warning');
                return;
            }
            if (!confirm('Delete this channel and all its messages?')) return;
            const id = currentChannelId;
            const msgRef = chatRootRef.child(id);
            Promise.all([
                channelsRef.child(id).remove(),
                msgRef.remove()
            ]).then(() => {
                setChannel('general');
            }).catch(err => {
                console.error('Delete channel failed:', err);
                showToast('Failed to delete channel.', 'error');
            });
        }

        function loadChannels() {
            channelsRef.on('value', (snapshot) => {
                channelsCache = snapshot.val() || {};
                if (!channelsCache.general) {
                    channelsCache.general = { name: 'General' };
                }
                updateChannelSelect();
                if (!channelsCache[currentChannelId]) {
                    currentChannelId = 'general';
                }
                setChannel(currentChannelId);
            });
        }

        // Toggle chat
        function toggleChat() {
            chatOpen = !chatOpen;
            const chatBox = document.getElementById('chatBox');
            const chatToggle = document.getElementById('chatToggle');
            if (chatOpen) {
                chatBox.style.display = 'flex';
                chatBox.style.flexDirection = 'column';
                unreadCount = 0;
                document.getElementById('chatBadge').style.display = 'none';
                setLastReadTimestamp(currentChannelId, Date.now());
                document.getElementById('chatInput').focus();
                scrollToBottom();
            } else {
                chatBox.style.display = 'none';
            }
            chatToggle.style.transform = chatOpen ? 'scale(0.9)' : 'scale(1)';
            chatToggle.setAttribute('aria-expanded', chatOpen);
            chatToggle.setAttribute('aria-label', chatOpen ? 'Close chat' : 'Open chat');
        }

        // Send message
        function sendMessage(event) {
            event.preventDefault();
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Admin commands (admin emails only)
            if (isAdminUser()) {
                // Alert command: alert/message or alert/clear
                if (message.toLowerCase().startsWith('alert/')) {
                    const alertMsg = message.substring(6).trim();
                    if (alertMsg.toLowerCase() === 'clear') {
                        announcementsRef.child('alert').remove();
                    } else if (alertMsg) {
                        announcementsRef.child('alert').set({ message: alertMsg, timestamp: Date.now() });
                    }
                    input.value = '';
                    return;
                }
                // FYI command: fyi/message or fyi/clear
                if (message.toLowerCase().startsWith('fyi/')) {
                    const fyiMsg = message.substring(4).trim();
                    if (fyiMsg.toLowerCase() === 'clear') {
                        announcementsRef.child('fyi').remove();
                    } else if (fyiMsg) {
                        announcementsRef.child('fyi').set({ message: fyiMsg, timestamp: Date.now() });
                    }
                    input.value = '';
                    return;
                }
                // Chat clear command: chat/clear
                if (message.toLowerCase() === 'chat/clear') {
                    chatRef.remove();
                    input.value = '';
                    return;
                }
            }

            // Check Firebase Auth status
            const currentUser = auth.currentUser;
            console.log('Sending message, Firebase auth user:', currentUser ? currentUser.email : 'NOT AUTHENTICATED');

            if (!currentUser) {
                showToast('Chat requires authentication. Please refresh the page or log in again.', 'error');
                return;
            }

            chatRef.push({
                user: displayName,
                username: currentUsername,
                text: message,
                timestamp: Date.now()
            }).then(() => {
                console.log('Message sent successfully');
            }).catch((error) => {
                console.error('Failed to send message:', error);
                showToast('Failed to send message: ' + error.message + '. You may need to log in again.', 'error');
            });

            input.value = '';
            hideMentionDropdown();
        }

        // Format timestamp (with safety checks)
        function formatTime(timestamp) {
            try {
                if (!timestamp || typeof timestamp !== 'number') {
                    return 'Unknown time';
                }
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    return 'Invalid time';
                }
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();

                if (isToday) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            } catch (e) {
                console.error('formatTime error:', e);
                return 'Time error';
            }
        }

        // Format message text with @mention highlighting (with safety checks)
        function formatMessageWithMentions(text, isMe) {
            try {
                if (!text || typeof text !== 'string') {
                    return '';
                }
                // Escape HTML first
                let formatted = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                // Highlight @mentions with a styled span
                formatted = formatted.replace(/@(\w+)/g, function(match, name) {
                    const bgColor = isMe ? 'rgba(255,255,255,0.3)' : 'rgba(139, 92, 246, 0.2)';
                    const textColor = isMe ? '#fff' : '#7c3aed';
                    return `<span style="background: ${bgColor}; color: ${textColor}; padding: 1px 6px; border-radius: 10px; font-weight: 600;">@${name}</span>`;
                });

                return formatted;
            } catch (e) {
                console.error('formatMessageWithMentions error:', e);
                return text || '';
            }
        }

        // Scroll to bottom
        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        // 7-day threshold in milliseconds
        const MESSAGE_RETENTION_MS = 7 * 24 * 60 * 60 * 1000;

        // Debug: Direct test read of messages
        function debugReadMessages() {
            if (!chatRef) return;
            chatRef.once('value').then((snapshot) => {
                console.log('DEBUG direct read - exists:', snapshot.exists());
                console.log('DEBUG direct read - data:', snapshot.val());
            }).catch((err) => {
                console.error('DEBUG direct read error:', err);
            });
        }

        // Clean up old messages (older than 48 hours)
        function cleanupOldMessages() {
            const cutoff = Date.now() - MESSAGE_RETENTION_MS;
            if (!chatRef) return;
            chatRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const msg = child.val();
                    if (msg.timestamp && msg.timestamp < cutoff) {
                        child.ref.remove();
                    }
                });
            });
        }

        // Run cleanup on load and every hour
        cleanupOldMessages();
        setInterval(cleanupOldMessages, 60 * 60 * 1000);

        // Debug function - call from console: testChat()
        window.testChat = function() {
            console.log('Testing chat connection...');
            if (!chatRef) return;
            chatRef.once('value').then((snap) => {
                console.log('Test read success!');
                console.log('Data exists:', snap.exists());
                console.log('Data:', snap.val());
                if (snap.exists()) {
                    const container = document.getElementById('chatMessages');
                    let html = '<div style="padding: 10px; background: #d4edda; margin-bottom: 10px; border-radius: 8px;">Test read successful! Found ' + snap.numChildren() + ' messages.</div>';
                    snap.forEach((child) => {
                        const msg = child.val();
                        html += '<div style="padding: 8px; border-bottom: 1px solid #eee;"><strong>' + (msg.user || 'Unknown') + ':</strong> ' + (msg.text || 'No text') + '</div>';
                    });
                    container.innerHTML = html;
                }
            }).catch((err) => {
                console.error('Test read failed:', err);
            });
        };

        // Listen for messages
        function setupChatListener() {
            console.log('Setting up chat listener...');
            if (!chatRef) return;
            if (chatListenerAttached) {
                chatRef.off();
                chatListenerAttached = false;
            }
            chatRef.on('value', (snapshot) => {
                chatListenerAttached = true;
                console.log('=== CHAT LISTENER FIRED ===');
                console.log('Snapshot exists:', snapshot.exists());
                console.log('Snapshot numChildren:', snapshot.numChildren());

                const container = document.getElementById('chatMessages');
                if (!container) {
                    console.error('chatMessages container not found!');
                    return;
                }

                if (!snapshot.exists() || snapshot.numChildren() === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; margin-top: 20px;">No messages yet. Start the conversation!</p>';
                    return;
                }

                // Get ALL messages first, then filter
                const allMessages = [];
                snapshot.forEach((child) => {
                    const msg = child.val();
                    console.log('Message found:', msg);
                    allMessages.push(msg);
                });

                console.log('Total messages found:', allMessages.length);

                // Filter by 48 hours
                const cutoff = Date.now() - MESSAGE_RETENTION_MS;
                let messages = allMessages.filter(msg => msg.timestamp && msg.timestamp >= cutoff);

                console.log('Messages after 48h filter:', messages.length);

                // Sort by timestamp
                messages.sort((a, b) => a.timestamp - b.timestamp);

                // Limit to last 50 messages for performance
                const MAX_DISPLAY_MESSAGES = 50;
                const hasOlderMessages = messages.length > MAX_DISPLAY_MESSAGES;
                if (hasOlderMessages) {
                    messages = messages.slice(-MAX_DISPLAY_MESSAGES);
                }

                if (messages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; margin-top: 20px;">No messages yet. Start the conversation!</p>';
                    return;
                }

                let html = '';
                // Show indicator if older messages are hidden
                if (hasOlderMessages) {
                    html += '<p style="text-align: center; color: #888; font-size: 11px; padding: 8px; background: #f0f0f0; border-radius: 8px; margin-bottom: 10px;">Showing last 50 messages</p>';
                }
                let newMessages = 0;

                messages.forEach((msg) => {
                    const isMe = msg.user === displayName || msg.username === currentUsername;
                    const isNew = msg.timestamp > getLastReadTimestamp(currentChannelId);

                    if (isNew && !chatOpen) newMessages++;

                    // Format text with @mention highlighting
                    const formattedText = formatMessageWithMentions(msg.text, isMe);
                    // Check if this message mentions the current user
                    const mentionsMe = msg.text.toLowerCase().includes('@' + displayName.toLowerCase());

                    html += `
                        <div style="margin-bottom: 12px; display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'};">
                            <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${isMe ? 'You' : msg.user}</div>
                            <div style="background: ${mentionsMe && !isMe ? 'linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%)' : (isMe ? 'linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%)' : '#e2e8f0')}; color: ${mentionsMe || isMe ? 'white' : '#333'}; padding: 10px 14px; border-radius: ${isMe ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 80%; word-wrap: break-word; font-size: 14px; ${mentionsMe && !isMe ? 'box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);' : ''}">
                                ${formattedText}
                            </div>
                            <div style="font-size: 9px; color: #aaa; margin-top: 3px;">
                                ${formatTime(msg.timestamp)}${isMe ? ' <span style="color: #4ade80;" title="Delivered">‚úì</span>' : ''}
                            </div>
                        </div>
                    `;
                });

                console.log('Setting innerHTML with', html.length, 'chars');
                container.innerHTML = html;
                scrollToBottom();

                // Update unread badge and send notifications
                if (newMessages > 0 && !chatOpen) {
                    // Only notify if this is a genuinely new message (not page load)
                    const shouldNotify = unreadCount < newMessages;

                    unreadCount = newMessages;
                    const badge = document.getElementById('chatBadge');
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    badge.style.display = 'flex';

                    // Play sound and send browser notification for new messages
                    if (shouldNotify && messages.length > 0) {
                        const latestMessage = messages[messages.length - 1];
                        // Don't notify for your own messages
                        if (latestMessage.username !== currentUsername) {
                            playNotificationSound();
                            sendBrowserNotification(latestMessage);
                        }
                    }
                }
            }, (error) => {
                console.error('Chat listener error:', error);
                document.getElementById('chatMessages').innerHTML = '<p style="color: red; padding: 20px;">Chat error: ' + error.message + '</p>';
            });
        }

        // Initialize channels + chat listener
        loadChannels();

        // ========== CHAT CONNECTION MONITORING ==========
        // Monitor Firebase connection state
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            const connected = snap.val() === true;
            const onlineCountEl = document.getElementById('onlineCount');
            if (connected) {
                console.log('Firebase: Connected');
                if (onlineCountEl && onlineCountEl.textContent.includes('Disconnected')) {
                    onlineCountEl.textContent = 'Reconnected! Refreshing...';
                    // Re-setup listener on reconnect
                    setTimeout(() => setupChatListener(), 500);
                }
            } else {
                console.log('Firebase: Disconnected');
                if (onlineCountEl) {
                    onlineCountEl.innerHTML = '<span style="color: #fca5a5;">Disconnected - reconnecting...</span>';
                }
            }
        });

        // Wrap critical operations in try-catch
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, 'at', url, lineNo);
            // Don't show alert for every error, just log
            return false;
        };

        // ========== DIRECT MESSAGES ==========
        let chatMode = 'group'; // 'group' or 'dm'
        let currentDMConversation = null;
        let dmConversations = [];
        let dmUnreadCount = 0;
        let dmLastReadTimestamps = JSON.parse(localStorage.getItem('dmLastRead') || '{}');
        const directMessagesRef = database.ref('directMessages');
        let userProfilesByUid = {};
        let userProfilesByEmail = {};
        let userProfilesByName = {};

        function rebuildUserProfileIndexes(profiles) {
            userProfilesByUid = {};
            userProfilesByEmail = {};
            userProfilesByName = {};
            if (!profiles) return;

            Object.keys(profiles).forEach((uid) => {
                const profile = profiles[uid] || {};
                const email = (profile.email || '').toLowerCase();
                const name = (profile.displayName || profile.firstName || '').toLowerCase();
                userProfilesByUid[uid] = profile;
                if (email) userProfilesByEmail[email] = { uid: uid, ...profile };
                if (name) userProfilesByName[name] = { uid: uid, ...profile };
            });
        }

        async function loadUserProfiles() {
            try {
                const snap = await userProfilesRef.once('value');
                rebuildUserProfileIndexes(snap.val());
            } catch (e) {
                console.warn('Failed to load user profiles:', e);
            }
        }

        function addUidsToRegisteredUsers() {
            allRegisteredUsers = allRegisteredUsers.map((u) => {
                const email = (u.email || '').toLowerCase();
                const name = (u.firstName || u.name || '').toLowerCase();
                const profile = userProfilesByEmail[email] || userProfilesByName[name];
                return { ...u, uid: profile?.uid || '' };
            });
        }

        // Generate conversation ID (sorted UIDs)
        function getConversationId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

        // Switch between group chat and DM mode
        function switchChatMode(mode) {
            try {
                chatMode = mode;
                const groupView = document.getElementById('groupChatView');
                const dmView = document.getElementById('dmView');
                const tabGroup = document.getElementById('tabGroupChat');
                const tabDM = document.getElementById('tabDM');
                const chatTitle = document.getElementById('chatTitle');
                const onlineCount = document.getElementById('onlineCount');

                // Safety checks
                if (!groupView || !dmView) {
                    console.error('Chat views not found');
                    return;
                }

            if (mode === 'group') {
                groupView.style.display = 'flex';
                dmView.style.display = 'none';
                tabGroup.style.background = 'rgba(255,255,255,0.3)';
                tabDM.style.background = 'rgba(255,255,255,0.1)';
                tabGroup.setAttribute('aria-selected', 'true');
                tabDM.setAttribute('aria-selected', 'false');
                chatTitle.textContent = 'BSN9B Chat';
                onlineCount.style.display = 'block';

                // Reset unread for group
                unreadCount = 0;
                document.getElementById('chatBadge').style.display = 'none';
                setLastReadTimestamp(currentChannelId, Date.now());
            } else {
                groupView.style.display = 'none';
                dmView.style.display = 'flex';
                tabGroup.style.background = 'rgba(255,255,255,0.1)';
                tabDM.style.background = 'rgba(255,255,255,0.3)';
                tabGroup.setAttribute('aria-selected', 'false');
                tabDM.setAttribute('aria-selected', 'true');
                chatTitle.textContent = 'Direct Messages';
                onlineCount.style.display = 'none';

                // Show conversation list
                showDMConversationList();
                loadDMConversations();
            }
            } catch (e) {
                console.error('Error switching chat mode:', e);
            }
        }

        // Show the conversation list view
        function showDMConversationList() {
            document.getElementById('dmConversationList').style.display = 'block';
            document.getElementById('dmMessageView').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'none';
            currentDMConversation = null;
        }

        // Show new DM user selector
        function showNewDMSelector() {
            document.getElementById('dmConversationList').style.display = 'none';
            document.getElementById('dmMessageView').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'flex';
            document.getElementById('dmUserSearch').value = '';
            loadDMUserList();
        }

        // Hide new DM selector
        function hideNewDMSelector() {
            showDMConversationList();
        }

        // Load user list for new DM
        async function loadDMUserList() {
            const container = document.getElementById('dmUserList');

            // Combine online users and all registered users
            await loadUserProfiles();
            addUidsToRegisteredUsers();
            const onlineSet = new Set(onlineUsersDetailed.map(u => (u.name || '').toLowerCase()));
            let users = [];

            // Add online users first
            onlineUsersDetailed.forEach(u => {
                if ((u.name || '').toLowerCase() !== displayName.toLowerCase()) {
                    users.push({
                        name: u.name,
                        online: true,
                        uid: u.uid || '',
                        email: u.email || u.username || ''
                    });
                }
            });

            // Add registered users who aren't online
            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                if (!onlineSet.has(firstName.toLowerCase()) && firstName.toLowerCase() !== displayName.toLowerCase()) {
                    users.push({
                        name: firstName,
                        fullName: u.name,
                        email: u.email,
                        online: false,
                        uid: u.uid || ''
                    });
                }
            });

            renderDMUserList(users);
        }

        // Filter DM users by search
        function filterDMUsers() {
            const search = document.getElementById('dmUserSearch').value.toLowerCase();
            const onlineSet = new Set(onlineUsersDetailed.map(u => (u.name || '').toLowerCase()));
            let users = [];

            onlineUsersDetailed.forEach(u => {
                const name = (u.name || '').toLowerCase();
                if (name !== displayName.toLowerCase() && name.includes(search)) {
                    users.push({
                        name: u.name,
                        online: true,
                        uid: u.uid || '',
                        email: u.email || u.username || ''
                    });
                }
            });

            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                if (!onlineSet.has(firstName.toLowerCase()) &&
                    firstName.toLowerCase() !== displayName.toLowerCase() &&
                    (firstName.toLowerCase().includes(search) || u.name.toLowerCase().includes(search))) {
                    users.push({
                        name: firstName,
                        fullName: u.name,
                        email: u.email,
                        online: false,
                        uid: u.uid || ''
                    });
                }
            });

            renderDMUserList(users);
        }

        // Render DM user list
        function renderDMUserList(users) {
            const container = document.getElementById('dmUserList');

            if (users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px;">No users found</p>';
                return;
            }

            container.innerHTML = users.map(u => `
                <div onclick="startDMConversation('${u.uid || ''}', '${u.name}', '${u.email || ''}')" style="padding: 12px; background: white; border-radius: 10px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div>
                        <div style="font-weight: 600; color: #1a1a2e;">${u.name}${u.fullName && u.fullName !== u.name ? ` <span style="color:#888;font-weight:normal;font-size:12px;">(${u.fullName})</span>` : ''}</div>
                    </div>
                    ${u.online ? '<span style="font-size: 10px; background: #22c55e; color: white; padding: 2px 8px; border-radius: 10px;">online</span>' : '<span style="font-size: 10px; color: #888;">offline</span>'}
                </div>
            `).join('');
        }

        // Start or open a DM conversation
        function startDMConversation(partnerUid, partnerName, partnerEmail) {
            const currentUid = getCurrentUserUid();
            if (!currentUid || !partnerUid) {
                showToast('This user is not available for DMs yet. Ask them to log in once so we can link their account.', 'warning');
                return;
            }

            currentDMConversation = {
                partnerName: partnerName,
                partnerUid: partnerUid,
                partnerEmail: partnerEmail || '',
                conversationId: getConversationId(currentUid, partnerUid)
            };

            // Update UI
            document.getElementById('dmConversationList').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'none';
            document.getElementById('dmMessageView').style.display = 'flex';
            document.getElementById('dmPartnerName').textContent = partnerName;

            // Check if partner is online
            const isOnline = onlineUsersDetailed.some(u =>
                (u.uid && u.uid === partnerUid) ||
                (u.name && u.name.toLowerCase() === partnerName.toLowerCase())
            );
            const statusEl = document.getElementById('dmPartnerStatus');
            statusEl.textContent = isOnline ? 'online' : 'offline';
            statusEl.style.background = isOnline ? '#dcfce7' : '#e2e8f0';
            statusEl.style.color = isOnline ? '#16a34a' : '#666';

            // Load messages
            loadDMMessages(currentDMConversation.conversationId);

            // Mark as read
            markDMAsRead(currentDMConversation.conversationId);
        }

        // Close DM conversation and go back to list
        function closeDMConversation() {
            currentDMConversation = null;
            showDMConversationList();
            loadDMConversations();
        }

        // Load DM conversations list
        function loadDMConversations() {
            const container = document.getElementById('dmConversations');
            if (!container) return;

            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading...</p>';

            // Query all conversations where the current user is a participant
            const currentUid = getCurrentUserUid();
            if (!currentUid) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">Please log in to view messages.</p>';
                return;
            }

            directMessagesRef.once('value', (snapshot) => {
                dmConversations = [];

                snapshot.forEach((child) => {
                    const convId = child.key;
                    const data = child.val();

                    if (!data) return;

                    // Check if current user is in this conversation
                    const participants = data.participants || {};
                    if (!participants[currentUid]) return;

                    if (data.lastMessage) {
                        // Get partner info
                        const partnerUid = Object.keys(participants).find(uid => uid !== currentUid);
                        const partner = partnerUid ? (participants[partnerUid] || {}) : {};
                        const partnerName = partner.displayName || partner.name || 'Unknown';
                        const partnerEmail = partner.email || '';

                        dmConversations.push({
                            conversationId: convId,
                            partnerUid: partnerUid || '',
                            partnerName: partnerName,
                            partnerEmail: partnerEmail,
                            lastMessage: data.lastMessage,
                            unread: !dmLastReadTimestamps[convId] || data.lastMessage.timestamp > dmLastReadTimestamps[convId]
                        });
                    }
                });

                // Sort by most recent
                dmConversations.sort((a, b) => (b.lastMessage?.timestamp || 0) - (a.lastMessage?.timestamp || 0));

                renderDMConversations();
            });
        }

        // Render DM conversations
        function renderDMConversations() {
            const container = document.getElementById('dmConversations');

            if (dmConversations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; padding: 20px;">No conversations yet.<br>Start a new message!</p>';
                return;
            }

            let totalUnread = 0;
            container.innerHTML = dmConversations.map(conv => {
                const time = conv.lastMessage ? formatTime(conv.lastMessage.timestamp) : '';
                const preview = conv.lastMessage ? (conv.lastMessage.text || '').substring(0, 40) + (conv.lastMessage.text?.length > 40 ? '...' : '') : '';
                const isUnread = conv.unread && conv.lastMessage?.senderUid !== getCurrentUserUid();
                if (isUnread) totalUnread++;

                return `
                    <div onclick="startDMConversation('${conv.partnerUid || ''}', '${conv.partnerName}', '${conv.partnerEmail || ''}')" style="padding: 12px; background: ${isUnread ? '#f0f7ff' : 'white'}; border-radius: 10px; margin-bottom: 8px; cursor: pointer; border: 1px solid ${isUnread ? '#8b5cf6' : '#e2e8f0'}; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='${isUnread ? '#8b5cf6' : '#e2e8f0'}'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: ${isUnread ? '700' : '600'}; color: #1a1a2e; margin-bottom: 4px;">
                                    ${isUnread ? '‚óè ' : ''}${conv.partnerName}
                                </div>
                                <div style="font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${conv.lastMessage?.senderUid === getCurrentUserUid() ? 'You: ' : ''}${preview}
                                </div>
                            </div>
                            <div style="font-size: 10px; color: #888; white-space: nowrap; margin-left: 10px;">
                                ${time}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update DM badge
            updateDMBadge(totalUnread);
        }

        // Update DM badge count
        function updateDMBadge(count) {
            dmUnreadCount = count;
            const badge = document.getElementById('dmBadge');
            const tabBadge = document.getElementById('dmTabBadge');

            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count;
                badge.style.display = 'flex';
                tabBadge.textContent = count;
                tabBadge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
                tabBadge.style.display = 'none';
            }
        }

        // Load messages for a DM conversation
        function loadDMMessages(conversationId) {
            const container = document.getElementById('dmMessages');
            container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px;">Loading messages...</p>';

            const messagesRef = directMessagesRef.child(conversationId + '/messages');
            messagesRef.orderByChild('timestamp').on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; padding: 20px;">No messages yet. Say hello!</p>';
                    return;
                }

                const messages = [];
                snapshot.forEach((child) => {
                    messages.push(child.val());
                });

                let html = '';
                const currentUid = getCurrentUserUid();
                messages.forEach(msg => {
                    const isMe = msg.senderUid ? msg.senderUid === currentUid : (msg.senderName === displayName || msg.sender === currentUsername);
                    const senderLabel = isMe ? 'You' : (msg.senderName || msg.sender || 'User');

                    html += `
                        <div style="margin-bottom: 12px; display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'};">
                            <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${senderLabel}</div>
                            <div style="background: ${isMe ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' : '#e2e8f0'}; color: ${isMe ? 'white' : '#333'}; padding: 10px 14px; border-radius: ${isMe ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 80%; word-wrap: break-word; font-size: 14px;">
                                ${(msg.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            </div>
                            <div style="font-size: 9px; color: #aaa; margin-top: 3px;">
                                ${formatTime(msg.timestamp)}${isMe ? (msg.read ? ' <span style="color: #4ade80;" title="Seen">‚úì‚úì</span>' : ' <span style="color: #888;" title="Delivered">‚úì</span>') : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                container.scrollTop = container.scrollHeight;

                // Mark messages as read in Firebase (for messages we received)
                if (currentDMConversation && currentDMConversation.conversationId === conversationId) {
                    markDMAsRead(conversationId, snapshot);
                }
            });
        }

        // Send a DM
        function sendDM(event) {
            event.preventDefault();

            if (!currentDMConversation) return;

            const input = document.getElementById('dmInput');
            if (!input) return;

            const text = input.value.trim();
            if (!text) return;

            const currentUser = auth.currentUser;
            if (!currentUser) {
                showToast('Please log in to send messages.', 'warning');
                return;
            }

            const conversationId = currentDMConversation.conversationId;
            const partnerName = currentDMConversation.partnerName;
            const partnerUid = currentDMConversation.partnerUid;
            const partnerEmail = currentDMConversation.partnerEmail || '';
            const currentUid = getCurrentUserUid();
            if (!currentUid || !partnerUid) {
                showToast('Unable to send DM (missing user ID). Please refresh and try again.', 'warning');
                return;
            }

            const messageData = {
                senderUid: currentUid,
                senderEmail: currentUsername,
                senderName: displayName,
                text: text,
                timestamp: Date.now(),
                read: false
            };

            try {
                // Add message
                directMessagesRef.child(conversationId + '/messages').push(messageData)
                    .catch(err => console.error('Error sending DM:', err));

                // Update participants
                const participantsData = {};
                participantsData[currentUid] = { displayName: displayName, email: currentUsername };
                participantsData[partnerUid] = { displayName: partnerName, email: partnerEmail };
                directMessagesRef.child(conversationId + '/participants').set(participantsData);

                // Update last message
                directMessagesRef.child(conversationId + '/lastMessage').set({
                    text: text,
                    timestamp: Date.now(),
                    senderUid: currentUid,
                    senderName: displayName
                });

                input.value = '';
            } catch (e) {
                console.error('Error sending DM:', e);
                showToast('Failed to send message. Please try again.', 'error');
            }
        }

        // Mark DM conversation as read
        function markDMAsRead(conversationId, snapshot) {
            dmLastReadTimestamps[conversationId] = Date.now();
            localStorage.setItem('dmLastRead', JSON.stringify(dmLastReadTimestamps));

            // Mark unread messages in Firebase as read (messages we received)
            if (snapshot && snapshot.exists()) {
                const currentUid = getCurrentUserUid();
                snapshot.forEach((child) => {
                    const msg = child.val();
                    const msgKey = child.key;
                    // Only mark messages from others as read
                    const isMine = msg && msg.senderUid ? msg.senderUid === currentUid : (msg.senderName === displayName || msg.sender === currentUsername);
                    if (msg && !msg.read && !isMine) {
                        directMessagesRef.child(conversationId + '/messages/' + msgKey + '/read').set(true)
                            .catch(err => console.error('Error marking message as read:', err));
                    }
                });
            }

            // Recalculate unread count
            let totalUnread = 0;
            dmConversations.forEach(conv => {
                if (conv.conversationId !== conversationId) {
                    if (conv.unread && conv.lastMessage?.senderUid !== getCurrentUserUid()) {
                        totalUnread++;
                    }
                }
            });
            updateDMBadge(totalUnread);
        }

        async function runDMSelfTest() {
            const uid = getCurrentUserUid();
            const email = getCurrentUserEmail();
            if (!uid) {
                showToast('Please log in to run the DM test.', 'warning');
                return;
            }

            const convId = 'selftest_' + uid;
            const convRef = directMessagesRef.child(convId);
            const participantsData = {};
            participantsData[uid] = { displayName: displayName, email: email };

            const messageData = {
                senderUid: uid,
                senderEmail: email,
                senderName: displayName,
                text: 'DM self-test at ' + new Date().toLocaleTimeString(),
                timestamp: Date.now(),
                read: true
            };

            try {
                await convRef.child('participants').set(participantsData);
                await convRef.child('messages').push(messageData);
                const snap = await convRef.child('messages').limitToLast(1).once('value');
                if (snap.exists()) {
                    showToast('DM self-test passed.', 'success');
                } else {
                    showToast('DM self-test failed. Check rules.', 'error');
                }
                try { await convRef.remove(); } catch (e) {}
            } catch (e) {
                console.error('DM self-test error:', e);
                showToast('DM self-test failed: ' + e.message, 'error');
            }
        }

        // Listen for new DMs (for notifications)
        function setupDMListener() {
            try {
                directMessagesRef.on('child_changed', (snapshot) => {
                    try {
                        const convId = snapshot.key;
                        const data = snapshot.val();

                        if (!data) return;

                        // Check if we're a participant
                        const participants = data.participants || {};
                        const currentUid = getCurrentUserUid();
                        if (!currentUid || !participants[currentUid]) return;

                        const partnerUid = Object.keys(participants).find(uid => uid !== currentUid);
                        const partner = partnerUid ? (participants[partnerUid] || {}) : {};
                        const partnerName = partner.displayName || partner.name || 'Unknown';
                        const partnerEmail = partner.email || '';

                        // Check if it's a new message for us
                        if (data.lastMessage && data.lastMessage.senderUid !== currentUid) {
                            const lastRead = dmLastReadTimestamps[convId] || 0;
                            if (data.lastMessage.timestamp > lastRead) {
                                // Play notification sound
                                if (!chatOpen || chatMode !== 'dm' || currentDMConversation?.conversationId !== convId) {
                                    playNotificationSound();

                                    // Browser notification
                                    if (notificationsEnabled && Notification.permission === 'granted') {
                                        try {
                                            const notification = new Notification('New DM from ' + partnerName, {
                                                body: (data.lastMessage.text || '').substring(0, 100),
                                                tag: 'bsn9b-dm-' + convId
                                            });
                                            notification.onclick = () => {
                                                window.focus();
                                                if (!chatOpen) toggleChat();
                                                switchChatMode('dm');
                                                startDMConversation(partnerUid || '', partnerName, partnerEmail);
                                                notification.close();
                                            };
                                        } catch (notifErr) {
                                            console.log('Notification error:', notifErr);
                                        }
                                    }
                                }

                                // Refresh conversation list if viewing DMs
                                if (chatOpen && chatMode === 'dm' && !currentDMConversation) {
                                    loadDMConversations();
                                }
                            }
                        }
                    } catch (innerErr) {
                        console.error('DM listener inner error:', innerErr);
                    }
                });
            } catch (e) {
                console.error('Error setting up DM listener:', e);
            }
        }

        // Initialize DM listener
        setupDMListener();

        // ========== AI NURSING COMPANION ==========
        const AI_API_URL = 'https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec';
        let aiOpen = false;
        let aiConversation = [];

        const AI_SYSTEM_PROMPT = `You are a helpful nursing education assistant for BSN nursing students. Your role is to:
- Explain nursing concepts, procedures, and pathophysiology clearly
- Provide drug information including mechanism, side effects, and nursing considerations
- Help develop care plans using NANDA-I diagnoses, NIC interventions, and NOC outcomes
- Generate NCLEX-style practice questions with detailed rationales
- Explain lab values and their clinical significance
- Guide through clinical scenarios and critical thinking

Important guidelines:
- Always emphasize this is for EDUCATIONAL purposes only, not actual patient care
- Encourage students to verify information with their instructors and official resources
- Be concise but thorough - nursing students are busy
- Use proper medical terminology while explaining in accessible terms
- When discussing medications, always mention common nursing considerations
- For NCLEX questions, provide the answer AND detailed rationales for all options`;

        function toggleAI() {
            aiOpen = !aiOpen;
            const aiBox = document.getElementById('aiBox');
            if (aiOpen) {
                aiBox.style.display = 'flex';
                document.getElementById('aiInput').focus();
            } else {
                aiBox.style.display = 'none';
            }
            document.getElementById('aiToggle').style.transform = aiOpen ? 'scale(0.9)' : 'scale(1)';
        }

        function aiQuickAction(type) {
            const input = document.getElementById('aiInput');
            switch(type) {
                case 'drug':
                    input.value = 'Tell me about the medication: ';
                    input.focus();
                    break;
                case 'careplan':
                    input.value = 'Help me create a care plan for a patient with: ';
                    input.focus();
                    break;
                case 'nclex':
                    input.value = 'Give me an NCLEX practice question about: ';
                    input.focus();
                    break;
                case 'labs':
                    input.value = 'Explain the lab value and nursing implications: ';
                    input.focus();
                    break;
            }
        }

        function addAIMessage(text, isUser) {
            const container = document.getElementById('aiMessages');
            const msgDiv = document.createElement('div');
            msgDiv.style.cssText = `
                margin-bottom: 12px;
                display: flex;
                flex-direction: column;
                align-items: ${isUser ? 'flex-end' : 'flex-start'};
            `;

            // Format AI responses with markdown-like styling
            let formattedText = text;
            if (!isUser) {
                // Convert **bold** to <strong>
                formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Convert bullet points
                formattedText = formattedText.replace(/^[\-\‚Ä¢]\s/gm, '‚Ä¢ ');
                // Convert newlines to <br>
                formattedText = formattedText.replace(/\n/g, '<br>');
            }

            msgDiv.innerHTML = `
                <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${isUser ? 'You' : 'ü©∫ AI Assistant'}</div>
                <div style="background: ${isUser ? 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)' : 'linear-gradient(135deg, #0d9488 0%, #14b8a6 100%)'}; color: white; padding: 12px 16px; border-radius: ${isUser ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 90%; word-wrap: break-word; font-size: 14px; line-height: 1.5;">
                    ${isUser ? text.replace(/</g, '&lt;').replace(/>/g, '&gt;') : formattedText}
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showAITyping() {
            const container = document.getElementById('aiMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'aiTyping';
            typingDiv.style.cssText = 'margin-bottom: 12px; display: flex; flex-direction: column; align-items: flex-start;';
            typingDiv.innerHTML = `
                <div style="font-size: 10px; color: #888; margin-bottom: 3px;">ü©∫ AI Assistant</div>
                <div style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 12px 16px; border-radius: 16px 16px 16px 4px; font-size: 14px;">
                    <span class="typing-dots">Thinking<span>.</span><span>.</span><span>.</span></span>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function hideAITyping() {
            const typing = document.getElementById('aiTyping');
            if (typing) typing.remove();
        }

        async function sendAIMessage(event) {
            event.preventDefault();
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            const sendBtn = document.getElementById('aiSendBtn');

            if (!message) return;

            // Add user message to UI
            addAIMessage(message, true);
            input.value = '';
            sendBtn.disabled = true;

            // Add to conversation history
            aiConversation.push({ role: 'user', content: message });

            // Show typing indicator
            showAITyping();

            try {
                const response = await fetch(AI_API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        messages: aiConversation,
                        systemPrompt: AI_SYSTEM_PROMPT
                    })
                });

                const data = await response.json();
                hideAITyping();

                if (data.success && data.response) {
                    addAIMessage(data.response, false);
                    aiConversation.push({ role: 'assistant', content: data.response });

                    // Keep conversation history manageable (last 10 exchanges)
                    if (aiConversation.length > 20) {
                        aiConversation = aiConversation.slice(-20);
                    }
                } else {
                    addAIMessage('Sorry, I encountered an error. Please try again. ' + (data.error || ''), false);
                }
            } catch (error) {
                hideAITyping();
                console.error('AI API Error:', error);
                addAIMessage('Sorry, I could not connect to the AI service. Please check your connection and try again.', false);
            }

            sendBtn.disabled = false;
            input.focus();
        }

        // Add typing animation CSS
        const aiStyle = document.createElement('style');
        aiStyle.textContent = `
            .typing-dots span {
                animation: blink 1.4s infinite;
                animation-fill-mode: both;
            }
            .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
            .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
            @keyframes blink {
                0%, 80%, 100% { opacity: 0; }
                40% { opacity: 1; }
            }
        `;
        document.head.appendChild(aiStyle);

        // Track online presence - use display name (first name)
        const myPresence = presenceRef.push();
        myPresence.set({
            user: displayName,
            username: currentUsername,
            uid: getCurrentUserUid(),
            email: getCurrentUserEmail(),
            online: true
        });
        myPresence.onDisconnect().remove();

        let userListVisible = false;
        function toggleUserList() {
            userListVisible = !userListVisible;
            document.getElementById('userList').style.display = userListVisible ? 'block' : 'none';
        }

        // Store online users for @mention autocomplete
        let onlineUsers = [];
        let onlineUsersDetailed = [];

        presenceRef.on('value', (snapshot) => {
            const count = snapshot.numChildren();
            document.getElementById('onlineCount').textContent = count + ' online (click to see)';

            // Build user list with clickable @mention
            onlineUsers = [];
            onlineUsersDetailed = [];
            snapshot.forEach((child) => {
                const data = child.val();
                if (data.user) {
                    onlineUsers.push(data.user);
                    onlineUsersDetailed.push({
                        name: data.user,
                        uid: data.uid || '',
                        email: data.email || '',
                        username: data.username || ''
                    });
                }
            });

            document.getElementById('userListNames').innerHTML = onlineUsers.length > 0
                ? onlineUsers.map(u => `<div style="padding: 4px 0; cursor: pointer;" onclick="insertMention('${u}')" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">‚Ä¢ ${u} <span style="font-size:10px;opacity:0.6;">(click to @mention)</span></div>`).join('')
                : '<div style="opacity: 0.7;">No users online</div>';
        });

        // Insert @mention into chat input
        function insertMention(username) {
            const input = document.getElementById('chatInput');
            input.value = '@' + username + ' ' + input.value;
            input.focus();
            // Close user list
            document.getElementById('userList').style.display = 'none';
            userListVisible = false;
        }

        // ========== @MENTION AUTOCOMPLETE ==========
        let allRegisteredUsers = [];
        let mentionDropdownIndex = -1;
        const USER_CACHE_KEY = 'bsn9b_users_cache';
        const USER_CACHE_EXPIRY = 10 * 60 * 1000; // 10 minutes

        // Fetch all registered users from Google Sheet (with caching)
        async function fetchAllUsersForMention() {
            try {
                // Check cache first
                const cached = localStorage.getItem(USER_CACHE_KEY);
                if (cached) {
                    const { users, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < USER_CACHE_EXPIRY) {
                        allRegisteredUsers = users;
                        console.log('Loaded', allRegisteredUsers.length, 'users from cache');
                        await loadUserProfiles();
                        addUidsToRegisteredUsers();
                        return;
                    }
                }

                // Fetch fresh data
                const response = await fetch('https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec?action=getUsers');
                const data = await response.json();
                if (data.success && data.users) {
                    // Extract names and filter out empty ones
                    allRegisteredUsers = data.users
                        .filter(u => u.name && u.name.trim())
                        .map(u => ({
                            name: u.name.trim(),
                            firstName: u.name.trim().split(' ')[0],
                            email: u.email || ''
                        }));

                    // Cache the results
                    localStorage.setItem(USER_CACHE_KEY, JSON.stringify({
                        users: allRegisteredUsers,
                        timestamp: Date.now()
                    }));
                    console.log('Loaded', allRegisteredUsers.length, 'users from API, cached');
                    await loadUserProfiles();
                    addUidsToRegisteredUsers();
                }
            } catch (e) {
                console.log('Could not fetch users for @mention:', e);
                // Try to use expired cache as fallback
                const cached = localStorage.getItem(USER_CACHE_KEY);
                if (cached) {
                    allRegisteredUsers = JSON.parse(cached).users || [];
                    console.log('Using expired cache as fallback');
                    await loadUserProfiles();
                    addUidsToRegisteredUsers();
                }
            }
        }

        // Initialize - fetch users on page load
        fetchAllUsersForMention();

        // @Mention autocomplete logic
        const chatInput = document.getElementById('chatInput');
        const mentionDropdown = document.getElementById('mentionDropdown');

        chatInput.addEventListener('input', function(e) {
            const value = this.value;
            const cursorPos = this.selectionStart;

            // Find if we're typing after an @ symbol
            const textBeforeCursor = value.substring(0, cursorPos);
            const atMatch = textBeforeCursor.match(/@(\w*)$/);

            if (atMatch) {
                const searchTerm = atMatch[1].toLowerCase();
                showMentionDropdown(searchTerm);
            } else {
                hideMentionDropdown();
            }
        });

        chatInput.addEventListener('keydown', function(e) {
            if (mentionDropdown.style.display === 'none') return;

            const items = mentionDropdown.querySelectorAll('.mention-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                mentionDropdownIndex = Math.min(mentionDropdownIndex + 1, items.length - 1);
                updateMentionHighlight(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                mentionDropdownIndex = Math.max(mentionDropdownIndex - 1, 0);
                updateMentionHighlight(items);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                if (mentionDropdownIndex >= 0 && items[mentionDropdownIndex]) {
                    e.preventDefault();
                    selectMention(items[mentionDropdownIndex].dataset.name);
                }
            } else if (e.key === 'Escape') {
                hideMentionDropdown();
            }
        });

        function showMentionDropdown(searchTerm) {
            // Combine online users and all registered users, prioritizing online
            const onlineSet = new Set(onlineUsers.map(u => u.toLowerCase()));

            let matches = [];

            // Add online users first (marked as online)
            onlineUsers.forEach(u => {
                if (u.toLowerCase().includes(searchTerm)) {
                    matches.push({ name: u, online: true });
                }
            });

            // Add registered users who aren't online
            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                const fullName = u.name;
                if (!onlineSet.has(firstName.toLowerCase()) &&
                    (firstName.toLowerCase().includes(searchTerm) || fullName.toLowerCase().includes(searchTerm))) {
                    matches.push({ name: firstName, fullName: fullName, online: false });
                }
            });

            // Limit to 8 results
            matches = matches.slice(0, 8);

            if (matches.length === 0) {
                hideMentionDropdown();
                return;
            }

            mentionDropdownIndex = 0;
            mentionDropdown.innerHTML = matches.map((m, i) => `
                <div class="mention-item" data-name="${m.name}"
                     style="padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; ${i === 0 ? 'background: #f0f7ff;' : ''}"
                     onclick="selectMention('${m.name}')"
                     onmouseover="this.style.background='#f0f7ff'"
                     onmouseout="this.style.background='${i === mentionDropdownIndex ? '#f0f7ff' : 'transparent'}'">
                    <span style="font-weight: 500;">@${m.name}${m.fullName && m.fullName !== m.name ? ' <span style="color:#888;font-weight:normal;">(' + m.fullName + ')</span>' : ''}</span>
                    ${m.online ? '<span style="font-size: 10px; background: #22c55e; color: white; padding: 2px 6px; border-radius: 10px;">online</span>' : ''}
                </div>
            `).join('');

            mentionDropdown.style.display = 'block';
        }

        function hideMentionDropdown() {
            mentionDropdown.style.display = 'none';
            mentionDropdownIndex = -1;
        }

        function updateMentionHighlight(items) {
            items.forEach((item, i) => {
                item.style.background = i === mentionDropdownIndex ? '#f0f7ff' : 'transparent';
            });
        }

        function selectMention(name) {
            const input = chatInput;
            const value = input.value;
            const cursorPos = input.selectionStart;

            // Find the @ symbol position
            const textBeforeCursor = value.substring(0, cursorPos);
            const atIndex = textBeforeCursor.lastIndexOf('@');

            if (atIndex !== -1) {
                // Replace @partial with @fullname
                const newValue = value.substring(0, atIndex) + '@' + name + ' ' + value.substring(cursorPos);
                input.value = newValue;

                // Move cursor after the mention
                const newCursorPos = atIndex + name.length + 2;
                input.setSelectionRange(newCursorPos, newCursorPos);
            }

            hideMentionDropdown();
            input.focus();
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!chatInput.contains(e.target) && !mentionDropdown.contains(e.target)) {
                hideMentionDropdown();
            }
        });
    </script>

    <script>
        // Lazy loading utility for export libraries
        const exportLibraries = {
            jspdf: { url: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', loaded: false },
            docx: { url: 'https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js', loaded: false },
            filesaver: { url: 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js', loaded: false }
        };

        function loadExportLibrary(name) {
            return new Promise((resolve, reject) => {
                const lib = exportLibraries[name];
                if (!lib) {
                    reject(new Error(`Unknown library: ${name}`));
                    return;
                }
                if (lib.loaded) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = lib.url;
                script.onload = () => {
                    lib.loaded = true;
                    resolve();
                };
                script.onerror = () => reject(new Error(`Failed to load ${name}`));
                document.head.appendChild(script);
            });
        }

        // Loading state utility for buttons
        function setButtonLoading(button, loading, originalText = null) {
            if (loading) {
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = '<span style="opacity:0.7">Loading...</span>';
                button.classList.add('btn-loading');
                button.disabled = true;
            } else {
                button.innerHTML = originalText || button.dataset.originalText || button.innerHTML;
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }

        let currentNoteType = 'dar';
        let selectedDiagnoses = [];

        // Google Apps Script API URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec';

        // Display current user (use displayName for friendly name)
        if (displayName) {
            document.getElementById('userDisplay').textContent = 'Logged in as: ' + displayName;
        }

        // Logout function
        function logout() {
            endSessionTracking('logout');
            auth.signOut().then(() => {
                localStorage.removeItem('bsn9b_auth');
                localStorage.removeItem('bsn9b_user');
                localStorage.removeItem('bsn9b_displayName');
                localStorage.removeItem('bsn9b_uid');
                clearSessionTracking();
                window.location.href = '/';
            });
        }

        // Lock screen - shows privacy overlay without logging out
        function lockScreen() {
            const overlay = document.getElementById('lockScreenOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        // Unlock screen - hides the privacy overlay
        function unlockScreen() {
            const overlay = document.getElementById('lockScreenOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Persistent login - users stay logged in until they click logout
        // (removed beforeunload auto-logout to enable persistent sessions)

        // Fetch all users from Google Sheet
        async function fetchAllUsers() {
            try {
                const response = await fetch(API_URL + '?action=getUsers');
                const data = await response.json();
                if (data.success) {
                    return data.users;
                }
            } catch (e) {
                console.error('Error fetching users:', e);
            }
            return [];
        }

        // Refresh and display pending users
        async function refreshPendingUsers() {
            const pendingContainer = document.getElementById('pendingUsersList');
            const approvedContainer = document.getElementById('approvedUsersList');

            if (pendingContainer) pendingContainer.innerHTML = '<p style="color: #666; font-style: italic;">Loading...</p>';
            if (approvedContainer) approvedContainer.innerHTML = '<p style="color: #666; font-style: italic;">Loading...</p>';

            const users = await fetchAllUsers();

            const pendingUsers = users.filter(u => u.status === 'pending');
            const approvedUsers = users.filter(u => u.status === 'approved');

            // Render pending users
            if (pendingContainer) {
                if (pendingUsers.length === 0) {
                    pendingContainer.innerHTML = '<p style="color: #666; font-style: italic;">No pending registrations.</p>';
                } else {
                    let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
                    html += '<tr style="background: #ffe0b2;"><th style="padding: 8px; text-align: left;">Name</th><th style="padding: 8px; text-align: left;">Username</th><th style="padding: 8px; text-align: left;">Email</th><th style="padding: 8px; text-align: left;">Date</th><th style="padding: 8px; width: 140px;">Actions</th></tr>';

                    for (const user of pendingUsers) {
                        html += '<tr style="border-bottom: 1px solid #ffcc80;">';
                        html += '<td style="padding: 8px;">' + (user.name || '-') + '</td>';
                        html += '<td style="padding: 8px;"><strong>' + user.username + '</strong></td>';
                        html += '<td style="padding: 8px;">' + (user.email || '-') + '</td>';
                        html += '<td style="padding: 8px;">' + (user.date || '-') + '</td>';
                        html += '<td style="padding: 8px;">';
                        html += '<button onclick="approveUser(\'' + user.username + '\')" style="background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Approve</button>';
                        html += '<button onclick="denyUser(\'' + user.username + '\')" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Deny</button>';
                        html += '</td></tr>';
                    }
                    html += '</table>';
                    pendingContainer.innerHTML = html;
                }
            }

            // Render approved users
            if (approvedContainer) {
                if (approvedUsers.length === 0) {
                    approvedContainer.innerHTML = '<p style="color: #666; font-style: italic;">No approved users yet.</p>';
                } else {
                    let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
                    html += '<tr style="background: #c8e6c9;"><th style="padding: 8px; text-align: left;">Name</th><th style="padding: 8px; text-align: left;">Username</th><th style="padding: 8px; text-align: left;">Email</th><th style="padding: 8px; width: 80px;">Actions</th></tr>';

                    for (const user of approvedUsers) {
                        html += '<tr style="border-bottom: 1px solid #a5d6a7;">';
                        html += '<td style="padding: 8px;">' + (user.name || '-') + '</td>';
                        html += '<td style="padding: 8px;"><strong>' + user.username + '</strong></td>';
                        html += '<td style="padding: 8px;">' + (user.email || '-') + '</td>';
                        html += '<td style="padding: 8px;">';
                        html += '<button onclick="revokeUser(\'' + user.username + '\')" style="background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Revoke</button>';
                        html += '</td></tr>';
                    }
                    html += '</table>';
                    approvedContainer.innerHTML = html;
                }
            }
        }

        // Approve a pending user
        async function approveUser(username) {
            if (!confirm('Approve user "' + username + '"?')) return;

            try {
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    username: username,
                    status: 'approved'
                });
                await fetch(API_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' });
                showToast('User "' + username + '" approved!', 'success');
                setTimeout(refreshPendingUsers, 1000); // Refresh after a short delay
            } catch (e) {
                showToast('Error approving user. Please try again.', 'error');
            }
        }

        // Deny/delete a pending user
        async function denyUser(username) {
            if (!confirm('Deny and remove user "' + username + '"?')) return;

            try {
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    username: username,
                    status: 'denied'
                });
                await fetch(API_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' });
                showToast('User "' + username + '" denied.', 'info');
                setTimeout(refreshPendingUsers, 1000);
            } catch (e) {
                showToast('Error denying user. Please try again.', 'error');
            }
        }

        // Revoke an approved user
        async function revokeUser(username) {
            if (!confirm('Revoke access for "' + username + '"?')) return;

            try {
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    username: username,
                    status: 'revoked'
                });
                await fetch(API_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' });
                showToast('User "' + username + '" access revoked.', 'warning');
                setTimeout(refreshPendingUsers, 1000);
            } catch (e) {
                showToast('Error revoking user. Please try again.', 'error');
            }
        }

        // Add user directly to sheet
        async function addUserToSheet() {
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const password = document.getElementById('newUserPassword').value;

            if (!username || !password) {
                showToast('Please enter at least username and password.', 'warning');
                return;
            }

            try {
                const params = new URLSearchParams({
                    action: 'addUser',
                    username: username,
                    password: password,
                    status: 'approved',
                    name: name,
                    email: ''
                });
                await fetch(API_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' });

                // Clear inputs
                document.getElementById('newUserName').value = '';
                document.getElementById('newUsername').value = '';
                document.getElementById('newUserPassword').value = '';

                showToast('User "' + username + '" added and approved!', 'success');
                setTimeout(refreshPendingUsers, 1000);
            } catch (e) {
                showToast('Error adding user. Please try again.', 'error');
            }
        }

        // Smart Phrases - type shortcut and it auto-expands
        let smartPhrases = {
            // Vital Signs
            '.vs': 'BP: __ | HR: __ | O2: __% | RR: __ | T: __ | Pain: __/10',
            // Neuro
            '.neuro': 'A&Ox4. PERRLA. GCS 15. MAE x4. ',
            '.aox4': 'Alert and oriented x4 (person, place, time, situation). ',
            '.aox3': 'Alert and oriented x3 (person, place, time). ',
            '.perrla': 'PERRLA (Pupils Equal, Round, Reactive to Light and Accommodation). ',
            '.mae': 'MAE x4 (Moving All Extremities). ',
            '.gcs15': 'GCS 15 (E4V5M6). ',
            // Respiratory
            '.resp': 'CTA bilat. No adventitious sounds. Unlabored. O2: __% on __. ',
            '.cta': 'CTA bilat (Clear to Auscultation bilaterally). ',
            '.lungs': 'Lung sounds clear bilaterally, no wheezes, crackles, or rhonchi. ',
            '.sob': 'Patient denies shortness of breath. Respirations unlabored. ',
            // Cardiovascular
            '.cv': 'S1S2 RRR. No murmurs. Pulses 2+ x4. Cap refill <3s. No edema. ',
            '.rrr': 'S1S2 RRR (Regular Rate and Rhythm). No murmurs, rubs, or gallops. ',
            '.pulses': 'Peripheral pulses 2+ bilaterally, cap refill <3 seconds. ',
            '.noedema': 'No peripheral edema noted. ',
            // GI
            '.gi': 'BS active x4 quads. Abdomen soft, NT, ND. Last BM: __. ',
            '.bsax4': 'BS active x4 quadrants. ',
            '.ntnd': 'Non-tender, non-distended. ',
            '.npo': 'Patient NPO. ',
            '.tolerated': 'Diet tolerated without nausea or vomiting. ',
            // GU
            '.gu': 'Voiding without difficulty. Urine clear yellow. ',
            '.fs': 'Foley catheter patent, draining clear yellow urine. Secured to thigh. ',
            '.voidclear': 'Voiding clear yellow urine without difficulty. ',
            // Skin
            '.skin': 'Warm, dry, intact. No breakdown or pressure injuries. ',
            '.wdi': 'Skin warm, dry, intact. ',
            '.turgor': 'Skin turgor elastic, no tenting. ',
            '.ivsite': 'IV site clean, dry, intact. No redness, swelling, or drainage. ',
            // Pain
            '.pain': 'Pain __/10 at __. Quality: __. Duration: __. Interventions: __. ',
            '.pain0': 'Patient denies pain. Pain 0/10. ',
            '.painmed': 'Pain medication administered as ordered. Will reassess in 30-60 min. ',
            // Allergies
            '.nkda': 'NKDA (No Known Drug Allergies). ',
            '.nka': 'NKA (No Known Allergies). ',
            // General Assessment
            '.denies': 'Patient denies pain, nausea, SOB, dizziness, chest pain. ',
            '.wnl': 'Within normal limits. ',
            '.nad': 'No acute distress. ',
            '.wdta': 'Will continue to monitor. Patient tolerated well. No adverse effects noted. ',
            // Interventions
            '.medadmin': 'Medication administered as ordered. Patient tolerated without adverse effects. ',
            '.ivp': 'IV patent, no redness/swelling at site. Flushed with 10mL NS. ',
            '.repos': 'Patient repositioned for comfort and pressure relief. ',
            '.amb': 'Assisted patient with ambulation in hallway. Gait steady, tolerated well. ',
            '.tcdb': 'Encouraged to turn, cough, and deep breathe. ',
            '.is': 'Incentive spirometer use encouraged. Patient demonstrated proper technique. ',
            '.scd': 'SCDs applied and functioning bilaterally. ',
            // Safety
            '.fall': 'Fall precautions in place. Bed in low position. Call light within reach. ',
            '.safe': 'Side rails up x2. Bed alarm on. Call light in reach. Non-skid socks on. ',
            '.idbands': 'ID bands verified x2. Patient confirmed identity. ',
            '.safeenv': 'Safe environment maintained: bed low, locked, call light in reach, side rails x2. ',
            // Communication
            '.mdnotify': 'MD notified of findings. Awaiting orders. ',
            '.neworders': 'New orders received from MD and implemented. ',
            '.handoff': 'Bedside handoff report given to oncoming nurse. ',
            // Education/Discharge
            '.edu': 'Patient educated on __. Patient verbalized understanding. ',
            '.dc': 'Discharge instructions reviewed with patient. Patient verbalized understanding. ',
            '.teachback': 'Patient able to teach back key information. ',
            '.dcteach': 'Discharge teaching completed. Patient/family verbalized understanding of medications, follow-up, and return precautions. '
        };

        // Smart phrase expansion function
        function expandSmartPhrases(e) {
            const textarea = e.target;
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;

            // Look for phrase shortcuts (words starting with .)
            for (const [shortcut, expansion] of Object.entries(smartPhrases)) {
                const regex = new RegExp(shortcut.replace('.', '\\.') + '(?=\\s|$)', 'gi');
                if (regex.test(text)) {
                    textarea.value = text.replace(regex, expansion);
                    // Adjust cursor position
                    const diff = expansion.length - shortcut.length;
                    textarea.selectionStart = textarea.selectionEnd = cursorPos + diff;
                    break;
                }
            }
        }

        // Track last active textarea for vitals insertion
        let lastActiveTextarea = null;
        document.addEventListener('focusin', function(e) {
            if (e.target.tagName === 'TEXTAREA') {
                lastActiveTextarea = e.target;
            }
        });

        // Insert formatted vitals into the last active textarea
        function insertVitals() {
            if (!lastActiveTextarea) {
                showToast('Please click in a text field first, then click "Insert Vitals".', 'warning');
                return;
            }

            const bpSys = document.getElementById('vsBpSys').value.trim();
            const bpDia = document.getElementById('vsBpDia').value.trim();
            const hr = document.getElementById('vsHr').value.trim();
            const rr = document.getElementById('vsRr').value.trim();
            const temp = document.getElementById('vsTemp').value.trim();
            const o2 = document.getElementById('vsO2').value.trim();
            const o2Source = document.getElementById('vsO2Source').value;
            const pain = document.getElementById('vsPain').value.trim();

            // Build vitals string, only include fields that have values
            let parts = [];
            if (bpSys && bpDia) parts.push(`BP ${bpSys}/${bpDia}`);
            if (hr) parts.push(`HR ${hr}`);
            if (rr) parts.push(`RR ${rr}`);
            if (temp) parts.push(`T ${temp}¬∞F`);
            if (o2) parts.push(`O2 ${o2}% ${o2Source}`);
            if (pain) parts.push(`Pain ${pain}/10`);

            if (parts.length === 0) {
                showToast('Please enter at least one vital sign.', 'warning');
                return;
            }

            const vitalsStr = 'VS: ' + parts.join(' | ') + '. ';

            // Insert at cursor position in textarea
            const start = lastActiveTextarea.selectionStart;
            const end = lastActiveTextarea.selectionEnd;
            const text = lastActiveTextarea.value;
            lastActiveTextarea.value = text.substring(0, start) + vitalsStr + text.substring(end);

            // Move cursor to end of inserted text
            lastActiveTextarea.selectionStart = lastActiveTextarea.selectionEnd = start + vitalsStr.length;
            lastActiveTextarea.focus();

            // Clear vitals fields
            document.getElementById('vsBpSys').value = '';
            document.getElementById('vsBpDia').value = '';
            document.getElementById('vsHr').value = '';
            document.getElementById('vsRr').value = '';
            document.getElementById('vsTemp').value = '';
            document.getElementById('vsO2').value = '';
            document.getElementById('vsPain').value = '';
        }

        // Insert formatted medication into the last active textarea
        function insertMedication() {
            if (!lastActiveTextarea) {
                showToast('Please click in a text field first, then click "Insert Med".', 'warning');
                return;
            }

            const name = document.getElementById('medName').value.trim();
            const dose = document.getElementById('medDose').value.trim();
            const freq = document.getElementById('medFreq').value;
            const route = document.getElementById('medRoute').value;
            const site = document.getElementById('medSite').value;
            const time = document.getElementById('medTime').value;
            const indication = document.getElementById('medIndication').value.trim();
            const prnParams = document.getElementById('medPrnParams').value.trim();
            const effect = document.getElementById('medEffect').value.trim();

            if (!name) {
                showToast('Please enter at least a medication name.', 'warning');
                return;
            }

            // Format time to 24hr
            let timeStr = '';
            if (time) {
                timeStr = time.replace(':', '');
            }

            // Build medication string
            let medStr = name;
            if (dose) medStr += ' ' + dose;
            medStr += ' ' + route;
            if (freq) medStr += ' ' + freq;
            if (site) medStr += ' to ' + site;
            if (timeStr) medStr += ' @ ' + timeStr;
            if (indication) medStr += ' for ' + indication;
            if (prnParams) medStr += ' (PRN: ' + prnParams + ')';
            if (effect) medStr += '. Response: ' + effect;
            medStr += '. Patient tolerated without adverse reaction. ';

            // Insert at cursor position in textarea
            const start = lastActiveTextarea.selectionStart;
            const end = lastActiveTextarea.selectionEnd;
            const text = lastActiveTextarea.value;
            lastActiveTextarea.value = text.substring(0, start) + medStr + text.substring(end);

            // Move cursor to end of inserted text
            lastActiveTextarea.selectionStart = lastActiveTextarea.selectionEnd = start + medStr.length;
            lastActiveTextarea.focus();

            // Clear med fields
            document.getElementById('medName').value = '';
            document.getElementById('medDose').value = '';
            document.getElementById('medFreq').value = '';
            document.getElementById('medSite').value = '';
            document.getElementById('medTime').value = '';
            document.getElementById('medIndication').value = '';
            document.getElementById('medPrnParams').value = '';
            document.getElementById('medEffect').value = '';
            // Also hide the dropdown
            document.getElementById('drugDropdown').classList.remove('show');

            if (name) {
                saveMedRecent(name);
                renderMedRecents();
            }
        }

        const MED_RECENTS_KEY = 'bsn9b_med_recents';

        function getMedRecents() {
            try {
                const raw = localStorage.getItem(MED_RECENTS_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                return [];
            }
        }

        function saveMedRecent(name) {
            const recents = getMedRecents().filter(n => n.toLowerCase() !== name.toLowerCase());
            recents.unshift(name);
            localStorage.setItem(MED_RECENTS_KEY, JSON.stringify(recents.slice(0, 8)));
        }

        function renderMedRecents() {
            const container = document.getElementById('medRecents');
            if (!container) return;
            const recents = getMedRecents();
            if (recents.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = recents.map(n =>
                `<button onclick="selectDrug('${n.replace(/'/g, "\\'")}')" style="border: 1px solid #cbd5e1; background: #f8fafc; color: #1f4e79; padding: 3px 8px; border-radius: 999px; font-size: 11px; cursor: pointer;">${n}</button>`
            ).join('');
        }

        // Drug Autocomplete using NIH RxNav API
        let drugSearchTimeout = null;
        const drugDropdown = document.getElementById('drugDropdown');
        const medNameInput = document.getElementById('medName');

        medNameInput.addEventListener('input', function() {
            const query = this.value.trim();

            // Clear previous timeout
            if (drugSearchTimeout) {
                clearTimeout(drugSearchTimeout);
            }

            // Hide dropdown if query is too short
            if (query.length < 2) {
                drugDropdown.classList.remove('show');
                return;
            }

            // Show loading
            drugDropdown.innerHTML = '<div class="drug-loading">Searching...</div>';
            drugDropdown.classList.add('show');

            // Debounce the search (wait 300ms after typing stops)
            drugSearchTimeout = setTimeout(() => {
                searchDrugs(query);
            }, 300);
        });

        async function searchDrugs(query) {
            try {
                // Use drugs endpoint for better brand/generic pairing
                const drugsResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/drugs.json?name=${encodeURIComponent(query)}`);
                const drugsData = await drugsResponse.json();

                let drugMap = new Map(); // Use map to store unique drugs with their info

                // Process drug group data
                if (drugsData.drugGroup && drugsData.drugGroup.conceptGroup) {
                    drugsData.drugGroup.conceptGroup.forEach(group => {
                        if (group.conceptProperties) {
                            group.conceptProperties.forEach(prop => {
                                const name = prop.name;
                                const tty = prop.tty; // IN=ingredient, BN=brand, SBD=branded drug, etc.
                                if (name && !drugMap.has(name.toLowerCase())) {
                                    drugMap.set(name.toLowerCase(), {
                                        name: name,
                                        type: tty === 'BN' ? 'brand' : tty === 'IN' ? 'generic' : 'drug'
                                    });
                                }
                            });
                        }
                    });
                }

                // Also try spelling suggestions for better matching
                const spellResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/spellingsuggestions.json?name=${encodeURIComponent(query)}`);
                const spellData = await spellResponse.json();
                if (spellData.suggestionGroup?.suggestionList?.suggestion) {
                    spellData.suggestionGroup.suggestionList.suggestion.slice(0, 5).forEach(s => {
                        if (!drugMap.has(s.toLowerCase())) {
                            drugMap.set(s.toLowerCase(), { name: s, type: 'drug' });
                        }
                    });
                }

                // Convert to array and clean up
                let suggestions = Array.from(drugMap.values());

                // Sort: exact matches first, then by length
                const queryLower = query.toLowerCase();
                suggestions.sort((a, b) => {
                    const aStartsWith = a.name.toLowerCase().startsWith(queryLower);
                    const bStartsWith = b.name.toLowerCase().startsWith(queryLower);
                    if (aStartsWith && !bStartsWith) return -1;
                    if (!aStartsWith && bStartsWith) return 1;
                    return a.name.length - b.name.length;
                });

                // Limit to 12 results
                suggestions = suggestions.slice(0, 12);

                if (suggestions.length === 0) {
                    drugDropdown.innerHTML = '<div class="drug-loading">No matches found. You can still type manually.</div>';
                } else {
                    drugDropdown.innerHTML = suggestions.map(drug => {
                        const typeLabel = drug.type === 'brand' ? ' <span style="color:#1976d2;font-size:10px;">(Brand)</span>' :
                                         drug.type === 'generic' ? ' <span style="color:#388e3c;font-size:10px;">(Generic)</span>' : '';
                        return `<div class="drug-item" onclick="selectDrug('${drug.name.replace(/'/g, "\\'")}')">${drug.name}${typeLabel}</div>`;
                    }).join('');
                }
                drugDropdown.classList.add('show');
            } catch (error) {
                console.error('Drug search error:', error);
                drugDropdown.innerHTML = '<div class="drug-loading">Search unavailable. Type manually.</div>';
            }
        }

        function selectDrug(drugName) {
            medNameInput.value = drugName;
            drugDropdown.classList.remove('show');
            saveMedRecent(drugName);
            renderMedRecents();
            // Focus the dose field after selecting
            document.getElementById('medDose').focus();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.drug-autocomplete-wrapper')) {
                drugDropdown.classList.remove('show');
            }
        });

        renderMedRecents();

        // Load custom phrases from localStorage and global phrases from Firebase
        function loadCustomPhrases() {
            // Load local custom phrases
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            if (custom) {
                const customPhrases = JSON.parse(custom);
                Object.assign(smartPhrases, customPhrases);
            }

            // Load global phrases from Firebase (admin-managed)
            const globalPhrasesRef = database.ref('globalPhrases');
            globalPhrasesRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const phrase = child.val();
                        smartPhrases[phrase.shortcut] = phrase.text;
                    });
                }
            });
        }

        // Save custom phrases to localStorage
        function saveCustomPhrases() {
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            const customPhrases = custom ? JSON.parse(custom) : {};
            localStorage.setItem('bsn9b_custom_phrases', JSON.stringify(customPhrases));
        }

        // Add a new custom phrase (admin only)
        function addCustomPhrase() {
            let shortcut = document.getElementById('newPhraseShortcut').value.trim().toLowerCase();
            const text = document.getElementById('newPhraseText').value.trim();

            if (!shortcut || !text) {
                showToast('Please enter both a shortcut and expansion text.', 'warning');
                return;
            }

            // Ensure shortcut starts with .
            if (!shortcut.startsWith('.')) {
                shortcut = '.' + shortcut;
            }

            // Add to smartPhrases
            smartPhrases[shortcut] = text;

            // Save to localStorage
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            const customPhrases = custom ? JSON.parse(custom) : {};
            customPhrases[shortcut] = text;
            localStorage.setItem('bsn9b_custom_phrases', JSON.stringify(customPhrases));

            // Clear inputs
            document.getElementById('newPhraseShortcut').value = '';
            document.getElementById('newPhraseText').value = '';

            // Refresh list
            renderCustomPhrases();
            showToast('Smart phrase added: ' + shortcut, 'success');
        }

        // Delete a custom phrase
        function deleteCustomPhrase(shortcut) {
            delete smartPhrases[shortcut];

            const custom = localStorage.getItem('bsn9b_custom_phrases');
            if (custom) {
                const customPhrases = JSON.parse(custom);
                delete customPhrases[shortcut];
                localStorage.setItem('bsn9b_custom_phrases', JSON.stringify(customPhrases));
            }

            renderCustomPhrases();
        }

        // Render custom phrases list
        function renderCustomPhrases() {
            const container = document.getElementById('customPhrasesList');
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            const customPhrases = custom ? JSON.parse(custom) : {};

            if (Object.keys(customPhrases).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No custom phrases added yet.</p>';
                return;
            }

            let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
            html += '<tr style="background: #ffe0b2;"><th style="padding: 8px; text-align: left;">Shortcut</th><th style="padding: 8px; text-align: left;">Expansion</th><th style="padding: 8px; width: 60px;"></th></tr>';

            for (const [shortcut, text] of Object.entries(customPhrases)) {
                html += `<tr style="border-bottom: 1px solid #ffcc80;">
                    <td style="padding: 8px;"><code style="background:#e65100;color:#fff;padding:2px 6px;border-radius:4px;">${shortcut}</code></td>
                    <td style="padding: 8px;">${text.substring(0, 60)}${text.length > 60 ? '...' : ''}</td>
                    <td style="padding: 8px;"><button onclick="deleteCustomPhrase('${shortcut}')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button></td>
                </tr>`;
            }
            html += '</table>';
            container.innerHTML = html;
        }

        // Simple hash for user passwords (same as login page)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Add a new custom user (admin only)
        function addCustomUser() {
            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const password = document.getElementById('newUserPassword').value;

            if (!username || !password) {
                showToast('Please enter both username and password.', 'warning');
                return;
            }

            // Reserved usernames
            const reserved = ['sumner', 'holdenc', 'np', 'instructor', 'admin'];
            if (reserved.includes(username)) {
                showToast('This username is reserved. Please choose a different one.', 'error');
                return;
            }

            // Get existing custom users
            const stored = localStorage.getItem('bsn9b_custom_users');
            const customUsers = stored ? JSON.parse(stored) : {};

            // Add new user with hashed password
            customUsers[username] = { password: simpleHash(password) };
            localStorage.setItem('bsn9b_custom_users', JSON.stringify(customUsers));

            // Clear inputs
            document.getElementById('newUsername').value = '';
            document.getElementById('newUserPassword').value = '';

            renderCustomUsers();
            showToast('User "' + username + '" added successfully!', 'success');
        }

        // Delete a custom user
        function deleteCustomUser(username) {
            if (!confirm('Delete user "' + username + '"?')) return;

            const stored = localStorage.getItem('bsn9b_custom_users');
            if (stored) {
                const customUsers = JSON.parse(stored);
                delete customUsers[username];
                localStorage.setItem('bsn9b_custom_users', JSON.stringify(customUsers));
            }
            renderCustomUsers();
        }

        // Render custom users list
        function renderCustomUsers() {
            const container = document.getElementById('customUsersList');
            if (!container) return;

            const stored = localStorage.getItem('bsn9b_custom_users');
            const customUsers = stored ? JSON.parse(stored) : {};

            if (Object.keys(customUsers).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No custom users added yet.</p>';
                return;
            }

            let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
            html += '<tr style="background: #ffe0b2;"><th style="padding: 8px; text-align: left;">Username</th><th style="padding: 8px; width: 60px;"></th></tr>';

            for (const username of Object.keys(customUsers)) {
                html += '<tr style="border-bottom: 1px solid #ffcc80;">';
                html += '<td style="padding: 8px;"><strong>' + username + '</strong></td>';
                html += '<td style="padding: 8px;"><button onclick="deleteCustomUser(\'' + username + '\')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button></td>';
                html += '</tr>';
            }
            html += '</table>';
            container.innerHTML = html;
        }

        // Attach smart phrase listener to all textareas on load
        document.addEventListener('DOMContentLoaded', function() {
            // Load custom phrases
            loadCustomPhrases();

            // Attach listeners
            document.querySelectorAll('textarea').forEach(ta => {
                ta.addEventListener('input', expandSmartPhrases);
            });

            });

        // NANDA Database
        const nandaDatabase = [
            // Activity/Rest
            {name: "Activity intolerance", category: "Activity/Rest", def: "Insufficient physiological or psychological energy to endure or complete daily activities"},
            {name: "Activity intolerance, risk for", category: "Activity/Rest", def: "At risk for insufficient energy to complete daily activities"},
            {name: "Fatigue", category: "Activity/Rest", def: "Overwhelming sustained sense of exhaustion and decreased capacity for work"},
            {name: "Insomnia", category: "Activity/Rest", def: "Disruption in amount and quality of sleep that impairs functioning"},
            {name: "Mobility: physical, impaired", category: "Activity/Rest", def: "Limitation in independent, purposeful physical movement"},
            {name: "Mobility: bed, impaired", category: "Activity/Rest", def: "Limitation of independent movement from one bed position to another"},
            {name: "Sleep deprivation", category: "Activity/Rest", def: "Prolonged periods without sleep"},
            {name: "Sleep pattern disturbed", category: "Activity/Rest", def: "Time-limited interruptions of sleep amount and quality"},
            {name: "Walking, impaired", category: "Activity/Rest", def: "Limitation of independent movement within environment on foot"},
            // Circulation
            {name: "Bleeding, risk for", category: "Circulation", def: "At risk for decrease in blood volume that may compromise health"},
            {name: "Cardiac output, decreased", category: "Circulation", def: "Inadequate blood pumped by heart to meet metabolic demands"},
            {name: "Tissue perfusion, ineffective peripheral", category: "Circulation", def: "Decrease in blood circulation to peripheries that may compromise health"},
            {name: "Tissue perfusion, ineffective cerebral, risk for", category: "Circulation", def: "Risk for decrease in cerebral tissue circulation"},
            {name: "Shock, risk for", category: "Circulation", def: "At risk for inadequate blood flow to body tissues"},
            // Ego Integrity
            {name: "Anxiety", category: "Ego Integrity", def: "Vague uneasy feeling of discomfort or dread with autonomic response"},
            {name: "Anxiety, death", category: "Ego Integrity", def: "Vague uneasy feeling generated by perceptions of threat to existence"},
            {name: "Body image, disturbed", category: "Ego Integrity", def: "Confusion in mental picture of one's physical self"},
            {name: "Coping, ineffective", category: "Ego Integrity", def: "Inability to form valid appraisal of stressors or access resources"},
            {name: "Fear", category: "Ego Integrity", def: "Response to perceived threat consciously recognized as danger"},
            {name: "Grieving", category: "Ego Integrity", def: "Normal complex process incorporating actual or anticipated loss"},
            {name: "Grieving, complicated", category: "Ego Integrity", def: "Disorder where bereavement distress manifests in functional impairment"},
            {name: "Hopelessness", category: "Ego Integrity", def: "State where individual sees limited alternatives and unable to mobilize energy"},
            {name: "Powerlessness", category: "Ego Integrity", def: "Perception that one's actions will not significantly affect outcome"},
            {name: "Self-esteem, chronic low", category: "Ego Integrity", def: "Long-standing negative self-evaluation/feelings about self"},
            {name: "Self-esteem, situational low", category: "Ego Integrity", def: "Development of negative perception of self-worth in response to situation"},
            // Elimination
            {name: "Bowel incontinence", category: "Elimination", def: "Change in bowel habits characterized by involuntary passage of stool"},
            {name: "Constipation", category: "Elimination", def: "Decrease in frequency of defecation with difficult or incomplete passage"},
            {name: "Constipation, risk for", category: "Elimination", def: "At risk for decrease in normal frequency of defecation"},
            {name: "Diarrhea", category: "Elimination", def: "Passage of loose, unformed stools"},
            {name: "Urinary elimination, impaired", category: "Elimination", def: "Disturbance in urine elimination"},
            {name: "Urinary incontinence, functional", category: "Elimination", def: "Inability to reach toilet in time to avoid unintentional loss of urine"},
            {name: "Urinary incontinence, stress", category: "Elimination", def: "Sudden leakage with activities that increase intra-abdominal pressure"},
            {name: "Urinary incontinence, urge", category: "Elimination", def: "Involuntary passage soon after strong sense of urgency"},
            {name: "Urinary retention", category: "Elimination", def: "Incomplete emptying of the bladder"},
            // Food/Fluid
            {name: "Fluid volume, deficient", category: "Food/Fluid", def: "Decreased intravascular, interstitial and/or intracellular fluid"},
            {name: "Fluid volume, deficient, risk for", category: "Food/Fluid", def: "At risk for vascular, cellular, or intracellular dehydration"},
            {name: "Fluid volume, excess", category: "Food/Fluid", def: "Increased isotonic fluid retention"},
            {name: "Electrolyte imbalance, risk for", category: "Food/Fluid", def: "At risk for change in serum electrolyte levels"},
            {name: "Nutrition: imbalanced, less than body requirements", category: "Food/Fluid", def: "Intake of nutrients insufficient to meet metabolic needs"},
            {name: "Nutrition: imbalanced, more than body requirements", category: "Food/Fluid", def: "Intake of nutrients that exceeds metabolic needs"},
            {name: "Nausea", category: "Food/Fluid", def: "Subjective unpleasant wave-like sensation that may lead to vomiting"},
            {name: "Swallowing, impaired", category: "Food/Fluid", def: "Abnormal functioning of swallowing mechanism"},
            // Neurosensory
            {name: "Confusion, acute", category: "Neurosensory", def: "Abrupt onset of reversible disturbances of consciousness and cognition"},
            {name: "Confusion, chronic", category: "Neurosensory", def: "Irreversible progressive deterioration of intellect and personality"},
            {name: "Communication, impaired verbal", category: "Neurosensory", def: "Decreased ability to receive, process, transmit, and use symbols"},
            {name: "Memory, impaired", category: "Neurosensory", def: "Inability to remember or recall bits of information"},
            {name: "Sensory perception, disturbed", category: "Neurosensory", def: "Change in amount or patterning of incoming stimuli"},
            // Pain/Discomfort
            {name: "Pain, acute", category: "Pain/Discomfort", def: "Unpleasant sensory experience from actual or potential tissue damage, <6 months"},
            {name: "Pain, chronic", category: "Pain/Discomfort", def: "Unpleasant sensory experience without predictable end, >6 months"},
            {name: "Comfort, impaired", category: "Pain/Discomfort", def: "Perceived lack of ease, relief in physical/psychospiritual dimensions"},
            // Respiration
            {name: "Airway clearance, ineffective", category: "Respiration", def: "Inability to clear secretions or obstructions from respiratory tract"},
            {name: "Aspiration, risk for", category: "Respiration", def: "At risk for entry of secretions into tracheobronchial passages"},
            {name: "Breathing pattern, ineffective", category: "Respiration", def: "Inspiration/expiration that does not provide adequate ventilation"},
            {name: "Gas exchange, impaired", category: "Respiration", def: "Excess or deficit in oxygenation at alveolar-capillary membrane"},
            // Safety
            {name: "Falls, risk for", category: "Safety", def: "Increased susceptibility to falling that may cause physical harm"},
            {name: "Infection, risk for", category: "Safety", def: "At increased risk for being invaded by pathogenic organisms"},
            {name: "Injury, risk for", category: "Safety", def: "At risk of injury from environmental conditions"},
            {name: "Skin integrity, impaired", category: "Safety", def: "Altered epidermis and/or dermis"},
            {name: "Skin integrity, impaired, risk for", category: "Safety", def: "At risk for skin being adversely altered"},
            {name: "Hypothermia", category: "Safety", def: "Body temperature below normal range"},
            {name: "Hyperthermia", category: "Safety", def: "Body temperature elevated above normal range"},
            {name: "Trauma, risk for", category: "Safety", def: "Accentuated risk of accidental tissue injury"},
            // Hygiene
            {name: "Self-care deficit, bathing", category: "Hygiene", def: "Impaired ability to perform bathing activities"},
            {name: "Self-care deficit, dressing", category: "Hygiene", def: "Impaired ability to perform dressing activities"},
            {name: "Self-care deficit, feeding", category: "Hygiene", def: "Impaired ability to perform feeding activities"},
            {name: "Self-care deficit, toileting", category: "Hygiene", def: "Impaired ability to perform toileting activities"},
            // Knowledge
            {name: "Knowledge deficient", category: "Health Promotion", def: "Absence of cognitive information related to specific topic"},
            {name: "Noncompliance", category: "Health Promotion", def: "Behavior that fails to coincide with therapeutic plan"}
        ];

        // Date/Time Shortcut Functions
        function showDateShortcut() {
            const dateInput = document.getElementById('noteDate');
            const textInput = document.getElementById('noteDateText');
            textInput.style.display = 'block';
            dateInput.style.display = 'none';
            textInput.value = '';
            textInput.focus();
            textInput.addEventListener('blur', processDateShortcut);
            textInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    processDateShortcut();
                }
            });
        }

        function hideDateShortcut() {
            // This is called but we process in processDateShortcut
        }

        function processDateShortcut() {
            const textInput = document.getElementById('noteDateText');
            const dateInput = document.getElementById('noteDate');
            const val = textInput.value.trim().toUpperCase();

            if (val) {
                const today = new Date();
                let targetDate = today;

                if (val === 'T' || val === 'TODAY') {
                    targetDate = today;
                } else if (val.match(/^T\s*[\+\-]\s*\d+$/)) {
                    const match = val.match(/^T\s*([\+\-])\s*(\d+)$/);
                    const sign = match[1] === '+' ? 1 : -1;
                    const days = parseInt(match[2]);
                    targetDate = new Date(today);
                    targetDate.setDate(today.getDate() + (sign * days));
                }

                // Format as YYYY-MM-DD for input
                const year = targetDate.getFullYear();
                const month = String(targetDate.getMonth() + 1).padStart(2, '0');
                const day = String(targetDate.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            }

            textInput.style.display = 'none';
            dateInput.style.display = 'block';
            textInput.removeEventListener('blur', processDateShortcut);
        }

        function showTimeShortcut() {
            const timeInput = document.getElementById('noteTime');
            const textInput = document.getElementById('noteTimeText');
            textInput.style.display = 'block';
            timeInput.style.display = 'none';
            textInput.value = '';
            textInput.focus();
            textInput.addEventListener('blur', processTimeShortcut);
            textInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    processTimeShortcut();
                }
            });
        }

        function hideTimeShortcut() {
            // This is called but we process in processTimeShortcut
        }

        function processTimeShortcut() {
            const textInput = document.getElementById('noteTimeText');
            const timeInput = document.getElementById('noteTime');
            const val = textInput.value.trim().toUpperCase();

            if (val) {
                const now = new Date();
                let targetTime = now;

                if (val === 'N' || val === 'NOW') {
                    targetTime = now;
                } else if (val.match(/^N\s*[\+\-]\s*\d+$/)) {
                    const match = val.match(/^N\s*([\+\-])\s*(\d+)$/);
                    const sign = match[1] === '+' ? 1 : -1;
                    const minutes = parseInt(match[2]);
                    targetTime = new Date(now);
                    targetTime.setMinutes(now.getMinutes() + (sign * minutes));
                }

                // Format as HH:MM for input
                const hours = String(targetTime.getHours()).padStart(2, '0');
                const mins = String(targetTime.getMinutes()).padStart(2, '0');
                timeInput.value = `${hours}:${mins}`;
            }

            textInput.style.display = 'none';
            timeInput.style.display = 'block';
            textInput.removeEventListener('blur', processTimeShortcut);
        }

        // Med Time shortcuts (same logic as note time)
        function showMedTimeShortcut() {
            const timeInput = document.getElementById('medTime');
            const textInput = document.getElementById('medTimeText');
            textInput.style.display = 'block';
            timeInput.style.display = 'none';
            textInput.value = '';
            textInput.focus();
            textInput.addEventListener('blur', processMedTimeShortcut);
            textInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    processMedTimeShortcut();
                }
            });
        }

        function hideMedTimeShortcut() {
            // Handled in processMedTimeShortcut
        }

        function processMedTimeShortcut() {
            const textInput = document.getElementById('medTimeText');
            const timeInput = document.getElementById('medTime');
            const val = textInput.value.trim().toUpperCase();

            if (val) {
                const now = new Date();
                let targetTime = now;

                if (val === 'N' || val === 'NOW') {
                    targetTime = now;
                } else if (val.match(/^N\s*[\+\-]\s*\d+$/)) {
                    const match = val.match(/^N\s*([\+\-])\s*(\d+)$/);
                    const sign = match[1] === '+' ? 1 : -1;
                    const minutes = parseInt(match[2]);
                    targetTime = new Date(now);
                    targetTime.setMinutes(now.getMinutes() + (sign * minutes));
                }

                const hours = String(targetTime.getHours()).padStart(2, '0');
                const mins = String(targetTime.getMinutes()).padStart(2, '0');
                timeInput.value = `${hours}:${mins}`;
            }

            textInput.style.display = 'none';
            timeInput.style.display = 'block';
            textInput.removeEventListener('blur', processMedTimeShortcut);
        }

        // Toggle collapsible panels
        function togglePanel(panelId, headerEl) {
            const panel = document.getElementById(panelId);
            const arrow = headerEl.querySelector('h3 span');
            const isHidden = panel.style.display === 'none';

            if (isHidden) {
                panel.style.display = 'block';
                if (arrow) arrow.textContent = '‚ñº';
            } else {
                panel.style.display = 'none';
                if (arrow) arrow.textContent = '‚ñ∂';
            }
        }

        // Initialize
        document.getElementById('noteDate').valueAsDate = new Date();
        document.getElementById('noteTime').value = new Date().toTimeString().slice(0, 5);
        const storedName = localStorage.getItem('bsn9b_displayName');
        const nurseNameInput = document.getElementById('nurseName');
        if (nurseNameInput && storedName && !nurseNameInput.value) {
            nurseNameInput.value = storedName;
        }
        setNoteType(currentNoteType);
        setupAutoSave();
        loadDraft(currentNoteType);
        startSessionHeartbeat();
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') updateSessionHeartbeat();
        });

        function setNoteType(type, cardEl = null) {
            currentNoteType = type;
            document.querySelectorAll('.note-type-card').forEach(c => c.classList.remove('active'));
            const targetCard = cardEl || document.querySelector(`.note-type-card[onclick*="${type}"]`);
            if (targetCard) targetCard.classList.add('active');
            document.querySelectorAll('.note-fields').forEach(f => f.classList.remove('active'));
            const fields = document.getElementById(type + 'Fields');
            if (fields) fields.classList.add('active');
            document.getElementById('focusGroup').style.display = ['dar', 'darp'].includes(type) ? 'block' : 'none';
            updateSectionJumpList();
        }

        function selectNoteType(type) {
            saveDraft();
            setNoteType(type, event.target.closest('.note-type-card'));
            loadDraft(type);
        }

        const NOTE_SECTIONS = {
            dar: [
                { id: 'darData', label: 'Data' },
                { id: 'darAction', label: 'Action' },
                { id: 'darResponse', label: 'Response' }
            ],
            darp: [
                { id: 'darpData', label: 'Data' },
                { id: 'darpAction', label: 'Action' },
                { id: 'darpResponse', label: 'Response' },
                { id: 'darpPlan', label: 'Plan' }
            ],
            soap: [
                { id: 'soapSubjective', label: 'Subjective' },
                { id: 'soapObjective', label: 'Objective' },
                { id: 'soapAssessment', label: 'Assessment' },
                { id: 'soapPlan', label: 'Plan' }
            ],
            soapie: [
                { id: 'soapieSubjective', label: 'Subjective' },
                { id: 'soapieObjective', label: 'Objective' },
                { id: 'soapieAssessment', label: 'Assessment' },
                { id: 'soapiePlan', label: 'Plan' },
                { id: 'soapieIntervention', label: 'Intervention' },
                { id: 'soapieEvaluation', label: 'Evaluation' }
            ],
            sbar: [
                { id: 'sbarSituation', label: 'Situation' },
                { id: 'sbarBackground', label: 'Background' },
                { id: 'sbarAssessment', label: 'Assessment' },
                { id: 'sbarRecommendation', label: 'Recommendation' }
            ],
            pie: [
                { id: 'pieProblem', label: 'Problem' },
                { id: 'pieIntervention', label: 'Intervention' },
                { id: 'pieEvaluation', label: 'Evaluation' }
            ],
            narrative: [
                { id: 'narrativeText', label: 'Narrative' }
            ],
            h2t: [
                { id: 'h2tNeuro', label: 'Neuro' },
                { id: 'h2tCardio', label: 'Cardio' },
                { id: 'h2tResp', label: 'Resp' },
                { id: 'h2tGI', label: 'GI' },
                { id: 'h2tGU', label: 'GU' },
                { id: 'h2tSkin', label: 'Skin' },
                { id: 'h2tMSK', label: 'MSK' },
                { id: 'h2tPain', label: 'Pain' },
                { id: 'h2tMental', label: 'Mental' },
                { id: 'h2tSafety', label: 'Safety' },
                { id: 'h2tLines', label: 'Lines/Drains' },
                { id: 'h2tPsych', label: 'Psych' }
            ]
        };

        function toggleSectionJump() {
            const panel = document.getElementById('sectionJumpPanel');
            if (!panel) return;
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function updateSectionJumpList() {
            const panel = document.getElementById('sectionJumpPanel');
            if (!panel) return;
            const sections = NOTE_SECTIONS[currentNoteType] || [];
            panel.innerHTML = sections.map(s => `<div class="section-jump-item" onclick="scrollToSection('${s.id}')">${s.label}</div>`).join('');
        }

        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            const panel = document.getElementById('sectionJumpPanel');
            if (panel) panel.style.display = 'none';
        }

        document.addEventListener('click', (e) => {
            const panel = document.getElementById('sectionJumpPanel');
            const btn = document.getElementById('sectionJumpBtn');
            if (panel && btn && panel.style.display === 'block' && !panel.contains(e.target) && e.target !== btn) {
                panel.style.display = 'none';
            }
        });

        const DRAFT_PREFIX = 'bsn9b_draft_';
        const AUTOSAVE_DELAY = 800;
        let autosaveTimer = null;

        function collectDraftFields() {
            const container = document.querySelector('.form-container');
            if (!container) return {};
            const data = {};
            container.querySelectorAll('input, textarea, select').forEach(el => {
                if (!el.id) return;
                if (el.type === 'checkbox' || el.type === 'radio') {
                    data[el.id] = el.checked;
                } else {
                    data[el.id] = el.value;
                }
            });
            return data;
        }

        function updateAutoSaveStatus(text) {
            const el = document.getElementById('autoSaveStatus');
            const mobile = document.getElementById('mobileActionStatus');
            if (el) el.textContent = text;
            if (mobile) mobile.textContent = text;
        }

        function saveDraft() {
            try {
                const key = DRAFT_PREFIX + currentNoteType;
                const payload = {
                    noteType: currentNoteType,
                    timestamp: Date.now(),
                    fields: collectDraftFields()
                };
                localStorage.setItem(key, JSON.stringify(payload));
                const time = new Date(payload.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                updateAutoSaveStatus('Draft saved ' + time);
            } catch (e) {
                console.warn('Autosave failed:', e);
            }
        }

        function loadDraft(type) {
            try {
                const key = DRAFT_PREFIX + type;
                const raw = localStorage.getItem(key);
                if (!raw) {
                    updateAutoSaveStatus('Draft not saved');
                    return;
                }
                const payload = JSON.parse(raw);
                if (!payload || !payload.fields) return;
                Object.keys(payload.fields).forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = !!payload.fields[id];
                    } else {
                        el.value = payload.fields[id];
                    }
                });
                updatePhq9Score();
                updateGad7Score();
                const time = new Date(payload.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                updateAutoSaveStatus('Draft restored ' + time);
            } catch (e) {
                console.warn('Draft load failed:', e);
            }
        }

        function scheduleAutoSave() {
            updateAutoSaveStatus('Saving...');
            clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(saveDraft, AUTOSAVE_DELAY);
        }

        function setupAutoSave() {
            const container = document.querySelector('.form-container');
            if (!container) return;
            container.querySelectorAll('input, textarea, select').forEach(el => {
                if (!el.id) return;
                el.addEventListener('input', scheduleAutoSave);
                el.addEventListener('change', scheduleAutoSave);
            });
        }

        function clearDraft(type) {
            try { localStorage.removeItem(DRAFT_PREFIX + type); } catch (e) {}
        }

        // Debounce utility for search functions (reduces CPU usage)
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function searchNandaImpl() {
            const query = document.getElementById('nandaSearch').value.toLowerCase();
            const dropdown = document.getElementById('nandaDropdown');
            if (query.length < 2) { dropdown.classList.remove('show'); return; }
            const results = nandaDatabase.filter(d =>
                d.name.toLowerCase().includes(query) ||
                d.category.toLowerCase().includes(query) ||
                d.def.toLowerCase().includes(query)
            ).slice(0, 10);
            if (results.length === 0) { dropdown.classList.remove('show'); return; }
            dropdown.innerHTML = results.map(d =>
                `<div class="nanda-item" onclick="addDiagnosis('${d.name.replace(/'/g, "\\'")}')">
                    <div class="category">${d.category}</div>
                    <div>${d.name}</div>
                </div>`
            ).join('');
            dropdown.classList.add('show');
        }

        // Debounced version (300ms delay for better performance)
        const searchNanda = debounce(searchNandaImpl, 300);

        function addDiagnosis(name) {
            if (!selectedDiagnoses.includes(name)) {
                selectedDiagnoses.push(name);
                renderDiagnoses();
            }
            document.getElementById('nandaSearch').value = '';
            document.getElementById('nandaDropdown').classList.remove('show');
        }

        function removeDiagnosis(name) {
            selectedDiagnoses = selectedDiagnoses.filter(d => d !== name);
            renderDiagnoses();
        }

        function renderDiagnoses() {
            document.getElementById('selectedDiagnoses').innerHTML = selectedDiagnoses.map(d =>
                `<div class="diagnosis-tag">${d}<span class="remove" onclick="removeDiagnosis('${d.replace(/'/g, "\\'")}')">&times;</span></div>`
            ).join('');
        }

        function appendToField(fieldId, text) {
            const field = document.getElementById(fieldId);
            field.value += text;
            field.focus();
        }

        function getSelectValue(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            const val = parseInt(el.value || '0', 10);
            return Number.isFinite(val) ? val : 0;
        }

        function hasScreeningResponses(prefix, count) {
            for (let i = 1; i <= count; i++) {
                const el = document.getElementById(prefix + i);
                if (el && el.value && el.value !== '0') return true;
            }
            return false;
        }

        function getPhq9Total() {
            let total = 0;
            for (let i = 1; i <= 9; i++) total += getSelectValue('phq' + i);
            return total;
        }

        function getGad7Total() {
            let total = 0;
            for (let i = 1; i <= 7; i++) total += getSelectValue('gad' + i);
            return total;
        }

        function getPhq9Severity(score) {
            if (score >= 20) return 'Severe';
            if (score >= 15) return 'Moderately severe';
            if (score >= 10) return 'Moderate';
            if (score >= 5) return 'Mild';
            return 'Minimal';
        }

        function getGad7Severity(score) {
            if (score >= 15) return 'Severe';
            if (score >= 10) return 'Moderate';
            if (score >= 5) return 'Mild';
            return 'Minimal';
        }

        function updatePhq9Score() {
            const total = getPhq9Total();
            const el = document.getElementById('phq9Score');
            if (el) el.textContent = total;
            return total;
        }

        function updateGad7Score() {
            const total = getGad7Total();
            const el = document.getElementById('gad7Score');
            if (el) el.textContent = total;
            return total;
        }

        function getScreeningSummary() {
            const hasPhq = hasScreeningResponses('phq', 9);
            const hasGad = hasScreeningResponses('gad', 7);
            if (!hasPhq && !hasGad) return '';
            const lines = [];
            if (hasPhq) {
                const phq = getPhq9Total();
                lines.push(`PHQ-9 Total: ${phq} (${getPhq9Severity(phq)})`);
            }
            if (hasGad) {
                const gad = getGad7Total();
                lines.push(`GAD-7 Total: ${gad} (${getGad7Severity(gad)})`);
            }
            return lines.join('\n');
        }

        function insertMentalHealthSummary() {
            const mental = (document.getElementById('h2tMental') || {}).value || '';
            const safety = (document.getElementById('h2tSafety') || {}).value || '';
            const screening = getScreeningSummary();
            const lines = [];
            if (mental.trim()) lines.push(`Mental status: ${mental.trim()}`);
            if (safety.trim()) lines.push(`Safety/Risk: ${safety.trim()}`);
            if (screening) lines.push(`Screening: ${screening}`);
            if (lines.length === 0) {
                showToast('Add mental status or screening scores first.', 'warning');
                return;
            }
            const target = document.getElementById('h2tPsych');
            if (!target) return;
            const existing = target.value.trim();
            target.value = existing ? `${existing}\n${lines.join('\n')}` : lines.join('\n');
            target.focus();
        }

        function clearForm() {
            if (!confirm('Clear all fields?')) return;
            document.querySelectorAll('input:not([type="date"]):not([type="time"]), textarea').forEach(el => el.value = '');
            document.getElementById('noteDate').valueAsDate = new Date();
            document.getElementById('noteTime').value = new Date().toTimeString().slice(0, 5);
            selectedDiagnoses = [];
            renderDiagnoses();
        }

        function formatTimeForFilename(t) { return t ? t.replace(':', '') : ''; }

        function getFormData() {
            return {
                nurseName: document.getElementById('nurseName').value || 'N/A',
                credentials: document.getElementById('credentials').value,
                noteDate: new Date(document.getElementById('noteDate').value + 'T00:00:00').toLocaleDateString('en-US', {month:'numeric',day:'numeric',year:'2-digit'}),
                noteTime: formatTimeForFilename(document.getElementById('noteTime').value),
                unit: document.getElementById('unit').value || '',
                patientId: document.getElementById('patientId').value || 'N/A',
                patientDemo: document.getElementById('patientDemo').value || '',
                focus: document.getElementById('focus').value || ''
            };
        }

        function getNoteContent() {
            const c = [], t = currentNoteType;
            if (t === 'dar') {
                c.push({l:'D',t:'Data',x:document.getElementById('darData').value});
                c.push({l:'A',t:'Action',x:document.getElementById('darAction').value});
                c.push({l:'R',t:'Response/Recommendations',x:document.getElementById('darResponse').value});
            } else if (t === 'darp') {
                c.push({l:'D',t:'Data',x:document.getElementById('darpData').value});
                c.push({l:'A',t:'Action',x:document.getElementById('darpAction').value});
                c.push({l:'R',t:'Response/Recommendations',x:document.getElementById('darpResponse').value});
                c.push({l:'P',t:'Plan',x:document.getElementById('darpPlan').value});
            } else if (t === 'soap') {
                c.push({l:'S',t:'Subjective',x:document.getElementById('soapSubjective').value});
                c.push({l:'O',t:'Objective',x:document.getElementById('soapObjective').value});
                c.push({l:'A',t:'Assessment',x:document.getElementById('soapAssessment').value});
                c.push({l:'P',t:'Plan',x:document.getElementById('soapPlan').value});
            } else if (t === 'soapie') {
                c.push({l:'S',t:'Subjective',x:document.getElementById('soapieSubjective').value});
                c.push({l:'O',t:'Objective',x:document.getElementById('soapieObjective').value});
                c.push({l:'A',t:'Assessment',x:document.getElementById('soapieAssessment').value});
                c.push({l:'P',t:'Plan',x:document.getElementById('soapiePlan').value});
                c.push({l:'I',t:'Intervention',x:document.getElementById('soapieIntervention').value});
                c.push({l:'E',t:'Evaluation',x:document.getElementById('soapieEvaluation').value});
            } else if (t === 'sbar') {
                c.push({l:'S',t:'Situation',x:document.getElementById('sbarSituation').value});
                c.push({l:'B',t:'Background',x:document.getElementById('sbarBackground').value});
                c.push({l:'A',t:'Assessment',x:document.getElementById('sbarAssessment').value});
                c.push({l:'R',t:'Recommendation',x:document.getElementById('sbarRecommendation').value});
            } else if (t === 'pie') {
                c.push({l:'P',t:'Problem',x:document.getElementById('pieProblem').value});
                c.push({l:'I',t:'Intervention',x:document.getElementById('pieIntervention').value});
                c.push({l:'E',t:'Evaluation',x:document.getElementById('pieEvaluation').value});
            } else if (t === 'narrative') {
                c.push({l:'',t:'Narrative',x:document.getElementById('narrativeText').value});
            } else if (t === 'h2t') {
                c.push({l:'',t:'Neurological',x:document.getElementById('h2tNeuro').value});
                c.push({l:'',t:'Cardiovascular',x:document.getElementById('h2tCardio').value});
                c.push({l:'',t:'Respiratory',x:document.getElementById('h2tResp').value});
                c.push({l:'',t:'Gastrointestinal',x:document.getElementById('h2tGI').value});
                c.push({l:'',t:'Genitourinary',x:document.getElementById('h2tGU').value});
                c.push({l:'',t:'Skin/Integumentary',x:document.getElementById('h2tSkin').value});
                c.push({l:'',t:'Musculoskeletal',x:document.getElementById('h2tMSK').value});
                c.push({l:'',t:'Pain/Comfort',x:document.getElementById('h2tPain').value});
                c.push({l:'',t:'Mental Status',x:document.getElementById('h2tMental').value});
                c.push({l:'',t:'Safety/Risk',x:document.getElementById('h2tSafety').value});
                c.push({l:'',t:'Lines/Drains/Airway',x:document.getElementById('h2tLines').value});
                const screeningSummary = getScreeningSummary();
                if (screeningSummary) {
                    c.push({l:'',t:'Mental Health Screening',x:screeningSummary});
                }
                c.push({l:'',t:'Psychosocial/Notes',x:document.getElementById('h2tPsych').value});
            }
            return c.filter(i => i.x);
        }

        function buildNoteText() {
            const d = getFormData();
            const nc = getNoteContent();
            if (nc.length === 0) return '';
            const tn = {dar:'DAR',darp:'DARP',soap:'SOAP',soapie:'SOAPIE',sbar:'SBAR',pie:'PIE',h2t:'Head-to-Toe',narrative:'Narrative'};
            let out = [];
            out.push(`Note Type: ${tn[currentNoteType] || currentNoteType}`);
            out.push(`Nurse: ${d.nurseName} ${d.credentials || ''}`.trim());
            out.push(`Date: ${d.noteDate}  Time: ${d.noteTime}`);
            if (d.unit) out.push(`Unit: ${d.unit}`);
            if (d.patientId) out.push(`Patient: ${d.patientId}`);
            if (d.patientDemo) out.push(`Demographics: ${d.patientDemo}`);
            if (d.focus && ['dar','darp'].includes(currentNoteType)) out.push(`Focus: ${d.focus}`);
            out.push('');
            nc.forEach(item => {
                const label = item.l ? `${item.l} - ${item.t}` : item.t;
                out.push(label + ':');
                out.push(item.x);
                out.push('');
            });
            return out.join('\n').trim();
        }

        async function copyNoteToClipboard() {
            const text = buildNoteText();
            if (!text) {
                showToast('Add content before copying.', 'warning');
                return;
            }
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                }
                showToast('Copied to clipboard.', 'success');
            } catch (e) {
                console.error('Copy failed:', e);
                showToast('Copy failed. Try manual select.', 'error');
            }
        }

        async function generatePDF(btn) {
            if (btn) setButtonLoading(btn, true);
            try {
                // Lazy load jsPDF library
                await loadExportLibrary('jspdf');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
            const pw = doc.internal.pageSize.getWidth();
            const m = 18;
            const cw = pw - m*2;
            let y = 15;
            const d = getFormData();
            const nc = getNoteContent();
            const tn = {dar:'DAR',darp:'DARP',soap:'SOAP',soapie:'SOAPIE',sbar:'SBAR',pie:'PIE',h2t:'Head-to-Toe Assessment',narrative:'Narrative Note'};

            // Header
            doc.setFillColor(31, 78, 121);
            doc.rect(0, 0, pw, 28, 'F');
            doc.setTextColor(255);
            doc.setFontSize(18);
            doc.setFont('helvetica','bold');
            doc.text('Sumner College - Bend Nursing Progress Note', pw/2, 12, {align:'center'});
            doc.setFontSize(11);
            doc.setFont('helvetica','normal');
            doc.text(tn[currentNoteType], pw/2, 22, {align:'center'});

            y = 36;
            doc.setTextColor(0);

            // Info box
            doc.setFillColor(248, 250, 252);
            doc.setDrawColor(31, 78, 121);
            doc.setLineWidth(0.3);
            doc.roundedRect(m, y, cw, 24, 2, 2, 'FD');
            doc.setFontSize(9);
            y += 8;
            doc.setFont('helvetica','bold');
            doc.text('Nurse:', m+4, y);
            doc.setFont('helvetica','normal');
            doc.text(`${d.nurseName}, ${d.credentials}`, m+18, y);
            doc.setFont('helvetica','bold');
            doc.text('Date/Time:', m+85, y);
            doc.setFont('helvetica','normal');
            doc.text(`${d.noteDate} @ ${d.noteTime}`, m+108, y);
            y += 8;
            doc.setFont('helvetica','bold');
            doc.text('Patient:', m+4, y);
            doc.setFont('helvetica','normal');
            doc.text(d.patientDemo ? `${d.patientId} (${d.patientDemo})` : d.patientId, m+22, y);
            if(d.unit){doc.setFont('helvetica','bold');doc.text('Unit:',m+85,y);doc.setFont('helvetica','normal');doc.text(d.unit,m+98,y);}
            y += 14;

            // NANDA diagnoses
            if (selectedDiagnoses.length > 0) {
                doc.setFillColor(240, 249, 255);
                doc.setDrawColor(31, 78, 121);
                const dxText = 'Nursing Dx: ' + selectedDiagnoses.join('; ');
                const dxLines = doc.splitTextToSize(dxText, cw - 8);
                const dxH = 8 + dxLines.length * 4;
                doc.roundedRect(m, y, cw, dxH, 2, 2, 'FD');
                doc.setFontSize(9);
                doc.setTextColor(31, 78, 121);
                doc.setFont('helvetica','normal');
                let dy = y + 6;
                dxLines.forEach(line => { doc.text(line, m + 4, dy); dy += 4; });
                y += dxH + 4;
                doc.setTextColor(0);
            }

            // Focus
            if (['dar','darp'].includes(currentNoteType) && d.focus) {
                doc.setFillColor(31, 78, 121);
                doc.roundedRect(m, y, cw, 10, 2, 2, 'F');
                doc.setTextColor(255);
                doc.setFontSize(10);
                doc.setFont('helvetica','bold');
                doc.text('FOCUS: ' + d.focus, m + 4, y + 7);
                y += 14;
                doc.setTextColor(0);
            }

            // Content
            nc.forEach(s => {
                const lines = doc.splitTextToSize(s.x, cw - 4);
                const sh = 12 + lines.length * 4.5;
                if (y + sh > 280) { doc.addPage(); y = 15; }

                // Section header - inline bold label
                doc.setFontSize(10);
                doc.setFont('helvetica','bold');
                doc.setTextColor(31, 78, 121);
                const label = s.l ? (s.l + ' - ' + s.t + ':') : (s.t + ':');
                doc.text(label, m, y + 5);

                y += 9;
                doc.setFont('helvetica','normal');
                doc.setFontSize(9);
                doc.setTextColor(50);
                lines.forEach(line => {
                    if (y > 280) { doc.addPage(); y = 15; }
                    doc.text(line, m + 2, y);
                    y += 4.5;
                });
                y += 4;
            });

            // Signature
            y += 8;
            if (y > 265) { doc.addPage(); y = 15; }
            doc.setDrawColor(180);
            doc.setLineWidth(0.2);
            doc.line(m, y, m + 70, y);
            doc.setFontSize(9);
            doc.setTextColor(0);
            doc.text(`${d.nurseName}, ${d.credentials}`, m, y + 6);
            doc.text(`${d.noteDate} @ ${d.noteTime}`, m, y + 11);

            // Disclaimer
            doc.setFontSize(7);
            doc.setTextColor(140);
            doc.text('*Patient demographics are simulated for educational purposes. No real patient information.', pw/2, 290, {align:'center'});

            // Get last name from nurse name (last word)
            const nameParts = d.nurseName.trim().split(' ');
            const lastName = nameParts[nameParts.length - 1] || 'Student';
            doc.save(`${document.getElementById('noteDate').value}_${d.noteTime}_${currentNoteType.toUpperCase()}_${lastName}.pdf`);
            } catch(e) {
                console.error('PDF export error:', e);
                showToast('Error generating PDF: ' + e.message, 'error');
            } finally {
                if (btn) setButtonLoading(btn, false);
            }
        }

        async function generateWord(btn) {
            if (btn) setButtonLoading(btn, true);
            try {
                // Lazy load docx and FileSaver libraries
                await Promise.all([
                    loadExportLibrary('docx'),
                    loadExportLibrary('filesaver')
                ]);

                const d = getFormData();
                const nc = getNoteContent();
                const tn = {dar:'DAR',darp:'DARP',soap:'SOAP',soapie:'SOAPIE',sbar:'SBAR',pie:'PIE',h2t:'Head-to-Toe Assessment',narrative:'Narrative Note'};

                const { Document, Packer, Paragraph, TextRun, AlignmentType } = docx;
                const ch = [];

                // Title
                ch.push(new Paragraph({
                    children: [new TextRun({text: 'Sumner College - Bend Nursing Progress Note', bold: true, size: 32, color: '1f4e79'})],
                    alignment: AlignmentType.CENTER,
                    spacing: {after: 100}
                }));

                // Note type
                ch.push(new Paragraph({
                    children: [new TextRun({text: tn[currentNoteType], size: 22, color: '1f4e79'})],
                    alignment: AlignmentType.CENTER,
                    spacing: {after: 200}
                }));

                // Nurse and date info
                ch.push(new Paragraph({
                    children: [
                        new TextRun({text: 'Nurse: ', bold: true}),
                        new TextRun(d.nurseName + ', ' + d.credentials),
                        new TextRun({text: '    Date/Time: ', bold: true}),
                        new TextRun(d.noteDate + ' @ ' + d.noteTime)
                    ],
                    spacing: {after: 80}
                }));

                // Patient info
                const patientChildren = [
                    new TextRun({text: 'Patient: ', bold: true}),
                    new TextRun(d.patientDemo ? d.patientId + ' (' + d.patientDemo + ')' : d.patientId)
                ];
                if (d.unit) {
                    patientChildren.push(new TextRun({text: '    Unit: ', bold: true}));
                    patientChildren.push(new TextRun(d.unit));
                }
                ch.push(new Paragraph({children: patientChildren, spacing: {after: 150}}));

                // NANDA diagnoses
                if (selectedDiagnoses.length > 0) {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: 'Nursing Dx: ' + selectedDiagnoses.join('; '), color: '1f4e79'})],
                        spacing: {after: 150}
                    }));
                }

                // Focus (for DAR/DARP)
                if (['dar','darp'].includes(currentNoteType) && d.focus) {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: 'FOCUS: ' + d.focus, bold: true, color: '1f4e79'})],
                        spacing: {after: 150}
                    }));
                }

                // Note content
                nc.forEach(s => {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: (s.l ? s.l + ' - ' : '') + s.t, bold: true, size: 22, color: '1f4e79'})],
                        spacing: {before: 150, after: 80}
                    }));
                    ch.push(new Paragraph({
                        children: [new TextRun(s.x)],
                        spacing: {after: 120}
                    }));
                });

                // Disclaimer
                ch.push(new Paragraph({text: '', spacing: {before: 200}}));
                ch.push(new Paragraph({
                    children: [new TextRun({text: '*Patient demographics are simulated for educational purposes. No real patient information.', italics: true, size: 18, color: '666666'})],
                    spacing: {after: 200}
                }));

                // Signature line
                ch.push(new Paragraph({children: [new TextRun('________________________________')]}));
                ch.push(new Paragraph({children: [new TextRun(d.nurseName + ', ' + d.credentials)], spacing: {after: 40}}));
                ch.push(new Paragraph({children: [new TextRun(d.noteDate + ' @ ' + d.noteTime)]}));

                const doc = new Document({sections: [{children: ch}]});
                const blob = await Packer.toBlob(doc);
                // Get last name from nurse name (last word)
                const nameParts = d.nurseName.trim().split(' ');
                const lastName = nameParts[nameParts.length - 1] || 'Student';
                saveAs(blob, document.getElementById('noteDate').value + '_' + d.noteTime + '_' + currentNoteType.toUpperCase() + '_' + lastName + '.docx');

            } catch(e) {
                console.error('Word export error:', e);
                showToast('Error generating Word document: ' + e.message + '. Please try PDF export instead.', 'error');
            } finally {
                if (btn) setButtonLoading(btn, false);
            }
        }

        document.addEventListener('click', e => {
            if (!e.target.closest('.nanda-search')) document.getElementById('nandaDropdown').classList.remove('show');
        });

        // ========== FIREBASE LISTENER CLEANUP ==========
        function cleanupFirebaseListeners() {
            try {
                if (typeof announcementsRef !== 'undefined') announcementsRef.off();
                if (typeof bannedRef !== 'undefined') bannedRef.off();
                if (typeof chatRef !== 'undefined') chatRef.off();
                if (typeof connectedRef !== 'undefined') connectedRef.off();
                if (typeof directMessagesRef !== 'undefined') directMessagesRef.off();
                if (typeof presenceRef !== 'undefined') presenceRef.off();
                console.log('Firebase listeners cleaned up');
            } catch (e) {
                console.log('Error cleaning up listeners:', e);
            }
        }

        window.addEventListener('beforeunload', cleanupFirebaseListeners);
        window.addEventListener('pagehide', cleanupFirebaseListeners);

        // ========== KEYBOARD NAVIGATION ==========
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close modals
                document.querySelectorAll('.modal:not(.hidden)').forEach(m => m.classList.add('hidden'));
                // Close more menu
                const moreMenu = document.getElementById('moreMenu');
                if (moreMenu) moreMenu.classList.remove('show');
                // Close chat box
                const chatBox = document.getElementById('chatBox');
                if (chatBox && chatBox.style.display !== 'none') {
                    chatBox.style.display = 'none';
                    chatOpen = false;
                }
                // Close NANDA dropdown
                const nandaDropdown = document.getElementById('nandaDropdown');
                if (nandaDropdown) nandaDropdown.classList.remove('show');
            }
        });

        // ========== SWIPE GESTURES FOR MOBILE ==========
        (function() {
            let touchStartX = 0;
            let touchStartY = 0;
            const SWIPE_THRESHOLD = 80;
            const SWIPE_RESTRAINT = 100;

            function addSwipeToClose(element, closeCallback, direction) {
                if (!element) return;

                element.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                }, { passive: true });

                element.addEventListener('touchend', function(e) {
                    const touchEndX = e.changedTouches[0].screenX;
                    const touchEndY = e.changedTouches[0].screenY;
                    const diffX = touchEndX - touchStartX;
                    const diffY = touchEndY - touchStartY;

                    // Swipe down to close (for all panels)
                    if (diffY > SWIPE_THRESHOLD && Math.abs(diffX) < SWIPE_RESTRAINT) {
                        closeCallback();
                        return;
                    }

                    // Horizontal swipe
                    if (Math.abs(diffX) > SWIPE_THRESHOLD && Math.abs(diffY) < SWIPE_RESTRAINT) {
                        if (direction === 'right' && diffX > 0) closeCallback();
                        if (direction === 'left' && diffX < 0) closeCallback();
                    }
                }, { passive: true });
            }

            // Chat box: swipe right or down to close (on right side of screen)
            addSwipeToClose(document.getElementById('chatBox'), function() {
                if (chatOpen) toggleChat();
            }, 'right');

            // AI box: swipe left or down to close (on left side of screen)
            addSwipeToClose(document.getElementById('aiBox'), function() {
                if (aiOpen) toggleAI();
            }, 'left');
        })();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
