<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>if(location.protocol !== 'https:' && location.hostname !== 'localhost'){location.replace('https:' + location.href.substring(location.protocol.length));}</script>
    <script>
        if (localStorage.getItem('bsn9b_auth') !== 'true') {
            window.location.href = '/';
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#1f4e79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSN9B">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <!-- Preconnect hints for faster external resource loading -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <title>BSN9B - Home</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-page: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #fafafa;
            --bg-input: #fafafa;
            --text-primary: #1a1a2e;
            --text-secondary: #666666;
            --accent: #1f4e79;
            --accent-light: #2d5a87;
            --shadow: rgba(0,0,0,0.4);
            --border: #e0e0e0;
            --chat-msg-other-bg: #e2e8f0;
        }

        [data-theme="dark"] {
            --bg-page: linear-gradient(135deg, #0a0a14 0%, #0d1117 50%, #161b22 100%);
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #1e2a3a;
            --bg-input: #16213e;
            --text-primary: #e6e6e6;
            --text-secondary: #aaaaaa;
            --accent: #4a90d9;
            --accent-light: #5a9fe8;
            --shadow: rgba(0,0,0,0.6);
            --border: #2d3748;
            --chat-msg-other-bg: #2d3748;
        }

        /* Status indicator colors for presence */
        .status-online { background: #22c55e; }  /* Green */
        .status-away { background: #eab308; }    /* Yellow */
        .status-offline { background: #6b7280; } /* Gray */

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-page);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            text-align: center;
            max-width: 800px;
            width: 100%;
        }

        .logo {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .title {
            font-size: 48px;
            color: white;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 18px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 50px;
        }

        .welcome {
            font-size: 20px;
            color: rgba(255,255,255,0.9);
            margin-bottom: 40px;
        }

        .nav-buttons {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-card {
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 40px 50px;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px var(--shadow);
            min-width: 250px;
        }

        .nav-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 60px var(--shadow);
        }

        .nav-card .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .nav-card .label {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .nav-card .description {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 10px;
            transition: color 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .toolbar-item:hover { color: var(--accent); }
        .toolbar-item.active { color: var(--accent); }
        .toolbar-item .icon { font-size: 24px; margin-bottom: 2px; }
        .toolbar-item .label { font-weight: 600; }

        /* More Menu */
        .more-menu {
            position: fixed;
            bottom: 70px;
            right: 10px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 8px 0;
            display: none;
            z-index: 1001;
            min-width: 160px;
            border: 1px solid var(--border);
        }

        .more-menu.show { display: block; }

        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
        }

        .more-menu-item:hover { background: var(--bg-secondary); }
        .more-menu-item .menu-icon { font-size: 18px; }

        /* Adjust body padding for toolbar */
        body {
            padding-bottom: 80px;
        }

        /* Dark mode specific */
        [data-theme="dark"] .nav-card {
            background: var(--bg-primary);
        }

        /* Dark mode chat widget styles */
        [data-theme="dark"] #chatBox {
            background: var(--bg-primary) !important;
        }
        [data-theme="dark"] #chatSidebar {
            background: linear-gradient(180deg, #0a0a14 0%, #0d1117 100%) !important;
        }
        [data-theme="dark"] #chatContentHeader {
            background: var(--bg-secondary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #chatTitle {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #chatMessages,
        [data-theme="dark"] #dmMessages,
        [data-theme="dark"] #dmConversationList {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #chatInput,
        [data-theme="dark"] #dmInput {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #mentionDropdown {
            background: var(--bg-primary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #dmHeader,
        [data-theme="dark"] #newDMSelector > div:first-child {
            background: var(--bg-tertiary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #dmHeader span,
        [data-theme="dark"] #newDMSelector span {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #dmPartnerStatus {
            background: var(--bg-secondary) !important;
            color: var(--text-secondary) !important;
        }
        [data-theme="dark"] #createChannelModal > div {
            background: var(--bg-primary) !important;
        }
        [data-theme="dark"] #createChannelModal h3 {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #newChannelName {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }

        /* Feedback Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.hidden { display: none; }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            color: var(--text-primary);
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .modal-content textarea { min-height: 120px; resize: vertical; }

        /* Lock Screen */
        #lockScreenOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 99999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* Focus visible styles for keyboard navigation */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        button:focus-visible, a:focus-visible, .nav-card:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* ========== MOBILE RESPONSIVE STYLES ========== */

        /* Smooth scrolling */
        html { scroll-behavior: smooth; }

        /* Touch-friendly scrolling */
        #chatMessages, #dmMessages, #aiMessages {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* Minimum touch target size (44px) */
        @media (pointer: coarse) {
            button, .btn, .toolbar-item, .more-menu-item, .nav-card {
                min-height: 44px;
            }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .title { font-size: 36px; }
            .nav-buttons { flex-direction: column; align-items: center; }
            .nav-card { min-width: 200px; padding: 30px 40px; min-height: 80px; }
        }

        /* Mobile Chat/AI Widget - Full Screen Overlay */
        @media (max-width: 768px) {
            body {
                padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
            }

            #chatBox, #aiBox {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-height: none !important;
                border-radius: 0 !important;
                z-index: 10000 !important;
                padding-top: env(safe-area-inset-top, 0px);
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            #chatWidget, #aiWidget {
                bottom: 70px !important;
            }

            #chatToggle, #aiToggle {
                width: 54px !important;
                height: 54px !important;
            }

            /* Chat sidebar narrower on mobile */
            #chatSidebar {
                width: 110px !important;
            }

            /* Create channel modal adjustments */
            #createChannelModal > div {
                width: calc(100vw - 40px) !important;
                max-width: 300px;
            }

            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }
        }

        /* Small phones */
        @media (max-width: 480px) {
            .title { font-size: 28px; }
            .nav-card { padding: 25px 35px; }

            /* Prevent iOS zoom on input focus */
            input, select, textarea {
                font-size: 16px !important;
            }
        }

        /* Landscape orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .container { padding: 20px; }
            .title { font-size: 24px; margin-bottom: 15px; }
            .bottom-toolbar { height: 50px; }
            .toolbar-item .label { display: none; }
        }

        /* Safe area insets for bottom toolbar */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(60px + env(safe-area-inset-bottom));
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 380px;
        }
        .toast {
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: toastSlideIn 0.3s ease;
            color: white;
            font-size: 14px;
            line-height: 1.4;
        }
        .toast.hiding { animation: toastSlideOut 0.3s ease forwards; }
        .toast-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .toast-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .toast-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .toast-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .toast-icon { font-size: 18px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-message { opacity: 0.95; }
        .toast-close { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; font-size: 18px; padding: 0; line-height: 1; }
        .toast-close:hover { opacity: 1; }
        @keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @media (max-width: 480px) { .toast-container { left: 10px; right: 10px; max-width: none; } }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Alert/FYI Banners - Fixed at top -->
    <div id="alertBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 10000; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5); animation: softFlashAlert 2s ease-in-out infinite;">
        <span id="alertText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.8;">‚ö†Ô∏è ALERT</span>
    </div>
    <div id="fyiBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a1a2e; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 9999; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); animation: softFlashFyi 2s ease-in-out infinite;">
        <span id="fyiText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.7;">‚ÑπÔ∏è FYI</span>
    </div>
    <style>
        @keyframes softFlashAlert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        @keyframes softFlashFyi {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        body.has-alert { padding-top: 50px; }
        body.has-fyi { padding-top: 50px; }
        body.has-alert.has-fyi { padding-top: 100px; }
    </style>

    <!-- Lock Screen Overlay -->
    <div id="lockScreenOverlay">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px;">üîí</div>
            <h1 style="font-size: 42px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">BSN9B</h1>
            <p style="font-size: 18px; opacity: 0.8; margin-bottom: 40px;">Portal Locked</p>
            <button onclick="unlockScreen()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 18px 50px; border-radius: 30px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);">
                üîì Unlock Portal
            </button>
            <p style="margin-top: 30px; font-size: 12px; opacity: 0.5;">Click unlock to return to your session</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="logo">üè•</div>
        <h1 class="title">BSN9B</h1>
        <p class="subtitle">Nursing Documentation Portal</p>
        <p class="welcome" id="welcomeMessage">Welcome back!</p>

        <div class="nav-buttons">
            <a href="/app/" class="nav-card">
                <div class="icon">üìù</div>
                <div class="label">Note Generator</div>
                <div class="description">Create nursing documentation with DAR, SOAP, and other formats</div>
            </a>

            <a href="/resources/" class="nav-card">
                <div class="icon">üìö</div>
                <div class="label">Resources</div>
                <div class="description">Access nursing references, guides, and study materials</div>
            </a>
        </div>
    </div>

    <!-- Bottom Toolbar -->
    <nav class="bottom-toolbar" role="navigation" aria-label="Main navigation">
        <a href="/home/" class="toolbar-item active" aria-label="Home" aria-current="page">
            <span class="icon" aria-hidden="true">üè†</span>
            <span class="label">Home</span>
        </a>
        <a href="/app/" class="toolbar-item" aria-label="RN Notes documentation generator">
            <span class="icon" aria-hidden="true">üìù</span>
            <span class="label">RN Notes</span>
        </a>
        <a href="/community/" class="toolbar-item" aria-label="Community hub">
            <span class="icon" aria-hidden="true">üë•</span>
            <span class="label">Community</span>
        </a>
        <a href="/resources/" class="toolbar-item" aria-label="Nursing resources">
            <span class="icon" aria-hidden="true">üìö</span>
            <span class="label">Resources</span>
        </a>
        <button class="toolbar-item" onclick="toggleMoreMenu()" aria-label="More options" aria-expanded="false" aria-controls="moreMenu">
            <span class="icon" aria-hidden="true">‚ãØ</span>
            <span class="label">More</span>
        </button>
    </nav>

    <!-- More Menu -->
    <div id="moreMenu" class="more-menu" role="menu" aria-label="More options menu">
        <button class="more-menu-item" onclick="toggleDarkMode(); toggleMoreMenu();" role="menuitem" aria-label="Toggle dark mode">
            <span class="menu-icon" id="themeMenuIcon" aria-hidden="true">üåô</span>
            <span id="themeMenuText">Dark Mode</span>
        </button>
        <button class="more-menu-item" onclick="lockScreen(); toggleMoreMenu();" role="menuitem" aria-label="Lock screen">
            <span class="menu-icon" aria-hidden="true">üîí</span>
            <span>Lock Screen</span>
        </button>
        <button class="more-menu-item" onclick="toggleFullscreen(); toggleMoreMenu();" role="menuitem" aria-label="Toggle full screen" id="fullscreenBtn">
            <span class="menu-icon" aria-hidden="true" id="fullscreenIcon">‚õ∂</span>
            <span id="fullscreenText">Full Screen</span>
        </button>
        <a href="/labsched/" class="more-menu-item" role="menuitem" aria-label="Lab Schedule Generator" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">üìÖ</span>
            <span>Sched Generator</span>
        </a>
        <a href="/apa/" class="more-menu-item" role="menuitem" aria-label="APA Paper Generator" id="apaMenuLink" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">üìÑ</span>
            <span>APA Generator</span>
        </a>
        <button class="more-menu-item" onclick="document.getElementById('feedbackModal').classList.remove('hidden'); toggleMoreMenu();" role="menuitem" aria-label="Send feedback">
            <span class="menu-icon" aria-hidden="true">üí°</span>
            <span>Feedback</span>
        </button>
        <button class="more-menu-item" onclick="logout();" role="menuitem" aria-label="Logout">
            <span class="menu-icon" aria-hidden="true">üö™</span>
            <span>Logout</span>
        </button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="feedbackModalTitle">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 20px;">üí° Send Feedback</h2>
                <button onclick="document.getElementById('feedbackModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
            </div>
            <form action="https://formsubmit.co/christiankholden@gmail.com" method="POST">
                <input type="hidden" name="_subject" value="BSN9B Feedback">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_template" value="table">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Type</label>
                <select name="type" required>
                    <option value="bug">üêõ Bug Report</option>
                    <option value="feature">‚ú® Feature Request</option>
                    <option value="phrase">üí¨ New Phrase Suggestion</option>
                    <option value="feedback" selected>üìù General Feedback</option>
                </select>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Your Name</label>
                <input type="text" name="name" required placeholder="Enter your name">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Message</label>
                <textarea name="message" required placeholder="Describe your feedback..."></textarea>
                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Send Feedback</button>
            </form>
        </div>
    </div>

    <!-- Peer Chat Widget - Slack-Style Redesign -->
    <div id="chatWidget" style="position: fixed; bottom: 80px; right: 20px; z-index: 999; font-family: 'Segoe UI', sans-serif;">
        <!-- Chat Toggle Button -->
        <button id="chatToggle" onclick="toggleChat()" aria-label="Open chat" aria-expanded="false" aria-controls="chatBox" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 24px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;">
            <span aria-hidden="true">üí¨</span>
        </button>
        <span id="chatBadge" aria-live="polite" style="display: none; position: absolute; top: -5px; right: -5px; background: #e94560; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center;">0</span>
        <!-- DM Badge (separate from group chat) -->
        <span id="dmBadge" aria-live="polite" style="display: none; position: absolute; top: -5px; left: -5px; background: #8b5cf6; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center;">0</span>

        <!-- Chat Box - Slack Style with Sidebar -->
        <div id="chatBox" role="dialog" aria-label="Chat window" aria-modal="false" style="display: none; flex-direction: row; position: absolute; bottom: 70px; right: 0; width: 480px; height: 520px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden;">

            <!-- Left Sidebar - Channel/DM List -->
            <div id="chatSidebar" style="width: 140px; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); display: flex; flex-direction: column; flex-shrink: 0;">
                <!-- Sidebar Header -->
                <div style="padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-weight: 700; font-size: 13px;">BSN9B Chat</span>
                        <div style="display: flex; gap: 4px;">
                            <button id="soundToggleBtn" onclick="toggleChatSound()" aria-label="Toggle sound" style="background: none; border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 12px; padding: 2px;">üîî</button>
                            <button onclick="toggleChat()" aria-label="Close chat" style="background: none; border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 14px; padding: 2px;">√ó</button>
                        </div>
                    </div>
                    <div id="onlineCount" onclick="toggleUserList()" style="font-size: 10px; color: rgba(255,255,255,0.6); cursor: pointer; margin-top: 4px;">Connecting...</div>
                </div>

                <!-- Channels Section -->
                <div style="flex: 1; overflow-y: auto; padding: 8px 0;">
                    <!-- Channels Header -->
                    <div onclick="toggleChannelsSection()" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; cursor: pointer;">
                        <span style="color: rgba(255,255,255,0.7); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                            <span id="channelsExpandIcon" style="font-size: 8px; margin-right: 4px;">‚ñº</span>Channels
                        </span>
                        <button id="createChannelBtn" onclick="event.stopPropagation(); createChannelModal()" title="Create channel" style="background: none; border: none; color: rgba(255,255,255,0.5); font-size: 14px; cursor: pointer; padding: 0 4px; display: none;">+</button>
                    </div>
                    <!-- Channel List -->
                    <div id="channelList" style="padding: 0 6px;"></div>

                    <!-- Direct Messages Header -->
                    <div onclick="toggleDMSection()" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; margin-top: 8px; cursor: pointer;">
                        <span style="color: rgba(255,255,255,0.7); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                            <span id="dmExpandIcon" style="font-size: 8px; margin-right: 4px;">‚ñº</span>Direct Messages
                        </span>
                        <button onclick="event.stopPropagation(); showNewDMSelector()" title="New message" style="background: none; border: none; color: rgba(255,255,255,0.5); font-size: 14px; cursor: pointer; padding: 0 4px;">+</button>
                    </div>
                    <!-- DM List -->
                    <div id="dmSidebarList" style="padding: 0 6px;"></div>
                </div>

                <!-- Online Users (toggleable) -->
                <div id="userList" style="display: none; background: rgba(0,0,0,0.3); padding: 8px; font-size: 11px; max-height: 80px; overflow-y: auto; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="color: rgba(255,255,255,0.6); margin-bottom: 4px;">Online:</div>
                    <div id="userListNames" style="color: rgba(255,255,255,0.8);"></div>
                </div>
            </div>

            <!-- Right Content Area -->
            <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
                <!-- Content Header -->
                <div id="chatContentHeader" style="background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 10px 14px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div id="chatTitle" style="font-weight: 700; font-size: 14px; color: #1a1a2e;"># general</div>
                        <div id="chatSubtitle" style="font-size: 11px; color: #888; display: none;"></div>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button id="notificationToggleBtn" onclick="toggleBrowserNotifications()" aria-label="Toggle browser notifications" style="background: #e2e8f0; border: none; color: #666; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 12px;">üìµ</button>
                        <button id="deleteChannelBtn" onclick="deleteChannel()" title="Delete channel" style="background: #fee2e2; border: none; color: #dc2626; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 12px; display: none;">üóë</button>
                    </div>
                </div>

                <!-- GROUP CHAT VIEW -->
                <div id="groupChatView" role="tabpanel" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                    <!-- Chat Messages -->
                    <div id="chatMessages" role="log" aria-live="polite" aria-label="Chat messages" style="flex: 1; overflow-y: auto; padding: 12px; background: #ffffff;">
                        <p style="text-align: center; color: #888; font-size: 12px;">Loading messages...</p>
                    </div>

                    <!-- Chat Input -->
                    <div style="padding: 10px 12px; border-top: 1px solid #e2e8f0; background: #f8fafc; position: relative;">
                        <!-- @Mention Autocomplete Dropdown -->
                        <div id="mentionDropdown" role="listbox" aria-label="Mention suggestions" style="display: none; position: absolute; bottom: 100%; left: 12px; right: 60px; background: white; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 -4px 15px rgba(0,0,0,0.15); max-height: 150px; overflow-y: auto; z-index: 100;"></div>
                        <form onsubmit="sendMessage(event)" style="display: flex; gap: 8px;">
                            <input type="text" id="chatInput" aria-label="Chat message input" placeholder="Message #general" style="flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; outline: none; background: white;" maxlength="500" autocomplete="off">
                            <button type="submit" aria-label="Send message" style="background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 14px;"><span aria-hidden="true">‚û§</span></button>
                        </form>
                    </div>
                </div>

                <!-- DM VIEW -->
                <div id="dmView" role="tabpanel" style="flex: 1; display: none; flex-direction: column; overflow: hidden;">
                    <!-- DM Conversation List (shows when no conversation selected) -->
                    <div id="dmConversationList" style="flex: 1; overflow-y: auto; padding: 15px; background: #ffffff;">
                        <div style="margin-bottom: 15px;">
                            <button onclick="showNewDMSelector()" aria-label="Start new direct message" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                <span aria-hidden="true">‚úèÔ∏è</span> New Message
                            </button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <button onclick="runDMSelfTest()" aria-label="Run DM self test" style="width: 100%; padding: 10px; background: #f1f5f9; color: #1f4e79; border: 1px dashed #cbd5e1; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                DM Self-Test (safe)
                            </button>
                        </div>
                        <div id="dmConversations" style="color: #888; font-size: 12px; text-align: center;">
                            Loading conversations...
                        </div>
                    </div>

                    <!-- DM Messages View (shows when conversation selected) -->
                    <div id="dmMessageView" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                        <!-- DM Header with back button -->
                        <div id="dmHeader" style="padding: 10px 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px;">
                            <button onclick="closeDMConversation()" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px;">‚Üê</button>
                            <span id="dmPartnerName" style="font-weight: 600; color: #1f4e79;">Partner Name</span>
                            <span id="dmPartnerStatus" style="font-size: 10px; padding: 2px 8px; border-radius: 10px; background: #e2e8f0; color: #666;">offline</span>
                        </div>
                        <!-- DM Messages -->
                        <div id="dmMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #ffffff;">
                        </div>
                        <!-- DM Input -->
                        <div style="padding: 10px 12px; border-top: 1px solid #e2e8f0; background: #f8fafc;">
                            <form onsubmit="sendDM(event)" style="display: flex; gap: 8px;">
                                <input type="text" id="dmInput" placeholder="Type a message..." style="flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; outline: none; background: white;" maxlength="500" autocomplete="off">
                                <button type="submit" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 14px;">‚û§</button>
                            </form>
                        </div>
                    </div>

                    <!-- New DM User Selector -->
                    <div id="newDMSelector" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                        <div style="padding: 10px 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px;">
                            <button onclick="hideNewDMSelector()" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px;">‚Üê</button>
                            <span style="font-weight: 600; color: #1f4e79;">New Message</span>
                        </div>
                        <div style="padding: 15px;">
                            <input type="text" id="dmUserSearch" placeholder="Search users..." oninput="filterDMUsers()" style="width: 100%; padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; margin-bottom: 15px;">
                        </div>
                        <div id="dmUserList" style="flex: 1; overflow-y: auto; padding: 0 15px 15px 15px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Channel Modal -->
        <div id="createChannelModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 20px; width: 300px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <h3 style="margin: 0 0 15px; font-size: 16px; color: #1a1a2e;">Create Channel</h3>
                <input type="text" id="newChannelName" placeholder="e.g., meds, clinical, nclex" style="width: 100%; padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; margin-bottom: 15px;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeCreateChannelModal()" style="flex: 1; padding: 10px; background: #e2e8f0; color: #666; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
                    <button onclick="submitCreateChannel()" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Widget -->
    <div id="aiWidget" style="position: fixed; bottom: 80px; left: 20px; z-index: 999;">
        <button id="aiToggle" onclick="toggleAI()" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); border: none; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 24px; display: flex; align-items: center; justify-content: center; position: relative;">
            ü©∫
            <span style="position: absolute; top: -2px; left: -2px; background: #8b5cf6; color: white; border-radius: 4px; padding: 2px 5px; font-size: 9px; font-weight: bold;">AI</span>
        </button>

        <div id="aiBox" style="display: none; flex-direction: column; position: absolute; bottom: 70px; left: 0; width: 380px; height: 500px; background: var(--bg-primary); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden;">
            <div style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 700;">ü©∫ AI Nursing Assistant</span>
                <button onclick="toggleAI()" style="background: none; border: none; color: white; cursor: pointer; font-size: 18px;">&times;</button>
            </div>
            <div style="background: #fef3c7; padding: 8px 12px; font-size: 11px; color: #92400e;">
                ‚ö†Ô∏è <strong>Educational Only:</strong> Not medical advice. Always verify with clinical resources.
            </div>
            <div style="padding: 10px; display: flex; gap: 6px; flex-wrap: wrap; border-bottom: 1px solid var(--border);">
                <button onclick="aiQuickAction('drug')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">üíä Drug Info</button>
                <button onclick="aiQuickAction('careplan')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">üìã Care Plan</button>
                <button onclick="aiQuickAction('nclex')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">üìù NCLEX Q</button>
                <button onclick="aiQuickAction('labs')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">üî¨ Labs</button>
            </div>
            <div id="aiMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: var(--bg-secondary);">
                <div style="background: var(--chat-msg-other-bg); padding: 10px 14px; border-radius: 16px; margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">
                    Hi! I'm your AI nursing assistant. Ask me about medications, care plans, NCLEX questions, or lab values. How can I help you today?
                </div>
            </div>
            <form onsubmit="sendAIMessage(event)" style="padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; background: var(--bg-primary);">
                <input type="text" id="aiInput" placeholder="Ask a nursing question..." style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 20px; font-size: 14px; background: var(--bg-input); color: var(--text-primary);">
                <button type="submit" style="background: linear-gradient(135deg, #0d9488, #14b8a6); color: white; border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer;">Ask</button>
            </form>
        </div>
    </div>

    <script>
        // ========== FULLSCREEN MODE ==========
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                const elem = document.documentElement;
                if (elem.requestFullscreen) elem.requestFullscreen();
                else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                updateFullscreenUI(true);
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                updateFullscreenUI(false);
            }
        }
        function updateFullscreenUI(isFullscreen) {
            const icon = document.getElementById('fullscreenIcon');
            const text = document.getElementById('fullscreenText');
            if (text) text.textContent = isFullscreen ? 'Exit Full Screen' : 'Full Screen';
        }
        document.addEventListener('fullscreenchange', () => updateFullscreenUI(!!document.fullscreenElement));
        document.addEventListener('webkitfullscreenchange', () => updateFullscreenUI(!!document.webkitFullscreenElement));

        // ========== TOAST NOTIFICATION SYSTEM ==========
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content"><div class="toast-message">${message.replace(/\n/g, '<br>')}</div></div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, duration);
        }

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAmr2W8mekSPJ2pXM3gz1FvarfSBddpfLM",
            authDomain: "bendbsn-17377.firebaseapp.com",
            databaseURL: "https://bendbsn-17377-default-rtdb.firebaseio.com",
            projectId: "bendbsn-17377",
            storageBucket: "bendbsn-17377.firebasestorage.app",
            messagingSenderId: "762882187702",
            appId: "1:762882187702:web:81c97c9eae005666796117"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const SESSION_KEY = 'bsn9b_session_key';
        const SESSION_START_KEY = 'bsn9b_session_start';
        const SESSION_HEARTBEAT_MS = 60000;
        let sessionHeartbeatTimer = null;
        let sessionValidated = false;

        // Presence/Activity timeout constants
        const IDLE_TIMEOUT = 10 * 60 * 1000;   // 10 minutes ‚Üí Away
        const LOGOUT_TIMEOUT = 30 * 60 * 1000; // 30 minutes ‚Üí Logout
        const ACTIVITY_DEBOUNCE = 30000;       // Debounce Firebase updates
        let idleTimer = null;
        let logoutTimer = null;
        let activityDebounceTimer = null;
        let lastActivityTime = Date.now();
        let currentPresenceStatus = 'online';
        let myPresenceRef = null;

        function updateSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey || !sessionValidated) return;
            database.ref('loginHistory/' + sessionKey).update({
                lastSeen: Date.now()
            }).catch(() => {});
        }

        function startSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey) return;
            database.ref('loginHistory/' + sessionKey).once('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val().timestamp) {
                    sessionValidated = true;
                    updateSessionHeartbeat();
                    if (sessionHeartbeatTimer) clearInterval(sessionHeartbeatTimer);
                    sessionHeartbeatTimer = setInterval(updateSessionHeartbeat, SESSION_HEARTBEAT_MS);
                } else {
                    clearSessionTracking();
                }
            }).catch(() => {});
        }

        function endSessionTracking(reason) {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey || !sessionValidated) return;
            if (localStorage.getItem('bsn9b_session_end_sent') === 'true') return;
            const start = parseInt(localStorage.getItem(SESSION_START_KEY) || '0', 10);
            const end = Date.now();
            const durationSeconds = start ? Math.max(0, Math.round((end - start) / 1000)) : null;
            const durationMinutes = durationSeconds !== null ? Math.round(durationSeconds / 60) : null;
            localStorage.setItem('bsn9b_session_end_sent', 'true');
            database.ref('loginHistory/' + sessionKey).update({
                sessionEnd: end,
                durationSeconds: durationSeconds,
                durationMinutes: durationMinutes,
                endReason: reason || 'logout'
            }).catch(() => {});
        }

        function clearSessionTracking() {
            localStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(SESSION_START_KEY);
            localStorage.removeItem('bsn9b_session_end_sent');
        }

        // ========== CHAT SYSTEM (INLINE FROM /app/) ==========
        const channelsRef = database.ref('chat/channels');
        const chatRootRef = database.ref('chat/messages');
        let chatRef = null;
        let chatListenerAttached = false;
        let currentChannelId = localStorage.getItem('bsn9b_chat_channel') || 'general';
        let channelsCache = {};
        const presenceRef = database.ref('chat/presence');
        const bannedRef = database.ref('banned');
        const announcementsRef = database.ref('announcements');
        const userProfilesRef = database.ref('userProfiles');

        // Listen for announcements (alert/fyi banners - inside header)
        function setupAnnouncementListener() {
            announcementsRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                const alertBanner = document.getElementById('alertBanner');
                const fyiBanner = document.getElementById('fyiBanner');
                const alertText = document.getElementById('alertText');
                const fyiText = document.getElementById('fyiText');

                // Handle alert banner
                if (data.alert && data.alert.message) {
                    alertText.textContent = data.alert.message;
                    alertBanner.style.display = 'block';
                    document.body.classList.add('has-alert');
                } else {
                    alertBanner.style.display = 'none';
                    document.body.classList.remove('has-alert');
                }

                // Handle FYI banner (offset if alert is showing)
                if (data.fyi && data.fyi.message) {
                    fyiText.textContent = data.fyi.message;
                    fyiBanner.style.display = 'block';
                    fyiBanner.style.top = (data.alert && data.alert.message) ? '50px' : '0';
                    document.body.classList.add('has-fyi');
                } else {
                    fyiBanner.style.display = 'none';
                    document.body.classList.remove('has-fyi');
                }
            });
        }
        setupAnnouncementListener();
        console.log('Firebase initialized, chatRef path:', chatRef ? chatRef.toString() : 'not set');

        // Get display name (first name) - stored when user logs in
        let currentUsername = localStorage.getItem('bsn9b_user') || 'Anonymous';
        let displayName = localStorage.getItem('bsn9b_displayName') || currentUsername;
        let currentUserUid = localStorage.getItem('bsn9b_uid') || '';

        function getCurrentUserEmail() {
            return currentUsername || auth.currentUser?.email || localStorage.getItem('bsn9b_user') || '';
        }

        function getCurrentUserUid() {
            return currentUserUid || auth.currentUser?.uid || localStorage.getItem('bsn9b_uid') || '';
        }

        function syncUserProfile(user) {
            if (!user) return;
            const email = user.email || getCurrentUserEmail();
            const name = displayName || user.displayName || (email ? email.split('@')[0] : 'User');
            const firstName = name.split(' ')[0] || name;
            userProfilesRef.child(user.uid).update({
                email: email,
                displayName: name,
                firstName: firstName,
                updatedAt: Date.now()
            });
        }

        // Verify Firebase Auth state and re-authenticate if needed
        let firebaseAuthReady = false;
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Firebase Auth: Logged in as', user.email);
                firebaseAuthReady = true;
                currentUserUid = user.uid;
                currentUsername = user.email || currentUsername;
                if (user.displayName) {
                    displayName = user.displayName;
                }
                localStorage.setItem('bsn9b_uid', currentUserUid);
                localStorage.setItem('bsn9b_user', currentUsername);
                localStorage.setItem('bsn9b_displayName', displayName);
                syncUserProfile(user);

                // Check user role and hide APA link for instructors
                userProfilesRef.child(user.uid).once('value').then((snap) => {
                    const profile = snap.val();
                    if (profile && profile.role === 'Instructor') {
                        const apaLink = document.getElementById('apaMenuLink');
                        if (apaLink) apaLink.style.display = 'none';
                    }
                });
            } else {
                console.log('Firebase Auth: Not logged in, attempting silent re-auth...');
                if (localStorage.getItem('bsn9b_auth') === 'true') {
                    console.warn('Session exists but Firebase auth lost - may need to re-login');
                }
            }
        });

        // Check if current user is banned
        function checkIfBanned() {
            bannedRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const banned = child.val();
                    if (banned.username === currentUsername || banned.username === displayName) {
                        showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                        localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                        setTimeout(() => { window.location.href = '/'; }, 2000);
                    }
                });
            });
        }
        checkIfBanned();

        // Listen for bans in real-time
        bannedRef.on('child_added', (snapshot) => {
            const banned = snapshot.val();
            if (banned.username === currentUsername || banned.username === displayName) {
                showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                setTimeout(() => { window.location.href = '/'; }, 2000);
            }
        });

        // Chat state
        var chatOpen = false;
        let unreadCount = 0;
        let lastReadByChannel = JSON.parse(localStorage.getItem('chatLastReadByChannel') || '{}');

        function getLastReadTimestamp(channelId) {
            return parseInt(lastReadByChannel[channelId] || '0');
        }

        function setLastReadTimestamp(channelId, value) {
            lastReadByChannel[channelId] = value.toString();
            localStorage.setItem('chatLastReadByChannel', JSON.stringify(lastReadByChannel));
        }

        function isAdminUser() {
            const adminEmails = ['christiankholden@gmail.com', 'holdenc'];
            return adminEmails.includes((currentUsername || '').toLowerCase());
        }

        // Notification preferences (sound ON by default, browser notifications OFF by default)
        let soundEnabled = localStorage.getItem('chatSoundEnabled') !== 'false';
        let notificationsEnabled = localStorage.getItem('chatNotificationsEnabled') === 'true';

        // Audio notification using Web Audio API
        function playNotificationSound() {
            if (!soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio notification not available:', e);
            }
        }

        // Toggle sound notifications
        function toggleChatSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('chatSoundEnabled', soundEnabled.toString());
            updateSoundToggleUI();
        }

        function updateSoundToggleUI() {
            const btn = document.getElementById('soundToggleBtn');
            if (btn) {
                btn.innerHTML = soundEnabled ? 'üîî' : 'üîï';
                btn.title = soundEnabled ? 'Sound ON (click to mute)' : 'Sound OFF (click to unmute)';
            }
        }

        // Browser Notifications
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Browser does not support notifications');
                return false;
            }

            if (Notification.permission === 'granted') {
                notificationsEnabled = true;
                localStorage.setItem('chatNotificationsEnabled', 'true');
                updateNotificationToggleUI();
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationsEnabled = true;
                    localStorage.setItem('chatNotificationsEnabled', 'true');
                    updateNotificationToggleUI();
                    return true;
                }
            }

            notificationsEnabled = false;
            localStorage.setItem('chatNotificationsEnabled', 'false');
            updateNotificationToggleUI();
            return false;
        }

        function sendBrowserNotification(message) {
            if (!notificationsEnabled || Notification.permission !== 'granted') return;
            if (document.hasFocus() && chatOpen) return;

            try {
                const notification = new Notification('BSN9B Chat', {
                    body: `${message.user}: ${message.text.substring(0, 100)}${message.text.length > 100 ? '...' : ''}`,
                    tag: 'bsn9b-chat',
                    requireInteraction: false
                });

                notification.onclick = function() {
                    window.focus();
                    if (!chatOpen) toggleChat();
                    notification.close();
                };

                setTimeout(() => notification.close(), 5000);
            } catch (e) {
                console.log('Notification error:', e);
            }
        }

        function toggleBrowserNotifications() {
            if (notificationsEnabled) {
                notificationsEnabled = false;
                localStorage.setItem('chatNotificationsEnabled', 'false');
                updateNotificationToggleUI();
            } else {
                requestNotificationPermission();
            }
        }

        function updateNotificationToggleUI() {
            const btn = document.getElementById('notificationToggleBtn');
            if (btn) {
                btn.innerHTML = notificationsEnabled ? 'üì≤' : 'üìµ';
                btn.title = notificationsEnabled ? 'Browser notifications ON' : 'Browser notifications OFF (click to enable)';
            }
        }

        // Initialize notification UI on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSoundToggleUI();
            updateNotificationToggleUI();
            startSessionHeartbeat();
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') updateSessionHeartbeat();
            });
        });

        function sanitizeChannelName(name) {
            return (name || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/(^-|-$)/g, '')
                .slice(0, 24);
        }

        // Unread counts per channel
        let channelUnreadCounts = {};
        let dmSidebarUnreadCounts = {};
        let channelsSectionCollapsed = false;
        let dmSectionCollapsed = false;

        function updateChatTitle() {
            const title = document.getElementById('chatTitle');
            const input = document.getElementById('chatInput');
            if (title) {
                const channelName = channelsCache[currentChannelId]?.name || 'General';
                title.textContent = `# ${channelName.toLowerCase()}`;
            }
            if (input) {
                const channelName = channelsCache[currentChannelId]?.name || 'general';
                input.placeholder = `Message #${channelName.toLowerCase()}`;
            }
        }

        function getChannelUnreadCount(channelId) {
            return channelUnreadCounts[channelId] || 0;
        }

        function setChannelUnreadCount(channelId, count) {
            channelUnreadCounts[channelId] = count;
            renderChannelSidebar();
        }

        function renderChannelSidebar() {
            const container = document.getElementById('channelList');
            if (!container) return;

            const entries = Object.entries(channelsCache);
            const list = entries.length ? entries : [['general', { name: 'General' }]];

            if (channelsSectionCollapsed) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = list
                .sort((a, b) => {
                    // General always first
                    if (a[0] === 'general') return -1;
                    if (b[0] === 'general') return 1;
                    return a[1].name.localeCompare(b[1].name);
                })
                .map(([id, ch]) => {
                    const isActive = id === currentChannelId;
                    const unreadCount = getChannelUnreadCount(id);
                    const unreadBadge = unreadCount > 0 ? `<span style="background: #e94560; color: white; font-size: 10px; padding: 1px 6px; border-radius: 10px; font-weight: 600;">${unreadCount > 9 ? '9+' : unreadCount}</span>` : '';
                    return `
                        <div onclick="selectChannel('${id}')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; margin-bottom: 2px; border-radius: 6px; cursor: pointer; background: ${isActive ? 'rgba(31, 78, 121, 0.8)' : 'transparent'}; transition: background 0.15s;" onmouseover="if(!${isActive}) this.style.background='rgba(255,255,255,0.1)'" onmouseout="if(!${isActive}) this.style.background='transparent'">
                            <span style="color: ${isActive ? 'white' : 'rgba(255,255,255,0.8)'}; font-size: 12px; font-weight: ${isActive ? '600' : '400'}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                <span style="opacity: 0.6; margin-right: 2px;">#</span>${ch.name.toLowerCase()}
                            </span>
                            ${unreadBadge}
                        </div>
                    `;
                })
                .join('');

            // Show/hide admin buttons
            const createBtn = document.getElementById('createChannelBtn');
            const deleteBtn = document.getElementById('deleteChannelBtn');
            if (createBtn) {
                createBtn.style.display = isAdminUser() ? 'inline-block' : 'none';
            }
            if (deleteBtn) {
                deleteBtn.style.display = isAdminUser() && currentChannelId !== 'general' ? 'inline-flex' : 'none';
            }
        }

        function renderDMSidebar() {
            const container = document.getElementById('dmSidebarList');
            if (!container) return;

            if (dmSectionCollapsed) {
                container.innerHTML = '';
                return;
            }

            if (dmConversations.length === 0) {
                container.innerHTML = `<div style="color: rgba(255,255,255,0.4); font-size: 11px; padding: 6px 8px;">No conversations yet</div>`;
                return;
            }

            container.innerHTML = dmConversations.slice(0, 8).map(conv => {
                const isActive = currentDMConversation && currentDMConversation.conversationId === conv.conversationId;
                const unread = dmSidebarUnreadCounts[conv.conversationId] || 0;
                const unreadBadge = unread > 0 ? `<span style="background: #8b5cf6; color: white; font-size: 10px; padding: 1px 6px; border-radius: 10px; font-weight: 600;">${unread > 9 ? '9+' : unread}</span>` : '';
                const isOnline = onlineUsersDetailed.some(u => u.name && u.name.toLowerCase() === conv.partnerName.toLowerCase());
                const onlineDot = isOnline ? `<span style="display: inline-block; width: 6px; height: 6px; background: #22c55e; border-radius: 50%; margin-right: 6px;"></span>` : '';

                return `
                    <div onclick="openDMFromSidebar('${conv.partnerUid}', '${conv.partnerName}', '${conv.partnerEmail || ''}')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; margin-bottom: 2px; border-radius: 6px; cursor: pointer; background: ${isActive ? 'rgba(139, 92, 246, 0.6)' : 'transparent'}; transition: background 0.15s;" onmouseover="if(!${isActive}) this.style.background='rgba(255,255,255,0.1)'" onmouseout="if(!${isActive}) this.style.background='transparent'">
                        <span style="color: ${isActive ? 'white' : 'rgba(255,255,255,0.8)'}; font-size: 12px; font-weight: ${isActive || unread > 0 ? '600' : '400'}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: flex; align-items: center;">
                            ${onlineDot}${conv.partnerName}
                        </span>
                        ${unreadBadge}
                    </div>
                `;
            }).join('');
        }

        function toggleChannelsSection() {
            channelsSectionCollapsed = !channelsSectionCollapsed;
            const icon = document.getElementById('channelsExpandIcon');
            if (icon) icon.textContent = channelsSectionCollapsed ? '‚ñ∂' : '‚ñº';
            renderChannelSidebar();
        }

        function toggleDMSection() {
            dmSectionCollapsed = !dmSectionCollapsed;
            const icon = document.getElementById('dmExpandIcon');
            if (icon) icon.textContent = dmSectionCollapsed ? '‚ñ∂' : '‚ñº';
            renderDMSidebar();
        }

        function selectChannel(channelId) {
            // Clear unread for this channel
            channelUnreadCounts[channelId] = 0;

            // Switch to group view if in DM mode
            if (chatMode !== 'group') {
                chatMode = 'group';
                document.getElementById('groupChatView').style.display = 'flex';
                document.getElementById('dmView').style.display = 'none';
            }

            setChannel(channelId);
            renderChannelSidebar();
            renderDMSidebar();
        }

        function openDMFromSidebar(partnerUid, partnerName, partnerEmail) {
            // Clear unread for this conversation
            const convId = getConversationId(getCurrentUserUid(), partnerUid);
            dmSidebarUnreadCounts[convId] = 0;

            // Switch to DM view
            chatMode = 'dm';
            document.getElementById('groupChatView').style.display = 'none';
            document.getElementById('dmView').style.display = 'flex';
            document.getElementById('chatTitle').textContent = partnerName;

            startDMConversation(partnerUid, partnerName, partnerEmail);
            renderChannelSidebar();
            renderDMSidebar();
        }

        function createChannelModal() {
            if (!isAdminUser()) {
                showToast('Only admins can create channels.', 'warning');
                return;
            }
            document.getElementById('createChannelModal').style.display = 'flex';
            document.getElementById('newChannelName').value = '';
            document.getElementById('newChannelName').focus();
        }

        function closeCreateChannelModal() {
            document.getElementById('createChannelModal').style.display = 'none';
        }

        function submitCreateChannel() {
            const name = document.getElementById('newChannelName').value.trim();
            if (!name) {
                showToast('Please enter a channel name.', 'warning');
                return;
            }
            const id = sanitizeChannelName(name);
            if (!id) {
                showToast('Invalid channel name.', 'warning');
                return;
            }
            channelsRef.child(id).set({
                name: name,
                createdAt: Date.now(),
                createdBy: currentUsername
            }).then(() => {
                closeCreateChannelModal();
                selectChannel(id);
                showToast(`Channel #${name} created!`, 'success');
            }).catch(err => {
                console.error('Create channel failed:', err);
                showToast('Failed to create channel.', 'error');
            });
        }

        // Legacy function - redirects to sidebar render
        function updateChannelSelect() {
            renderChannelSidebar();
        }

        function attachChatRef() {
            if (chatRef && chatListenerAttached) {
                chatRef.off();
                chatListenerAttached = false;
            }
            chatRef = chatRootRef.child(currentChannelId);
        }

        function setChannel(channelId) {
            if (!channelId) return;
            currentChannelId = channelId;
            localStorage.setItem('bsn9b_chat_channel', currentChannelId);
            attachChatRef();
            updateChatTitle();
            renderChannelSidebar();
            setupChatListener();
            cleanupOldMessages();
        }

        function handleChannelChange(value) {
            selectChannel(value);
        }

        function createChannel() {
            createChannelModal();
        }

        function deleteChannel() {
            if (!isAdminUser()) return;
            if (currentChannelId === 'general') {
                showToast('General cannot be deleted.', 'warning');
                return;
            }
            if (!confirm('Delete this channel and all its messages?')) return;
            const id = currentChannelId;
            const msgRef = chatRootRef.child(id);
            Promise.all([
                channelsRef.child(id).remove(),
                msgRef.remove()
            ]).then(() => {
                setChannel('general');
            }).catch(err => {
                console.error('Delete channel failed:', err);
                showToast('Failed to delete channel.', 'error');
            });
        }

        function loadChannels() {
            channelsRef.on('value', (snapshot) => {
                channelsCache = snapshot.val() || {};
                if (!channelsCache.general) {
                    channelsCache.general = { name: 'General' };
                }
                if (!channelsCache[currentChannelId]) {
                    currentChannelId = 'general';
                }
                renderChannelSidebar();
                setChannel(currentChannelId);

                // Load unread counts for all channels
                updateAllChannelUnreadCounts();
            });
        }

        // Check unread messages for all channels
        let channelUnreadListeners = {};

        function updateAllChannelUnreadCounts() {
            Object.keys(channelsCache).forEach(channelId => {
                if (channelId === currentChannelId) {
                    channelUnreadCounts[channelId] = 0;
                    return;
                }

                // Set up real-time listener for each channel (if not already)
                if (!channelUnreadListeners[channelId]) {
                    channelUnreadListeners[channelId] = true;
                    chatRootRef.child(channelId).on('child_added', (snapshot) => {
                        if (channelId === currentChannelId) return;
                        const msg = snapshot.val();
                        const lastRead = getLastReadTimestamp(channelId);
                        if (msg.timestamp > lastRead && msg.username !== currentUsername) {
                            channelUnreadCounts[channelId] = (channelUnreadCounts[channelId] || 0) + 1;
                            renderChannelSidebar();
                            // Update main badge
                            updateTotalUnreadBadge();
                        }
                    });
                }

                // Initial count
                const lastRead = getLastReadTimestamp(channelId);
                chatRootRef.child(channelId).once('value', (snapshot) => {
                    let unread = 0;
                    snapshot.forEach((child) => {
                        const msg = child.val();
                        if (msg.timestamp > lastRead && msg.username !== currentUsername) {
                            unread++;
                        }
                    });
                    if (channelUnreadCounts[channelId] !== unread) {
                        channelUnreadCounts[channelId] = unread;
                        renderChannelSidebar();
                        updateTotalUnreadBadge();
                    }
                });
            });
        }

        function updateTotalUnreadBadge() {
            const total = Object.values(channelUnreadCounts).reduce((a, b) => a + b, 0);
            const badge = document.getElementById('chatBadge');
            if (total > 0 && !chatOpen) {
                badge.textContent = total > 9 ? '9+' : total;
                badge.style.display = 'flex';
            } else if (chatOpen || total === 0) {
                badge.style.display = 'none';
            }
        }

        // Toggle chat
        function toggleChat() {
            chatOpen = !chatOpen;
            const chatBox = document.getElementById('chatBox');
            const chatToggle = document.getElementById('chatToggle');
            if (chatOpen) {
                chatBox.style.display = 'flex';
                chatBox.style.flexDirection = 'row'; // Sidebar layout
                unreadCount = 0;
                channelUnreadCounts[currentChannelId] = 0;
                document.getElementById('chatBadge').style.display = 'none';
                setLastReadTimestamp(currentChannelId, Date.now());
                renderChannelSidebar();
                loadDMConversations(); // Load DM sidebar
                const chatInput = document.getElementById('chatInput');
                if (chatInput) chatInput.focus();
                scrollToBottom();
            } else {
                chatBox.style.display = 'none';
            }
            chatToggle.style.transform = chatOpen ? 'scale(0.9)' : 'scale(1)';
            chatToggle.setAttribute('aria-expanded', chatOpen);
            chatToggle.setAttribute('aria-label', chatOpen ? 'Close chat' : 'Open chat');
        }

        // Send message
        function sendMessage(event) {
            event.preventDefault();
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Admin commands (admin emails only)
            if (isAdminUser()) {
                // Alert command: alert/message or alert/clear
                if (message.toLowerCase().startsWith('alert/')) {
                    const alertMsg = message.substring(6).trim();
                    if (alertMsg.toLowerCase() === 'clear') {
                        announcementsRef.child('alert').remove();
                    } else if (alertMsg) {
                        announcementsRef.child('alert').set({ message: alertMsg, timestamp: Date.now() });
                    }
                    input.value = '';
                    return;
                }
                // FYI command: fyi/message or fyi/clear
                if (message.toLowerCase().startsWith('fyi/')) {
                    const fyiMsg = message.substring(4).trim();
                    if (fyiMsg.toLowerCase() === 'clear') {
                        announcementsRef.child('fyi').remove();
                    } else if (fyiMsg) {
                        announcementsRef.child('fyi').set({ message: fyiMsg, timestamp: Date.now() });
                    }
                    input.value = '';
                    return;
                }
                // Chat clear command: chat/clear
                if (message.toLowerCase() === 'chat/clear') {
                    chatRef.remove();
                    input.value = '';
                    return;
                }
            }

            // Check Firebase Auth status
            const currentUser = auth.currentUser;
            console.log('Sending message, Firebase auth user:', currentUser ? currentUser.email : 'NOT AUTHENTICATED');

            if (!currentUser) {
                showToast('Chat requires authentication. Please refresh the page or log in again.', 'error');
                return;
            }

            chatRef.push({
                user: displayName,
                username: currentUsername,
                text: message,
                timestamp: Date.now()
            }).then(() => {
                console.log('Message sent successfully');
            }).catch((error) => {
                console.error('Failed to send message:', error);
                showToast('Failed to send message: ' + error.message + '. You may need to log in again.', 'error');
            });

            input.value = '';
            hideMentionDropdown();
        }

        // Format timestamp (with safety checks)
        function formatTime(timestamp) {
            try {
                if (!timestamp || typeof timestamp !== 'number') {
                    return 'Unknown time';
                }
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    return 'Invalid time';
                }
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();

                if (isToday) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            } catch (e) {
                console.error('formatTime error:', e);
                return 'Time error';
            }
        }

        // Format message text with @mention highlighting (with safety checks)
        function formatMessageWithMentions(text, isMe) {
            try {
                if (!text || typeof text !== 'string') {
                    return '';
                }
                // Escape HTML first
                let formatted = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                // Highlight @mentions with a styled span
                formatted = formatted.replace(/@(\w+)/g, function(match, name) {
                    const bgColor = isMe ? 'rgba(255,255,255,0.3)' : 'rgba(139, 92, 246, 0.2)';
                    const textColor = isMe ? '#fff' : '#7c3aed';
                    return `<span style="background: ${bgColor}; color: ${textColor}; padding: 1px 6px; border-radius: 10px; font-weight: 600;">@${name}</span>`;
                });

                return formatted;
            } catch (e) {
                console.error('formatMessageWithMentions error:', e);
                return text || '';
            }
        }

        // Scroll to bottom
        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        // 7-day threshold in milliseconds
        const MESSAGE_RETENTION_MS = 7 * 24 * 60 * 60 * 1000;

        // Clean up old messages (older than 7 days)
        function cleanupOldMessages() {
            const cutoff = Date.now() - MESSAGE_RETENTION_MS;
            if (!chatRef) return;
            chatRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const msg = child.val();
                    if (msg.timestamp && msg.timestamp < cutoff) {
                        child.ref.remove();
                    }
                });
            });
        }

        // Run cleanup on load and every hour
        cleanupOldMessages();
        setInterval(cleanupOldMessages, 60 * 60 * 1000);

        // Listen for messages
        function setupChatListener() {
            console.log('Setting up chat listener...');
            if (!chatRef) return;
            if (chatListenerAttached) {
                chatRef.off();
                chatListenerAttached = false;
            }
            chatRef.on('value', (snapshot) => {
                chatListenerAttached = true;
                console.log('=== CHAT LISTENER FIRED ===');
                console.log('Snapshot exists:', snapshot.exists());
                console.log('Snapshot numChildren:', snapshot.numChildren());

                const container = document.getElementById('chatMessages');
                if (!container) {
                    console.error('chatMessages container not found!');
                    return;
                }

                if (!snapshot.exists() || snapshot.numChildren() === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; margin-top: 20px;">No messages yet. Start the conversation!</p>';
                    return;
                }

                // Get ALL messages first, then filter
                const allMessages = [];
                snapshot.forEach((child) => {
                    const msg = child.val();
                    allMessages.push(msg);
                });

                // Filter by 7 days
                const cutoff = Date.now() - MESSAGE_RETENTION_MS;
                let messages = allMessages.filter(msg => msg.timestamp && msg.timestamp >= cutoff);

                // Sort by timestamp
                messages.sort((a, b) => a.timestamp - b.timestamp);

                // Limit to last 50 messages for performance
                const MAX_DISPLAY_MESSAGES = 50;
                const hasOlderMessages = messages.length > MAX_DISPLAY_MESSAGES;
                if (hasOlderMessages) {
                    messages = messages.slice(-MAX_DISPLAY_MESSAGES);
                }

                if (messages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; margin-top: 20px;">No messages yet. Start the conversation!</p>';
                    return;
                }

                let html = '';
                // Show indicator if older messages are hidden
                if (hasOlderMessages) {
                    html += '<p style="text-align: center; color: #888; font-size: 11px; padding: 8px; background: #f0f0f0; border-radius: 8px; margin-bottom: 10px;">Showing last 50 messages</p>';
                }
                let newMessages = 0;

                messages.forEach((msg) => {
                    const isMe = msg.user === displayName || msg.username === currentUsername;
                    const isNew = msg.timestamp > getLastReadTimestamp(currentChannelId);

                    if (isNew && !chatOpen) newMessages++;

                    // Format text with @mention highlighting
                    const formattedText = formatMessageWithMentions(msg.text, isMe);
                    // Check if this message mentions the current user
                    const mentionsMe = msg.text.toLowerCase().includes('@' + displayName.toLowerCase());

                    html += `
                        <div style="margin-bottom: 12px; display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'};">
                            <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${isMe ? 'You' : msg.user}</div>
                            <div style="background: ${mentionsMe && !isMe ? 'linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%)' : (isMe ? 'linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%)' : '#e2e8f0')}; color: ${mentionsMe || isMe ? 'white' : '#333'}; padding: 10px 14px; border-radius: ${isMe ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 80%; word-wrap: break-word; font-size: 14px; ${mentionsMe && !isMe ? 'box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);' : ''}">
                                ${formattedText}
                            </div>
                            <div style="font-size: 9px; color: #aaa; margin-top: 3px;">
                                ${formatTime(msg.timestamp)}${isMe ? ' <span style="color: #4ade80;" title="Delivered">‚úì</span>' : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                scrollToBottom();

                // Update unread badge and send notifications
                if (newMessages > 0 && !chatOpen) {
                    const shouldNotify = unreadCount < newMessages;

                    unreadCount = newMessages;
                    const badge = document.getElementById('chatBadge');
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    badge.style.display = 'flex';

                    if (shouldNotify && messages.length > 0) {
                        const latestMessage = messages[messages.length - 1];
                        if (latestMessage.username !== currentUsername) {
                            playNotificationSound();
                            sendBrowserNotification(latestMessage);
                        }
                    }
                }
            }, (error) => {
                console.error('Chat listener error:', error);
                document.getElementById('chatMessages').innerHTML = '<p style="color: red; padding: 20px;">Chat error: ' + error.message + '</p>';
            });
        }

        // Initialize chat listener
        loadChannels();

        // Monitor Firebase connection state
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            const connected = snap.val() === true;
            const onlineCountEl = document.getElementById('onlineCount');
            if (connected) {
                console.log('Firebase: Connected');
                if (onlineCountEl && onlineCountEl.textContent.includes('Disconnected')) {
                    onlineCountEl.textContent = 'Reconnected! Refreshing...';
                    setTimeout(() => setupChatListener(), 500);
                }
            } else {
                console.log('Firebase: Disconnected');
                if (onlineCountEl) {
                    onlineCountEl.innerHTML = '<span style="color: #fca5a5;">Disconnected - reconnecting...</span>';
                }
            }
        });

        // ========== DIRECT MESSAGES ==========
        let chatMode = 'group';
        let currentDMConversation = null;
        let dmConversations = [];
        let dmUnreadCount = 0;
        let dmLastReadTimestamps = JSON.parse(localStorage.getItem('dmLastRead') || '{}');
        const directMessagesRef = database.ref('directMessages');
        let userProfilesByUid = {};
        let userProfilesByEmail = {};
        let userProfilesByName = {};

        function rebuildUserProfileIndexes(profiles) {
            userProfilesByUid = {};
            userProfilesByEmail = {};
            userProfilesByName = {};
            if (!profiles) return;

            Object.keys(profiles).forEach((uid) => {
                const profile = profiles[uid] || {};
                const email = (profile.email || '').toLowerCase();
                const name = (profile.displayName || profile.firstName || '').toLowerCase();
                userProfilesByUid[uid] = profile;
                if (email) userProfilesByEmail[email] = { uid: uid, ...profile };
                if (name) userProfilesByName[name] = { uid: uid, ...profile };
            });
        }

        async function loadUserProfiles() {
            try {
                const snap = await userProfilesRef.once('value');
                rebuildUserProfileIndexes(snap.val());
            } catch (e) {
                console.warn('Failed to load user profiles:', e);
            }
        }

        function addUidsToRegisteredUsers() {
            allRegisteredUsers = allRegisteredUsers.map((u) => {
                const email = (u.email || '').toLowerCase();
                const name = (u.firstName || u.name || '').toLowerCase();
                const profile = userProfilesByEmail[email] || userProfilesByName[name];
                return { ...u, uid: profile?.uid || '' };
            });
        }

        function getConversationId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

        function switchChatMode(mode) {
            try {
                chatMode = mode;
                const groupView = document.getElementById('groupChatView');
                const dmView = document.getElementById('dmView');
                const chatTitle = document.getElementById('chatTitle');

                if (!groupView || !dmView) {
                    console.error('Chat views not found');
                    return;
                }

                if (mode === 'group') {
                    groupView.style.display = 'flex';
                    dmView.style.display = 'none';
                    updateChatTitle();

                    unreadCount = 0;
                    channelUnreadCounts[currentChannelId] = 0;
                    document.getElementById('chatBadge').style.display = 'none';
                    setLastReadTimestamp(currentChannelId, Date.now());
                    renderChannelSidebar();
                } else {
                    groupView.style.display = 'none';
                    dmView.style.display = 'flex';
                    chatTitle.textContent = 'Direct Messages';

                    showDMConversationList();
                    loadDMConversations();
                }
                renderDMSidebar();
            } catch (e) {
                console.error('Error switching chat mode:', e);
            }
        }

        function showDMConversationList() {
            document.getElementById('dmConversationList').style.display = 'block';
            document.getElementById('dmMessageView').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'none';
            currentDMConversation = null;
        }

        function showNewDMSelector() {
            document.getElementById('dmConversationList').style.display = 'none';
            document.getElementById('dmMessageView').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'flex';
            document.getElementById('dmUserSearch').value = '';
            loadDMUserList();
        }

        function hideNewDMSelector() {
            showDMConversationList();
        }

        async function loadDMUserList() {
            const container = document.getElementById('dmUserList');
            await loadUserProfiles();
            addUidsToRegisteredUsers();
            const onlineSet = new Set(onlineUsersDetailed.map(u => (u.name || '').toLowerCase()));
            let users = [];

            onlineUsersDetailed.forEach(u => {
                if ((u.name || '').toLowerCase() !== displayName.toLowerCase()) {
                    users.push({
                        name: u.name,
                        online: true,
                        uid: u.uid || '',
                        email: u.email || u.username || ''
                    });
                }
            });

            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                if (!onlineSet.has(firstName.toLowerCase()) && firstName.toLowerCase() !== displayName.toLowerCase()) {
                    users.push({
                        name: firstName,
                        fullName: u.name,
                        email: u.email,
                        online: false,
                        uid: u.uid || ''
                    });
                }
            });

            renderDMUserList(users);
        }

        function filterDMUsers() {
            const search = document.getElementById('dmUserSearch').value.toLowerCase();
            const onlineSet = new Set(onlineUsersDetailed.map(u => (u.name || '').toLowerCase()));
            let users = [];

            onlineUsersDetailed.forEach(u => {
                const name = (u.name || '').toLowerCase();
                if (name !== displayName.toLowerCase() && name.includes(search)) {
                    users.push({
                        name: u.name,
                        online: true,
                        uid: u.uid || '',
                        email: u.email || u.username || ''
                    });
                }
            });

            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                if (!onlineSet.has(firstName.toLowerCase()) &&
                    firstName.toLowerCase() !== displayName.toLowerCase() &&
                    (firstName.toLowerCase().includes(search) || u.name.toLowerCase().includes(search))) {
                    users.push({
                        name: firstName,
                        fullName: u.name,
                        email: u.email,
                        online: false,
                        uid: u.uid || ''
                    });
                }
            });

            renderDMUserList(users);
        }

        function renderDMUserList(users) {
            const container = document.getElementById('dmUserList');

            if (users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px;">No users found</p>';
                return;
            }

            container.innerHTML = users.map(u => `
                <div onclick="startDMConversation('${u.uid || ''}', '${u.name}', '${u.email || ''}')" style="padding: 12px; background: white; border-radius: 10px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div>
                        <div style="font-weight: 600; color: #1a1a2e;">${u.name}${u.fullName && u.fullName !== u.name ? ` <span style="color:#888;font-weight:normal;font-size:12px;">(${u.fullName})</span>` : ''}</div>
                    </div>
                    ${u.online ? '<span style="font-size: 10px; background: #22c55e; color: white; padding: 2px 8px; border-radius: 10px;">online</span>' : '<span style="font-size: 10px; color: #888;">offline</span>'}
                </div>
            `).join('');
        }

        function startDMConversation(partnerUid, partnerName, partnerEmail) {
            const currentUid = getCurrentUserUid();
            if (!currentUid || !partnerUid) {
                showToast('This user is not available for DMs yet. Ask them to log in once so we can link their account.', 'warning');
                return;
            }

            currentDMConversation = {
                partnerName: partnerName,
                partnerUid: partnerUid,
                partnerEmail: partnerEmail || '',
                conversationId: getConversationId(currentUid, partnerUid)
            };

            document.getElementById('dmConversationList').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'none';
            document.getElementById('dmMessageView').style.display = 'flex';
            document.getElementById('dmPartnerName').textContent = partnerName;

            const isOnline = onlineUsersDetailed.some(u =>
                (u.uid && u.uid === partnerUid) ||
                (u.name && u.name.toLowerCase() === partnerName.toLowerCase())
            );
            const statusEl = document.getElementById('dmPartnerStatus');
            statusEl.textContent = isOnline ? 'online' : 'offline';
            statusEl.style.background = isOnline ? '#dcfce7' : '#e2e8f0';
            statusEl.style.color = isOnline ? '#16a34a' : '#666';

            loadDMMessages(currentDMConversation.conversationId);
            markDMAsRead(currentDMConversation.conversationId);
        }

        function closeDMConversation() {
            currentDMConversation = null;
            showDMConversationList();
            loadDMConversations();
        }

        function loadDMConversations() {
            const container = document.getElementById('dmConversations');
            if (!container) return;

            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading...</p>';

            const currentUid = getCurrentUserUid();
            if (!currentUid) {
                container.innerHTML = '<p style="color: #888; font-size: 12px;">Please log in to view messages.</p>';
                return;
            }

            directMessagesRef.once('value', (snapshot) => {
                dmConversations = [];

                snapshot.forEach((child) => {
                    const convId = child.key;
                    const data = child.val();

                    if (!data) return;

                    const participants = data.participants || {};
                    if (!participants[currentUid]) return;

                    if (data.lastMessage) {
                        const partnerUid = Object.keys(participants).find(uid => uid !== currentUid);
                        const partner = partnerUid ? (participants[partnerUid] || {}) : {};
                        const partnerName = partner.displayName || partner.name || 'Unknown';
                        const partnerEmail = partner.email || '';

                        dmConversations.push({
                            conversationId: convId,
                            partnerUid: partnerUid || '',
                            partnerName: partnerName,
                            partnerEmail: partnerEmail,
                            lastMessage: data.lastMessage,
                            unread: !dmLastReadTimestamps[convId] || data.lastMessage.timestamp > dmLastReadTimestamps[convId]
                        });
                    }
                });

                dmConversations.sort((a, b) => (b.lastMessage?.timestamp || 0) - (a.lastMessage?.timestamp || 0));
                renderDMConversations();
                renderDMSidebar(); // Update sidebar as well
            });
        }

        function renderDMConversations() {
            const container = document.getElementById('dmConversations');

            if (dmConversations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; padding: 20px;">No conversations yet.<br>Start a new message!</p>';
                return;
            }

            let totalUnread = 0;
            container.innerHTML = dmConversations.map(conv => {
                const time = conv.lastMessage ? formatTime(conv.lastMessage.timestamp) : '';
                const preview = conv.lastMessage ? (conv.lastMessage.text || '').substring(0, 40) + (conv.lastMessage.text?.length > 40 ? '...' : '') : '';
                const isUnread = conv.unread && conv.lastMessage?.senderUid !== getCurrentUserUid();
                if (isUnread) totalUnread++;

                return `
                    <div onclick="startDMConversation('${conv.partnerUid || ''}', '${conv.partnerName}', '${conv.partnerEmail || ''}')" style="padding: 12px; background: ${isUnread ? '#f0f7ff' : 'white'}; border-radius: 10px; margin-bottom: 8px; cursor: pointer; border: 1px solid ${isUnread ? '#8b5cf6' : '#e2e8f0'}; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='${isUnread ? '#8b5cf6' : '#e2e8f0'}'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: ${isUnread ? '700' : '600'}; color: #1a1a2e; margin-bottom: 4px;">
                                    ${isUnread ? '‚óè ' : ''}${conv.partnerName}
                                </div>
                                <div style="font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${conv.lastMessage?.senderUid === getCurrentUserUid() ? 'You: ' : ''}${preview}
                                </div>
                            </div>
                            <div style="font-size: 10px; color: #888; white-space: nowrap; margin-left: 10px;">
                                ${time}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateDMBadge(totalUnread);
        }

        function updateDMBadge(count) {
            dmUnreadCount = count;
            const badge = document.getElementById('dmBadge');
            const tabBadge = document.getElementById('dmTabBadge');

            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count;
                badge.style.display = 'flex';
                tabBadge.textContent = count;
                tabBadge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
                tabBadge.style.display = 'none';
            }
        }

        function loadDMMessages(conversationId) {
            const container = document.getElementById('dmMessages');
            container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px;">Loading messages...</p>';

            const messagesRef = directMessagesRef.child(conversationId + '/messages');
            messagesRef.orderByChild('timestamp').on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; padding: 20px;">No messages yet. Say hello!</p>';
                    return;
                }

                const messages = [];
                snapshot.forEach((child) => {
                    messages.push(child.val());
                });

                let html = '';
                const currentUid = getCurrentUserUid();
                messages.forEach(msg => {
                    const isMe = msg.senderUid ? msg.senderUid === currentUid : (msg.senderName === displayName || msg.sender === currentUsername);
                    const senderLabel = isMe ? 'You' : (msg.senderName || msg.sender || 'User');

                    html += `
                        <div style="margin-bottom: 12px; display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'};">
                            <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${senderLabel}</div>
                            <div style="background: ${isMe ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' : '#e2e8f0'}; color: ${isMe ? 'white' : '#333'}; padding: 10px 14px; border-radius: ${isMe ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 80%; word-wrap: break-word; font-size: 14px;">
                                ${(msg.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            </div>
                            <div style="font-size: 9px; color: #aaa; margin-top: 3px;">
                                ${formatTime(msg.timestamp)}${isMe ? (msg.read ? ' <span style="color: #4ade80;" title="Seen">‚úì‚úì</span>' : ' <span style="color: #888;" title="Delivered">‚úì</span>') : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                container.scrollTop = container.scrollHeight;

                if (currentDMConversation && currentDMConversation.conversationId === conversationId) {
                    markDMAsRead(conversationId, snapshot);
                }
            });
        }

        function sendDM(event) {
            event.preventDefault();

            if (!currentDMConversation) return;

            const input = document.getElementById('dmInput');
            if (!input) return;

            const text = input.value.trim();
            if (!text) return;

            const currentUser = auth.currentUser;
            if (!currentUser) {
                showToast('Please log in to send messages.', 'warning');
                return;
            }

            const conversationId = currentDMConversation.conversationId;
            const partnerName = currentDMConversation.partnerName;
            const partnerUid = currentDMConversation.partnerUid;
            const partnerEmail = currentDMConversation.partnerEmail || '';
            const currentUid = getCurrentUserUid();
            if (!currentUid || !partnerUid) {
                showToast('Unable to send DM (missing user ID). Please refresh and try again.', 'warning');
                return;
            }

            const messageData = {
                senderUid: currentUid,
                senderEmail: currentUsername,
                senderName: displayName,
                text: text,
                timestamp: Date.now(),
                read: false
            };

            try {
                directMessagesRef.child(conversationId + '/messages').push(messageData)
                    .catch(err => console.error('Error sending DM:', err));

                const participantsData = {};
                participantsData[currentUid] = { displayName: displayName, email: currentUsername };
                participantsData[partnerUid] = { displayName: partnerName, email: partnerEmail };
                directMessagesRef.child(conversationId + '/participants').set(participantsData);

                directMessagesRef.child(conversationId + '/lastMessage').set({
                    text: text,
                    timestamp: Date.now(),
                    senderUid: currentUid,
                    senderName: displayName
                });

                input.value = '';
            } catch (e) {
                console.error('Error sending DM:', e);
                showToast('Failed to send message. Please try again.', 'error');
            }
        }

        function markDMAsRead(conversationId, snapshot) {
            dmLastReadTimestamps[conversationId] = Date.now();
            localStorage.setItem('dmLastRead', JSON.stringify(dmLastReadTimestamps));

            if (snapshot && snapshot.exists()) {
                const currentUid = getCurrentUserUid();
                snapshot.forEach((child) => {
                    const msg = child.val();
                    const msgKey = child.key;
                    const isMine = msg && msg.senderUid ? msg.senderUid === currentUid : (msg.senderName === displayName || msg.sender === currentUsername);
                    if (msg && !msg.read && !isMine) {
                        directMessagesRef.child(conversationId + '/messages/' + msgKey + '/read').set(true)
                            .catch(err => console.error('Error marking message as read:', err));
                    }
                });
            }

            let totalUnread = 0;
            dmConversations.forEach(conv => {
                if (conv.conversationId !== conversationId) {
                    if (conv.unread && conv.lastMessage?.senderUid !== getCurrentUserUid()) {
                        totalUnread++;
                    }
                }
            });
            updateDMBadge(totalUnread);
        }

        async function runDMSelfTest() {
            const uid = getCurrentUserUid();
            const email = getCurrentUserEmail();
            if (!uid) {
                showToast('Please log in to run the DM test.', 'warning');
                return;
            }

            const convId = 'selftest_' + uid;
            const convRef = directMessagesRef.child(convId);
            const participantsData = {};
            participantsData[uid] = { displayName: displayName, email: email };

            const messageData = {
                senderUid: uid,
                senderEmail: email,
                senderName: displayName,
                text: 'DM self-test at ' + new Date().toLocaleTimeString(),
                timestamp: Date.now(),
                read: true
            };

            try {
                await convRef.child('participants').set(participantsData);
                await convRef.child('messages').push(messageData);
                const snap = await convRef.child('messages').limitToLast(1).once('value');
                if (snap.exists()) {
                    showToast('DM self-test passed.', 'success');
                } else {
                    showToast('DM self-test failed. Check rules.', 'error');
                }
                try { await convRef.remove(); } catch (e) {}
            } catch (e) {
                console.error('DM self-test error:', e);
                showToast('DM self-test failed: ' + e.message, 'error');
            }
        }

        function setupDMListener() {
            try {
                directMessagesRef.on('child_changed', (snapshot) => {
                    try {
                        const convId = snapshot.key;
                        const data = snapshot.val();

                        if (!data) return;

                        const participants = data.participants || {};
                        const currentUid = getCurrentUserUid();
                        if (!currentUid || !participants[currentUid]) return;

                        const partnerUid = Object.keys(participants).find(uid => uid !== currentUid);
                        const partner = partnerUid ? (participants[partnerUid] || {}) : {};
                        const partnerName = partner.displayName || partner.name || 'Unknown';
                        const partnerEmail = partner.email || '';

                        if (data.lastMessage && data.lastMessage.senderUid !== currentUid) {
                            const lastRead = dmLastReadTimestamps[convId] || 0;
                            if (data.lastMessage.timestamp > lastRead) {
                                if (!chatOpen || chatMode !== 'dm' || currentDMConversation?.conversationId !== convId) {
                                    playNotificationSound();

                                    if (notificationsEnabled && Notification.permission === 'granted') {
                                        try {
                                            const notification = new Notification('New DM from ' + partnerName, {
                                                body: (data.lastMessage.text || '').substring(0, 100),
                                                tag: 'bsn9b-dm-' + convId
                                            });
                                            notification.onclick = () => {
                                                window.focus();
                                                if (!chatOpen) toggleChat();
                                                switchChatMode('dm');
                                                startDMConversation(partnerUid || '', partnerName, partnerEmail);
                                                notification.close();
                                            };
                                        } catch (notifErr) {
                                            console.log('Notification error:', notifErr);
                                        }
                                    }
                                }

                                if (chatOpen && chatMode === 'dm' && !currentDMConversation) {
                                    loadDMConversations();
                                }
                            }
                        }
                    } catch (innerErr) {
                        console.error('DM listener inner error:', innerErr);
                    }
                });
            } catch (e) {
                console.error('Error setting up DM listener:', e);
            }
        }

        setupDMListener();

        // ========== PRESENCE SYSTEM ==========
        // Set presence using UID as key (prevents duplicates across tabs)
        function setPresence(status = 'online') {
            const uid = getCurrentUserUid();
            if (!uid) return;

            myPresenceRef = presenceRef.child(uid);
            myPresenceRef.set({
                user: displayName,
                username: currentUsername,
                uid: uid,
                status: status,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
            myPresenceRef.onDisconnect().remove();
            currentPresenceStatus = status;
        }

        // Update status without full rewrite
        function updatePresenceStatus(status) {
            const uid = getCurrentUserUid();
            if (!uid) return;
            presenceRef.child(uid).update({
                status: status,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            }).catch(() => {});
            currentPresenceStatus = status;
        }

        // Activity detection - reset idle timers (debounced)
        function recordActivity() {
            lastActivityTime = Date.now();

            // Reset idle/logout timers immediately (local)
            clearTimeout(idleTimer);
            clearTimeout(logoutTimer);

            // Set idle timer (10 min)
            idleTimer = setTimeout(() => {
                updatePresenceStatus('away');

                // Set logout timer (additional 20 min = 30 min total)
                logoutTimer = setTimeout(() => {
                    logout(); // Full logout
                }, LOGOUT_TIMEOUT - IDLE_TIMEOUT);
            }, IDLE_TIMEOUT);

            // Debounce Firebase updates (don't spam on every mouse move)
            if (activityDebounceTimer) return;

            // If was away, go back online immediately
            if (currentPresenceStatus === 'away') {
                updatePresenceStatus('online');
            }

            activityDebounceTimer = setTimeout(() => {
                activityDebounceTimer = null;
                // Update lastActive timestamp periodically while active
                const uid = getCurrentUserUid();
                if (currentPresenceStatus === 'online' && uid) {
                    presenceRef.child(uid).update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    }).catch(() => {});
                }
            }, ACTIVITY_DEBOUNCE);
        }

        // Initialize activity listeners
        function initActivityTracking() {
            const events = ['mousedown', 'keydown', 'scroll', 'touchstart', 'mousemove'];
            events.forEach(event => {
                document.addEventListener(event, recordActivity, { passive: true });
            });

            // Also track visibility
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    recordActivity();
                }
            });

            // Start initial timer
            recordActivity();
        }

        // Initialize presence (called after auth check)
        setPresence('online');
        initActivityTracking();

        let userListVisible = false;
        function toggleUserList() {
            userListVisible = !userListVisible;
            document.getElementById('userList').style.display = userListVisible ? 'block' : 'none';
        }

        // Store online users for @mention autocomplete
        let onlineUsers = [];
        let onlineUsersDetailed = [];

        presenceRef.on('value', (snapshot) => {
            const users = [];
            snapshot.forEach((child) => {
                const data = child.val();
                if (data.user) {
                    users.push({
                        name: data.user,
                        uid: data.uid || child.key,
                        email: data.email || '',
                        username: data.username || '',
                        status: data.status || 'online',
                        lastActive: data.lastActive || 0
                    });
                }
            });

            // Sort: online first, then away, then by name
            users.sort((a, b) => {
                const statusOrder = { online: 0, away: 1, offline: 2 };
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }
                return a.name.localeCompare(b.name);
            });

            // Update count - only count online + away (not offline)
            const activeCount = users.filter(u => u.status !== 'offline').length;
            const onlineOnlyCount = users.filter(u => u.status === 'online').length;
            const awayCount = users.filter(u => u.status === 'away').length;

            let countText = onlineOnlyCount + ' online';
            if (awayCount > 0) countText += ', ' + awayCount + ' away';
            document.getElementById('onlineCount').textContent = countText + ' (click to see)';

            // Build user list for @mention autocomplete
            onlineUsers = users.map(u => u.name);
            onlineUsersDetailed = users;

            // Render with status indicators
            document.getElementById('userListNames').innerHTML = users.length > 0
                ? users.map(u => {
                    const color = u.status === 'online' ? '#22c55e' :
                                  u.status === 'away' ? '#eab308' : '#6b7280';
                    const statusText = u.status === 'away' ? ' (away)' : '';
                    return `<div style="padding: 6px 0; cursor: pointer; display: flex; align-items: center; gap: 8px;"
                                 onclick="insertMention('${u.name}')"
                                 onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                 onmouseout="this.style.background='transparent'">
                        <span style="width: 8px; height: 8px; border-radius: 50%; background: ${color}; flex-shrink: 0;"></span>
                        <span>${u.name}${statusText}</span>
                    </div>`;
                }).join('')
                : '<div style="opacity: 0.7;">No users online</div>';
        });

        function insertMention(username) {
            const input = document.getElementById('chatInput');
            input.value = '@' + username + ' ' + input.value;
            input.focus();
            document.getElementById('userList').style.display = 'none';
            userListVisible = false;
        }

        // ========== @MENTION AUTOCOMPLETE ==========
        let allRegisteredUsers = [];
        let mentionDropdownIndex = -1;
        const USER_CACHE_KEY = 'bsn9b_users_cache';
        const USER_CACHE_EXPIRY = 10 * 60 * 1000; // 10 minutes

        async function fetchAllUsers() {
            try {
                // Check cache first
                const cached = localStorage.getItem(USER_CACHE_KEY);
                if (cached) {
                    const { users, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < USER_CACHE_EXPIRY) {
                        allRegisteredUsers = users;
                        console.log('Loaded', allRegisteredUsers.length, 'users from cache');
                        await loadUserProfiles();
                        addUidsToRegisteredUsers();
                        return;
                    }
                }

                // Fetch fresh data
                const response = await fetch('https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec?action=getUsers');
                const data = await response.json();
                if (data.success && data.users) {
                    allRegisteredUsers = data.users
                        .filter(u => u.name && u.name.trim())
                        .map(u => ({
                            name: u.name.trim(),
                            firstName: u.name.trim().split(' ')[0],
                            email: u.email || ''
                        }));

                    // Cache the results
                    localStorage.setItem(USER_CACHE_KEY, JSON.stringify({
                        users: allRegisteredUsers,
                        timestamp: Date.now()
                    }));
                    console.log('Loaded', allRegisteredUsers.length, 'users from API, cached');
                    await loadUserProfiles();
                    addUidsToRegisteredUsers();
                }
            } catch (e) {
                console.log('Could not fetch users for @mention:', e);
                // Try to use expired cache as fallback
                const cached = localStorage.getItem(USER_CACHE_KEY);
                if (cached) {
                    allRegisteredUsers = JSON.parse(cached).users || [];
                    console.log('Using expired cache as fallback');
                    await loadUserProfiles();
                    addUidsToRegisteredUsers();
                }
            }
        }

        fetchAllUsers();

        const chatInput = document.getElementById('chatInput');
        const mentionDropdown = document.getElementById('mentionDropdown');

        if (chatInput) chatInput.addEventListener('input', function(e) {
            const value = this.value;
            const cursorPos = this.selectionStart;
            const textBeforeCursor = value.substring(0, cursorPos);
            const atMatch = textBeforeCursor.match(/@(\w*)$/);

            if (atMatch) {
                const searchTerm = atMatch[1].toLowerCase();
                showMentionDropdown(searchTerm);
            } else {
                hideMentionDropdown();
            }
        });

        if (chatInput) chatInput.addEventListener('keydown', function(e) {
            if (mentionDropdown.style.display === 'none') return;

            const items = mentionDropdown.querySelectorAll('.mention-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                mentionDropdownIndex = Math.min(mentionDropdownIndex + 1, items.length - 1);
                updateMentionHighlight(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                mentionDropdownIndex = Math.max(mentionDropdownIndex - 1, 0);
                updateMentionHighlight(items);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                if (mentionDropdownIndex >= 0 && items[mentionDropdownIndex]) {
                    e.preventDefault();
                    selectMention(items[mentionDropdownIndex].dataset.name);
                }
            } else if (e.key === 'Escape') {
                hideMentionDropdown();
            }
        });

        function showMentionDropdown(searchTerm) {
            const onlineSet = new Set(onlineUsers.map(u => u.toLowerCase()));
            let matches = [];

            onlineUsers.forEach(u => {
                if (u.toLowerCase().includes(searchTerm)) {
                    matches.push({ name: u, online: true });
                }
            });

            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                const fullName = u.name;
                if (!onlineSet.has(firstName.toLowerCase()) &&
                    (firstName.toLowerCase().includes(searchTerm) || fullName.toLowerCase().includes(searchTerm))) {
                    matches.push({ name: firstName, fullName: fullName, online: false });
                }
            });

            matches = matches.slice(0, 8);

            if (matches.length === 0) {
                hideMentionDropdown();
                return;
            }

            mentionDropdownIndex = 0;
            mentionDropdown.innerHTML = matches.map((m, i) => `
                <div class="mention-item" data-name="${m.name}"
                     style="padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; ${i === 0 ? 'background: #f0f7ff;' : ''}"
                     onclick="selectMention('${m.name}')"
                     onmouseover="this.style.background='#f0f7ff'"
                     onmouseout="this.style.background='${i === mentionDropdownIndex ? '#f0f7ff' : 'transparent'}'">
                    <span style="font-weight: 500;">@${m.name}${m.fullName && m.fullName !== m.name ? ' <span style="color:#888;font-weight:normal;">(' + m.fullName + ')</span>' : ''}</span>
                    ${m.online ? '<span style="font-size: 10px; background: #22c55e; color: white; padding: 2px 6px; border-radius: 10px;">online</span>' : ''}
                </div>
            `).join('');

            mentionDropdown.style.display = 'block';
        }

        function hideMentionDropdown() {
            mentionDropdown.style.display = 'none';
            mentionDropdownIndex = -1;
        }

        function updateMentionHighlight(items) {
            items.forEach((item, i) => {
                item.style.background = i === mentionDropdownIndex ? '#f0f7ff' : 'transparent';
            });
        }

        function selectMention(name) {
            const input = chatInput;
            const value = input.value;
            const cursorPos = input.selectionStart;

            const textBeforeCursor = value.substring(0, cursorPos);
            const atIndex = textBeforeCursor.lastIndexOf('@');

            if (atIndex !== -1) {
                const newValue = value.substring(0, atIndex) + '@' + name + ' ' + value.substring(cursorPos);
                input.value = newValue;

                const newCursorPos = atIndex + name.length + 2;
                input.setSelectionRange(newCursorPos, newCursorPos);
            }

            hideMentionDropdown();
            input.focus();
        }

        document.addEventListener('click', function(e) {
            if (chatInput && mentionDropdown && !chatInput.contains(e.target) && !mentionDropdown.contains(e.target)) {
                hideMentionDropdown();
            }
        });
        // ========== END CHAT SYSTEM ==========

        // Set welcome message
        document.getElementById('welcomeMessage').textContent = 'Welcome back, ' + displayName + '!';

        // Theme functions
        function initTheme() {
            const saved = localStorage.getItem('bsn9b_theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcon();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('bsn9b_theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const themeMenuIcon = document.getElementById('themeMenuIcon');
            const themeMenuText = document.getElementById('themeMenuText');
            if (themeMenuIcon) {
                themeMenuIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            }
            if (themeMenuText) {
                themeMenuText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            }
        }

        // More menu toggle
        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const isExpanded = menu.classList.toggle('show');
            if (moreBtn) {
                moreBtn.setAttribute('aria-expanded', isExpanded);
            }
        }

        // Close more menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const moreBtnClicked = e.target.closest('.toolbar-item');
            if (!menu.contains(e.target) && (!moreBtnClicked || !moreBtnClicked.onclick?.toString().includes('toggleMoreMenu'))) {
                menu.classList.remove('show');
                if (moreBtn) {
                    moreBtn.setAttribute('aria-expanded', 'false');
                }
            }
        });

        // Lock/Unlock
        function lockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'flex';
        }

        function unlockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'none';
        }

        // Logout
        function logout() {
            endSessionTracking('logout');
            // Clean presence before signing out
            const uid = getCurrentUserUid();
            if (uid) {
                presenceRef.child(uid).remove().catch(() => {});
            }
            // Clear idle/logout timers
            clearTimeout(idleTimer);
            clearTimeout(logoutTimer);
            clearTimeout(activityDebounceTimer);

            auth.signOut().then(() => {
                localStorage.removeItem('bsn9b_auth');
                localStorage.removeItem('bsn9b_user');
                localStorage.removeItem('bsn9b_displayName');
                localStorage.removeItem('bsn9b_uid');
                clearSessionTracking();
                window.location.href = '/';
            });
        }


        // ========== AI NURSING COMPANION ==========
        const AI_API_URL = 'https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec';
        var aiOpen = false;
        let aiConversation = [];

        const AI_SYSTEM_PROMPT = `You are a helpful nursing education assistant for BSN nursing students. Your role is to:
- Explain nursing concepts, procedures, and pathophysiology clearly
- Provide drug information including mechanism, side effects, and nursing considerations
- Help develop care plans using NANDA-I diagnoses, NIC interventions, and NOC outcomes
- Generate NCLEX-style practice questions with detailed rationales
- Explain lab values and their clinical significance
- Guide through clinical scenarios and critical thinking

Important guidelines:
- Always emphasize this is for EDUCATIONAL purposes only, not actual patient care
- Encourage students to verify information with their instructors and official resources
- Be concise but thorough - nursing students are busy
- Use proper medical terminology while explaining in accessible terms
- When discussing medications, always mention common nursing considerations
- For NCLEX questions, provide the answer AND detailed rationales for all options`;

        function toggleAI() {
            aiOpen = !aiOpen;
            const aiBox = document.getElementById('aiBox');
            if (aiOpen) {
                aiBox.style.display = 'flex';
                document.getElementById('aiInput').focus();
            } else {
                aiBox.style.display = 'none';
            }
            document.getElementById('aiToggle').style.transform = aiOpen ? 'scale(0.9)' : 'scale(1)';
        }

        function aiQuickAction(type) {
            const input = document.getElementById('aiInput');
            switch(type) {
                case 'drug':
                    input.value = 'Tell me about the medication: ';
                    input.focus();
                    break;
                case 'careplan':
                    input.value = 'Help me create a care plan for a patient with: ';
                    input.focus();
                    break;
                case 'nclex':
                    input.value = 'Give me an NCLEX practice question about: ';
                    input.focus();
                    break;
                case 'labs':
                    input.value = 'Explain the lab value and nursing implications: ';
                    input.focus();
                    break;
            }
        }

        function addAIMessage(text, isUser) {
            const container = document.getElementById('aiMessages');
            const msgDiv = document.createElement('div');
            msgDiv.style.cssText = `
                margin-bottom: 12px;
                display: flex;
                flex-direction: column;
                align-items: ${isUser ? 'flex-end' : 'flex-start'};
            `;

            // Format AI responses with markdown-like styling
            let formattedText = text;
            if (!isUser) {
                // Convert **bold** to <strong>
                formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Convert bullet points
                formattedText = formattedText.replace(/^[\-\‚Ä¢]\s/gm, '‚Ä¢ ');
                // Convert newlines to <br>
                formattedText = formattedText.replace(/\n/g, '<br>');
            }

            msgDiv.innerHTML = `
                <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${isUser ? 'You' : 'ü©∫ AI Assistant'}</div>
                <div style="background: ${isUser ? 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)' : 'linear-gradient(135deg, #0d9488 0%, #14b8a6 100%)'}; color: white; padding: 12px 16px; border-radius: ${isUser ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 90%; word-wrap: break-word; font-size: 14px; line-height: 1.5;">
                    ${isUser ? text.replace(/</g, '&lt;').replace(/>/g, '&gt;') : formattedText}
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showAITyping() {
            const container = document.getElementById('aiMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'aiTyping';
            typingDiv.style.cssText = 'margin-bottom: 12px; display: flex; flex-direction: column; align-items: flex-start;';
            typingDiv.innerHTML = `
                <div style="font-size: 10px; color: #888; margin-bottom: 3px;">ü©∫ AI Assistant</div>
                <div style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 12px 16px; border-radius: 16px 16px 16px 4px; font-size: 14px;">
                    <span class="typing-dots">Thinking<span>.</span><span>.</span><span>.</span></span>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function hideAITyping() {
            const typing = document.getElementById('aiTyping');
            if (typing) typing.remove();
        }

        async function sendAIMessage(event) {
            event.preventDefault();
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            const sendBtn = document.querySelector('#aiBox button[type="submit"]');

            if (!message) return;

            // Add user message to UI
            addAIMessage(message, true);
            input.value = '';
            if (sendBtn) sendBtn.disabled = true;

            // Add to conversation history
            aiConversation.push({ role: 'user', content: message });

            // Show typing indicator
            showAITyping();

            try {
                const response = await fetch(AI_API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        messages: aiConversation,
                        systemPrompt: AI_SYSTEM_PROMPT
                    })
                });

                const data = await response.json();
                hideAITyping();

                if (data.success && data.response) {
                    addAIMessage(data.response, false);
                    aiConversation.push({ role: 'assistant', content: data.response });

                    // Keep conversation history manageable (last 10 exchanges)
                    if (aiConversation.length > 20) {
                        aiConversation = aiConversation.slice(-20);
                    }
                } else {
                    addAIMessage('Sorry, I encountered an error. Please try again. ' + (data.error || ''), false);
                }
            } catch (error) {
                hideAITyping();
                console.error('AI API Error:', error);
                addAIMessage('Sorry, I could not connect to the AI service. Please check your connection and try again.', false);
            }

            if (sendBtn) sendBtn.disabled = false;
            input.focus();
        }

        // Add typing animation CSS
        const aiStyle = document.createElement('style');
        aiStyle.textContent = `
            .typing-dots span {
                animation: blink 1.4s infinite;
                animation-fill-mode: both;
            }
            .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
            .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
            @keyframes blink {
                0%, 80%, 100% { opacity: 0; }
                40% { opacity: 1; }
            }
        `;
        document.head.appendChild(aiStyle);

        // Initialize
        initTheme();

        // ========== FIREBASE LISTENER CLEANUP ==========
        // Clean up Firebase listeners on page unload to prevent memory leaks
        function cleanupFirebaseListeners() {
            try {
                if (typeof announcementsRef !== 'undefined') announcementsRef.off();
                if (typeof bannedRef !== 'undefined') bannedRef.off();
                if (typeof chatRef !== 'undefined') chatRef.off();
                if (typeof connectedRef !== 'undefined') connectedRef.off();
                if (typeof directMessagesRef !== 'undefined') directMessagesRef.off();
                if (typeof presenceRef !== 'undefined') presenceRef.off();
                console.log('Firebase listeners cleaned up');
            } catch (e) {
                console.log('Error cleaning up listeners:', e);
            }
        }

        window.addEventListener('beforeunload', cleanupFirebaseListeners);
        window.addEventListener('pagehide', cleanupFirebaseListeners);

        // ========== KEYBOARD NAVIGATION ==========
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close modals
                document.querySelectorAll('.modal-overlay:not(.hidden)').forEach(m => m.classList.add('hidden'));
                // Close more menu
                const moreMenu = document.getElementById('moreMenu');
                if (moreMenu) moreMenu.classList.remove('show');
                // Close chat box
                const chatBox = document.getElementById('chatBox');
                if (chatBox && chatBox.style.display !== 'none') {
                    chatBox.style.display = 'none';
                    chatOpen = false;
                }
            }
        });

        // ========== SWIPE GESTURES FOR MOBILE ==========
        (function() {
            let touchStartX = 0;
            let touchStartY = 0;
            const SWIPE_THRESHOLD = 80;
            const SWIPE_RESTRAINT = 100;

            function addSwipeToClose(element, closeCallback, direction) {
                if (!element) return;
                element.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                }, { passive: true });
                element.addEventListener('touchend', function(e) {
                    const touchEndX = e.changedTouches[0].screenX;
                    const touchEndY = e.changedTouches[0].screenY;
                    const diffX = touchEndX - touchStartX;
                    const diffY = touchEndY - touchStartY;
                    if (diffY > SWIPE_THRESHOLD && Math.abs(diffX) < SWIPE_RESTRAINT) { closeCallback(); return; }
                    if (Math.abs(diffX) > SWIPE_THRESHOLD && Math.abs(diffY) < SWIPE_RESTRAINT) {
                        if (direction === 'right' && diffX > 0) closeCallback();
                        if (direction === 'left' && diffX < 0) closeCallback();
                    }
                }, { passive: true });
            }
            addSwipeToClose(document.getElementById('chatBox'), function() { if (chatOpen) toggleChat(); }, 'right');
            addSwipeToClose(document.getElementById('aiBox'), function() { if (aiOpen) toggleAI(); }, 'left');
        })();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>

</body>
</html>
