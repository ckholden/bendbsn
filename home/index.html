<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com https://cdn.emailjs.com https://*.firebaseio.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; connect-src 'self' https://www.gstatic.com https://script.google.com https://script.googleusercontent.com https://*.firebaseio.com https://*.googleapis.com https://formsubmit.co https://en.wikipedia.org wss://*.firebaseio.com; img-src 'self' data: blob: https:;">
    <script>if(location.protocol !== 'https:' && location.hostname !== 'localhost'){location.replace('https:' + location.href.substring(location.protocol.length));}</script>
    <script>
        if (localStorage.getItem('bsn9b_auth') !== 'true') {
            window.location.href = '/';
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#0d1f2d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BendBSN">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="stylesheet" href="/shared/header.css">
    <link rel="stylesheet" href="/shared/toast.css">
    <link rel="stylesheet" href="/shared/clinical-ui.css">
    <link rel="stylesheet" href="/shared/app-shell.css">
    <title>BendBSN ‚Äî Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* ---- Base ---- */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }


        .status-online  { background: #22c55e; }
        .status-away    { background: #eab308; }
        .status-offline { background: #6b7280; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            background: var(--clx-bg-canvas);
            color: var(--clx-text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            padding-bottom: 60px;
        }

        /* ================================================
           CONTEXT BAR
        ================================================ */
        .dash-context-bar {
            background: var(--clx-bg-surface);
            border-bottom: 1px solid var(--clx-border);
            padding: 0 16px;
            display: flex;
            align-items: stretch;
            gap: 0;
            font-size: 13px;
            overflow-x: auto;
            scrollbar-width: none;
            flex-shrink: 0;
        }
        .dash-context-bar::-webkit-scrollbar { display: none; }

        .ctx-item {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 8px 16px;
            border-right: 1px solid var(--clx-border);
            white-space: nowrap;
            min-width: 0;
        }
        .ctx-item:last-child { border-right: none; }

        .ctx-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--clx-text-muted);
            margin-bottom: 1px;
        }
        .ctx-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--clx-text-primary);
        }
        .ctx-value.editable {
            cursor: pointer;
            border-bottom: 1px dashed var(--clx-border-strong);
        }
        .ctx-value.editable:hover {
            color: var(--clx-accent);
            border-bottom-color: var(--clx-accent);
        }
        .ctx-value.accent { color: var(--clx-accent); }

        /* ================================================
           MAIN DASHBOARD AREA
        ================================================ */
        .dash-page {
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
            padding: 14px 16px 16px;
            flex: 1;
        }

        /* ================================================
           ACTION ROW
        ================================================ */
        .dash-action-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 14px;
        }

        .dash-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 6px;
            border: 1px solid var(--clx-border);
            background: var(--clx-bg-surface);
            color: var(--clx-text-primary);
            cursor: pointer;
            text-decoration: none;
            font-family: inherit;
            white-space: nowrap;
        }
        .dash-btn:hover {
            background: var(--clx-bg-surface-2);
            border-color: var(--clx-border-strong);
        }
        .dash-btn.primary {
            background: var(--clx-accent);
            color: #fff;
            border-color: var(--clx-accent);
        }
        .dash-btn.primary:hover {
            background: var(--clx-accent-hover);
            border-color: var(--clx-accent-hover);
        }
        .dash-btn:focus-visible {
            outline: 2px solid var(--clx-focus);
            outline-offset: 2px;
        }

        /* ================================================
           DASHBOARD GRID
        ================================================ */
        .dash-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* ================================================
           PANELS
        ================================================ */
        .dash-panel {
            background: var(--clx-bg-surface);
            border: 1px solid var(--clx-border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .dash-panel-hd {
            background: var(--clx-bg-surface-2);
            border-bottom: 1px solid var(--clx-border);
            padding: 9px 14px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            color: var(--clx-text-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            flex-shrink: 0;
        }

        .dash-panel-bd {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            max-height: 260px;
        }

        .dash-panel-ft {
            border-top: 1px solid var(--clx-border);
            padding: 8px 14px;
            flex-shrink: 0;
        }
        .dash-panel-ft a {
            font-size: 12px;
            color: var(--clx-accent);
            text-decoration: none;
            font-weight: 600;
        }
        .dash-panel-ft a:hover { text-decoration: underline; }

        .dash-empty {
            padding: 20px 14px;
            font-size: 13px;
            color: var(--clx-text-muted);
            text-align: center;
        }

        /* ---- Note items ---- */
        .dash-note-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 14px;
            border-bottom: 1px solid var(--clx-border);
            cursor: pointer;
            text-decoration: none;
        }
        .dash-note-item:last-child { border-bottom: none; }
        .dash-note-item:hover { background: var(--clx-accent-subtle); }

        .dash-note-type {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--clx-accent-subtle);
            color: var(--clx-accent);
            white-space: nowrap;
            flex-shrink: 0;
        }
        .dash-note-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--clx-text-primary);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .dash-note-date {
            font-size: 11px;
            color: var(--clx-text-muted);
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* ---- Quick ref links ---- */
        .dash-ref-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 9px 14px;
            border-bottom: 1px solid var(--clx-border);
            font-size: 13px;
            font-weight: 500;
            color: var(--clx-text-primary);
            text-decoration: none;
        }
        .dash-ref-link:last-child { border-bottom: none; }
        .dash-ref-link:hover {
            background: var(--clx-accent-subtle);
            color: var(--clx-accent);
        }
        .dash-ref-link::before {
            content: '‚Üí';
            font-size: 11px;
            color: var(--clx-text-muted);
            flex-shrink: 0;
        }

        /* ---- Structured Reminders ---- */
        .rem-add-row {
            display: flex;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid var(--clx-border);
            flex-wrap: wrap;
            align-items: center;
        }
        .rem-input {
            flex: 1;
            min-width: 140px;
        }
        .rem-date {
            width: 140px;
        }
        .rem-sel {
            width: 90px;
        }
        .rem-add-btn {
            white-space: nowrap;
            padding: 7px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 6px;
            border: 1px solid var(--clx-accent);
            background: var(--clx-accent);
            color: #fff;
            cursor: pointer;
            font-family: inherit;
        }
        .rem-add-btn:hover { background: var(--clx-accent-hover); }
        .rem-list {
            flex: 1;
            overflow-y: auto;
            max-height: 240px;
        }
        .rem-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 9px 12px;
            border-bottom: 1px solid var(--clx-border);
            font-size: 13px;
        }
        .rem-item:last-child { border-bottom: none; }
        .rem-item.overdue { background: var(--clx-danger-bg); }
        .rem-text {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--clx-text-primary);
        }
        .rem-due {
            font-size: 11px;
            color: var(--clx-text-muted);
            white-space: nowrap;
            flex-shrink: 0;
        }
        .rem-due.overdue { color: var(--clx-danger); font-weight: 600; }
        .rem-due.today { color: var(--clx-warning); font-weight: 600; }
        .rem-actions { display: flex; gap: 2px; flex-shrink: 0; }
        .rem-del-btn {
            background: none; border: none; cursor: pointer;
            color: var(--clx-text-muted); font-size: 14px; padding: 2px 4px;
            border-radius: 4px;
        }
        .rem-del-btn:hover { color: var(--clx-danger); background: var(--clx-danger-bg); }
        .rem-email-btn {
            background: none; border: none; cursor: pointer;
            color: var(--clx-text-muted); font-size: 13px; padding: 2px 4px;
            border-radius: 4px;
        }
        .rem-email-btn:hover { color: var(--clx-accent); background: var(--clx-accent-subtle); }
        .rem-empty {
            padding: 20px 14px;
            font-size: 13px;
            color: var(--clx-text-muted);
            text-align: center;
        }


        /* ================================================
           DOCUMENTATION HERO
        ================================================ */
        .doc-hero {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            background: linear-gradient(135deg, var(--clx-accent, #0f7490) 0%, #0d5f78 100%);
            border-radius: 10px;
            padding: 20px 24px;
            margin-bottom: 14px;
            color: #fff;
        }
        .doc-hero-left { flex: 1; min-width: 0; }
        .doc-hero-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            opacity: 0.75;
            margin-bottom: 4px;
        }
        .doc-hero-title {
            font-size: 22px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 4px;
        }
        .doc-hero-sub {
            font-size: 13px;
            opacity: 0.85;
            margin-bottom: 14px;
        }
        .doc-hero-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .doc-cta-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 700;
            border-radius: 7px;
            border: none;
            background: #fff;
            color: var(--clx-accent, #0f7490);
            cursor: pointer;
            text-decoration: none;
            font-family: inherit;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .doc-cta-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .doc-hero-sec-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 9px 16px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 7px;
            border: 1.5px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.12);
            color: #fff;
            cursor: pointer;
            font-family: inherit;
        }
        .doc-hero-sec-btn:hover { background: rgba(255,255,255,0.2); }
        .doc-hero-stat {
            text-align: center;
            flex-shrink: 0;
        }
        .doc-hero-num {
            font-size: 36px;
            font-weight: 700;
            line-height: 1;
        }
        .doc-hero-lbl {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 2px;
        }
        @media (max-width: 600px) {
            .doc-hero { flex-direction: column; align-items: flex-start; }
            .doc-hero-stat { display: none; }
        }

        /* ================================================
           TOOLS ROW
        ================================================ */
        .tools-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        .tool-chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 20px;
            border: 1px solid var(--clx-border);
            background: var(--clx-bg-surface);
            color: var(--clx-text-secondary);
            text-decoration: none;
            font-family: inherit;
            cursor: pointer;
            white-space: nowrap;
        }
        .tool-chip:hover {
            background: var(--clx-accent-subtle);
            color: var(--clx-accent);
            border-color: var(--clx-accent-subtle);
        }

        /* Collapsible panel body */
        .panel-body-collapsed { display: none !important; }

        /* ================================================
           BOTTOM TOOLBAR
        ================================================ */
        .bottom-toolbar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: var(--clx-bg-surface);
            border-top: 1px solid var(--clx-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 8px;
            color: var(--clx-text-secondary);
            text-decoration: none;
            font-size: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }
        .toolbar-item:hover, .toolbar-item.active { color: var(--clx-accent); }
        .toolbar-item .icon { font-size: 22px; margin-bottom: 2px; }
        .toolbar-item .label { font-weight: 600; }

        .more-menu {
            position: fixed;
            bottom: 70px; right: 10px;
            background: var(--clx-bg-surface);
            border: 1px solid var(--clx-border);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 6px 0;
            display: none;
            z-index: 1001;
            min-width: 160px;
        }
        .more-menu.show { display: block; }
        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            color: var(--clx-text-primary);
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
        }
        .more-menu-item:hover { background: var(--clx-accent-subtle); color: var(--clx-accent); }
        .more-menu-item .menu-icon { font-size: 16px; }

        /* ================================================
           MODALS (feedback)
        ================================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.hidden { display: none; }
        .modal-content {
            background: var(--clx-bg-surface);
            border: 1px solid var(--clx-border);
            border-radius: 10px;
            padding: 22px 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            color: var(--clx-text-primary);
        }
        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--clx-border);
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
            background: var(--clx-bg-surface);
            color: var(--clx-text-primary);
            font-family: inherit;
        }
        .modal-content textarea { min-height: 100px; resize: vertical; }

        /* ================================================
           LOCK SCREEN
        ================================================ */
        #lockScreenOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: #0d1f2d;
            z-index: 99999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* ================================================
           TOASTS
        ================================================ */
        @media (pointer: coarse) {
            .dash-btn, .toolbar-item, .more-menu-item { min-height: 44px; }
        }
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(60px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <!-- Site header -->
    <header class="site-header">
        <a href="/home/" class="logo-link"><img src="/logo-dark.svg" alt="BendBSN" class="site-logo"></a>
        <div class="header-actions">
            <div class="online-count" id="onlineCount" onclick="toggleUserList()" title="Online users" aria-label="Online users" role="button" tabindex="0">
                <span class="online-dot"></span>
                <span class="online-count-text" id="onlineCountText">‚Äî</span>
            </div>
        </div>
    </header>

    <!-- Toast container -->

    <!-- App Shell -->
    <div class="clx-shell">

    <!-- Left Sidebar (desktop only) -->
    <aside class="clx-sidebar" id="appSidebar" role="navigation" aria-label="App navigation">
        <div class="clx-sidebar-section">Navigation</div>
        <a href="/home/" class="clx-sidebar-item active" data-page="home">
            <span class="clx-sidebar-icon">üè†</span>
            <span class="clx-sidebar-label">Home</span>
        </a>
        <a href="/app/" class="clx-sidebar-item" data-page="app">
            <span class="clx-sidebar-icon">üìù</span>
            <span class="clx-sidebar-label">RN Notes</span>
        </a>
        <a href="/chat/" class="clx-sidebar-item" data-page="chat" target="_blank">
            <span class="clx-sidebar-icon">üí¨</span>
            <span class="clx-sidebar-label">Chat</span>
        </a>
        <a href="/ai/" class="clx-sidebar-item" data-page="ai" target="_blank">
            <span class="clx-sidebar-icon">ü©∫</span>
            <span class="clx-sidebar-label">AI Assistant</span>
        </a>
        <a href="/community/" class="clx-sidebar-item" data-page="community">
            <span class="clx-sidebar-icon">üë•</span>
            <span class="clx-sidebar-label">Community</span>
        </a>
        <a href="/resources/" class="clx-sidebar-item" data-page="resources">
            <span class="clx-sidebar-icon">üìö</span>
            <span class="clx-sidebar-label">Resources</span>
        </a>
        <div class="clx-sidebar-section" style="margin-top:8px;">Tools</div>
        <a href="/clinical/" class="clx-sidebar-item" data-page="clinical">
            <span class="clx-sidebar-icon">ü©ª</span>
            <span class="clx-sidebar-label">Clinical Packet</span>
        </a>
        <a href="/apa/" class="clx-sidebar-item" data-page="apa">
            <span class="clx-sidebar-icon">üìÑ</span>
            <span class="clx-sidebar-label">APA Generator</span>
        </a>
        <a href="/labsched/" class="clx-sidebar-item" data-page="labsched">
            <span class="clx-sidebar-icon">üóìÔ∏è</span>
            <span class="clx-sidebar-label">Sched Generator</span>
        </a>
        <div class="clx-sidebar-section" style="margin-top:8px;">Account</div>
        <button class="clx-sidebar-item" onclick="toggleDarkMode()">
            <span class="clx-sidebar-icon" id="sidebarThemeIcon">üåô</span>
            <span class="clx-sidebar-label">Dark Mode</span>
        </button>
        <button class="clx-sidebar-item" onclick="lockScreen()">
            <span class="clx-sidebar-icon">üîí</span>
            <span class="clx-sidebar-label">Lock</span>
        </button>
        <button class="clx-sidebar-item" onclick="logout()">
            <span class="clx-sidebar-icon">üö™</span>
            <span class="clx-sidebar-label">Logout</span>
        </button>
        <button class="clx-sidebar-toggle" onclick="toggleSidebar()" id="sidebarToggle" aria-label="Collapse sidebar">
            <span class="clx-sidebar-icon" id="sidebarToggleIcon">‚óÄ</span>
            <span class="clx-sidebar-toggle-label">Collapse</span>
        </button>
    </aside>

    <!-- Main content -->
    <main class="clx-main" role="main">

    <!-- Alert / FYI banners -->
    <div id="alertBanner" style="display:none;position:fixed;top:0;left:0;right:0;background:#dc2626;color:white;padding:10px 20px;text-align:center;font-weight:600;font-size:13px;z-index:10000;animation:softFlashAlert 2s ease-in-out infinite;">
        <span id="alertText"></span>
        <span style="position:absolute;right:15px;font-size:11px;opacity:.8;">‚ö† ALERT</span>
    </div>
    <div id="fyiBanner" style="display:none;position:fixed;top:0;left:0;right:0;background:#d97706;color:#1a1a2e;padding:10px 20px;text-align:center;font-weight:600;font-size:13px;z-index:9999;animation:softFlashFyi 2s ease-in-out infinite;">
        <span id="fyiText"></span>
        <span style="position:absolute;right:15px;font-size:11px;opacity:.7;">‚Ñπ FYI</span>
    </div>

    <!-- Lock screen -->
    <div id="lockScreenOverlay">
        <div style="text-align:center;color:white;">
            <div style="font-size:60px;margin-bottom:16px;">üîí</div>
            <h1 style="font-size:28px;margin-bottom:8px;">BendBSN</h1>
            <p style="font-size:15px;opacity:.7;margin-bottom:32px;">Portal Locked</p>
            <button onclick="unlockScreen()" style="background:var(--clx-accent);color:white;border:none;padding:14px 40px;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;">üîì Unlock</button>
        </div>
    </div>


    <!-- Context bar -->
    <div class="dash-context-bar" id="dashContextBar">
        <div class="ctx-item">
            <span class="ctx-label">Student</span>
            <span class="ctx-value" id="ctxName">‚Äî</span>
        </div>
        <div class="ctx-item">
            <span class="ctx-label">Term</span>
            <span class="ctx-value editable" id="ctxTerm" onclick="editCtx('term')" title="Click to edit">Spring 2026</span>
        </div>
        <div class="ctx-item">
            <span class="ctx-label">Next Exam</span>
            <span class="ctx-value editable" id="ctxExam" onclick="editCtx('exam')" title="Click to edit">‚Äî</span>
        </div>
        <div class="ctx-item">
            <span class="ctx-label">Graduation</span>
            <span class="ctx-value editable" id="ctxGrad" onclick="editCtx('grad')" title="Click to set graduation month">‚Äî</span>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dash-page">

        <!-- Documentation Hero -->
        <div class="doc-hero">
            <div class="doc-hero-left">
                <div class="doc-hero-label">Nursing Documentation</div>
                <div class="doc-hero-title">Start Documenting</div>
                <div class="doc-hero-sub">Build a professional nursing note in minutes.</div>
                <div class="doc-hero-actions">
                    <a href="/app/" class="doc-cta-btn">üìù Start New Note</a>
                </div>
            </div>
            <div class="doc-hero-stat">
                <div class="doc-hero-num" id="docHeroNoteCount">‚Äî</div>
                <div class="doc-hero-lbl">Notes Saved</div>
            </div>
        </div>

        <!-- Recent Notes -->
        <div class="dash-panel" style="margin-bottom:12px;">
            <div class="dash-panel-hd">
                Recent Notes
                <a href="/app/" style="font-size:11px;color:var(--clx-accent);font-weight:600;text-decoration:none;margin-left:auto;">+ New Note</a>
            </div>
            <div class="dash-panel-bd" id="recentNotesList">
                <div class="dash-empty">Loading notes‚Ä¶</div>
            </div>
        </div>

        <!-- Secondary Tools Row -->
        <div class="tools-row">
            <a class="tool-chip" href="/chat/">üí¨ Chat</a>
            <a class="tool-chip" href="/ai/">ü©∫ AI</a>
            <a class="tool-chip" href="/resources/">üìö Resources</a>
            <a class="tool-chip" href="/community/">üë• Community</a>
            <a class="tool-chip" href="/clinical/">üìã Clinical Packet</a>
            <a class="tool-chip" id="apaToolChip" href="/apa/">üìÑ APA Generator</a>
            <a class="tool-chip" href="/labsched/">üóì Lab Sched</a>
        </div>

        <!-- Collapsible reference + skills grid -->
        <div class="dash-grid" style="margin-bottom:12px;">

            <!-- Quick Reference (collapsible) -->
            <div class="dash-panel">
                <div class="dash-panel-hd" onclick="toggleHomePanel('quickRef')" style="cursor:pointer;user-select:none;">
                    Quick Reference
                    <span id="quickRefChev" style="font-size:11px;margin-left:auto;opacity:0.6;">‚ñº</span>
                </div>
                <div class="dash-panel-bd panel-body-collapsed" id="quickRefBody">
                    <a class="dash-ref-link" href="/resources/">Vital Signs Reference</a>
                    <a class="dash-ref-link" href="/resources/">Lab Values</a>
                    <a class="dash-ref-link" href="/resources/">Dosage Calculator</a>
                    <a class="dash-ref-link" href="/resources/">IV Drip Rate</a>
                    <a class="dash-ref-link" href="/resources/">Glasgow Coma Scale</a>
                    <a class="dash-ref-link" href="/resources/">APGAR Score</a>
                    <a class="dash-ref-link" href="/resources/">SBAR Template</a>
                    <a class="dash-ref-link" href="/resources/">Drug Lookup (RxNav)</a>
                    <a class="dash-ref-link" href="/ai/">Ask AI Nursing Assistant</a>
                </div>
            </div>


        </div><!-- /dash-grid -->

        <!-- Structured Reminders (full width) -->
        <div class="dash-panel">
            <div class="dash-panel-hd">
                My Reminders
                <span class="pill pill-neutral" id="reminderCount" style="font-size:10px;text-transform:none;letter-spacing:0;font-weight:600;">0</span>
            </div>
            <div class="dash-panel-bd" style="max-height:none; flex:1; display:flex; flex-direction:column; padding:0;">
                <div class="rem-add-row">
                    <input id="remText" type="text" placeholder="New reminder‚Ä¶" class="rem-input"
                        onkeydown="if(event.key==='Enter')addReminder()">
                    <input id="remDue" type="date" class="rem-date">
                    <select id="remPriority" class="rem-sel">
                        <option value="med">Med</option>
                        <option value="high">‚ö° High</option>
                        <option value="low">Low</option>
                    </select>
                    <button onclick="addReminder()" class="rem-add-btn">+ Add</button>
                </div>
                <div id="reminderList" class="rem-list"></div>
            </div>
        </div>

    </div><!-- /dash-page -->

    </main><!-- /clx-main -->
    </div><!-- /clx-shell -->

    <!-- User list dropdown (online presence) -->
    <div id="userListDropdown" style="display:none;position:fixed;top:56px;right:10px;background:var(--clx-bg-surface);border:1px solid var(--clx-border);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.15);padding:8px 0;min-width:180px;z-index:1001;max-height:300px;overflow-y:auto;">
        <div style="padding:8px 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--clx-text-muted);border-bottom:1px solid var(--clx-border);margin-bottom:4px;">Online Now</div>
        <div id="userListNames"></div>
    </div>

    <!-- Bottom Toolbar -->
    <nav class="bottom-toolbar" role="navigation" aria-label="Main navigation">
        <a href="/home/" class="toolbar-item active" aria-label="Home" aria-current="page">
            <span class="icon" aria-hidden="true">üè†</span>
            <span class="label">Home</span>
        </a>
        <a href="/app/" class="toolbar-item" aria-label="RN Notes">
            <span class="icon" aria-hidden="true">üìù</span>
            <span class="label">RN Notes</span>
        </a>
        <a href="/chat/" class="toolbar-item" aria-label="Chat">
            <span class="icon" aria-hidden="true">üí¨</span>
            <span class="label">Chat</span>
        </a>
        <a href="/ai/" class="toolbar-item" aria-label="AI Assistant">
            <span class="icon" aria-hidden="true">ü©∫</span>
            <span class="label">AI</span>
        </a>
        <a href="/community/" class="toolbar-item" aria-label="Community">
            <span class="icon" aria-hidden="true">üë•</span>
            <span class="label">Community</span>
        </a>
        <a href="/resources/" class="toolbar-item" aria-label="Resources">
            <span class="icon" aria-hidden="true">üìö</span>
            <span class="label">Resources</span>
        </a>
        <button class="toolbar-item" onclick="toggleMoreMenu()" aria-label="More options" aria-expanded="false" aria-controls="moreMenu">
            <span class="icon" aria-hidden="true">‚ãØ</span>
            <span class="label">More</span>
        </button>
    </nav>

    <!-- More Menu -->
    <div id="moreMenu" class="more-menu" role="menu" aria-label="More options menu">
        <button class="more-menu-item" onclick="toggleDarkMode();toggleMoreMenu();" role="menuitem">
            <span class="menu-icon" id="themeMenuIcon" aria-hidden="true">üåô</span>
            <span id="themeMenuText">Dark Mode</span>
        </button>
        <button class="more-menu-item" onclick="lockScreen();toggleMoreMenu();" role="menuitem">
            <span class="menu-icon" aria-hidden="true">üîí</span>
            <span>Lock Screen</span>
        </button>
        <button class="more-menu-item" onclick="toggleFullscreen();toggleMoreMenu();" role="menuitem" id="fullscreenBtn">
            <span class="menu-icon" id="fullscreenIcon" aria-hidden="true">‚õ∂</span>
            <span id="fullscreenText">Full Screen</span>
        </button>
        <a href="/labsched/" class="more-menu-item" role="menuitem" style="text-decoration:none;color:inherit;">
            <span class="menu-icon" aria-hidden="true">üìÖ</span>
            <span>Sched Generator</span>
        </a>
        <a href="/apa/" class="more-menu-item" role="menuitem" id="apaMenuLink" style="text-decoration:none;color:inherit;">
            <span class="menu-icon" aria-hidden="true">üìÑ</span>
            <span>APA Generator</span>
        </a>
        <a href="/clinical/" class="more-menu-item" role="menuitem" id="clinicalMenuLink" style="text-decoration:none;color:inherit;">
            <span class="menu-icon" aria-hidden="true">üìã</span>
            <span>Clinical Packet</span>
        </a>
        <button class="more-menu-item" onclick="document.getElementById('feedbackModal').classList.remove('hidden');toggleMoreMenu();" role="menuitem">
            <span class="menu-icon" aria-hidden="true">üí°</span>
            <span>Feedback</span>
        </button>
        <button class="more-menu-item" onclick="logout();" role="menuitem">
            <span class="menu-icon" aria-hidden="true">üö™</span>
            <span>Logout</span>
        </button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h2 style="font-size:16px;font-weight:700;">üí° Send Feedback</h2>
                <button onclick="document.getElementById('feedbackModal').classList.add('hidden')" style="background:none;border:none;font-size:22px;cursor:pointer;color:var(--clx-text-muted);">&times;</button>
            </div>
            <form action="https://formsubmit.co/christiankholden@gmail.com" method="POST">
                <input type="hidden" name="_subject" value="BendBSN Feedback">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_template" value="table">
                <label style="display:block;margin-bottom:4px;font-size:12px;font-weight:700;color:var(--clx-text-secondary);">Type</label>
                <select name="type" required>
                    <option value="bug">üêõ Bug Report</option>
                    <option value="feature">‚ú® Feature Request</option>
                    <option value="phrase">üí¨ Phrase Suggestion</option>
                    <option value="feedback" selected>üìù General Feedback</option>
                </select>
                <label style="display:block;margin-bottom:4px;font-size:12px;font-weight:700;color:var(--clx-text-secondary);">Name</label>
                <input type="text" name="name" required placeholder="Your name">
                <label style="display:block;margin-bottom:4px;font-size:12px;font-weight:700;color:var(--clx-text-secondary);">Message</label>
                <textarea name="message" required placeholder="Describe your feedback‚Ä¶"></textarea>
                <button type="submit" style="width:100%;padding:10px;background:var(--clx-accent);color:white;border:none;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;">Send Feedback</button>
            </form>
        </div>
    </div>

    <script>
        // ========== FULLSCREEN ==========
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                const el = document.documentElement;
                if (el.requestFullscreen) el.requestFullscreen();
                else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                updateFullscreenUI(true);
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                updateFullscreenUI(false);
            }
        }
        function updateFullscreenUI(fs) {
            const t = document.getElementById('fullscreenText');
            if (t) t.textContent = fs ? 'Exit Full Screen' : 'Full Screen';
        }
        document.addEventListener('fullscreenchange', () => updateFullscreenUI(!!document.fullscreenElement));
        document.addEventListener('webkitfullscreenchange', () => updateFullscreenUI(!!document.webkitFullscreenElement));

        // ========== TOAST ==========

        // ========== FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAmr2W8mekSPJ2pXM3gz1FvarfSBddpfLM",
            authDomain: "bendbsn-17377.firebaseapp.com",
            databaseURL: "https://bendbsn-17377-default-rtdb.firebaseio.com",
            projectId: "bendbsn-17377",
            storageBucket: "bendbsn-17377.firebasestorage.app",
            messagingSenderId: "762882187702",
            appId: "1:762882187702:web:81c97c9eae005666796117"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const SESSION_KEY = 'bsn9b_session_key';
        const SESSION_START_KEY = 'bsn9b_session_start';
        const SESSION_HEARTBEAT_MS = 60000;
        let sessionHeartbeatTimer = null;
        let sessionValidated = false;

        const IDLE_TIMEOUT = 10 * 60 * 1000;
        const LOGOUT_TIMEOUT = 30 * 60 * 1000;
        const LOGOUT_WARNING_TIMEOUT = 25 * 60 * 1000;
        const ACTIVITY_DEBOUNCE = 30000;
        let idleTimer = null, logoutTimer = null, logoutWarningTimer = null, activityDebounceTimer = null;
        let currentPresenceStatus = 'online';
        let myPresenceRef = null;

        function updateSessionHeartbeat() {
            const key = localStorage.getItem(SESSION_KEY);
            if (!key || !sessionValidated) return;
            database.ref('loginHistory/' + key).update({ lastSeen: Date.now() }).catch(() => {});
        }
        function startSessionHeartbeat() {
            const key = localStorage.getItem(SESSION_KEY);
            if (!key) return;
            database.ref('loginHistory/' + key).once('value', (snap) => {
                if (snap.exists() && snap.val().timestamp) {
                    sessionValidated = true;
                    updateSessionHeartbeat();
                    if (sessionHeartbeatTimer) clearInterval(sessionHeartbeatTimer);
                    sessionHeartbeatTimer = setInterval(updateSessionHeartbeat, SESSION_HEARTBEAT_MS);
                } else {
                    clearSessionTracking();
                }
            }).catch(() => {});
        }
        function endSessionTracking(reason) {
            const key = localStorage.getItem(SESSION_KEY);
            if (!key || !sessionValidated) return;
            if (localStorage.getItem('bsn9b_session_end_sent') === 'true') return;
            const start = parseInt(localStorage.getItem(SESSION_START_KEY) || '0', 10);
            const end = Date.now();
            const durationSeconds = start ? Math.max(0, Math.round((end - start) / 1000)) : null;
            localStorage.setItem('bsn9b_session_end_sent', 'true');
            database.ref('loginHistory/' + key).update({
                sessionEnd: end,
                durationSeconds,
                durationMinutes: durationSeconds !== null ? Math.round(durationSeconds / 60) : null,
                endReason: reason || 'logout'
            }).catch(() => {});
        }
        function clearSessionTracking() {
            localStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(SESSION_START_KEY);
            localStorage.removeItem('bsn9b_session_end_sent');
        }

        const presenceRef = database.ref('chat/presence');
        const bannedRef = database.ref('banned');
        const announcementsRef = database.ref('announcements');
        const userProfilesRef = database.ref('userProfiles');

        function setupAnnouncementListener() {
            announcementsRef.on('value', (snap) => {
                const data = snap.val() || {};
                const alertBanner = document.getElementById('alertBanner');
                const fyiBanner = document.getElementById('fyiBanner');
                if (data.alert && data.alert.message) {
                    document.getElementById('alertText').textContent = data.alert.message;
                    alertBanner.style.display = 'block';
                    document.body.classList.add('has-alert');
                } else {
                    alertBanner.style.display = 'none';
                    document.body.classList.remove('has-alert');
                }
                if (data.fyi && data.fyi.message) {
                    document.getElementById('fyiText').textContent = data.fyi.message;
                    fyiBanner.style.display = 'block';
                    fyiBanner.style.top = (data.alert && data.alert.message) ? '50px' : '0';
                    document.body.classList.add('has-fyi');
                } else {
                    fyiBanner.style.display = 'none';
                    document.body.classList.remove('has-fyi');
                }
            });
        }
        setupAnnouncementListener();

        let currentUsername = localStorage.getItem('bsn9b_user') || 'Anonymous';
        let displayName = localStorage.getItem('bsn9b_displayName') || currentUsername;
        let currentUserUid = localStorage.getItem('bsn9b_uid') || '';

        function getCurrentUserEmail() { return currentUsername || auth.currentUser?.email || ''; }
        function getCurrentUserUid()   { return currentUserUid || auth.currentUser?.uid || ''; }

        function syncUserProfile(user) {
            if (!user) return;
            const email = user.email || getCurrentUserEmail();
            const name = displayName || user.displayName || (email ? email.split('@')[0] : 'User');
            userProfilesRef.child(user.uid).update({
                email, displayName: name, firstName: name.split(' ')[0] || name, updatedAt: Date.now()
            });
        }

        let firebaseAuthReady = false;
        auth.onAuthStateChanged((user) => {
            if (user) {
                firebaseAuthReady = true;
                currentUserUid = user.uid;
                currentUsername = user.email || currentUsername;
                if (user.displayName) displayName = user.displayName;
                localStorage.setItem('bsn9b_uid', currentUserUid);
                localStorage.setItem('bsn9b_user', currentUsername);
                localStorage.setItem('bsn9b_displayName', displayName);
                syncUserProfile(user);
                document.getElementById('ctxName').textContent = displayName;

                userProfilesRef.child(user.uid).once('value').then((snap) => {
                    const profile = snap.val();
                    if (profile && (profile.role === 'Instructor' || profile.role_label === 'Instructor')) {
                        const apaLink = document.getElementById('apaMenuLink');
                        if (apaLink) apaLink.style.display = 'none';
                        const apaChip = document.getElementById('apaToolChip');
                        if (apaChip) apaChip.style.display = 'none';
                    }
                });

                // Load recent notes from Firebase
                loadRecentNotes(user.email);
            }
        });

        function checkIfBanned() {
            bannedRef.once('value', (snap) => {
                snap.forEach((child) => {
                    const b = child.val();
                    if (b.username === currentUsername || b.username === displayName) {
                        showToast('Your account has been suspended: ' + (b.reason || 'Rule violation'), 'error', 5000);
                        ['bsn9b_auth','bsn9b_user','bsn9b_displayName','bsn9b_uid'].forEach(k => localStorage.removeItem(k));
                        setTimeout(() => { window.location.href = '/'; }, 2000);
                    }
                });
            });
        }
        checkIfBanned();
        bannedRef.on('child_added', (snap) => {
            const b = snap.val();
            if (b.username === currentUsername || b.username === displayName) {
                showToast('Your account has been suspended: ' + (b.reason || 'Rule violation'), 'error', 5000);
                ['bsn9b_auth','bsn9b_user','bsn9b_displayName','bsn9b_uid'].forEach(k => localStorage.removeItem(k));
                setTimeout(() => { window.location.href = '/'; }, 2000);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            startSessionHeartbeat();
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') updateSessionHeartbeat();
            });
        });

        // ========== PRESENCE ==========
        function setPresence(status = 'online') {
            const uid = getCurrentUserUid();
            if (!uid) return;
            myPresenceRef = presenceRef.child(uid);
            myPresenceRef.set({ user: displayName, username: currentUsername, uid, status, lastActive: firebase.database.ServerValue.TIMESTAMP });
            myPresenceRef.onDisconnect().remove();
            currentPresenceStatus = status;
        }
        function updatePresenceStatus(status) {
            const uid = getCurrentUserUid();
            if (!uid) return;
            presenceRef.child(uid).update({ status, lastActive: firebase.database.ServerValue.TIMESTAMP }).catch(() => {});
            currentPresenceStatus = status;
        }
        function recordActivity() {
            clearTimeout(idleTimer); clearTimeout(logoutTimer); clearTimeout(logoutWarningTimer);
            idleTimer = setTimeout(() => {
                updatePresenceStatus('away');
                logoutTimer = setTimeout(() => logout(), LOGOUT_TIMEOUT - IDLE_TIMEOUT);
            }, IDLE_TIMEOUT);
            logoutWarningTimer = setTimeout(() => {
                showToast('You will be logged out in 5 minutes due to inactivity.', 'warning', 10000);
            }, LOGOUT_WARNING_TIMEOUT);
            if (activityDebounceTimer) return;
            if (currentPresenceStatus === 'away') updatePresenceStatus('online');
            activityDebounceTimer = setTimeout(() => {
                activityDebounceTimer = null;
                const uid = getCurrentUserUid();
                if (currentPresenceStatus === 'online' && uid) {
                    presenceRef.child(uid).update({ lastActive: firebase.database.ServerValue.TIMESTAMP }).catch(() => {});
                }
            }, ACTIVITY_DEBOUNCE);
        }
        function initActivityTracking() {
            ['mousedown','keydown','scroll','touchstart','mousemove'].forEach(ev => {
                document.addEventListener(ev, recordActivity, { passive: true });
            });
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') recordActivity();
            });
            recordActivity();
        }
        setPresence('online');
        initActivityTracking();
        database.ref('.info/connected').on('value', (snap) => {
            if (snap.val() === true && currentUsername) setPresence(currentPresenceStatus || 'online');
        });

        // Online count display
        let userListOpen = false;
        presenceRef.on('value', (snap) => {
            const data = snap.val() || {};
            const users = Object.values(data);
            const online = users.filter(u => u.status === 'online');
            const away   = users.filter(u => u.status === 'away');
            const countText = document.getElementById('onlineCountText');
            if (countText) countText.textContent = `${online.length} online${away.length ? `, ${away.length} away` : ''}`;
            renderUserList(online, away);
        });
        function toggleUserList() {
            userListOpen = !userListOpen;
            const d = document.getElementById('userListDropdown');
            if (d) d.style.display = userListOpen ? 'block' : 'none';
        }
        function renderUserList(online, away) {
            const el = document.getElementById('userListNames');
            if (!el) return;
            const rows = [
                ...online.map(u => `<div style="padding:6px 14px;font-size:13px;display:flex;align-items:center;gap:8px;"><span style="width:8px;height:8px;border-radius:50%;background:#22c55e;display:inline-block;flex-shrink:0;"></span>${u.user||'‚Äî'}</div>`),
                ...away.map(u => `<div style="padding:6px 14px;font-size:13px;display:flex;align-items:center;gap:8px;color:var(--clx-text-muted);"><span style="width:8px;height:8px;border-radius:50%;background:#eab308;display:inline-block;flex-shrink:0;"></span>${u.user||'‚Äî'}</div>`)
            ];
            el.innerHTML = rows.length ? rows.join('') : '<div style="padding:8px 14px;font-size:12px;color:var(--clx-text-muted);">Nobody online</div>';
        }
        document.addEventListener('click', (e) => {
            if (userListOpen && !e.target.closest('#userListDropdown') && !e.target.closest('#onlineCount')) {
                userListOpen = false;
                const d = document.getElementById('userListDropdown');
                if (d) d.style.display = 'none';
            }
        });

        // ========== THEME ==========
        function initTheme() {
            const saved = localStorage.getItem('bsn9b_theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcon();
        }
        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const t = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', t);
            localStorage.setItem('bsn9b_theme', t);
            updateThemeIcon();
        }
        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const icon = document.getElementById('themeMenuIcon');
            const text = document.getElementById('themeMenuText');
            const sidebarIcon = document.getElementById('sidebarThemeIcon');
            if (icon) icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            if (text) text.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            if (sidebarIcon) sidebarIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }
        initTheme();

        // ========== MORE MENU ==========
        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            const btn = document.querySelector('[aria-controls="moreMenu"]');
            const open = menu.classList.toggle('show');
            if (btn) btn.setAttribute('aria-expanded', open);
        }
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('moreMenu');
            const btn = document.querySelector('[aria-controls="moreMenu"]');
            if (!menu.contains(e.target) && !e.target.closest('[onclick*="toggleMoreMenu"]')) {
                menu.classList.remove('show');
                if (btn) btn.setAttribute('aria-expanded', 'false');
            }
        });

        // ========== LOCK ==========
        function lockScreen() { document.getElementById('lockScreenOverlay').style.display = 'flex'; }
        function unlockScreen() { document.getElementById('lockScreenOverlay').style.display = 'none'; }

        // ========== LOGOUT ==========
        function logout() {
            endSessionTracking('logout');
            cleanupFirebaseListeners();
            const uid = getCurrentUserUid();
            if (uid) presenceRef.child(uid).remove().catch(() => {});
            [idleTimer, logoutTimer, logoutWarningTimer, activityDebounceTimer].forEach(t => clearTimeout(t));
            auth.signOut().then(() => {
                ['bsn9b_auth','bsn9b_user','bsn9b_displayName','bsn9b_uid'].forEach(k => localStorage.removeItem(k));
                clearSessionTracking();
                window.location.href = '/';
            });
        }

        function cleanupFirebaseListeners() {
            try {
                if (typeof announcementsRef !== 'undefined') announcementsRef.off();
                if (typeof bannedRef !== 'undefined') bannedRef.off();
                if (typeof presenceRef !== 'undefined') presenceRef.off();
            } catch(e) {}
        }
        window.addEventListener('beforeunload', cleanupFirebaseListeners);
        window.addEventListener('pagehide', cleanupFirebaseListeners);

        // ========== KEYBOARD ==========
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay:not(.hidden)').forEach(m => m.classList.add('hidden'));
                document.getElementById('moreMenu')?.classList.remove('show');
                if (userListOpen) { userListOpen = false; document.getElementById('userListDropdown').style.display = 'none'; }
            }
        });

        // ========== SERVICE WORKER ==========
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    setInterval(() => reg.update(), 5 * 60 * 1000);
                    reg.addEventListener('updatefound', () => {
                        const nw = reg.installing;
                        if (!nw) return;
                        nw.addEventListener('statechange', () => {
                            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                                showToast('Update available ‚Äî click to reload.', 'info', 0);
                            }
                        });
                    });
                }).catch(() => {});
            });
            navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
        }

        // ========== CONTEXT BAR ==========
        (function initContextBar() {
            const term = localStorage.getItem('bsn9b_home_term');
            const exam = localStorage.getItem('bsn9b_home_exam');
            if (term) document.getElementById('ctxTerm').textContent = term;
            if (exam) document.getElementById('ctxExam').textContent = exam;
            document.getElementById('ctxName').textContent = displayName || localStorage.getItem('bsn9b_displayName') || '‚Äî';
            // Graduation countdown
            const grad = localStorage.getItem('bsn9b_home_grad');
            if (grad) document.getElementById('ctxGrad').textContent = calcGradCountdown(grad);
        })();

        function calcGradCountdown(gradStr) {
            // gradStr = "May 2027" format ‚Äî parse as 1st of that month
            const target = new Date(gradStr + ' 01');
            if (isNaN(target.getTime())) return gradStr;
            const now = new Date();
            if (target <= now) return 'üéì Done!';
            const diffMs = target - now;
            const days = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
            if (days <= 30) return days + ' days';
            const months = Math.round(diffMs / (1000 * 60 * 60 * 24 * 30.44));
            if (months < 24) return months + ' mo';
            const years = Math.floor(months / 12);
            const remMonths = months % 12;
            return remMonths ? years + 'y ' + remMonths + 'mo' : years + 'y';
        }

        function editCtx(field) {
            if (field === 'grad') {
                const el = document.getElementById('ctxGrad');
                const current = (el.textContent === '‚Äî' || el.textContent.includes('üéì') || el.textContent.includes('mo') || el.textContent.includes('y') || el.textContent.includes('days')) ? (localStorage.getItem('bsn9b_home_grad') || '') : el.textContent;
                showPromptModal('Graduation Date', 'Enter your expected graduation (e.g. May 2027)', (val) => {
                    if (val && val.trim()) {
                        localStorage.setItem('bsn9b_home_grad', val.trim());
                        el.textContent = calcGradCountdown(val.trim());
                    }
                }, { defaultValue: current, placeholder: 'May 2027' });
                return;
            }
            const el = document.getElementById(field === 'term' ? 'ctxTerm' : 'ctxExam');
            const current = el.textContent === '‚Äî' ? '' : el.textContent;
            const label = field === 'term' ? 'Current term (e.g. Spring 2026)' : 'Next exam date (e.g. Mar 3 ‚Äî NCLEX Review)';
            showPromptModal('Edit ' + (field === 'term' ? 'Term' : 'Next Exam'), label, (val) => {
                if (val && val.trim()) {
                    el.textContent = val.trim();
                    localStorage.setItem(field === 'term' ? 'bsn9b_home_term' : 'bsn9b_home_exam', val.trim());
                }
            }, { defaultValue: current, placeholder: label });
        }


        // ========== RECENT NOTES ==========
        function sanitizeEmail(email) {
            return email.replace(/\./g, '_').replace(/@/g, '_at_');
        }
        function loadRecentNotes(email) {
            if (!email) { renderRecentNotes([]); return; }
            const ref = database.ref('userDocuments/' + sanitizeEmail(email));
            // Get total count for hero stat
            ref.once('value', (snap) => {
                const total = snap.numChildren();
                const heroCount = document.getElementById('docHeroNoteCount');
                if (heroCount) heroCount.textContent = total;
            }).catch(() => {});
            ref.orderByChild('savedAt').limitToLast(5).once('value', (snap) => {
                const docs = [];
                snap.forEach((child) => {
                    docs.unshift({ id: child.key, ...child.val() });
                });
                renderRecentNotes(docs);
            }).catch(() => renderRecentNotes([]));
        }
        function renderRecentNotes(docs) {
            const el = document.getElementById('recentNotesList');
            if (!el) return;
            if (!docs.length) {
                el.innerHTML = '<div class="dash-empty">No saved notes yet.<br><a href="/app/" style="color:var(--clx-accent);font-weight:600;">Start your first note ‚Üí</a></div>';
                return;
            }
            el.innerHTML = docs.map(doc => {
                const name = doc.patientName || doc.name || 'Unnamed Note';
                const type = doc.noteType || doc.type || '‚Äî';
                const date = doc.savedAt ? new Date(doc.savedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                return `<a class="dash-note-item" href="/app/" title="Open in Note Builder">
                    <span class="dash-note-type">${escHtml(type)}</span>
                    <span class="dash-note-name">${escHtml(name)}</span>
                    <span class="dash-note-date">${escHtml(date)}</span>
                </a>`;
            }).join('');
        }
        function escHtml(s) {
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }


        // ========== COLLAPSIBLE HOME PANELS ==========
        const HOME_PANEL_KEY = 'bsn9b_home_panels';
        function loadPanelStates() {
            try { return JSON.parse(localStorage.getItem(HOME_PANEL_KEY) || '{}'); } catch { return {}; }
        }
        function savePanelState(id, open) {
            const s = loadPanelStates(); s[id] = open;
            localStorage.setItem(HOME_PANEL_KEY, JSON.stringify(s));
        }
        function toggleHomePanel(id) {
            const body = document.getElementById('quickRefBody');
            const chev = document.getElementById('quickRefChev');
            if (!body) return;
            const isOpen = !body.classList.contains('panel-body-collapsed');
            body.classList.toggle('panel-body-collapsed', isOpen);
            if (chev) chev.textContent = isOpen ? '‚ñº' : '‚ñ≤';
            savePanelState(id, !isOpen);
        }
        // Restore panel states (default: collapsed)
        (function() {
            const states = loadPanelStates();
            const isOpen = !!states['quickRef'];
            const body = document.getElementById('quickRefBody');
            const chev = document.getElementById('quickRefChev');
            if (body) { body.classList.toggle('panel-body-collapsed', !isOpen); }
            if (chev) chev.textContent = isOpen ? '‚ñ≤' : '‚ñº';
        })();

        // ========== STRUCTURED REMINDERS ==========
        const REMINDERS_V2_KEY = 'bsn9b_home_reminders_v2';

        function loadRemindersData() {
            try { return JSON.parse(localStorage.getItem(REMINDERS_V2_KEY) || '[]'); }
            catch { return []; }
        }
        function saveRemindersData(arr) {
            localStorage.setItem(REMINDERS_V2_KEY, JSON.stringify(arr));
        }

        function addReminder() {
            const text = (document.getElementById('remText')?.value || '').trim();
            if (!text) { showToast('Enter a reminder first.', 'warning'); return; }
            const due = document.getElementById('remDue')?.value || '';
            const priority = document.getElementById('remPriority')?.value || 'med';
            const arr = loadRemindersData();
            arr.push({ id: Date.now(), text, due, priority, created: Date.now() });
            saveRemindersData(arr);
            document.getElementById('remText').value = '';
            document.getElementById('remDue').value = '';
            document.getElementById('remPriority').value = 'med';
            renderReminderList();
        }

        function deleteReminder(id) {
            const arr = loadRemindersData().filter(r => r.id !== id);
            saveRemindersData(arr);
            renderReminderList();
        }

        function emailReminder(rem) {
            const userEmail = localStorage.getItem('bsn9b_user') || '';
            const subject = encodeURIComponent('Reminder: ' + rem.text);
            const body = encodeURIComponent('Due: ' + (rem.due ? formatRemDue(rem.due) : 'No due date') + '\n\nPriority: ' + rem.priority);
            window.open('mailto:' + userEmail + '?subject=' + subject + '&body=' + body);
        }

        function formatRemDue(due) {
            if (!due) return '‚Äî';
            const d = new Date(due + 'T00:00:00');
            const today = new Date(); today.setHours(0,0,0,0);
            const diff = d - today;
            if (diff < 0) return 'Overdue';
            if (diff === 0) return 'Today';
            if (diff === 86400000) return 'Tomorrow';
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getRemDueClass(due) {
            if (!due) return '';
            const d = new Date(due + 'T00:00:00');
            const today = new Date(); today.setHours(0,0,0,0);
            const diff = d - today;
            if (diff < 0) return 'overdue';
            if (diff === 0) return 'today';
            return '';
        }

        function getReminderPillClass(priority) {
            if (priority === 'high') return 'pill-danger';
            if (priority === 'low') return 'pill-info';
            return 'pill-warning';
        }

        function renderReminderList() {
            const el = document.getElementById('reminderList');
            const countEl = document.getElementById('reminderCount');
            if (!el) return;
            const arr = loadRemindersData();
            // Sort: overdue first, then by date, then no date
            arr.sort((a, b) => {
                const da = a.due ? new Date(a.due + 'T00:00:00') : null;
                const db = b.due ? new Date(b.due + 'T00:00:00') : null;
                const today = new Date(); today.setHours(0,0,0,0);
                const aOver = da && da < today;
                const bOver = db && db < today;
                if (aOver && !bOver) return -1;
                if (!aOver && bOver) return 1;
                if (da && db) return da - db;
                if (da) return -1;
                if (db) return 1;
                return b.created - a.created;
            });
            if (countEl) countEl.textContent = arr.length;
            if (!arr.length) {
                el.innerHTML = '<div class="rem-empty">No reminders yet. Add one above!</div>';
                return;
            }
            const today = new Date(); today.setHours(0,0,0,0);
            el.innerHTML = arr.map(rem => {
                const dueLabel = formatRemDue(rem.due);
                const dueClass = getRemDueClass(rem.due);
                const isOverdue = dueClass === 'overdue';
                const pillClass = getReminderPillClass(rem.priority);
                return `<div class="rem-item${isOverdue ? ' overdue' : ''}">
                    <span class="pill ${pillClass}" style="flex-shrink:0;font-size:9px;">${rem.priority}</span>
                    <span class="rem-text" title="${escHtml(rem.text)}">${escHtml(rem.text)}</span>
                    <span class="rem-due ${dueClass}">${escHtml(dueLabel)}</span>
                    <div class="rem-actions">
                        <button class="rem-email-btn" onclick="emailReminder(${JSON.stringify(rem).replace(/"/g,'&quot;')})" title="Email this reminder">‚úâ</button>
                        <button class="rem-del-btn" onclick="deleteReminder(${rem.id})" title="Delete reminder">√ó</button>
                    </div>
                </div>`;
            }).join('');
        }

        // Initialize reminders on load
        renderReminderList();

        // ========== SIDEBAR ==========
        (function initSidebar() {
            document.body.classList.add('has-sidebar');
            const sidebar = document.getElementById('appSidebar');
            if (!sidebar) return;
            if (localStorage.getItem('bsn9b_sidebar_collapsed') === 'true') {
                sidebar.classList.add('collapsed');
                const icon = document.getElementById('sidebarToggleIcon');
                if (icon) icon.textContent = '‚ñ∂';
            }
        })();

        function toggleSidebar() {
            const sidebar = document.getElementById('appSidebar');
            if (!sidebar) return;
            const collapsed = sidebar.classList.toggle('collapsed');
            localStorage.setItem('bsn9b_sidebar_collapsed', String(collapsed));
            const icon = document.getElementById('sidebarToggleIcon');
            if (icon) icon.textContent = collapsed ? '‚ñ∂' : '‚óÄ';
        }
    </script>
    <script src="/shared/toast.js"></script>
    <script src="/shared/header.js"></script>
</body>
</html>
