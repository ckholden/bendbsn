<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com https://cdn.emailjs.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; connect-src 'self' https://www.gstatic.com https://script.google.com https://script.googleusercontent.com https://*.firebaseio.com https://*.googleapis.com https://formsubmit.co https://en.wikipedia.org wss://*.firebaseio.com; img-src 'self' data: blob: https:;">
    <script>if(location.protocol !== 'https:' && location.hostname !== 'localhost'){location.replace('https:' + location.href.substring(location.protocol.length));}</script>
    <script>
        if (localStorage.getItem('bsn9b_auth') !== 'true') {
            window.location.href = '/';
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#1f4e79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BendBSN">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="icon" type="image/png" href="/favicon.png?v=3">
    <link rel="shortcut icon" href="/favicon.png?v=3">
    <!-- Preconnect hints for faster external resource loading -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="stylesheet" href="/shared/header.css">
    <title>BendBSN - Home</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-page: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #fafafa;
            --bg-input: #fafafa;
            --text-primary: #1a1a2e;
            --text-secondary: #666666;
            --accent: #1f4e79;
            --accent-light: #2d5a87;
            --shadow: rgba(0,0,0,0.4);
            --border: #e0e0e0;
        }

        [data-theme="dark"] {
            --bg-page: linear-gradient(135deg, #0a0a14 0%, #0d1117 50%, #161b22 100%);
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #1e2a3a;
            --bg-input: #16213e;
            --text-primary: #e6e6e6;
            --text-secondary: #aaaaaa;
            --accent: #4a90d9;
            --accent-light: #5a9fe8;
            --shadow: rgba(0,0,0,0.6);
            --border: #2d3748;
        }

        /* Status indicator colors for presence */
        .status-online { background: #22c55e; }  /* Green */
        .status-away { background: #eab308; }    /* Yellow */
        .status-offline { background: #6b7280; } /* Gray */

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }


        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-page);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            text-align: center;
            max-width: 800px;
            width: 100%;
        }

        .hero-heading {
            font-size: 40px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        .hero-subheading {
            font-size: 18px;
            font-weight: 500;
            color: rgba(255,255,255,0.7);
            margin-bottom: 24px;
        }

        .hero-description {
            font-size: 16px;
            color: rgba(255,255,255,0.6);
            line-height: 1.6;
            max-width: 540px;
            margin: 0 auto 36px;
        }

        .quick-start {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 20px;
            margin: 0 auto 36px;
            max-width: 760px;
            text-align: left;
        }
        .quick-start h2 {
            font-size: 18px;
            color: #ffffff;
            margin-bottom: 6px;
        }
        .quick-start p {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 14px;
        }
        .quick-start-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .quick-card {
            background: rgba(255,255,255,0.9);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 14px 16px;
            text-decoration: none;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .quick-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 28px rgba(0,0,0,0.25);
        }
        .quick-card .label {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .quick-card .desc {
            font-size: 12px;
            color: #475569;
        }

        .cta-primary {
            display: inline-block;
            background: #3b82f6;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            padding: 14px 36px;
            border-radius: 10px;
            text-decoration: none;
            transition: background 0.2s, transform 0.15s;
            box-shadow: 0 4px 16px rgba(59,130,246,0.35);
        }

        .cta-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(59,130,246,0.45);
        }

        .cta-primary:active {
            transform: translateY(0);
        }

        .welcome {
            font-size: 14px;
            color: rgba(255,255,255,0.4);
            margin-top: 28px;
        }

        .nav-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 48px;
        }

        .nav-card {
            background: var(--bg-primary);
            border-radius: 14px;
            padding: 28px 32px;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.2s ease;
            box-shadow: 0 4px 20px var(--shadow);
            min-width: 220px;
            max-width: 280px;
            flex: 1;
        }

        .nav-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px var(--shadow);
        }

        .nav-card .label {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .nav-card .description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 10px;
            transition: color 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .toolbar-item:hover { color: var(--accent); }
        .toolbar-item.active { color: var(--accent); }
        .toolbar-item .icon { font-size: 24px; margin-bottom: 2px; }
        .toolbar-item .label { font-weight: 600; }

        /* More Menu */
        .more-menu {
            position: fixed;
            bottom: 70px;
            right: 10px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 8px 0;
            display: none;
            z-index: 1001;
            min-width: 160px;
            border: 1px solid var(--border);
        }

        .more-menu.show { display: block; }

        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
        }

        .more-menu-item:hover { background: var(--bg-secondary); }
        .more-menu-item .menu-icon { font-size: 18px; }

        /* Adjust body padding for toolbar */
        body {
            padding-bottom: 80px;
        }

        /* Dark mode specific */
        [data-theme="dark"] .nav-card {
            background: var(--bg-primary);
        }

        /* Feedback Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.hidden { display: none; }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            color: var(--text-primary);
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .modal-content textarea { min-height: 120px; resize: vertical; }

        /* Lock Screen */
        #lockScreenOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 99999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* Focus visible styles for keyboard navigation */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        button:focus-visible, a:focus-visible, .nav-card:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* ========== MOBILE RESPONSIVE STYLES ========== */

        /* Smooth scrolling */
        html { scroll-behavior: smooth; }

        /* Minimum touch target size (44px) */
        @media (pointer: coarse) {
            button, .btn, .toolbar-item, .more-menu-item, .nav-card {
                min-height: 44px;
            }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .title { font-size: 36px; }
            .nav-buttons { flex-direction: column; align-items: center; }
            .nav-card { min-width: 200px; padding: 30px 40px; min-height: 80px; }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            body {
                padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
            }

            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }
        }

        /* Small phones */
        @media (max-width: 480px) {
            .title { font-size: 28px; }
            .nav-card { padding: 25px 35px; }

            /* Prevent iOS zoom on input focus */
            input, select, textarea {
                font-size: 16px !important;
            }
        }

        /* Landscape orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .container { padding: 20px; }
            .title { font-size: 24px; margin-bottom: 15px; }
            .bottom-toolbar { height: 50px; }
            .toolbar-item .label { display: none; }
        }

        /* Safe area insets for bottom toolbar */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(60px + env(safe-area-inset-bottom));
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 380px;
        }
        .toast {
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: toastSlideIn 0.3s ease;
            color: white;
            font-size: 14px;
            line-height: 1.4;
        }
        .toast.hiding { animation: toastSlideOut 0.3s ease forwards; }
        .toast-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .toast-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .toast-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .toast-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .toast-icon { font-size: 18px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-message { opacity: 0.95; }
        .toast-close { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; font-size: 18px; padding: 0; line-height: 1; }
        .toast-close:hover { opacity: 1; }
        @keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @media (max-width: 480px) { .toast-container { left: 10px; right: 10px; max-width: none; } }
    </style>
</head>
<body>
    <header class="site-header">
        <a href="/home/" class="logo-link"><img src="/logo.png" alt="BendBSN" class="site-logo"></a>
    </header>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Alert/FYI Banners - Fixed at top -->
    <div id="alertBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 10000; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5); animation: softFlashAlert 2s ease-in-out infinite;">
        <span id="alertText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.8;">‚ö†Ô∏è ALERT</span>
    </div>
    <div id="fyiBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a1a2e; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 9999; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); animation: softFlashFyi 2s ease-in-out infinite;">
        <span id="fyiText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.7;">‚ÑπÔ∏è FYI</span>
    </div>
    <style>
        @keyframes softFlashAlert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        @keyframes softFlashFyi {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        body.has-alert { padding-top: 50px; }
        body.has-fyi { padding-top: 50px; }
        body.has-alert.has-fyi { padding-top: 100px; }
    </style>

    <!-- Lock Screen Overlay -->
    <div id="lockScreenOverlay">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px;">üîí</div>
            <h1 style="font-size: 42px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">BendBSN</h1>
            <p style="font-size: 18px; opacity: 0.8; margin-bottom: 40px;">Portal Locked</p>
            <button onclick="unlockScreen()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 18px 50px; border-radius: 30px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);">
                üîì Unlock Portal
            </button>
            <p style="margin-top: 30px; font-size: 12px; opacity: 0.5;">Click unlock to return to your session</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <h1 class="hero-heading">BendBSN</h1>
        <p class="hero-subheading">Nursing Documentation Tools</p>
        <p class="hero-description">Create structured nursing notes, head-to-toe assessments, and clinical documentation‚Äîfast.</p>
        <a href="/app/" class="cta-primary">Start a Note</a>
        <div class="quick-start">
            <h2>Quick Start</h2>
            <p>Pick a task to get moving quickly.</p>
            <div class="quick-start-grid">
                <a class="quick-card" href="/app/">
                    <div class="label">Create a Note</div>
                    <div class="desc">DAR, SOAP, Head-to-Toe, and more.</div>
                </a>
                <a class="quick-card" href="/resources/">
                    <div class="label">Open Resources</div>
                    <div class="desc">Drug tools, calculators, and references.</div>
                </a>
                <a class="quick-card" href="/chat/">
                    <div class="label">Join Chat</div>
                    <div class="desc">Ask questions or DM classmates.</div>
                </a>
            </div>
        </div>
        <p class="welcome" id="welcomeMessage">Welcome back</p>

        <div class="nav-buttons">
            <a href="/app/" class="nav-card">
                <div class="label">Note Generator</div>
                <div class="description">Create nursing documentation with DAR, SOAP, and other formats</div>
            </a>
            <a href="/resources/" class="nav-card">
                <div class="label">Resources</div>
                <div class="description">Clinical references, calculators, drug lookup, and study materials</div>
            </a>
            <a href="/community/" class="nav-card">
                <div class="label">Community</div>
                <div class="description">Discussion boards, study tips, and peer connections</div>
            </a>
        </div>
    </div>

    <!-- Bottom Toolbar -->
    <nav class="bottom-toolbar" role="navigation" aria-label="Main navigation">
        <a href="/home/" class="toolbar-item active" aria-label="Home" aria-current="page">
            <span class="icon" aria-hidden="true">üè†</span>
            <span class="label">Home</span>
        </a>
        <a href="/app/" class="toolbar-item" aria-label="RN Notes documentation generator">
            <span class="icon" aria-hidden="true">üìù</span>
            <span class="label">RN Notes</span>
        </a>
        <a href="/chat/" class="toolbar-item" aria-label="Chat">
            <span class="icon" aria-hidden="true">üí¨</span>
            <span class="label">Chat</span>
        </a>
        <a href="/ai/" class="toolbar-item" aria-label="AI Assistant">
            <span class="icon" aria-hidden="true">ü©∫</span>
            <span class="label">AI</span>
        </a>
        <a href="/community/" class="toolbar-item" aria-label="Community hub">
            <span class="icon" aria-hidden="true">üë•</span>
            <span class="label">Community</span>
        </a>
        <a href="/resources/" class="toolbar-item" aria-label="Nursing resources">
            <span class="icon" aria-hidden="true">üìö</span>
            <span class="label">Resources</span>
        </a>
        <button class="toolbar-item" onclick="toggleMoreMenu()" aria-label="More options" aria-expanded="false" aria-controls="moreMenu">
            <span class="icon" aria-hidden="true">‚ãØ</span>
            <span class="label">More</span>
        </button>
    </nav>

    <!-- More Menu -->
    <div id="moreMenu" class="more-menu" role="menu" aria-label="More options menu">
        <button class="more-menu-item" onclick="toggleDarkMode(); toggleMoreMenu();" role="menuitem" aria-label="Toggle dark mode">
            <span class="menu-icon" id="themeMenuIcon" aria-hidden="true">üåô</span>
            <span id="themeMenuText">Dark Mode</span>
        </button>
        <button class="more-menu-item" onclick="lockScreen(); toggleMoreMenu();" role="menuitem" aria-label="Lock screen">
            <span class="menu-icon" aria-hidden="true">üîí</span>
            <span>Lock Screen</span>
        </button>
        <button class="more-menu-item" onclick="toggleFullscreen(); toggleMoreMenu();" role="menuitem" aria-label="Toggle full screen" id="fullscreenBtn">
            <span class="menu-icon" aria-hidden="true" id="fullscreenIcon">‚õ∂</span>
            <span id="fullscreenText">Full Screen</span>
        </button>
        <a href="/labsched/" class="more-menu-item" role="menuitem" aria-label="Lab Schedule Generator" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">üìÖ</span>
            <span>Sched Generator</span>
        </a>
        <a href="/apa/" class="more-menu-item" role="menuitem" aria-label="APA Paper Generator" id="apaMenuLink" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">üìÑ</span>
            <span>APA Generator</span>
        </a>
        <a href="/clinical/" class="more-menu-item" role="menuitem" aria-label="Clinical Packet Builder" id="clinicalMenuLink" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">üìã</span>
            <span>Clinical Packet</span>
        </a>
        <button class="more-menu-item" onclick="document.getElementById('feedbackModal').classList.remove('hidden'); toggleMoreMenu();" role="menuitem" aria-label="Send feedback">
            <span class="menu-icon" aria-hidden="true">üí°</span>
            <span>Feedback</span>
        </button>
        <button class="more-menu-item" onclick="logout();" role="menuitem" aria-label="Logout">
            <span class="menu-icon" aria-hidden="true">üö™</span>
            <span>Logout</span>
        </button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="feedbackModalTitle">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 20px;">üí° Send Feedback</h2>
                <button onclick="document.getElementById('feedbackModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
            </div>
            <form action="https://formsubmit.co/christiankholden@gmail.com" method="POST">
                <input type="hidden" name="_subject" value="BendBSN Feedback">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_template" value="table">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Type</label>
                <select name="type" required>
                    <option value="bug">üêõ Bug Report</option>
                    <option value="feature">‚ú® Feature Request</option>
                    <option value="phrase">üí¨ New Phrase Suggestion</option>
                    <option value="feedback" selected>üìù General Feedback</option>
                </select>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Your Name</label>
                <input type="text" name="name" required placeholder="Enter your name">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Message</label>
                <textarea name="message" required placeholder="Describe your feedback..."></textarea>
                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Send Feedback</button>
            </form>
        </div>
    </div>


    <script>
        // ========== FULLSCREEN MODE ==========
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                const elem = document.documentElement;
                if (elem.requestFullscreen) elem.requestFullscreen();
                else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                updateFullscreenUI(true);
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                updateFullscreenUI(false);
            }
        }
        function updateFullscreenUI(isFullscreen) {
            const icon = document.getElementById('fullscreenIcon');
            const text = document.getElementById('fullscreenText');
            if (text) text.textContent = isFullscreen ? 'Exit Full Screen' : 'Full Screen';
        }
        document.addEventListener('fullscreenchange', () => updateFullscreenUI(!!document.fullscreenElement));
        document.addEventListener('webkitfullscreenchange', () => updateFullscreenUI(!!document.webkitFullscreenElement));

        // ========== TOAST NOTIFICATION SYSTEM ==========
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content"><div class="toast-message">${message.replace(/\n/g, '<br>')}</div></div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, duration);
        }

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAmr2W8mekSPJ2pXM3gz1FvarfSBddpfLM",
            authDomain: "bendbsn-17377.firebaseapp.com",
            databaseURL: "https://bendbsn-17377-default-rtdb.firebaseio.com",
            projectId: "bendbsn-17377",
            storageBucket: "bendbsn-17377.firebasestorage.app",
            messagingSenderId: "762882187702",
            appId: "1:762882187702:web:81c97c9eae005666796117"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const SESSION_KEY = 'bsn9b_session_key';
        const SESSION_START_KEY = 'bsn9b_session_start';
        const SESSION_HEARTBEAT_MS = 60000;
        let sessionHeartbeatTimer = null;
        let sessionValidated = false;

        // Presence/Activity timeout constants
        const IDLE_TIMEOUT = 10 * 60 * 1000;   // 10 minutes -> Away
        const LOGOUT_TIMEOUT = 30 * 60 * 1000; // 30 minutes -> Logout
        const LOGOUT_WARNING_TIMEOUT = 25 * 60 * 1000; // 25 minutes -> Show warning
        const ACTIVITY_DEBOUNCE = 30000;       // Debounce Firebase updates
        let idleTimer = null;
        let logoutTimer = null;
        let logoutWarningTimer = null;
        let activityDebounceTimer = null;
        let lastActivityTime = Date.now();
        let currentPresenceStatus = 'online';
        let myPresenceRef = null;

        function updateSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey || !sessionValidated) return;
            database.ref('loginHistory/' + sessionKey).update({
                lastSeen: Date.now()
            }).catch(() => {});
        }

        function startSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey) return;
            database.ref('loginHistory/' + sessionKey).once('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val().timestamp) {
                    sessionValidated = true;
                    updateSessionHeartbeat();
                    if (sessionHeartbeatTimer) clearInterval(sessionHeartbeatTimer);
                    sessionHeartbeatTimer = setInterval(updateSessionHeartbeat, SESSION_HEARTBEAT_MS);
                } else {
                    clearSessionTracking();
                }
            }).catch(() => {});
        }

        function endSessionTracking(reason) {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey || !sessionValidated) return;
            if (localStorage.getItem('bsn9b_session_end_sent') === 'true') return;
            const start = parseInt(localStorage.getItem(SESSION_START_KEY) || '0', 10);
            const end = Date.now();
            const durationSeconds = start ? Math.max(0, Math.round((end - start) / 1000)) : null;
            const durationMinutes = durationSeconds !== null ? Math.round(durationSeconds / 60) : null;
            localStorage.setItem('bsn9b_session_end_sent', 'true');
            database.ref('loginHistory/' + sessionKey).update({
                sessionEnd: end,
                durationSeconds: durationSeconds,
                durationMinutes: durationMinutes,
                endReason: reason || 'logout'
            }).catch(() => {});
        }

        function clearSessionTracking() {
            localStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(SESSION_START_KEY);
            localStorage.removeItem('bsn9b_session_end_sent');
        }

        // ========== CORE FIREBASE REFS & SYSTEMS ==========
        const presenceRef = database.ref('chat/presence');
        const bannedRef = database.ref('banned');
        const announcementsRef = database.ref('announcements');
        const userProfilesRef = database.ref('userProfiles');

        // Listen for announcements (alert/fyi banners - inside header)
        function setupAnnouncementListener() {
            announcementsRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                const alertBanner = document.getElementById('alertBanner');
                const fyiBanner = document.getElementById('fyiBanner');
                const alertText = document.getElementById('alertText');
                const fyiText = document.getElementById('fyiText');

                // Handle alert banner
                if (data.alert && data.alert.message) {
                    alertText.textContent = data.alert.message;
                    alertBanner.style.display = 'block';
                    document.body.classList.add('has-alert');
                } else {
                    alertBanner.style.display = 'none';
                    document.body.classList.remove('has-alert');
                }

                // Handle FYI banner (offset if alert is showing)
                if (data.fyi && data.fyi.message) {
                    fyiText.textContent = data.fyi.message;
                    fyiBanner.style.display = 'block';
                    fyiBanner.style.top = (data.alert && data.alert.message) ? '50px' : '0';
                    document.body.classList.add('has-fyi');
                } else {
                    fyiBanner.style.display = 'none';
                    document.body.classList.remove('has-fyi');
                }
            });
        }
        setupAnnouncementListener();

        // Get display name (first name) - stored when user logs in
        let currentUsername = localStorage.getItem('bsn9b_user') || 'Anonymous';
        let displayName = localStorage.getItem('bsn9b_displayName') || currentUsername;
        let currentUserUid = localStorage.getItem('bsn9b_uid') || '';

        function getCurrentUserEmail() {
            return currentUsername || auth.currentUser?.email || localStorage.getItem('bsn9b_user') || '';
        }

        function getCurrentUserUid() {
            return currentUserUid || auth.currentUser?.uid || localStorage.getItem('bsn9b_uid') || '';
        }

        function syncUserProfile(user) {
            if (!user) return;
            const email = user.email || getCurrentUserEmail();
            const name = displayName || user.displayName || (email ? email.split('@')[0] : 'User');
            const firstName = name.split(' ')[0] || name;
            userProfilesRef.child(user.uid).update({
                email: email,
                displayName: name,
                firstName: firstName,
                updatedAt: Date.now()
            });
        }

        // Verify Firebase Auth state and re-authenticate if needed
        let firebaseAuthReady = false;
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Firebase Auth: Logged in as', user.email);
                firebaseAuthReady = true;
                currentUserUid = user.uid;
                currentUsername = user.email || currentUsername;
                if (user.displayName) {
                    displayName = user.displayName;
                }
                localStorage.setItem('bsn9b_uid', currentUserUid);
                localStorage.setItem('bsn9b_user', currentUsername);
                localStorage.setItem('bsn9b_displayName', displayName);
                syncUserProfile(user);

                // Check user role and hide APA link for instructors
                userProfilesRef.child(user.uid).once('value').then((snap) => {
                    const profile = snap.val();
                    if (profile && profile.role === 'Instructor') {
                        const apaLink = document.getElementById('apaMenuLink');
                        if (apaLink) apaLink.style.display = 'none';
                    }
                });
            } else {
                console.log('Firebase Auth: Not logged in, attempting silent re-auth...');
                if (localStorage.getItem('bsn9b_auth') === 'true') {
                    console.warn('Session exists but Firebase auth lost - may need to re-login');
                }
            }
        });

        // Check if current user is banned
        function checkIfBanned() {
            bannedRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const banned = child.val();
                    if (banned.username === currentUsername || banned.username === displayName) {
                        showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                        localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                        setTimeout(() => { window.location.href = '/'; }, 2000);
                    }
                });
            });
        }
        checkIfBanned();

        // Listen for bans in real-time
        bannedRef.on('child_added', (snapshot) => {
            const banned = snapshot.val();
            if (banned.username === currentUsername || banned.username === displayName) {
                showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                setTimeout(() => { window.location.href = '/'; }, 2000);
            }
        });

        function isAdminUser() {
            const adminEmails = ['christiankholden@gmail.com', 'holdenc'];
            return adminEmails.includes((currentUsername || '').toLowerCase());
        }

        // Initialize session heartbeat on page load
        document.addEventListener('DOMContentLoaded', function() {
            startSessionHeartbeat();
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') updateSessionHeartbeat();
            });
        });

        // ========== PRESENCE SYSTEM ==========
        // Set presence using UID as key (prevents duplicates across tabs)
        function setPresence(status = 'online') {
            const uid = getCurrentUserUid();
            if (!uid) return;

            myPresenceRef = presenceRef.child(uid);
            myPresenceRef.set({
                user: displayName,
                username: currentUsername,
                uid: uid,
                status: status,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
            myPresenceRef.onDisconnect().remove();
            currentPresenceStatus = status;
        }

        // Update status without full rewrite
        function updatePresenceStatus(status) {
            const uid = getCurrentUserUid();
            if (!uid) return;
            presenceRef.child(uid).update({
                status: status,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            }).catch(() => {});
            currentPresenceStatus = status;
        }

        // Activity detection - reset idle timers (debounced)
        function recordActivity() {
            lastActivityTime = Date.now();

            // Reset idle/logout/warning timers immediately (local)
            clearTimeout(idleTimer);
            clearTimeout(logoutTimer);
            clearTimeout(logoutWarningTimer);

            // Set idle timer (10 min)
            idleTimer = setTimeout(() => {
                updatePresenceStatus('away');

                // Set logout timer (additional 20 min = 30 min total)
                logoutTimer = setTimeout(() => {
                    logout(); // Full logout
                }, LOGOUT_TIMEOUT - IDLE_TIMEOUT);
            }, IDLE_TIMEOUT);

            // Set warning timer (25 min = 5 min before logout)
            logoutWarningTimer = setTimeout(() => {
                showToast('You will be logged out in 5 minutes due to inactivity. Move your mouse or press a key to stay logged in.', 'warning', 10000);
            }, LOGOUT_WARNING_TIMEOUT);

            // Debounce Firebase updates (don't spam on every mouse move)
            if (activityDebounceTimer) return;

            // If was away, go back online immediately
            if (currentPresenceStatus === 'away') {
                updatePresenceStatus('online');
            }

            activityDebounceTimer = setTimeout(() => {
                activityDebounceTimer = null;
                // Update lastActive timestamp periodically while active
                const uid = getCurrentUserUid();
                if (currentPresenceStatus === 'online' && uid) {
                    presenceRef.child(uid).update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    }).catch(() => {});
                }
            }, ACTIVITY_DEBOUNCE);
        }

        // Initialize activity listeners
        function initActivityTracking() {
            const events = ['mousedown', 'keydown', 'scroll', 'touchstart', 'mousemove'];
            events.forEach(event => {
                document.addEventListener(event, recordActivity, { passive: true });
            });

            // Also track visibility
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    recordActivity();
                }
            });

            // Start initial timer
            recordActivity();
        }

        // Initialize presence (called after auth check)
        setPresence('online');
        initActivityTracking();

        // Re-establish presence on reconnect (handles multi-tab onDisconnect conflicts)
        database.ref('.info/connected').on('value', (snap) => {
            if (snap.val() === true && currentUsername) setPresence(currentPresenceStatus || 'online');
        });

        // Set welcome message
        document.getElementById('welcomeMessage').textContent = 'Welcome back, ' + displayName;

        // Theme functions
        function initTheme() {
            const saved = localStorage.getItem('bsn9b_theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcon();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('bsn9b_theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const themeMenuIcon = document.getElementById('themeMenuIcon');
            const themeMenuText = document.getElementById('themeMenuText');
            if (themeMenuIcon) {
                themeMenuIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            }
            if (themeMenuText) {
                themeMenuText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            }
        }

        // More menu toggle
        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const isExpanded = menu.classList.toggle('show');
            if (moreBtn) {
                moreBtn.setAttribute('aria-expanded', isExpanded);
            }
        }

        // Close more menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const moreBtnClicked = e.target.closest('.toolbar-item');
            if (!menu.contains(e.target) && (!moreBtnClicked || !moreBtnClicked.onclick?.toString().includes('toggleMoreMenu'))) {
                menu.classList.remove('show');
                if (moreBtn) {
                    moreBtn.setAttribute('aria-expanded', 'false');
                }
            }
        });

        // Lock/Unlock
        function lockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'flex';
        }

        function unlockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'none';
        }

        // Logout
        function logout() {
            endSessionTracking('logout');
            cleanupFirebaseListeners();
            // Clean presence before signing out
            const uid = getCurrentUserUid();
            if (uid) {
                presenceRef.child(uid).remove().catch(() => {});
            }
            // Clear idle/logout/warning timers
            clearTimeout(idleTimer);
            clearTimeout(logoutTimer);
            clearTimeout(logoutWarningTimer);
            clearTimeout(activityDebounceTimer);

            auth.signOut().then(() => {
                localStorage.removeItem('bsn9b_auth');
                localStorage.removeItem('bsn9b_user');
                localStorage.removeItem('bsn9b_displayName');
                localStorage.removeItem('bsn9b_uid');
                clearSessionTracking();
                window.location.href = '/';
            });
        }

        // Initialize
        initTheme();

        // ========== FIREBASE LISTENER CLEANUP ==========
        // Clean up Firebase listeners on page unload to prevent memory leaks
        function cleanupFirebaseListeners() {
            try {
                if (typeof announcementsRef !== 'undefined') announcementsRef.off();
                if (typeof bannedRef !== 'undefined') bannedRef.off();
                if (typeof presenceRef !== 'undefined') presenceRef.off();
                console.log('Firebase listeners cleaned up');
            } catch (e) {
                console.log('Error cleaning up listeners:', e);
            }
        }

        window.addEventListener('beforeunload', cleanupFirebaseListeners);
        window.addEventListener('pagehide', cleanupFirebaseListeners);

        // ========== KEYBOARD NAVIGATION ==========
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close modals
                document.querySelectorAll('.modal-overlay:not(.hidden)').forEach(m => m.classList.add('hidden'));
                // Close more menu
                const moreMenu = document.getElementById('moreMenu');
                if (moreMenu) moreMenu.classList.remove('show');
            }
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);

                        // Check for updates every 5 minutes
                        setInterval(() => {
                            registration.update();
                        }, 5 * 60 * 1000);

                        // Listen for service worker updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            if (!newWorker) return;

                            newWorker.addEventListener('statechange', () => {
                                // If new SW is waiting and there's an active controller, show update prompt
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showToast(
                                        'Update available! Click here to reload and get the latest version.',
                                        0, // Don't auto-dismiss
                                        () => {
                                            // Tell the new SW to skip waiting
                                            newWorker.postMessage({type: 'SKIP_WAITING'});
                                        }
                                    );
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });

            // Listen for controller change (new SW activated)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                // Reload the page to use the new service worker
                window.location.reload();
            });
        }
    </script>
    <script src="/shared/header.js"></script>

</body>
</html>






