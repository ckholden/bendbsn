<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>if(location.protocol !== 'https:' && location.hostname !== 'localhost'){location.replace('https:' + location.href.substring(location.protocol.length));}</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>BSN9B Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #0f3460 0%, #533483 50%, #e94560 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 24px; }
        .header-actions { display: flex; gap: 10px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: #e94560; color: white; }
        .btn-primary:hover { background: #d63850; transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; }
        .btn-secondary:hover { background: rgba(255,255,255,0.3); }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .card-header {
            background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body { padding: 20px; max-height: 250px; overflow-y: auto; }
        .card-body.tall { max-height: 300px; }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        .user-item:hover { background: #f8f9fa; }
        .user-item:last-child { border-bottom: none; }
        .user-info { flex: 1; }
        .user-name { font-weight: 600; color: #333; }
        .user-email { font-size: 12px; color: #666; }
        .user-status { font-size: 11px; margin-top: 3px; }
        .status-approved { color: #28a745; }
        .status-pending { color: #ffc107; }
        .status-banned { color: #dc3545; }
        .user-actions { display: flex; gap: 5px; }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .message-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .message-content { flex: 1; }
        .message-user { font-weight: 600; font-size: 12px; color: #1f4e79; }
        .message-text { font-size: 14px; color: #333; margin: 5px 0; }
        .message-time { font-size: 10px; color: #999; }

        .stat-box {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        .stat-number { font-size: 36px; font-weight: 700; color: #1f4e79; }
        .stat-label { font-size: 12px; color: #666; margin-top: 5px; }

        .login-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .login-box h2 { margin-bottom: 20px; color: #1f4e79; }
        .login-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .login-box input:focus { outline: none; border-color: #1f4e79; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 10px; }

        .refresh-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .refresh-btn:hover { opacity: 1; }

        .action-bar {
            background: white;
            border-radius: 16px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .action-bar label { font-weight: 600; color: #333; }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #ffffff;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            color: #666;
            text-decoration: none;
            font-size: 10px;
            transition: color 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }
        .toolbar-item:hover { color: #1f4e79; }
        .toolbar-item.active { color: #e94560; }
        .toolbar-item .icon { font-size: 24px; margin-bottom: 2px; }
        .toolbar-item .label { font-weight: 600; }
        body { padding-bottom: 70px; }
    </style>
</head>
<body>
    <!-- Alert/FYI Banners -->
    <div id="alertBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 10000; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5); animation: alertFlash 1s infinite;">
        <span id="alertText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.8;">‚ö†Ô∏è ALERT</span>
    </div>
    <div id="fyiBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a1a2e; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 9999; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);">
        <span id="fyiText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.7;">‚ÑπÔ∏è FYI</span>
    </div>
    <style>
        @keyframes alertFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        }
        body.has-alert { padding-top: 50px; }
        body.has-fyi { padding-top: 50px; }
        body.has-alert.has-fyi { padding-top: 100px; }
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 14px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            font-size: 14px;
            z-index: 100000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 400px;
        }
        .toast.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .toast.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .toast.info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>

    <!-- Admin Login -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>Admin Access</h2>
            <p style="color: #666; margin-bottom: 20px;">Enter admin password to continue</p>
            <input type="password" id="adminPassword" placeholder="Admin Password" onkeypress="if(event.key==='Enter')checkAdminPassword()">
            <button class="btn btn-primary" style="width: 100%;" onclick="checkAdminPassword()">Access Admin Panel</button>
            <p id="loginError" style="color: #dc3545; margin-top: 15px; display: none;">Invalid password</p>
            <a href="/" style="display: block; margin-top: 20px; color: #666; font-size: 14px;">Back to Login</a>
        </div>
    </div>

    <div class="container" id="adminContent" style="display: none;">
        <div class="header">
            <div>
                <h1>BSN9B Admin Panel</h1>
                <p style="opacity: 0.8; font-size: 14px;">Manage users, chat, and site settings</p>
            </div>
            <div class="header-actions">
                <span id="firebaseAuthStatus" style="color: rgba(255,255,255,0.8); font-size: 12px; align-self: center;">Firebase: not signed in</span>
                <button class="btn btn-secondary" onclick="openFirebaseAuthModal()">Firebase Sign In</button>
                <button class="btn btn-secondary" onclick="window.location.href='/app/'">Back to App</button>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid" style="margin-bottom: 20px;">
            <div class="card">
                <div class="card-body" style="display: flex; gap: 15px;">
                    <div class="stat-box" style="flex: 1;">
                        <div class="stat-number" id="statOnline">0</div>
                        <div class="stat-label">Online Now</div>
                    </div>
                    <div class="stat-box" style="flex: 1;">
                        <div class="stat-number" id="statRegistered">0</div>
                        <div class="stat-label">Registered Users</div>
                    </div>
                    <div class="stat-box" style="flex: 1;">
                        <div class="stat-number" id="statBanned">0</div>
                        <div class="stat-label">Banned</div>
                    </div>
                    <div class="stat-box" style="flex: 1;">
                        <div class="stat-number" id="statPosts">0</div>
                        <div class="stat-label">Community Posts</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <label>Quick Actions:</label>
            <button class="btn btn-danger btn-sm" onclick="kickAllUsers()">Kick All from Chat</button>
            <button class="btn btn-warning btn-sm" onclick="clearAllMessages()">Clear All Messages</button>
            <button class="btn btn-primary btn-sm" onclick="refreshAll()">Refresh All Data</button>
            <button class="btn btn-sm" style="background: #6c757d; color: white;" onclick="showLoginHistory()">Login History</button>
            <button class="btn btn-sm" style="background: #ff9800; color: white;" onclick="showSmartPhrases()">Manage Smart Phrases</button>
            <button class="btn btn-sm" style="background: #9c27b0; color: white;" onclick="showCommunityStats()">Community Stats</button>
            <button class="btn btn-danger btn-sm" onclick="clearAllPosts()">Clear All Posts</button>
            <button class="btn btn-sm" style="background: #1f4e79; color: white;" onclick="normalizeUserRoles()">Normalize Roles</button>
        </div>

        <!-- Login History Modal -->
        <div id="loginHistoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; padding: 20px; overflow-y: auto;">
            <div style="max-width: 900px; margin: 20px auto; background: white; border-radius: 12px; overflow: hidden;">
                <div style="background: #1f4e79; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 18px;">Login History</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportLoginHistory()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Export CSV</button>
                        <button onclick="clearAllLoginHistory()" style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Clear All</button>
                        <button onclick="closeLoginHistory()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Close</button>
                    </div>
                </div>
                <!-- Bulk Actions Bar -->
                <div id="loginHistoryBulkBar" style="display: none; padding: 10px 20px; background: #f0f7ff; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="selectAllLoginHistory" onchange="toggleSelectAllLoginHistory()">
                        <span style="font-size: 13px; font-weight: 600;">Select All</span>
                    </label>
                    <button id="deleteSelectedBtn" onclick="deleteSelectedLoginHistory()" style="background: #dc3545; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; display: none;">Delete Selected (<span id="selectedCount">0</span>)</button>
                </div>
                <div id="loginHistoryContent" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <!-- Smart Phrases Modal -->
        <div id="smartPhrasesModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; padding: 20px; overflow-y: auto;">
            <div style="max-width: 700px; margin: 20px auto; background: white; border-radius: 12px; overflow: hidden;">
                <div style="background: #ff9800; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 18px;">Manage Smart Phrases</h2>
                    <button onclick="closeSmartPhrases()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Close</button>
                </div>
                <div style="padding: 20px;">
                    <p style="color: #666; margin-bottom: 15px;">Add custom smart phrases that all users can use. Shortcuts start with a period (e.g., .custom)</p>
                    <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="newPhraseShortcut" placeholder=".shortcut" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <input type="text" id="newPhraseText" placeholder="Expansion text..." style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <button onclick="addGlobalPhrase()" style="background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Add</button>
                    </div>
                    <div id="globalPhrasesList" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: #888;">Custom phrases will appear here.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Detail Modal -->
        <div id="postDetailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; padding: 20px; overflow-y: auto;">
            <div style="max-width: 700px; margin: 20px auto; background: white; border-radius: 12px; overflow: hidden;">
                <div style="background: #9c27b0; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 18px;">Post Details</h2>
                    <button onclick="closePostDetail()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Close</button>
                </div>
                <div id="postDetailContent" style="padding: 20px;">
                    <p>Loading...</p>
                </div>
                <div style="padding: 0 20px 20px; display: flex; gap: 10px;">
                    <button id="pinPostBtn" onclick="togglePostPin()" style="background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Pin Post</button>
                    <button onclick="deletePostAdmin()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Delete Post</button>
                </div>
                <div style="padding: 0 20px 20px;">
                    <h4 style="margin: 0 0 10px; color: #333;">Replies</h4>
                    <div id="postRepliesList" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 10px;">
                        <p style="color: #888; margin: 0;">No replies</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Community Stats Modal -->
        <div id="communityStatsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; padding: 20px; overflow-y: auto;">
            <div style="max-width: 500px; margin: 50px auto; background: white; border-radius: 12px; overflow: hidden;">
                <div style="background: #9c27b0; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 18px;">Community Statistics</h2>
                    <button onclick="closeCommunityStats()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Close</button>
                </div>
                <div id="communityStatsContent" style="padding: 20px;">
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Online Users -->
            <div class="card">
                <div class="card-header">
                    <span>Online Users</span>
                    <button class="refresh-btn" onclick="loadOnlineUsers()">&#x21bb;</button>
                </div>
                <div class="card-body" id="onlineUsersList">
                    <div class="empty-state">
                        <div class="icon">&#128274;</div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Banned Users -->
            <div class="card">
                <div class="card-header">
                    <span>Banned Users</span>
                    <button class="refresh-btn" onclick="loadBannedUsers()">&#x21bb;</button>
                </div>
                <div class="card-body" id="bannedUsersList">
                    <div class="empty-state">
                        <div class="icon">&#128683;</div>
                        <p>No banned users</p>
                    </div>
                </div>
            </div>

            <!-- Registered Users -->
            <div class="card">
                <div class="card-header">
                    <span>Registered Users</span>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-warning" onclick="sendWelcomeEmailsToAll()" title="Send welcome email to all users">üìß Email All</button>
                        <button class="refresh-btn" onclick="loadRegisteredUsers()">&#x21bb;</button>
                    </div>
                </div>
                <div style="padding: 8px 15px; background: #e3f2fd; font-size: 11px; color: #1565c0;">
                    <strong>Note:</strong> Ban users here. To fully delete accounts, go to <a href="https://console.firebase.google.com/project/bendbsn-17377/authentication/users" target="_blank" style="color: #1565c0;">Firebase Console ‚Üí Authentication</a>
                </div>
                <div class="card-body tall" id="registeredUsersList">
                    <div class="empty-state">
                        <div class="icon">&#128100;</div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="card">
                <div class="card-header">
                    <span>Recent Chat Messages</span>
                    <button class="refresh-btn" onclick="loadMessages()">&#x21bb;</button>
                </div>
                <div class="card-body tall" id="messagesList">
                    <div class="empty-state">
                        <div class="icon">&#128172;</div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Community Posts -->
            <div class="card" style="grid-column: span 2;">
                <div class="card-header">
                    <span>Community Posts</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="categoryFilter" onchange="loadCommunityPosts()" style="padding: 5px 10px; border-radius: 4px; border: none; font-size: 12px;">
                            <option value="all">All Categories</option>
                            <option value="announcements">Announcements</option>
                            <option value="study-tips">Study Tips</option>
                            <option value="career">Career</option>
                            <option value="nclex">NCLEX</option>
                            <option value="general">General</option>
                        </select>
                        <button class="refresh-btn" onclick="loadCommunityPosts()">&#x21bb;</button>
                    </div>
                </div>
                <div class="card-body tall" id="communityPostsList" style="max-height: 350px;">
                    <div class="empty-state">
                        <div class="icon">&#128221;</div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Auth Modal -->
    <div id="firebaseAuthModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="font-size: 18px;">Firebase Sign In</h2>
                <button onclick="closeFirebaseAuthModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-bottom: 12px;">Sign in so admin actions can update Firebase data.</p>
            <input type="email" id="firebaseAuthEmail" placeholder="Email" autocomplete="email">
            <input type="password" id="firebaseAuthPassword" placeholder="Password" autocomplete="current-password">
            <button class="btn btn-primary" style="width: 100%;" onclick="firebaseAdminSignIn()">Sign In</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script>
        // Admin password - change this!
        const ADMIN_PASSWORD = 'admin1374';
        const API_URL = 'https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec';

        // Firebase setup
        const firebaseConfig = {
            apiKey: "AIzaSyAmr2W8mekSPJ2pXM3gz1FvarfSBddpfLM",
            authDomain: "bendbsn-17377.firebaseapp.com",
            databaseURL: "https://bendbsn-17377-default-rtdb.firebaseio.com",
            projectId: "bendbsn-17377",
            storageBucket: "bendbsn-17377.firebasestorage.app",
            messagingSenderId: "762882187702",
            appId: "1:762882187702:web:81c97c9eae005666796117"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const chatRef = database.ref('chat/messages');
        const presenceRef = database.ref('chat/presence');
        const userProfilesRef = database.ref('userProfiles');
        const ROLE_OPTIONS = ['RN Student', 'Instructor', 'RN', 'Other'];
        let userProfilesByEmail = {};
        let userProfilesByUid = {};

        const SESSION_KEY = 'bsn9b_session_key';
        const SESSION_START_KEY = 'bsn9b_session_start';
        const SESSION_HEARTBEAT_MS = 60000;
        let sessionHeartbeatTimer = null;
        let sessionValidated = false;

        function updateSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey || !sessionValidated) return;
            database.ref('loginHistory/' + sessionKey).update({
                lastSeen: Date.now()
            }).catch(() => {});
        }

        function startSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey) return;
            database.ref('loginHistory/' + sessionKey).once('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val().timestamp) {
                    sessionValidated = true;
                    updateSessionHeartbeat();
                    if (sessionHeartbeatTimer) clearInterval(sessionHeartbeatTimer);
                    sessionHeartbeatTimer = setInterval(updateSessionHeartbeat, SESSION_HEARTBEAT_MS);
                } else {
                    clearSessionTracking();
                }
            }).catch(() => {});
        }

        function endSessionTracking(reason) {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey || !sessionValidated) return;
            if (localStorage.getItem('bsn9b_session_end_sent') === 'true') return;
            const start = parseInt(localStorage.getItem(SESSION_START_KEY) || '0', 10);
            const end = Date.now();
            const durationSeconds = start ? Math.max(0, Math.round((end - start) / 1000)) : null;
            const durationMinutes = durationSeconds !== null ? Math.round(durationSeconds / 60) : null;
            localStorage.setItem('bsn9b_session_end_sent', 'true');
            database.ref('loginHistory/' + sessionKey).update({
                sessionEnd: end,
                durationSeconds: durationSeconds,
                durationMinutes: durationMinutes,
                endReason: reason || 'logout'
            }).catch(() => {});
        }

        function clearSessionTracking() {
            localStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(SESSION_START_KEY);
            localStorage.removeItem('bsn9b_session_end_sent');
        }

        startSessionHeartbeat();
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') updateSessionHeartbeat();
        });
        const bannedRef = database.ref('banned');
        const announcementsRef = database.ref('announcements');
        const communityPostsRef = database.ref('community/posts');

        // Community posts state
        let allCommunityPosts = [];
        let currentPostId = null;

        // Toast notification function
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // EmailJS Configuration
        const EMAILJS_PUBLIC_KEY = 'Paf-N3lByYsImp0af';
        const EMAILJS_SERVICE_ID = 'service_2dw80zz';
        const EMAILJS_TEMPLATE_ID = 'template_ty32lyw';
        emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

        // Send welcome emails to all registered users
        async function sendWelcomeEmailsToAll() {
            if (!confirm('Send welcome email to ALL registered users? This cannot be undone.')) return;

            try {
                const response = await fetch(API_URL + '?action=getUsers');
                const data = await response.json();

                if (!data.success || !data.users) {
                    showToast('Failed to fetch users', 'error');
                    return;
                }

                const users = data.users;
                let sent = 0;
                let failed = 0;

                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
                statusDiv.innerHTML = '<h3>Sending Emails...</h3><p id="emailProgress">0 / ' + users.length + '</p>';
                document.body.appendChild(statusDiv);

                for (let i = 0; i < users.length; i++) {
                    const user = users[i];
                    if (!user.email) continue;

                    try {
                        const templateParams = {
                            to_name: user.name || user.email.split('@')[0],
                            to_email: user.email,
                            reply_to: user.email,
                            login_link: 'https://bendbsn.com',
                            message: 'Your BSN9B account has been successfully created!\n\nPlease use your email address (' + user.email + ') and the password you created to login.\n\nClick the link below to login to your account.'
                        };
                        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams, EMAILJS_PUBLIC_KEY);
                        sent++;
                    } catch (e) {
                        console.error('Failed to send to', user.email, e);
                        failed++;
                    }

                    document.getElementById('emailProgress').textContent = (i + 1) + ' / ' + users.length;
                    await new Promise(r => setTimeout(r, 500)); // Rate limit
                }

                statusDiv.remove();
                showToast('Done! Sent: ' + sent + ', Failed: ' + failed, 'success');
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        // Listen for announcements (alert/fyi banners)
        announcementsRef.on('value', (snapshot) => {
            const data = snapshot.val() || {};
            const alertBanner = document.getElementById('alertBanner');
            const fyiBanner = document.getElementById('fyiBanner');
            const alertText = document.getElementById('alertText');
            const fyiText = document.getElementById('fyiText');

            if (data.alert && data.alert.message) {
                alertText.textContent = data.alert.message;
                alertBanner.style.display = 'block';
                document.body.classList.add('has-alert');
            } else {
                alertBanner.style.display = 'none';
                document.body.classList.remove('has-alert');
            }

            if (data.fyi && data.fyi.message) {
                fyiText.textContent = data.fyi.message;
                fyiBanner.style.display = 'block';
                fyiBanner.style.top = (data.alert && data.alert.message) ? '50px' : '0';
                document.body.classList.add('has-fyi');
            } else {
                fyiBanner.style.display = 'none';
                document.body.classList.remove('has-fyi');
            }
        });

        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                sessionStorage.setItem('bsn9b_admin', 'true');
                initAdmin();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function updateFirebaseAuthStatus() {
            const statusEl = document.getElementById('firebaseAuthStatus');
            const user = auth.currentUser;
            if (!statusEl) return;
            if (user && user.email) {
                statusEl.textContent = 'Firebase: ' + user.email;
            } else {
                statusEl.textContent = 'Firebase: not signed in';
            }
        }

        function openFirebaseAuthModal() {
            document.getElementById('firebaseAuthModal').classList.remove('hidden');
            document.getElementById('firebaseAuthEmail').focus();
        }

        function closeFirebaseAuthModal() {
            document.getElementById('firebaseAuthModal').classList.add('hidden');
        }

        async function firebaseAdminSignIn() {
            const email = document.getElementById('firebaseAuthEmail').value.trim();
            const password = document.getElementById('firebaseAuthPassword').value;
            if (!email || !password) {
                showToast('Enter email and password.', 'error');
                return;
            }
            try {
                await auth.signInWithEmailAndPassword(email, password);
                updateFirebaseAuthStatus();
                closeFirebaseAuthModal();
                showToast('Firebase sign-in successful.', 'success');
            } catch (e) {
                showToast('Firebase sign-in failed: ' + e.message, 'error');
            }
        }

        // Check if already logged in as admin
        if (sessionStorage.getItem('bsn9b_admin') === 'true') {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            initAdmin();
        }

        function initAdmin() {
            auth.onAuthStateChanged(() => updateFirebaseAuthStatus());
            updateFirebaseAuthStatus();
            loadOnlineUsers();
            loadBannedUsers();
            loadRegisteredUsers();
            loadMessages();
            loadCommunityPosts();

            // Real-time updates
            presenceRef.on('value', () => loadOnlineUsers());
            bannedRef.on('value', () => loadBannedUsers());
            chatRef.limitToLast(50).on('value', () => loadMessages());
            communityPostsRef.on('value', () => loadCommunityPosts());
        }

        function logout() {
            auth.signOut().catch(() => {});
            endSessionTracking('logout');
            sessionStorage.removeItem('bsn9b_admin');
            localStorage.removeItem('bsn9b_auth');
            localStorage.removeItem('bsn9b_user');
            localStorage.removeItem('bsn9b_displayName');
            localStorage.removeItem('bsn9b_uid');
            clearSessionTracking();
            window.location.href = '/';
        }

        // Load online users
        function loadOnlineUsers() {
            presenceRef.once('value', (snapshot) => {
                const container = document.getElementById('onlineUsersList');
                const count = snapshot.numChildren();
                document.getElementById('statOnline').textContent = count;

                if (!snapshot.exists() || count === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">&#128564;</div><p>No users online</p></div>';
                    return;
                }

                let html = '';
                snapshot.forEach((child) => {
                    const user = child.val();
                    const key = child.key;
                    html += `
                        <div class="user-item">
                            <div class="user-info">
                                <span class="online-dot"></span>
                                <span class="user-name">${user.user || 'Anonymous'}</span>
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-warning btn-sm" onclick="kickUser('${key}', '${user.user}')">Kick</button>
                                <button class="btn btn-danger btn-sm" onclick="banUser('${user.user}')">Ban</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }

        // Load banned users
        function loadBannedUsers() {
            bannedRef.once('value', (snapshot) => {
                const container = document.getElementById('bannedUsersList');
                const count = snapshot.numChildren();
                document.getElementById('statBanned').textContent = count;

                if (!snapshot.exists() || count === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">&#9989;</div><p>No banned users</p></div>';
                    return;
                }

                let html = '';
                snapshot.forEach((child) => {
                    const data = child.val();
                    const key = child.key;
                    html += `
                        <div class="user-item">
                            <div class="user-info">
                                <span class="user-name">${data.username}</span>
                                <div class="user-status status-banned">Banned: ${data.reason || 'No reason given'}</div>
                                <div class="user-email">Banned on: ${new Date(data.timestamp).toLocaleString()}</div>
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-success btn-sm" onclick="unbanUser('${key}')">Unban</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }

        async function refreshUserProfilesMap() {
            userProfilesByEmail = {};
            userProfilesByUid = {};
            if (!auth.currentUser) return;
            try {
                const snapshot = await userProfilesRef.once('value');
                if (!snapshot.exists()) return;
                snapshot.forEach((child) => {
                    const profile = child.val() || {};
                    const uid = child.key;
                    const emailKey = (profile.email || '').toLowerCase();
                    userProfilesByUid[uid] = profile;
                    if (emailKey) {
                        userProfilesByEmail[emailKey] = { uid: uid, ...profile };
                    }
                });
            } catch (e) {
                console.warn('Failed to load user profiles for roles:', e);
            }
        }

        function getRoleOptionsHtml(selected) {
            return ROLE_OPTIONS.map((role) => {
                const isSelected = role === selected ? 'selected' : '';
                return `<option value="${role}" ${isSelected}>${role}</option>`;
            }).join('');
        }

        async function updateUserRole(uid, email, role) {
            if (!auth.currentUser) {
                showToast('Sign in to Firebase first.', 'error');
                openFirebaseAuthModal();
                return;
            }

            try {
                // If user has a Firebase profile (has logged in), update it
                if (uid && uid !== 'undefined' && uid !== '') {
                    await userProfilesRef.child(uid).update({
                        role: role,
                        email: email || null,
                        updatedAt: Date.now()
                    });
                }

                // Always update Google Sheet role too (works even if user hasn't logged in)
                if (email) {
                    const params = new URLSearchParams({
                        action: 'updateRole',
                        email: email,
                        role: role
                    });
                    await fetch(API_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' });
                }

                showToast(`Role updated to ${role}`, 'success');
                await refreshUserProfilesMap();
                loadRegisteredUsers();
            } catch (e) {
                showToast('Failed to update role: ' + e.message, 'error');
            }
        }

        // Load registered users from Google Sheets
        async function loadRegisteredUsers() {
            const container = document.getElementById('registeredUsersList');
            try {
                await refreshUserProfilesMap();
                const response = await fetch(API_URL + '?action=getUsers');
                const data = await response.json();

                if (data.success && data.users) {
                    const users = data.users;
                    document.getElementById('statRegistered').textContent = users.length;

                    if (users.length === 0) {
                        container.innerHTML = '<div class="empty-state"><div class="icon">&#128100;</div><p>No registered users</p></div>';
                        return;
                    }

                    let html = '';
                    users.forEach((user) => {
                        const statusClass = user.status === 'approved' ? 'status-approved' :
                                           user.status === 'banned' ? 'status-banned' : 'status-pending';
                        const emailKey = (user.email || '').toLowerCase();
                        const profile = userProfilesByEmail[emailKey] || null;
                        const roleValue = (profile && profile.role) || user.role || 'RN Student';
                        const roleLabel = roleValue || 'RN Student';
                        const profileUid = profile ? profile.uid : '';
                        const roleSelect = auth.currentUser
                            ? `<select style="padding: 4px 6px; border-radius: 6px; border: 1px solid #ddd; font-size: 12px; margin-right: 6px;">
                                   ${getRoleOptionsHtml(roleLabel)}
                               </select>`
                            : `<span style="font-size: 12px; color: #666;">${roleLabel}</span>`;
                        html += `
                            <div class="user-item">
                                <div class="user-info">
                                    <div class="user-name">${user.name || user.username}</div>
                                    <div class="user-email">${user.email || ''} | @${user.username}</div>
                                    <div class="user-status ${statusClass}">${user.status || 'pending'}</div>
                                    <div class="user-status" style="font-size: 11px; color: #1f4e79;">Role: ${roleLabel}</div>
                                </div>
                                <div class="user-actions">
                                    ${user.status !== 'approved' ? `<button class="btn btn-success btn-sm" onclick="approveUser('${user.username}')">Approve</button>` : ''}
                                    ${auth.currentUser ? `
                                        ${roleSelect}
                                        <button class="btn btn-sm btn-primary" onclick="updateUserRole('${profileUid}', '${user.email || ''}', this.previousElementSibling.value)">Save Role</button>
                                    ` : ''}
                                    <button class="btn btn-danger btn-sm" onclick="banUser('${user.username}')">Ban</button>
                                    <button class="btn btn-sm" style="background:#dc3545;color:white;" onclick="deleteUser('${user.username}', '${user.email || ''}', '${profileUid}', '${user.name || user.username}')" title="Permanently delete user">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="icon">&#128679;</div><p>Could not load users</p></div>';
                }
            } catch (e) {
                console.error('Error loading users:', e);
                container.innerHTML = '<div class="empty-state"><div class="icon">&#128679;</div><p>Error loading users</p></div>';
            }
        }

        // Load chat messages
        function loadMessages() {
            chatRef.limitToLast(50).once('value', (snapshot) => {
                const container = document.getElementById('messagesList');

                if (!snapshot.exists()) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">&#128172;</div><p>No messages</p></div>';
                    return;
                }

                let html = '';
                const messages = [];
                snapshot.forEach((child) => {
                    messages.push({ key: child.key, ...child.val() });
                });

                // Sort by timestamp descending (newest first)
                messages.sort((a, b) => b.timestamp - a.timestamp);

                messages.forEach((msg) => {
                    html += `
                        <div class="message-item">
                            <div class="message-content">
                                <div class="message-user">${msg.user}</div>
                                <div class="message-text">${msg.text}</div>
                                <div class="message-time">${new Date(msg.timestamp).toLocaleString()}</div>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="deleteMessage('${msg.key}')">Delete</button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }

        // Kick user from chat
        function kickUser(presenceKey, username) {
            if (confirm(`Kick ${username} from chat?`)) {
                presenceRef.child(presenceKey).remove()
                    .then(() => showToast(`${username} has been kicked from chat`, 'success'))
                    .catch((e) => showToast('Error: ' + e.message, 'error'));
            }
        }

        // Kick all users
        function kickAllUsers() {
            if (confirm('Kick ALL users from chat? They will need to refresh to reconnect.')) {
                presenceRef.remove()
                    .then(() => showToast('All users have been kicked from chat', 'success'))
                    .catch((e) => showToast('Error: ' + e.message, 'error'));
            }
        }

        // Ban user
        function banUser(username) {
            const reason = prompt(`Ban ${username}? Enter reason (optional):`, 'Rule violation');
            if (reason !== null) {
                bannedRef.push({
                    username: username,
                    reason: reason,
                    timestamp: Date.now(),
                    bannedBy: 'admin'
                }).then(() => {
                    showToast(`${username} has been banned`, 'success');
                    // Also kick them from chat
                    presenceRef.once('value', (snapshot) => {
                        snapshot.forEach((child) => {
                            if (child.val().user === username) {
                                child.ref.remove();
                            }
                        });
                    });
                }).catch((e) => showToast('Error: ' + e.message, 'error'));
            }
        }

        // Unban user
        function unbanUser(banKey) {
            if (confirm('Unban this user?')) {
                bannedRef.child(banKey).remove()
                    .then(() => showToast('User has been unbanned', 'success'))
                    .catch((e) => showToast('Error: ' + e.message, 'error'));
            }
        }

        // Approve user (update Google Sheets)
        async function approveUser(username) {
            if (confirm(`Approve ${username}?`)) {
                try {
                    const params = new URLSearchParams({
                        action: 'updateStatus',
                        username: username,
                        status: 'approved'
                    });
                    await fetch(API_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' });
                    showToast(`${username} has been approved`, 'success');
                    loadRegisteredUsers();
                } catch (e) {
                    showToast('Error: ' + e.message, 'error');
                }
            }
        }

        // Delete user completely
        async function deleteUser(username, email, uid, displayName) {
            const confirmMsg = `PERMANENTLY DELETE "${displayName || username}"?\n\nThis will remove:\n‚Ä¢ User profile from database\n‚Ä¢ User from Google Sheet\n\nYou'll also need to delete from Firebase Auth Console.\n\nThis cannot be undone!`;

            if (!confirm(confirmMsg)) return;
            if (!confirm('Are you REALLY sure? Type OK to confirm.')) return;

            let deletedItems = [];
            let errors = [];

            try {
                // 1. Delete from Firebase userProfiles (if uid exists)
                if (uid && uid !== 'undefined' && uid !== '') {
                    try {
                        await userProfilesRef.child(uid).remove();
                        deletedItems.push('Firebase profile');
                    } catch (e) {
                        errors.push('Firebase profile: ' + e.message);
                    }
                }

                // 2. Delete from Google Sheet
                try {
                    const params = new URLSearchParams({
                        action: 'deleteUser',
                        username: username,
                        email: email
                    });
                    await fetch(API_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' });
                    deletedItems.push('Google Sheet');
                } catch (e) {
                    errors.push('Google Sheet: ' + e.message);
                }

                // 3. Remove from banned list if present
                try {
                    const bannedSnapshot = await bannedRef.once('value');
                    bannedSnapshot.forEach((child) => {
                        if (child.val().username === username || child.val().username === email) {
                            child.ref.remove();
                        }
                    });
                } catch (e) {
                    // Ignore ban removal errors
                }

                // 4. Show results
                if (deletedItems.length > 0) {
                    showToast(`Deleted from: ${deletedItems.join(', ')}`, 'success');
                }
                if (errors.length > 0) {
                    showToast(`Errors: ${errors.join('; ')}`, 'warning');
                }

                // 5. Open Firebase Console for Auth deletion
                const openConsole = confirm('User data deleted!\n\nOpen Firebase Console to delete the Auth account?\n\n(Required to fully remove the user)');
                if (openConsole) {
                    window.open('https://console.firebase.google.com/project/bendbsn-17377/authentication/users', '_blank');
                }

                // Refresh user list
                loadRegisteredUsers();

            } catch (e) {
                showToast('Error deleting user: ' + e.message, 'error');
            }
        }

        // Delete message
        function deleteMessage(messageKey) {
            if (confirm('Delete this message?')) {
                chatRef.child(messageKey).remove()
                    .then(() => loadMessages())
                    .catch((e) => showToast('Error: ' + e.message, 'error'));
            }
        }

        // Clear all messages
        function clearAllMessages() {
            if (confirm('Delete ALL chat messages? This cannot be undone.')) {
                chatRef.remove()
                    .then(() => {
                        showToast('All messages have been deleted', 'success');
                        loadMessages();
                    })
                    .catch((e) => showToast('Error: ' + e.message, 'error'));
            }
        }

        // Refresh all data
        function refreshAll() {
            loadOnlineUsers();
            loadBannedUsers();
            loadRegisteredUsers();
            loadMessages();
            loadCommunityPosts();
        }

        // Login History - use correct Firebase URL
        const loginHistoryRef = firebase.database().ref('loginHistory');
        let loginHistoryData = [];

        function showLoginHistory() {
            document.getElementById('loginHistoryModal').style.display = 'block';
            loadLoginHistory();
        }

        function closeLoginHistory() {
            document.getElementById('loginHistoryModal').style.display = 'none';
        }

        function formatDuration(seconds) {
            const s = Math.max(0, Math.floor(seconds));
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            if (h > 0) return `${h}h ${m}m`;
            if (m > 0) return `${m}m ${sec}s`;
            return `${sec}s`;
        }

        let loginHistoryKeys = {}; // Map of index to Firebase key

        function loadLoginHistory() {
            const container = document.getElementById('loginHistoryContent');
            const bulkBar = document.getElementById('loginHistoryBulkBar');
            container.innerHTML = '<p>Loading...</p>';
            loginHistoryKeys = {};

            // Check if Firebase Auth is signed in (required by database rules)
            const currentUser = auth.currentUser;
            console.log('Login History - Current user:', currentUser ? currentUser.email : 'none');

            if (!currentUser) {
                bulkBar.style.display = 'none';
                container.innerHTML = '<div style="text-align: center; padding: 20px;"><p style="color: #dc3545; font-weight: bold;">Firebase authentication required</p><p style="color: #666; margin: 10px 0;">Click the "Firebase Auth" button in the header to sign in with your admin credentials.</p><button onclick="closeLoginHistory(); openFirebaseAuthModal();" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;">Sign in to Firebase</button></div>';
                return;
            }

            container.innerHTML = '<p>Loading as ' + currentUser.email + '...</p>';

            loginHistoryRef.orderByChild('timestamp').limitToLast(200).once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    bulkBar.style.display = 'none';
                    container.innerHTML = '<p style="color: #666; text-align: center;">No login history found</p>';
                    return;
                }

                loginHistoryData = [];
                let idx = 0;
                snapshot.forEach((child) => {
                    loginHistoryData.push({ key: child.key, ...child.val() });
                    loginHistoryKeys[idx] = child.key;
                    idx++;
                });

                // Sort newest first
                loginHistoryData.sort((a, b) => b.timestamp - a.timestamp);

                // Show bulk bar
                bulkBar.style.display = 'flex';
                document.getElementById('selectAllLoginHistory').checked = false;
                document.getElementById('deleteSelectedBtn').style.display = 'none';

                let html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                html += '<thead><tr style="background: #f0f0f0;">';
                html += '<th style="padding: 10px; width: 40px; text-align: center; border-bottom: 2px solid #ddd;"></th>';
                html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Date/Time</th>';
                html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Username</th>';
                html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Display Name</th>';
                html += '<th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Duration</th>';
                html += '<th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Status</th>';
                html += '<th style="padding: 10px; width: 50px; text-align: center; border-bottom: 2px solid #ddd;"></th>';
                html += '</tr></thead><tbody>';

                loginHistoryData.forEach((login, index) => {
                    // Handle missing or invalid timestamps
                    let date = 'Invalid entry';
                    if (login.timestamp && typeof login.timestamp === 'number') {
                        const dateObj = new Date(login.timestamp);
                        if (!isNaN(dateObj.getTime())) {
                            date = dateObj.toLocaleString();
                        }
                    } else if (login.date) {
                        date = login.date; // Fallback to stored date string
                    }

                    const statusColor = login.success ? '#28a745' : '#dc3545';
                    const statusText = login.success ? 'Success' : 'Failed';
                    const start = login.timestamp || 0;
                    const end = login.sessionEnd || login.lastSeen || null;
                    let durationSeconds = login.durationSeconds;
                    if ((!durationSeconds || durationSeconds === 0) && start && end) {
                        durationSeconds = Math.max(0, Math.round((end - start) / 1000));
                    }
                    const durationLabel = durationSeconds
                        ? formatDuration(durationSeconds)
                        : (login.success ? 'Active' : '‚Äî');

                    // Mark invalid entries with warning style
                    const isInvalid = date === 'Invalid entry';
                    const rowStyle = isInvalid ? 'background: #fff5f5;' : '';

                    html += `<tr style="border-bottom: 1px solid #eee; ${rowStyle}" data-key="${login.key}">
                        <td style="padding: 8px 10px; text-align: center;"><input type="checkbox" class="login-history-checkbox" data-key="${login.key}" onchange="updateSelectedCount()"></td>
                        <td style="padding: 8px 10px;">${date}${isInvalid ? ' <span style="color:#dc3545;font-size:10px;">(corrupted)</span>' : ''}</td>
                        <td style="padding: 8px 10px; font-weight: 500;">${login.username || 'N/A'}</td>
                        <td style="padding: 8px 10px;">${login.displayName || 'N/A'}</td>
                        <td style="padding: 8px 10px; text-align: center;">${durationLabel}</td>
                        <td style="padding: 8px 10px; text-align: center;"><span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${statusText}</span></td>
                        <td style="padding: 8px 10px; text-align: center;"><button onclick="deleteLoginHistoryEntry('${login.key}')" style="background: none; border: none; cursor: pointer; font-size: 16px;" title="Delete entry">üóëÔ∏è</button></td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            }).catch((error) => {
                console.error('Login history error:', error);
                bulkBar.style.display = 'none';
                const userEmail = auth.currentUser ? auth.currentUser.email : 'not signed in';
                container.innerHTML = `<div style="text-align: center; padding: 20px;">
                    <p style="color: #dc3545; font-weight: bold;">Permission denied</p>
                    <p style="color: #666; margin: 10px 0;">Error: ${error.message || error.code || 'Unknown error'}</p>
                    <p style="color: #666; margin: 10px 0;">Current Firebase user: <strong>${userEmail}</strong></p>
                    <p style="color: #666; margin: 10px 0;">Required: christiankholden@gmail.com</p>
                    <button onclick="closeLoginHistory(); openFirebaseAuthModal();" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;">Sign in to Firebase</button>
                </div>`;
            });
        }

        function clearAllLoginHistory() {
            if (!confirm('Delete ALL login history records? This cannot be undone.')) return;
            if (!confirm('Are you REALLY sure? This will permanently delete all login history.')) return;

            loginHistoryRef.remove()
                .then(() => {
                    showToast('All login history deleted', 'success');
                    loadLoginHistory();
                })
                .catch((e) => showToast('Error: ' + e.message, 'error'));
        }

        function deleteLoginHistoryEntry(key) {
            if (!confirm('Delete this login history entry?')) return;

            loginHistoryRef.child(key).remove()
                .then(() => {
                    showToast('Entry deleted', 'success');
                    loadLoginHistory();
                })
                .catch((e) => showToast('Error: ' + e.message, 'error'));
        }

        function toggleSelectAllLoginHistory() {
            const selectAll = document.getElementById('selectAllLoginHistory').checked;
            const checkboxes = document.querySelectorAll('.login-history-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.login-history-checkbox:checked');
            const count = checkboxes.length;
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');

            if (count > 0) {
                deleteBtn.style.display = 'inline-block';
                countSpan.textContent = count;
            } else {
                deleteBtn.style.display = 'none';
            }

            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.login-history-checkbox');
            const selectAllCb = document.getElementById('selectAllLoginHistory');
            if (allCheckboxes.length > 0 && count === allCheckboxes.length) {
                selectAllCb.checked = true;
            } else {
                selectAllCb.checked = false;
            }
        }

        function deleteSelectedLoginHistory() {
            const checkboxes = document.querySelectorAll('.login-history-checkbox:checked');
            const keys = Array.from(checkboxes).map(cb => cb.dataset.key);

            if (keys.length === 0) {
                showToast('No entries selected', 'info');
                return;
            }

            if (!confirm(`Delete ${keys.length} selected login history entries?`)) return;

            const promises = keys.map(key => loginHistoryRef.child(key).remove());
            Promise.all(promises)
                .then(() => {
                    showToast(`${keys.length} entries deleted`, 'success');
                    loadLoginHistory();
                })
                .catch((e) => showToast('Error: ' + e.message, 'error'));
        }

        function exportLoginHistory() {
            if (loginHistoryData.length === 0) {
                showToast('No data to export', 'info');
                return;
            }

            let csv = 'Date/Time,Username,Display Name,Status,Duration (sec),User Agent\n';
            loginHistoryData.forEach((login) => {
                const date = new Date(login.timestamp).toLocaleString();
                const status = login.success ? 'Success' : 'Failed';
                const userAgent = (login.userAgent || '').replace(/,/g, ';');
                const start = login.timestamp || 0;
                const end = login.sessionEnd || login.lastSeen || null;
                let durationSeconds = login.durationSeconds;
                if ((!durationSeconds || durationSeconds === 0) && start && end) {
                    durationSeconds = Math.max(0, Math.round((end - start) / 1000));
                }
                csv += `"${date}","${login.username || ''}","${login.displayName || ''}","${status}","${durationSeconds || ''}","${userAgent}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'login-history-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Smart Phrases Management
        const globalPhrasesRef = database.ref('globalPhrases');

        function showSmartPhrases() {
            document.getElementById('smartPhrasesModal').style.display = 'block';
            loadGlobalPhrases();
        }

        function closeSmartPhrases() {
            document.getElementById('smartPhrasesModal').style.display = 'none';
        }

        function loadGlobalPhrases() {
            const container = document.getElementById('globalPhrasesList');
            container.innerHTML = '<p style="color: #888;">Loading...</p>';

            globalPhrasesRef.once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="color: #888;">No custom phrases added yet.</p>';
                    return;
                }

                let html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                html += '<tr style="background: #fff3e0;"><th style="padding: 8px; text-align: left;">Shortcut</th><th style="padding: 8px; text-align: left;">Expansion</th><th style="padding: 8px; width: 60px;"></th></tr>';

                snapshot.forEach((child) => {
                    const phrase = child.val();
                    const key = child.key;
                    html += `<tr style="border-bottom: 1px solid #ffe0b2;">
                        <td style="padding: 8px;"><code style="background: #e65100; color: white; padding: 2px 6px; border-radius: 4px;">${phrase.shortcut}</code></td>
                        <td style="padding: 8px;">${phrase.text.substring(0, 50)}${phrase.text.length > 50 ? '...' : ''}</td>
                        <td style="padding: 8px;"><button onclick="deleteGlobalPhrase('${key}')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">X</button></td>
                    </tr>`;
                });
                html += '</table>';
                container.innerHTML = html;
            });
        }

        function addGlobalPhrase() {
            let shortcut = document.getElementById('newPhraseShortcut').value.trim().toLowerCase();
            const text = document.getElementById('newPhraseText').value.trim();

            if (!shortcut || !text) {
                showToast('Please enter both shortcut and expansion text.', 'error');
                return;
            }

            if (!shortcut.startsWith('.')) {
                shortcut = '.' + shortcut;
            }

            globalPhrasesRef.push({
                shortcut: shortcut,
                text: text,
                addedBy: 'admin',
                timestamp: Date.now()
            }).then(() => {
                document.getElementById('newPhraseShortcut').value = '';
                document.getElementById('newPhraseText').value = '';
                loadGlobalPhrases();
                showToast('Smart phrase added: ' + shortcut, 'success');
            }).catch((e) => showToast('Error: ' + e.message, 'error'));
        }

        function deleteGlobalPhrase(key) {
            if (confirm('Delete this smart phrase?')) {
                globalPhrasesRef.child(key).remove()
                    .then(() => loadGlobalPhrases())
                    .catch((e) => showToast('Error: ' + e.message, 'error'));
            }
        }

        // ========== COMMUNITY POSTS MANAGEMENT ==========

        function getCategoryLabel(cat) {
            const labels = {
                'announcements': 'Announcements',
                'study-tips': 'Study Tips',
                'career': 'Career',
                'nclex': 'NCLEX',
                'general': 'General'
            };
            return labels[cat] || cat;
        }

        function getCategoryColor(cat) {
            const colors = {
                'announcements': '#e94560',
                'study-tips': '#28a745',
                'career': '#007bff',
                'nclex': '#ff9800',
                'general': '#6c757d'
            };
            return colors[cat] || '#6c757d';
        }

        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + 'm ago';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + 'h ago';
            const days = Math.floor(hours / 24);
            if (days < 7) return days + 'd ago';
            return new Date(timestamp).toLocaleDateString();
        }

        function loadCommunityPosts() {
            const container = document.getElementById('communityPostsList');
            const filter = document.getElementById('categoryFilter').value;

            communityPostsRef.once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">&#128221;</div><p>No community posts</p></div>';
                    document.getElementById('statPosts').textContent = '0';
                    allCommunityPosts = [];
                    return;
                }

                allCommunityPosts = [];
                snapshot.forEach((child) => {
                    allCommunityPosts.push({ id: child.key, ...child.val() });
                });

                // Update stat
                document.getElementById('statPosts').textContent = allCommunityPosts.length;

                // Sort by pinned first, then by timestamp (newest first)
                allCommunityPosts.sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return (b.timestamp || 0) - (a.timestamp || 0);
                });

                // Filter by category
                let filtered = allCommunityPosts;
                if (filter !== 'all') {
                    filtered = allCommunityPosts.filter(p => p.category === filter);
                }

                if (filtered.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">&#128221;</div><p>No posts in this category</p></div>';
                    return;
                }

                let html = '<table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
                html += '<thead><tr style="background: #f8f9fa;">';
                html += '<th style="padding: 8px; text-align: left;">Title</th>';
                html += '<th style="padding: 8px; text-align: left;">Author</th>';
                html += '<th style="padding: 8px; text-align: center;">Category</th>';
                html += '<th style="padding: 8px; text-align: center;">Stats</th>';
                html += '<th style="padding: 8px; text-align: center;">Actions</th>';
                html += '</tr></thead><tbody>';

                filtered.forEach((post) => {
                    const pinIcon = post.pinned ? 'üìå ' : '';
                    const replyCount = post.replies ? Object.keys(post.replies).length : 0;
                    const likeCount = post.likes || 0;
                    const categoryColor = getCategoryColor(post.category);

                    html += `<tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px;">
                            <div style="font-weight: 600; color: #333;">${pinIcon}${escapeHtml(post.title || 'Untitled')}</div>
                            <div style="font-size: 11px; color: #888;">${formatTimeAgo(post.timestamp)}</div>
                        </td>
                        <td style="padding: 8px; color: #666;">${escapeHtml(post.authorName || 'Unknown')}</td>
                        <td style="padding: 8px; text-align: center;">
                            <span style="background: ${categoryColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${getCategoryLabel(post.category)}</span>
                        </td>
                        <td style="padding: 8px; text-align: center; font-size: 12px;">
                            <span title="Likes">‚ù§Ô∏è ${likeCount}</span>
                            <span title="Replies" style="margin-left: 8px;">üí¨ ${replyCount}</span>
                        </td>
                        <td style="padding: 8px; text-align: center;">
                            <button onclick="viewPostDetail('${post.id}')" class="btn btn-sm" style="background: #9c27b0; color: white; margin-right: 4px;">View</button>
                            <button onclick="quickTogglePin('${post.id}', ${!!post.pinned})" class="btn btn-sm btn-warning" style="margin-right: 4px;">${post.pinned ? 'Unpin' : 'Pin'}</button>
                            <button onclick="quickDeletePost('${post.id}', '${escapeHtml(post.title || 'this post')}')" class="btn btn-sm btn-danger">Delete</button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function viewPostDetail(postId) {
            currentPostId = postId;
            const post = allCommunityPosts.find(p => p.id === postId);
            if (!post) {
                showToast('Post not found', 'error');
                return;
            }

            const container = document.getElementById('postDetailContent');
            const pinBtn = document.getElementById('pinPostBtn');
            pinBtn.textContent = post.pinned ? 'Unpin Post' : 'Pin Post';

            const categoryColor = getCategoryColor(post.category);
            container.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <span style="background: ${categoryColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${getCategoryLabel(post.category)}</span>
                    ${post.pinned ? '<span style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-left: 8px;">üìå Pinned</span>' : ''}
                </div>
                <h3 style="margin: 0 0 10px; color: #333;">${escapeHtml(post.title || 'Untitled')}</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                    By <strong>${escapeHtml(post.authorName || 'Unknown')}</strong> ‚Ä¢ ${new Date(post.timestamp).toLocaleString()}
                </p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-size: 14px; color: #333; max-height: 200px; overflow-y: auto;">${escapeHtml(post.content || 'No content')}</div>
                <div style="margin-top: 15px; display: flex; gap: 20px; color: #666; font-size: 13px;">
                    <span>‚ù§Ô∏è ${post.likes || 0} likes</span>
                    <span>üí¨ ${post.replies ? Object.keys(post.replies).length : 0} replies</span>
                </div>
            `;

            loadPostReplies(postId, post.replies);
            document.getElementById('postDetailModal').style.display = 'block';
        }

        function loadPostReplies(postId, replies) {
            const container = document.getElementById('postRepliesList');

            if (!replies || Object.keys(replies).length === 0) {
                container.innerHTML = '<p style="color: #888; margin: 0; text-align: center;">No replies yet</p>';
                return;
            }

            const replyArray = Object.entries(replies).map(([key, val]) => ({ id: key, ...val }));
            replyArray.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

            let html = '';
            replyArray.forEach((reply) => {
                html += `<div style="padding: 10px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 12px; color: #1f4e79;">${escapeHtml(reply.authorName || 'Unknown')}</div>
                        <div style="font-size: 13px; color: #333; margin: 4px 0;">${escapeHtml(reply.content || '')}</div>
                        <div style="font-size: 11px; color: #888;">${formatTimeAgo(reply.timestamp)}</div>
                    </div>
                    <button onclick="deleteReply('${postId}', '${reply.id}')" class="btn btn-danger btn-sm" style="flex-shrink: 0;">Delete</button>
                </div>`;
            });

            container.innerHTML = html;
        }

        function closePostDetail() {
            document.getElementById('postDetailModal').style.display = 'none';
            currentPostId = null;
        }

        function deleteReply(postId, replyId) {
            if (!confirm('Delete this reply?')) return;

            communityPostsRef.child(postId).child('replies').child(replyId).remove()
                .then(() => {
                    showToast('Reply deleted', 'success');
                    // Reload the post detail
                    communityPostsRef.child(postId).once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const post = snapshot.val();
                            loadPostReplies(postId, post.replies);
                        }
                    });
                    loadCommunityPosts();
                })
                .catch((e) => showToast('Error: ' + e.message, 'error'));
        }

        function togglePostPin() {
            if (!currentPostId) return;

            const post = allCommunityPosts.find(p => p.id === currentPostId);
            if (!post) return;

            const newPinned = !post.pinned;
            communityPostsRef.child(currentPostId).update({ pinned: newPinned })
                .then(() => {
                    showToast(newPinned ? 'Post pinned' : 'Post unpinned', 'success');
                    document.getElementById('pinPostBtn').textContent = newPinned ? 'Unpin Post' : 'Pin Post';
                    loadCommunityPosts();
                })
                .catch((e) => showToast('Error: ' + e.message, 'error'));
        }

        function quickTogglePin(postId, currentlyPinned) {
            const newPinned = !currentlyPinned;
            communityPostsRef.child(postId).update({ pinned: newPinned })
                .then(() => {
                    showToast(newPinned ? 'Post pinned' : 'Post unpinned', 'success');
                    loadCommunityPosts();
                })
                .catch((e) => showToast('Error: ' + e.message, 'error'));
        }

        function deletePostAdmin() {
            if (!currentPostId) return;

            const post = allCommunityPosts.find(p => p.id === currentPostId);
            const title = post ? post.title : 'this post';

            if (!confirm(`Delete "${title}"? This cannot be undone.`)) return;

            communityPostsRef.child(currentPostId).remove()
                .then(() => {
                    showToast('Post deleted', 'success');
                    closePostDetail();
                    loadCommunityPosts();
                })
                .catch((e) => showToast('Error: ' + e.message, 'error'));
        }

        function quickDeletePost(postId, title) {
            if (!confirm(`Delete "${title}"? This cannot be undone.`)) return;

            communityPostsRef.child(postId).remove()
                .then(() => {
                    showToast('Post deleted', 'success');
                    loadCommunityPosts();
                })
                .catch((e) => showToast('Error: ' + e.message, 'error'));
        }

        function clearAllPosts() {
            if (!confirm('Delete ALL community posts? This cannot be undone!')) return;
            if (!confirm('Are you REALLY sure? This will permanently delete all posts and replies.')) return;

            communityPostsRef.remove()
                .then(() => {
                    showToast('All community posts deleted', 'success');
                    loadCommunityPosts();
                })
                .catch((e) => showToast('Error: ' + e.message, 'error'));
        }

        function showCommunityStats() {
            document.getElementById('communityStatsModal').style.display = 'block';
            renderCommunityStats();
        }

        function closeCommunityStats() {
            document.getElementById('communityStatsModal').style.display = 'none';
        }

        function renderCommunityStats() {
            const container = document.getElementById('communityStatsContent');

            if (allCommunityPosts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">No community posts to analyze</p>';
                return;
            }

            const totalPosts = allCommunityPosts.length;
            let totalReplies = 0;
            let totalLikes = 0;
            let pinnedCount = 0;
            const authorCounts = {};
            const categoryCounts = {};

            allCommunityPosts.forEach((post) => {
                if (post.replies) totalReplies += Object.keys(post.replies).length;
                totalLikes += post.likes || 0;
                if (post.pinned) pinnedCount++;

                const author = post.authorName || 'Unknown';
                authorCounts[author] = (authorCounts[author] || 0) + 1;

                const cat = post.category || 'general';
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            });

            // Find top contributor
            let topContributor = 'N/A';
            let maxPosts = 0;
            Object.entries(authorCounts).forEach(([name, count]) => {
                if (count > maxPosts) {
                    maxPosts = count;
                    topContributor = name;
                }
            });

            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="stat-box">
                        <div class="stat-number">${totalPosts}</div>
                        <div class="stat-label">Total Posts</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${totalReplies}</div>
                        <div class="stat-label">Total Replies</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${totalLikes}</div>
                        <div class="stat-label">Total Likes</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${pinnedCount}</div>
                        <div class="stat-label">Pinned Posts</div>
                    </div>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px; color: #1f4e79;">Top Contributor</h4>
                    <p style="margin: 0; font-size: 16px; font-weight: 600;">${escapeHtml(topContributor)} <span style="color: #888; font-weight: normal;">(${maxPosts} posts)</span></p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px; color: #1f4e79;">Posts by Category</h4>
            `;

            Object.entries(categoryCounts).forEach(([cat, count]) => {
                const color = getCategoryColor(cat);
                const percent = Math.round((count / totalPosts) * 100);
                html += `<div style="margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>${getCategoryLabel(cat)}</span>
                        <span>${count} (${percent}%)</span>
                    </div>
                    <div style="height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${percent}%; background: ${color};"></div>
                    </div>
                </div>`;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // ========== END COMMUNITY POSTS MANAGEMENT ==========

        async function normalizeUserRoles() {
            if (!confirm('Set all users to RN Student and set Ann to Instructor?')) return;
            if (!auth.currentUser) {
                showToast('Sign in to Firebase first.', 'error');
                openFirebaseAuthModal();
                return;
            }
            const annEmail = 'amottesen@gmail.com';
            try {
                const snapshot = await userProfilesRef.once('value');
                if (!snapshot.exists()) {
                    showToast('No user profiles found.', 'info');
                    return;
                }
                const updates = {};
                let total = 0;
                let annFound = false;
                snapshot.forEach((child) => {
                    const profile = child.val() || {};
                    const email = (profile.email || '').toLowerCase();
                    const role = email === annEmail ? 'Instructor' : 'RN Student';
                    if (email === annEmail) annFound = true;
                    updates[child.key + '/role'] = role;
                    total += 1;
                });
                await userProfilesRef.update(updates);
                const annStatus = annFound ? 'Ann set to Instructor.' : 'Ann not found in userProfiles.';
                showToast(`Roles updated for ${total} users. ${annStatus}`, 'success');
            } catch (e) {
                console.error('Role normalization failed:', e);
                showToast('Failed to normalize roles: ' + e.message, 'error');
            }
        }

    </script>

    <!-- Bottom Toolbar -->
    <nav class="bottom-toolbar">
        <a href="/home/" class="toolbar-item">
            <span class="icon">&#127968;</span>
            <span class="label">Home</span>
        </a>
        <a href="/app/" class="toolbar-item">
            <span class="icon">&#128221;</span>
            <span class="label">RN Notes</span>
        </a>
        <a href="/community/" class="toolbar-item">
            <span class="icon">&#128172;</span>
            <span class="label">Community</span>
        </a>
        <a href="/resources/" class="toolbar-item">
            <span class="icon">&#128218;</span>
            <span class="label">Resources</span>
        </a>
        <a href="/admin/" class="toolbar-item active">
            <span class="icon">&#9881;&#65039;</span>
            <span class="label">Admin</span>
        </a>
        <button class="toolbar-item" onclick="logout()">
            <span class="icon">&#128682;</span>
            <span class="label">Logout</span>
        </button>
    </nav>
</body>
</html>
