<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com https://cdn.emailjs.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; connect-src 'self' https://script.google.com https://script.googleusercontent.com https://*.firebaseio.com https://*.googleapis.com https://formsubmit.co https://en.wikipedia.org wss://*.firebaseio.com; img-src 'self' data: blob: https:;">
    <script>if(location.protocol !== 'https:' && location.hostname !== 'localhost'){location.replace('https:' + location.href.substring(location.protocol.length));}</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="theme-color" content="#1f4e79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSN9B">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="icon" type="image/png" href="/favicon.png?v=3">
    <link rel="shortcut icon" href="/favicon.png?v=3">
    <!-- Preconnect hints for faster external resource loading -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="stylesheet" href="/shared/header.css">
    <title>RN Resources - BSN9B</title>
    <script>
        if (localStorage.getItem('bsn9b_auth') !== 'true') {
            window.location.href = '/';
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-page: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-input: #fafafa;
            --text-primary: #1a1a2e;
            --text-secondary: #666666;
            --accent: #1f4e79;
            --border: #e2e8f0;
        }
        [data-theme="dark"] {
            --bg-page: linear-gradient(135deg, #0a0a14 0%, #0d1117 50%, #161b22 100%);
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-input: #16213e;
            --text-primary: #e6e6e6;
            --text-secondary: #aaaaaa;
            --accent: #4a90d9;
            --border: #2d3748;
        }

        /* Status indicator colors for presence */
        .status-online { background: #22c55e; }  /* Green */
        .status-away { background: #eab308; }    /* Yellow */
        .status-offline { background: #6b7280; } /* Gray */

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-page);
            min-height: 100vh;
            min-height: 100dvh;
            padding: 24px;
            padding-bottom: 80px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }
        .header h1 { font-size: 26px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 13px; }
        .back-btn {
            display: inline-block;
            margin-top: 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        .content {
            background: white;
            padding: 30px;
            border-radius: 0 0 16px 16px;
        }
        .grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }
        .grid > * {
            width: 100%;
        }
        .resource-navigator {
            background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 28px;
        }
        .resource-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
            font-size: 12px;
            color: #64748b;
        }
        .resource-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .resource-chip {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #cbd5f5;
            background: white;
            color: #1f4e79;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .resource-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .resource-chip.active {
            background: #1f4e79;
            color: white;
            border-color: #1f4e79;
            box-shadow: 0 2px 8px rgba(31, 78, 121, 0.3);
        }
        .resource-card.hidden { display: none; }

        /* Collapsible card styles - Accordion layout */
        .resource-card.collapsible {
            padding: 0;
            overflow: hidden;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.03);
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            transition: box-shadow 0.2s, transform 0.2s, border-color 0.2s;
            display: block;
            cursor: default;
            margin-bottom: 16px;
        }
        .resource-card.collapsible:after {
            content: none;
        }
        .resource-card.collapsible:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }
        .resource-card.collapsible.expanded {
            border-color: rgba(31, 78, 121, 0.3);
        }
        .resource-card.collapsible .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 14px 18px;
            background: rgba(31, 78, 121, 0.08);
            transition: all 0.2s;
            user-select: none;
        }
        .resource-card.collapsible .card-header:hover {
            background: rgba(31, 78, 121, 0.12);
        }
        .resource-card.collapsible .card-header:active {
            transform: scale(0.995);
        }
        .resource-card.collapsible .card-header h2 {
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            border: none;
            font-size: 14px;
            font-weight: 600;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .resource-card.collapsible .card-header h2::first-letter {
            font-size: 1.3em;
        }
        .resource-card.collapsible .card-header .expand-icon {
            color: var(--text-primary);
            font-size: 10px;
            transition: transform 0.3s ease, background 0.2s;
            font-weight: bold;
            background: rgba(31,78,121,0.15);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .resource-card.collapsible .card-header:hover .expand-icon {
            background: rgba(31,78,121,0.25);
        }
        .resource-card.collapsible.expanded .card-header .expand-icon {
            transform: rotate(180deg);
            background: rgba(31,78,121,0.25);
        }
        .resource-card.collapsible .card-content {
            max-height: 0;
            overflow: hidden;
            padding: 0 20px;
            background: #fafbfc;
            border-top: 1px solid rgba(0,0,0,0.08);
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.2s ease;
            opacity: 0;
            line-height: 1.6;
        }
        .resource-card.collapsible.expanded .card-content {
            max-height: 2000px;
            padding: 18px 20px;
            opacity: 1;
        }
        /* Dark mode styles */
        [data-theme="dark"] .resource-card.collapsible {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 2px 12px rgba(0,0,0,0.4);
        }
        [data-theme="dark"] .resource-card.collapsible:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        [data-theme="dark"] .resource-card.collapsible.expanded {
            border-color: rgba(74, 144, 217, 0.3);
        }
        [data-theme="dark"] .resource-card.collapsible .card-header {
            background: rgba(74, 144, 217, 0.12);
        }
        [data-theme="dark"] .resource-card.collapsible .card-header:hover {
            background: rgba(74, 144, 217, 0.18);
        }
        [data-theme="dark"] .resource-card.collapsible .card-header .expand-icon {
            background: rgba(74, 144, 217, 0.2);
        }
        [data-theme="dark"] .resource-card.collapsible .card-header:hover .expand-icon {
            background: rgba(74, 144, 217, 0.3);
        }
        [data-theme="dark"] .resource-card.collapsible.expanded .card-header .expand-icon {
            background: rgba(74, 144, 217, 0.3);
        }
        [data-theme="dark"] .resource-card.collapsible .card-content {
            background: var(--bg-secondary);
            border-top-color: rgba(255,255,255,0.08);
        }
        [data-theme="dark"] .resource-navigator {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
        }
        /* Mobile touch targets */
        @media (max-width: 600px) {
            .resource-card.collapsible .card-header {
                padding: 16px 16px;
            }
            .resource-card.collapsible.expanded .card-content {
                padding: 16px;
            }
        }

        .card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
        }
        .card h2 {
            color: #1f4e79;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1f4e79;
        }
        .card h3 {
            color: #334155;
            font-size: 14px;
            margin: 15px 0 8px 0;
        }
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .search-box input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .search-box button, .btn {
            padding: 10px 16px;
            background: #1f4e79;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: background 0.2s;
        }
        .search-box button:hover, .btn:hover { background: #2d5a87; }
        .btn-secondary {
            background: #64748b;
        }
        .btn-secondary:hover { background: #475569; }
        .link-list {
            list-style: none;
        }
        .link-list li {
            margin-bottom: 8px;
        }
        .link-list a {
            color: #1f4e79;
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .link-list a:hover { text-decoration: underline; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 10px;
        }
        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #1f4e79;
            color: white;
            font-weight: 600;
        }
        tr:hover { background: #f1f5f9; }
        .abbrev-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            font-size: 12px;
        }
        .abbrev-item {
            padding: 4px 8px;
            background: #e8f4fc;
            border-radius: 4px;
        }
        .abbrev-item strong { color: #1f4e79; }
        .calc-result {
            margin-top: 10px;
            padding: 12px;
            background: #e8f4fc;
            border-radius: 8px;
            font-weight: 600;
            color: #1f4e79;
            display: none;
        }
        .planner-grid {
            display: grid;
            gap: 10px;
            margin-top: 8px;
        }
        .planner-input {
            width: 100%;
            min-height: 80px;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #cbd5f5;
            background: white;
            font-size: 13px;
            resize: vertical;
        }
        .planner-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .planner-actions .btn {
            flex: 1;
            min-width: 120px;
        }
        /* Smart Drug Autocomplete */
        .drug-search-wrapper {
            position: relative;
            margin-bottom: 10px;
        }
        .drug-search-wrapper input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .drug-search-wrapper input:focus {
            border-color: #1f4e79;
            box-shadow: 0 0 0 3px rgba(31, 78, 121, 0.15);
            outline: none;
        }
        .drug-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 2px solid #1f4e79;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }
        .drug-autocomplete.show { display: block; }
        .drug-autocomplete-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            transition: background 0.15s;
        }
        .drug-autocomplete-item:hover { background: #e3f2fd; }
        .drug-autocomplete-item:last-child { border-bottom: none; }
        .drug-autocomplete-item .drug-type {
            font-size: 10px;
            color: #666;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }
        .drug-autocomplete-loading {
            padding: 12px 14px;
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
        .drug-autocomplete-hint {
            padding: 8px 14px;
            background: #fffbeb;
            color: #92400e;
            font-size: 11px;
            border-bottom: 1px solid #fcd34d;
        }
        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }
        .input-group label {
            min-width: 100px;
            font-size: 13px;
        }
        .input-group input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .input-group span {
            font-size: 12px;
            color: #666;
        }
        footer {
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.6);
            font-size: 12px;
        }
        .nanda-list {
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .nanda-category {
            font-weight: 600;
            color: #1f4e79;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .nanda-item {
            padding: 4px 8px;
            margin: 2px 0;
            background: #f1f5f9;
            border-radius: 4px;
        }
        .collapsible {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible:after {
            content: '▼';
            font-size: 10px;
        }
        .collapsible.collapsed:after {
            content: '▶';
        }
        .collapse-content {
            display: block;
        }
        .collapse-content.hidden {
            display: none;
        }

        /* Procedure Checklists */
        .checklist {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            line-height: 1.4;
        }
        .checklist-item:hover {
            background: var(--accent-hover);
        }
        .checklist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            flex-shrink: 0;
            cursor: pointer;
            accent-color: #4caf50;
        }
        .checklist-item:has(input:checked) {
            background: #e8f5e9;
            text-decoration: line-through;
            color: #666;
        }
        [data-theme="dark"] .checklist-item:has(input:checked) {
            background: #1b3d1b;
            color: #888;
        }

        /* Med Timer */
        .timer-preset {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .timer-preset:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .active-timer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 4px solid #4caf50;
        }
        [data-theme="dark"] .active-timer {
            background: linear-gradient(135deg, #1b3d1b 0%, #2d4a2d 100%);
        }
        .timer-info { flex: 1; }
        .timer-label { font-weight: 600; font-size: 14px; color: var(--text-primary); }
        .timer-countdown { font-size: 20px; font-weight: 700; color: #2e7d32; font-family: monospace; }
        [data-theme="dark"] .timer-countdown { color: #81c784; }
        .timer-cancel {
            padding: 6px 12px;
            background: #ffebee;
            color: #c62828;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .timer-cancel:hover { background: #c62828; color: white; }

        /* Banner close button */
        .banner-dismiss {
            position: absolute;
            right: 45px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: inherit;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .banner-dismiss:hover {
            background: rgba(255,255,255,0.3);
        }
        body.has-alert { padding-top: 48px; }
        body.has-fyi { padding-top: 48px; }
        body.has-alert.has-fyi { padding-top: 92px; }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 10px;
            transition: color 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .toolbar-item:hover { color: var(--accent); }
        .toolbar-item.active { color: var(--accent); }
        .toolbar-item .icon { font-size: 24px; margin-bottom: 2px; }
        .toolbar-item .label { font-weight: 600; }

        /* More Menu */
        .more-menu {
            position: fixed;
            bottom: 70px;
            right: 10px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 8px 0;
            display: none;
            z-index: 1001;
            min-width: 160px;
            border: 1px solid var(--border);
        }

        .more-menu.show { display: block; }

        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
        }

        .more-menu-item:hover { background: var(--bg-secondary); }
        .more-menu-item .menu-icon { font-size: 18px; }

        /* Dark mode support */
        [data-theme="dark"] .content { background: var(--bg-primary); color: var(--text-primary); }
        [data-theme="dark"] .card { background: var(--bg-secondary); border-color: var(--border); }
        [data-theme="dark"] .card h2 { color: var(--accent); border-color: var(--accent); }
        [data-theme="dark"] .link-list a { color: var(--accent); }
        [data-theme="dark"] table { color: var(--text-primary); }
        [data-theme="dark"] th { background: var(--bg-secondary); color: var(--text-primary); }
        [data-theme="dark"] td { border-color: var(--border); }
        [data-theme="dark"] input, [data-theme="dark"] select, [data-theme="dark"] textarea { background: var(--bg-input); color: var(--text-primary); border-color: var(--border); }
        [data-theme="dark"] footer { color: rgba(255,255,255,0.6); }
        [data-theme="dark"] .resource-chip { background: #0f172a; border-color: #1f2937; color: #93c5fd; }
        [data-theme="dark"] .resource-chip.active { background: #2563eb; color: white; border-color: #2563eb; }
        [data-theme="dark"] .planner-input { background: #0f172a; border-color: #1f2937; color: var(--text-primary); }

        /* Lock screen */
        #lockScreenOverlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); z-index: 99999; align-items: center; justify-content: center; flex-direction: column; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .modal-overlay.hidden { display: none; }
        .modal-content { background: var(--bg-primary); border-radius: 16px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); color: var(--text-primary); }
        .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 15px; background: var(--bg-input); color: var(--text-primary); }
        .modal-content textarea { min-height: 120px; resize: vertical; }

        /* ========== MOBILE RESPONSIVE STYLES ========== */

        /* Smooth scrolling and touch-friendly */
        html { scroll-behavior: smooth; }

        /* Minimum touch target size */
        @media (pointer: coarse) {
            button, .btn, .toolbar-item, .more-menu-item, .resource-btn, .tab-btn {
                min-height: 44px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
            }

            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }
        }

        /* Small phones */
        @media (max-width: 480px) {
            input, select, textarea {
                font-size: 16px !important;
            }

            .resource-grid { grid-template-columns: 1fr; }
            .calc-grid { grid-template-columns: 1fr; }
        }

        /* Mobile responsive padding */
        @media (max-width: 600px) {
            body {
                padding: 16px;
            }
        }

        /* Landscape orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .bottom-toolbar { height: 50px; }
            .toolbar-item .label { display: none; }
        }

        /* Safe area insets for bottom toolbar */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(60px + env(safe-area-inset-bottom));
            }
        }

        /* Focus visible styles for keyboard navigation */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        button:focus-visible, a:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; max-width: 380px; }
        .toast { padding: 14px 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); display: flex; align-items: flex-start; gap: 12px; animation: toastSlideIn 0.3s ease; color: white; font-size: 14px; line-height: 1.4; }
        .toast.hiding { animation: toastSlideOut 0.3s ease forwards; }
        .toast-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .toast-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .toast-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .toast-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .toast-icon { font-size: 18px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-message { opacity: 0.95; }
        .toast-close { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; font-size: 18px; padding: 0; line-height: 1; }
        .toast-close:hover { opacity: 1; }
        @keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @media (max-width: 480px) { .toast-container { left: 10px; right: 10px; max-width: none; } }

        /* ========== RESOURCES PAGE REDESIGN ========== */

        /* Page container - dark professional UI */
        .content {
            background: transparent !important;
            padding: 28px 24px !important;
            border-radius: 0 0 16px 16px;
        }

        /* Educational banner - slim, dismissible */
        .edu-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            background: rgba(220, 38, 38, 0.15);
            border: 1px solid rgba(220, 38, 38, 0.3);
            color: #fca5a5;
            padding: 10px 16px;
            border-radius: 10px;
            margin-bottom: 24px;
            font-size: 12px;
        }
        .edu-banner-text { flex: 1; line-height: 1.4; }
        .edu-banner-dismiss {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fca5a5;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        .edu-banner-dismiss:hover { background: rgba(255,255,255,0.2); }
        .edu-banner.hidden { display: none; }

        /* Resource navigator as toolbar card */
        .resource-navigator {
            background: rgba(255,255,255,0.04) !important;
            border: 1px solid rgba(255,255,255,0.08) !important;
            border-radius: 14px !important;
            padding: 20px 22px !important;
            margin-bottom: 28px !important;
            backdrop-filter: blur(10px);
        }
        .nav-toolbar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        .nav-title {
            color: rgba(255,255,255,0.9);
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        .nav-count {
            color: rgba(255,255,255,0.5);
            font-size: 12px;
        }
        .resource-navigator .search-box {
            margin-bottom: 14px;
        }
        .resource-navigator .search-box input {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            color: #e6e6e6;
            border-radius: 10px;
            padding: 11px 16px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .resource-navigator .search-box input::placeholder { color: rgba(255,255,255,0.35); }
        .resource-navigator .search-box input:focus {
            border-color: rgba(74, 144, 217, 0.5);
            box-shadow: 0 0 0 3px rgba(74, 144, 217, 0.15);
            outline: none;
            background: rgba(255,255,255,0.08);
        }
        .resource-navigator .search-box button {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.7);
            border-radius: 10px;
            padding: 11px 18px;
            transition: all 0.2s;
        }
        .resource-navigator .search-box button:hover {
            background: rgba(255,255,255,0.12);
            color: #fff;
        }

        /* Chips - larger gap, clear selected state */
        .resource-filters {
            gap: 8px !important;
        }
        .resource-chip {
            background: rgba(255,255,255,0.05) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            color: rgba(255,255,255,0.65) !important;
            padding: 7px 14px !important;
            border-radius: 999px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
        }
        .resource-chip:hover {
            background: rgba(255,255,255,0.08) !important;
            color: rgba(255,255,255,0.9) !important;
            border-color: rgba(255,255,255,0.2) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
        }
        .resource-chip:focus-visible {
            outline: 2px solid rgba(74, 144, 217, 0.6);
            outline-offset: 2px;
        }
        .resource-chip.active {
            background: linear-gradient(135deg, #2563eb, #1d4ed8) !important;
            color: white !important;
            border-color: #2563eb !important;
            box-shadow: 0 2px 10px rgba(37, 99, 235, 0.35) !important;
            font-weight: 600 !important;
        }

        /* ===== ACCORDION CARDS - Spaced, floating cards on dark bg ===== */
        .resource-card.collapsible {
            margin-bottom: 14px !important;
            border: 1px solid rgba(255,255,255,0.07) !important;
            background: rgba(255,255,255,0.025) !important;
            border-radius: 14px !important;
            box-shadow: 0 1px 8px rgba(0,0,0,0.2) !important;
            transition: box-shadow 0.25s, transform 0.25s, border-color 0.25s !important;
            overflow: hidden;
        }
        .resource-card.collapsible:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
            transform: translateY(-1px) !important;
            border-color: rgba(255,255,255,0.12) !important;
        }
        .resource-card.collapsible.expanded {
            border-color: rgba(74, 144, 217, 0.35) !important;
            box-shadow: 0 4px 24px rgba(0,0,0,0.3) !important;
        }

        /* Accordion header - subtle surface, less tall */
        .resource-card.collapsible .card-header {
            padding: 13px 18px !important;
            background: rgba(255,255,255,0.03) !important;
            transition: background 0.2s !important;
        }
        .resource-card.collapsible .card-header:hover {
            background: rgba(255,255,255,0.06) !important;
        }
        .resource-card.collapsible .card-header:focus-visible {
            outline: 2px solid rgba(74, 144, 217, 0.6);
            outline-offset: -2px;
        }
        .resource-card.collapsible .card-header h2 {
            color: rgba(255,255,255,0.88) !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Expand icon - small circular button */
        .resource-card.collapsible .card-header .expand-icon {
            background: rgba(255,255,255,0.06) !important;
            color: rgba(255,255,255,0.5) !important;
            width: 30px !important;
            height: 30px !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 10px !important;
            transition: all 0.3s ease !important;
            flex-shrink: 0;
        }
        .resource-card.collapsible .card-header:hover .expand-icon {
            background: rgba(255,255,255,0.1) !important;
            color: rgba(255,255,255,0.8) !important;
        }
        .resource-card.collapsible.expanded .card-header .expand-icon {
            transform: rotate(180deg) !important;
            background: rgba(74, 144, 217, 0.2) !important;
            color: #60a5fa !important;
        }

        /* Accordion body - top border divider, better spacing */
        .resource-card.collapsible .card-content {
            background: rgba(15, 23, 42, 0.6) !important;
            border-top: 1px solid rgba(255,255,255,0.06) !important;
            line-height: 1.65 !important;
            color: rgba(255,255,255,0.8);
        }
        .resource-card.collapsible.expanded .card-content {
            padding: 18px 22px !important;
        }

        /* Card content sub-elements - dark theme */
        .resource-card .card-content h3 {
            color: rgba(255,255,255,0.85) !important;
            font-size: 13px !important;
        }
        .resource-card .card-content p {
            color: rgba(255,255,255,0.65);
        }
        .resource-card .card-content table {
            color: rgba(255,255,255,0.8);
        }
        .resource-card .card-content th {
            background: rgba(31, 78, 121, 0.4) !important;
            color: rgba(255,255,255,0.9) !important;
        }
        .resource-card .card-content td {
            border-color: rgba(255,255,255,0.06) !important;
        }
        .resource-card .card-content tr:hover {
            background: rgba(255,255,255,0.04) !important;
        }
        .resource-card .card-content .abbrev-item {
            background: rgba(31, 78, 121, 0.15);
            color: rgba(255,255,255,0.8);
        }
        .resource-card .card-content .abbrev-item strong {
            color: #60a5fa;
        }
        .resource-card .card-content a {
            color: #60a5fa;
        }
        .resource-card .card-content .link-list a {
            color: #60a5fa;
        }
        .resource-card .card-content .nanda-category {
            color: #60a5fa;
        }
        .resource-card .card-content .nanda-item {
            background: rgba(255,255,255,0.04);
            color: rgba(255,255,255,0.75);
        }
        .resource-card .card-content .checklist-item {
            background: rgba(255,255,255,0.04);
            color: rgba(255,255,255,0.8);
        }
        .resource-card .card-content .checklist-item:hover {
            background: rgba(255,255,255,0.07);
        }
        .resource-card .card-content .checklist-item:has(input:checked) {
            background: rgba(16, 185, 129, 0.1);
            color: rgba(255,255,255,0.45);
        }
        .resource-card .card-content input,
        .resource-card .card-content select,
        .resource-card .card-content textarea {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.1);
            color: #e6e6e6;
        }
        .resource-card .card-content input:focus,
        .resource-card .card-content select:focus {
            border-color: rgba(74, 144, 217, 0.5);
            box-shadow: 0 0 0 3px rgba(74, 144, 217, 0.15);
        }
        .resource-card .card-content .btn {
            background: linear-gradient(135deg, #1f4e79, #2d5a87);
        }
        .resource-card .card-content .calc-result {
            background: rgba(31, 78, 121, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(74, 144, 217, 0.2);
        }
        .resource-card .card-content .timer-preset {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.8);
        }
        .resource-card .card-content .timer-preset:hover {
            background: rgba(74, 144, 217, 0.3);
            color: white;
        }

        /* Inner collapsibles (lab sub-sections etc) */
        .resource-card .card-content .collapsible {
            color: rgba(255,255,255,0.85);
            padding: 10px 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin: 6px 0;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .resource-card .card-content .collapsible:hover {
            background: rgba(255,255,255,0.06);
        }

        /* Drug info panel */
        #drugInfo {
            background: rgba(31, 78, 121, 0.15) !important;
            border: 1px solid rgba(74, 144, 217, 0.2);
        }
        #drugInfoName { color: #60a5fa !important; }
        #drugInfoDetails { color: rgba(255,255,255,0.8) !important; }

        /* Drug autocomplete */
        .drug-autocomplete {
            background: #1a1a2e !important;
            border-color: rgba(74, 144, 217, 0.4) !important;
        }
        .drug-autocomplete-item {
            color: rgba(255,255,255,0.8);
            border-bottom-color: rgba(255,255,255,0.06) !important;
        }
        .drug-autocomplete-item:hover { background: rgba(74, 144, 217, 0.15) !important; }
        .drug-autocomplete-hint {
            background: rgba(146, 64, 14, 0.15) !important;
            color: #fbbf24 !important;
            border-bottom-color: rgba(252, 211, 77, 0.2) !important;
        }

        /* Warning badges inside cards */
        .resource-card .card-content [style*="background: #ffebee"],
        .resource-card .card-content [style*="background:#ffebee"] {
            background: rgba(220, 38, 38, 0.12) !important;
            color: #fca5a5 !important;
        }

        /* SBAR sections inside cards */
        .resource-card .card-content [style*="background: #e3f2fd"] { background: rgba(25, 118, 210, 0.12) !important; }
        .resource-card .card-content [style*="background: #fff3e0"] { background: rgba(255, 152, 0, 0.1) !important; }
        .resource-card .card-content [style*="background: #e8f5e9"] { background: rgba(76, 175, 80, 0.1) !important; }
        .resource-card .card-content [style*="background: #fce4ec"] { background: rgba(233, 30, 99, 0.1) !important; }
        .resource-card .card-content [style*="background: #f8fafc"] { background: rgba(255,255,255,0.04) !important; }

        /* SBAR output */
        #sbar-output { background: rgba(15, 23, 42, 0.8) !important; border-color: rgba(74, 144, 217, 0.3) !important; }
        #sbar-text { color: rgba(255,255,255,0.8) !important; }

        /* Planner inputs */
        .planner-input {
            background: rgba(255,255,255,0.06) !important;
            border-color: rgba(255,255,255,0.1) !important;
            color: #e6e6e6 !important;
        }

        /* Active timers */
        .active-timer {
            background: rgba(76, 175, 80, 0.1) !important;
            border-left-color: #4caf50 !important;
        }
        .timer-label { color: rgba(255,255,255,0.9) !important; }

        /* EKG strips - keep white bg for readability */
        .resource-card .card-content [style*="background: #fff"] {
            background: rgba(255,255,255,0.95) !important;
            border-color: rgba(255,255,255,0.15) !important;
        }

        /* Header - reduce visual weight */
        .header {
            border-radius: 14px !important;
            padding: 20px 30px !important;
            margin-bottom: 4px;
        }
        .header h1 { font-size: 22px !important; }
        .header p { font-size: 12px !important; }

        /* Container - remove rounded bottom on content */
        .container {
            background: transparent !important;
            box-shadow: none !important;
        }

        /* Footer */
        footer { color: rgba(255,255,255,0.4); }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 600px) {
            .content { padding: 16px 12px !important; }
            .resource-navigator { padding: 16px !important; }
            .resource-card.collapsible .card-header { padding: 12px 14px !important; }
            .resource-card.collapsible.expanded .card-content { padding: 14px 16px !important; }
            .nav-toolbar-header { flex-direction: column; align-items: flex-start; gap: 4px; }
        }

        /* Override dark mode selectors since we're already dark */
        [data-theme="dark"] .content { background: transparent !important; }
        [data-theme="dark"] .resource-navigator { background: rgba(255,255,255,0.05) !important; border-color: rgba(255,255,255,0.1) !important; }
        [data-theme="dark"] .resource-chip { background: rgba(255,255,255,0.05) !important; border-color: rgba(255,255,255,0.1) !important; color: rgba(255,255,255,0.65) !important; }
        [data-theme="dark"] .resource-chip.active { background: linear-gradient(135deg, #2563eb, #1d4ed8) !important; color: white !important; border-color: #2563eb !important; }

    </style>
</head>
<body>
    <header class="site-header">
        <a href="/home/" class="logo-link"><img src="/logo.png" alt="BendBSN" class="site-logo"></a>
    </header>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Alert/FYI Banners -->
    <div id="alertBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 10px 20px; text-align: center; font-weight: 600; font-size: 13px; z-index: 10000; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5);">
        <span id="alertText"></span>
        <button class="banner-dismiss" onclick="dismissBanner('alert')" aria-label="Dismiss alert">×</button>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.8;">⚠️ ALERT</span>
    </div>
    <div id="fyiBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a1a2e; padding: 10px 20px; text-align: center; font-weight: 600; font-size: 13px; z-index: 9999; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);">
        <span id="fyiText"></span>
        <button class="banner-dismiss" onclick="dismissBanner('fyi')" aria-label="Dismiss notification">×</button>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.7;">ℹ️ FYI</span>
    </div>

    <div class="container">
        <div class="header" style="position: relative;">
            <div style="position: absolute; top: 15px; right: 20px;">
                <span id="userDisplay" style="color: rgba(255,255,255,0.8); font-size: 12px; margin-right: 10px;"></span>
                <button onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">Logout</button>
            </div>
            <h1>RN Resources</h1>
            <p>Drug Information | Lab Values | Calculations | References</p>
            <a href="/home/" class="back-btn">← Back to Home</a>
        </div>

        <div class="content">
            <!-- Educational Disclaimer Banner (dismissible) -->
            <div id="eduBanner" class="edu-banner">
                <span class="edu-banner-text"><strong>⚠️ EDUCATIONAL USE ONLY</strong> — Not for clinical decisions. Always verify with official sources.</span>
                <button onclick="dismissEduBanner()" class="edu-banner-dismiss" aria-label="Dismiss">×</button>
            </div>

            <div class="resource-navigator">
                <div class="nav-toolbar-header">
                    <strong class="nav-title">Resource Navigator</strong>
                    <span id="resourceCount" class="nav-count">Showing all resources</span>
                </div>
                <div class="search-box">
                    <input type="text" id="resourceSearch" placeholder="Search resources, tools, or skills..." oninput="filterResources()">
                    <button type="button" onclick="clearResourceSearch()">Clear</button>
                </div>
                <div class="resource-filters">
                    <button type="button" class="resource-chip active" onclick="setResourceFilter('all', this)">All</button>
                    <button type="button" class="resource-chip" onclick="setResourceFilter('drugs', this)">Drugs</button>
                    <button type="button" class="resource-chip" onclick="setResourceFilter('labs', this)">Labs</button>
                    <button type="button" class="resource-chip" onclick="setResourceFilter('vitals', this)">Vitals</button>
                    <button type="button" class="resource-chip" onclick="setResourceFilter('calculations', this)">Calculations</button>
                    <button type="button" class="resource-chip" onclick="setResourceFilter('clinical', this)">Clinical Skills</button>
                    <button type="button" class="resource-chip" onclick="setResourceFilter('sbar', this)">SBAR</button>
                    <button type="button" class="resource-chip" onclick="setResourceFilter('checklists', this)">Checklists</button>
                    <button type="button" class="resource-chip" onclick="setResourceFilter('study', this)">Study</button>
                </div>
            </div>

            <div class="grid" id="resourceGrid">
                <!-- Drug Information -->
                <div class="card resource-card collapsible collapsed" data-tags="drugs medication pharma reference">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>💊 Drug Information</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <p style="font-size: 12px; color: #c62828; background: #ffebee; padding: 8px; border-radius: 6px; margin-bottom: 12px;"><strong>Educational reference only.</strong> Verify all information with official sources.</p>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Start typing to search medications (smart spelling correction)</p>
                    <div class="drug-search-wrapper">
                        <input type="text" id="drugSearch" placeholder="Type drug name (e.g., met, lisi, ator)..." autocomplete="off">
                        <div id="drugSearchDropdown" class="drug-autocomplete"></div>
                    </div>
                    <div id="drugInfo" style="display:none; padding: 12px; background: #e8f4fc; border-radius: 8px; margin-bottom: 15px;">
                        <h4 id="drugInfoName" style="color: #1f4e79; margin-bottom: 8px;"></h4>
                        <div id="drugInfoDetails" style="font-size: 13px;"></div>
                        <div style="margin-top: 10px; font-size: 12px;">
                            <a id="drugLinkDailyMed" href="#" target="_blank" style="color: #1f4e79; margin-right: 10px;">📄 Full Label (DailyMed)</a>
                            <a id="drugLinkDrugs" href="#" target="_blank" style="color: #1f4e79;">💊 Drugs.com</a>
                        </div>
                    </div>
                    <p style="font-size: 11px; color: #888; margin-top: 10px;">Recommended Resources:</p>
                    <ul class="link-list" style="margin-top: 5px;">
                        <li><a href="https://www.nursingcenter.com/drug-information" target="_blank">📚 Lippincott Drug Information</a></li>
                        <li><a href="https://www.nursingcenter.com/clinical-resources" target="_blank">📚 Lippincott Clinical Resources</a></li>
                        <li><a href="https://medlineplus.gov/druginformation.html" target="_blank">🔗 MedlinePlus Drugs (NIH)</a></li>
                    </ul>
                    </div>
                </div>

                <!-- Lab Values -->
                <div class="card resource-card collapsible collapsed" data-tags="labs cbc bmp abg coagulation cardiac reference">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>🔬 Lab Values Reference</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <h3 class="collapsible" onclick="toggleCollapse(this)">Complete Blood Count (CBC)</h3>
                    <div class="collapse-content">
                        <table>
                            <tr><th>Test</th><th>Normal Range</th></tr>
                            <tr><td>WBC</td><td>4,500-11,000/mcL</td></tr>
                            <tr><td>RBC (M)</td><td>4.5-5.5 million/mcL</td></tr>
                            <tr><td>RBC (F)</td><td>4.0-5.0 million/mcL</td></tr>
                            <tr><td>Hemoglobin (M)</td><td>14-18 g/dL</td></tr>
                            <tr><td>Hemoglobin (F)</td><td>12-16 g/dL</td></tr>
                            <tr><td>Hematocrit (M)</td><td>40-54%</td></tr>
                            <tr><td>Hematocrit (F)</td><td>36-48%</td></tr>
                            <tr><td>Platelets</td><td>150,000-400,000/mcL</td></tr>
                        </table>
                    </div>
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">Basic Metabolic Panel (BMP)</h3>
                    <div class="collapse-content hidden">
                        <table>
                            <tr><th>Test</th><th>Normal Range</th></tr>
                            <tr><td>Sodium (Na)</td><td>136-145 mEq/L</td></tr>
                            <tr><td>Potassium (K)</td><td>3.5-5.0 mEq/L</td></tr>
                            <tr><td>Chloride (Cl)</td><td>98-106 mEq/L</td></tr>
                            <tr><td>CO2</td><td>23-29 mEq/L</td></tr>
                            <tr><td>BUN</td><td>7-20 mg/dL</td></tr>
                            <tr><td>Creatinine</td><td>0.6-1.2 mg/dL</td></tr>
                            <tr><td>Glucose</td><td>70-100 mg/dL (fasting)</td></tr>
                            <tr><td>Calcium</td><td>8.5-10.5 mg/dL</td></tr>
                        </table>
                    </div>
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">Coagulation</h3>
                    <div class="collapse-content hidden">
                        <table>
                            <tr><th>Test</th><th>Normal Range</th></tr>
                            <tr><td>PT</td><td>11-13.5 seconds</td></tr>
                            <tr><td>INR</td><td>0.8-1.1 (2-3 on warfarin)</td></tr>
                            <tr><td>PTT</td><td>25-35 seconds</td></tr>
                            <tr><td>aPTT</td><td>30-40 seconds</td></tr>
                        </table>
                    </div>
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">Cardiac Markers</h3>
                    <div class="collapse-content hidden">
                        <table>
                            <tr><th>Test</th><th>Normal Range</th></tr>
                            <tr><td>Troponin I</td><td>&lt;0.04 ng/mL</td></tr>
                            <tr><td>Troponin T</td><td>&lt;0.1 ng/mL</td></tr>
                            <tr><td>BNP</td><td>&lt;100 pg/mL</td></tr>
                            <tr><td>CK-MB</td><td>&lt;5 ng/mL</td></tr>
                        </table>
                    </div>
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">ABGs</h3>
                    <div class="collapse-content hidden">
                        <table>
                            <tr><th>Test</th><th>Normal Range</th></tr>
                            <tr><td>pH</td><td>7.35-7.45</td></tr>
                            <tr><td>PaCO2</td><td>35-45 mmHg</td></tr>
                            <tr><td>PaO2</td><td>80-100 mmHg</td></tr>
                            <tr><td>HCO3</td><td>22-26 mEq/L</td></tr>
                            <tr><td>O2 Sat</td><td>95-100%</td></tr>
                        </table>
                    </div>
                </div>

                <!-- Vital Signs -->
                <div class="card resource-card collapsible collapsed" data-tags="vitals assessment normal ranges">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>❤️ Vital Signs Normal Ranges</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <table>
                        <tr><th>Vital Sign</th><th>Adult Normal</th></tr>
                        <tr><td>Heart Rate</td><td>60-100 bpm</td></tr>
                        <tr><td>Blood Pressure</td><td>&lt;120/80 mmHg</td></tr>
                        <tr><td>Respiratory Rate</td><td>12-20 breaths/min</td></tr>
                        <tr><td>Temperature</td><td>97.8-99.1°F (36.5-37.3°C)</td></tr>
                        <tr><td>O2 Saturation</td><td>95-100%</td></tr>
                    </table>
                    <h3>Blood Pressure Categories</h3>
                    <table>
                        <tr><th>Category</th><th>Systolic</th><th>Diastolic</th></tr>
                        <tr><td>Normal</td><td>&lt;120</td><td>&lt;80</td></tr>
                        <tr><td>Elevated</td><td>120-129</td><td>&lt;80</td></tr>
                        <tr><td>HTN Stage 1</td><td>130-139</td><td>80-89</td></tr>
                        <tr><td>HTN Stage 2</td><td>≥140</td><td>≥90</td></tr>
                        <tr><td>Crisis</td><td>&gt;180</td><td>&gt;120</td></tr>
                    </table>
                    </div>
                </div>

                <!-- IV Calculations -->
                <div class="card resource-card collapsible collapsed" data-tags="calculations iv drip math clinical">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>💉 IV Drip Rate Calculator</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <p style="font-size: 11px; color: #c62828; background: #ffebee; padding: 6px 8px; border-radius: 4px; margin-bottom: 10px;"><strong>Double-check all calculations.</strong> Verify with preceptor/RN before administration.</p>
                    <p style="font-size: 12px; color: #666; margin-bottom: 12px;">For gravity drip or pump rate calculation</p>
                    <div class="input-group">
                        <label>Volume to Infuse:</label>
                        <input type="number" id="ivVolume" placeholder="1000" step="any" min="0">
                        <span>mL</span>
                    </div>
                    <div class="input-group">
                        <label>Infusion Time:</label>
                        <input type="number" id="ivTime" placeholder="8" step="any" min="0">
                        <span>hours</span>
                    </div>
                    <div class="input-group">
                        <label>Drop Factor:</label>
                        <select id="ivDropFactor" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="10">10 gtt/mL (Macrodrip)</option>
                            <option value="15" selected>15 gtt/mL (Macrodrip)</option>
                            <option value="20">20 gtt/mL (Macrodrip)</option>
                            <option value="60">60 gtt/mL (Microdrip/Peds)</option>
                        </select>
                    </div>
                    <button onclick="calculateDripRate()" style="width: 100%;">Calculate Drip Rate</button>
                    <div id="dripResult" class="calc-result"></div>

                    <h3 style="margin-top: 20px;">Quick Reference</h3>
                    <table>
                        <tr><th>Set Type</th><th>Drop Factor</th><th>Common Use</th></tr>
                        <tr><td>Macrodrip</td><td>10-20 gtt/mL</td><td>Adults, large volumes</td></tr>
                        <tr><td>Microdrip</td><td>60 gtt/mL</td><td>Peds, precise dosing</td></tr>
                        <tr><td>Blood tubing</td><td>10 gtt/mL</td><td>Blood products</td></tr>
                    </table>
                    <p style="font-size: 11px; color: #666; margin-top: 10px;"><strong>Tip:</strong> For IV pumps, you only need mL/hr (no drop factor needed). Microdrip: gtt/min = mL/hr</p>
                    </div>
                </div>

                <!-- Dosage Calculator -->
                <div class="card resource-card collapsible collapsed" data-tags="calculations dosage math meds">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>💊 Dosage Calculator</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <p style="font-size: 11px; color: #c62828; background: #ffebee; padding: 6px 8px; border-radius: 4px; margin-bottom: 10px;"><strong>Double-check all calculations.</strong> Verify with preceptor/RN before administration.</p>
                    <p style="font-size: 12px; color: #666; margin-bottom: 12px;">D/H × Q (Desired ÷ Have × Quantity)</p>
                    <div class="input-group">
                        <label>Desired Dose:</label>
                        <input type="number" id="desiredDose" placeholder="500" step="any" min="0">
                        <span>mg</span>
                    </div>
                    <div class="input-group">
                        <label>Have on Hand:</label>
                        <input type="number" id="haveOnHand" placeholder="250" step="any" min="0">
                        <span>mg per unit</span>
                    </div>
                    <div class="input-group">
                        <label>Quantity per Unit:</label>
                        <input type="number" id="quantity" placeholder="1" value="1" step="any" min="0">
                        <select id="quantityUnit" style="width: 80px; padding: 5px; border-radius: 4px;">
                            <option value="tablet">tablet</option>
                            <option value="mL">mL</option>
                            <option value="capsule">capsule</option>
                        </select>
                    </div>
                    <button onclick="calculateDosage()" style="width: 100%;">Calculate</button>
                    <div id="dosageResult" class="calc-result"></div>

                    <h3 style="margin-top: 20px;">Weight-Based Dosing</h3>
                    <p style="font-size: 11px; color: #666; margin-bottom: 8px;">Calculate dose based on patient weight</p>
                    <div class="input-group">
                        <label>Order (mg/kg):</label>
                        <input type="number" id="mgPerKg" placeholder="10" step="any" min="0">
                        <span>mg/kg</span>
                    </div>
                    <div class="input-group">
                        <label>Patient Weight:</label>
                        <input type="number" id="patientWeight" placeholder="70" step="any" min="0">
                        <select id="weightUnit" style="width: 60px; padding: 5px; border-radius: 4px;">
                            <option value="kg">kg</option>
                            <option value="lb">lb</option>
                        </select>
                    </div>
                    <button onclick="calculateWeightDose()" style="width: 100%;">Calculate Weight-Based Dose</button>
                    <div id="weightDoseResult" class="calc-result"></div>
                    </div>
                </div>

                <!-- Common Abbreviations -->
                <div class="card resource-card collapsible collapsed" data-tags="study abbreviations documentation">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>📝 Common Abbreviations</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <div class="abbrev-grid">
                        <div class="abbrev-item"><strong>AC</strong> - Before meals</div>
                        <div class="abbrev-item"><strong>PC</strong> - After meals</div>
                        <div class="abbrev-item"><strong>BID</strong> - Twice daily</div>
                        <div class="abbrev-item"><strong>TID</strong> - Three times daily</div>
                        <div class="abbrev-item"><strong>QID</strong> - Four times daily</div>
                        <div class="abbrev-item"><strong>PRN</strong> - As needed</div>
                        <div class="abbrev-item"><strong>STAT</strong> - Immediately</div>
                        <div class="abbrev-item"><strong>PO</strong> - By mouth</div>
                        <div class="abbrev-item"><strong>IV</strong> - Intravenous</div>
                        <div class="abbrev-item"><strong>IM</strong> - Intramuscular</div>
                        <div class="abbrev-item"><strong>SQ/SubQ</strong> - Subcutaneous</div>
                        <div class="abbrev-item"><strong>SL</strong> - Sublingual</div>
                        <div class="abbrev-item"><strong>NPO</strong> - Nothing by mouth</div>
                        <div class="abbrev-item"><strong>WDL</strong> - Within defined limits</div>
                        <div class="abbrev-item"><strong>SOB</strong> - Shortness of breath</div>
                        <div class="abbrev-item"><strong>ROM</strong> - Range of motion</div>
                        <div class="abbrev-item"><strong>ADL</strong> - Activities of daily living</div>
                        <div class="abbrev-item"><strong>I&O</strong> - Intake and output</div>
                        <div class="abbrev-item"><strong>BRP</strong> - Bathroom privileges</div>
                        <div class="abbrev-item"><strong>OOB</strong> - Out of bed</div>
                        <div class="abbrev-item"><strong>HS</strong> - At bedtime</div>
                        <div class="abbrev-item"><strong>QHS</strong> - Every bedtime</div>
                        <div class="abbrev-item"><strong>GT</strong> - Gastrostomy tube</div>
                        <div class="abbrev-item"><strong>NG</strong> - Nasogastric</div>
                    </div>
                    </div><!-- end card-content -->
                </div>

                <!-- Clinical Prep -->
                <div class="card resource-card collapsible collapsed" data-tags="clinical study sim prep planner">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>🗂️ Clinical Prep & Sim Lab</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <p style="font-size: 12px; color: #666; margin-bottom: 12px;">Quick checklist + planner for pre-clinical and sim days</p>
                    <div class="checklist" id="shift-prep-checklist" style="margin-bottom: 12px;">
                        <label class="checklist-item"><input type="checkbox"> Review patient summary, diagnosis, and H&P</label>
                        <label class="checklist-item"><input type="checkbox"> Check latest vitals, labs, and abnormal values</label>
                        <label class="checklist-item"><input type="checkbox"> Identify high-alert meds + top 2 nursing priorities</label>
                        <label class="checklist-item"><input type="checkbox"> Prepare SBAR points and key questions for RN</label>
                        <label class="checklist-item"><input type="checkbox"> Gather supplies for assigned skills (IV, wound, Foley)</label>
                    </div>
                    <h3>Shift Planner</h3>
                    <div class="planner-grid">
                        <textarea id="shiftPriority" class="planner-input" placeholder="Top 3 priorities (ex: pain control, mobility, I&O)"></textarea>
                        <textarea id="shiftFollowup" class="planner-input" placeholder="Follow-ups & reminders (ex: recheck vitals @ 1400, med re-assessment)"></textarea>
                    </div>
                    <div class="planner-actions">
                        <button class="btn" onclick="saveShiftPlan()">Save Plan</button>
                        <button class="btn btn-secondary" onclick="copyShiftPlan()">Copy Plan</button>
                        <button class="btn btn-secondary" onclick="clearShiftPlan()">Clear</button>
                    </div>
                    </div>
                </div>

                <!-- Clinical Toolkit -->
                <div class="card resource-card collapsible collapsed" data-tags="clinical toolkit vitals pain apgar sbar handoff">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>🩺 Clinical Toolkit</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Quick reference tools for clinical rotations</p>

                    <!-- Pediatric Vital Signs -->
                    <h3 class="collapsible" onclick="toggleCollapse(this)">👶 Pediatric Vital Signs</h3>
                    <div class="collapse-content">
                        <table>
                            <tr><th>Age</th><th>HR (bpm)</th><th>RR (/min)</th><th>BP (mmHg)</th></tr>
                            <tr><td>Newborn</td><td>100-160</td><td>30-60</td><td>60-90/30-60</td></tr>
                            <tr><td>Infant (1-12 mo)</td><td>80-140</td><td>25-40</td><td>80-100/50-70</td></tr>
                            <tr><td>Toddler (1-3 yr)</td><td>80-130</td><td>20-30</td><td>90-105/55-70</td></tr>
                            <tr><td>Preschool (3-5 yr)</td><td>80-120</td><td>20-25</td><td>95-110/60-75</td></tr>
                            <tr><td>School Age (6-12 yr)</td><td>70-110</td><td>18-22</td><td>100-120/60-75</td></tr>
                            <tr><td>Adolescent (13+ yr)</td><td>60-100</td><td>12-20</td><td>110-135/65-85</td></tr>
                        </table>
                    </div>

                    <!-- Pain Scales -->
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">😣 Pain Assessment Scales</h3>
                    <div class="collapse-content hidden">
                        <div style="margin-bottom: 15px;">
                            <strong>Numeric Rating Scale (NRS)</strong>
                            <p style="font-size: 12px; margin-top: 5px;">0 = No pain | 1-3 = Mild | 4-6 = Moderate | 7-10 = Severe</p>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>FLACC Scale (Non-verbal/Pediatric)</strong>
                            <table style="font-size: 11px;">
                                <tr><th>Category</th><th>0</th><th>1</th><th>2</th></tr>
                                <tr><td><strong>F</strong>ace</td><td>Relaxed</td><td>Occasional grimace</td><td>Frequent grimace</td></tr>
                                <tr><td><strong>L</strong>egs</td><td>Relaxed</td><td>Restless</td><td>Kicking</td></tr>
                                <tr><td><strong>A</strong>ctivity</td><td>Lying quietly</td><td>Squirming</td><td>Arched, rigid</td></tr>
                                <tr><td><strong>C</strong>ry</td><td>No cry</td><td>Moans, whimpers</td><td>Crying steadily</td></tr>
                                <tr><td><strong>C</strong>onsolability</td><td>Content</td><td>Reassured by touch</td><td>Difficult to console</td></tr>
                            </table>
                            <p style="font-size: 11px; color: #666; margin-top: 5px;">Score 0-10: 0 = No pain, 1-3 = Mild, 4-6 = Moderate, 7-10 = Severe</p>
                        </div>
                    </div>

                    <!-- Glasgow Coma Scale -->
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">🧠 Glasgow Coma Scale (GCS)</h3>
                    <div class="collapse-content hidden">
                        <table style="font-size: 12px;">
                            <tr><th>Response</th><th>Score</th><th>Description</th></tr>
                            <tr><td rowspan="4"><strong>Eye Opening</strong></td><td>4</td><td>Spontaneous</td></tr>
                            <tr><td>3</td><td>To voice</td></tr>
                            <tr><td>2</td><td>To pain</td></tr>
                            <tr><td>1</td><td>None</td></tr>
                            <tr><td rowspan="5"><strong>Verbal</strong></td><td>5</td><td>Oriented</td></tr>
                            <tr><td>4</td><td>Confused</td></tr>
                            <tr><td>3</td><td>Inappropriate words</td></tr>
                            <tr><td>2</td><td>Incomprehensible sounds</td></tr>
                            <tr><td>1</td><td>None</td></tr>
                            <tr><td rowspan="6"><strong>Motor</strong></td><td>6</td><td>Obeys commands</td></tr>
                            <tr><td>5</td><td>Localizes pain</td></tr>
                            <tr><td>4</td><td>Withdraws from pain</td></tr>
                            <tr><td>3</td><td>Abnormal flexion (decorticate)</td></tr>
                            <tr><td>2</td><td>Extension (decerebrate)</td></tr>
                            <tr><td>1</td><td>None</td></tr>
                        </table>
                        <p style="font-size: 11px; margin-top: 10px;"><strong>Interpretation:</strong> 15 = Normal | 13-14 = Mild | 9-12 = Moderate | 3-8 = Severe</p>
                    </div>

                    <!-- APGAR Calculator -->
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">👶 APGAR Score Calculator</h3>
                    <div class="collapse-content hidden">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Appearance (Color)</label>
                                <select id="apgar-appearance" onchange="calculateAPGAR()" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="0">Blue/Pale all over</option>
                                    <option value="1">Body pink, extremities blue</option>
                                    <option value="2">Completely pink</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Pulse (Heart Rate)</label>
                                <select id="apgar-pulse" onchange="calculateAPGAR()" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="0">Absent</option>
                                    <option value="1">< 100 bpm</option>
                                    <option value="2">> 100 bpm</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Grimace (Reflex)</label>
                                <select id="apgar-grimace" onchange="calculateAPGAR()" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="0">No response</option>
                                    <option value="1">Grimace</option>
                                    <option value="2">Cry, cough, sneeze</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Activity (Muscle Tone)</label>
                                <select id="apgar-activity" onchange="calculateAPGAR()" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="0">Limp</option>
                                    <option value="1">Some flexion</option>
                                    <option value="2">Active movement</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Respiration</label>
                                <select id="apgar-respiration" onchange="calculateAPGAR()" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="0">Absent</option>
                                    <option value="1">Slow, irregular</option>
                                    <option value="2">Good, crying</option>
                                </select>
                            </div>
                        </div>
                        <div id="apgar-result" class="calc-result" style="display: block; background: #e8f4fc; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <strong>APGAR Score:</strong> <span id="apgar-score">0</span>/10
                            <span id="apgar-interpretation" style="margin-left: 10px; font-size: 12px;"></span>
                        </div>
                    </div>

                    <!-- SBAR Template -->
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">📋 SBAR Communication Template</h3>
                    <div class="collapse-content hidden">
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; font-size: 12px;">
                            <div style="margin-bottom: 12px;">
                                <strong style="color: #1f4e79;">S - Situation</strong>
                                <p style="margin-top: 4px;">"I am calling about [patient name] in [room/unit]. The problem I am calling about is..."</p>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong style="color: #1f4e79;">B - Background</strong>
                                <p style="margin-top: 4px;">"The patient's diagnosis is... They were admitted on [date] for... Relevant history includes..."</p>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong style="color: #1f4e79;">A - Assessment</strong>
                                <p style="margin-top: 4px;">"My assessment is that... Vital signs are... Changes from baseline include..."</p>
                            </div>
                            <div>
                                <strong style="color: #1f4e79;">R - Recommendation</strong>
                                <p style="margin-top: 4px;">"I recommend... Would you like me to... Is there anything else you need?"</p>
                            </div>
                        </div>
                    </div>

                    <!-- SBAR Shift Handoff Generator -->
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">📝 SBAR Shift Handoff Generator</h3>
                    <div class="collapse-content hidden">
                        <p style="font-size: 11px; color: #666; margin-bottom: 12px;">Fill in the fields below to generate a complete SBAR handoff report</p>
                        <div id="sbarForm" style="display: grid; gap: 12px;">
                            <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; border-left: 4px solid #1976d2;">
                                <strong style="color: #1976d2; font-size: 13px;">S - Situation</strong>
                                <input type="text" id="sbar-patient" placeholder="Patient name & room (e.g., John Doe, Rm 412)" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-reason" placeholder="Reason for handoff (e.g., End of shift report)" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                            <div style="background: #fff3e0; padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                <strong style="color: #e65100; font-size: 13px;">B - Background</strong>
                                <input type="text" id="sbar-diagnosis" placeholder="Admitting diagnosis" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-history" placeholder="Relevant history (allergies, code status, isolation)" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-meds" placeholder="Key medications & IVs" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                            <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; border-left: 4px solid #4caf50;">
                                <strong style="color: #2e7d32; font-size: 13px;">A - Assessment</strong>
                                <input type="text" id="sbar-vitals" placeholder="Latest vitals (BP, HR, RR, Temp, SpO2, Pain)" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-neuro" placeholder="Neuro/LOC status" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-io" placeholder="I&O, last void/BM" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-concerns" placeholder="Current concerns or changes" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                            <div style="background: #fce4ec; padding: 12px; border-radius: 8px; border-left: 4px solid #e91e63;">
                                <strong style="color: #c2185b; font-size: 13px;">R - Recommendation</strong>
                                <input type="text" id="sbar-pending" placeholder="Pending tests/procedures" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-followup" placeholder="Follow-up actions needed" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-priority" placeholder="Priority concerns for next shift" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button onclick="generateSBARHandoff()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #1f4e79, #2d5a87); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Generate Handoff</button>
                            <button onclick="clearSBARForm()" style="padding: 12px 20px; background: #f0f0f0; color: #333; border: none; border-radius: 6px; cursor: pointer;">Clear</button>
                        </div>
                        <div id="sbar-output" style="display: none; margin-top: 15px; background: #fff; border: 2px solid #1f4e79; border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: #1f4e79;">Generated SBAR Handoff</strong>
                                <button onclick="copySBARHandoff()" style="padding: 6px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy to Clipboard</button>
                            </div>
                            <pre id="sbar-text" style="white-space: pre-wrap; font-family: inherit; font-size: 12px; line-height: 1.6; margin: 0; color: #333;"></pre>
                        </div>
                    </div>

                    </div><!-- end card-content -->
                </div>

                <!-- NANDA Diagnoses Quick Reference -->
                <div class="card resource-card collapsible collapsed" data-tags="nanda diagnoses study care plan">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>🩺 NANDA Nursing Diagnoses</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Common nursing diagnoses by category</p>
                    <div class="nanda-list">
                        <div class="nanda-category">Activity/Rest</div>
                        <div class="nanda-item">Activity intolerance</div>
                        <div class="nanda-item">Fatigue</div>
                        <div class="nanda-item">Insomnia</div>
                        <div class="nanda-item">Impaired physical mobility</div>

                        <div class="nanda-category">Circulation</div>
                        <div class="nanda-item">Decreased cardiac output</div>
                        <div class="nanda-item">Ineffective tissue perfusion</div>
                        <div class="nanda-item">Risk for bleeding</div>

                        <div class="nanda-category">Respiration</div>
                        <div class="nanda-item">Ineffective airway clearance</div>
                        <div class="nanda-item">Impaired gas exchange</div>
                        <div class="nanda-item">Ineffective breathing pattern</div>

                        <div class="nanda-category">Safety</div>
                        <div class="nanda-item">Risk for falls</div>
                        <div class="nanda-item">Risk for infection</div>
                        <div class="nanda-item">Impaired skin integrity</div>

                        <div class="nanda-category">Pain/Comfort</div>
                        <div class="nanda-item">Acute pain</div>
                        <div class="nanda-item">Chronic pain</div>
                        <div class="nanda-item">Nausea</div>

                        <div class="nanda-category">Elimination</div>
                        <div class="nanda-item">Constipation</div>
                        <div class="nanda-item">Diarrhea</div>
                        <div class="nanda-item">Impaired urinary elimination</div>
                    </div>
                    <a href="/app/" class="btn" style="display: block; text-align: center; margin-top: 15px;">Full NANDA Database →</a>
                    </div><!-- end card-content -->
                </div>

                <!-- Procedure Checklists -->
                <div class="card resource-card collapsible collapsed" data-tags="checklists clinical skills procedures">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>📋 Procedure Checklists</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Interactive checklists for common nursing procedures</p>

                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">🩺 Foley Catheter Insertion</h3>
                    <div class="collapse-content hidden">
                        <div class="checklist" id="foley-checklist">
                            <label class="checklist-item"><input type="checkbox"> Verify order and check for allergies (latex, iodine)</label>
                            <label class="checklist-item"><input type="checkbox"> Gather supplies: catheter kit, extra gloves, lighting</label>
                            <label class="checklist-item"><input type="checkbox"> Explain procedure to patient, ensure privacy</label>
                            <label class="checklist-item"><input type="checkbox"> Position patient (supine, knees bent for female; supine for male)</label>
                            <label class="checklist-item"><input type="checkbox"> Perform hand hygiene, apply sterile gloves</label>
                            <label class="checklist-item"><input type="checkbox"> Establish sterile field, arrange supplies</label>
                            <label class="checklist-item"><input type="checkbox"> Apply sterile drape with fenestration</label>
                            <label class="checklist-item"><input type="checkbox"> Test balloon with 10mL sterile water</label>
                            <label class="checklist-item"><input type="checkbox"> Lubricate catheter tip generously</label>
                            <label class="checklist-item"><input type="checkbox"> Cleanse urethral meatus (female: front to back; male: circular from meatus outward)</label>
                            <label class="checklist-item"><input type="checkbox"> Insert catheter until urine flows, then advance 2-3 inches more</label>
                            <label class="checklist-item"><input type="checkbox"> Inflate balloon with 10mL sterile water</label>
                            <label class="checklist-item"><input type="checkbox"> Gently pull back to confirm balloon seated</label>
                            <label class="checklist-item"><input type="checkbox"> Secure catheter to thigh, connect to drainage bag</label>
                            <label class="checklist-item"><input type="checkbox"> Position bag below bladder level</label>
                            <label class="checklist-item"><input type="checkbox"> Document: catheter size, balloon volume, urine output, patient tolerance</label>
                        </div>
                        <button onclick="clearChecklist('foley-checklist')" style="margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Reset Checklist</button>
                    </div>

                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">💉 IV Insertion</h3>
                    <div class="collapse-content hidden">
                        <div class="checklist" id="iv-checklist">
                            <label class="checklist-item"><input type="checkbox"> Verify order, check patient ID, assess for allergies</label>
                            <label class="checklist-item"><input type="checkbox"> Gather supplies: IV catheter, tegaderm, extension set, flush, tourniquet</label>
                            <label class="checklist-item"><input type="checkbox"> Explain procedure to patient</label>
                            <label class="checklist-item"><input type="checkbox"> Perform hand hygiene, apply clean gloves</label>
                            <label class="checklist-item"><input type="checkbox"> Select appropriate vein (avoid arm with fistula, mastectomy side, injured area)</label>
                            <label class="checklist-item"><input type="checkbox"> Apply tourniquet 4-6 inches above site</label>
                            <label class="checklist-item"><input type="checkbox"> Palpate vein, confirm bouncy feeling</label>
                            <label class="checklist-item"><input type="checkbox"> Cleanse site with alcohol/chlorhexidine, allow to dry</label>
                            <label class="checklist-item"><input type="checkbox"> Anchor vein below insertion site</label>
                            <label class="checklist-item"><input type="checkbox"> Insert catheter at 15-30° angle, bevel up</label>
                            <label class="checklist-item"><input type="checkbox"> Observe for flashback in chamber</label>
                            <label class="checklist-item"><input type="checkbox"> Advance catheter, retract stylet</label>
                            <label class="checklist-item"><input type="checkbox"> Release tourniquet</label>
                            <label class="checklist-item"><input type="checkbox"> Apply pressure above catheter tip, remove stylet completely</label>
                            <label class="checklist-item"><input type="checkbox"> Connect extension set/flush, secure with tegaderm</label>
                            <label class="checklist-item"><input type="checkbox"> Flush with saline, assess for infiltration</label>
                            <label class="checklist-item"><input type="checkbox"> Label dressing with date, time, initials, gauge</label>
                            <label class="checklist-item"><input type="checkbox"> Document: site, catheter gauge, number of attempts, patient tolerance</label>
                        </div>
                        <button onclick="clearChecklist('iv-checklist')" style="margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Reset Checklist</button>
                    </div>

                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">🩹 Wound Care/Dressing Change</h3>
                    <div class="collapse-content hidden">
                        <div class="checklist" id="wound-checklist">
                            <label class="checklist-item"><input type="checkbox"> Review order and wound care instructions</label>
                            <label class="checklist-item"><input type="checkbox"> Gather supplies based on wound type</label>
                            <label class="checklist-item"><input type="checkbox"> Perform hand hygiene, apply clean gloves</label>
                            <label class="checklist-item"><input type="checkbox"> Position patient, ensure adequate lighting</label>
                            <label class="checklist-item"><input type="checkbox"> Remove old dressing, assess drainage on dressing</label>
                            <label class="checklist-item"><input type="checkbox"> Dispose of soiled dressing, remove gloves, hand hygiene</label>
                            <label class="checklist-item"><input type="checkbox"> Apply sterile gloves</label>
                            <label class="checklist-item"><input type="checkbox"> Assess wound: size, depth, drainage, odor, edges, surrounding skin</label>
                            <label class="checklist-item"><input type="checkbox"> Cleanse wound per order (typically center to periphery)</label>
                            <label class="checklist-item"><input type="checkbox"> Apply prescribed treatment/medication</label>
                            <label class="checklist-item"><input type="checkbox"> Apply appropriate dressing, secure</label>
                            <label class="checklist-item"><input type="checkbox"> Label dressing with date, time, initials</label>
                            <label class="checklist-item"><input type="checkbox"> Document: wound assessment, treatment, patient response</label>
                        </div>
                        <button onclick="clearChecklist('wound-checklist')" style="margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Reset Checklist</button>
                    </div>

                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">💊 Medication Administration (5 Rights)</h3>
                    <div class="collapse-content hidden">
                        <div class="checklist" id="med-checklist">
                            <label class="checklist-item"><input type="checkbox"> <strong>Right Patient</strong> - Check 2 identifiers (name, DOB, MRN)</label>
                            <label class="checklist-item"><input type="checkbox"> <strong>Right Drug</strong> - Verify medication matches order</label>
                            <label class="checklist-item"><input type="checkbox"> <strong>Right Dose</strong> - Calculate if needed, verify amount</label>
                            <label class="checklist-item"><input type="checkbox"> <strong>Right Route</strong> - PO, IV, IM, SubQ, SL, etc.</label>
                            <label class="checklist-item"><input type="checkbox"> <strong>Right Time</strong> - Within 30 min of scheduled time</label>
                            <label class="checklist-item"><input type="checkbox"> Check for allergies</label>
                            <label class="checklist-item"><input type="checkbox"> Verify expiration date</label>
                            <label class="checklist-item"><input type="checkbox"> Assess for contraindications (vital signs, labs)</label>
                            <label class="checklist-item"><input type="checkbox"> Educate patient about medication</label>
                            <label class="checklist-item"><input type="checkbox"> Administer medication</label>
                            <label class="checklist-item"><input type="checkbox"> Stay with patient for PO meds to ensure swallowed</label>
                            <label class="checklist-item"><input type="checkbox"> Document immediately after administration</label>
                        </div>
                        <button onclick="clearChecklist('med-checklist')" style="margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Reset Checklist</button>
                    </div>

                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">🫁 Tracheostomy Care</h3>
                    <div class="collapse-content hidden">
                        <div class="checklist" id="trach-checklist">
                            <label class="checklist-item"><input type="checkbox"> Verify order, gather supplies, explain to patient</label>
                            <label class="checklist-item"><input type="checkbox"> Position patient (semi-Fowler's)</label>
                            <label class="checklist-item"><input type="checkbox"> Perform hand hygiene, apply sterile gloves</label>
                            <label class="checklist-item"><input type="checkbox"> Suction tracheostomy if needed (before cleaning)</label>
                            <label class="checklist-item"><input type="checkbox"> Remove inner cannula (if applicable)</label>
                            <label class="checklist-item"><input type="checkbox"> Clean inner cannula with sterile saline/hydrogen peroxide</label>
                            <label class="checklist-item"><input type="checkbox"> Rinse with sterile saline, dry with pipe cleaners</label>
                            <label class="checklist-item"><input type="checkbox"> Replace inner cannula and lock in place</label>
                            <label class="checklist-item"><input type="checkbox"> Clean stoma site with sterile saline, moving outward</label>
                            <label class="checklist-item"><input type="checkbox"> Apply pre-cut trach dressing (do not cut gauze)</label>
                            <label class="checklist-item"><input type="checkbox"> Change trach ties if soiled (two-person assist recommended)</label>
                            <label class="checklist-item"><input type="checkbox"> Ensure ties allow 1-2 finger breadth</label>
                            <label class="checklist-item"><input type="checkbox"> Document: stoma condition, secretions, patient tolerance</label>
                        </div>
                        <button onclick="clearChecklist('trach-checklist')" style="margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Reset Checklist</button>
                    </div>
                    </div>
                </div>

                <!-- Medication Timer -->
                <div class="card resource-card collapsible collapsed" data-tags="timers clinical meds reminders">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>⏱️ Med Pass Timer</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Set reminders for medication rounds or patient checks</p>

                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="setMedTimer(15)" class="timer-preset">15 min</button>
                            <button onclick="setMedTimer(30)" class="timer-preset">30 min</button>
                            <button onclick="setMedTimer(60)" class="timer-preset">1 hour</button>
                            <button onclick="setMedTimer(120)" class="timer-preset">2 hours</button>
                        </div>

                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 13px; font-weight: 600;">Custom:</label>
                            <input type="number" id="customTimerMin" placeholder="Minutes" min="1" max="480" style="flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
                            <button onclick="setMedTimer(parseInt(document.getElementById('customTimerMin').value))" style="padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Set</button>
                        </div>

                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 13px; font-weight: 600;">Label:</label>
                            <input type="text" id="timerLabel" placeholder="e.g., Room 412 Pain Med" style="flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>

                    <!-- Active Timers -->
                    <div id="activeTimers" style="margin-top: 15px;"></div>

                    <p style="font-size: 11px; color: #888; margin-top: 15px;">
                        <strong>Note:</strong> Enable browser notifications for alerts when timer completes.
                        <button onclick="requestNotificationPermission()" style="background: none; border: none; color: var(--accent); text-decoration: underline; cursor: pointer; font-size: 11px;">Enable Notifications</button>
                    </p>
                    </div>
                </div>

                <!-- EKG Reference Guide -->
                <div class="card resource-card collapsible collapsed" data-tags="ekg ecg cardiac arrhythmia rhythm strips">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>💓 EKG/ECG Reference Guide</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">

                    <!-- Visual Rhythm Strips Section -->
                    <h3 style="color: #1f4e79; margin-bottom: 15px; border-bottom: 2px solid #1f4e79; padding-bottom: 8px;">Visual Rhythm Strips</h3>
                    <p style="font-size: 11px; color: #666; margin-bottom: 15px;">Classic ECG paper format: Small box = 0.04 sec (40 ms) / 0.1 mV. Large box = 0.2 sec / 0.5 mV. Each strip shows ~3 seconds.</p>

                    <!-- SVG Pattern Definitions (shared across all strips) -->
                    <svg style="position: absolute; width: 0; height: 0;">
                        <defs>
                            <pattern id="ecgSmallGrid" width="10" height="10" patternUnits="userSpaceOnUse">
                                <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#ffcccc" stroke-width="0.5"/>
                            </pattern>
                            <pattern id="ecgLargeGrid" width="50" height="50" patternUnits="userSpaceOnUse">
                                <rect width="50" height="50" fill="url(#ecgSmallGrid)"/>
                                <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#ff9999" stroke-width="1"/>
                            </pattern>
                        </defs>
                    </svg>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; margin-bottom: 25px;">

                        <!-- Normal Sinus Rhythm -->
                        <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #2e7d32; font-size: 13px;">Normal Sinus Rhythm (NSR)</strong>
                                <span style="background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 10px; font-size: 10px;">60-100 bpm</span>
                            </div>
                            <svg viewBox="0 0 300 80" style="width: 100%; height: 70px; background: #fff5f5; border-radius: 4px;">
                                <rect width="300" height="80" fill="url(#ecgLargeGrid)"/>
                                <!-- NSR: Regular P-QRS-T at ~75 bpm (R-R ~0.8 sec = 80 units) -->
                                <path d="M0,40 L15,40 Q20,40 22,36 Q25,28 28,40 L32,40 L34,38 L36,60 L40,15 L44,45 L48,40 Q52,40 55,35 Q60,42 65,40 L95,40 Q100,40 102,36 Q105,28 108,40 L112,40 L114,38 L116,60 L120,15 L124,45 L128,40 Q132,40 135,35 Q140,42 145,40 L175,40 Q180,40 182,36 Q185,28 188,40 L192,40 L194,38 L196,60 L200,15 L204,45 L208,40 Q212,40 215,35 Q220,42 225,40 L255,40 Q260,40 262,36 Q265,28 268,40 L272,40 L274,38 L276,60 L280,15 L284,45 L288,40 Q292,40 295,35 L300,40"
                                      stroke="#000" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p style="font-size: 10px; color: #555; margin-top: 6px;">Regular rhythm • P before each QRS • PR 0.12-0.20s • QRS &lt;0.12s</p>
                        </div>

                        <!-- Sinus Bradycardia -->
                        <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #1565c0; font-size: 13px;">Sinus Bradycardia</strong>
                                <span style="background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 10px; font-size: 10px;">&lt;60 bpm</span>
                            </div>
                            <svg viewBox="0 0 300 80" style="width: 100%; height: 70px; background: #fff5f5; border-radius: 4px;">
                                <rect width="300" height="80" fill="url(#ecgLargeGrid)"/>
                                <!-- Sinus Brady: Same morphology, wider spacing (~50 bpm, R-R ~1.2 sec = 120 units) -->
                                <path d="M0,40 L25,40 Q30,40 32,36 Q35,28 38,40 L42,40 L44,38 L46,60 L50,15 L54,45 L58,40 Q62,40 65,35 Q70,42 75,40 L145,40 Q150,40 152,36 Q155,28 158,40 L162,40 L164,38 L166,60 L170,15 L174,45 L178,40 Q182,40 185,35 Q190,42 195,40 L265,40 Q270,40 272,36 Q275,28 278,40 L282,40 L284,38 L286,60 L290,15 L294,45 L298,40 L300,40"
                                      stroke="#000" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p style="font-size: 10px; color: #555; margin-top: 6px;">Regular rhythm • Normal P-QRS-T • Rate &lt;60 • Athletes, sleep, beta-blockers</p>
                        </div>

                        <!-- Sinus Tachycardia -->
                        <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #e65100; font-size: 13px;">Sinus Tachycardia</strong>
                                <span style="background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 10px; font-size: 10px;">&gt;100 bpm</span>
                            </div>
                            <svg viewBox="0 0 300 80" style="width: 100%; height: 70px; background: #fff5f5; border-radius: 4px;">
                                <rect width="300" height="80" fill="url(#ecgLargeGrid)"/>
                                <!-- Sinus Tachy: Same morphology, closer spacing (~120 bpm, R-R ~0.5 sec = 50 units) -->
                                <path d="M0,40 L8,40 Q12,40 14,36 Q16,30 18,40 L21,40 L22,38 L24,58 L27,18 L30,44 L33,40 Q36,40 38,36 Q41,42 44,40
                                         L58,40 Q62,40 64,36 Q66,30 68,40 L71,40 L72,38 L74,58 L77,18 L80,44 L83,40 Q86,40 88,36 Q91,42 94,40
                                         L108,40 Q112,40 114,36 Q116,30 118,40 L121,40 L122,38 L124,58 L127,18 L130,44 L133,40 Q136,40 138,36 Q141,42 144,40
                                         L158,40 Q162,40 164,36 Q166,30 168,40 L171,40 L172,38 L174,58 L177,18 L180,44 L183,40 Q186,40 188,36 Q191,42 194,40
                                         L208,40 Q212,40 214,36 Q216,30 218,40 L221,40 L222,38 L224,58 L227,18 L230,44 L233,40 Q236,40 238,36 Q241,42 244,40
                                         L258,40 Q262,40 264,36 Q266,30 268,40 L271,40 L272,38 L274,58 L277,18 L280,44 L283,40 Q286,40 288,36 Q291,42 294,40 L300,40"
                                      stroke="#000" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p style="font-size: 10px; color: #555; margin-top: 6px;">Regular rhythm • Normal P-QRS-T • Rate &gt;100 • Fever, pain, anxiety, hypovolemia</p>
                        </div>

                        <!-- Atrial Fibrillation -->
                        <div style="background: #fff; border: 1px solid #c2185b; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #c2185b; font-size: 13px;">Atrial Fibrillation (A-Fib)</strong>
                                <span style="background: #fce4ec; color: #c2185b; padding: 2px 8px; border-radius: 10px; font-size: 10px;">Irreg. Irreg.</span>
                            </div>
                            <svg viewBox="0 0 300 80" style="width: 100%; height: 70px; background: #fff5f5; border-radius: 4px;">
                                <rect width="300" height="80" fill="url(#ecgLargeGrid)"/>
                                <!-- A-Fib: No P waves, fibrillatory baseline, irregular R-R intervals -->
                                <path d="M0,40 L5,39 L8,41 L12,39 L15,41 L18,40 L20,38 L22,58 L25,18 L28,44 L31,40 L34,41 L37,39 L40,40 L43,41 L46,39 L50,40 L54,39 L58,41 L62,39 L65,40 L67,38 L69,60 L72,16 L75,45 L78,40 L82,41 L86,39 L90,40 L95,41 L100,39 L105,41 L108,38 L110,62 L113,14 L116,46 L120,40 L125,39 L130,41 L135,40 L138,41 L142,39 L146,40 L150,41 L154,39 L158,40 L161,38 L163,59 L166,17 L169,44 L173,40 L178,39 L183,41 L188,39 L192,41 L196,40 L200,39 L205,41 L209,39 L213,40 L218,41 L222,39 L225,40 L228,38 L230,61 L233,15 L236,45 L240,40 L245,41 L250,39 L255,40 L260,41 L265,39 L270,40 L275,41 L280,39 L285,40 L288,38 L290,58 L293,19 L296,44 L300,40"
                                      stroke="#000" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p style="font-size: 10px; color: #c2185b; margin-top: 6px;"><strong>Irregularly irregular</strong> • No P waves (fibrillatory baseline) • Stroke risk!</p>
                        </div>

                        <!-- Atrial Flutter -->
                        <div style="background: #fff; border: 1px solid #7b1fa2; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #7b1fa2; font-size: 13px;">Atrial Flutter</strong>
                                <span style="background: #f3e5f5; color: #7b1fa2; padding: 2px 8px; border-radius: 10px; font-size: 10px;">~150 bpm (2:1)</span>
                            </div>
                            <svg viewBox="0 0 300 80" style="width: 100%; height: 70px; background: #fff5f5; border-radius: 4px;">
                                <rect width="300" height="80" fill="url(#ecgLargeGrid)"/>
                                <!-- A-Flutter: Sawtooth F waves (~300/min), regular QRS at 2:1 block (~150/min) -->
                                <path d="M0,40 L4,35 L8,45 L12,35 L16,45 L20,35 L22,38 L24,58 L27,18 L30,44 L33,40 L36,35 L40,45 L44,35 L48,45 L52,35 L56,45 L60,35 L64,45 L68,35 L70,38 L72,58 L75,18 L78,44 L81,40 L84,35 L88,45 L92,35 L96,45 L100,35 L104,45 L108,35 L112,45 L116,35 L118,38 L120,58 L123,18 L126,44 L129,40 L132,35 L136,45 L140,35 L144,45 L148,35 L152,45 L156,35 L160,45 L164,35 L166,38 L168,58 L171,18 L174,44 L177,40 L180,35 L184,45 L188,35 L192,45 L196,35 L200,45 L204,35 L208,45 L212,35 L214,38 L216,58 L219,18 L222,44 L225,40 L228,35 L232,45 L236,35 L240,45 L244,35 L248,45 L252,35 L256,45 L260,35 L262,38 L264,58 L267,18 L270,44 L273,40 L276,35 L280,45 L284,35 L288,45 L292,35 L296,45 L300,35"
                                      stroke="#000" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p style="font-size: 10px; color: #555; margin-top: 6px;"><strong>Sawtooth pattern</strong> (F waves) • Atrial rate ~300 • Usually regular ventricular rate</p>
                        </div>

                        <!-- Ventricular Tachycardia -->
                        <div style="background: #fff; border: 2px solid #d32f2f; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #d32f2f; font-size: 13px;">Ventricular Tachycardia (V-Tach)</strong>
                                <span style="background: #ffebee; color: #d32f2f; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">EMERGENCY</span>
                            </div>
                            <svg viewBox="0 0 300 80" style="width: 100%; height: 70px; background: #fff5f5; border-radius: 4px;">
                                <rect width="300" height="80" fill="url(#ecgLargeGrid)"/>
                                <!-- V-Tach: Wide QRS (>0.12s), regular, rate >100, no P waves -->
                                <path d="M0,40 L8,40 L10,35 L14,65 L22,10 L30,55 L34,40 L42,40 L44,35 L48,65 L56,10 L64,55 L68,40 L76,40 L78,35 L82,65 L90,10 L98,55 L102,40 L110,40 L112,35 L116,65 L124,10 L132,55 L136,40 L144,40 L146,35 L150,65 L158,10 L166,55 L170,40 L178,40 L180,35 L184,65 L192,10 L200,55 L204,40 L212,40 L214,35 L218,65 L226,10 L234,55 L238,40 L246,40 L248,35 L252,65 L260,10 L268,55 L272,40 L280,40 L282,35 L286,65 L294,10 L300,40"
                                      stroke="#d32f2f" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p style="font-size: 10px; color: #d32f2f; margin-top: 6px;"><strong>Wide QRS (&gt;0.12s)</strong> • Regular • Rate &gt;100 • CHECK PULSE! Start ACLS</p>
                        </div>

                        <!-- Ventricular Fibrillation -->
                        <div style="background: #ffebee; border: 2px solid #d32f2f; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #d32f2f; font-size: 13px;">Ventricular Fibrillation (V-Fib)</strong>
                                <span style="background: #d32f2f; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">DEFIB NOW!</span>
                            </div>
                            <svg viewBox="0 0 300 80" style="width: 100%; height: 70px; background: #fff5f5; border-radius: 4px;">
                                <rect width="300" height="80" fill="url(#ecgLargeGrid)"/>
                                <!-- V-Fib: Chaotic, irregular, no identifiable waves -->
                                <path d="M0,40 L5,25 L10,55 L15,30 L20,60 L25,20 L30,50 L35,35 L40,65 L45,15 L50,45 L55,30 L60,70 L65,25 L70,55 L75,20 L80,48 L85,35 L90,62 L95,22 L100,52 L105,28 L110,58 L115,18 L120,50 L125,32 L130,68 L135,24 L140,54 L145,30 L150,60 L155,20 L160,55 L165,25 L170,58 L175,22 L180,52 L185,35 L190,65 L195,18 L200,48 L205,28 L210,62 L215,24 L220,56 L225,30 L230,58 L235,20 L240,50 L245,32 L250,66 L255,22 L260,54 L265,28 L270,60 L275,18 L280,52 L285,35 L290,62 L295,25 L300,50"
                                      stroke="#d32f2f" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p style="font-size: 10px; color: #d32f2f; margin-top: 6px; font-weight: bold;">Chaotic • No pulse • DEFIBRILLATE IMMEDIATELY! CPR until defibrillator ready</p>
                        </div>

                        <!-- Asystole -->
                        <div style="background: #ffebee; border: 2px solid #d32f2f; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #d32f2f; font-size: 13px;">Asystole (Flatline)</strong>
                                <span style="background: #d32f2f; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">NO SHOCK</span>
                            </div>
                            <svg viewBox="0 0 300 80" style="width: 100%; height: 70px; background: #fff5f5; border-radius: 4px;">
                                <rect width="300" height="80" fill="url(#ecgLargeGrid)"/>
                                <!-- Asystole: Flat line with minimal drift -->
                                <path d="M0,40 L50,40 L55,39 L60,41 L100,40 L150,40 L155,41 L160,39 L200,40 L250,40 L255,39 L260,41 L300,40"
                                      stroke="#d32f2f" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p style="font-size: 10px; color: #d32f2f; margin-top: 6px; font-weight: bold;">Flatline • No electrical activity • CPR + Epinephrine • NOT shockable!</p>
                        </div>
                    </div>

                    <p style="font-size: 10px; color: #666; text-align: center; margin-bottom: 20px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
                        <strong>Source:</strong> Waveforms based on standard ECG morphology per <a href="https://ecg.utah.edu/" target="_blank" style="color: #1f4e79;">University of Utah ECG Learning Center</a>
                        and <a href="https://uark.pressbooks.pub/ekgmanual/" target="_blank" style="color: #1f4e79;">University of Arkansas EKG Essentials</a> (CC BY-NC 4.0)
                    </p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                        <!-- Normal Values -->
                        <div style="background: #e8f5e9; border-radius: 10px; padding: 14px; border-left: 4px solid #4caf50;">
                            <h3 style="color: #2e7d32; margin-bottom: 10px; font-size: 14px;">Normal Sinus Rhythm</h3>
                            <ul style="font-size: 12px; color: #333; padding-left: 18px; line-height: 1.7;">
                                <li><strong>Rate:</strong> 60-100 bpm</li>
                                <li><strong>Rhythm:</strong> Regular</li>
                                <li><strong>P waves:</strong> Present, upright, one before each QRS</li>
                                <li><strong>PR interval:</strong> 0.12-0.20 sec (3-5 small boxes)</li>
                                <li><strong>QRS duration:</strong> 0.06-0.10 sec (&lt;3 small boxes)</li>
                                <li><strong>QT interval:</strong> &lt;0.44 sec (corrected)</li>
                            </ul>
                        </div>

                        <!-- Heart Rate Calculation -->
                        <div style="background: #e3f2fd; border-radius: 10px; padding: 14px; border-left: 4px solid #2196f3;">
                            <h3 style="color: #1565c0; margin-bottom: 10px; font-size: 14px;">Heart Rate Calculation</h3>
                            <ul style="font-size: 12px; color: #333; padding-left: 18px; line-height: 1.7;">
                                <li><strong>6-Second Method:</strong> Count QRS complexes in 6 seconds × 10</li>
                                <li><strong>300 Rule (regular):</strong> 300 ÷ # large boxes between R waves</li>
                                <li><strong>1500 Rule (precise):</strong> 1500 ÷ # small boxes between R waves</li>
                                <li><strong>Sequence:</strong> 300-150-100-75-60-50 (for large box counting)</li>
                            </ul>
                        </div>

                        <!-- Interval Reference -->
                        <div style="background: #fff3e0; border-radius: 10px; padding: 14px; border-left: 4px solid #ff9800;">
                            <h3 style="color: #e65100; margin-bottom: 10px; font-size: 14px;">Interval Reference</h3>
                            <ul style="font-size: 12px; color: #333; padding-left: 18px; line-height: 1.7;">
                                <li><strong>PR Interval:</strong> 0.12-0.20 sec
                                    <br><span style="color:#666; font-size:11px;">• Short (&lt;0.12): WPW, junctional</span>
                                    <br><span style="color:#666; font-size:11px;">• Long (&gt;0.20): 1° AV block</span>
                                </li>
                                <li><strong>QRS Complex:</strong> &lt;0.12 sec
                                    <br><span style="color:#666; font-size:11px;">• Wide (&gt;0.12): BBB, ventricular origin</span>
                                </li>
                                <li><strong>QT Interval:</strong> &lt;0.44 sec (varies with HR)
                                    <br><span style="color:#666; font-size:11px;">• Long QT: Torsades risk</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Arrhythmia Quick Reference -->
                        <div style="background: #fce4ec; border-radius: 10px; padding: 14px; border-left: 4px solid #e91e63;">
                            <h3 style="color: #c2185b; margin-bottom: 10px; font-size: 14px;">Arrhythmia Quick Reference</h3>
                            <ul style="font-size: 12px; color: #333; padding-left: 18px; line-height: 1.7;">
                                <li><strong>Sinus Brady:</strong> &lt;60 bpm, regular rhythm</li>
                                <li><strong>Sinus Tachy:</strong> &gt;100 bpm, regular rhythm</li>
                                <li><strong>A-Fib:</strong> Irregularly irregular, no P waves</li>
                                <li><strong>A-Flutter:</strong> Sawtooth pattern, regular R-R</li>
                                <li><strong>V-Tach:</strong> Wide QRS, rate &gt;100, regular</li>
                                <li><strong>V-Fib:</strong> Chaotic, no discernible waves</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Common Arrhythmias Table -->
                    <h3 style="margin-top: 20px; color: #1f4e79;">Common Arrhythmias - Key Features</h3>
                    <div style="overflow-x: auto; margin-top: 10px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #1f4e79; color: white;">
                                    <th style="padding: 10px; text-align: left;">Rhythm</th>
                                    <th style="padding: 10px; text-align: center;">Rate</th>
                                    <th style="padding: 10px; text-align: center;">Regularity</th>
                                    <th style="padding: 10px; text-align: left;">P Waves</th>
                                    <th style="padding: 10px; text-align: left;">Key Features</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 8px; font-weight: 600;">NSR</td>
                                    <td style="padding: 8px; text-align: center;">60-100</td>
                                    <td style="padding: 8px; text-align: center;">Regular</td>
                                    <td style="padding: 8px;">Upright, 1:1</td>
                                    <td style="padding: 8px;">Normal intervals</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; font-weight: 600;">Sinus Bradycardia</td>
                                    <td style="padding: 8px; text-align: center;">&lt;60</td>
                                    <td style="padding: 8px; text-align: center;">Regular</td>
                                    <td style="padding: 8px;">Normal</td>
                                    <td style="padding: 8px;">Athletes, sleep, beta blockers</td>
                                </tr>
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 8px; font-weight: 600;">Sinus Tachycardia</td>
                                    <td style="padding: 8px; text-align: center;">&gt;100</td>
                                    <td style="padding: 8px; text-align: center;">Regular</td>
                                    <td style="padding: 8px;">Normal</td>
                                    <td style="padding: 8px;">Fever, pain, anxiety, hypovolemia</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; font-weight: 600; color: #c2185b;">Atrial Fibrillation</td>
                                    <td style="padding: 8px; text-align: center;">Varies</td>
                                    <td style="padding: 8px; text-align: center; color: #c2185b;">Irreg. Irreg.</td>
                                    <td style="padding: 8px; color: #c2185b;">Absent/fibrillatory</td>
                                    <td style="padding: 8px;">Stroke risk! Anticoag needed</td>
                                </tr>
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 8px; font-weight: 600;">Atrial Flutter</td>
                                    <td style="padding: 8px; text-align: center;">150 (2:1)</td>
                                    <td style="padding: 8px; text-align: center;">Often regular</td>
                                    <td style="padding: 8px;">Sawtooth (F waves)</td>
                                    <td style="padding: 8px;">Atrial rate ~300, fixed block</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; font-weight: 600;">1° AV Block</td>
                                    <td style="padding: 8px; text-align: center;">Normal</td>
                                    <td style="padding: 8px; text-align: center;">Regular</td>
                                    <td style="padding: 8px;">Normal, 1:1</td>
                                    <td style="padding: 8px;">PR &gt;0.20 sec (prolonged)</td>
                                </tr>
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 8px; font-weight: 600; color: #d32f2f;">2° AV Block Type II</td>
                                    <td style="padding: 8px; text-align: center;">Often slow</td>
                                    <td style="padding: 8px; text-align: center;">Irregular</td>
                                    <td style="padding: 8px;">More P's than QRS</td>
                                    <td style="padding: 8px; color: #d32f2f;">May progress to 3°! Pacing</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; font-weight: 600; color: #d32f2f;">3° AV Block</td>
                                    <td style="padding: 8px; text-align: center;">20-60</td>
                                    <td style="padding: 8px; text-align: center;">Regular (2 rates)</td>
                                    <td style="padding: 8px;">P's march out</td>
                                    <td style="padding: 8px; color: #d32f2f;">Complete block! Pace ASAP</td>
                                </tr>
                                <tr style="background: #ffebee;">
                                    <td style="padding: 8px; font-weight: 600; color: #d32f2f;">Ventricular Tach</td>
                                    <td style="padding: 8px; text-align: center; color: #d32f2f;">&gt;100</td>
                                    <td style="padding: 8px; text-align: center;">Usually regular</td>
                                    <td style="padding: 8px;">None visible</td>
                                    <td style="padding: 8px; color: #d32f2f;">Wide QRS! Check pulse. ACLS</td>
                                </tr>
                                <tr style="background: #ffcdd2;">
                                    <td style="padding: 8px; font-weight: 600; color: #d32f2f;">Ventricular Fib</td>
                                    <td style="padding: 8px; text-align: center; color: #d32f2f;">N/A</td>
                                    <td style="padding: 8px; text-align: center; color: #d32f2f;">Chaotic</td>
                                    <td style="padding: 8px; color: #d32f2f;">None</td>
                                    <td style="padding: 8px; color: #d32f2f; font-weight: 600;">DEFIB IMMEDIATELY!</td>
                                </tr>
                                <tr style="background: #ffcdd2;">
                                    <td style="padding: 8px; font-weight: 600; color: #d32f2f;">Asystole</td>
                                    <td style="padding: 8px; text-align: center; color: #d32f2f;">0</td>
                                    <td style="padding: 8px; text-align: center; color: #d32f2f;">None</td>
                                    <td style="padding: 8px; color: #d32f2f;">None</td>
                                    <td style="padding: 8px; color: #d32f2f; font-weight: 600;">Flatline. CPR. Epi.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <p style="margin-top: 15px; font-size: 11px; color: #666; text-align: center;">
                        <strong>Remember:</strong> Always correlate EKG findings with patient assessment. "Treat the patient, not the monitor."
                    </p>
                    </div><!-- end card-content -->
                </div>

                <!-- Additional Resources -->
                <div class="card resource-card collapsible collapsed" data-tags="study links reference safety">
                    <div class="card-header" onclick="toggleResourceCard(this)">
                        <h2>🔗 Additional Resources</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="card-content">
                    <ul class="link-list">
                        <li><a href="https://www.nursingworld.org/" target="_blank">🏥 American Nurses Association</a></li>
                        <li><a href="https://www.ncsbn.org/nclex.htm" target="_blank">📚 NCLEX Resources (NCSBN)</a></li>
                        <li><a href="https://www.cdc.gov/niosh/topics/bbp/" target="_blank">🧤 CDC Bloodborne Pathogens</a></li>
                        <li><a href="https://www.jointcommission.org/resources/patient-safety-topics/patient-safety/" target="_blank">⚕️ Joint Commission Patient Safety</a></li>
                        <li><a href="https://www.ahrq.gov/patient-safety/index.html" target="_blank">🛡️ AHRQ Patient Safety</a></li>
                    </ul>
                    </div>
                </div>

                <!-- Cited Sources Button -->
                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <button onclick="openCitedSources()" class="btn" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);">
                        📚 View Cited Sources (APA Format)
                    </button>
                    <p style="font-size: 10px; color: #666; margin-top: 8px;">Academic citations for all clinical reference content</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Cited Sources Modal -->
    <div id="citedSourcesModal" class="modal-overlay hidden" onclick="if(event.target === this) closeCitedSources()">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; padding-bottom: 10px; border-bottom: 2px solid #1f4e79;">
                <h2 style="color: #1f4e79; font-size: 20px;">📚 Cited Sources</h2>
                <button onclick="closeCitedSources()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
            </div>

            <p style="font-size: 12px; color: #666; margin-bottom: 20px;">All clinical reference content on this page is based on the following academic sources, formatted in APA 7th edition.</p>

            <h3 style="color: #1f4e79; font-size: 14px; margin: 20px 0 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">Assessment Tools</h3>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                Apgar, V. (1953). A proposal for a new method of evaluation of the newborn infant. <em>Current Researches in Anesthesia & Analgesia, 32</em>(4), 260-267.
            </p>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                McCaffery, M., & Beebe, A. (1989). <em>Pain: Clinical manual for nursing practice</em>. Mosby.
            </p>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                Merkel, S. I., Voepel-Lewis, T., Shayevitz, J. R., & Malviya, S. (1997). The FLACC: A behavioral scale for scoring postoperative pain in young children. <em>Pediatric Nursing, 23</em>(3), 293-297.
            </p>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                Teasdale, G., & Jennett, B. (1974). Assessment of coma and impaired consciousness: A practical scale. <em>The Lancet, 304</em>(7872), 81-84. https://doi.org/10.1016/S0140-6736(74)91639-0
            </p>

            <h3 style="color: #1f4e79; font-size: 14px; margin: 20px 0 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">Vital Signs & Clinical Guidelines</h3>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                American Heart Association. (2020). <em>Pediatric Advanced Life Support (PALS) provider manual</em>. American Heart Association.
            </p>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                Whelton, P. K., Carey, R. M., Aronow, W. S., Casey, D. E., Collins, K. J., Himmelfarb, C. D., ... & Wright, J. T. (2018). 2017 ACC/AHA/AAPA/ABC/ACPM/AGS/APhA/ASH/ASPC/NMA/PCNA guideline for the prevention, detection, evaluation, and management of high blood pressure in adults. <em>Hypertension, 71</em>(6), e13-e115.
            </p>

            <h3 style="color: #1f4e79; font-size: 14px; margin: 20px 0 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">Laboratory Values</h3>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                Pagana, K. D., Pagana, T. J., & Pagana, T. N. (2022). <em>Mosby's manual of diagnostic and laboratory tests</em> (7th ed.). Elsevier.
            </p>

            <h3 style="color: #1f4e79; font-size: 14px; margin: 20px 0 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">Communication & Safety</h3>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                Haig, K. M., Sutton, S., & Whittington, J. (2006). SBAR: A shared mental model for improving communication between clinicians. <em>The Joint Commission Journal on Quality and Patient Safety, 32</em>(3), 167-175.
            </p>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                Institute for Safe Medication Practices. (2021). <em>ISMP guidelines for safe medication practices</em>. https://www.ismp.org
            </p>

            <h3 style="color: #1f4e79; font-size: 14px; margin: 20px 0 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">Nursing Diagnoses</h3>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                Herdman, T. H., Kamitsuru, S., & Lopes, C. T. (Eds.). (2021). <em>NANDA International nursing diagnoses: Definitions and classification 2021-2023</em> (12th ed.). Thieme.
            </p>

            <h3 style="color: #1f4e79; font-size: 14px; margin: 20px 0 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">Cardiac/EKG Reference</h3>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                McGee, J. E. (2024). <em>EKG essentials: A student handbook</em>. University of Arkansas. CC BY-NC 4.0. https://uark.pressbooks.pub/ekgmanual/
            </p>

            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 12px; padding-left: 20px; text-indent: -20px;">
                University of Utah Health. (n.d.). <em>ECG learning center</em>. https://ecg.utah.edu/
            </p>

            <div style="margin-top: 25px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #1f4e79;">
                <p style="font-size: 11px; color: #333; margin: 0;"><strong>Note:</strong> This resource is intended for educational purposes only. Always verify clinical information with current institutional protocols and authoritative sources. Content is updated periodically to reflect current evidence-based practice.</p>
            </div>
        </div>
    </div>

    <!-- Lock Screen Overlay -->
    <div id="lockScreenOverlay">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px;">🔒</div>
            <h1 style="font-size: 42px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">BSN9B</h1>
            <p style="font-size: 18px; opacity: 0.8; margin-bottom: 40px;">Portal Locked</p>
            <button onclick="unlockScreen()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 18px 50px; border-radius: 30px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);">🔓 Unlock Portal</button>
            <p style="margin-top: 30px; font-size: 12px; opacity: 0.5;">Click unlock to return to your session</p>
        </div>
    </div>

    <!-- Bottom Toolbar -->
    <nav class="bottom-toolbar" role="navigation" aria-label="Main navigation">
        <a href="/home/" class="toolbar-item" aria-label="Home">
            <span class="icon" aria-hidden="true">🏠</span>
            <span class="label">Home</span>
        </a>
        <a href="/app/" class="toolbar-item" aria-label="RN Notes">
            <span class="icon" aria-hidden="true">📝</span>
            <span class="label">RN Notes</span>
        </a>
        <a href="/chat/" class="toolbar-item" aria-label="Chat" target="_blank" style="position:relative;">
            <span class="icon" aria-hidden="true">💬</span>
            <span class="label">Chat</span>
            <span id="chatNavBadge" style="display:none;position:absolute;top:2px;right:2px;background:#e94560;color:white;border-radius:50%;width:16px;height:16px;font-size:9px;font-weight:bold;line-height:16px;text-align:center;">0</span>
        </a>
        <a href="/ai/" class="toolbar-item" aria-label="AI Assistant" target="_blank">
            <span class="icon" aria-hidden="true">🩺</span>
            <span class="label">AI</span>
        </a>
        <a href="/community/" class="toolbar-item" aria-label="Community">
            <span class="icon" aria-hidden="true">👥</span>
            <span class="label">Community</span>
        </a>
        <a href="/resources/" class="toolbar-item active" aria-label="Resources" aria-current="page">
            <span class="icon" aria-hidden="true">📚</span>
            <span class="label">Resources</span>
        </a>
        <button class="toolbar-item" onclick="toggleMoreMenu()" aria-label="More options" aria-expanded="false" aria-controls="moreMenu">
            <span class="icon" aria-hidden="true">⋯</span>
            <span class="label">More</span>
        </button>
    </nav>

    <!-- More Menu -->
    <div id="moreMenu" class="more-menu" role="menu" aria-label="Additional options">
        <button class="more-menu-item" role="menuitem" onclick="toggleDarkMode(); toggleMoreMenu();">
            <span class="menu-icon" id="themeMenuIcon" aria-hidden="true">🌙</span>
            <span id="themeMenuText">Dark Mode</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="lockScreen(); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">🔒</span>
            <span>Lock Screen</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="toggleFullscreen(); toggleMoreMenu();" id="fullscreenBtn">
            <span class="menu-icon" aria-hidden="true" id="fullscreenIcon">⛶</span>
            <span id="fullscreenText">Full Screen</span>
        </button>
        <a href="/labsched/" class="more-menu-item" role="menuitem" aria-label="Lab Schedule Generator" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">📅</span>
            <span>Sched Generator</span>
        </a>
        <a href="/apa/" class="more-menu-item" role="menuitem" aria-label="APA Paper Generator" id="apaMenuLink" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">📄</span>
            <span>APA Generator</span>
        </a>
        <a href="/clinical/" class="more-menu-item" role="menuitem" aria-label="Clinical Packet Builder" id="clinicalMenuLink" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">📋</span>
            <span>Clinical Packet</span>
        </a>
        <button class="more-menu-item" role="menuitem" onclick="document.getElementById('feedbackModal').classList.remove('hidden'); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">💡</span>
            <span>Feedback</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="logout();">
            <span class="menu-icon" aria-hidden="true">🚪</span>
            <span>Logout</span>
        </button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 20px;">💡 Send Feedback</h2>
                <button onclick="document.getElementById('feedbackModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
            </div>
            <form action="https://formsubmit.co/christiankholden@gmail.com" method="POST">
                <input type="hidden" name="_subject" value="BSN9B Feedback">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_template" value="table">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Type</label>
                <select name="type" required>
                    <option value="bug">🐛 Bug Report</option>
                    <option value="feature">✨ Feature Request</option>
                    <option value="feedback" selected>📝 General Feedback</option>
                </select>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Your Name</label>
                <input type="text" name="name" required placeholder="Enter your name">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Message</label>
                <textarea name="message" required placeholder="Describe your feedback..."></textarea>
                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Send Feedback</button>
            </form>
        </div>
    </div>


    <footer>
        BSN9B Nursing Resources
    </footer>

    <script>
        // Display current user
        const currentUsername = localStorage.getItem('bsn9b_user');
        if (currentUsername) {
            document.getElementById('userDisplay').textContent = 'Logged in as: ' + currentUsername;
        }

        // Logout function
        function logout() {
            endSessionTracking('logout');
            cleanupFirebaseListeners();
            // Clean presence before signing out
            if (typeof presenceRef !== 'undefined' && typeof getCurrentUserUid === 'function') {
                const uid = getCurrentUserUid();
                if (uid) {
                    presenceRef.child(uid).remove().catch(() => {});
                }
            }
            // Clear idle/logout/warning timers (if initialized)
            if (typeof idleTimer !== 'undefined') clearTimeout(idleTimer);
            if (typeof logoutTimer !== 'undefined') clearTimeout(logoutTimer);
            if (typeof logoutWarningTimer !== 'undefined') clearTimeout(logoutWarningTimer);
            if (typeof activityDebounceTimer !== 'undefined') clearTimeout(activityDebounceTimer);

            localStorage.removeItem('bsn9b_auth');
            localStorage.removeItem('bsn9b_user');
            localStorage.removeItem('bsn9b_displayName');
            localStorage.removeItem('bsn9b_uid');
            clearSessionTracking();
            window.location.href = '/';
        }

        // Theme functions
        
        // Educational banner dismiss
        function dismissEduBanner() {
            document.getElementById('eduBanner').classList.add('hidden');
            localStorage.setItem('bsn9b_edu_banner_dismissed', 'true');
        }
        (function() {
            if (localStorage.getItem('bsn9b_edu_banner_dismissed') === 'true') {
                var b = document.getElementById('eduBanner');
                if (b) b.classList.add('hidden');
            }
        })();

        function initTheme() {
            const saved = localStorage.getItem('bsn9b_theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcon();
        }
        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('bsn9b_theme', newTheme);
            updateThemeIcon();
        }
        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const themeMenuIcon = document.getElementById('themeMenuIcon');
            const themeMenuText = document.getElementById('themeMenuText');
            if (themeMenuIcon) {
                themeMenuIcon.textContent = isDark ? '☀️' : '🌙';
            }
            if (themeMenuText) {
                themeMenuText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            }
        }

        // More menu toggle
        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const isExpanded = menu.classList.toggle('show');
            if (moreBtn) {
                moreBtn.setAttribute('aria-expanded', isExpanded);
            }
        }

        // Close more menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const moreBtnClicked = e.target.closest('.toolbar-item');
            if (!menu.contains(e.target) && (!moreBtnClicked || !moreBtnClicked.onclick?.toString().includes('toggleMoreMenu'))) {
                menu.classList.remove('show');
                if (moreBtn) {
                    moreBtn.setAttribute('aria-expanded', 'false');
                }
            }
        });

        initTheme();

        // Lock functions
        function lockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'flex';
        }
        function unlockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'none';
        }

        // Drug lookup state
        let drugSearchTimeout = null;

        // Smart Drug Search - combines spelling suggestions + approximate matching
        async function smartDrugSearch(query, dropdownId, onSelect) {
            const dropdown = document.getElementById(dropdownId);

            if (query.length < 2) {
                dropdown.classList.remove('show');
                return;
            }

            dropdown.innerHTML = '<div class="drug-autocomplete-loading">Searching...</div>';
            dropdown.classList.add('show');

            try {
                // Use multiple search strategies for better results
                const results = new Map(); // Use Map to deduplicate by rxcui

                // 1. Spelling suggestions (helps with typos like "metforman" -> "metformin")
                const spellResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/spellingsuggestions.json?name=${encodeURIComponent(query)}`);
                const spellData = await spellResponse.json();

                if (spellData.suggestionGroup?.suggestionList?.suggestion) {
                    // Get RxCUI for each spelling suggestion
                    for (const suggestion of spellData.suggestionGroup.suggestionList.suggestion.slice(0, 5)) {
                        const rxcuiResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/rxcui.json?name=${encodeURIComponent(suggestion)}`);
                        const rxcuiData = await rxcuiResponse.json();
                        if (rxcuiData.idGroup?.rxnormId?.[0]) {
                            results.set(rxcuiData.idGroup.rxnormId[0], {
                                rxcui: rxcuiData.idGroup.rxnormId[0],
                                name: suggestion,
                                type: 'exact'
                            });
                        }
                    }
                }

                // 2. Approximate term matching (fuzzy search)
                const approxResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/approximateTerm.json?term=${encodeURIComponent(query)}&maxEntries=15`);
                const approxData = await approxResponse.json();

                if (approxData.approximateGroup?.candidate) {
                    approxData.approximateGroup.candidate.forEach(c => {
                        if (c.rxcui && c.name && !results.has(c.rxcui)) {
                            results.set(c.rxcui, {
                                rxcui: c.rxcui,
                                name: c.name,
                                type: c.rank > 50 ? 'close' : 'approx'
                            });
                        }
                    });
                }

                // 3. Direct drug search as fallback
                const drugResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/drugs.json?name=${encodeURIComponent(query)}`);
                const drugData = await drugResponse.json();

                if (drugData.drugGroup?.conceptGroup) {
                    drugData.drugGroup.conceptGroup.forEach(group => {
                        if (group.conceptProperties) {
                            group.conceptProperties.slice(0, 10).forEach(prop => {
                                if (!results.has(prop.rxcui)) {
                                    results.set(prop.rxcui, {
                                        rxcui: prop.rxcui,
                                        name: prop.name,
                                        type: 'brand'
                                    });
                                }
                            });
                        }
                    });
                }

                // Build dropdown HTML
                const resultArray = Array.from(results.values()).slice(0, 12);

                if (resultArray.length === 0) {
                    dropdown.innerHTML = '<div class="drug-autocomplete-loading">No matches found. Try different spelling.</div>';
                } else {
                    let html = '';
                    if (query.length >= 2 && spellData.suggestionGroup?.suggestionList?.suggestion?.[0] !== query) {
                        const topSuggestion = spellData.suggestionGroup?.suggestionList?.suggestion?.[0];
                        if (topSuggestion && topSuggestion.toLowerCase() !== query.toLowerCase()) {
                            html += `<div class="drug-autocomplete-hint">Did you mean: <strong>${topSuggestion}</strong>?</div>`;
                        }
                    }
                    resultArray.forEach(drug => {
                        const escapedName = drug.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        html += `<div class="drug-autocomplete-item" onclick="${onSelect}('${drug.rxcui}', '${escapedName}')">${drug.name}</div>`;
                    });
                    dropdown.innerHTML = html;
                }
            } catch (error) {
                console.error('Drug search error:', error);
                dropdown.innerHTML = '<div class="drug-autocomplete-loading">Search error. Try again.</div>';
            }
        }

        // Drug Information search input handler
        const drugSearchInput = document.getElementById('drugSearch');
        if (drugSearchInput) {
            drugSearchInput.addEventListener('input', function() {
                clearTimeout(drugSearchTimeout);
                const query = this.value.trim();
                const dropdown = document.getElementById('drugSearchDropdown');

                if (query.length < 2) {
                    if (dropdown) dropdown.classList.remove('show');
                    return;
                }

                drugSearchTimeout = setTimeout(() => {
                    smartDrugSearch(query, 'drugSearchDropdown', 'selectDrugInfo');
                }, 300);
            });
        } else {
            console.warn('Drug search input not found');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.drug-search-wrapper')) {
                const dropdown = document.getElementById('drugSearchDropdown');
                if (dropdown) dropdown.classList.remove('show');
            }
        });

        // Select drug for information display
        async function selectDrugInfo(rxcui, name) {
            const dropdown = document.getElementById('drugSearchDropdown');
            const searchInput = document.getElementById('drugSearch');
            const infoDiv = document.getElementById('drugInfo');
            const nameEl = document.getElementById('drugInfoName');
            const detailsEl = document.getElementById('drugInfoDetails');
            const dailyMedLink = document.getElementById('drugLinkDailyMed');
            const drugsLink = document.getElementById('drugLinkDrugs');

            if (dropdown) dropdown.classList.remove('show');
            if (searchInput) searchInput.value = name;

            if (!infoDiv || !nameEl || !detailsEl) {
                console.error('Drug info elements not found');
                return;
            }

            nameEl.textContent = name;
            detailsEl.innerHTML = '<p>Loading details...</p>';
            infoDiv.style.display = 'block';

            // Set external links
            if (dailyMedLink) dailyMedLink.href = `https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(name)}`;
            if (drugsLink) drugsLink.href = `https://www.drugs.com/search.php?searchterm=${encodeURIComponent(name)}`;

            try {
                // Get drug class info
                const classResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/rxclass/class/byRxcui.json?rxcui=${rxcui}`);
                const classData = await classResponse.json();

                let details = '';

                if (classData.rxclassDrugInfoList && classData.rxclassDrugInfoList.rxclassDrugInfo) {
                    const classes = classData.rxclassDrugInfoList.rxclassDrugInfo;
                    const uniqueClasses = [...new Set(classes.map(c => c.rxclassMinConceptItem.className))].slice(0, 5);
                    if (uniqueClasses.length > 0) {
                        details += `<p><strong>Drug Class:</strong> ${uniqueClasses.join(', ')}</p>`;
                    }
                }

                // Get related drugs (brand names)
                const relatedResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/rxcui/${rxcui}/related.json?tty=BN`);
                const relatedData = await relatedResponse.json();

                if (relatedData.relatedGroup && relatedData.relatedGroup.conceptGroup) {
                    const brands = relatedData.relatedGroup.conceptGroup
                        .filter(g => g.conceptProperties)
                        .flatMap(g => g.conceptProperties.map(p => p.name))
                        .slice(0, 5);
                    if (brands.length > 0) {
                        details += `<p><strong>Brand Names:</strong> ${brands.join(', ')}</p>`;
                    }
                }

                details += `<p><strong>RxCUI:</strong> ${rxcui}</p>`;
                document.getElementById('drugInfoDetails').innerHTML = details || '<p>Basic info only. Click links below for full details.</p>';

            } catch (error) {
                document.getElementById('drugInfoDetails').innerHTML = '<p>Could not load details. Use links below.</p>';
            }
        }

        function calculateDripRate() {
            const volume = parseFloat(document.getElementById('ivVolume').value);
            const time = parseFloat(document.getElementById('ivTime').value);
            const dropFactor = parseFloat(document.getElementById('ivDropFactor').value);
            const result = document.getElementById('dripResult');

            if (!volume || !time || !dropFactor) {
                result.innerHTML = '<span style="color: #c00;">Please enter all values</span>';
                result.style.display = 'block';
                return;
            }

            if (time <= 0) {
                result.innerHTML = '<span style="color: #c00;">Time must be greater than 0</span>';
                result.style.display = 'block';
                return;
            }

            // IV Drip Rate Formula: gtt/min = (Volume mL × Drop Factor) ÷ (Time in min)
            const mlPerHour = volume / time;
            const gttsPerMin = (volume * dropFactor) / (time * 60);

            result.innerHTML = `
                <strong>Flow Rate:</strong> ${mlPerHour.toFixed(1)} mL/hr<br>
                <strong>Drip Rate:</strong> ${Math.round(gttsPerMin)} gtt/min<br>
                <span style="font-size: 11px; color: #666;">Formula: (${volume} mL × ${dropFactor} gtt/mL) ÷ (${time} hr × 60 min)</span>
            `;
            result.style.display = 'block';
        }

        function calculateDosage() {
            const desired = parseFloat(document.getElementById('desiredDose').value);
            const have = parseFloat(document.getElementById('haveOnHand').value);
            const qty = parseFloat(document.getElementById('quantity').value);
            const unit = document.getElementById('quantityUnit').value;
            const result = document.getElementById('dosageResult');

            if (!desired || !have || !qty) {
                result.innerHTML = '<span style="color: #c00;">Please enter all values</span>';
                result.style.display = 'block';
                return;
            }

            if (have <= 0) {
                result.innerHTML = '<span style="color: #c00;">"Have on Hand" must be greater than 0</span>';
                result.style.display = 'block';
                return;
            }

            // D/H × Q Formula
            const give = (desired / have) * qty;

            result.innerHTML = `
                <strong>Administer:</strong> ${give.toFixed(2)} ${unit}(s)<br>
                <span style="font-size: 11px; color: #666;">Formula: (${desired} mg ÷ ${have} mg) × ${qty} ${unit}</span>
            `;
            result.style.display = 'block';
        }

        function calculateWeightDose() {
            const mgPerKg = parseFloat(document.getElementById('mgPerKg').value);
            let weight = parseFloat(document.getElementById('patientWeight').value);
            const weightUnit = document.getElementById('weightUnit').value;
            const result = document.getElementById('weightDoseResult');

            if (!mgPerKg || !weight) {
                result.innerHTML = '<span style="color: #c00;">Please enter all values</span>';
                result.style.display = 'block';
                return;
            }

            // Convert lbs to kg if needed (1 lb = 0.453592 kg)
            let weightInKg = weight;
            if (weightUnit === 'lb') {
                weightInKg = weight * 0.453592;
            }

            const totalDose = mgPerKg * weightInKg;

            result.innerHTML = `
                <strong>Total Dose:</strong> ${totalDose.toFixed(1)} mg<br>
                ${weightUnit === 'lb' ? `<span style="font-size: 11px; color: #666;">Patient weight: ${weightInKg.toFixed(1)} kg (${weight} lb)</span><br>` : ''}
                <span style="font-size: 11px; color: #666;">Formula: ${mgPerKg} mg/kg × ${weightInKg.toFixed(1)} kg</span>
            `;
            result.style.display = 'block';
        }

        function toggleCollapse(element) {
            element.classList.toggle('collapsed');
            const content = element.nextElementSibling;
            content.classList.toggle('hidden');
        }

        // Toggle collapsible resource cards
        function toggleResourceCard(header) {
            const card = header.closest('.collapsible');
            if (!card) return;
            card.classList.toggle('expanded');
            card.classList.toggle('collapsed');
        }

        // Open cited sources modal
        function openCitedSources() {
            document.getElementById('citedSourcesModal').classList.remove('hidden');
        }

        // Close cited sources modal
        function closeCitedSources() {
            document.getElementById('citedSourcesModal').classList.add('hidden');
        }

        let activeResourceFilter = 'all';

        function updateResourceCount(visible, total) {
            const countEl = document.getElementById('resourceCount');
            if (!countEl) return;
            countEl.textContent = `Showing ${visible} of ${total} resources`;
        }

        function filterResources() {
            const query = (document.getElementById('resourceSearch') || {}).value || '';
            const q = query.trim().toLowerCase();
            const cards = Array.from(document.querySelectorAll('.resource-card'));
            let visible = 0;
            cards.forEach(card => {
                const tags = (card.dataset.tags || '').toLowerCase();
                const text = card.textContent.toLowerCase();
                const matchesTag = activeResourceFilter === 'all' || tags.includes(activeResourceFilter);
                const matchesQuery = !q || tags.includes(q) || text.includes(q);
                const show = matchesTag && matchesQuery;
                card.classList.toggle('hidden', !show);
                if (show) visible += 1;
            });
            updateResourceCount(visible, cards.length);
        }

        function setResourceFilter(tag, button) {
            activeResourceFilter = tag;
            document.querySelectorAll('.resource-chip').forEach(chip => chip.classList.remove('active'));
            if (button) button.classList.add('active');
            filterResources();
        }

        function clearResourceSearch() {
            const input = document.getElementById('resourceSearch');
            if (input) input.value = '';
            filterResources();
        }

        const SHIFT_PLAN_KEY = 'bsn9b_shift_plan';

        function saveShiftPlan() {
            try {
                const payload = {
                    priority: document.getElementById('shiftPriority')?.value || '',
                    followup: document.getElementById('shiftFollowup')?.value || '',
                    savedAt: Date.now()
                };
                localStorage.setItem(SHIFT_PLAN_KEY, JSON.stringify(payload));
                showToast('Shift plan saved.', 'success');
            } catch (e) {
                console.warn('Shift plan save failed:', e);
                showToast('Unable to save plan.', 'error');
            }
        }

        function loadShiftPlan() {
            try {
                const raw = localStorage.getItem(SHIFT_PLAN_KEY);
                if (!raw) return;
                const payload = JSON.parse(raw);
                if (!payload) return;
                if (document.getElementById('shiftPriority')) document.getElementById('shiftPriority').value = payload.priority || '';
                if (document.getElementById('shiftFollowup')) document.getElementById('shiftFollowup').value = payload.followup || '';
            } catch (e) {
                console.warn('Shift plan load failed:', e);
            }
        }

        function clearShiftPlan() {
            if (document.getElementById('shiftPriority')) document.getElementById('shiftPriority').value = '';
            if (document.getElementById('shiftFollowup')) document.getElementById('shiftFollowup').value = '';
            try { localStorage.removeItem(SHIFT_PLAN_KEY); } catch (e) {}
            showToast('Shift plan cleared.', 'info');
        }

        async function copyShiftPlan() {
            const priority = document.getElementById('shiftPriority')?.value || '';
            const followup = document.getElementById('shiftFollowup')?.value || '';
            const text = `Shift Plan\n\nPriorities:\n${priority || '-'}\n\nFollow-ups:\n${followup || '-'}`;
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                }
                showToast('Shift plan copied.', 'success');
            } catch (e) {
                showToast('Copy failed.', 'error');
            }
        }

        function clearChecklist(checklistId) {
            const checklist = document.getElementById(checklistId);
            if (checklist) {
                checklist.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
                showToast('Checklist reset', 'info');
            }
        }

        // ========== MED PASS TIMER ==========
        let activeTimers = [];
        let timerIdCounter = 0;

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('Notifications enabled!', 'success');
                    } else {
                        showToast('Notifications blocked. Enable in browser settings.', 'warning');
                    }
                });
            } else {
                showToast('Browser does not support notifications', 'error');
            }
        }

        function setMedTimer(minutes) {
            if (!minutes || minutes < 1 || minutes > 480) {
                showToast('Please enter a valid time (1-480 minutes)', 'warning');
                return;
            }

            const label = document.getElementById('timerLabel').value.trim() || 'Med Timer';
            const timerId = ++timerIdCounter;
            const endTime = Date.now() + (minutes * 60 * 1000);

            const timer = {
                id: timerId,
                label: label,
                endTime: endTime,
                interval: null
            };

            timer.interval = setInterval(() => updateTimer(timerId), 1000);
            activeTimers.push(timer);

            document.getElementById('timerLabel').value = '';
            document.getElementById('customTimerMin').value = '';

            renderTimers();
            showToast(`Timer set for ${minutes} minute${minutes > 1 ? 's' : ''}`, 'success');
        }

        function updateTimer(timerId) {
            const timer = activeTimers.find(t => t.id === timerId);
            if (!timer) return;

            const remaining = timer.endTime - Date.now();

            if (remaining <= 0) {
                // Timer complete
                clearInterval(timer.interval);
                activeTimers = activeTimers.filter(t => t.id !== timerId);
                renderTimers();

                // Show notification
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Med Timer Complete', {
                        body: timer.label,
                        icon: '/icons/icon-192.png',
                        tag: 'med-timer-' + timerId,
                        requireInteraction: true
                    });
                }

                // Play sound and show toast
                playTimerSound();
                showToast(`Timer complete: ${timer.label}`, 'success', 10000);
            } else {
                renderTimers();
            }
        }

        function cancelTimer(timerId) {
            const timer = activeTimers.find(t => t.id === timerId);
            if (timer) {
                clearInterval(timer.interval);
                activeTimers = activeTimers.filter(t => t.id !== timerId);
                renderTimers();
                showToast('Timer cancelled', 'info');
            }
        }

        function renderTimers() {
            const container = document.getElementById('activeTimers');
            if (!container) return;

            if (activeTimers.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = activeTimers.map(timer => {
                const remaining = Math.max(0, timer.endTime - Date.now());
                const mins = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                return `
                    <div class="active-timer">
                        <div class="timer-info">
                            <div class="timer-label">${escapeHtml(timer.label)}</div>
                            <div class="timer-countdown">${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}</div>
                        </div>
                        <button class="timer-cancel" onclick="cancelTimer(${timer.id})">Cancel</button>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function playTimerSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                oscillator.start();
                setTimeout(() => { oscillator.stop(); }, 200);
                setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    osc2.connect(gainNode);
                    osc2.frequency.value = 1000;
                    osc2.type = 'sine';
                    osc2.start();
                    setTimeout(() => osc2.stop(), 200);
                }, 300);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // APGAR Calculator
        function calculateAPGAR() {
            const appearance = parseInt(document.getElementById('apgar-appearance').value) || 0;
            const pulse = parseInt(document.getElementById('apgar-pulse').value) || 0;
            const grimace = parseInt(document.getElementById('apgar-grimace').value) || 0;
            const activity = parseInt(document.getElementById('apgar-activity').value) || 0;
            const respiration = parseInt(document.getElementById('apgar-respiration').value) || 0;

            const score = appearance + pulse + grimace + activity + respiration;
            document.getElementById('apgar-score').textContent = score;

            let interpretation = '';
            if (score >= 7) {
                interpretation = '(Normal - reassuring)';
            } else if (score >= 4) {
                interpretation = '(Moderately abnormal - needs intervention)';
            } else {
                interpretation = '(Critically low - immediate resuscitation)';
            }
            document.getElementById('apgar-interpretation').textContent = interpretation;
        }

        // ========== SBAR HANDOFF GENERATOR ==========
        function generateSBARHandoff() {
            const patient = document.getElementById('sbar-patient').value.trim();
            const reason = document.getElementById('sbar-reason').value.trim();
            const diagnosis = document.getElementById('sbar-diagnosis').value.trim();
            const history = document.getElementById('sbar-history').value.trim();
            const meds = document.getElementById('sbar-meds').value.trim();
            const vitals = document.getElementById('sbar-vitals').value.trim();
            const neuro = document.getElementById('sbar-neuro').value.trim();
            const io = document.getElementById('sbar-io').value.trim();
            const concerns = document.getElementById('sbar-concerns').value.trim();
            const pending = document.getElementById('sbar-pending').value.trim();
            const followup = document.getElementById('sbar-followup').value.trim();
            const priority = document.getElementById('sbar-priority').value.trim();

            if (!patient) {
                showToast('Please enter patient name and room', 'warning');
                return;
            }

            let output = `SBAR SHIFT HANDOFF REPORT
${'='.repeat(40)}

S - SITUATION
Patient: ${patient || 'N/A'}
Reason: ${reason || 'End of shift handoff'}

B - BACKGROUND
Diagnosis: ${diagnosis || 'N/A'}
Relevant History: ${history || 'N/A'}
Key Medications/IVs: ${meds || 'N/A'}

A - ASSESSMENT
Vitals: ${vitals || 'N/A'}
Neuro/LOC: ${neuro || 'N/A'}
I&O: ${io || 'N/A'}
Current Concerns: ${concerns || 'None noted'}

R - RECOMMENDATION
Pending Tests/Procedures: ${pending || 'None'}
Follow-up Actions: ${followup || 'Continue current plan of care'}
Priority for Next Shift: ${priority || 'Monitor as per orders'}

${'='.repeat(40)}
Generated: ${new Date().toLocaleString()}`;

            document.getElementById('sbar-text').textContent = output;
            document.getElementById('sbar-output').style.display = 'block';
            showToast('SBAR handoff generated!', 'success');
        }

        function clearSBARForm() {
            const inputs = document.querySelectorAll('#sbarForm input');
            inputs.forEach(input => input.value = '');
            document.getElementById('sbar-output').style.display = 'none';
            showToast('Form cleared', 'info');
        }

        function copySBARHandoff() {
            const text = document.getElementById('sbar-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Copied to clipboard!', 'success');
            });
        }
    </script>

    <!-- Chat and AI floating widgets removed - now at /chat/ and /ai/ -->

    <script>
        // ========== FULLSCREEN MODE ==========
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                const elem = document.documentElement;
                if (elem.requestFullscreen) elem.requestFullscreen();
                else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                updateFullscreenUI(true);
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                updateFullscreenUI(false);
            }
        }
        function updateFullscreenUI(isFullscreen) {
            const text = document.getElementById('fullscreenText');
            if (text) text.textContent = isFullscreen ? 'Exit Full Screen' : 'Full Screen';
        }
        document.addEventListener('fullscreenchange', () => updateFullscreenUI(!!document.fullscreenElement));
        document.addEventListener('webkitfullscreenchange', () => updateFullscreenUI(!!document.webkitFullscreenElement));

        // ========== TOAST NOTIFICATION SYSTEM ==========
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const icons = { success: '✓', error: '✕', warning: '⚠', info: 'ℹ' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content"><div class="toast-message">${message.replace(/\n/g, '<br>')}</div></div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, duration);
        }

        const firebaseConfig = {
            apiKey: "AIzaSyAmr2W8mekSPJ2pXM3gz1FvarfSBddpfLM",
            authDomain: "bendbsn-17377.firebaseapp.com",
            databaseURL: "https://bendbsn-17377-default-rtdb.firebaseio.com",
            projectId: "bendbsn-17377",
            storageBucket: "bendbsn-17377.firebasestorage.app",
            messagingSenderId: "762882187702",
            appId: "1:762882187702:web:81c97c9eae005666796117"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const SESSION_KEY = 'bsn9b_session_key';
        const SESSION_START_KEY = 'bsn9b_session_start';
        const SESSION_HEARTBEAT_MS = 60000;
        let sessionHeartbeatTimer = null;
        let sessionValidated = false;

        // Presence/Activity timeout constants
        const IDLE_TIMEOUT = 10 * 60 * 1000;   // 10 minutes → Away
        const LOGOUT_TIMEOUT = 30 * 60 * 1000; // 30 minutes → Logout
        const LOGOUT_WARNING_TIMEOUT = 25 * 60 * 1000; // 25 minutes → Show warning
        const ACTIVITY_DEBOUNCE = 30000;       // Debounce Firebase updates
        let idleTimer = null;
        let logoutTimer = null;
        let logoutWarningTimer = null;
        let activityDebounceTimer = null;
        let lastActivityTime = Date.now();
        let currentPresenceStatus = 'online';
        let myPresenceRef = null;

        function updateSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey || !sessionValidated) return;
            database.ref('loginHistory/' + sessionKey).update({
                lastSeen: Date.now()
            }).catch(() => {});
        }

        function startSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey) return;
            database.ref('loginHistory/' + sessionKey).once('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val().timestamp) {
                    sessionValidated = true;
                    updateSessionHeartbeat();
                    if (sessionHeartbeatTimer) clearInterval(sessionHeartbeatTimer);
                    sessionHeartbeatTimer = setInterval(updateSessionHeartbeat, SESSION_HEARTBEAT_MS);
                } else {
                    clearSessionTracking();
                }
            }).catch(() => {});
        }

        function endSessionTracking(reason) {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey || !sessionValidated) return;
            if (localStorage.getItem('bsn9b_session_end_sent') === 'true') return;
            const start = parseInt(localStorage.getItem(SESSION_START_KEY) || '0', 10);
            const end = Date.now();
            const durationSeconds = start ? Math.max(0, Math.round((end - start) / 1000)) : null;
            const durationMinutes = durationSeconds !== null ? Math.round(durationSeconds / 60) : null;
            localStorage.setItem('bsn9b_session_end_sent', 'true');
            database.ref('loginHistory/' + sessionKey).update({
                sessionEnd: end,
                durationSeconds: durationSeconds,
                durationMinutes: durationMinutes,
                endReason: reason || 'logout'
            }).catch(() => {});
        }

        function clearSessionTracking() {
            localStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(SESSION_START_KEY);
            localStorage.removeItem('bsn9b_session_end_sent');
        }

        // ========== FIREBASE REFS & ESSENTIAL SERVICES ==========
        // (Chat/AI widgets removed - now at /chat/ and /ai/)
        const presenceRef = database.ref('chat/presence');
        const bannedRef = database.ref('banned');
        const announcementsRef = database.ref('announcements');
        const userProfilesRef = database.ref('userProfiles');

        // Listen for announcements (alert/fyi banners)
        // Hash function for banner messages
        function hashBannerMessage(message) {
            let hash = 0;
            for (let i = 0; i < message.length; i++) {
                const char = message.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Dismiss banner function
        function dismissBanner(type) {
            const banner = document.getElementById(type === 'alert' ? 'alertBanner' : 'fyiBanner');
            const text = document.getElementById(type === 'alert' ? 'alertText' : 'fyiText');
            const message = text.textContent;
            const messageHash = hashBannerMessage(message);

            // Save dismissal to localStorage
            localStorage.setItem(`bsn9b_${type}_dismissed_${messageHash}`, 'true');

            // Hide banner
            banner.style.display = 'none';
            document.body.classList.remove(`has-${type}`);
        }

        function setupAnnouncementListener() {
            announcementsRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                const alertBanner = document.getElementById('alertBanner');
                const fyiBanner = document.getElementById('fyiBanner');
                const alertText = document.getElementById('alertText');
                const fyiText = document.getElementById('fyiText');

                // Handle alert banner
                if (data.alert && data.alert.message) {
                    const messageHash = hashBannerMessage(data.alert.message);
                    const isDismissed = localStorage.getItem(`bsn9b_alert_dismissed_${messageHash}`) === 'true';

                    if (!isDismissed) {
                        alertText.textContent = data.alert.message;
                        alertBanner.style.display = 'block';
                        document.body.classList.add('has-alert');
                    } else {
                        alertBanner.style.display = 'none';
                        document.body.classList.remove('has-alert');
                    }
                } else {
                    alertBanner.style.display = 'none';
                    document.body.classList.remove('has-alert');
                }

                // Handle FYI banner (offset if alert is showing)
                if (data.fyi && data.fyi.message) {
                    const messageHash = hashBannerMessage(data.fyi.message);
                    const isDismissed = localStorage.getItem(`bsn9b_fyi_dismissed_${messageHash}`) === 'true';

                    if (!isDismissed) {
                        fyiText.textContent = data.fyi.message;
                        fyiBanner.style.display = 'block';
                        fyiBanner.style.top = (data.alert && data.alert.message && alertBanner.style.display === 'block') ? '44px' : '0';
                        document.body.classList.add('has-fyi');
                    } else {
                        fyiBanner.style.display = 'none';
                        document.body.classList.remove('has-fyi');
                    }
                } else {
                    fyiBanner.style.display = 'none';
                    document.body.classList.remove('has-fyi');
                }
            });
        }
        setupAnnouncementListener();

        // User identity
        let chatCurrentUsername = localStorage.getItem('bsn9b_user') || 'Anonymous';
        let chatDisplayName = localStorage.getItem('bsn9b_displayName') || chatCurrentUsername;
        let chatCurrentUserUid = localStorage.getItem('bsn9b_uid') || '';

        function getCurrentUserEmail() {
            return chatCurrentUsername || auth.currentUser?.email || localStorage.getItem('bsn9b_user') || '';
        }

        function getCurrentUserUid() {
            return chatCurrentUserUid || auth.currentUser?.uid || localStorage.getItem('bsn9b_uid') || '';
        }

        function syncUserProfile(user) {
            if (!user) return;
            const email = user.email || getCurrentUserEmail();
            const name = chatDisplayName || user.displayName || (email ? email.split('@')[0] : 'User');
            const firstName = name.split(' ')[0] || name;
            userProfilesRef.child(user.uid).update({
                email: email,
                displayName: name,
                firstName: firstName,
                updatedAt: Date.now()
            });
        }

        // Firebase Auth state and ban checking
        let firebaseAuthReady = false;
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Firebase Auth: Logged in as', user.email);
                firebaseAuthReady = true;
                chatCurrentUserUid = user.uid;
                chatCurrentUsername = user.email || chatCurrentUsername;
                if (user.displayName) {
                    chatDisplayName = user.displayName;
                }
                localStorage.setItem('bsn9b_uid', chatCurrentUserUid);
                localStorage.setItem('bsn9b_user', chatCurrentUsername);
                localStorage.setItem('bsn9b_displayName', chatDisplayName);
                syncUserProfile(user);

                // Check user role and hide APA link for instructors
                userProfilesRef.child(user.uid).once('value').then((snap) => {
                    const profile = snap.val();
                    if (profile && profile.role === 'Instructor') {
                        const apaLink = document.getElementById('apaMenuLink');
                        if (apaLink) apaLink.style.display = 'none';
                    }
                });
            } else {
                console.log('Firebase Auth: Not logged in, attempting silent re-auth...');
                if (localStorage.getItem('bsn9b_auth') === 'true') {
                    console.warn('Session exists but Firebase auth lost - may need to re-login');
                }
            }
        });

        // Check if current user is banned
        function checkIfBanned() {
            bannedRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const banned = child.val();
                    if (banned.username === chatCurrentUsername || banned.username === chatDisplayName) {
                        showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                        localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                        setTimeout(() => { window.location.href = '/'; }, 2000);
                    }
                });
            });
        }
        checkIfBanned();

        // Listen for bans in real-time
        bannedRef.on('child_added', (snapshot) => {
            const banned = snapshot.val();
            if (banned.username === chatCurrentUsername || banned.username === chatDisplayName) {
                showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                setTimeout(() => { window.location.href = '/'; }, 2000);
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadShiftPlan();
            filterResources();
            startSessionHeartbeat();
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') updateSessionHeartbeat();
            });
        });

        // ========== PRESENCE SYSTEM ==========
        // Set presence using UID as key (prevents duplicates across tabs)
        function setPresence(status = 'online') {
            const uid = getCurrentUserUid();
            if (!uid) return;

            myPresenceRef = presenceRef.child(uid);
            myPresenceRef.set({
                user: chatDisplayName,
                username: chatCurrentUsername,
                uid: uid,
                status: status,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
            myPresenceRef.onDisconnect().remove();
            currentPresenceStatus = status;
        }

        // Update status without full rewrite
        function updatePresenceStatus(status) {
            const uid = getCurrentUserUid();
            if (!uid) return;
            presenceRef.child(uid).update({
                status: status,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            }).catch(() => {});
            currentPresenceStatus = status;
        }

        // Activity detection - reset idle timers (debounced)
        function recordActivity() {
            lastActivityTime = Date.now();

            // Reset idle/logout/warning timers immediately (local)
            clearTimeout(idleTimer);
            clearTimeout(logoutTimer);
            clearTimeout(logoutWarningTimer);

            // Set idle timer (10 min)
            idleTimer = setTimeout(() => {
                updatePresenceStatus('away');

                // Set logout timer (additional 20 min = 30 min total)
                logoutTimer = setTimeout(() => {
                    logout(); // Full logout
                }, LOGOUT_TIMEOUT - IDLE_TIMEOUT);
            }, IDLE_TIMEOUT);

            // Set warning timer (25 min = 5 min before logout)
            logoutWarningTimer = setTimeout(() => {
                showToast('You will be logged out in 5 minutes due to inactivity. Move your mouse or press a key to stay logged in.', 'warning', 10000);
            }, LOGOUT_WARNING_TIMEOUT);

            // Debounce Firebase updates (don't spam on every mouse move)
            if (activityDebounceTimer) return;

            // If was away, go back online immediately
            if (currentPresenceStatus === 'away') {
                updatePresenceStatus('online');
            }

            activityDebounceTimer = setTimeout(() => {
                activityDebounceTimer = null;
                // Update lastActive timestamp periodically while active
                const uid = getCurrentUserUid();
                if (currentPresenceStatus === 'online' && uid) {
                    presenceRef.child(uid).update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    }).catch(() => {});
                }
            }, ACTIVITY_DEBOUNCE);
        }

        // Initialize activity listeners
        function initActivityTracking() {
            const events = ['mousedown', 'keydown', 'scroll', 'touchstart', 'mousemove'];
            events.forEach(event => {
                document.addEventListener(event, recordActivity, { passive: true });
            });

            // Also track visibility
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    recordActivity();
                }
            });

            // Start initial timer
            recordActivity();
        }

        // Initialize presence (called after auth check)
        setPresence('online');
        initActivityTracking();

        // Monitor Firebase connection state
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            const connected = snap.val() === true;
            if (connected) {
                // Re-establish presence on reconnect (handles multi-tab onDisconnect conflicts)
                if (chatCurrentUsername) setPresence(currentPresenceStatus || 'online');
            }
        });

        // ========== FIREBASE LISTENER CLEANUP ==========
        function cleanupFirebaseListeners() {
            try {
                if (typeof announcementsRef !== 'undefined') announcementsRef.off();
                if (typeof bannedRef !== 'undefined') bannedRef.off();
                if (typeof connectedRef !== 'undefined') connectedRef.off();
                if (typeof presenceRef !== 'undefined') presenceRef.off();
                console.log('Firebase listeners cleaned up');
            } catch (e) {
                console.log('Error cleaning up listeners:', e);
            }
        }

        window.addEventListener('beforeunload', cleanupFirebaseListeners);
        window.addEventListener('pagehide', cleanupFirebaseListeners);

        // ========== KEYBOARD NAVIGATION ==========
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close more menu
                const moreMenu = document.getElementById('moreMenu');
                if (moreMenu) moreMenu.classList.remove('show');
            }
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);

                        // Check for updates every 5 minutes
                        setInterval(() => {
                            registration.update();
                        }, 5 * 60 * 1000);

                        // Listen for service worker updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            if (!newWorker) return;

                            newWorker.addEventListener('statechange', () => {
                                // If new SW is waiting and there's an active controller, show update prompt
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showToast(
                                        'Update available! Click here to reload and get the latest version.',
                                        0, // Don't auto-dismiss
                                        () => {
                                            // Tell the new SW to skip waiting
                                            newWorker.postMessage({type: 'SKIP_WAITING'});
                                        }
                                    );
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });

            // Listen for controller change (new SW activated)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                // Reload the page to use the new service worker
                window.location.reload();
            });
        }
    </script>

    <script src="/shared/header.js"></script>
</body>
</html>
