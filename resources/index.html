<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>if(location.protocol !== 'https:' && location.hostname !== 'localhost'){location.replace('https:' + location.href.substring(location.protocol.length));}</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="theme-color" content="#1f4e79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSN9B">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <!-- Preconnect hints for faster external resource loading -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <title>RN Resources - BSN9B</title>
    <script>
        if (localStorage.getItem('bsn9b_auth') !== 'true') {
            window.location.href = '/';
        }
    </script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-page: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-input: #fafafa;
            --text-primary: #1a1a2e;
            --text-secondary: #666666;
            --accent: #1f4e79;
            --border: #e2e8f0;
            --chat-msg-other-bg: #e2e8f0;
        }
        [data-theme="dark"] {
            --bg-page: linear-gradient(135deg, #0a0a14 0%, #0d1117 50%, #161b22 100%);
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-input: #16213e;
            --text-primary: #e6e6e6;
            --text-secondary: #aaaaaa;
            --accent: #4a90d9;
            --border: #2d3748;
            --chat-msg-other-bg: #2d3748;
        }

        /* Dark mode chat widget styles */
        [data-theme="dark"] #chatBox {
            background: var(--bg-primary) !important;
        }
        [data-theme="dark"] #chatMessages,
        [data-theme="dark"] #dmMessages,
        [data-theme="dark"] #dmConversationList {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #chatInput,
        [data-theme="dark"] #dmInput {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #mentionDropdown {
            background: var(--bg-primary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #dmHeader,
        [data-theme="dark"] #newDMSelector > div:first-child {
            background: var(--bg-tertiary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #dmHeader span,
        [data-theme="dark"] #newDMSelector span {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #dmPartnerStatus {
            background: var(--bg-secondary) !important;
            color: var(--text-secondary) !important;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-page);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }
        .header h1 { font-size: 26px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 13px; }
        .back-btn {
            display: inline-block;
            margin-top: 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        .content {
            background: white;
            padding: 30px;
            border-radius: 0 0 16px 16px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        .card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
        }
        .card h2 {
            color: #1f4e79;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1f4e79;
        }
        .card h3 {
            color: #334155;
            font-size: 14px;
            margin: 15px 0 8px 0;
        }
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .search-box input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .search-box button, .btn {
            padding: 10px 16px;
            background: #1f4e79;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: background 0.2s;
        }
        .search-box button:hover, .btn:hover { background: #2d5a87; }
        .btn-secondary {
            background: #64748b;
        }
        .btn-secondary:hover { background: #475569; }
        .link-list {
            list-style: none;
        }
        .link-list li {
            margin-bottom: 8px;
        }
        .link-list a {
            color: #1f4e79;
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .link-list a:hover { text-decoration: underline; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 10px;
        }
        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #1f4e79;
            color: white;
            font-weight: 600;
        }
        tr:hover { background: #f1f5f9; }
        .abbrev-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            font-size: 12px;
        }
        .abbrev-item {
            padding: 4px 8px;
            background: #e8f4fc;
            border-radius: 4px;
        }
        .abbrev-item strong { color: #1f4e79; }
        .calc-result {
            margin-top: 10px;
            padding: 12px;
            background: #e8f4fc;
            border-radius: 8px;
            font-weight: 600;
            color: #1f4e79;
            display: none;
        }
        /* Smart Drug Autocomplete */
        .drug-search-wrapper {
            position: relative;
            margin-bottom: 10px;
        }
        .drug-search-wrapper input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .drug-search-wrapper input:focus {
            border-color: #1f4e79;
            box-shadow: 0 0 0 3px rgba(31, 78, 121, 0.15);
            outline: none;
        }
        .drug-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 2px solid #1f4e79;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }
        .drug-autocomplete.show { display: block; }
        .drug-autocomplete-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            transition: background 0.15s;
        }
        .drug-autocomplete-item:hover { background: #e3f2fd; }
        .drug-autocomplete-item:last-child { border-bottom: none; }
        .drug-autocomplete-item .drug-type {
            font-size: 10px;
            color: #666;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }
        .drug-autocomplete-loading {
            padding: 12px 14px;
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
        .drug-autocomplete-hint {
            padding: 8px 14px;
            background: #fffbeb;
            color: #92400e;
            font-size: 11px;
            border-bottom: 1px solid #fcd34d;
        }
        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }
        .input-group label {
            min-width: 100px;
            font-size: 13px;
        }
        .input-group input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .input-group span {
            font-size: 12px;
            color: #666;
        }
        footer {
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.6);
            font-size: 12px;
        }
        .nanda-list {
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .nanda-category {
            font-weight: 600;
            color: #1f4e79;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .nanda-item {
            padding: 4px 8px;
            margin: 2px 0;
            background: #f1f5f9;
            border-radius: 4px;
        }
        .collapsible {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible:after {
            content: '‚ñº';
            font-size: 10px;
        }
        .collapsible.collapsed:after {
            content: '‚ñ∂';
        }
        .collapse-content {
            display: block;
        }
        .collapse-content.hidden {
            display: none;
        }

        /* Procedure Checklists */
        .checklist {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            line-height: 1.4;
        }
        .checklist-item:hover {
            background: var(--accent-hover);
        }
        .checklist-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            flex-shrink: 0;
            cursor: pointer;
            accent-color: #4caf50;
        }
        .checklist-item:has(input:checked) {
            background: #e8f5e9;
            text-decoration: line-through;
            color: #666;
        }
        [data-theme="dark"] .checklist-item:has(input:checked) {
            background: #1b3d1b;
            color: #888;
        }

        /* Med Timer */
        .timer-preset {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .timer-preset:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .active-timer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 4px solid #4caf50;
        }
        [data-theme="dark"] .active-timer {
            background: linear-gradient(135deg, #1b3d1b 0%, #2d4a2d 100%);
        }
        .timer-info { flex: 1; }
        .timer-label { font-weight: 600; font-size: 14px; color: var(--text-primary); }
        .timer-countdown { font-size: 20px; font-weight: 700; color: #2e7d32; font-family: monospace; }
        [data-theme="dark"] .timer-countdown { color: #81c784; }
        .timer-cancel {
            padding: 6px 12px;
            background: #ffebee;
            color: #c62828;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .timer-cancel:hover { background: #c62828; color: white; }

        @keyframes alertFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        }
        body.has-alert { padding-top: 50px; }
        body.has-fyi { padding-top: 50px; }
        body.has-alert.has-fyi { padding-top: 100px; }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 10px;
            transition: color 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .toolbar-item:hover { color: var(--accent); }
        .toolbar-item.active { color: var(--accent); }
        .toolbar-item .icon { font-size: 24px; margin-bottom: 2px; }
        .toolbar-item .label { font-weight: 600; }

        /* More Menu */
        .more-menu {
            position: fixed;
            bottom: 70px;
            right: 10px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 8px 0;
            display: none;
            z-index: 1001;
            min-width: 160px;
            border: 1px solid var(--border);
        }

        .more-menu.show { display: block; }

        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
        }

        .more-menu-item:hover { background: var(--bg-secondary); }
        .more-menu-item .menu-icon { font-size: 18px; }

        /* Dark mode support */
        [data-theme="dark"] .content { background: var(--bg-primary); color: var(--text-primary); }
        [data-theme="dark"] .card { background: var(--bg-secondary); border-color: var(--border); }
        [data-theme="dark"] .card h2 { color: var(--accent); border-color: var(--accent); }
        [data-theme="dark"] .link-list a { color: var(--accent); }
        [data-theme="dark"] table { color: var(--text-primary); }
        [data-theme="dark"] th { background: var(--bg-secondary); color: var(--text-primary); }
        [data-theme="dark"] td { border-color: var(--border); }
        [data-theme="dark"] input, [data-theme="dark"] select, [data-theme="dark"] textarea { background: var(--bg-input); color: var(--text-primary); border-color: var(--border); }
        [data-theme="dark"] footer { color: rgba(255,255,255,0.6); }

        /* Lock screen */
        #lockScreenOverlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); z-index: 99999; align-items: center; justify-content: center; flex-direction: column; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .modal-overlay.hidden { display: none; }
        .modal-content { background: var(--bg-primary); border-radius: 16px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); color: var(--text-primary); }
        .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 15px; background: var(--bg-input); color: var(--text-primary); }
        .modal-content textarea { min-height: 120px; resize: vertical; }

        /* ========== MOBILE RESPONSIVE STYLES ========== */

        /* Smooth scrolling and touch-friendly */
        html { scroll-behavior: smooth; }
        #chatMessages, #dmMessages, #aiMessages {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* Minimum touch target size */
        @media (pointer: coarse) {
            button, .btn, .toolbar-item, .more-menu-item, .resource-btn, .tab-btn {
                min-height: 44px;
            }
        }

        /* Mobile Chat/AI Widget - Full Screen Overlay */
        @media (max-width: 768px) {
            body {
                padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
            }

            #chatBox, #aiBox {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                border-radius: 0 !important;
                z-index: 10000 !important;
                padding-top: env(safe-area-inset-top, 0px);
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            #chatWidget, #aiWidget {
                bottom: 70px !important;
            }

            #chatToggle, #aiToggle {
                width: 54px !important;
                height: 54px !important;
            }

            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }
        }

        /* Small phones */
        @media (max-width: 480px) {
            input, select, textarea {
                font-size: 16px !important;
            }

            .resource-grid { grid-template-columns: 1fr; }
            .calc-grid { grid-template-columns: 1fr; }
        }

        /* Landscape orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .bottom-toolbar { height: 50px; }
            .toolbar-item .label { display: none; }
        }

        /* Safe area insets for bottom toolbar */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(60px + env(safe-area-inset-bottom));
            }
        }

        /* Focus visible styles for keyboard navigation */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        button:focus-visible, a:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; max-width: 380px; }
        .toast { padding: 14px 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); display: flex; align-items: flex-start; gap: 12px; animation: toastSlideIn 0.3s ease; color: white; font-size: 14px; line-height: 1.4; }
        .toast.hiding { animation: toastSlideOut 0.3s ease forwards; }
        .toast-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .toast-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .toast-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .toast-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .toast-icon { font-size: 18px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-message { opacity: 0.95; }
        .toast-close { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; font-size: 18px; padding: 0; line-height: 1; }
        .toast-close:hover { opacity: 1; }
        @keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @media (max-width: 480px) { .toast-container { left: 10px; right: 10px; max-width: none; } }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Alert/FYI Banners -->
    <div id="alertBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 10000; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5); animation: alertFlash 1s infinite;">
        <span id="alertText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.8;">‚ö†Ô∏è ALERT</span>
    </div>
    <div id="fyiBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a1a2e; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 9999; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);">
        <span id="fyiText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.7;">‚ÑπÔ∏è FYI</span>
    </div>

    <div class="container">
        <div class="header" style="position: relative;">
            <div style="position: absolute; top: 15px; right: 20px;">
                <span id="userDisplay" style="color: rgba(255,255,255,0.8); font-size: 12px; margin-right: 10px;"></span>
                <button onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">Logout</button>
            </div>
            <h1>RN Resources</h1>
            <p>Drug Information | Lab Values | Calculations | References</p>
            <a href="/home/" class="back-btn">‚Üê Back to Home</a>
        </div>

        <div class="content">
            <!-- Educational Disclaimer Banner -->
            <div style="background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <p style="font-weight: 700; font-size: 14px; margin-bottom: 5px;">‚ö†Ô∏è EDUCATIONAL USE ONLY - NOT FOR CLINICAL DECISIONS</p>
                <p style="font-size: 12px; opacity: 0.95;">This tool is for nursing student learning purposes only. Always consult your facility's official drug guide, pharmacist, and clinical resources before administering any medication. This tool may contain incomplete or inaccurate information.</p>
            </div>

            <div class="grid">
                <!-- Drug Information -->
                <div class="card">
                    <h2>üíä Drug Information</h2>
                    <p style="font-size: 12px; color: #c62828; background: #ffebee; padding: 8px; border-radius: 6px; margin-bottom: 12px;"><strong>Educational reference only.</strong> Verify all information with official sources.</p>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Start typing to search medications (smart spelling correction)</p>
                    <div class="drug-search-wrapper">
                        <input type="text" id="drugSearch" placeholder="Type drug name (e.g., met, lisi, ator)..." autocomplete="off">
                        <div id="drugSearchDropdown" class="drug-autocomplete"></div>
                    </div>
                    <div id="drugInfo" style="display:none; padding: 12px; background: #e8f4fc; border-radius: 8px; margin-bottom: 15px;">
                        <h4 id="drugInfoName" style="color: #1f4e79; margin-bottom: 8px;"></h4>
                        <div id="drugInfoDetails" style="font-size: 13px;"></div>
                        <div style="margin-top: 10px; font-size: 12px;">
                            <a id="drugLinkDailyMed" href="#" target="_blank" style="color: #1f4e79; margin-right: 10px;">üìÑ Full Label (DailyMed)</a>
                            <a id="drugLinkDrugs" href="#" target="_blank" style="color: #1f4e79;">üíä Drugs.com</a>
                        </div>
                    </div>
                    <p style="font-size: 11px; color: #888; margin-top: 10px;">Recommended Resources:</p>
                    <ul class="link-list" style="margin-top: 5px;">
                        <li><a href="https://www.nursingcenter.com/drug-information" target="_blank">üìö Lippincott Drug Information</a></li>
                        <li><a href="https://www.nursingcenter.com/clinical-resources" target="_blank">üìö Lippincott Clinical Resources</a></li>
                        <li><a href="https://medlineplus.gov/druginformation.html" target="_blank">üîó MedlinePlus Drugs (NIH)</a></li>
                    </ul>
                </div>

                <!-- Lab Values -->
                <div class="card">
                    <h2>üî¨ Lab Values Reference</h2>
                    <h3 class="collapsible" onclick="toggleCollapse(this)">Complete Blood Count (CBC)</h3>
                    <div class="collapse-content">
                        <table>
                            <tr><th>Test</th><th>Normal Range</th></tr>
                            <tr><td>WBC</td><td>4,500-11,000/mcL</td></tr>
                            <tr><td>RBC (M)</td><td>4.5-5.5 million/mcL</td></tr>
                            <tr><td>RBC (F)</td><td>4.0-5.0 million/mcL</td></tr>
                            <tr><td>Hemoglobin (M)</td><td>14-18 g/dL</td></tr>
                            <tr><td>Hemoglobin (F)</td><td>12-16 g/dL</td></tr>
                            <tr><td>Hematocrit (M)</td><td>40-54%</td></tr>
                            <tr><td>Hematocrit (F)</td><td>36-48%</td></tr>
                            <tr><td>Platelets</td><td>150,000-400,000/mcL</td></tr>
                        </table>
                    </div>
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">Basic Metabolic Panel (BMP)</h3>
                    <div class="collapse-content hidden">
                        <table>
                            <tr><th>Test</th><th>Normal Range</th></tr>
                            <tr><td>Sodium (Na)</td><td>136-145 mEq/L</td></tr>
                            <tr><td>Potassium (K)</td><td>3.5-5.0 mEq/L</td></tr>
                            <tr><td>Chloride (Cl)</td><td>98-106 mEq/L</td></tr>
                            <tr><td>CO2</td><td>23-29 mEq/L</td></tr>
                            <tr><td>BUN</td><td>7-20 mg/dL</td></tr>
                            <tr><td>Creatinine</td><td>0.6-1.2 mg/dL</td></tr>
                            <tr><td>Glucose</td><td>70-100 mg/dL (fasting)</td></tr>
                            <tr><td>Calcium</td><td>8.5-10.5 mg/dL</td></tr>
                        </table>
                    </div>
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">Coagulation</h3>
                    <div class="collapse-content hidden">
                        <table>
                            <tr><th>Test</th><th>Normal Range</th></tr>
                            <tr><td>PT</td><td>11-13.5 seconds</td></tr>
                            <tr><td>INR</td><td>0.8-1.1 (2-3 on warfarin)</td></tr>
                            <tr><td>PTT</td><td>25-35 seconds</td></tr>
                            <tr><td>aPTT</td><td>30-40 seconds</td></tr>
                        </table>
                    </div>
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">Cardiac Markers</h3>
                    <div class="collapse-content hidden">
                        <table>
                            <tr><th>Test</th><th>Normal Range</th></tr>
                            <tr><td>Troponin I</td><td>&lt;0.04 ng/mL</td></tr>
                            <tr><td>Troponin T</td><td>&lt;0.1 ng/mL</td></tr>
                            <tr><td>BNP</td><td>&lt;100 pg/mL</td></tr>
                            <tr><td>CK-MB</td><td>&lt;5 ng/mL</td></tr>
                        </table>
                    </div>
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">ABGs</h3>
                    <div class="collapse-content hidden">
                        <table>
                            <tr><th>Test</th><th>Normal Range</th></tr>
                            <tr><td>pH</td><td>7.35-7.45</td></tr>
                            <tr><td>PaCO2</td><td>35-45 mmHg</td></tr>
                            <tr><td>PaO2</td><td>80-100 mmHg</td></tr>
                            <tr><td>HCO3</td><td>22-26 mEq/L</td></tr>
                            <tr><td>O2 Sat</td><td>95-100%</td></tr>
                        </table>
                    </div>
                </div>

                <!-- Vital Signs -->
                <div class="card">
                    <h2>‚ù§Ô∏è Vital Signs Normal Ranges</h2>
                    <table>
                        <tr><th>Vital Sign</th><th>Adult Normal</th></tr>
                        <tr><td>Heart Rate</td><td>60-100 bpm</td></tr>
                        <tr><td>Blood Pressure</td><td>&lt;120/80 mmHg</td></tr>
                        <tr><td>Respiratory Rate</td><td>12-20 breaths/min</td></tr>
                        <tr><td>Temperature</td><td>97.8-99.1¬∞F (36.5-37.3¬∞C)</td></tr>
                        <tr><td>O2 Saturation</td><td>95-100%</td></tr>
                    </table>
                    <h3>Blood Pressure Categories</h3>
                    <table>
                        <tr><th>Category</th><th>Systolic</th><th>Diastolic</th></tr>
                        <tr><td>Normal</td><td>&lt;120</td><td>&lt;80</td></tr>
                        <tr><td>Elevated</td><td>120-129</td><td>&lt;80</td></tr>
                        <tr><td>HTN Stage 1</td><td>130-139</td><td>80-89</td></tr>
                        <tr><td>HTN Stage 2</td><td>‚â•140</td><td>‚â•90</td></tr>
                        <tr><td>Crisis</td><td>&gt;180</td><td>&gt;120</td></tr>
                    </table>
                </div>

                <!-- IV Calculations -->
                <div class="card">
                    <h2>üíâ IV Drip Rate Calculator</h2>
                    <p style="font-size: 11px; color: #c62828; background: #ffebee; padding: 6px 8px; border-radius: 4px; margin-bottom: 10px;"><strong>Double-check all calculations.</strong> Verify with preceptor/RN before administration.</p>
                    <p style="font-size: 12px; color: #666; margin-bottom: 12px;">For gravity drip or pump rate calculation</p>
                    <div class="input-group">
                        <label>Volume to Infuse:</label>
                        <input type="number" id="ivVolume" placeholder="1000" step="any" min="0">
                        <span>mL</span>
                    </div>
                    <div class="input-group">
                        <label>Infusion Time:</label>
                        <input type="number" id="ivTime" placeholder="8" step="any" min="0">
                        <span>hours</span>
                    </div>
                    <div class="input-group">
                        <label>Drop Factor:</label>
                        <select id="ivDropFactor" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="10">10 gtt/mL (Macrodrip)</option>
                            <option value="15" selected>15 gtt/mL (Macrodrip)</option>
                            <option value="20">20 gtt/mL (Macrodrip)</option>
                            <option value="60">60 gtt/mL (Microdrip/Peds)</option>
                        </select>
                    </div>
                    <button onclick="calculateDripRate()" style="width: 100%;">Calculate Drip Rate</button>
                    <div id="dripResult" class="calc-result"></div>

                    <h3 style="margin-top: 20px;">Quick Reference</h3>
                    <table>
                        <tr><th>Set Type</th><th>Drop Factor</th><th>Common Use</th></tr>
                        <tr><td>Macrodrip</td><td>10-20 gtt/mL</td><td>Adults, large volumes</td></tr>
                        <tr><td>Microdrip</td><td>60 gtt/mL</td><td>Peds, precise dosing</td></tr>
                        <tr><td>Blood tubing</td><td>10 gtt/mL</td><td>Blood products</td></tr>
                    </table>
                    <p style="font-size: 11px; color: #666; margin-top: 10px;"><strong>Tip:</strong> For IV pumps, you only need mL/hr (no drop factor needed). Microdrip: gtt/min = mL/hr</p>
                </div>

                <!-- Dosage Calculator -->
                <div class="card">
                    <h2>üíä Dosage Calculator</h2>
                    <p style="font-size: 11px; color: #c62828; background: #ffebee; padding: 6px 8px; border-radius: 4px; margin-bottom: 10px;"><strong>Double-check all calculations.</strong> Verify with preceptor/RN before administration.</p>
                    <p style="font-size: 12px; color: #666; margin-bottom: 12px;">D/H √ó Q (Desired √∑ Have √ó Quantity)</p>
                    <div class="input-group">
                        <label>Desired Dose:</label>
                        <input type="number" id="desiredDose" placeholder="500" step="any" min="0">
                        <span>mg</span>
                    </div>
                    <div class="input-group">
                        <label>Have on Hand:</label>
                        <input type="number" id="haveOnHand" placeholder="250" step="any" min="0">
                        <span>mg per unit</span>
                    </div>
                    <div class="input-group">
                        <label>Quantity per Unit:</label>
                        <input type="number" id="quantity" placeholder="1" value="1" step="any" min="0">
                        <select id="quantityUnit" style="width: 80px; padding: 5px; border-radius: 4px;">
                            <option value="tablet">tablet</option>
                            <option value="mL">mL</option>
                            <option value="capsule">capsule</option>
                        </select>
                    </div>
                    <button onclick="calculateDosage()" style="width: 100%;">Calculate</button>
                    <div id="dosageResult" class="calc-result"></div>

                    <h3 style="margin-top: 20px;">Weight-Based Dosing</h3>
                    <p style="font-size: 11px; color: #666; margin-bottom: 8px;">Calculate dose based on patient weight</p>
                    <div class="input-group">
                        <label>Order (mg/kg):</label>
                        <input type="number" id="mgPerKg" placeholder="10" step="any" min="0">
                        <span>mg/kg</span>
                    </div>
                    <div class="input-group">
                        <label>Patient Weight:</label>
                        <input type="number" id="patientWeight" placeholder="70" step="any" min="0">
                        <select id="weightUnit" style="width: 60px; padding: 5px; border-radius: 4px;">
                            <option value="kg">kg</option>
                            <option value="lb">lb</option>
                        </select>
                    </div>
                    <button onclick="calculateWeightDose()" style="width: 100%;">Calculate Weight-Based Dose</button>
                    <div id="weightDoseResult" class="calc-result"></div>
                </div>

                <!-- Common Abbreviations -->
                <div class="card">
                    <h2>üìù Common Abbreviations</h2>
                    <div class="abbrev-grid">
                        <div class="abbrev-item"><strong>AC</strong> - Before meals</div>
                        <div class="abbrev-item"><strong>PC</strong> - After meals</div>
                        <div class="abbrev-item"><strong>BID</strong> - Twice daily</div>
                        <div class="abbrev-item"><strong>TID</strong> - Three times daily</div>
                        <div class="abbrev-item"><strong>QID</strong> - Four times daily</div>
                        <div class="abbrev-item"><strong>PRN</strong> - As needed</div>
                        <div class="abbrev-item"><strong>STAT</strong> - Immediately</div>
                        <div class="abbrev-item"><strong>PO</strong> - By mouth</div>
                        <div class="abbrev-item"><strong>IV</strong> - Intravenous</div>
                        <div class="abbrev-item"><strong>IM</strong> - Intramuscular</div>
                        <div class="abbrev-item"><strong>SQ/SubQ</strong> - Subcutaneous</div>
                        <div class="abbrev-item"><strong>SL</strong> - Sublingual</div>
                        <div class="abbrev-item"><strong>NPO</strong> - Nothing by mouth</div>
                        <div class="abbrev-item"><strong>WNL</strong> - Within normal limits</div>
                        <div class="abbrev-item"><strong>SOB</strong> - Shortness of breath</div>
                        <div class="abbrev-item"><strong>ROM</strong> - Range of motion</div>
                        <div class="abbrev-item"><strong>ADL</strong> - Activities of daily living</div>
                        <div class="abbrev-item"><strong>I&O</strong> - Intake and output</div>
                        <div class="abbrev-item"><strong>BRP</strong> - Bathroom privileges</div>
                        <div class="abbrev-item"><strong>OOB</strong> - Out of bed</div>
                        <div class="abbrev-item"><strong>HS</strong> - At bedtime</div>
                        <div class="abbrev-item"><strong>QHS</strong> - Every bedtime</div>
                        <div class="abbrev-item"><strong>GT</strong> - Gastrostomy tube</div>
                        <div class="abbrev-item"><strong>NG</strong> - Nasogastric</div>
                    </div>
                </div>

                <!-- Clinical Toolkit -->
                <div class="card" style="grid-column: span 2;">
                    <h2>ü©∫ Clinical Toolkit</h2>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Quick reference tools for clinical rotations</p>

                    <!-- Pediatric Vital Signs -->
                    <h3 class="collapsible" onclick="toggleCollapse(this)">üë∂ Pediatric Vital Signs</h3>
                    <div class="collapse-content">
                        <table>
                            <tr><th>Age</th><th>HR (bpm)</th><th>RR (/min)</th><th>BP (mmHg)</th></tr>
                            <tr><td>Newborn</td><td>100-160</td><td>30-60</td><td>60-90/30-60</td></tr>
                            <tr><td>Infant (1-12 mo)</td><td>80-140</td><td>25-40</td><td>80-100/50-70</td></tr>
                            <tr><td>Toddler (1-3 yr)</td><td>80-130</td><td>20-30</td><td>90-105/55-70</td></tr>
                            <tr><td>Preschool (3-5 yr)</td><td>80-120</td><td>20-25</td><td>95-110/60-75</td></tr>
                            <tr><td>School Age (6-12 yr)</td><td>70-110</td><td>18-22</td><td>100-120/60-75</td></tr>
                            <tr><td>Adolescent (13+ yr)</td><td>60-100</td><td>12-20</td><td>110-135/65-85</td></tr>
                        </table>
                    </div>

                    <!-- Pain Scales -->
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">üò£ Pain Assessment Scales</h3>
                    <div class="collapse-content hidden">
                        <div style="margin-bottom: 15px;">
                            <strong>Numeric Rating Scale (NRS)</strong>
                            <p style="font-size: 12px; margin-top: 5px;">0 = No pain | 1-3 = Mild | 4-6 = Moderate | 7-10 = Severe</p>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>FLACC Scale (Non-verbal/Pediatric)</strong>
                            <table style="font-size: 11px;">
                                <tr><th>Category</th><th>0</th><th>1</th><th>2</th></tr>
                                <tr><td><strong>F</strong>ace</td><td>Relaxed</td><td>Occasional grimace</td><td>Frequent grimace</td></tr>
                                <tr><td><strong>L</strong>egs</td><td>Relaxed</td><td>Restless</td><td>Kicking</td></tr>
                                <tr><td><strong>A</strong>ctivity</td><td>Lying quietly</td><td>Squirming</td><td>Arched, rigid</td></tr>
                                <tr><td><strong>C</strong>ry</td><td>No cry</td><td>Moans, whimpers</td><td>Crying steadily</td></tr>
                                <tr><td><strong>C</strong>onsolability</td><td>Content</td><td>Reassured by touch</td><td>Difficult to console</td></tr>
                            </table>
                            <p style="font-size: 11px; color: #666; margin-top: 5px;">Score 0-10: 0 = No pain, 1-3 = Mild, 4-6 = Moderate, 7-10 = Severe</p>
                        </div>
                    </div>

                    <!-- Glasgow Coma Scale -->
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">üß† Glasgow Coma Scale (GCS)</h3>
                    <div class="collapse-content hidden">
                        <table style="font-size: 12px;">
                            <tr><th>Response</th><th>Score</th><th>Description</th></tr>
                            <tr><td rowspan="4"><strong>Eye Opening</strong></td><td>4</td><td>Spontaneous</td></tr>
                            <tr><td>3</td><td>To voice</td></tr>
                            <tr><td>2</td><td>To pain</td></tr>
                            <tr><td>1</td><td>None</td></tr>
                            <tr><td rowspan="5"><strong>Verbal</strong></td><td>5</td><td>Oriented</td></tr>
                            <tr><td>4</td><td>Confused</td></tr>
                            <tr><td>3</td><td>Inappropriate words</td></tr>
                            <tr><td>2</td><td>Incomprehensible sounds</td></tr>
                            <tr><td>1</td><td>None</td></tr>
                            <tr><td rowspan="6"><strong>Motor</strong></td><td>6</td><td>Obeys commands</td></tr>
                            <tr><td>5</td><td>Localizes pain</td></tr>
                            <tr><td>4</td><td>Withdraws from pain</td></tr>
                            <tr><td>3</td><td>Abnormal flexion (decorticate)</td></tr>
                            <tr><td>2</td><td>Extension (decerebrate)</td></tr>
                            <tr><td>1</td><td>None</td></tr>
                        </table>
                        <p style="font-size: 11px; margin-top: 10px;"><strong>Interpretation:</strong> 15 = Normal | 13-14 = Mild | 9-12 = Moderate | 3-8 = Severe</p>
                    </div>

                    <!-- APGAR Calculator -->
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">üë∂ APGAR Score Calculator</h3>
                    <div class="collapse-content hidden">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Appearance (Color)</label>
                                <select id="apgar-appearance" onchange="calculateAPGAR()" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="0">Blue/Pale all over</option>
                                    <option value="1">Body pink, extremities blue</option>
                                    <option value="2">Completely pink</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Pulse (Heart Rate)</label>
                                <select id="apgar-pulse" onchange="calculateAPGAR()" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="0">Absent</option>
                                    <option value="1">< 100 bpm</option>
                                    <option value="2">> 100 bpm</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Grimace (Reflex)</label>
                                <select id="apgar-grimace" onchange="calculateAPGAR()" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="0">No response</option>
                                    <option value="1">Grimace</option>
                                    <option value="2">Cry, cough, sneeze</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Activity (Muscle Tone)</label>
                                <select id="apgar-activity" onchange="calculateAPGAR()" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="0">Limp</option>
                                    <option value="1">Some flexion</option>
                                    <option value="2">Active movement</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; font-weight: 600;">Respiration</label>
                                <select id="apgar-respiration" onchange="calculateAPGAR()" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="0">Absent</option>
                                    <option value="1">Slow, irregular</option>
                                    <option value="2">Good, crying</option>
                                </select>
                            </div>
                        </div>
                        <div id="apgar-result" class="calc-result" style="display: block; background: #e8f4fc; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <strong>APGAR Score:</strong> <span id="apgar-score">0</span>/10
                            <span id="apgar-interpretation" style="margin-left: 10px; font-size: 12px;"></span>
                        </div>
                    </div>

                    <!-- SBAR Template -->
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">üìã SBAR Communication Template</h3>
                    <div class="collapse-content hidden">
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; font-size: 12px;">
                            <div style="margin-bottom: 12px;">
                                <strong style="color: #1f4e79;">S - Situation</strong>
                                <p style="margin-top: 4px;">"I am calling about [patient name] in [room/unit]. The problem I am calling about is..."</p>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong style="color: #1f4e79;">B - Background</strong>
                                <p style="margin-top: 4px;">"The patient's diagnosis is... They were admitted on [date] for... Relevant history includes..."</p>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong style="color: #1f4e79;">A - Assessment</strong>
                                <p style="margin-top: 4px;">"My assessment is that... Vital signs are... Changes from baseline include..."</p>
                            </div>
                            <div>
                                <strong style="color: #1f4e79;">R - Recommendation</strong>
                                <p style="margin-top: 4px;">"I recommend... Would you like me to... Is there anything else you need?"</p>
                            </div>
                        </div>
                    </div>

                    <!-- SBAR Shift Handoff Generator -->
                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">üìù SBAR Shift Handoff Generator</h3>
                    <div class="collapse-content hidden">
                        <p style="font-size: 11px; color: #666; margin-bottom: 12px;">Fill in the fields below to generate a complete SBAR handoff report</p>
                        <div id="sbarForm" style="display: grid; gap: 12px;">
                            <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; border-left: 4px solid #1976d2;">
                                <strong style="color: #1976d2; font-size: 13px;">S - Situation</strong>
                                <input type="text" id="sbar-patient" placeholder="Patient name & room (e.g., John Doe, Rm 412)" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-reason" placeholder="Reason for handoff (e.g., End of shift report)" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                            <div style="background: #fff3e0; padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                <strong style="color: #e65100; font-size: 13px;">B - Background</strong>
                                <input type="text" id="sbar-diagnosis" placeholder="Admitting diagnosis" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-history" placeholder="Relevant history (allergies, code status, isolation)" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-meds" placeholder="Key medications & IVs" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                            <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; border-left: 4px solid #4caf50;">
                                <strong style="color: #2e7d32; font-size: 13px;">A - Assessment</strong>
                                <input type="text" id="sbar-vitals" placeholder="Latest vitals (BP, HR, RR, Temp, SpO2, Pain)" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-neuro" placeholder="Neuro/LOC status" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-io" placeholder="I&O, last void/BM" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-concerns" placeholder="Current concerns or changes" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                            <div style="background: #fce4ec; padding: 12px; border-radius: 8px; border-left: 4px solid #e91e63;">
                                <strong style="color: #c2185b; font-size: 13px;">R - Recommendation</strong>
                                <input type="text" id="sbar-pending" placeholder="Pending tests/procedures" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-followup" placeholder="Follow-up actions needed" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <input type="text" id="sbar-priority" placeholder="Priority concerns for next shift" style="width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button onclick="generateSBARHandoff()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #1f4e79, #2d5a87); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Generate Handoff</button>
                            <button onclick="clearSBARForm()" style="padding: 12px 20px; background: #f0f0f0; color: #333; border: none; border-radius: 6px; cursor: pointer;">Clear</button>
                        </div>
                        <div id="sbar-output" style="display: none; margin-top: 15px; background: #fff; border: 2px solid #1f4e79; border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: #1f4e79;">Generated SBAR Handoff</strong>
                                <button onclick="copySBARHandoff()" style="padding: 6px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy to Clipboard</button>
                            </div>
                            <pre id="sbar-text" style="white-space: pre-wrap; font-family: inherit; font-size: 12px; line-height: 1.6; margin: 0; color: #333;"></pre>
                        </div>
                    </div>

                </div>

                <!-- NANDA Diagnoses Quick Reference -->
                <div class="card">
                    <h2>ü©∫ NANDA Nursing Diagnoses</h2>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Common nursing diagnoses by category</p>
                    <div class="nanda-list">
                        <div class="nanda-category">Activity/Rest</div>
                        <div class="nanda-item">Activity intolerance</div>
                        <div class="nanda-item">Fatigue</div>
                        <div class="nanda-item">Insomnia</div>
                        <div class="nanda-item">Impaired physical mobility</div>

                        <div class="nanda-category">Circulation</div>
                        <div class="nanda-item">Decreased cardiac output</div>
                        <div class="nanda-item">Ineffective tissue perfusion</div>
                        <div class="nanda-item">Risk for bleeding</div>

                        <div class="nanda-category">Respiration</div>
                        <div class="nanda-item">Ineffective airway clearance</div>
                        <div class="nanda-item">Impaired gas exchange</div>
                        <div class="nanda-item">Ineffective breathing pattern</div>

                        <div class="nanda-category">Safety</div>
                        <div class="nanda-item">Risk for falls</div>
                        <div class="nanda-item">Risk for infection</div>
                        <div class="nanda-item">Impaired skin integrity</div>

                        <div class="nanda-category">Pain/Comfort</div>
                        <div class="nanda-item">Acute pain</div>
                        <div class="nanda-item">Chronic pain</div>
                        <div class="nanda-item">Nausea</div>

                        <div class="nanda-category">Elimination</div>
                        <div class="nanda-item">Constipation</div>
                        <div class="nanda-item">Diarrhea</div>
                        <div class="nanda-item">Impaired urinary elimination</div>
                    </div>
                    <a href="/app/" class="btn" style="display: block; text-align: center; margin-top: 15px;">Full NANDA Database ‚Üí</a>
                </div>

                <!-- Procedure Checklists -->
                <div class="card" style="grid-column: span 2;">
                    <h2>üìã Procedure Checklists</h2>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Interactive checklists for common nursing procedures</p>

                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">ü©∫ Foley Catheter Insertion</h3>
                    <div class="collapse-content hidden">
                        <div class="checklist" id="foley-checklist">
                            <label class="checklist-item"><input type="checkbox"> Verify order and check for allergies (latex, iodine)</label>
                            <label class="checklist-item"><input type="checkbox"> Gather supplies: catheter kit, extra gloves, lighting</label>
                            <label class="checklist-item"><input type="checkbox"> Explain procedure to patient, ensure privacy</label>
                            <label class="checklist-item"><input type="checkbox"> Position patient (supine, knees bent for female; supine for male)</label>
                            <label class="checklist-item"><input type="checkbox"> Perform hand hygiene, apply sterile gloves</label>
                            <label class="checklist-item"><input type="checkbox"> Establish sterile field, arrange supplies</label>
                            <label class="checklist-item"><input type="checkbox"> Apply sterile drape with fenestration</label>
                            <label class="checklist-item"><input type="checkbox"> Test balloon with 10mL sterile water</label>
                            <label class="checklist-item"><input type="checkbox"> Lubricate catheter tip generously</label>
                            <label class="checklist-item"><input type="checkbox"> Cleanse urethral meatus (female: front to back; male: circular from meatus outward)</label>
                            <label class="checklist-item"><input type="checkbox"> Insert catheter until urine flows, then advance 2-3 inches more</label>
                            <label class="checklist-item"><input type="checkbox"> Inflate balloon with 10mL sterile water</label>
                            <label class="checklist-item"><input type="checkbox"> Gently pull back to confirm balloon seated</label>
                            <label class="checklist-item"><input type="checkbox"> Secure catheter to thigh, connect to drainage bag</label>
                            <label class="checklist-item"><input type="checkbox"> Position bag below bladder level</label>
                            <label class="checklist-item"><input type="checkbox"> Document: catheter size, balloon volume, urine output, patient tolerance</label>
                        </div>
                        <button onclick="clearChecklist('foley-checklist')" style="margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Reset Checklist</button>
                    </div>

                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">üíâ IV Insertion</h3>
                    <div class="collapse-content hidden">
                        <div class="checklist" id="iv-checklist">
                            <label class="checklist-item"><input type="checkbox"> Verify order, check patient ID, assess for allergies</label>
                            <label class="checklist-item"><input type="checkbox"> Gather supplies: IV catheter, tegaderm, extension set, flush, tourniquet</label>
                            <label class="checklist-item"><input type="checkbox"> Explain procedure to patient</label>
                            <label class="checklist-item"><input type="checkbox"> Perform hand hygiene, apply clean gloves</label>
                            <label class="checklist-item"><input type="checkbox"> Select appropriate vein (avoid arm with fistula, mastectomy side, injured area)</label>
                            <label class="checklist-item"><input type="checkbox"> Apply tourniquet 4-6 inches above site</label>
                            <label class="checklist-item"><input type="checkbox"> Palpate vein, confirm bouncy feeling</label>
                            <label class="checklist-item"><input type="checkbox"> Cleanse site with alcohol/chlorhexidine, allow to dry</label>
                            <label class="checklist-item"><input type="checkbox"> Anchor vein below insertion site</label>
                            <label class="checklist-item"><input type="checkbox"> Insert catheter at 15-30¬∞ angle, bevel up</label>
                            <label class="checklist-item"><input type="checkbox"> Observe for flashback in chamber</label>
                            <label class="checklist-item"><input type="checkbox"> Advance catheter, retract stylet</label>
                            <label class="checklist-item"><input type="checkbox"> Release tourniquet</label>
                            <label class="checklist-item"><input type="checkbox"> Apply pressure above catheter tip, remove stylet completely</label>
                            <label class="checklist-item"><input type="checkbox"> Connect extension set/flush, secure with tegaderm</label>
                            <label class="checklist-item"><input type="checkbox"> Flush with saline, assess for infiltration</label>
                            <label class="checklist-item"><input type="checkbox"> Label dressing with date, time, initials, gauge</label>
                            <label class="checklist-item"><input type="checkbox"> Document: site, catheter gauge, number of attempts, patient tolerance</label>
                        </div>
                        <button onclick="clearChecklist('iv-checklist')" style="margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Reset Checklist</button>
                    </div>

                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">ü©π Wound Care/Dressing Change</h3>
                    <div class="collapse-content hidden">
                        <div class="checklist" id="wound-checklist">
                            <label class="checklist-item"><input type="checkbox"> Review order and wound care instructions</label>
                            <label class="checklist-item"><input type="checkbox"> Gather supplies based on wound type</label>
                            <label class="checklist-item"><input type="checkbox"> Perform hand hygiene, apply clean gloves</label>
                            <label class="checklist-item"><input type="checkbox"> Position patient, ensure adequate lighting</label>
                            <label class="checklist-item"><input type="checkbox"> Remove old dressing, assess drainage on dressing</label>
                            <label class="checklist-item"><input type="checkbox"> Dispose of soiled dressing, remove gloves, hand hygiene</label>
                            <label class="checklist-item"><input type="checkbox"> Apply sterile gloves</label>
                            <label class="checklist-item"><input type="checkbox"> Assess wound: size, depth, drainage, odor, edges, surrounding skin</label>
                            <label class="checklist-item"><input type="checkbox"> Cleanse wound per order (typically center to periphery)</label>
                            <label class="checklist-item"><input type="checkbox"> Apply prescribed treatment/medication</label>
                            <label class="checklist-item"><input type="checkbox"> Apply appropriate dressing, secure</label>
                            <label class="checklist-item"><input type="checkbox"> Label dressing with date, time, initials</label>
                            <label class="checklist-item"><input type="checkbox"> Document: wound assessment, treatment, patient response</label>
                        </div>
                        <button onclick="clearChecklist('wound-checklist')" style="margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Reset Checklist</button>
                    </div>

                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">üíä Medication Administration (5 Rights)</h3>
                    <div class="collapse-content hidden">
                        <div class="checklist" id="med-checklist">
                            <label class="checklist-item"><input type="checkbox"> <strong>Right Patient</strong> - Check 2 identifiers (name, DOB, MRN)</label>
                            <label class="checklist-item"><input type="checkbox"> <strong>Right Drug</strong> - Verify medication matches order</label>
                            <label class="checklist-item"><input type="checkbox"> <strong>Right Dose</strong> - Calculate if needed, verify amount</label>
                            <label class="checklist-item"><input type="checkbox"> <strong>Right Route</strong> - PO, IV, IM, SubQ, SL, etc.</label>
                            <label class="checklist-item"><input type="checkbox"> <strong>Right Time</strong> - Within 30 min of scheduled time</label>
                            <label class="checklist-item"><input type="checkbox"> Check for allergies</label>
                            <label class="checklist-item"><input type="checkbox"> Verify expiration date</label>
                            <label class="checklist-item"><input type="checkbox"> Assess for contraindications (vital signs, labs)</label>
                            <label class="checklist-item"><input type="checkbox"> Educate patient about medication</label>
                            <label class="checklist-item"><input type="checkbox"> Administer medication</label>
                            <label class="checklist-item"><input type="checkbox"> Stay with patient for PO meds to ensure swallowed</label>
                            <label class="checklist-item"><input type="checkbox"> Document immediately after administration</label>
                        </div>
                        <button onclick="clearChecklist('med-checklist')" style="margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Reset Checklist</button>
                    </div>

                    <h3 class="collapsible collapsed" onclick="toggleCollapse(this)">ü´Å Tracheostomy Care</h3>
                    <div class="collapse-content hidden">
                        <div class="checklist" id="trach-checklist">
                            <label class="checklist-item"><input type="checkbox"> Verify order, gather supplies, explain to patient</label>
                            <label class="checklist-item"><input type="checkbox"> Position patient (semi-Fowler's)</label>
                            <label class="checklist-item"><input type="checkbox"> Perform hand hygiene, apply sterile gloves</label>
                            <label class="checklist-item"><input type="checkbox"> Suction tracheostomy if needed (before cleaning)</label>
                            <label class="checklist-item"><input type="checkbox"> Remove inner cannula (if applicable)</label>
                            <label class="checklist-item"><input type="checkbox"> Clean inner cannula with sterile saline/hydrogen peroxide</label>
                            <label class="checklist-item"><input type="checkbox"> Rinse with sterile saline, dry with pipe cleaners</label>
                            <label class="checklist-item"><input type="checkbox"> Replace inner cannula and lock in place</label>
                            <label class="checklist-item"><input type="checkbox"> Clean stoma site with sterile saline, moving outward</label>
                            <label class="checklist-item"><input type="checkbox"> Apply pre-cut trach dressing (do not cut gauze)</label>
                            <label class="checklist-item"><input type="checkbox"> Change trach ties if soiled (two-person assist recommended)</label>
                            <label class="checklist-item"><input type="checkbox"> Ensure ties allow 1-2 finger breadth</label>
                            <label class="checklist-item"><input type="checkbox"> Document: stoma condition, secretions, patient tolerance</label>
                        </div>
                        <button onclick="clearChecklist('trach-checklist')" style="margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Reset Checklist</button>
                    </div>
                </div>

                <!-- Medication Timer -->
                <div class="card">
                    <h2>‚è±Ô∏è Med Pass Timer</h2>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Set reminders for medication rounds or patient checks</p>

                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="setMedTimer(15)" class="timer-preset">15 min</button>
                            <button onclick="setMedTimer(30)" class="timer-preset">30 min</button>
                            <button onclick="setMedTimer(60)" class="timer-preset">1 hour</button>
                            <button onclick="setMedTimer(120)" class="timer-preset">2 hours</button>
                        </div>

                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 13px; font-weight: 600;">Custom:</label>
                            <input type="number" id="customTimerMin" placeholder="Minutes" min="1" max="480" style="flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
                            <button onclick="setMedTimer(parseInt(document.getElementById('customTimerMin').value))" style="padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Set</button>
                        </div>

                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 13px; font-weight: 600;">Label:</label>
                            <input type="text" id="timerLabel" placeholder="e.g., Room 412 Pain Med" style="flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>

                    <!-- Active Timers -->
                    <div id="activeTimers" style="margin-top: 15px;"></div>

                    <p style="font-size: 11px; color: #888; margin-top: 15px;">
                        <strong>Note:</strong> Enable browser notifications for alerts when timer completes.
                        <button onclick="requestNotificationPermission()" style="background: none; border: none; color: var(--accent); text-decoration: underline; cursor: pointer; font-size: 11px;">Enable Notifications</button>
                    </p>
                </div>

                <!-- Additional Resources -->
                <div class="card">
                    <h2>üîó Additional Resources</h2>
                    <ul class="link-list">
                        <li><a href="https://www.nursingworld.org/" target="_blank">üè• American Nurses Association</a></li>
                        <li><a href="https://www.ncsbn.org/nclex.htm" target="_blank">üìö NCLEX Resources (NCSBN)</a></li>
                        <li><a href="https://www.cdc.gov/niosh/topics/bbp/" target="_blank">üß§ CDC Bloodborne Pathogens</a></li>
                        <li><a href="https://www.jointcommission.org/resources/patient-safety-topics/patient-safety/" target="_blank">‚öïÔ∏è Joint Commission Patient Safety</a></li>
                        <li><a href="https://www.ahrq.gov/patient-safety/index.html" target="_blank">üõ°Ô∏è AHRQ Patient Safety</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Lock Screen Overlay -->
    <div id="lockScreenOverlay">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px;">üîí</div>
            <h1 style="font-size: 42px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">BSN9B</h1>
            <p style="font-size: 18px; opacity: 0.8; margin-bottom: 40px;">Portal Locked</p>
            <button onclick="unlockScreen()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 18px 50px; border-radius: 30px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);">üîì Unlock Portal</button>
            <p style="margin-top: 30px; font-size: 12px; opacity: 0.5;">Click unlock to return to your session</p>
        </div>
    </div>

    <!-- Bottom Toolbar -->
    <nav class="bottom-toolbar" role="navigation" aria-label="Main navigation">
        <a href="/home/" class="toolbar-item" aria-label="Home">
            <span class="icon" aria-hidden="true">üè†</span>
            <span class="label">Home</span>
        </a>
        <a href="/app/" class="toolbar-item" aria-label="RN Notes">
            <span class="icon" aria-hidden="true">üìù</span>
            <span class="label">RN Notes</span>
        </a>
        <a href="/community/" class="toolbar-item" aria-label="Community">
            <span class="icon" aria-hidden="true">üë•</span>
            <span class="label">Community</span>
        </a>
        <a href="/resources/" class="toolbar-item active" aria-label="Resources" aria-current="page">
            <span class="icon" aria-hidden="true">üìö</span>
            <span class="label">Resources</span>
        </a>
        <button class="toolbar-item" onclick="toggleMoreMenu()" aria-label="More options" aria-expanded="false" aria-controls="moreMenu">
            <span class="icon" aria-hidden="true">‚ãØ</span>
            <span class="label">More</span>
        </button>
    </nav>

    <!-- More Menu -->
    <div id="moreMenu" class="more-menu" role="menu" aria-label="Additional options">
        <button class="more-menu-item" role="menuitem" onclick="toggleDarkMode(); toggleMoreMenu();">
            <span class="menu-icon" id="themeMenuIcon" aria-hidden="true">üåô</span>
            <span id="themeMenuText">Dark Mode</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="lockScreen(); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">üîí</span>
            <span>Lock Screen</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="toggleFullscreen(); toggleMoreMenu();" id="fullscreenBtn">
            <span class="menu-icon" aria-hidden="true" id="fullscreenIcon">‚õ∂</span>
            <span id="fullscreenText">Full Screen</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="document.getElementById('feedbackModal').classList.remove('hidden'); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">üí°</span>
            <span>Feedback</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="logout();">
            <span class="menu-icon" aria-hidden="true">üö™</span>
            <span>Logout</span>
        </button>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 20px;">üí° Send Feedback</h2>
                <button onclick="document.getElementById('feedbackModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
            </div>
            <form action="https://formsubmit.co/christiankholden@gmail.com" method="POST">
                <input type="hidden" name="_subject" value="BSN9B Feedback">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_template" value="table">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Type</label>
                <select name="type" required>
                    <option value="bug">üêõ Bug Report</option>
                    <option value="feature">‚ú® Feature Request</option>
                    <option value="feedback" selected>üìù General Feedback</option>
                </select>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Your Name</label>
                <input type="text" name="name" required placeholder="Enter your name">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Message</label>
                <textarea name="message" required placeholder="Describe your feedback..."></textarea>
                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Send Feedback</button>
            </form>
        </div>
    </div>

    <!-- AI Widget -->
    <div id="aiWidget" style="position: fixed; bottom: 80px; left: 20px; z-index: 999;">
        <button id="aiToggle" onclick="toggleAI()" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); border: none; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 24px; display: flex; align-items: center; justify-content: center; position: relative;">
            ü©∫
            <span style="position: absolute; top: -2px; left: -2px; background: #8b5cf6; color: white; border-radius: 4px; padding: 2px 5px; font-size: 9px; font-weight: bold;">AI</span>
        </button>
        <div id="aiBox" style="display: none; flex-direction: column; position: absolute; bottom: 70px; left: 0; width: 380px; height: 500px; background: var(--bg-primary); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden;">
            <div style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 700;">ü©∫ AI Nursing Assistant</span>
                <button onclick="toggleAI()" style="background: none; border: none; color: white; cursor: pointer; font-size: 18px;">&times;</button>
            </div>
            <div style="background: #fef3c7; padding: 8px 12px; font-size: 11px; color: #92400e;">‚ö†Ô∏è <strong>Educational Only:</strong> Not medical advice. Always verify with clinical resources.</div>
            <div style="padding: 10px; display: flex; gap: 6px; flex-wrap: wrap; border-bottom: 1px solid var(--border);">
                <button onclick="aiQuickAction('drug')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">üíä Drug Info</button>
                <button onclick="aiQuickAction('careplan')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">üìã Care Plan</button>
                <button onclick="aiQuickAction('nclex')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">üìù NCLEX Q</button>
                <button onclick="aiQuickAction('labs')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">üî¨ Labs</button>
            </div>
            <div id="aiMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: var(--bg-secondary);">
                <div style="background: var(--chat-msg-other-bg); padding: 10px 14px; border-radius: 16px; margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">Hi! I'm your AI nursing assistant. Ask me about medications, care plans, NCLEX questions, or lab values. How can I help you today?</div>
            </div>
            <form onsubmit="sendAIMessage(event)" style="padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; background: var(--bg-primary);">
                <input type="text" id="aiInput" placeholder="Ask a nursing question..." style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 20px; font-size: 14px; background: var(--bg-input); color: var(--text-primary);">
                <button type="submit" style="background: linear-gradient(135deg, #0d9488, #14b8a6); color: white; border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer;">Ask</button>
            </form>
        </div>
    </div>

    <footer>
        BSN9B Nursing Resources
    </footer>

    <script>
        // Display current user
        const currentUsername = localStorage.getItem('bsn9b_user');
        if (currentUsername) {
            document.getElementById('userDisplay').textContent = 'Logged in as: ' + currentUsername;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('bsn9b_auth');
            localStorage.removeItem('bsn9b_user');
            localStorage.removeItem('bsn9b_displayName');
            localStorage.removeItem('bsn9b_uid');
            window.location.href = '/';
        }

        // Theme functions
        function initTheme() {
            const saved = localStorage.getItem('bsn9b_theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcon();
        }
        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('bsn9b_theme', newTheme);
            updateThemeIcon();
        }
        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const themeMenuIcon = document.getElementById('themeMenuIcon');
            const themeMenuText = document.getElementById('themeMenuText');
            if (themeMenuIcon) {
                themeMenuIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            }
            if (themeMenuText) {
                themeMenuText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            }
        }

        // More menu toggle
        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const isExpanded = menu.classList.toggle('show');
            if (moreBtn) {
                moreBtn.setAttribute('aria-expanded', isExpanded);
            }
        }

        // Close more menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const moreBtnClicked = e.target.closest('.toolbar-item');
            if (!menu.contains(e.target) && (!moreBtnClicked || !moreBtnClicked.onclick?.toString().includes('toggleMoreMenu'))) {
                menu.classList.remove('show');
                if (moreBtn) {
                    moreBtn.setAttribute('aria-expanded', 'false');
                }
            }
        });

        initTheme();

        // Lock functions
        function lockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'flex';
        }
        function unlockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'none';
        }

        // ========== AI NURSING COMPANION ==========
        const AI_API_URL = 'https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec';
        let aiOpen = false;
        let aiConversation = [];

        const AI_SYSTEM_PROMPT = `You are a helpful nursing education assistant for BSN nursing students. Your role is to:
- Explain nursing concepts, procedures, and pathophysiology clearly
- Provide drug information including mechanism, side effects, and nursing considerations
- Help develop care plans using NANDA-I diagnoses, NIC interventions, and NOC outcomes
- Generate NCLEX-style practice questions with detailed rationales
- Explain lab values and their clinical significance
- Guide through clinical scenarios and critical thinking

Important guidelines:
- Always emphasize this is for EDUCATIONAL purposes only, not actual patient care
- Encourage students to verify information with their instructors and official resources
- Be concise but thorough - nursing students are busy
- Use proper medical terminology while explaining in accessible terms
- When discussing medications, always mention common nursing considerations
- For NCLEX questions, provide the answer AND detailed rationales for all options`;

        function toggleAI() {
            aiOpen = !aiOpen;
            const aiBox = document.getElementById('aiBox');
            if (aiOpen) {
                aiBox.style.display = 'flex';
                document.getElementById('aiInput').focus();
            } else {
                aiBox.style.display = 'none';
            }
            document.getElementById('aiToggle').style.transform = aiOpen ? 'scale(0.9)' : 'scale(1)';
        }

        function aiQuickAction(type) {
            const input = document.getElementById('aiInput');
            switch(type) {
                case 'drug':
                    input.value = 'Tell me about the medication: ';
                    input.focus();
                    break;
                case 'careplan':
                    input.value = 'Help me create a care plan for a patient with: ';
                    input.focus();
                    break;
                case 'nclex':
                    input.value = 'Give me an NCLEX practice question about: ';
                    input.focus();
                    break;
                case 'labs':
                    input.value = 'Explain the lab value and nursing implications: ';
                    input.focus();
                    break;
            }
        }

        function addAIMessage(text, isUser) {
            const container = document.getElementById('aiMessages');
            const msgDiv = document.createElement('div');
            msgDiv.style.cssText = `
                margin-bottom: 12px;
                display: flex;
                flex-direction: column;
                align-items: ${isUser ? 'flex-end' : 'flex-start'};
            `;

            // Format AI responses with markdown-like styling
            let formattedText = text;
            if (!isUser) {
                // Convert **bold** to <strong>
                formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Convert bullet points
                formattedText = formattedText.replace(/^[\-\‚Ä¢]\s/gm, '‚Ä¢ ');
                // Convert newlines to <br>
                formattedText = formattedText.replace(/\n/g, '<br>');
            }

            msgDiv.innerHTML = `
                <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${isUser ? 'You' : 'ü©∫ AI Assistant'}</div>
                <div style="background: ${isUser ? 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)' : 'linear-gradient(135deg, #0d9488 0%, #14b8a6 100%)'}; color: white; padding: 12px 16px; border-radius: ${isUser ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 90%; word-wrap: break-word; font-size: 14px; line-height: 1.5;">
                    ${isUser ? text.replace(/</g, '&lt;').replace(/>/g, '&gt;') : formattedText}
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showAITyping() {
            const container = document.getElementById('aiMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'aiTyping';
            typingDiv.style.cssText = 'margin-bottom: 12px; display: flex; flex-direction: column; align-items: flex-start;';
            typingDiv.innerHTML = `
                <div style="font-size: 10px; color: #888; margin-bottom: 3px;">ü©∫ AI Assistant</div>
                <div style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 12px 16px; border-radius: 16px 16px 16px 4px; font-size: 14px;">
                    <span class="typing-dots">Thinking<span>.</span><span>.</span><span>.</span></span>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function hideAITyping() {
            const typing = document.getElementById('aiTyping');
            if (typing) typing.remove();
        }

        async function sendAIMessage(event) {
            event.preventDefault();
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            const sendBtn = document.querySelector('#aiBox button[type="submit"]');

            if (!message) return;

            // Add user message to UI
            addAIMessage(message, true);
            input.value = '';
            if (sendBtn) sendBtn.disabled = true;

            // Add to conversation history
            aiConversation.push({ role: 'user', content: message });

            // Show typing indicator
            showAITyping();

            try {
                const response = await fetch(AI_API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        messages: aiConversation,
                        systemPrompt: AI_SYSTEM_PROMPT
                    })
                });

                const data = await response.json();
                hideAITyping();

                if (data.success && data.response) {
                    addAIMessage(data.response, false);
                    aiConversation.push({ role: 'assistant', content: data.response });

                    // Keep conversation history manageable (last 10 exchanges)
                    if (aiConversation.length > 20) {
                        aiConversation = aiConversation.slice(-20);
                    }
                } else {
                    addAIMessage('Sorry, I encountered an error. Please try again. ' + (data.error || ''), false);
                }
            } catch (error) {
                hideAITyping();
                console.error('AI API Error:', error);
                addAIMessage('Sorry, I could not connect to the AI service. Please check your connection and try again.', false);
            }

            if (sendBtn) sendBtn.disabled = false;
            input.focus();
        }

        // Add typing animation CSS
        const aiStyle = document.createElement('style');
        aiStyle.textContent = `
            .typing-dots span {
                animation: blink 1.4s infinite;
                animation-fill-mode: both;
            }
            .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
            .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
            @keyframes blink {
                0%, 80%, 100% { opacity: 0; }
                40% { opacity: 1; }
            }
        `;
        document.head.appendChild(aiStyle);

        // Drug lookup state
        let drugSearchTimeout = null;

        // Smart Drug Search - combines spelling suggestions + approximate matching
        async function smartDrugSearch(query, dropdownId, onSelect) {
            const dropdown = document.getElementById(dropdownId);

            if (query.length < 2) {
                dropdown.classList.remove('show');
                return;
            }

            dropdown.innerHTML = '<div class="drug-autocomplete-loading">Searching...</div>';
            dropdown.classList.add('show');

            try {
                // Use multiple search strategies for better results
                const results = new Map(); // Use Map to deduplicate by rxcui

                // 1. Spelling suggestions (helps with typos like "metforman" -> "metformin")
                const spellResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/spellingsuggestions.json?name=${encodeURIComponent(query)}`);
                const spellData = await spellResponse.json();

                if (spellData.suggestionGroup?.suggestionList?.suggestion) {
                    // Get RxCUI for each spelling suggestion
                    for (const suggestion of spellData.suggestionGroup.suggestionList.suggestion.slice(0, 5)) {
                        const rxcuiResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/rxcui.json?name=${encodeURIComponent(suggestion)}`);
                        const rxcuiData = await rxcuiResponse.json();
                        if (rxcuiData.idGroup?.rxnormId?.[0]) {
                            results.set(rxcuiData.idGroup.rxnormId[0], {
                                rxcui: rxcuiData.idGroup.rxnormId[0],
                                name: suggestion,
                                type: 'exact'
                            });
                        }
                    }
                }

                // 2. Approximate term matching (fuzzy search)
                const approxResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/approximateTerm.json?term=${encodeURIComponent(query)}&maxEntries=15`);
                const approxData = await approxResponse.json();

                if (approxData.approximateGroup?.candidate) {
                    approxData.approximateGroup.candidate.forEach(c => {
                        if (c.rxcui && c.name && !results.has(c.rxcui)) {
                            results.set(c.rxcui, {
                                rxcui: c.rxcui,
                                name: c.name,
                                type: c.rank > 50 ? 'close' : 'approx'
                            });
                        }
                    });
                }

                // 3. Direct drug search as fallback
                const drugResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/drugs.json?name=${encodeURIComponent(query)}`);
                const drugData = await drugResponse.json();

                if (drugData.drugGroup?.conceptGroup) {
                    drugData.drugGroup.conceptGroup.forEach(group => {
                        if (group.conceptProperties) {
                            group.conceptProperties.slice(0, 10).forEach(prop => {
                                if (!results.has(prop.rxcui)) {
                                    results.set(prop.rxcui, {
                                        rxcui: prop.rxcui,
                                        name: prop.name,
                                        type: 'brand'
                                    });
                                }
                            });
                        }
                    });
                }

                // Build dropdown HTML
                const resultArray = Array.from(results.values()).slice(0, 12);

                if (resultArray.length === 0) {
                    dropdown.innerHTML = '<div class="drug-autocomplete-loading">No matches found. Try different spelling.</div>';
                } else {
                    let html = '';
                    if (query.length >= 2 && spellData.suggestionGroup?.suggestionList?.suggestion?.[0] !== query) {
                        const topSuggestion = spellData.suggestionGroup?.suggestionList?.suggestion?.[0];
                        if (topSuggestion && topSuggestion.toLowerCase() !== query.toLowerCase()) {
                            html += `<div class="drug-autocomplete-hint">Did you mean: <strong>${topSuggestion}</strong>?</div>`;
                        }
                    }
                    resultArray.forEach(drug => {
                        const escapedName = drug.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        html += `<div class="drug-autocomplete-item" onclick="${onSelect}('${drug.rxcui}', '${escapedName}')">${drug.name}</div>`;
                    });
                    dropdown.innerHTML = html;
                }
            } catch (error) {
                console.error('Drug search error:', error);
                dropdown.innerHTML = '<div class="drug-autocomplete-loading">Search error. Try again.</div>';
            }
        }

        // Drug Information search input handler
        document.getElementById('drugSearch').addEventListener('input', function() {
            clearTimeout(drugSearchTimeout);
            const query = this.value.trim();

            if (query.length < 2) {
                document.getElementById('drugSearchDropdown').classList.remove('show');
                return;
            }

            drugSearchTimeout = setTimeout(() => {
                smartDrugSearch(query, 'drugSearchDropdown', 'selectDrugInfo');
            }, 300);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.drug-search-wrapper')) {
                document.getElementById('drugSearchDropdown').classList.remove('show');
            }
        });

        // Select drug for information display
        async function selectDrugInfo(rxcui, name) {
            document.getElementById('drugSearchDropdown').classList.remove('show');
            document.getElementById('drugSearch').value = name;

            const infoDiv = document.getElementById('drugInfo');
            document.getElementById('drugInfoName').textContent = name;
            document.getElementById('drugInfoDetails').innerHTML = '<p>Loading details...</p>';
            infoDiv.style.display = 'block';

            // Set external links
            document.getElementById('drugLinkDailyMed').href = `https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(name)}`;
            document.getElementById('drugLinkDrugs').href = `https://www.drugs.com/search.php?searchterm=${encodeURIComponent(name)}`;

            try {
                // Get drug class info
                const classResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/rxclass/class/byRxcui.json?rxcui=${rxcui}`);
                const classData = await classResponse.json();

                let details = '';

                if (classData.rxclassDrugInfoList && classData.rxclassDrugInfoList.rxclassDrugInfo) {
                    const classes = classData.rxclassDrugInfoList.rxclassDrugInfo;
                    const uniqueClasses = [...new Set(classes.map(c => c.rxclassMinConceptItem.className))].slice(0, 5);
                    if (uniqueClasses.length > 0) {
                        details += `<p><strong>Drug Class:</strong> ${uniqueClasses.join(', ')}</p>`;
                    }
                }

                // Get related drugs (brand names)
                const relatedResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/rxcui/${rxcui}/related.json?tty=BN`);
                const relatedData = await relatedResponse.json();

                if (relatedData.relatedGroup && relatedData.relatedGroup.conceptGroup) {
                    const brands = relatedData.relatedGroup.conceptGroup
                        .filter(g => g.conceptProperties)
                        .flatMap(g => g.conceptProperties.map(p => p.name))
                        .slice(0, 5);
                    if (brands.length > 0) {
                        details += `<p><strong>Brand Names:</strong> ${brands.join(', ')}</p>`;
                    }
                }

                details += `<p><strong>RxCUI:</strong> ${rxcui}</p>`;
                document.getElementById('drugInfoDetails').innerHTML = details || '<p>Basic info only. Click links below for full details.</p>';

            } catch (error) {
                document.getElementById('drugInfoDetails').innerHTML = '<p>Could not load details. Use links below.</p>';
            }
        }

        function calculateDripRate() {
            const volume = parseFloat(document.getElementById('ivVolume').value);
            const time = parseFloat(document.getElementById('ivTime').value);
            const dropFactor = parseFloat(document.getElementById('ivDropFactor').value);
            const result = document.getElementById('dripResult');

            if (!volume || !time || !dropFactor) {
                result.innerHTML = '<span style="color: #c00;">Please enter all values</span>';
                result.style.display = 'block';
                return;
            }

            if (time <= 0) {
                result.innerHTML = '<span style="color: #c00;">Time must be greater than 0</span>';
                result.style.display = 'block';
                return;
            }

            // IV Drip Rate Formula: gtt/min = (Volume mL √ó Drop Factor) √∑ (Time in min)
            const mlPerHour = volume / time;
            const gttsPerMin = (volume * dropFactor) / (time * 60);

            result.innerHTML = `
                <strong>Flow Rate:</strong> ${mlPerHour.toFixed(1)} mL/hr<br>
                <strong>Drip Rate:</strong> ${Math.round(gttsPerMin)} gtt/min<br>
                <span style="font-size: 11px; color: #666;">Formula: (${volume} mL √ó ${dropFactor} gtt/mL) √∑ (${time} hr √ó 60 min)</span>
            `;
            result.style.display = 'block';
        }

        function calculateDosage() {
            const desired = parseFloat(document.getElementById('desiredDose').value);
            const have = parseFloat(document.getElementById('haveOnHand').value);
            const qty = parseFloat(document.getElementById('quantity').value);
            const unit = document.getElementById('quantityUnit').value;
            const result = document.getElementById('dosageResult');

            if (!desired || !have || !qty) {
                result.innerHTML = '<span style="color: #c00;">Please enter all values</span>';
                result.style.display = 'block';
                return;
            }

            if (have <= 0) {
                result.innerHTML = '<span style="color: #c00;">"Have on Hand" must be greater than 0</span>';
                result.style.display = 'block';
                return;
            }

            // D/H √ó Q Formula
            const give = (desired / have) * qty;

            result.innerHTML = `
                <strong>Administer:</strong> ${give.toFixed(2)} ${unit}(s)<br>
                <span style="font-size: 11px; color: #666;">Formula: (${desired} mg √∑ ${have} mg) √ó ${qty} ${unit}</span>
            `;
            result.style.display = 'block';
        }

        function calculateWeightDose() {
            const mgPerKg = parseFloat(document.getElementById('mgPerKg').value);
            let weight = parseFloat(document.getElementById('patientWeight').value);
            const weightUnit = document.getElementById('weightUnit').value;
            const result = document.getElementById('weightDoseResult');

            if (!mgPerKg || !weight) {
                result.innerHTML = '<span style="color: #c00;">Please enter all values</span>';
                result.style.display = 'block';
                return;
            }

            // Convert lbs to kg if needed (1 lb = 0.453592 kg)
            let weightInKg = weight;
            if (weightUnit === 'lb') {
                weightInKg = weight * 0.453592;
            }

            const totalDose = mgPerKg * weightInKg;

            result.innerHTML = `
                <strong>Total Dose:</strong> ${totalDose.toFixed(1)} mg<br>
                ${weightUnit === 'lb' ? `<span style="font-size: 11px; color: #666;">Patient weight: ${weightInKg.toFixed(1)} kg (${weight} lb)</span><br>` : ''}
                <span style="font-size: 11px; color: #666;">Formula: ${mgPerKg} mg/kg √ó ${weightInKg.toFixed(1)} kg</span>
            `;
            result.style.display = 'block';
        }

        function toggleCollapse(element) {
            element.classList.toggle('collapsed');
            const content = element.nextElementSibling;
            content.classList.toggle('hidden');
        }

        function clearChecklist(checklistId) {
            const checklist = document.getElementById(checklistId);
            if (checklist) {
                checklist.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
                showToast('Checklist reset', 'info');
            }
        }

        // ========== MED PASS TIMER ==========
        let activeTimers = [];
        let timerIdCounter = 0;

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('Notifications enabled!', 'success');
                    } else {
                        showToast('Notifications blocked. Enable in browser settings.', 'warning');
                    }
                });
            } else {
                showToast('Browser does not support notifications', 'error');
            }
        }

        function setMedTimer(minutes) {
            if (!minutes || minutes < 1 || minutes > 480) {
                showToast('Please enter a valid time (1-480 minutes)', 'warning');
                return;
            }

            const label = document.getElementById('timerLabel').value.trim() || 'Med Timer';
            const timerId = ++timerIdCounter;
            const endTime = Date.now() + (minutes * 60 * 1000);

            const timer = {
                id: timerId,
                label: label,
                endTime: endTime,
                interval: null
            };

            timer.interval = setInterval(() => updateTimer(timerId), 1000);
            activeTimers.push(timer);

            document.getElementById('timerLabel').value = '';
            document.getElementById('customTimerMin').value = '';

            renderTimers();
            showToast(`Timer set for ${minutes} minute${minutes > 1 ? 's' : ''}`, 'success');
        }

        function updateTimer(timerId) {
            const timer = activeTimers.find(t => t.id === timerId);
            if (!timer) return;

            const remaining = timer.endTime - Date.now();

            if (remaining <= 0) {
                // Timer complete
                clearInterval(timer.interval);
                activeTimers = activeTimers.filter(t => t.id !== timerId);
                renderTimers();

                // Show notification
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Med Timer Complete', {
                        body: timer.label,
                        icon: '/icons/icon-192.png',
                        tag: 'med-timer-' + timerId,
                        requireInteraction: true
                    });
                }

                // Play sound and show toast
                playTimerSound();
                showToast(`Timer complete: ${timer.label}`, 'success', 10000);
            } else {
                renderTimers();
            }
        }

        function cancelTimer(timerId) {
            const timer = activeTimers.find(t => t.id === timerId);
            if (timer) {
                clearInterval(timer.interval);
                activeTimers = activeTimers.filter(t => t.id !== timerId);
                renderTimers();
                showToast('Timer cancelled', 'info');
            }
        }

        function renderTimers() {
            const container = document.getElementById('activeTimers');
            if (!container) return;

            if (activeTimers.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = activeTimers.map(timer => {
                const remaining = Math.max(0, timer.endTime - Date.now());
                const mins = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                return `
                    <div class="active-timer">
                        <div class="timer-info">
                            <div class="timer-label">${escapeHtml(timer.label)}</div>
                            <div class="timer-countdown">${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}</div>
                        </div>
                        <button class="timer-cancel" onclick="cancelTimer(${timer.id})">Cancel</button>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function playTimerSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                oscillator.start();
                setTimeout(() => { oscillator.stop(); }, 200);
                setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    osc2.connect(gainNode);
                    osc2.frequency.value = 1000;
                    osc2.type = 'sine';
                    osc2.start();
                    setTimeout(() => osc2.stop(), 200);
                }, 300);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // APGAR Calculator
        function calculateAPGAR() {
            const appearance = parseInt(document.getElementById('apgar-appearance').value) || 0;
            const pulse = parseInt(document.getElementById('apgar-pulse').value) || 0;
            const grimace = parseInt(document.getElementById('apgar-grimace').value) || 0;
            const activity = parseInt(document.getElementById('apgar-activity').value) || 0;
            const respiration = parseInt(document.getElementById('apgar-respiration').value) || 0;

            const score = appearance + pulse + grimace + activity + respiration;
            document.getElementById('apgar-score').textContent = score;

            let interpretation = '';
            if (score >= 7) {
                interpretation = '(Normal - reassuring)';
            } else if (score >= 4) {
                interpretation = '(Moderately abnormal - needs intervention)';
            } else {
                interpretation = '(Critically low - immediate resuscitation)';
            }
            document.getElementById('apgar-interpretation').textContent = interpretation;
        }

        // ========== SBAR HANDOFF GENERATOR ==========
        function generateSBARHandoff() {
            const patient = document.getElementById('sbar-patient').value.trim();
            const reason = document.getElementById('sbar-reason').value.trim();
            const diagnosis = document.getElementById('sbar-diagnosis').value.trim();
            const history = document.getElementById('sbar-history').value.trim();
            const meds = document.getElementById('sbar-meds').value.trim();
            const vitals = document.getElementById('sbar-vitals').value.trim();
            const neuro = document.getElementById('sbar-neuro').value.trim();
            const io = document.getElementById('sbar-io').value.trim();
            const concerns = document.getElementById('sbar-concerns').value.trim();
            const pending = document.getElementById('sbar-pending').value.trim();
            const followup = document.getElementById('sbar-followup').value.trim();
            const priority = document.getElementById('sbar-priority').value.trim();

            if (!patient) {
                showToast('Please enter patient name and room', 'warning');
                return;
            }

            let output = `SBAR SHIFT HANDOFF REPORT
${'='.repeat(40)}

S - SITUATION
Patient: ${patient || 'N/A'}
Reason: ${reason || 'End of shift handoff'}

B - BACKGROUND
Diagnosis: ${diagnosis || 'N/A'}
Relevant History: ${history || 'N/A'}
Key Medications/IVs: ${meds || 'N/A'}

A - ASSESSMENT
Vitals: ${vitals || 'N/A'}
Neuro/LOC: ${neuro || 'N/A'}
I&O: ${io || 'N/A'}
Current Concerns: ${concerns || 'None noted'}

R - RECOMMENDATION
Pending Tests/Procedures: ${pending || 'None'}
Follow-up Actions: ${followup || 'Continue current plan of care'}
Priority for Next Shift: ${priority || 'Monitor as per orders'}

${'='.repeat(40)}
Generated: ${new Date().toLocaleString()}`;

            document.getElementById('sbar-text').textContent = output;
            document.getElementById('sbar-output').style.display = 'block';
            showToast('SBAR handoff generated!', 'success');
        }

        function clearSBARForm() {
            const inputs = document.querySelectorAll('#sbarForm input');
            inputs.forEach(input => input.value = '');
            document.getElementById('sbar-output').style.display = 'none';
            showToast('Form cleared', 'info');
        }

        function copySBARHandoff() {
            const text = document.getElementById('sbar-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Copied to clipboard!', 'success');
            });
        }
    </script>

    <!-- Chat Widget with DM Support -->
    <div id="chatWidget" style="position: fixed; bottom: 80px; right: 20px; z-index: 999; font-family: 'Segoe UI', sans-serif;">
        <!-- Chat Toggle Button -->
        <button id="chatToggle" onclick="toggleChat()" aria-label="Open chat" aria-expanded="false" aria-controls="chatBox" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 24px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;">
            <span aria-hidden="true">üí¨</span>
        </button>
        <span id="chatBadge" aria-live="polite" style="display: none; position: absolute; top: -5px; right: -5px; background: #e94560; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center;">0</span>
        <!-- DM Badge (separate from group chat) -->
        <span id="dmBadge" aria-live="polite" style="display: none; position: absolute; top: -5px; left: -5px; background: #8b5cf6; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center;">0</span>

        <!-- Chat Box -->
        <div id="chatBox" role="dialog" aria-label="Chat window" aria-modal="false" style="display: none; flex-direction: column; position: absolute; bottom: 70px; right: 0; width: 350px; height: 500px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden;">
            <!-- Chat Header -->
            <div style="background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; padding: 12px 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong id="chatTitle" style="font-size: 16px;">BSN9B Chat</strong>
                        <div id="onlineCount" onclick="toggleUserList()" style="font-size: 11px; opacity: 0.8; cursor: pointer;">Connecting...</div>
                    </div>
                    <div style="display: flex; gap: 6px; align-items: center;">
                        <button id="soundToggleBtn" onclick="toggleChatSound()" aria-label="Toggle sound notifications" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 14px;"><span aria-hidden="true">üîî</span></button>
                        <button id="notificationToggleBtn" onclick="toggleBrowserNotifications()" aria-label="Toggle browser notifications" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 14px;"><span aria-hidden="true">üìµ</span></button>
                        <button onclick="toggleChat()" aria-label="Close chat" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 16px;"><span aria-hidden="true">√ó</span></button>
                    </div>
                </div>
                <!-- Chat Mode Tabs -->
                <div role="tablist" aria-label="Chat mode" style="display: flex; gap: 8px; margin-top: 10px;">
                    <button id="tabGroupChat" role="tab" aria-selected="true" aria-controls="groupChatView" onclick="switchChatMode('group')" style="flex: 1; padding: 8px; border: none; border-radius: 8px; background: rgba(255,255,255,0.3); color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <span aria-hidden="true">üë•</span> Group
                    </button>
                    <button id="tabDM" role="tab" aria-selected="false" aria-controls="dmView" onclick="switchChatMode('dm')" style="flex: 1; padding: 8px; border: none; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <span aria-hidden="true">‚úâÔ∏è</span> Direct <span id="dmTabBadge" style="display: none; background: #8b5cf6; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 4px;">0</span>
                    </button>
                </div>
            </div>

            <!-- Online Users List (toggleable) -->
            <div id="userList" style="display: none; background: #1a3d5c; color: white; padding: 10px 15px; font-size: 12px; max-height: 100px; overflow-y: auto;">
                <div style="opacity: 0.7; margin-bottom: 5px;">Online now:</div>
                <div id="userListNames"></div>
            </div>

            <!-- GROUP CHAT VIEW -->
            <div id="groupChatView" role="tabpanel" aria-labelledby="tabGroupChat" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <!-- Chat Messages -->
                <div id="chatMessages" role="log" aria-live="polite" aria-label="Chat messages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
                    <p style="text-align: center; color: #888; font-size: 12px;">Loading messages...</p>
                </div>

                <!-- Chat Input -->
                <div style="padding: 12px; border-top: 1px solid #e2e8f0; background: white; position: relative;">
                    <!-- @Mention Autocomplete Dropdown -->
                    <div id="mentionDropdown" role="listbox" aria-label="Mention suggestions" style="display: none; position: absolute; bottom: 100%; left: 12px; right: 60px; background: white; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 -4px 15px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; z-index: 100;"></div>
                    <form onsubmit="sendMessage(event)" style="display: flex; gap: 8px;">
                        <input type="text" id="chatInput" aria-label="Chat message input" placeholder="Type @ to mention someone..." style="flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none;" maxlength="500" autocomplete="off">
                        <button type="submit" aria-label="Send message" style="background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 16px;"><span aria-hidden="true">‚û§</span></button>
                    </form>
                </div>
            </div>

            <!-- DM VIEW -->
            <div id="dmView" role="tabpanel" aria-labelledby="tabDM" style="flex: 1; display: none; flex-direction: column; overflow: hidden;">
                <!-- DM Conversation List (shows when no conversation selected) -->
                <div id="dmConversationList" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
                    <div style="margin-bottom: 15px;">
                        <button onclick="showNewDMSelector()" aria-label="Start new direct message" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            <span aria-hidden="true">‚úèÔ∏è</span> New Message
                        </button>
                    </div>
                    <div id="dmConversations" style="color: #888; font-size: 12px; text-align: center;">
                        Loading conversations...
                    </div>
                </div>

                <!-- DM Messages View (shows when conversation selected) -->
                <div id="dmMessageView" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                    <!-- DM Header with back button -->
                    <div id="dmHeader" style="padding: 10px 15px; background: #f0f7ff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px;">
                        <button onclick="closeDMConversation()" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px;">‚Üê</button>
                        <span id="dmPartnerName" style="font-weight: 600; color: #1f4e79;">Partner Name</span>
                        <span id="dmPartnerStatus" style="font-size: 10px; padding: 2px 8px; border-radius: 10px; background: #e2e8f0; color: #666;">offline</span>
                    </div>
                    <!-- DM Messages -->
                    <div id="dmMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
                    </div>
                    <!-- DM Input -->
                    <div style="padding: 12px; border-top: 1px solid #e2e8f0; background: white;">
                        <form onsubmit="sendDM(event)" style="display: flex; gap: 8px;">
                            <input type="text" id="dmInput" placeholder="Type a message..." style="flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none;" maxlength="500" autocomplete="off">
                            <button type="submit" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 16px;">‚û§</button>
                        </form>
                    </div>
                </div>

                <!-- New DM User Selector -->
                <div id="newDMSelector" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                    <div style="padding: 10px 15px; background: #f0f7ff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px;">
                        <button onclick="hideNewDMSelector()" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px;">‚Üê</button>
                        <span style="font-weight: 600; color: #1f4e79;">New Message</span>
                    </div>
                    <div style="padding: 15px;">
                        <input type="text" id="dmUserSearch" placeholder="Search users..." oninput="filterDMUsers()" style="width: 100%; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none; margin-bottom: 15px;">
                    </div>
                    <div id="dmUserList" style="flex: 1; overflow-y: auto; padding: 0 15px 15px 15px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== FULLSCREEN MODE ==========
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                const elem = document.documentElement;
                if (elem.requestFullscreen) elem.requestFullscreen();
                else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                updateFullscreenUI(true);
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                updateFullscreenUI(false);
            }
        }
        function updateFullscreenUI(isFullscreen) {
            const text = document.getElementById('fullscreenText');
            if (text) text.textContent = isFullscreen ? 'Exit Full Screen' : 'Full Screen';
        }
        document.addEventListener('fullscreenchange', () => updateFullscreenUI(!!document.fullscreenElement));
        document.addEventListener('webkitfullscreenchange', () => updateFullscreenUI(!!document.webkitFullscreenElement));

        // ========== TOAST NOTIFICATION SYSTEM ==========
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content"><div class="toast-message">${message.replace(/\n/g, '<br>')}</div></div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, duration);
        }

        const firebaseConfig = {
            apiKey: "AIzaSyAmr2W8mekSPJ2pXM3gz1FvarfSBddpfLM",
            authDomain: "bendbsn-17377.firebaseapp.com",
            databaseURL: "https://bendbsn-17377-default-rtdb.firebaseio.com",
            projectId: "bendbsn-17377",
            storageBucket: "bendbsn-17377.firebasestorage.app",
            messagingSenderId: "762882187702",
            appId: "1:762882187702:web:81c97c9eae005666796117"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ========== CHAT SYSTEM (INLINE FROM /app/) ==========
        const chatRef = database.ref('chat/messages');
        const presenceRef = database.ref('chat/presence');
        const bannedRef = database.ref('banned');
        const announcementsRef = database.ref('announcements');

        // Listen for announcements (alert/fyi banners - inside header)
        function setupAnnouncementListener() {
            announcementsRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                const alertBanner = document.getElementById('alertBanner');
                const fyiBanner = document.getElementById('fyiBanner');
                const alertText = document.getElementById('alertText');
                const fyiText = document.getElementById('fyiText');

                // Handle alert banner
                if (data.alert && data.alert.message) {
                    alertText.textContent = data.alert.message;
                    alertBanner.style.display = 'block';
                    document.body.classList.add('has-alert');
                } else {
                    alertBanner.style.display = 'none';
                    document.body.classList.remove('has-alert');
                }

                // Handle FYI banner (offset if alert is showing)
                if (data.fyi && data.fyi.message) {
                    fyiText.textContent = data.fyi.message;
                    fyiBanner.style.display = 'block';
                    fyiBanner.style.top = (data.alert && data.alert.message) ? '50px' : '0';
                    document.body.classList.add('has-fyi');
                } else {
                    fyiBanner.style.display = 'none';
                    document.body.classList.remove('has-fyi');
                }
            });
        }
        setupAnnouncementListener();
        console.log('Firebase initialized, chatRef path:', chatRef.toString());

        // Get display name (first name) - stored when user logs in
        const chatCurrentUsername = localStorage.getItem('bsn9b_user') || 'Anonymous';
        const chatDisplayName = localStorage.getItem('bsn9b_displayName') || chatCurrentUsername;

        // Verify Firebase Auth state and re-authenticate if needed
        let firebaseAuthReady = false;
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Firebase Auth: Logged in as', user.email);
                firebaseAuthReady = true;
            } else {
                console.log('Firebase Auth: Not logged in, attempting silent re-auth...');
                if (localStorage.getItem('bsn9b_auth') === 'true') {
                    console.warn('Session exists but Firebase auth lost - may need to re-login');
                }
            }
        });

        // Check if current user is banned
        function checkIfBanned() {
            bannedRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const banned = child.val();
                    if (banned.username === chatCurrentUsername || banned.username === chatDisplayName) {
                        showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                        localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                        setTimeout(() => { window.location.href = '/'; }, 2000);
                    }
                });
            });
        }
        checkIfBanned();

        // Listen for bans in real-time
        bannedRef.on('child_added', (snapshot) => {
            const banned = snapshot.val();
            if (banned.username === chatCurrentUsername || banned.username === chatDisplayName) {
                showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                setTimeout(() => { window.location.href = '/'; }, 2000);
            }
        });

        // Chat state
        let chatOpen = false;
        let unreadCount = 0;
        let lastReadTimestamp = parseInt(localStorage.getItem('chatLastRead') || '0');

        // Notification preferences (sound ON by default, browser notifications OFF by default)
        let soundEnabled = localStorage.getItem('chatSoundEnabled') !== 'false';
        let notificationsEnabled = localStorage.getItem('chatNotificationsEnabled') === 'true';

        // Audio notification using Web Audio API
        function playNotificationSound() {
            if (!soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio notification not available:', e);
            }
        }

        // Toggle sound notifications
        function toggleChatSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('chatSoundEnabled', soundEnabled.toString());
            updateSoundToggleUI();
        }

        function updateSoundToggleUI() {
            const btn = document.getElementById('soundToggleBtn');
            if (btn) {
                btn.innerHTML = soundEnabled ? 'üîî' : 'üîï';
                btn.title = soundEnabled ? 'Sound ON (click to mute)' : 'Sound OFF (click to unmute)';
            }
        }

        // Browser Notifications
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Browser does not support notifications');
                return false;
            }

            if (Notification.permission === 'granted') {
                notificationsEnabled = true;
                localStorage.setItem('chatNotificationsEnabled', 'true');
                updateNotificationToggleUI();
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationsEnabled = true;
                    localStorage.setItem('chatNotificationsEnabled', 'true');
                    updateNotificationToggleUI();
                    return true;
                }
            }

            notificationsEnabled = false;
            localStorage.setItem('chatNotificationsEnabled', 'false');
            updateNotificationToggleUI();
            return false;
        }

        function sendBrowserNotification(message) {
            if (!notificationsEnabled || Notification.permission !== 'granted') return;
            if (document.hasFocus() && chatOpen) return;

            try {
                const notification = new Notification('BSN9B Chat', {
                    body: `${message.user}: ${message.text.substring(0, 100)}${message.text.length > 100 ? '...' : ''}`,
                    tag: 'bsn9b-chat',
                    requireInteraction: false
                });

                notification.onclick = function() {
                    window.focus();
                    if (!chatOpen) toggleChat();
                    notification.close();
                };

                setTimeout(() => notification.close(), 5000);
            } catch (e) {
                console.log('Notification error:', e);
            }
        }

        function toggleBrowserNotifications() {
            if (notificationsEnabled) {
                notificationsEnabled = false;
                localStorage.setItem('chatNotificationsEnabled', 'false');
                updateNotificationToggleUI();
            } else {
                requestNotificationPermission();
            }
        }

        function updateNotificationToggleUI() {
            const btn = document.getElementById('notificationToggleBtn');
            if (btn) {
                btn.innerHTML = notificationsEnabled ? 'üì≤' : 'üìµ';
                btn.title = notificationsEnabled ? 'Browser notifications ON' : 'Browser notifications OFF (click to enable)';
            }
        }

        // Initialize notification UI on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSoundToggleUI();
            updateNotificationToggleUI();
        });

        // Toggle chat
        function toggleChat() {
            chatOpen = !chatOpen;
            const chatBox = document.getElementById('chatBox');
            const chatToggle = document.getElementById('chatToggle');
            if (chatOpen) {
                chatBox.style.display = 'flex';
                chatBox.style.flexDirection = 'column';
                unreadCount = 0;
                document.getElementById('chatBadge').style.display = 'none';
                lastReadTimestamp = Date.now();
                localStorage.setItem('chatLastRead', lastReadTimestamp.toString());
                document.getElementById('chatInput').focus();
                scrollToBottom();
            } else {
                chatBox.style.display = 'none';
            }
            chatToggle.style.transform = chatOpen ? 'scale(0.9)' : 'scale(1)';
            chatToggle.setAttribute('aria-expanded', chatOpen);
            chatToggle.setAttribute('aria-label', chatOpen ? 'Close chat' : 'Open chat');
        }

        // Send message
        function sendMessage(event) {
            event.preventDefault();
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Admin commands (admin emails only)
            const adminEmails = ['christiankholden@gmail.com', 'holdenc'];
            if (adminEmails.includes(chatCurrentUsername.toLowerCase())) {
                // Alert command: alert/message or alert/clear
                if (message.toLowerCase().startsWith('alert/')) {
                    const alertMsg = message.substring(6).trim();
                    if (alertMsg.toLowerCase() === 'clear') {
                        announcementsRef.child('alert').remove();
                    } else if (alertMsg) {
                        announcementsRef.child('alert').set({ message: alertMsg, timestamp: Date.now() });
                    }
                    input.value = '';
                    return;
                }
                // FYI command: fyi/message or fyi/clear
                if (message.toLowerCase().startsWith('fyi/')) {
                    const fyiMsg = message.substring(4).trim();
                    if (fyiMsg.toLowerCase() === 'clear') {
                        announcementsRef.child('fyi').remove();
                    } else if (fyiMsg) {
                        announcementsRef.child('fyi').set({ message: fyiMsg, timestamp: Date.now() });
                    }
                    input.value = '';
                    return;
                }
                // Chat clear command: chat/clear
                if (message.toLowerCase() === 'chat/clear') {
                    chatRef.remove();
                    input.value = '';
                    return;
                }
            }

            // Check Firebase Auth status
            const currentUser = auth.currentUser;
            console.log('Sending message, Firebase auth user:', currentUser ? currentUser.email : 'NOT AUTHENTICATED');

            if (!currentUser) {
                showToast('Chat requires authentication. Please refresh the page or log in again.', 'error');
                return;
            }

            chatRef.push({
                user: chatDisplayName,
                username: chatCurrentUsername,
                text: message,
                timestamp: Date.now()
            }).then(() => {
                console.log('Message sent successfully');
            }).catch((error) => {
                console.error('Failed to send message:', error);
                showToast('Failed to send message: ' + error.message + '. You may need to log in again.', 'error');
            });

            input.value = '';
            hideMentionDropdown();
        }

        // Format timestamp (with safety checks)
        function formatTime(timestamp) {
            try {
                if (!timestamp || typeof timestamp !== 'number') {
                    return 'Unknown time';
                }
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    return 'Invalid time';
                }
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();

                if (isToday) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            } catch (e) {
                console.error('formatTime error:', e);
                return 'Time error';
            }
        }

        // Format message text with @mention highlighting (with safety checks)
        function formatMessageWithMentions(text, isMe) {
            try {
                if (!text || typeof text !== 'string') {
                    return '';
                }
                // Escape HTML first
                let formatted = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                // Highlight @mentions with a styled span
                formatted = formatted.replace(/@(\w+)/g, function(match, name) {
                    const bgColor = isMe ? 'rgba(255,255,255,0.3)' : 'rgba(139, 92, 246, 0.2)';
                    const textColor = isMe ? '#fff' : '#7c3aed';
                    return `<span style="background: ${bgColor}; color: ${textColor}; padding: 1px 6px; border-radius: 10px; font-weight: 600;">@${name}</span>`;
                });

                return formatted;
            } catch (e) {
                console.error('formatMessageWithMentions error:', e);
                return text || '';
            }
        }

        // Scroll to bottom
        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        // 7-day threshold in milliseconds
        const MESSAGE_RETENTION_MS = 7 * 24 * 60 * 60 * 1000;

        // Clean up old messages (older than 7 days)
        function cleanupOldMessages() {
            const cutoff = Date.now() - MESSAGE_RETENTION_MS;
            chatRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const msg = child.val();
                    if (msg.timestamp && msg.timestamp < cutoff) {
                        child.ref.remove();
                    }
                });
            });
        }

        // Run cleanup on load and every hour
        cleanupOldMessages();
        setInterval(cleanupOldMessages, 60 * 60 * 1000);

        // Listen for messages
        function setupChatListener() {
            console.log('Setting up chat listener...');
            chatRef.on('value', (snapshot) => {
                console.log('=== CHAT LISTENER FIRED ===');
                console.log('Snapshot exists:', snapshot.exists());
                console.log('Snapshot numChildren:', snapshot.numChildren());

                const container = document.getElementById('chatMessages');
                if (!container) {
                    console.error('chatMessages container not found!');
                    return;
                }

                if (!snapshot.exists() || snapshot.numChildren() === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; margin-top: 20px;">No messages yet. Start the conversation!</p>';
                    return;
                }

                // Get ALL messages first, then filter
                const allMessages = [];
                snapshot.forEach((child) => {
                    const msg = child.val();
                    allMessages.push(msg);
                });

                // Filter by 7 days
                const cutoff = Date.now() - MESSAGE_RETENTION_MS;
                let messages = allMessages.filter(msg => msg.timestamp && msg.timestamp >= cutoff);

                // Sort by timestamp
                messages.sort((a, b) => a.timestamp - b.timestamp);

                // Limit to last 50 messages for performance
                const MAX_DISPLAY_MESSAGES = 50;
                const hasOlderMessages = messages.length > MAX_DISPLAY_MESSAGES;
                if (hasOlderMessages) {
                    messages = messages.slice(-MAX_DISPLAY_MESSAGES);
                }

                if (messages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; margin-top: 20px;">No messages yet. Start the conversation!</p>';
                    return;
                }

                let html = '';
                // Show indicator if older messages are hidden
                if (hasOlderMessages) {
                    html += '<p style="text-align: center; color: #888; font-size: 11px; padding: 8px; background: #f0f0f0; border-radius: 8px; margin-bottom: 10px;">Showing last 50 messages</p>';
                }
                let newMessages = 0;

                messages.forEach((msg) => {
                    const isMe = msg.user === chatDisplayName || msg.username === chatCurrentUsername;
                    const isNew = msg.timestamp > lastReadTimestamp;

                    if (isNew && !chatOpen) newMessages++;

                    // Format text with @mention highlighting
                    const formattedText = formatMessageWithMentions(msg.text, isMe);
                    // Check if this message mentions the current user
                    const mentionsMe = msg.text.toLowerCase().includes('@' + chatDisplayName.toLowerCase());

                    html += `
                        <div style="margin-bottom: 12px; display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'};">
                            <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${isMe ? 'You' : msg.user}</div>
                            <div style="background: ${mentionsMe && !isMe ? 'linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%)' : (isMe ? 'linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%)' : '#e2e8f0')}; color: ${mentionsMe || isMe ? 'white' : '#333'}; padding: 10px 14px; border-radius: ${isMe ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 80%; word-wrap: break-word; font-size: 14px; ${mentionsMe && !isMe ? 'box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);' : ''}">
                                ${formattedText}
                            </div>
                            <div style="font-size: 9px; color: #aaa; margin-top: 3px;">
                                ${formatTime(msg.timestamp)}${isMe ? ' <span style="color: #4ade80;" title="Delivered">‚úì</span>' : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                scrollToBottom();

                // Update unread badge and send notifications
                if (newMessages > 0 && !chatOpen) {
                    const shouldNotify = unreadCount < newMessages;

                    unreadCount = newMessages;
                    const badge = document.getElementById('chatBadge');
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    badge.style.display = 'flex';

                    if (shouldNotify && messages.length > 0) {
                        const latestMessage = messages[messages.length - 1];
                        if (latestMessage.username !== chatCurrentUsername) {
                            playNotificationSound();
                            sendBrowserNotification(latestMessage);
                        }
                    }
                }
            }, (error) => {
                console.error('Chat listener error:', error);
                document.getElementById('chatMessages').innerHTML = '<p style="color: red; padding: 20px;">Chat error: ' + error.message + '</p>';
            });
        }

        // Initialize chat listener
        setupChatListener();

        // Monitor Firebase connection state
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            const connected = snap.val() === true;
            const onlineCountEl = document.getElementById('onlineCount');
            if (connected) {
                console.log('Firebase: Connected');
                if (onlineCountEl && onlineCountEl.textContent.includes('Disconnected')) {
                    onlineCountEl.textContent = 'Reconnected! Refreshing...';
                    setTimeout(() => setupChatListener(), 500);
                }
            } else {
                console.log('Firebase: Disconnected');
                if (onlineCountEl) {
                    onlineCountEl.innerHTML = '<span style="color: #fca5a5;">Disconnected - reconnecting...</span>';
                }
            }
        });

        // ========== DIRECT MESSAGES ==========
        let chatMode = 'group';
        let currentDMConversation = null;
        let dmConversations = [];
        let dmUnreadCount = 0;
        let dmLastReadTimestamps = JSON.parse(localStorage.getItem('dmLastRead') || '{}');
        const directMessagesRef = database.ref('directMessages');

        function getConversationId(email1, email2) {
            return [email1, email2].sort().join('_').replace(/[.@]/g, '_');
        }

        function switchChatMode(mode) {
            try {
                chatMode = mode;
                const groupView = document.getElementById('groupChatView');
                const dmView = document.getElementById('dmView');
                const tabGroup = document.getElementById('tabGroupChat');
                const tabDM = document.getElementById('tabDM');
                const chatTitle = document.getElementById('chatTitle');
                const onlineCount = document.getElementById('onlineCount');

                if (!groupView || !dmView) {
                    console.error('Chat views not found');
                    return;
                }

                if (mode === 'group') {
                    groupView.style.display = 'flex';
                    dmView.style.display = 'none';
                    tabGroup.style.background = 'rgba(255,255,255,0.3)';
                    tabDM.style.background = 'rgba(255,255,255,0.1)';
                    tabGroup.setAttribute('aria-selected', 'true');
                    tabDM.setAttribute('aria-selected', 'false');
                    chatTitle.textContent = 'BSN9B Chat';
                    onlineCount.style.display = 'block';

                    unreadCount = 0;
                    document.getElementById('chatBadge').style.display = 'none';
                    lastReadTimestamp = Date.now();
                    localStorage.setItem('chatLastRead', lastReadTimestamp.toString());
                } else {
                    groupView.style.display = 'none';
                    dmView.style.display = 'flex';
                    tabGroup.style.background = 'rgba(255,255,255,0.1)';
                    tabDM.style.background = 'rgba(255,255,255,0.3)';
                    tabGroup.setAttribute('aria-selected', 'false');
                    tabDM.setAttribute('aria-selected', 'true');
                    chatTitle.textContent = 'Direct Messages';
                    onlineCount.style.display = 'none';

                    showDMConversationList();
                    loadDMConversations();
                }
            } catch (e) {
                console.error('Error switching chat mode:', e);
            }
        }

        function showDMConversationList() {
            document.getElementById('dmConversationList').style.display = 'block';
            document.getElementById('dmMessageView').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'none';
            currentDMConversation = null;
        }

        function showNewDMSelector() {
            document.getElementById('dmConversationList').style.display = 'none';
            document.getElementById('dmMessageView').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'flex';
            document.getElementById('dmUserSearch').value = '';
            loadDMUserList();
        }

        function hideNewDMSelector() {
            showDMConversationList();
        }

        function loadDMUserList() {
            const container = document.getElementById('dmUserList');
            const onlineSet = new Set(onlineUsers.map(u => u.toLowerCase()));
            let users = [];

            onlineUsers.forEach(u => {
                if (u.toLowerCase() !== chatDisplayName.toLowerCase()) {
                    users.push({ name: u, online: true });
                }
            });

            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                if (!onlineSet.has(firstName.toLowerCase()) && firstName.toLowerCase() !== chatDisplayName.toLowerCase()) {
                    users.push({ name: firstName, fullName: u.name, email: u.email, online: false });
                }
            });

            renderDMUserList(users);
        }

        function filterDMUsers() {
            const search = document.getElementById('dmUserSearch').value.toLowerCase();
            const onlineSet = new Set(onlineUsers.map(u => u.toLowerCase()));
            let users = [];

            onlineUsers.forEach(u => {
                if (u.toLowerCase() !== chatDisplayName.toLowerCase() && u.toLowerCase().includes(search)) {
                    users.push({ name: u, online: true });
                }
            });

            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                if (!onlineSet.has(firstName.toLowerCase()) &&
                    firstName.toLowerCase() !== chatDisplayName.toLowerCase() &&
                    (firstName.toLowerCase().includes(search) || u.name.toLowerCase().includes(search))) {
                    users.push({ name: firstName, fullName: u.name, email: u.email, online: false });
                }
            });

            renderDMUserList(users);
        }

        function renderDMUserList(users) {
            const container = document.getElementById('dmUserList');

            if (users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px;">No users found</p>';
                return;
            }

            container.innerHTML = users.map(u => `
                <div onclick="startDMConversation('${u.name}')" style="padding: 12px; background: white; border-radius: 10px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div>
                        <div style="font-weight: 600; color: #1a1a2e;">${u.name}${u.fullName && u.fullName !== u.name ? ` <span style="color:#888;font-weight:normal;font-size:12px;">(${u.fullName})</span>` : ''}</div>
                    </div>
                    ${u.online ? '<span style="font-size: 10px; background: #22c55e; color: white; padding: 2px 8px; border-radius: 10px;">online</span>' : '<span style="font-size: 10px; color: #888;">offline</span>'}
                </div>
            `).join('');
        }

        function startDMConversation(partnerName) {
            currentDMConversation = {
                partnerName: partnerName,
                conversationId: getConversationId(chatDisplayName, partnerName)
            };

            document.getElementById('dmConversationList').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'none';
            document.getElementById('dmMessageView').style.display = 'flex';
            document.getElementById('dmPartnerName').textContent = partnerName;

            const isOnline = onlineUsers.some(u => u.toLowerCase() === partnerName.toLowerCase());
            const statusEl = document.getElementById('dmPartnerStatus');
            statusEl.textContent = isOnline ? 'online' : 'offline';
            statusEl.style.background = isOnline ? '#dcfce7' : '#e2e8f0';
            statusEl.style.color = isOnline ? '#16a34a' : '#666';

            loadDMMessages(currentDMConversation.conversationId);
            markDMAsRead(currentDMConversation.conversationId);
        }

        function closeDMConversation() {
            currentDMConversation = null;
            showDMConversationList();
            loadDMConversations();
        }

        function loadDMConversations() {
            const container = document.getElementById('dmConversations');
            if (!container) return;

            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading...</p>';

            directMessagesRef.once('value', (snapshot) => {
                dmConversations = [];

                snapshot.forEach((child) => {
                    const convId = child.key;
                    const data = child.val();

                    if (!data) return;

                    const participants = data.participants || {};
                    const isParticipant = Object.values(participants).some(p =>
                        p && (p.toLowerCase() === chatDisplayName.toLowerCase() ||
                        p.toLowerCase() === chatCurrentUsername.toLowerCase())
                    );

                    if (isParticipant && data.lastMessage) {
                        let partnerName = '';
                        Object.values(participants).forEach(p => {
                            if (p && p.toLowerCase() !== chatDisplayName.toLowerCase() &&
                                p.toLowerCase() !== chatCurrentUsername.toLowerCase()) {
                                partnerName = p;
                            }
                        });

                        dmConversations.push({
                            conversationId: convId,
                            partnerName: partnerName,
                            lastMessage: data.lastMessage,
                            unread: !dmLastReadTimestamps[convId] || data.lastMessage.timestamp > dmLastReadTimestamps[convId]
                        });
                    }
                });

                dmConversations.sort((a, b) => (b.lastMessage?.timestamp || 0) - (a.lastMessage?.timestamp || 0));
                renderDMConversations();
            });
        }

        function renderDMConversations() {
            const container = document.getElementById('dmConversations');

            if (dmConversations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; padding: 20px;">No conversations yet.<br>Start a new message!</p>';
                return;
            }

            let totalUnread = 0;
            container.innerHTML = dmConversations.map(conv => {
                const time = conv.lastMessage ? formatTime(conv.lastMessage.timestamp) : '';
                const preview = conv.lastMessage ? (conv.lastMessage.text || '').substring(0, 40) + (conv.lastMessage.text?.length > 40 ? '...' : '') : '';
                const isUnread = conv.unread && conv.lastMessage?.sender !== chatDisplayName;
                if (isUnread) totalUnread++;

                return `
                    <div onclick="startDMConversation('${conv.partnerName}')" style="padding: 12px; background: ${isUnread ? '#f0f7ff' : 'white'}; border-radius: 10px; margin-bottom: 8px; cursor: pointer; border: 1px solid ${isUnread ? '#8b5cf6' : '#e2e8f0'}; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='${isUnread ? '#8b5cf6' : '#e2e8f0'}'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: ${isUnread ? '700' : '600'}; color: #1a1a2e; margin-bottom: 4px;">
                                    ${isUnread ? '‚óè ' : ''}${conv.partnerName}
                                </div>
                                <div style="font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${conv.lastMessage?.sender === chatDisplayName ? 'You: ' : ''}${preview}
                                </div>
                            </div>
                            <div style="font-size: 10px; color: #888; white-space: nowrap; margin-left: 10px;">
                                ${time}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateDMBadge(totalUnread);
        }

        function updateDMBadge(count) {
            dmUnreadCount = count;
            const badge = document.getElementById('dmBadge');
            const tabBadge = document.getElementById('dmTabBadge');

            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count;
                badge.style.display = 'flex';
                tabBadge.textContent = count;
                tabBadge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
                tabBadge.style.display = 'none';
            }
        }

        function loadDMMessages(conversationId) {
            const container = document.getElementById('dmMessages');
            container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px;">Loading messages...</p>';

            const messagesRef = directMessagesRef.child(conversationId + '/messages');
            messagesRef.orderByChild('timestamp').on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; padding: 20px;">No messages yet. Say hello!</p>';
                    return;
                }

                const messages = [];
                snapshot.forEach((child) => {
                    messages.push(child.val());
                });

                let html = '';
                messages.forEach(msg => {
                    const isMe = msg.senderName === chatDisplayName || msg.sender === chatCurrentUsername;

                    html += `
                        <div style="margin-bottom: 12px; display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'};">
                            <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${isMe ? 'You' : msg.senderName}</div>
                            <div style="background: ${isMe ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' : '#e2e8f0'}; color: ${isMe ? 'white' : '#333'}; padding: 10px 14px; border-radius: ${isMe ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 80%; word-wrap: break-word; font-size: 14px;">
                                ${(msg.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            </div>
                            <div style="font-size: 9px; color: #aaa; margin-top: 3px;">
                                ${formatTime(msg.timestamp)}${isMe ? (msg.read ? ' <span style="color: #4ade80;" title="Seen">‚úì‚úì</span>' : ' <span style="color: #888;" title="Delivered">‚úì</span>') : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                container.scrollTop = container.scrollHeight;

                if (currentDMConversation && currentDMConversation.conversationId === conversationId) {
                    markDMAsRead(conversationId, snapshot);
                }
            });
        }

        function sendDM(event) {
            event.preventDefault();

            if (!currentDMConversation) return;

            const input = document.getElementById('dmInput');
            if (!input) return;

            const text = input.value.trim();
            if (!text) return;

            const currentUser = auth.currentUser;
            if (!currentUser) {
                showToast('Please log in to send messages.', 'warning');
                return;
            }

            const conversationId = currentDMConversation.conversationId;
            const partnerName = currentDMConversation.partnerName;

            const messageData = {
                sender: chatCurrentUsername,
                senderName: chatDisplayName,
                text: text,
                timestamp: Date.now(),
                read: false
            };

            try {
                directMessagesRef.child(conversationId + '/messages').push(messageData)
                    .catch(err => console.error('Error sending DM:', err));

                directMessagesRef.child(conversationId + '/participants').set({
                    user1: chatDisplayName,
                    user2: partnerName
                });

                directMessagesRef.child(conversationId + '/lastMessage').set({
                    text: text,
                    timestamp: Date.now(),
                    sender: chatDisplayName
                });

                input.value = '';
            } catch (e) {
                console.error('Error sending DM:', e);
                showToast('Failed to send message. Please try again.', 'error');
            }
        }

        function markDMAsRead(conversationId, snapshot) {
            dmLastReadTimestamps[conversationId] = Date.now();
            localStorage.setItem('dmLastRead', JSON.stringify(dmLastReadTimestamps));

            if (snapshot && snapshot.exists()) {
                snapshot.forEach((child) => {
                    const msg = child.val();
                    const msgKey = child.key;
                    if (msg && !msg.read && msg.senderName !== chatDisplayName && msg.sender !== chatCurrentUsername) {
                        directMessagesRef.child(conversationId + '/messages/' + msgKey + '/read').set(true)
                            .catch(err => console.error('Error marking message as read:', err));
                    }
                });
            }

            let totalUnread = 0;
            dmConversations.forEach(conv => {
                if (conv.conversationId !== conversationId) {
                    if (conv.unread && conv.lastMessage?.sender !== chatDisplayName) {
                        totalUnread++;
                    }
                }
            });
            updateDMBadge(totalUnread);
        }

        function setupDMListener() {
            try {
                directMessagesRef.on('child_changed', (snapshot) => {
                    try {
                        const convId = snapshot.key;
                        const data = snapshot.val();

                        if (!data) return;

                        const participants = data.participants || {};
                        const isParticipant = Object.values(participants).some(p =>
                            p && (p.toLowerCase() === chatDisplayName.toLowerCase() ||
                            p.toLowerCase() === chatCurrentUsername.toLowerCase())
                        );

                        if (!isParticipant) return;

                        if (data.lastMessage && data.lastMessage.sender !== chatDisplayName) {
                            const lastRead = dmLastReadTimestamps[convId] || 0;
                            if (data.lastMessage.timestamp > lastRead) {
                                if (!chatOpen || chatMode !== 'dm' || currentDMConversation?.conversationId !== convId) {
                                    playNotificationSound();

                                    if (notificationsEnabled && Notification.permission === 'granted') {
                                        try {
                                            const notification = new Notification('New DM from ' + data.lastMessage.sender, {
                                                body: (data.lastMessage.text || '').substring(0, 100),
                                                tag: 'bsn9b-dm-' + convId
                                            });
                                            notification.onclick = () => {
                                                window.focus();
                                                if (!chatOpen) toggleChat();
                                                switchChatMode('dm');
                                                startDMConversation(data.lastMessage.sender);
                                                notification.close();
                                            };
                                        } catch (notifErr) {
                                            console.log('Notification error:', notifErr);
                                        }
                                    }
                                }

                                if (chatOpen && chatMode === 'dm' && !currentDMConversation) {
                                    loadDMConversations();
                                }
                            }
                        }
                    } catch (innerErr) {
                        console.error('DM listener inner error:', innerErr);
                    }
                });
            } catch (e) {
                console.error('Error setting up DM listener:', e);
            }
        }

        setupDMListener();

        // Track online presence
        const myPresence = presenceRef.push();
        myPresence.set({
            user: chatDisplayName,
            username: chatCurrentUsername,
            online: true
        });
        myPresence.onDisconnect().remove();

        let userListVisible = false;
        function toggleUserList() {
            userListVisible = !userListVisible;
            document.getElementById('userList').style.display = userListVisible ? 'block' : 'none';
        }

        // Store online users for @mention autocomplete
        let onlineUsers = [];

        presenceRef.on('value', (snapshot) => {
            const count = snapshot.numChildren();
            document.getElementById('onlineCount').textContent = count + ' online (click to see)';

            onlineUsers = [];
            snapshot.forEach((child) => {
                const data = child.val();
                if (data.user) {
                    onlineUsers.push(data.user);
                }
            });

            document.getElementById('userListNames').innerHTML = onlineUsers.length > 0
                ? onlineUsers.map(u => `<div style="padding: 4px 0; cursor: pointer;" onclick="insertMention('${u}')" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">‚Ä¢ ${u} <span style="font-size:10px;opacity:0.6;">(click to @mention)</span></div>`).join('')
                : '<div style="opacity: 0.7;">No users online</div>';
        });

        function insertMention(username) {
            const input = document.getElementById('chatInput');
            input.value = '@' + username + ' ' + input.value;
            input.focus();
            document.getElementById('userList').style.display = 'none';
            userListVisible = false;
        }

        // ========== @MENTION AUTOCOMPLETE ==========
        let allRegisteredUsers = [];
        let mentionDropdownIndex = -1;
        const USER_CACHE_KEY = 'bsn9b_users_cache';
        const USER_CACHE_EXPIRY = 10 * 60 * 1000; // 10 minutes

        async function fetchAllUsersForChat() {
            try {
                // Check cache first
                const cached = localStorage.getItem(USER_CACHE_KEY);
                if (cached) {
                    const { users, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < USER_CACHE_EXPIRY) {
                        allRegisteredUsers = users;
                        console.log('Loaded', allRegisteredUsers.length, 'users from cache');
                        return;
                    }
                }

                // Fetch fresh data
                const response = await fetch('https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec?action=getUsers');
                const data = await response.json();
                if (data.success && data.users) {
                    allRegisteredUsers = data.users
                        .filter(u => u.name && u.name.trim())
                        .map(u => ({
                            name: u.name.trim(),
                            firstName: u.name.trim().split(' ')[0],
                            email: u.email || ''
                        }));

                    // Cache the results
                    localStorage.setItem(USER_CACHE_KEY, JSON.stringify({
                        users: allRegisteredUsers,
                        timestamp: Date.now()
                    }));
                    console.log('Loaded', allRegisteredUsers.length, 'users from API, cached');
                }
            } catch (e) {
                console.log('Could not fetch users for @mention:', e);
                // Try to use expired cache as fallback
                const cached = localStorage.getItem(USER_CACHE_KEY);
                if (cached) {
                    allRegisteredUsers = JSON.parse(cached).users || [];
                    console.log('Using expired cache as fallback');
                }
            }
        }

        fetchAllUsersForChat();

        const chatInput = document.getElementById('chatInput');
        const mentionDropdown = document.getElementById('mentionDropdown');

        if (chatInput) chatInput.addEventListener('input', function(e) {
            const value = this.value;
            const cursorPos = this.selectionStart;
            const textBeforeCursor = value.substring(0, cursorPos);
            const atMatch = textBeforeCursor.match(/@(\w*)$/);

            if (atMatch) {
                const searchTerm = atMatch[1].toLowerCase();
                showMentionDropdown(searchTerm);
            } else {
                hideMentionDropdown();
            }
        });

        if (chatInput) chatInput.addEventListener('keydown', function(e) {
            if (mentionDropdown.style.display === 'none') return;

            const items = mentionDropdown.querySelectorAll('.mention-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                mentionDropdownIndex = Math.min(mentionDropdownIndex + 1, items.length - 1);
                updateMentionHighlight(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                mentionDropdownIndex = Math.max(mentionDropdownIndex - 1, 0);
                updateMentionHighlight(items);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                if (mentionDropdownIndex >= 0 && items[mentionDropdownIndex]) {
                    e.preventDefault();
                    selectMention(items[mentionDropdownIndex].dataset.name);
                }
            } else if (e.key === 'Escape') {
                hideMentionDropdown();
            }
        });

        function showMentionDropdown(searchTerm) {
            const onlineSet = new Set(onlineUsers.map(u => u.toLowerCase()));
            let matches = [];

            onlineUsers.forEach(u => {
                if (u.toLowerCase().includes(searchTerm)) {
                    matches.push({ name: u, online: true });
                }
            });

            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                const fullName = u.name;
                if (!onlineSet.has(firstName.toLowerCase()) &&
                    (firstName.toLowerCase().includes(searchTerm) || fullName.toLowerCase().includes(searchTerm))) {
                    matches.push({ name: firstName, fullName: fullName, online: false });
                }
            });

            matches = matches.slice(0, 8);

            if (matches.length === 0) {
                hideMentionDropdown();
                return;
            }

            mentionDropdownIndex = 0;
            mentionDropdown.innerHTML = matches.map((m, i) => `
                <div class="mention-item" data-name="${m.name}"
                     style="padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; ${i === 0 ? 'background: #f0f7ff;' : ''}"
                     onclick="selectMention('${m.name}')"
                     onmouseover="this.style.background='#f0f7ff'"
                     onmouseout="this.style.background='${i === mentionDropdownIndex ? '#f0f7ff' : 'transparent'}'">
                    <span style="font-weight: 500;">@${m.name}${m.fullName && m.fullName !== m.name ? ' <span style="color:#888;font-weight:normal;">(' + m.fullName + ')</span>' : ''}</span>
                    ${m.online ? '<span style="font-size: 10px; background: #22c55e; color: white; padding: 2px 6px; border-radius: 10px;">online</span>' : ''}
                </div>
            `).join('');

            mentionDropdown.style.display = 'block';
        }

        function hideMentionDropdown() {
            mentionDropdown.style.display = 'none';
            mentionDropdownIndex = -1;
        }

        function updateMentionHighlight(items) {
            items.forEach((item, i) => {
                item.style.background = i === mentionDropdownIndex ? '#f0f7ff' : 'transparent';
            });
        }

        function selectMention(name) {
            const input = chatInput;
            const value = input.value;
            const cursorPos = input.selectionStart;

            const textBeforeCursor = value.substring(0, cursorPos);
            const atIndex = textBeforeCursor.lastIndexOf('@');

            if (atIndex !== -1) {
                const newValue = value.substring(0, atIndex) + '@' + name + ' ' + value.substring(cursorPos);
                input.value = newValue;

                const newCursorPos = atIndex + name.length + 2;
                input.setSelectionRange(newCursorPos, newCursorPos);
            }

            hideMentionDropdown();
            input.focus();
        }

        document.addEventListener('click', function(e) {
            if (chatInput && mentionDropdown && !chatInput.contains(e.target) && !mentionDropdown.contains(e.target)) {
                hideMentionDropdown();
            }
        });
        // ========== END CHAT SYSTEM ==========

        // ========== FIREBASE LISTENER CLEANUP ==========
        function cleanupFirebaseListeners() {
            try {
                if (typeof announcementsRef !== 'undefined') announcementsRef.off();
                if (typeof bannedRef !== 'undefined') bannedRef.off();
                if (typeof chatRef !== 'undefined') chatRef.off();
                if (typeof connectedRef !== 'undefined') connectedRef.off();
                if (typeof directMessagesRef !== 'undefined') directMessagesRef.off();
                if (typeof presenceRef !== 'undefined') presenceRef.off();
                console.log('Firebase listeners cleaned up');
            } catch (e) {
                console.log('Error cleaning up listeners:', e);
            }
        }

        window.addEventListener('beforeunload', cleanupFirebaseListeners);
        window.addEventListener('pagehide', cleanupFirebaseListeners);

        // ========== KEYBOARD NAVIGATION ==========
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close more menu
                const moreMenu = document.getElementById('moreMenu');
                if (moreMenu) moreMenu.classList.remove('show');
                // Close chat box
                const chatBox = document.getElementById('chatBox');
                if (chatBox && chatBox.style.display !== 'none') {
                    chatBox.style.display = 'none';
                    chatOpen = false;
                }
            }
        });

        // ========== SWIPE GESTURES FOR MOBILE ==========
        (function() {
            let touchStartX = 0;
            let touchStartY = 0;
            const SWIPE_THRESHOLD = 80;
            const SWIPE_RESTRAINT = 100;

            function addSwipeToClose(element, closeCallback, direction) {
                if (!element) return;
                element.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                }, { passive: true });
                element.addEventListener('touchend', function(e) {
                    const touchEndX = e.changedTouches[0].screenX;
                    const touchEndY = e.changedTouches[0].screenY;
                    const diffX = touchEndX - touchStartX;
                    const diffY = touchEndY - touchStartY;
                    if (diffY > SWIPE_THRESHOLD && Math.abs(diffX) < SWIPE_RESTRAINT) { closeCallback(); return; }
                    if (Math.abs(diffX) > SWIPE_THRESHOLD && Math.abs(diffY) < SWIPE_RESTRAINT) {
                        if (direction === 'right' && diffX > 0) closeCallback();
                        if (direction === 'left' && diffX < 0) closeCallback();
                    }
                }, { passive: true });
            }
            addSwipeToClose(document.getElementById('chatBox'), function() { if (chatOpen) toggleChat(); }, 'right');
            addSwipeToClose(document.getElementById('aiBox'), function() { if (aiOpen) toggleAI(); }, 'left');
        })();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
