<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>BSN9B Nursing Documentation</title>
    <script>
        if (sessionStorage.getItem('bsn9b_auth') !== 'true') {
            window.location.href = 'index.html';
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .hidden { display: none !important; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 13px; }
        .form-container { padding: 30px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 6px; font-size: 13px; }
        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: #fafafa;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1f4e79;
            box-shadow: 0 0 0 3px rgba(31, 78, 121, 0.1);
            background: white;
        }
        textarea { min-height: 80px; resize: vertical; }
        textarea.large { min-height: 120px; }
        .note-type-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .note-type-card {
            padding: 14px 8px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .note-type-card:hover { border-color: #1f4e79; background: #f8fafc; }
        .note-type-card.active {
            border-color: #1f4e79;
            background: #1f4e79;
            color: white;
        }
        .note-type-card h3 { font-size: 15px; margin-bottom: 3px; }
        .note-type-card p { font-size: 9px; opacity: 0.8; }
        .section-title {
            font-size: 16px;
            color: #1f4e79;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #1f4e79;
        }
        .note-fields { display: none; }
        .note-fields.active { display: block; }
        .field-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .field-letter {
            width: 28px; height: 28px;
            background: #1f4e79;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
        }
        .field-info h4 { font-size: 13px; color: #1a1a2e; }
        .field-info p { font-size: 11px; color: #666; }
        .btn-container { display: flex; gap: 12px; margin-top: 25px; }
        .btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-pdf { background: #1f4e79; color: white; }
        .btn-word { background: #2b5797; color: white; }
        .btn-clear { background: #f0f0f0; color: #333; flex: 0.4; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .warning-box {
            background: #fff5f5;
            border: 1px solid #e53e3e;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #c53030;
        }
        .info-box {
            background: #fffbeb;
            border: 1px solid #d69e2e;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        .info-box ul { margin: 8px 0 0 18px; }
        .info-box li { margin-bottom: 3px; }
        /* NANDA Search */
        .nanda-section { margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0; }
        .nanda-search { position: relative; }
        .nanda-search input { padding-right: 35px; }
        .nanda-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
        }
        .nanda-dropdown.show { display: block; }
        .nanda-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .nanda-item:hover { background: #f0f7ff; }
        .nanda-item .category { font-size: 10px; color: #1f4e79; font-weight: 600; }
        .selected-diagnoses { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .diagnosis-tag {
            background: #1f4e79;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .diagnosis-tag .remove { cursor: pointer; opacity: 0.8; }
        .diagnosis-tag .remove:hover { opacity: 1; }
        /* H2T Assessment */
        .h2t-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .h2t-section { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .h2t-section h4 { font-size: 13px; color: #1f4e79; margin-bottom: 8px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }
        .quick-fills { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
        .quick-fill {
            background: #e8f4fd;
            border: 1px solid #bee3f8;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-fill:hover { background: #1f4e79; color: white; border-color: #1f4e79; }
        .h2t-section textarea { min-height: 60px; font-size: 12px; }
        @media (max-width: 768px) {
            .note-type-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row, .form-row.three-col, .h2t-grid { grid-template-columns: 1fr; }
            .btn-container { flex-direction: column; }
        }
        /* Drug Autocomplete */
        .drug-autocomplete-wrapper {
            position: relative;
        }
        .drug-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 2px solid #1976d2;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 200;
            display: none;
        }
        .drug-dropdown.show { display: block; }
        .drug-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            color: #333;
        }
        .drug-item:hover { background: #e3f2fd; }
        .drug-item:last-child { border-bottom: none; }
        .drug-loading {
            padding: 10px 12px;
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
        /* Pulse animation for RN Resources button */
        @keyframes pulse-btn {
            0% { box-shadow: 0 4px 15px rgba(255,107,53,0.4); }
            50% { box-shadow: 0 4px 25px rgba(255,107,53,0.7); }
            100% { box-shadow: 0 4px 15px rgba(255,107,53,0.4); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sumner BSN9B Nursing Documentation</h1>
            <p>Progress Notes | Head-to-Toe | NANDA Diagnoses</p>
            <a href="resources.html" style="display: inline-block; margin-top: 15px; background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; text-decoration: none; padding: 14px 30px; border-radius: 25px; font-size: 16px; font-weight: 700; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,107,53,0.4); animation: pulse-btn 2s infinite;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(255,107,53,0.6)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(255,107,53,0.4)'">üìö RN Resources - Click Here!</a>
        </div>
        <div class="form-container">
            <div class="warning-box">
                <strong>HIPAA Notice:</strong> Do NOT enter PHI/PII. Use patient aliases only (e.g., "J.D.", "Room 302").
            </div>
            <div class="info-box">
                <strong>Quick Start:</strong> Enter info ‚Üí Select format ‚Üí Document ‚Üí Export PDF/Word. Use <strong>Smart Phrases</strong> (üìù button on right) for quick text shortcuts.
            </div>
            <!-- Floating Smart Phrases Button - More Visible -->
            <button onclick="document.getElementById('phrasesModal').classList.remove('hidden')" style="position: fixed; right: 0; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border: none; padding: 15px 12px; border-radius: 10px 0 0 10px; cursor: pointer; font-weight: 700; font-size: 13px; box-shadow: -4px 4px 15px rgba(0,0,0,0.4); z-index: 100; writing-mode: vertical-rl; text-orientation: mixed; animation: pulse 2s infinite;">
                üìù SMART PHRASES
            </button>
            <style>
                @keyframes pulse {
                    0%, 100% { box-shadow: -4px 4px 15px rgba(0,0,0,0.4); }
                    50% { box-shadow: -4px 4px 25px rgba(255,152,0,0.6); }
                }
                .phrase-item { position: relative; cursor: help; padding: 4px 6px; border-radius: 4px; transition: background 0.2s; }
                .phrase-item:hover { background: #e3f2fd; }
                .phrase-item .tooltip {
                    display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
                    background: #333; color: #fff; padding: 10px 12px; border-radius: 6px;
                    font-size: 12px; white-space: normal; word-wrap: break-word;
                    width: 280px; max-width: 90vw; z-index: 1001;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.4); line-height: 1.5;
                    text-align: left; margin-bottom: 8px;
                }
                .phrase-item:hover .tooltip { display: block; }
            </style>

            <!-- Smart Phrases Modal with Tooltips -->
            <div id="phrasesModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) this.classList.add('hidden')">
                <div style="background: white; border-radius: 12px; padding: 20px; max-width: 550px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #1f4e79; padding-bottom: 10px;">
                        <h3 style="color: #1f4e79; margin: 0;">üìù Smart Phrases Reference</h3>
                        <button onclick="document.getElementById('phrasesModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Type shortcut + <strong>space</strong> to expand. <em>Hover over any phrase to preview.</em></p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.vs</code> Vital Signs<span class="tooltip">BP: __ | HR: __ | O2: __% | RR: __ | T: __ | Pain: __/10</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.neuro</code> Neuro<span class="tooltip">A&Ox4. PERRLA. GCS 15. MAE x4.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.resp</code> Respiratory<span class="tooltip">CTA bilat. No adventitious sounds. Unlabored. O2: __% on __.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.cv</code> Cardiovascular<span class="tooltip">S1S2 RRR. No murmurs. Pulses 2+ x4. Cap refill <3s. No edema.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.gi</code> GI<span class="tooltip">BS active x4 quads. Abdomen soft, NT, ND. Last BM: __.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.gu</code> GU<span class="tooltip">Voiding without difficulty. Urine clear yellow.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.skin</code> Skin<span class="tooltip">Warm, dry, intact. No breakdown or pressure injuries.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.pain</code> Pain<span class="tooltip">Pain __/10 at __. Quality: __. Duration: __. Interventions: __.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.nkda</code> NKDA<span class="tooltip">NKDA (No Known Drug Allergies).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.denies</code> Denies<span class="tooltip">Patient denies pain, nausea, SOB, dizziness, chest pain.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.aox4</code> A&Ox4<span class="tooltip">Alert and oriented x4 (person, place, time, situation).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.aox3</code> A&Ox3<span class="tooltip">Alert and oriented x3 (person, place, time).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.perrla</code> PERRLA<span class="tooltip">PERRLA (Pupils Equal, Round, Reactive to Light and Accommodation).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.mae</code> MAE<span class="tooltip">MAE x4 (Moving All Extremities).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.cta</code> CTA<span class="tooltip">CTA bilat (Clear to Auscultation bilaterally).</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.rrr</code> RRR<span class="tooltip">S1S2 RRR (Regular Rate and Rhythm). No murmurs, rubs, or gallops.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.bsax4</code> BS x4<span class="tooltip">BS active x4 quadrants.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.ntnd</code> NTND<span class="tooltip">Non-tender, non-distended.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.ivp</code> IV Patent<span class="tooltip">IV patent, no redness/swelling at site. Flushed with 10mL NS.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.fs</code> Foley<span class="tooltip">Foley catheter patent, draining clear yellow urine. Secured to thigh.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.medadmin</code> Med Admin<span class="tooltip">Medication administered as ordered. Patient tolerated without adverse effects.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.amb</code> Ambulation<span class="tooltip">Assisted patient with ambulation in hallway. Gait steady, tolerated well.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.fall</code> Fall Risk<span class="tooltip">Fall precautions in place. Bed in low position. Call light within reach.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.safe</code> Safety<span class="tooltip">Side rails up x2. Bed alarm on. Call light in reach. Non-skid socks on.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.wdta</code> Monitor<span class="tooltip">Will continue to monitor. Patient tolerated well. No adverse effects noted.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.wnl</code> WNL<span class="tooltip">Within normal limits.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.nad</code> NAD<span class="tooltip">No acute distress.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.edu</code> Education<span class="tooltip">Patient educated on __. Patient verbalized understanding.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.dc</code> Discharge<span class="tooltip">Discharge instructions reviewed with patient. Patient verbalized understanding.</span></div>
                        <div class="phrase-item"><code style="background:#1f4e79;color:#fff;padding:2px 5px;border-radius:3px;font-size:10px;">.tcdb</code> TCDB<span class="tooltip">Encouraged to turn, cough, and deep breathe.</span></div>
                    </div>
                    <!-- Suggestion Box -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <p style="font-size: 11px; color: #1f4e79; font-weight: 600; margin-bottom: 8px;">üí¨ Feedback, Issues, or Phrase Suggestions</p>
                        <form id="suggestionForm" action="https://formsubmit.co/christiankholden@gmail.com" method="POST" target="_blank" style="margin: 0;">
                            <input type="hidden" name="_subject" value="BSN9B Nursing App Feedback">
                            <input type="hidden" name="_captcha" value="false">
                            <input type="hidden" name="_template" value="table">
                            <textarea name="message" placeholder="Report an issue, suggest a smart phrase, or share feedback..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; resize: none; height: 60px;" required></textarea>
                            <button type="submit" style="margin-top: 8px; background: #1f4e79; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; width: 100%;">Submit</button>
                        </form>
                    </div>
                </div>
            </div>

            <h2 class="section-title">Patient & Nurse Information</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Nurse Name</label>
                    <input type="text" id="nurseName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Credentials</label>
                    <select id="credentials">
                        <option value="Student RN">Student RN</option>
                        <option value="RN">RN</option>
                        <option value="BSN, RN">BSN, RN</option>
                        <option value="LPN">LPN</option>
                    </select>
                </div>
            </div>
            <div class="form-row three-col">
                <div class="form-group">
                    <label>Date <span style="font-weight: normal; font-size: 10px; color: #666;">(T=today, T+1, T-3)</span></label>
                    <input type="text" id="noteDateText" placeholder="T for today" style="display:none;">
                    <input type="date" id="noteDate" onfocus="showDateShortcut()" onblur="hideDateShortcut()">
                </div>
                <div class="form-group">
                    <label>Time <span style="font-weight: normal; font-size: 10px; color: #666;">(N=now, N-30, N+15)</span></label>
                    <input type="text" id="noteTimeText" placeholder="N for now" style="display:none;">
                    <input type="time" id="noteTime" onfocus="showTimeShortcut()" onblur="hideTimeShortcut()">
                </div>
                <div class="form-group">
                    <label>Unit</label>
                    <input type="text" id="unit" placeholder="e.g., Med-Surg 3B">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Patient ID</label>
                    <input type="text" id="patientId" placeholder="e.g., J.D. / Room 302">
                </div>
                <div class="form-group">
                    <label>Demographics</label>
                    <input type="text" id="patientDemo" placeholder="e.g., 42yom">
                </div>
            </div>

            <h2 class="section-title">Documentation Format</h2>
            <div class="note-type-grid">
                <div class="note-type-card active" onclick="selectNoteType('dar')">
                    <h3>DAR</h3>
                    <p>Data, Action, Response</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('darp')">
                    <h3>DARP</h3>
                    <p>DAR + Plan</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('soap')">
                    <h3>SOAP</h3>
                    <p>Subj, Obj, Assess, Plan</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('sbar')">
                    <h3>SBAR</h3>
                    <p>Situation, Background</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('pie')">
                    <h3>PIE</h3>
                    <p>Problem, Intervention</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('h2t')">
                    <h3>H2T</h3>
                    <p>Head-to-Toe Assessment</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('soapie')">
                    <h3>SOAPIE</h3>
                    <p>SOAP + I, E</p>
                </div>
                <div class="note-type-card" onclick="selectNoteType('narrative')">
                    <h3>Narrative</h3>
                    <p>Free-form Note</p>
                </div>
            </div>

            <!-- NANDA Diagnosis Section -->
            <div class="nanda-section">
                <label>NANDA Nursing Diagnoses (optional - search to add)</label>
                <div class="nanda-search">
                    <input type="text" id="nandaSearch" placeholder="Search diagnoses... (e.g., pain, anxiety, mobility)" oninput="searchNanda()" onfocus="searchNanda()">
                    <div class="nanda-dropdown" id="nandaDropdown"></div>
                </div>
                <div class="selected-diagnoses" id="selectedDiagnoses"></div>
            </div>

            <!-- Quick Entry Panels -->
            <h2 class="section-title">Quick Entry Tools</h2>

            <!-- Vitals Quick-Entry Panel -->
            <div class="vitals-panel" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 10px; padding: 15px 20px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="togglePanel('vitalsContent', this)">
                    <h3 style="color: #2e7d32; margin: 0;">ü©∫ Quick Vitals Entry <span style="font-size: 12px; opacity: 0.7;">‚ñ∂</span></h3>
                    <button onclick="event.stopPropagation(); insertVitals()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Insert Vitals ‚ûú</button>
                </div>
                <div id="vitalsContent" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">BP (sys/dia)</label>
                        <div style="display: flex; gap: 4px;">
                            <input type="text" id="vsBpSys" placeholder="120" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                            <span style="line-height: 36px;">/</span>
                            <input type="text" id="vsBpDia" placeholder="80" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">HR</label>
                        <input type="text" id="vsHr" placeholder="72" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">RR</label>
                        <input type="text" id="vsRr" placeholder="16" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="2">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">Temp ¬∞F</label>
                        <input type="text" id="vsTemp" placeholder="98.6" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="5">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">O2%</label>
                        <input type="text" id="vsO2" placeholder="98" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="3">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">O2 Delivery</label>
                        <select id="vsO2Source" style="width: 100%; padding: 8px; font-size: 11px;">
                            <option value="RA">RA (Room Air)</option>
                            <optgroup label="Nasal Cannula">
                                <option value="1L NC">1L NC</option>
                                <option value="2L NC">2L NC</option>
                                <option value="3L NC">3L NC</option>
                                <option value="4L NC">4L NC</option>
                                <option value="5L NC">5L NC</option>
                                <option value="6L NC">6L NC</option>
                            </optgroup>
                            <optgroup label="Masks">
                                <option value="Simple Mask">Simple Mask</option>
                                <option value="Venturi Mask">Venturi Mask</option>
                                <option value="NRB">Non-Rebreather</option>
                                <option value="Partial Rebreather">Partial Rebreather</option>
                            </optgroup>
                            <optgroup label="High Flow / Advanced">
                                <option value="HFNC">High Flow NC (HFNC)</option>
                                <option value="CPAP">CPAP</option>
                                <option value="BiPAP">BiPAP</option>
                                <option value="Trach Collar">Trach Collar</option>
                                <option value="T-Piece">T-Piece</option>
                                <option value="Vent">Ventilator</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #2e7d32; font-weight: 600;">Pain (0-10)</label>
                        <input type="text" id="vsPain" placeholder="0" style="width: 100%; padding: 8px; font-size: 14px; text-align: center;" maxlength="2">
                    </div>
                </div>
                <p style="margin-top: 8px; font-size: 11px; color: #558b2f;">Click in a text field first, then click "Insert Vitals" to add formatted vitals.</p>
                </div>
            </div>

            <!-- Medication Administration Panel -->
            <div class="med-panel" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #1976d2; border-radius: 10px; padding: 15px 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="togglePanel('medContent', this)">
                    <h3 style="color: #1565c0; margin: 0;">üíä Medication Administration <span style="font-size: 12px; opacity: 0.7;">‚ñ∂</span></h3>
                    <button onclick="event.stopPropagation(); insertMedication()" style="background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Insert Med ‚ûú</button>
                </div>
                <div id="medContent" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                    <div class="drug-autocomplete-wrapper">
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Medication Name</label>
                        <input type="text" id="medName" placeholder="Start typing drug name..." style="width: 100%; padding: 8px; font-size: 13px;" autocomplete="off">
                        <div id="drugDropdown" class="drug-dropdown"></div>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Dose</label>
                        <input type="text" id="medDose" placeholder="e.g., 4mg" style="width: 100%; padding: 8px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Route</label>
                        <select id="medRoute" style="width: 100%; padding: 8px; font-size: 12px;">
                            <option value="PO">PO (by mouth)</option>
                            <option value="IV">IV (intravenous)</option>
                            <option value="IV Push">IV Push</option>
                            <option value="IVPB">IVPB (piggyback)</option>
                            <option value="IM">IM (intramuscular)</option>
                            <option value="SubQ">SubQ (subcutaneous)</option>
                            <option value="SL">SL (sublingual)</option>
                            <option value="PR">PR (rectal)</option>
                            <option value="Topical">Topical</option>
                            <option value="Inhaled">Inhaled</option>
                            <option value="Nasal">Nasal</option>
                            <option value="Ophthalmic">Ophthalmic</option>
                            <option value="Otic">Otic</option>
                            <option value="Transdermal">Transdermal</option>
                            <option value="GT">GT (gastrostomy)</option>
                            <option value="NGT">NGT (nasogastric)</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Site (if applicable)</label>
                        <select id="medSite" style="width: 100%; padding: 8px; font-size: 12px;">
                            <option value="">N/A</option>
                            <optgroup label="IV Sites">
                                <option value="R hand">R hand</option>
                                <option value="L hand">L hand</option>
                                <option value="R forearm">R forearm</option>
                                <option value="L forearm">L forearm</option>
                                <option value="R AC">R AC (antecubital)</option>
                                <option value="L AC">L AC (antecubital)</option>
                                <option value="PICC">PICC line</option>
                                <option value="Central line">Central line</option>
                                <option value="Port">Port</option>
                            </optgroup>
                            <optgroup label="IM/SubQ Sites">
                                <option value="R deltoid">R deltoid</option>
                                <option value="L deltoid">L deltoid</option>
                                <option value="R vastus lateralis">R vastus lateralis</option>
                                <option value="L vastus lateralis">L vastus lateralis</option>
                                <option value="R ventrogluteal">R ventrogluteal</option>
                                <option value="L ventrogluteal">L ventrogluteal</option>
                                <option value="Abdomen">Abdomen</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Time Given</label>
                        <input type="text" id="medTimeText" placeholder="N=now" style="display:none; width: 100%; padding: 8px; font-size: 13px;">
                        <input type="time" id="medTime" style="width: 100%; padding: 8px; font-size: 13px;" onfocus="showMedTimeShortcut()" onblur="hideMedTimeShortcut()">
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #1565c0; font-weight: 600;">Indication</label>
                        <input type="text" id="medIndication" placeholder="e.g., pain, HTN" style="width: 100%; padding: 8px; font-size: 13px;">
                    </div>
                </div>
                <p style="margin-top: 8px; font-size: 11px; color: #1565c0;">Click in a text field first, then click "Insert Med" to add medication documentation. Time: N=now, N+15, N-30</p>
                </div>
            </div>

            <h2 class="section-title">Documentation</h2>

            <div class="form-group" id="focusGroup">
                <label>FOCUS</label>
                <input type="text" id="focus" placeholder="e.g., Pain management, Fall risk, Post-op care">
            </div>

            <!-- DAR -->
            <div id="darFields" class="note-fields active">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">D</span><div class="field-info"><h4>Data</h4></div></div>
                    <textarea id="darData" class="large" placeholder="Subjective & objective data..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Action</h4></div></div>
                    <textarea id="darAction" class="large" placeholder="Nursing interventions..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">R</span><div class="field-info"><h4>Response</h4></div></div>
                    <textarea id="darResponse" placeholder="Patient response..."></textarea>
                </div>
            </div>

            <!-- DARP -->
            <div id="darpFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">D</span><div class="field-info"><h4>Data</h4></div></div>
                    <textarea id="darpData" class="large" placeholder="Subjective & objective data..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Action</h4></div></div>
                    <textarea id="darpAction" placeholder="Nursing interventions..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">R</span><div class="field-info"><h4>Response</h4></div></div>
                    <textarea id="darpResponse" placeholder="Patient response..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Plan</h4></div></div>
                    <textarea id="darpPlan" placeholder="Care plan..."></textarea>
                </div>
            </div>

            <!-- SOAP -->
            <div id="soapFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">S</span><div class="field-info"><h4>Subjective</h4></div></div>
                    <textarea id="soapSubjective" class="large" placeholder="Patient statements..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">O</span><div class="field-info"><h4>Objective</h4></div></div>
                    <textarea id="soapObjective" class="large" placeholder="Vital signs, observations..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Assessment</h4></div></div>
                    <textarea id="soapAssessment" placeholder="Nursing diagnosis..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Plan</h4></div></div>
                    <textarea id="soapPlan" placeholder="Care plan..."></textarea>
                </div>
            </div>

            <!-- SOAPIE -->
            <div id="soapieFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">S</span><div class="field-info"><h4>Subjective</h4></div></div>
                    <textarea id="soapieSubjective" placeholder="Patient statements..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">O</span><div class="field-info"><h4>Objective</h4></div></div>
                    <textarea id="soapieObjective" placeholder="VS, observations..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Assessment</h4></div></div>
                    <textarea id="soapieAssessment" placeholder="Nursing diagnosis..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Plan</h4></div></div>
                    <textarea id="soapiePlan" placeholder="Care plan..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">I</span><div class="field-info"><h4>Intervention</h4></div></div>
                    <textarea id="soapieIntervention" placeholder="Actions taken..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">E</span><div class="field-info"><h4>Evaluation</h4></div></div>
                    <textarea id="soapieEvaluation" placeholder="Effectiveness..."></textarea>
                </div>
            </div>

            <!-- SBAR -->
            <div id="sbarFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">S</span><div class="field-info"><h4>Situation</h4></div></div>
                    <textarea id="sbarSituation" class="large" placeholder="What is happening now?"></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">B</span><div class="field-info"><h4>Background</h4></div></div>
                    <textarea id="sbarBackground" class="large" placeholder="Relevant history..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">A</span><div class="field-info"><h4>Assessment</h4></div></div>
                    <textarea id="sbarAssessment" placeholder="What do you think is the problem?"></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">R</span><div class="field-info"><h4>Recommendation</h4></div></div>
                    <textarea id="sbarRecommendation" placeholder="What do you need?"></textarea>
                </div>
            </div>

            <!-- PIE -->
            <div id="pieFields" class="note-fields">
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">P</span><div class="field-info"><h4>Problem</h4></div></div>
                    <textarea id="pieProblem" class="large" placeholder="Nursing diagnosis or problem..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">I</span><div class="field-info"><h4>Intervention</h4></div></div>
                    <textarea id="pieIntervention" class="large" placeholder="Actions taken..."></textarea>
                </div>
                <div class="form-group">
                    <div class="field-header"><span class="field-letter">E</span><div class="field-info"><h4>Evaluation</h4></div></div>
                    <textarea id="pieEvaluation" placeholder="Effectiveness, outcomes..."></textarea>
                </div>
            </div>

            <!-- Narrative -->
            <div id="narrativeFields" class="note-fields">
                <div class="form-group">
                    <label>Narrative Note</label>
                    <textarea id="narrativeText" class="large" style="min-height:200px" placeholder="Document in free-form narrative format..."></textarea>
                </div>
            </div>

            <!-- Head-to-Toe Assessment -->
            <div id="h2tFields" class="note-fields">
                <p style="font-size:12px;color:#666;margin-bottom:15px;">Click quick-fill buttons to insert common findings, then edit as needed.</p>
                <div class="h2t-grid">
                    <div class="h2t-section">
                        <h4>Neurological</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'A&O x4. ')">A&O x4</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'PERRLA 3mm. ')">PERRLA</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'GCS 15. ')">GCS 15</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'MAE x4, strength 5/5. ')">MAE</span>
                            <span class="quick-fill" onclick="appendToField('h2tNeuro', 'No focal deficits. ')">No deficits</span>
                        </div>
                        <textarea id="h2tNeuro" placeholder="LOC, orientation, pupils, motor/sensory..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Cardiovascular</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'S1S2, RRR, no murmur. ')">S1S2 RRR</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Radial pulses 2+ bilat. ')">Pulses 2+</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Cap refill <3 sec. ')">Cap refill <3s</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'No peripheral edema. ')">No edema</span>
                            <span class="quick-fill" onclick="appendToField('h2tCardio', 'Pedal pulses palpable bilat. ')">Pedal pulses</span>
                        </div>
                        <textarea id="h2tCardio" placeholder="Heart sounds, pulses, edema, cap refill..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Respiratory</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'CTA bilat. ')">CTA bilat</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'Unlabored, regular. ')">Unlabored</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'RA, SpO2 WNL. ')">RA</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'O2 via NC _L/min. ')">O2 NC</span>
                            <span class="quick-fill" onclick="appendToField('h2tResp', 'No cough, no SOB. ')">No cough/SOB</span>
                        </div>
                        <textarea id="h2tResp" placeholder="Breath sounds, effort, O2, cough..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Gastrointestinal</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'BS active x4 quads. ')">BS active</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'Soft, non-tender, non-distended. ')">Soft NT ND</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'Last BM: ___. ')">Last BM</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'Tolerating diet. ')">Tolerating diet</span>
                            <span class="quick-fill" onclick="appendToField('h2tGI', 'No N/V. ')">No N/V</span>
                        </div>
                        <textarea id="h2tGI" placeholder="Bowel sounds, abdomen, N/V, diet, BM..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Genitourinary</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'Voiding without difficulty. ')">Voiding WNL</span>
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'Foley patent, clear yellow urine. ')">Foley patent</span>
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'Last void: ___. ')">Last void</span>
                            <span class="quick-fill" onclick="appendToField('h2tGU', 'I&O balanced. ')">I&O balanced</span>
                        </div>
                        <textarea id="h2tGU" placeholder="Voiding, Foley, output, color..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Skin/Integumentary</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'Warm, dry, intact. ')">WDI</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'Color appropriate. ')">Color WNL</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'Turgor elastic. ')">Turgor elastic</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'No breakdown, no pressure areas. ')">No breakdown</span>
                            <span class="quick-fill" onclick="appendToField('h2tSkin', 'IV site: ___. ')">IV site</span>
                        </div>
                        <textarea id="h2tSkin" placeholder="Color, temp, turgor, wounds, IV sites..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Musculoskeletal</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'ROM intact. ')">ROM intact</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Gait steady. ')">Gait steady</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Ambulating independently. ')">Ambulating</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Bed rest. ')">Bed rest</span>
                            <span class="quick-fill" onclick="appendToField('h2tMSK', 'Fall risk precautions. ')">Fall risk</span>
                        </div>
                        <textarea id="h2tMSK" placeholder="Mobility, ROM, strength, gait, fall risk..."></textarea>
                    </div>
                    <div class="h2t-section">
                        <h4>Pain/Comfort</h4>
                        <div class="quick-fills">
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Pain 0/10. ')">Pain 0/10</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Pain ___/10 at ___. ')">Pain __/10</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Denies pain. ')">Denies pain</span>
                            <span class="quick-fill" onclick="appendToField('h2tPain', 'Medicated for pain. ')">Medicated</span>
                        </div>
                        <textarea id="h2tPain" placeholder="Pain level, location, quality, interventions..."></textarea>
                    </div>
                </div>
                <div class="form-group" style="margin-top:15px;">
                    <label>Psychosocial/Additional Notes</label>
                    <textarea id="h2tPsych" placeholder="Mood, behavior, support system, safety concerns, plan..."></textarea>
                </div>
            </div>

            <div class="btn-container">
                <button class="btn btn-clear" onclick="clearForm()">Clear</button>
                <button class="btn btn-word" onclick="generateWord()">Export Word</button>
                <button class="btn btn-pdf" onclick="generatePDF()">Export PDF</button>
            </div>

            <!-- Admin Panel for Smart Phrases -->
            <div id="adminPanel" class="admin-panel hidden" style="margin-top: 30px; padding: 20px; background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px;">
                <h3 style="color: #e65100; margin-bottom: 15px;">‚öôÔ∏è Admin: Manage Smart Phrases</h3>
                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; align-items: end;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px;">Shortcut (e.g., .abc)</label>
                        <input type="text" id="newPhraseShortcut" placeholder=".shortcut" style="padding: 10px;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px;">Expansion Text</label>
                        <input type="text" id="newPhraseText" placeholder="Text that will replace the shortcut" style="padding: 10px;">
                    </div>
                    <button onclick="addCustomPhrase()" style="padding: 10px 20px; background: #ff9800; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Add Phrase</button>
                </div>
                <div id="customPhrasesList" style="margin-top: 15px;"></div>

                <!-- Pending Registrations Section -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #ffcc80;">
                    <h3 style="color: #e65100; margin-bottom: 15px;">üìã Pending Registrations <button onclick="refreshPendingUsers()" style="font-size: 12px; padding: 4px 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Refresh</button></h3>
                    <div id="pendingUsersList" style="margin-top: 10px;">
                        <p style="color: #666; font-style: italic;">Loading pending registrations...</p>
                    </div>
                </div>

                <!-- Approved Users Section -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #ffcc80;">
                    <h3 style="color: #e65100; margin-bottom: 15px;">‚úÖ Approved Users</h3>
                    <div id="approvedUsersList" style="margin-top: 10px;">
                        <p style="color: #666; font-style: italic;">Loading approved users...</p>
                    </div>
                </div>

                <!-- Manual User Add Section -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #ffcc80;">
                    <h3 style="color: #e65100; margin-bottom: 15px;">‚ûï Add User Manually</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">Full Name</label>
                            <input type="text" id="newUserName" placeholder="Jane Smith" style="padding: 10px;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">Username</label>
                            <input type="text" id="newUsername" placeholder="jsmith" style="padding: 10px;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">Password</label>
                            <input type="text" id="newUserPassword" placeholder="password" style="padding: 10px;">
                        </div>
                        <button onclick="addUserToSheet()" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Add</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6); font-size: 12px;">
        BSN9B Nursing Documentation Tool
    </footer>

    <script>
        const { jsPDF } = window.jspdf;
        let currentNoteType = 'dar';
        let selectedDiagnoses = [];

        // Google Apps Script API URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec';

        // Fetch all users from Google Sheet
        async function fetchAllUsers() {
            try {
                const response = await fetch(API_URL + '?action=getUsers');
                const data = await response.json();
                if (data.success) {
                    return data.users;
                }
            } catch (e) {
                console.error('Error fetching users:', e);
            }
            return [];
        }

        // Refresh and display pending users
        async function refreshPendingUsers() {
            const pendingContainer = document.getElementById('pendingUsersList');
            const approvedContainer = document.getElementById('approvedUsersList');

            if (pendingContainer) pendingContainer.innerHTML = '<p style="color: #666; font-style: italic;">Loading...</p>';
            if (approvedContainer) approvedContainer.innerHTML = '<p style="color: #666; font-style: italic;">Loading...</p>';

            const users = await fetchAllUsers();

            const pendingUsers = users.filter(u => u.status === 'pending');
            const approvedUsers = users.filter(u => u.status === 'approved');

            // Render pending users
            if (pendingContainer) {
                if (pendingUsers.length === 0) {
                    pendingContainer.innerHTML = '<p style="color: #666; font-style: italic;">No pending registrations.</p>';
                } else {
                    let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
                    html += '<tr style="background: #ffe0b2;"><th style="padding: 8px; text-align: left;">Name</th><th style="padding: 8px; text-align: left;">Username</th><th style="padding: 8px; text-align: left;">Email</th><th style="padding: 8px; text-align: left;">Date</th><th style="padding: 8px; width: 140px;">Actions</th></tr>';

                    for (const user of pendingUsers) {
                        html += '<tr style="border-bottom: 1px solid #ffcc80;">';
                        html += '<td style="padding: 8px;">' + (user.name || '-') + '</td>';
                        html += '<td style="padding: 8px;"><strong>' + user.username + '</strong></td>';
                        html += '<td style="padding: 8px;">' + (user.email || '-') + '</td>';
                        html += '<td style="padding: 8px;">' + (user.date || '-') + '</td>';
                        html += '<td style="padding: 8px;">';
                        html += '<button onclick="approveUser(\'' + user.username + '\')" style="background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Approve</button>';
                        html += '<button onclick="denyUser(\'' + user.username + '\')" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Deny</button>';
                        html += '</td></tr>';
                    }
                    html += '</table>';
                    pendingContainer.innerHTML = html;
                }
            }

            // Render approved users
            if (approvedContainer) {
                if (approvedUsers.length === 0) {
                    approvedContainer.innerHTML = '<p style="color: #666; font-style: italic;">No approved users yet.</p>';
                } else {
                    let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
                    html += '<tr style="background: #c8e6c9;"><th style="padding: 8px; text-align: left;">Name</th><th style="padding: 8px; text-align: left;">Username</th><th style="padding: 8px; text-align: left;">Email</th><th style="padding: 8px; width: 80px;">Actions</th></tr>';

                    for (const user of approvedUsers) {
                        html += '<tr style="border-bottom: 1px solid #a5d6a7;">';
                        html += '<td style="padding: 8px;">' + (user.name || '-') + '</td>';
                        html += '<td style="padding: 8px;"><strong>' + user.username + '</strong></td>';
                        html += '<td style="padding: 8px;">' + (user.email || '-') + '</td>';
                        html += '<td style="padding: 8px;">';
                        html += '<button onclick="revokeUser(\'' + user.username + '\')" style="background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Revoke</button>';
                        html += '</td></tr>';
                    }
                    html += '</table>';
                    approvedContainer.innerHTML = html;
                }
            }
        }

        // Approve a pending user
        async function approveUser(username) {
            if (!confirm('Approve user "' + username + '"?')) return;

            try {
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    username: username,
                    status: 'approved'
                });
                await fetch(API_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' });
                alert('User "' + username + '" approved!');
                setTimeout(refreshPendingUsers, 1000); // Refresh after a short delay
            } catch (e) {
                alert('Error approving user. Please try again.');
            }
        }

        // Deny/delete a pending user
        async function denyUser(username) {
            if (!confirm('Deny and remove user "' + username + '"?')) return;

            try {
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    username: username,
                    status: 'denied'
                });
                await fetch(API_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' });
                alert('User "' + username + '" denied.');
                setTimeout(refreshPendingUsers, 1000);
            } catch (e) {
                alert('Error denying user. Please try again.');
            }
        }

        // Revoke an approved user
        async function revokeUser(username) {
            if (!confirm('Revoke access for "' + username + '"?')) return;

            try {
                const params = new URLSearchParams({
                    action: 'updateStatus',
                    username: username,
                    status: 'revoked'
                });
                await fetch(API_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' });
                alert('User "' + username + '" access revoked.');
                setTimeout(refreshPendingUsers, 1000);
            } catch (e) {
                alert('Error revoking user. Please try again.');
            }
        }

        // Add user directly to sheet
        async function addUserToSheet() {
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const password = document.getElementById('newUserPassword').value;

            if (!username || !password) {
                alert('Please enter at least username and password.');
                return;
            }

            try {
                const params = new URLSearchParams({
                    action: 'addUser',
                    username: username,
                    password: password,
                    status: 'approved',
                    name: name,
                    email: ''
                });
                await fetch(API_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' });

                // Clear inputs
                document.getElementById('newUserName').value = '';
                document.getElementById('newUsername').value = '';
                document.getElementById('newUserPassword').value = '';

                alert('User "' + username + '" added and approved!');
                setTimeout(refreshPendingUsers, 1000);
            } catch (e) {
                alert('Error adding user. Please try again.');
            }
        }

        // Smart Phrases - type shortcut and it auto-expands
        let smartPhrases = {
            // Vital Signs
            '.vs': 'BP: __ | HR: __ | O2: __% | RR: __ | T: __ | Pain: __/10',
            // Neuro
            '.neuro': 'A&Ox4. PERRLA. GCS 15. MAE x4. ',
            '.aox4': 'Alert and oriented x4 (person, place, time, situation). ',
            '.aox3': 'Alert and oriented x3 (person, place, time). ',
            '.perrla': 'PERRLA (Pupils Equal, Round, Reactive to Light and Accommodation). ',
            '.mae': 'MAE x4 (Moving All Extremities). ',
            '.gcs15': 'GCS 15 (E4V5M6). ',
            // Respiratory
            '.resp': 'CTA bilat. No adventitious sounds. Unlabored. O2: __% on __. ',
            '.cta': 'CTA bilat (Clear to Auscultation bilaterally). ',
            '.lungs': 'Lung sounds clear bilaterally, no wheezes, crackles, or rhonchi. ',
            '.sob': 'Patient denies shortness of breath. Respirations unlabored. ',
            // Cardiovascular
            '.cv': 'S1S2 RRR. No murmurs. Pulses 2+ x4. Cap refill <3s. No edema. ',
            '.rrr': 'S1S2 RRR (Regular Rate and Rhythm). No murmurs, rubs, or gallops. ',
            '.pulses': 'Peripheral pulses 2+ bilaterally, cap refill <3 seconds. ',
            '.noedema': 'No peripheral edema noted. ',
            // GI
            '.gi': 'BS active x4 quads. Abdomen soft, NT, ND. Last BM: __. ',
            '.bsax4': 'BS active x4 quadrants. ',
            '.ntnd': 'Non-tender, non-distended. ',
            '.npo': 'Patient NPO. ',
            '.tolerated': 'Diet tolerated without nausea or vomiting. ',
            // GU
            '.gu': 'Voiding without difficulty. Urine clear yellow. ',
            '.fs': 'Foley catheter patent, draining clear yellow urine. Secured to thigh. ',
            '.voidclear': 'Voiding clear yellow urine without difficulty. ',
            // Skin
            '.skin': 'Warm, dry, intact. No breakdown or pressure injuries. ',
            '.wdi': 'Skin warm, dry, intact. ',
            '.turgor': 'Skin turgor elastic, no tenting. ',
            '.ivsite': 'IV site clean, dry, intact. No redness, swelling, or drainage. ',
            // Pain
            '.pain': 'Pain __/10 at __. Quality: __. Duration: __. Interventions: __. ',
            '.pain0': 'Patient denies pain. Pain 0/10. ',
            '.painmed': 'Pain medication administered as ordered. Will reassess in 30-60 min. ',
            // Allergies
            '.nkda': 'NKDA (No Known Drug Allergies). ',
            '.nka': 'NKA (No Known Allergies). ',
            // General Assessment
            '.denies': 'Patient denies pain, nausea, SOB, dizziness, chest pain. ',
            '.wnl': 'Within normal limits. ',
            '.nad': 'No acute distress. ',
            '.wdta': 'Will continue to monitor. Patient tolerated well. No adverse effects noted. ',
            // Interventions
            '.medadmin': 'Medication administered as ordered. Patient tolerated without adverse effects. ',
            '.ivp': 'IV patent, no redness/swelling at site. Flushed with 10mL NS. ',
            '.repos': 'Patient repositioned for comfort and pressure relief. ',
            '.amb': 'Assisted patient with ambulation in hallway. Gait steady, tolerated well. ',
            '.tcdb': 'Encouraged to turn, cough, and deep breathe. ',
            '.is': 'Incentive spirometer use encouraged. Patient demonstrated proper technique. ',
            '.scd': 'SCDs applied and functioning bilaterally. ',
            // Safety
            '.fall': 'Fall precautions in place. Bed in low position. Call light within reach. ',
            '.safe': 'Side rails up x2. Bed alarm on. Call light in reach. Non-skid socks on. ',
            '.idbands': 'ID bands verified x2. Patient confirmed identity. ',
            '.safeenv': 'Safe environment maintained: bed low, locked, call light in reach, side rails x2. ',
            // Communication
            '.mdnotify': 'MD notified of findings. Awaiting orders. ',
            '.neworders': 'New orders received from MD and implemented. ',
            '.handoff': 'Bedside handoff report given to oncoming nurse. ',
            // Education/Discharge
            '.edu': 'Patient educated on __. Patient verbalized understanding. ',
            '.dc': 'Discharge instructions reviewed with patient. Patient verbalized understanding. ',
            '.teachback': 'Patient able to teach back key information. ',
            '.dcteach': 'Discharge teaching completed. Patient/family verbalized understanding of medications, follow-up, and return precautions. '
        };

        // Smart phrase expansion function
        function expandSmartPhrases(e) {
            const textarea = e.target;
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;

            // Look for phrase shortcuts (words starting with .)
            for (const [shortcut, expansion] of Object.entries(smartPhrases)) {
                const regex = new RegExp(shortcut.replace('.', '\\.') + '(?=\\s|$)', 'gi');
                if (regex.test(text)) {
                    textarea.value = text.replace(regex, expansion);
                    // Adjust cursor position
                    const diff = expansion.length - shortcut.length;
                    textarea.selectionStart = textarea.selectionEnd = cursorPos + diff;
                    break;
                }
            }
        }

        // Track last active textarea for vitals insertion
        let lastActiveTextarea = null;
        document.addEventListener('focusin', function(e) {
            if (e.target.tagName === 'TEXTAREA') {
                lastActiveTextarea = e.target;
            }
        });

        // Insert formatted vitals into the last active textarea
        function insertVitals() {
            if (!lastActiveTextarea) {
                alert('Please click in a text field first, then click "Insert Vitals".');
                return;
            }

            const bpSys = document.getElementById('vsBpSys').value.trim();
            const bpDia = document.getElementById('vsBpDia').value.trim();
            const hr = document.getElementById('vsHr').value.trim();
            const rr = document.getElementById('vsRr').value.trim();
            const temp = document.getElementById('vsTemp').value.trim();
            const o2 = document.getElementById('vsO2').value.trim();
            const o2Source = document.getElementById('vsO2Source').value;
            const pain = document.getElementById('vsPain').value.trim();

            // Build vitals string, only include fields that have values
            let parts = [];
            if (bpSys && bpDia) parts.push(`BP ${bpSys}/${bpDia}`);
            if (hr) parts.push(`HR ${hr}`);
            if (rr) parts.push(`RR ${rr}`);
            if (temp) parts.push(`T ${temp}¬∞F`);
            if (o2) parts.push(`O2 ${o2}% ${o2Source}`);
            if (pain) parts.push(`Pain ${pain}/10`);

            if (parts.length === 0) {
                alert('Please enter at least one vital sign.');
                return;
            }

            const vitalsStr = 'VS: ' + parts.join(' | ') + '. ';

            // Insert at cursor position in textarea
            const start = lastActiveTextarea.selectionStart;
            const end = lastActiveTextarea.selectionEnd;
            const text = lastActiveTextarea.value;
            lastActiveTextarea.value = text.substring(0, start) + vitalsStr + text.substring(end);

            // Move cursor to end of inserted text
            lastActiveTextarea.selectionStart = lastActiveTextarea.selectionEnd = start + vitalsStr.length;
            lastActiveTextarea.focus();

            // Clear vitals fields
            document.getElementById('vsBpSys').value = '';
            document.getElementById('vsBpDia').value = '';
            document.getElementById('vsHr').value = '';
            document.getElementById('vsRr').value = '';
            document.getElementById('vsTemp').value = '';
            document.getElementById('vsO2').value = '';
            document.getElementById('vsPain').value = '';
        }

        // Insert formatted medication into the last active textarea
        function insertMedication() {
            if (!lastActiveTextarea) {
                alert('Please click in a text field first, then click "Insert Med".');
                return;
            }

            const name = document.getElementById('medName').value.trim();
            const dose = document.getElementById('medDose').value.trim();
            const route = document.getElementById('medRoute').value;
            const site = document.getElementById('medSite').value;
            const time = document.getElementById('medTime').value;
            const indication = document.getElementById('medIndication').value.trim();

            if (!name) {
                alert('Please enter at least a medication name.');
                return;
            }

            // Format time to 24hr
            let timeStr = '';
            if (time) {
                timeStr = time.replace(':', '');
            }

            // Build medication string
            let medStr = name;
            if (dose) medStr += ' ' + dose;
            medStr += ' ' + route;
            if (site) medStr += ' to ' + site;
            if (timeStr) medStr += ' @ ' + timeStr;
            if (indication) medStr += ' for ' + indication;
            medStr += '. Patient tolerated without adverse reaction. ';

            // Insert at cursor position in textarea
            const start = lastActiveTextarea.selectionStart;
            const end = lastActiveTextarea.selectionEnd;
            const text = lastActiveTextarea.value;
            lastActiveTextarea.value = text.substring(0, start) + medStr + text.substring(end);

            // Move cursor to end of inserted text
            lastActiveTextarea.selectionStart = lastActiveTextarea.selectionEnd = start + medStr.length;
            lastActiveTextarea.focus();

            // Clear med fields
            document.getElementById('medName').value = '';
            document.getElementById('medDose').value = '';
            document.getElementById('medSite').value = '';
            document.getElementById('medTime').value = '';
            document.getElementById('medIndication').value = '';
            // Also hide the dropdown
            document.getElementById('drugDropdown').classList.remove('show');
        }

        // Drug Autocomplete using NIH RxNav API
        let drugSearchTimeout = null;
        const drugDropdown = document.getElementById('drugDropdown');
        const medNameInput = document.getElementById('medName');

        medNameInput.addEventListener('input', function() {
            const query = this.value.trim();

            // Clear previous timeout
            if (drugSearchTimeout) {
                clearTimeout(drugSearchTimeout);
            }

            // Hide dropdown if query is too short
            if (query.length < 2) {
                drugDropdown.classList.remove('show');
                return;
            }

            // Show loading
            drugDropdown.innerHTML = '<div class="drug-loading">Searching...</div>';
            drugDropdown.classList.add('show');

            // Debounce the search (wait 300ms after typing stops)
            drugSearchTimeout = setTimeout(() => {
                searchDrugs(query);
            }, 300);
        });

        async function searchDrugs(query) {
            try {
                const response = await fetch(`https://rxnav.nlm.nih.gov/REST/spellingsuggestions.json?name=${encodeURIComponent(query)}`);
                const data = await response.json();

                let suggestions = [];
                if (data.suggestionGroup && data.suggestionGroup.suggestionList && data.suggestionGroup.suggestionList.suggestion) {
                    suggestions = data.suggestionGroup.suggestionList.suggestion.slice(0, 10);
                }

                // Also try approximate match for better results
                const approxResponse = await fetch(`https://rxnav.nlm.nih.gov/REST/approximateTerm.json?term=${encodeURIComponent(query)}&maxEntries=10`);
                const approxData = await approxResponse.json();

                if (approxData.approximateGroup && approxData.approximateGroup.candidate) {
                    approxData.approximateGroup.candidate.forEach(c => {
                        if (c.name && !suggestions.includes(c.name)) {
                            suggestions.push(c.name);
                        }
                    });
                }

                // Remove duplicates and limit to 10
                suggestions = [...new Set(suggestions)].slice(0, 10);

                if (suggestions.length === 0) {
                    drugDropdown.innerHTML = '<div class="drug-loading">No matches found. You can still type manually.</div>';
                } else {
                    drugDropdown.innerHTML = suggestions.map(drug =>
                        `<div class="drug-item" onclick="selectDrug('${drug.replace(/'/g, "\\'")}')">${drug}</div>`
                    ).join('');
                }
                drugDropdown.classList.add('show');
            } catch (error) {
                console.error('Drug search error:', error);
                drugDropdown.innerHTML = '<div class="drug-loading">Search unavailable. Type manually.</div>';
            }
        }

        function selectDrug(drugName) {
            medNameInput.value = drugName;
            drugDropdown.classList.remove('show');
            // Focus the dose field after selecting
            document.getElementById('medDose').focus();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.drug-autocomplete-wrapper')) {
                drugDropdown.classList.remove('show');
            }
        });

        // Load custom phrases from localStorage
        function loadCustomPhrases() {
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            if (custom) {
                const customPhrases = JSON.parse(custom);
                Object.assign(smartPhrases, customPhrases);
            }
        }

        // Save custom phrases to localStorage
        function saveCustomPhrases() {
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            const customPhrases = custom ? JSON.parse(custom) : {};
            localStorage.setItem('bsn9b_custom_phrases', JSON.stringify(customPhrases));
        }

        // Add a new custom phrase (admin only)
        function addCustomPhrase() {
            let shortcut = document.getElementById('newPhraseShortcut').value.trim().toLowerCase();
            const text = document.getElementById('newPhraseText').value.trim();

            if (!shortcut || !text) {
                alert('Please enter both a shortcut and expansion text.');
                return;
            }

            // Ensure shortcut starts with .
            if (!shortcut.startsWith('.')) {
                shortcut = '.' + shortcut;
            }

            // Add to smartPhrases
            smartPhrases[shortcut] = text;

            // Save to localStorage
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            const customPhrases = custom ? JSON.parse(custom) : {};
            customPhrases[shortcut] = text;
            localStorage.setItem('bsn9b_custom_phrases', JSON.stringify(customPhrases));

            // Clear inputs
            document.getElementById('newPhraseShortcut').value = '';
            document.getElementById('newPhraseText').value = '';

            // Refresh list
            renderCustomPhrases();
            alert('Smart phrase added: ' + shortcut);
        }

        // Delete a custom phrase
        function deleteCustomPhrase(shortcut) {
            delete smartPhrases[shortcut];

            const custom = localStorage.getItem('bsn9b_custom_phrases');
            if (custom) {
                const customPhrases = JSON.parse(custom);
                delete customPhrases[shortcut];
                localStorage.setItem('bsn9b_custom_phrases', JSON.stringify(customPhrases));
            }

            renderCustomPhrases();
        }

        // Render custom phrases list
        function renderCustomPhrases() {
            const container = document.getElementById('customPhrasesList');
            const custom = localStorage.getItem('bsn9b_custom_phrases');
            const customPhrases = custom ? JSON.parse(custom) : {};

            if (Object.keys(customPhrases).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No custom phrases added yet.</p>';
                return;
            }

            let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
            html += '<tr style="background: #ffe0b2;"><th style="padding: 8px; text-align: left;">Shortcut</th><th style="padding: 8px; text-align: left;">Expansion</th><th style="padding: 8px; width: 60px;"></th></tr>';

            for (const [shortcut, text] of Object.entries(customPhrases)) {
                html += `<tr style="border-bottom: 1px solid #ffcc80;">
                    <td style="padding: 8px;"><code style="background:#e65100;color:#fff;padding:2px 6px;border-radius:4px;">${shortcut}</code></td>
                    <td style="padding: 8px;">${text.substring(0, 60)}${text.length > 60 ? '...' : ''}</td>
                    <td style="padding: 8px;"><button onclick="deleteCustomPhrase('${shortcut}')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button></td>
                </tr>`;
            }
            html += '</table>';
            container.innerHTML = html;
        }

        // Simple hash for user passwords (same as login page)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Add a new custom user (admin only)
        function addCustomUser() {
            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const password = document.getElementById('newUserPassword').value;

            if (!username || !password) {
                alert('Please enter both username and password.');
                return;
            }

            // Reserved usernames
            const reserved = ['sumner', 'holdenc', 'np', 'instructor', 'admin'];
            if (reserved.includes(username)) {
                alert('This username is reserved. Please choose a different one.');
                return;
            }

            // Get existing custom users
            const stored = localStorage.getItem('bsn9b_custom_users');
            const customUsers = stored ? JSON.parse(stored) : {};

            // Add new user with hashed password
            customUsers[username] = { password: simpleHash(password) };
            localStorage.setItem('bsn9b_custom_users', JSON.stringify(customUsers));

            // Clear inputs
            document.getElementById('newUsername').value = '';
            document.getElementById('newUserPassword').value = '';

            renderCustomUsers();
            alert('User "' + username + '" added successfully!');
        }

        // Delete a custom user
        function deleteCustomUser(username) {
            if (!confirm('Delete user "' + username + '"?')) return;

            const stored = localStorage.getItem('bsn9b_custom_users');
            if (stored) {
                const customUsers = JSON.parse(stored);
                delete customUsers[username];
                localStorage.setItem('bsn9b_custom_users', JSON.stringify(customUsers));
            }
            renderCustomUsers();
        }

        // Render custom users list
        function renderCustomUsers() {
            const container = document.getElementById('customUsersList');
            if (!container) return;

            const stored = localStorage.getItem('bsn9b_custom_users');
            const customUsers = stored ? JSON.parse(stored) : {};

            if (Object.keys(customUsers).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No custom users added yet.</p>';
                return;
            }

            let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
            html += '<tr style="background: #ffe0b2;"><th style="padding: 8px; text-align: left;">Username</th><th style="padding: 8px; width: 60px;"></th></tr>';

            for (const username of Object.keys(customUsers)) {
                html += '<tr style="border-bottom: 1px solid #ffcc80;">';
                html += '<td style="padding: 8px;"><strong>' + username + '</strong></td>';
                html += '<td style="padding: 8px;"><button onclick="deleteCustomUser(\'' + username + '\')" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button></td>';
                html += '</tr>';
            }
            html += '</table>';
            container.innerHTML = html;
        }

        // Attach smart phrase listener to all textareas on load
        document.addEventListener('DOMContentLoaded', function() {
            // Load custom phrases
            loadCustomPhrases();

            // Attach listeners
            document.querySelectorAll('textarea').forEach(ta => {
                ta.addEventListener('input', expandSmartPhrases);
            });

            // Check if admin user, show admin panel
            const currentUser = sessionStorage.getItem('bsn9b_user');
            if (currentUser === 'admin' || currentUser === 'holdenc') {
                document.getElementById('adminPanel').classList.remove('hidden');
                renderCustomPhrases();
                refreshPendingUsers();
            }

            // Check URL param for direct admin access
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true' && (currentUser === 'admin' || currentUser === 'holdenc')) {
                document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
            }
        });

        // NANDA Database
        const nandaDatabase = [
            // Activity/Rest
            {name: "Activity intolerance", category: "Activity/Rest", def: "Insufficient physiological or psychological energy to endure or complete daily activities"},
            {name: "Activity intolerance, risk for", category: "Activity/Rest", def: "At risk for insufficient energy to complete daily activities"},
            {name: "Fatigue", category: "Activity/Rest", def: "Overwhelming sustained sense of exhaustion and decreased capacity for work"},
            {name: "Insomnia", category: "Activity/Rest", def: "Disruption in amount and quality of sleep that impairs functioning"},
            {name: "Mobility: physical, impaired", category: "Activity/Rest", def: "Limitation in independent, purposeful physical movement"},
            {name: "Mobility: bed, impaired", category: "Activity/Rest", def: "Limitation of independent movement from one bed position to another"},
            {name: "Sleep deprivation", category: "Activity/Rest", def: "Prolonged periods without sleep"},
            {name: "Sleep pattern disturbed", category: "Activity/Rest", def: "Time-limited interruptions of sleep amount and quality"},
            {name: "Walking, impaired", category: "Activity/Rest", def: "Limitation of independent movement within environment on foot"},
            // Circulation
            {name: "Bleeding, risk for", category: "Circulation", def: "At risk for decrease in blood volume that may compromise health"},
            {name: "Cardiac output, decreased", category: "Circulation", def: "Inadequate blood pumped by heart to meet metabolic demands"},
            {name: "Tissue perfusion, ineffective peripheral", category: "Circulation", def: "Decrease in blood circulation to peripheries that may compromise health"},
            {name: "Tissue perfusion, ineffective cerebral, risk for", category: "Circulation", def: "Risk for decrease in cerebral tissue circulation"},
            {name: "Shock, risk for", category: "Circulation", def: "At risk for inadequate blood flow to body tissues"},
            // Ego Integrity
            {name: "Anxiety", category: "Ego Integrity", def: "Vague uneasy feeling of discomfort or dread with autonomic response"},
            {name: "Anxiety, death", category: "Ego Integrity", def: "Vague uneasy feeling generated by perceptions of threat to existence"},
            {name: "Body image, disturbed", category: "Ego Integrity", def: "Confusion in mental picture of one's physical self"},
            {name: "Coping, ineffective", category: "Ego Integrity", def: "Inability to form valid appraisal of stressors or access resources"},
            {name: "Fear", category: "Ego Integrity", def: "Response to perceived threat consciously recognized as danger"},
            {name: "Grieving", category: "Ego Integrity", def: "Normal complex process incorporating actual or anticipated loss"},
            {name: "Grieving, complicated", category: "Ego Integrity", def: "Disorder where bereavement distress manifests in functional impairment"},
            {name: "Hopelessness", category: "Ego Integrity", def: "State where individual sees limited alternatives and unable to mobilize energy"},
            {name: "Powerlessness", category: "Ego Integrity", def: "Perception that one's actions will not significantly affect outcome"},
            {name: "Self-esteem, chronic low", category: "Ego Integrity", def: "Long-standing negative self-evaluation/feelings about self"},
            {name: "Self-esteem, situational low", category: "Ego Integrity", def: "Development of negative perception of self-worth in response to situation"},
            // Elimination
            {name: "Bowel incontinence", category: "Elimination", def: "Change in bowel habits characterized by involuntary passage of stool"},
            {name: "Constipation", category: "Elimination", def: "Decrease in frequency of defecation with difficult or incomplete passage"},
            {name: "Constipation, risk for", category: "Elimination", def: "At risk for decrease in normal frequency of defecation"},
            {name: "Diarrhea", category: "Elimination", def: "Passage of loose, unformed stools"},
            {name: "Urinary elimination, impaired", category: "Elimination", def: "Disturbance in urine elimination"},
            {name: "Urinary incontinence, functional", category: "Elimination", def: "Inability to reach toilet in time to avoid unintentional loss of urine"},
            {name: "Urinary incontinence, stress", category: "Elimination", def: "Sudden leakage with activities that increase intra-abdominal pressure"},
            {name: "Urinary incontinence, urge", category: "Elimination", def: "Involuntary passage soon after strong sense of urgency"},
            {name: "Urinary retention", category: "Elimination", def: "Incomplete emptying of the bladder"},
            // Food/Fluid
            {name: "Fluid volume, deficient", category: "Food/Fluid", def: "Decreased intravascular, interstitial and/or intracellular fluid"},
            {name: "Fluid volume, deficient, risk for", category: "Food/Fluid", def: "At risk for vascular, cellular, or intracellular dehydration"},
            {name: "Fluid volume, excess", category: "Food/Fluid", def: "Increased isotonic fluid retention"},
            {name: "Electrolyte imbalance, risk for", category: "Food/Fluid", def: "At risk for change in serum electrolyte levels"},
            {name: "Nutrition: imbalanced, less than body requirements", category: "Food/Fluid", def: "Intake of nutrients insufficient to meet metabolic needs"},
            {name: "Nutrition: imbalanced, more than body requirements", category: "Food/Fluid", def: "Intake of nutrients that exceeds metabolic needs"},
            {name: "Nausea", category: "Food/Fluid", def: "Subjective unpleasant wave-like sensation that may lead to vomiting"},
            {name: "Swallowing, impaired", category: "Food/Fluid", def: "Abnormal functioning of swallowing mechanism"},
            // Neurosensory
            {name: "Confusion, acute", category: "Neurosensory", def: "Abrupt onset of reversible disturbances of consciousness and cognition"},
            {name: "Confusion, chronic", category: "Neurosensory", def: "Irreversible progressive deterioration of intellect and personality"},
            {name: "Communication, impaired verbal", category: "Neurosensory", def: "Decreased ability to receive, process, transmit, and use symbols"},
            {name: "Memory, impaired", category: "Neurosensory", def: "Inability to remember or recall bits of information"},
            {name: "Sensory perception, disturbed", category: "Neurosensory", def: "Change in amount or patterning of incoming stimuli"},
            // Pain/Discomfort
            {name: "Pain, acute", category: "Pain/Discomfort", def: "Unpleasant sensory experience from actual or potential tissue damage, <6 months"},
            {name: "Pain, chronic", category: "Pain/Discomfort", def: "Unpleasant sensory experience without predictable end, >6 months"},
            {name: "Comfort, impaired", category: "Pain/Discomfort", def: "Perceived lack of ease, relief in physical/psychospiritual dimensions"},
            // Respiration
            {name: "Airway clearance, ineffective", category: "Respiration", def: "Inability to clear secretions or obstructions from respiratory tract"},
            {name: "Aspiration, risk for", category: "Respiration", def: "At risk for entry of secretions into tracheobronchial passages"},
            {name: "Breathing pattern, ineffective", category: "Respiration", def: "Inspiration/expiration that does not provide adequate ventilation"},
            {name: "Gas exchange, impaired", category: "Respiration", def: "Excess or deficit in oxygenation at alveolar-capillary membrane"},
            // Safety
            {name: "Falls, risk for", category: "Safety", def: "Increased susceptibility to falling that may cause physical harm"},
            {name: "Infection, risk for", category: "Safety", def: "At increased risk for being invaded by pathogenic organisms"},
            {name: "Injury, risk for", category: "Safety", def: "At risk of injury from environmental conditions"},
            {name: "Skin integrity, impaired", category: "Safety", def: "Altered epidermis and/or dermis"},
            {name: "Skin integrity, impaired, risk for", category: "Safety", def: "At risk for skin being adversely altered"},
            {name: "Hypothermia", category: "Safety", def: "Body temperature below normal range"},
            {name: "Hyperthermia", category: "Safety", def: "Body temperature elevated above normal range"},
            {name: "Trauma, risk for", category: "Safety", def: "Accentuated risk of accidental tissue injury"},
            // Hygiene
            {name: "Self-care deficit, bathing", category: "Hygiene", def: "Impaired ability to perform bathing activities"},
            {name: "Self-care deficit, dressing", category: "Hygiene", def: "Impaired ability to perform dressing activities"},
            {name: "Self-care deficit, feeding", category: "Hygiene", def: "Impaired ability to perform feeding activities"},
            {name: "Self-care deficit, toileting", category: "Hygiene", def: "Impaired ability to perform toileting activities"},
            // Knowledge
            {name: "Knowledge deficient", category: "Health Promotion", def: "Absence of cognitive information related to specific topic"},
            {name: "Noncompliance", category: "Health Promotion", def: "Behavior that fails to coincide with therapeutic plan"}
        ];

        // Date/Time Shortcut Functions
        function showDateShortcut() {
            const dateInput = document.getElementById('noteDate');
            const textInput = document.getElementById('noteDateText');
            textInput.style.display = 'block';
            dateInput.style.display = 'none';
            textInput.value = '';
            textInput.focus();
            textInput.addEventListener('blur', processDateShortcut);
            textInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    processDateShortcut();
                }
            });
        }

        function hideDateShortcut() {
            // This is called but we process in processDateShortcut
        }

        function processDateShortcut() {
            const textInput = document.getElementById('noteDateText');
            const dateInput = document.getElementById('noteDate');
            const val = textInput.value.trim().toUpperCase();

            if (val) {
                const today = new Date();
                let targetDate = today;

                if (val === 'T' || val === 'TODAY') {
                    targetDate = today;
                } else if (val.match(/^T\s*[\+\-]\s*\d+$/)) {
                    const match = val.match(/^T\s*([\+\-])\s*(\d+)$/);
                    const sign = match[1] === '+' ? 1 : -1;
                    const days = parseInt(match[2]);
                    targetDate = new Date(today);
                    targetDate.setDate(today.getDate() + (sign * days));
                }

                // Format as YYYY-MM-DD for input
                const year = targetDate.getFullYear();
                const month = String(targetDate.getMonth() + 1).padStart(2, '0');
                const day = String(targetDate.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            }

            textInput.style.display = 'none';
            dateInput.style.display = 'block';
            textInput.removeEventListener('blur', processDateShortcut);
        }

        function showTimeShortcut() {
            const timeInput = document.getElementById('noteTime');
            const textInput = document.getElementById('noteTimeText');
            textInput.style.display = 'block';
            timeInput.style.display = 'none';
            textInput.value = '';
            textInput.focus();
            textInput.addEventListener('blur', processTimeShortcut);
            textInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    processTimeShortcut();
                }
            });
        }

        function hideTimeShortcut() {
            // This is called but we process in processTimeShortcut
        }

        function processTimeShortcut() {
            const textInput = document.getElementById('noteTimeText');
            const timeInput = document.getElementById('noteTime');
            const val = textInput.value.trim().toUpperCase();

            if (val) {
                const now = new Date();
                let targetTime = now;

                if (val === 'N' || val === 'NOW') {
                    targetTime = now;
                } else if (val.match(/^N\s*[\+\-]\s*\d+$/)) {
                    const match = val.match(/^N\s*([\+\-])\s*(\d+)$/);
                    const sign = match[1] === '+' ? 1 : -1;
                    const minutes = parseInt(match[2]);
                    targetTime = new Date(now);
                    targetTime.setMinutes(now.getMinutes() + (sign * minutes));
                }

                // Format as HH:MM for input
                const hours = String(targetTime.getHours()).padStart(2, '0');
                const mins = String(targetTime.getMinutes()).padStart(2, '0');
                timeInput.value = `${hours}:${mins}`;
            }

            textInput.style.display = 'none';
            timeInput.style.display = 'block';
            textInput.removeEventListener('blur', processTimeShortcut);
        }

        // Med Time shortcuts (same logic as note time)
        function showMedTimeShortcut() {
            const timeInput = document.getElementById('medTime');
            const textInput = document.getElementById('medTimeText');
            textInput.style.display = 'block';
            timeInput.style.display = 'none';
            textInput.value = '';
            textInput.focus();
            textInput.addEventListener('blur', processMedTimeShortcut);
            textInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    processMedTimeShortcut();
                }
            });
        }

        function hideMedTimeShortcut() {
            // Handled in processMedTimeShortcut
        }

        function processMedTimeShortcut() {
            const textInput = document.getElementById('medTimeText');
            const timeInput = document.getElementById('medTime');
            const val = textInput.value.trim().toUpperCase();

            if (val) {
                const now = new Date();
                let targetTime = now;

                if (val === 'N' || val === 'NOW') {
                    targetTime = now;
                } else if (val.match(/^N\s*[\+\-]\s*\d+$/)) {
                    const match = val.match(/^N\s*([\+\-])\s*(\d+)$/);
                    const sign = match[1] === '+' ? 1 : -1;
                    const minutes = parseInt(match[2]);
                    targetTime = new Date(now);
                    targetTime.setMinutes(now.getMinutes() + (sign * minutes));
                }

                const hours = String(targetTime.getHours()).padStart(2, '0');
                const mins = String(targetTime.getMinutes()).padStart(2, '0');
                timeInput.value = `${hours}:${mins}`;
            }

            textInput.style.display = 'none';
            timeInput.style.display = 'block';
            textInput.removeEventListener('blur', processMedTimeShortcut);
        }

        // Toggle collapsible panels
        function togglePanel(panelId, headerEl) {
            const panel = document.getElementById(panelId);
            const arrow = headerEl.querySelector('h3 span');
            const isHidden = panel.style.display === 'none';

            if (isHidden) {
                panel.style.display = 'block';
                if (arrow) arrow.textContent = '‚ñº';
            } else {
                panel.style.display = 'none';
                if (arrow) arrow.textContent = '‚ñ∂';
            }
        }

        // Initialize
        document.getElementById('noteDate').valueAsDate = new Date();
        document.getElementById('noteTime').value = new Date().toTimeString().slice(0, 5);

        function selectNoteType(type) {
            currentNoteType = type;
            document.querySelectorAll('.note-type-card').forEach(c => c.classList.remove('active'));
            event.target.closest('.note-type-card').classList.add('active');
            document.querySelectorAll('.note-fields').forEach(f => f.classList.remove('active'));
            document.getElementById(type + 'Fields').classList.add('active');
            document.getElementById('focusGroup').style.display = ['dar', 'darp'].includes(type) ? 'block' : 'none';
        }

        function searchNanda() {
            const query = document.getElementById('nandaSearch').value.toLowerCase();
            const dropdown = document.getElementById('nandaDropdown');
            if (query.length < 2) { dropdown.classList.remove('show'); return; }
            const results = nandaDatabase.filter(d =>
                d.name.toLowerCase().includes(query) ||
                d.category.toLowerCase().includes(query) ||
                d.def.toLowerCase().includes(query)
            ).slice(0, 10);
            if (results.length === 0) { dropdown.classList.remove('show'); return; }
            dropdown.innerHTML = results.map(d =>
                `<div class="nanda-item" onclick="addDiagnosis('${d.name.replace(/'/g, "\\'")}')">
                    <div class="category">${d.category}</div>
                    <div>${d.name}</div>
                </div>`
            ).join('');
            dropdown.classList.add('show');
        }

        function addDiagnosis(name) {
            if (!selectedDiagnoses.includes(name)) {
                selectedDiagnoses.push(name);
                renderDiagnoses();
            }
            document.getElementById('nandaSearch').value = '';
            document.getElementById('nandaDropdown').classList.remove('show');
        }

        function removeDiagnosis(name) {
            selectedDiagnoses = selectedDiagnoses.filter(d => d !== name);
            renderDiagnoses();
        }

        function renderDiagnoses() {
            document.getElementById('selectedDiagnoses').innerHTML = selectedDiagnoses.map(d =>
                `<div class="diagnosis-tag">${d}<span class="remove" onclick="removeDiagnosis('${d.replace(/'/g, "\\'")}')">&times;</span></div>`
            ).join('');
        }

        function appendToField(fieldId, text) {
            const field = document.getElementById(fieldId);
            field.value += text;
            field.focus();
        }

        function clearForm() {
            if (!confirm('Clear all fields?')) return;
            document.querySelectorAll('input:not([type="date"]):not([type="time"]), textarea').forEach(el => el.value = '');
            document.getElementById('noteDate').valueAsDate = new Date();
            document.getElementById('noteTime').value = new Date().toTimeString().slice(0, 5);
            selectedDiagnoses = [];
            renderDiagnoses();
        }

        function formatTime(t) { return t.replace(':', ''); }

        function getFormData() {
            return {
                nurseName: document.getElementById('nurseName').value || 'N/A',
                credentials: document.getElementById('credentials').value,
                noteDate: new Date(document.getElementById('noteDate').value + 'T00:00:00').toLocaleDateString('en-US', {month:'numeric',day:'numeric',year:'2-digit'}),
                noteTime: formatTime(document.getElementById('noteTime').value),
                unit: document.getElementById('unit').value || '',
                patientId: document.getElementById('patientId').value || 'N/A',
                patientDemo: document.getElementById('patientDemo').value || '',
                focus: document.getElementById('focus').value || ''
            };
        }

        function getNoteContent() {
            const c = [], t = currentNoteType;
            if (t === 'dar') {
                c.push({l:'D',t:'Data',x:document.getElementById('darData').value});
                c.push({l:'A',t:'Action',x:document.getElementById('darAction').value});
                c.push({l:'R',t:'Response',x:document.getElementById('darResponse').value});
            } else if (t === 'darp') {
                c.push({l:'D',t:'Data',x:document.getElementById('darpData').value});
                c.push({l:'A',t:'Action',x:document.getElementById('darpAction').value});
                c.push({l:'R',t:'Response',x:document.getElementById('darpResponse').value});
                c.push({l:'P',t:'Plan',x:document.getElementById('darpPlan').value});
            } else if (t === 'soap') {
                c.push({l:'S',t:'Subjective',x:document.getElementById('soapSubjective').value});
                c.push({l:'O',t:'Objective',x:document.getElementById('soapObjective').value});
                c.push({l:'A',t:'Assessment',x:document.getElementById('soapAssessment').value});
                c.push({l:'P',t:'Plan',x:document.getElementById('soapPlan').value});
            } else if (t === 'soapie') {
                c.push({l:'S',t:'Subjective',x:document.getElementById('soapieSubjective').value});
                c.push({l:'O',t:'Objective',x:document.getElementById('soapieObjective').value});
                c.push({l:'A',t:'Assessment',x:document.getElementById('soapieAssessment').value});
                c.push({l:'P',t:'Plan',x:document.getElementById('soapiePlan').value});
                c.push({l:'I',t:'Intervention',x:document.getElementById('soapieIntervention').value});
                c.push({l:'E',t:'Evaluation',x:document.getElementById('soapieEvaluation').value});
            } else if (t === 'sbar') {
                c.push({l:'S',t:'Situation',x:document.getElementById('sbarSituation').value});
                c.push({l:'B',t:'Background',x:document.getElementById('sbarBackground').value});
                c.push({l:'A',t:'Assessment',x:document.getElementById('sbarAssessment').value});
                c.push({l:'R',t:'Recommendation',x:document.getElementById('sbarRecommendation').value});
            } else if (t === 'pie') {
                c.push({l:'P',t:'Problem',x:document.getElementById('pieProblem').value});
                c.push({l:'I',t:'Intervention',x:document.getElementById('pieIntervention').value});
                c.push({l:'E',t:'Evaluation',x:document.getElementById('pieEvaluation').value});
            } else if (t === 'narrative') {
                c.push({l:'',t:'Narrative',x:document.getElementById('narrativeText').value});
            } else if (t === 'h2t') {
                c.push({l:'',t:'Neurological',x:document.getElementById('h2tNeuro').value});
                c.push({l:'',t:'Cardiovascular',x:document.getElementById('h2tCardio').value});
                c.push({l:'',t:'Respiratory',x:document.getElementById('h2tResp').value});
                c.push({l:'',t:'Gastrointestinal',x:document.getElementById('h2tGI').value});
                c.push({l:'',t:'Genitourinary',x:document.getElementById('h2tGU').value});
                c.push({l:'',t:'Skin/Integumentary',x:document.getElementById('h2tSkin').value});
                c.push({l:'',t:'Musculoskeletal',x:document.getElementById('h2tMSK').value});
                c.push({l:'',t:'Pain/Comfort',x:document.getElementById('h2tPain').value});
                c.push({l:'',t:'Psychosocial/Notes',x:document.getElementById('h2tPsych').value});
            }
            return c.filter(i => i.x);
        }

        function generatePDF() {
            const doc = new jsPDF();
            const pw = doc.internal.pageSize.getWidth();
            const m = 18;
            const cw = pw - m*2;
            let y = 15;
            const d = getFormData();
            const nc = getNoteContent();
            const tn = {dar:'DAR',darp:'DARP',soap:'SOAP',soapie:'SOAPIE',sbar:'SBAR',pie:'PIE',h2t:'Head-to-Toe Assessment',narrative:'Narrative Note'};

            // Header
            doc.setFillColor(31, 78, 121);
            doc.rect(0, 0, pw, 28, 'F');
            doc.setTextColor(255);
            doc.setFontSize(18);
            doc.setFont('helvetica','bold');
            doc.text('Sumner College - Bend Nursing Progress Note', pw/2, 12, {align:'center'});
            doc.setFontSize(11);
            doc.setFont('helvetica','normal');
            doc.text(tn[currentNoteType], pw/2, 22, {align:'center'});

            y = 36;
            doc.setTextColor(0);

            // Info box
            doc.setFillColor(248, 250, 252);
            doc.setDrawColor(31, 78, 121);
            doc.setLineWidth(0.3);
            doc.roundedRect(m, y, cw, 24, 2, 2, 'FD');
            doc.setFontSize(9);
            y += 8;
            doc.setFont('helvetica','bold');
            doc.text('Nurse:', m+4, y);
            doc.setFont('helvetica','normal');
            doc.text(`${d.nurseName}, ${d.credentials}`, m+18, y);
            doc.setFont('helvetica','bold');
            doc.text('Date/Time:', m+85, y);
            doc.setFont('helvetica','normal');
            doc.text(`${d.noteDate} @ ${d.noteTime}`, m+108, y);
            y += 8;
            doc.setFont('helvetica','bold');
            doc.text('Patient:', m+4, y);
            doc.setFont('helvetica','normal');
            doc.text(d.patientDemo ? `${d.patientId} (${d.patientDemo})` : d.patientId, m+22, y);
            if(d.unit){doc.setFont('helvetica','bold');doc.text('Unit:',m+85,y);doc.setFont('helvetica','normal');doc.text(d.unit,m+98,y);}
            y += 14;

            // NANDA diagnoses
            if (selectedDiagnoses.length > 0) {
                doc.setFillColor(240, 249, 255);
                doc.setDrawColor(31, 78, 121);
                const dxText = 'Nursing Dx: ' + selectedDiagnoses.join('; ');
                const dxLines = doc.splitTextToSize(dxText, cw - 8);
                const dxH = 8 + dxLines.length * 4;
                doc.roundedRect(m, y, cw, dxH, 2, 2, 'FD');
                doc.setFontSize(9);
                doc.setTextColor(31, 78, 121);
                doc.setFont('helvetica','normal');
                let dy = y + 6;
                dxLines.forEach(line => { doc.text(line, m + 4, dy); dy += 4; });
                y += dxH + 4;
                doc.setTextColor(0);
            }

            // Focus
            if (['dar','darp'].includes(currentNoteType) && d.focus) {
                doc.setFillColor(31, 78, 121);
                doc.roundedRect(m, y, cw, 10, 2, 2, 'F');
                doc.setTextColor(255);
                doc.setFontSize(10);
                doc.setFont('helvetica','bold');
                doc.text('FOCUS: ' + d.focus, m + 4, y + 7);
                y += 14;
                doc.setTextColor(0);
            }

            // Content
            nc.forEach(s => {
                const lines = doc.splitTextToSize(s.x, cw - 4);
                const sh = 12 + lines.length * 4.5;
                if (y + sh > 280) { doc.addPage(); y = 15; }

                // Section header - inline bold label
                doc.setFontSize(10);
                doc.setFont('helvetica','bold');
                doc.setTextColor(31, 78, 121);
                const label = s.l ? (s.l + ' - ' + s.t + ':') : (s.t + ':');
                doc.text(label, m, y + 5);

                y += 9;
                doc.setFont('helvetica','normal');
                doc.setFontSize(9);
                doc.setTextColor(50);
                lines.forEach(line => {
                    if (y > 280) { doc.addPage(); y = 15; }
                    doc.text(line, m + 2, y);
                    y += 4.5;
                });
                y += 4;
            });

            // Signature
            y += 8;
            if (y > 265) { doc.addPage(); y = 15; }
            doc.setDrawColor(180);
            doc.setLineWidth(0.2);
            doc.line(m, y, m + 70, y);
            doc.setFontSize(9);
            doc.setTextColor(0);
            doc.text(`${d.nurseName}, ${d.credentials}`, m, y + 6);
            doc.text(`${d.noteDate} @ ${d.noteTime}`, m, y + 11);

            // Disclaimer
            doc.setFontSize(7);
            doc.setTextColor(140);
            doc.text('*Patient demographics are simulated for educational purposes. No real patient information.', pw/2, 290, {align:'center'});

            // Get last name from nurse name (last word)
            const nameParts = d.nurseName.trim().split(' ');
            const lastName = nameParts[nameParts.length - 1] || 'Student';
            doc.save(`${document.getElementById('noteDate').value}_${d.noteTime}_${currentNoteType.toUpperCase()}_${lastName}.pdf`);
        }

        async function generateWord() {
            try {
                const d = getFormData();
                const nc = getNoteContent();
                const tn = {dar:'DAR',darp:'DARP',soap:'SOAP',soapie:'SOAPIE',sbar:'SBAR',pie:'PIE',h2t:'Head-to-Toe Assessment',narrative:'Narrative Note'};

                if (typeof docx === 'undefined') {
                    alert('Word export library not loaded. Please try PDF export instead.');
                    return;
                }

                const { Document, Packer, Paragraph, TextRun, AlignmentType } = docx;
                const ch = [];

                // Title
                ch.push(new Paragraph({
                    children: [new TextRun({text: 'Sumner College - Bend Nursing Progress Note', bold: true, size: 32, color: '1f4e79'})],
                    alignment: AlignmentType.CENTER,
                    spacing: {after: 100}
                }));

                // Note type
                ch.push(new Paragraph({
                    children: [new TextRun({text: tn[currentNoteType], size: 22, color: '1f4e79'})],
                    alignment: AlignmentType.CENTER,
                    spacing: {after: 200}
                }));

                // Nurse and date info
                ch.push(new Paragraph({
                    children: [
                        new TextRun({text: 'Nurse: ', bold: true}),
                        new TextRun(d.nurseName + ', ' + d.credentials),
                        new TextRun({text: '    Date/Time: ', bold: true}),
                        new TextRun(d.noteDate + ' @ ' + d.noteTime)
                    ],
                    spacing: {after: 80}
                }));

                // Patient info
                const patientChildren = [
                    new TextRun({text: 'Patient: ', bold: true}),
                    new TextRun(d.patientDemo ? d.patientId + ' (' + d.patientDemo + ')' : d.patientId)
                ];
                if (d.unit) {
                    patientChildren.push(new TextRun({text: '    Unit: ', bold: true}));
                    patientChildren.push(new TextRun(d.unit));
                }
                ch.push(new Paragraph({children: patientChildren, spacing: {after: 150}}));

                // NANDA diagnoses
                if (selectedDiagnoses.length > 0) {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: 'Nursing Dx: ' + selectedDiagnoses.join('; '), color: '1f4e79'})],
                        spacing: {after: 150}
                    }));
                }

                // Focus (for DAR/DARP)
                if (['dar','darp'].includes(currentNoteType) && d.focus) {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: 'FOCUS: ' + d.focus, bold: true, color: '1f4e79'})],
                        spacing: {after: 150}
                    }));
                }

                // Note content
                nc.forEach(s => {
                    ch.push(new Paragraph({
                        children: [new TextRun({text: (s.l ? s.l + ' - ' : '') + s.t, bold: true, size: 22, color: '1f4e79'})],
                        spacing: {before: 150, after: 80}
                    }));
                    ch.push(new Paragraph({
                        children: [new TextRun(s.x)],
                        spacing: {after: 120}
                    }));
                });

                // Disclaimer
                ch.push(new Paragraph({text: '', spacing: {before: 200}}));
                ch.push(new Paragraph({
                    children: [new TextRun({text: '*Patient demographics are simulated for educational purposes. No real patient information.', italics: true, size: 18, color: '666666'})],
                    spacing: {after: 200}
                }));

                // Signature line
                ch.push(new Paragraph({children: [new TextRun('________________________________')]}));
                ch.push(new Paragraph({children: [new TextRun(d.nurseName + ', ' + d.credentials)], spacing: {after: 40}}));
                ch.push(new Paragraph({children: [new TextRun(d.noteDate + ' @ ' + d.noteTime)]}));

                const doc = new Document({sections: [{children: ch}]});
                const blob = await Packer.toBlob(doc);
                // Get last name from nurse name (last word)
                const nameParts = d.nurseName.trim().split(' ');
                const lastName = nameParts[nameParts.length - 1] || 'Student';
                saveAs(blob, document.getElementById('noteDate').value + '_' + d.noteTime + '_' + currentNoteType.toUpperCase() + '_' + lastName + '.docx');

            } catch(e) {
                console.error('Word export error:', e);
                alert('Error generating Word document: ' + e.message + '\n\nPlease try PDF export instead.');
            }
        }

        document.addEventListener('click', e => {
            if (!e.target.closest('.nanda-search')) document.getElementById('nandaDropdown').classList.remove('show');
        });
    </script>
</body>
</html>
