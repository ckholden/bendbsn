<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>if(location.protocol !== 'https:' && location.hostname !== 'localhost'){location.replace('https:' + location.href.substring(location.protocol.length));}</script>
    <script>
        if (localStorage.getItem('bsn9b_auth') !== 'true') {
            window.location.href = '/';
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#1f4e79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSN9B">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <!-- Preconnect hints for faster external resource loading -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <title>Community Hub - BSN9B</title>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-page: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #fafafa;
            --bg-input: #fafafa;
            --text-primary: #1a1a2e;
            --text-secondary: #666666;
            --accent: #1f4e79;
            --accent-light: #2d5a87;
            --shadow: rgba(0,0,0,0.4);
            --border: #e0e0e0;
            --chat-msg-other-bg: #e2e8f0;
        }

        [data-theme="dark"] {
            --bg-page: linear-gradient(135deg, #0a0a14 0%, #0d1117 50%, #161b22 100%);
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #1e2a3a;
            --bg-input: #16213e;
            --text-primary: #e6e6e6;
            --text-secondary: #aaaaaa;
            --accent: #4a90d9;
            --accent-light: #5a9fe8;
            --shadow: rgba(0,0,0,0.6);
            --border: #2d3748;
            --chat-msg-other-bg: #2d3748;
        }

        /* Dark mode chat widget styles */
        [data-theme="dark"] #chatBox {
            background: var(--bg-primary) !important;
        }
        [data-theme="dark"] #chatMessages,
        [data-theme="dark"] #dmMessages,
        [data-theme="dark"] #dmConversationList {
            background: var(--bg-secondary) !important;
        }
        [data-theme="dark"] #chatInput,
        [data-theme="dark"] #dmInput {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #mentionDropdown {
            background: var(--bg-primary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #dmHeader,
        [data-theme="dark"] #newDMSelector > div:first-child {
            background: var(--bg-tertiary) !important;
            border-color: var(--border) !important;
        }
        [data-theme="dark"] #dmHeader span,
        [data-theme="dark"] #newDMSelector span {
            color: var(--text-primary) !important;
        }
        [data-theme="dark"] #dmPartnerStatus {
            background: var(--bg-secondary) !important;
            color: var(--text-secondary) !important;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-page);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }

        .header h1 { font-size: 26px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 13px; }

        .back-btn {
            display: inline-block;
            margin-top: 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        .content {
            background: var(--bg-primary);
            padding: 25px;
            border-radius: 0 0 16px 16px;
        }

        /* Category Tabs */
        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 10px 20px;
            border: 2px solid var(--border);
            background: var(--bg-secondary);
            border-radius: 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .category-tab:hover { border-color: var(--accent); }
        .category-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Post Card */
        .post-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.2s;
        }

        .post-card:hover { box-shadow: 0 4px 15px var(--shadow); }

        .post-card.pinned {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1) 0%, var(--bg-secondary) 100%);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .post-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .post-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .post-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-announcement { background: #fef3c7; color: #92400e; }
        .badge-blog { background: #dbeafe; color: #1e40af; }
        .badge-career { background: #d1fae5; color: #065f46; }
        .badge-nclex { background: #fce7f3; color: #9d174d; }

        .post-content {
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .post-actions {
            display: flex;
            gap: 15px;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
            transition: color 0.2s;
        }

        .post-action:hover { color: var(--accent); }

        /* Create Post Button */
        .create-post-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .create-post-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
        }

        .section-header h2 {
            font-size: 18px;
            color: var(--accent);
        }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 10px;
            transition: color 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .toolbar-item:hover { color: var(--accent); }
        .toolbar-item.active { color: var(--accent); }
        .toolbar-item .icon { font-size: 24px; margin-bottom: 2px; }
        .toolbar-item .label { font-weight: 600; }

        /* More Menu */
        .more-menu {
            position: fixed;
            bottom: 70px;
            right: 10px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 8px 0;
            display: none;
            z-index: 1001;
            min-width: 160px;
            border: 1px solid var(--border);
        }

        .more-menu.show { display: block; }

        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
        }

        .more-menu-item:hover { background: var(--bg-secondary); }
        .more-menu-item .menu-icon { font-size: 18px; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.hidden { display: none; }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            color: var(--text-primary);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .modal-content textarea { min-height: 150px; resize: vertical; }

        /* Lock screen */
        #lockScreenOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 99999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon { font-size: 48px; margin-bottom: 15px; }
        .empty-state h3 { color: var(--text-primary); margin-bottom: 10px; }

        /* Comments */
        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .comment {
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .comment-author {
            font-weight: 600;
            font-size: 12px;
            color: var(--accent);
        }

        .comment-text {
            font-size: 13px;
            color: var(--text-primary);
            margin-top: 4px;
        }

        .comment-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        @media (max-width: 600px) {
            .category-tabs { gap: 6px; }
            .category-tab { padding: 8px 14px; font-size: 12px; }
            .post-title { font-size: 16px; }
        }

        /* Focus visible styles for keyboard navigation */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        button:focus-visible, a:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* ========== MOBILE RESPONSIVE STYLES ========== */

        /* Smooth scrolling and touch-friendly */
        html { scroll-behavior: smooth; }
        #chatMessages, #dmMessages, #aiMessages, .posts-container {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* Minimum touch target size */
        @media (pointer: coarse) {
            button, .btn, .toolbar-item, .more-menu-item, .category-tab {
                min-height: 44px;
            }
        }

        /* Mobile Chat/AI Widget - Full Screen Overlay */
        @media (max-width: 768px) {
            body {
                padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
            }

            #chatBox, #aiBox {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                border-radius: 0 !important;
                z-index: 10000 !important;
                padding-top: env(safe-area-inset-top, 0px);
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            #chatWidget, #aiWidget {
                bottom: 70px !important;
            }

            #chatToggle, #aiToggle {
                width: 54px !important;
                height: 54px !important;
            }

            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }
        }

        /* Small phones */
        @media (max-width: 480px) {
            input, select, textarea {
                font-size: 16px !important;
            }

            .post-card { padding: 15px; }
            .category-tabs { flex-wrap: wrap; gap: 8px; }
        }

        /* Landscape orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .bottom-toolbar { height: 50px; }
            .toolbar-item .label { display: none; }
        }

        /* Safe area insets for bottom toolbar */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(60px + env(safe-area-inset-bottom));
            }
        }

        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; max-width: 380px; }
        .toast { padding: 14px 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); display: flex; align-items: flex-start; gap: 12px; animation: toastSlideIn 0.3s ease; color: white; font-size: 14px; line-height: 1.4; }
        .toast.hiding { animation: toastSlideOut 0.3s ease forwards; }
        .toast-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .toast-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .toast-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .toast-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .toast-icon { font-size: 18px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-message { opacity: 0.95; }
        .toast-close { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; font-size: 18px; padding: 0; line-height: 1; }
        .toast-close:hover { opacity: 1; }
        @keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @media (max-width: 480px) { .toast-container { left: 10px; right: 10px; max-width: none; } }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Alert/FYI Banners - Fixed at top -->
    <div id="alertBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 10000; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5); animation: softFlashAlert 2s ease-in-out infinite;">
        <span id="alertText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.8;">‚ö†Ô∏è ALERT</span>
    </div>
    <div id="fyiBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a1a2e; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 9999; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); animation: softFlashFyi 2s ease-in-out infinite;">
        <span id="fyiText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.7;">‚ÑπÔ∏è FYI</span>
    </div>
    <style>
        @keyframes softFlashAlert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        @keyframes softFlashFyi {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        body.has-alert { padding-top: 50px; }
        body.has-fyi { padding-top: 50px; }
        body.has-alert.has-fyi { padding-top: 100px; }
    </style>

    <!-- Lock Screen Overlay -->
    <div id="lockScreenOverlay">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px;">&#128274;</div>
            <h1 style="font-size: 42px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">BSN9B</h1>
            <p style="font-size: 18px; opacity: 0.8; margin-bottom: 40px;">Portal Locked</p>
            <button onclick="unlockScreen()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 18px 50px; border-radius: 30px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);">&#128275; Unlock Portal</button>
            <p style="margin-top: 30px; font-size: 12px; opacity: 0.5;">Click unlock to return to your session</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Community Hub</h1>
            <p>Announcements | Study Tips | Career Resources | NCLEX Prep</p>
            <a href="/home/" class="back-btn">Back to Home</a>
        </div>

        <div class="content">
            <!-- Category Tabs -->
            <div class="category-tabs">
                <button class="category-tab active" onclick="filterCategory('all')">All</button>
                <button class="category-tab" onclick="filterCategory('announcement')">Announcements</button>
                <button class="category-tab" onclick="filterCategory('blog')">Study Tips</button>
                <button class="category-tab" onclick="filterCategory('career')">Career</button>
                <button class="category-tab" onclick="filterCategory('nclex')">NCLEX</button>
            </div>

            <!-- Create Post Button -->
            <button class="create-post-btn" onclick="showCreatePostModal()">
                <span>+</span> Create Post
            </button>

            <!-- Pinned Section -->
            <div id="pinnedSection" style="display: none;">
                <div class="section-header">
                    <span>&#128204;</span>
                    <h2>Pinned</h2>
                </div>
                <div id="pinnedPosts"></div>
            </div>

            <!-- Posts Feed -->
            <div class="section-header">
                <span>&#128240;</span>
                <h2>Latest Posts</h2>
            </div>
            <div id="postsFeed">
                <div class="empty-state">
                    <div class="icon">&#128221;</div>
                    <h3>No posts yet</h3>
                    <p>Be the first to share something with the community!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 20px;">Create Post</h2>
                <button onclick="hideCreatePostModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
            </div>
            <form onsubmit="createPost(event)">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Title</label>
                <input type="text" id="postTitle" required placeholder="Enter post title">

                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Category</label>
                <select id="postCategory" required>
                    <option value="blog">Study Tips</option>
                    <option value="career">Career</option>
                    <option value="nclex">NCLEX</option>
                </select>

                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Content</label>
                <textarea id="postContent" required placeholder="Share your thoughts, tips, or questions..."></textarea>

                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Publish Post</button>
            </form>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 20px;">Send Feedback</h2>
                <button onclick="document.getElementById('feedbackModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
            </div>
            <form action="https://formsubmit.co/christiankholden@gmail.com" method="POST">
                <input type="hidden" name="_subject" value="BSN9B Feedback">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_template" value="table">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Type</label>
                <select name="type" required>
                    <option value="bug">Bug Report</option>
                    <option value="feature">Feature Request</option>
                    <option value="feedback" selected>General Feedback</option>
                </select>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Your Name</label>
                <input type="text" name="name" required placeholder="Enter your name">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Message</label>
                <textarea name="message" required placeholder="Describe your feedback..."></textarea>
                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Send Feedback</button>
            </form>
        </div>
    </div>

    <!-- Bottom Toolbar -->
    <nav class="bottom-toolbar" role="navigation" aria-label="Main navigation">
        <a href="/home/" class="toolbar-item" aria-label="Home">
            <span class="icon" aria-hidden="true">&#127968;</span>
            <span class="label">Home</span>
        </a>
        <a href="/app/" class="toolbar-item" aria-label="RN Notes">
            <span class="icon" aria-hidden="true">&#128221;</span>
            <span class="label">RN Notes</span>
        </a>
        <a href="/community/" class="toolbar-item active" aria-label="Community" aria-current="page">
            <span class="icon" aria-hidden="true">&#128101;</span>
            <span class="label">Community</span>
        </a>
        <a href="/resources/" class="toolbar-item" aria-label="Resources">
            <span class="icon" aria-hidden="true">&#128218;</span>
            <span class="label">Resources</span>
        </a>
        <button class="toolbar-item" onclick="toggleMoreMenu()" aria-label="More options" aria-expanded="false" aria-controls="moreMenu">
            <span class="icon" aria-hidden="true">&#8943;</span>
            <span class="label">More</span>
        </button>
    </nav>

    <!-- More Menu -->
    <div id="moreMenu" class="more-menu" role="menu" aria-label="Additional options">
        <button class="more-menu-item" role="menuitem" onclick="toggleDarkMode(); toggleMoreMenu();">
            <span class="menu-icon" id="themeMenuIcon" aria-hidden="true">&#127769;</span>
            <span id="themeMenuText">Dark Mode</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="lockScreen(); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">&#128274;</span>
            <span>Lock Screen</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="document.getElementById('feedbackModal').classList.remove('hidden'); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">&#128161;</span>
            <span>Feedback</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="logout();">
            <span class="menu-icon" aria-hidden="true">&#128682;</span>
            <span>Logout</span>
        </button>
    </div>

    <!-- AI Widget -->
    <div id="aiWidget" style="position: fixed; bottom: 80px; left: 20px; z-index: 999;">
        <button id="aiToggle" onclick="toggleAI()" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); border: none; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 24px; display: flex; align-items: center; justify-content: center; position: relative;">
            &#129658;
            <span style="position: absolute; top: -2px; left: -2px; background: #8b5cf6; color: white; border-radius: 4px; padding: 2px 5px; font-size: 9px; font-weight: bold;">AI</span>
        </button>
        <div id="aiBox" style="display: none; flex-direction: column; position: absolute; bottom: 70px; left: 0; width: 380px; height: 500px; background: var(--bg-primary); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden;">
            <div style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 700;">&#129658; AI Nursing Assistant</span>
                <button onclick="toggleAI()" style="background: none; border: none; color: white; cursor: pointer; font-size: 18px;">&times;</button>
            </div>
            <div style="background: #fef3c7; padding: 8px 12px; font-size: 11px; color: #92400e;">&#9888;&#65039; <strong>Educational Only:</strong> Not medical advice. Always verify with clinical resources.</div>
            <div style="padding: 10px; display: flex; gap: 6px; flex-wrap: wrap; border-bottom: 1px solid var(--border);">
                <button onclick="aiQuickAction('drug')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">&#128138; Drug Info</button>
                <button onclick="aiQuickAction('careplan')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">&#128203; Care Plan</button>
                <button onclick="aiQuickAction('nclex')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">&#128221; NCLEX Q</button>
                <button onclick="aiQuickAction('labs')" style="padding: 5px 10px; border-radius: 12px; border: none; background: #0d9488; color: white; cursor: pointer; font-size: 11px;">&#128300; Labs</button>
            </div>
            <div id="aiMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: var(--bg-secondary);">
                <div style="background: var(--chat-msg-other-bg); padding: 10px 14px; border-radius: 16px; margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">Hi! I'm your AI nursing assistant. Ask me about medications, care plans, NCLEX questions, or lab values. How can I help you today?</div>
            </div>
            <form onsubmit="sendAIMessage(event)" style="padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; background: var(--bg-primary);">
                <input type="text" id="aiInput" placeholder="Ask a nursing question..." style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 20px; font-size: 14px; background: var(--bg-input); color: var(--text-primary);">
                <button type="submit" style="background: linear-gradient(135deg, #0d9488, #14b8a6); color: white; border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer;">Ask</button>
            </form>
        </div>
    </div>

    <!-- Chat Widget with DM Support -->
    <div id="chatWidget" style="position: fixed; bottom: 80px; right: 20px; z-index: 999; font-family: 'Segoe UI', sans-serif;">
        <!-- Chat Toggle Button -->
        <button id="chatToggle" onclick="toggleChat()" aria-label="Open chat" aria-expanded="false" aria-controls="chatBox" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 24px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;">
            <span aria-hidden="true">üí¨</span>
        </button>
        <span id="chatBadge" aria-live="polite" style="display: none; position: absolute; top: -5px; right: -5px; background: #e94560; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center;">0</span>
        <!-- DM Badge (separate from group chat) -->
        <span id="dmBadge" aria-live="polite" style="display: none; position: absolute; top: -5px; left: -5px; background: #8b5cf6; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center;">0</span>

        <!-- Chat Box -->
        <div id="chatBox" role="dialog" aria-label="Chat window" aria-modal="false" style="display: none; flex-direction: column; position: absolute; bottom: 70px; right: 0; width: 350px; height: 500px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden;">
            <!-- Chat Header -->
            <div style="background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; padding: 12px 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong id="chatTitle" style="font-size: 16px;">BSN9B Chat</strong>
                        <div id="onlineCount" onclick="toggleUserList()" style="font-size: 11px; opacity: 0.8; cursor: pointer;">Connecting...</div>
                    </div>
                    <div style="display: flex; gap: 6px; align-items: center;">
                        <button id="soundToggleBtn" onclick="toggleChatSound()" aria-label="Toggle sound notifications" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 14px;"><span aria-hidden="true">üîî</span></button>
                        <button id="notificationToggleBtn" onclick="toggleBrowserNotifications()" aria-label="Toggle browser notifications" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 14px;"><span aria-hidden="true">üìµ</span></button>
                        <button onclick="toggleChat()" aria-label="Close chat" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 16px;"><span aria-hidden="true">√ó</span></button>
                    </div>
                </div>
                <!-- Chat Mode Tabs -->
                <div role="tablist" aria-label="Chat mode" style="display: flex; gap: 8px; margin-top: 10px;">
                    <button id="tabGroupChat" role="tab" aria-selected="true" aria-controls="groupChatView" onclick="switchChatMode('group')" style="flex: 1; padding: 8px; border: none; border-radius: 8px; background: rgba(255,255,255,0.3); color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <span aria-hidden="true">üë•</span> Group
                    </button>
                    <button id="tabDM" role="tab" aria-selected="false" aria-controls="dmView" onclick="switchChatMode('dm')" style="flex: 1; padding: 8px; border: none; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <span aria-hidden="true">‚úâÔ∏è</span> Direct <span id="dmTabBadge" style="display: none; background: #8b5cf6; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 4px;">0</span>
                    </button>
                </div>
            </div>

            <!-- Online Users List (toggleable) -->
            <div id="userList" style="display: none; background: #1a3d5c; color: white; padding: 10px 15px; font-size: 12px; max-height: 100px; overflow-y: auto;">
                <div style="opacity: 0.7; margin-bottom: 5px;">Online now:</div>
                <div id="userListNames"></div>
            </div>

            <!-- GROUP CHAT VIEW -->
            <div id="groupChatView" role="tabpanel" aria-labelledby="tabGroupChat" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <!-- Chat Messages -->
                <div id="chatMessages" role="log" aria-live="polite" aria-label="Chat messages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
                    <p style="text-align: center; color: #888; font-size: 12px;">Loading messages...</p>
                </div>

                <!-- Chat Input -->
                <div style="padding: 12px; border-top: 1px solid #e2e8f0; background: white; position: relative;">
                    <!-- @Mention Autocomplete Dropdown -->
                    <div id="mentionDropdown" role="listbox" aria-label="Mention suggestions" style="display: none; position: absolute; bottom: 100%; left: 12px; right: 60px; background: white; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 -4px 15px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; z-index: 100;"></div>
                    <form onsubmit="sendMessage(event)" style="display: flex; gap: 8px;">
                        <input type="text" id="chatInput" aria-label="Chat message input" placeholder="Type @ to mention someone..." style="flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none;" maxlength="500" autocomplete="off">
                        <button type="submit" aria-label="Send message" style="background: linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 16px;"><span aria-hidden="true">‚û§</span></button>
                    </form>
                </div>
            </div>

            <!-- DM VIEW -->
            <div id="dmView" role="tabpanel" aria-labelledby="tabDM" style="flex: 1; display: none; flex-direction: column; overflow: hidden;">
                <!-- DM Conversation List (shows when no conversation selected) -->
                <div id="dmConversationList" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
                    <div style="margin-bottom: 15px;">
                        <button onclick="showNewDMSelector()" aria-label="Start new direct message" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            <span aria-hidden="true">‚úèÔ∏è</span> New Message
                        </button>
                    </div>
                    <div id="dmConversations" style="color: #888; font-size: 12px; text-align: center;">
                        Loading conversations...
                    </div>
                </div>

                <!-- DM Messages View (shows when conversation selected) -->
                <div id="dmMessageView" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                    <!-- DM Header with back button -->
                    <div id="dmHeader" style="padding: 10px 15px; background: #f0f7ff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px;">
                        <button onclick="closeDMConversation()" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px;">‚Üê</button>
                        <span id="dmPartnerName" style="font-weight: 600; color: #1f4e79;">Partner Name</span>
                        <span id="dmPartnerStatus" style="font-size: 10px; padding: 2px 8px; border-radius: 10px; background: #e2e8f0; color: #666;">offline</span>
                    </div>
                    <!-- DM Messages -->
                    <div id="dmMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc;">
                    </div>
                    <!-- DM Input -->
                    <div style="padding: 12px; border-top: 1px solid #e2e8f0; background: white;">
                        <form onsubmit="sendDM(event)" style="display: flex; gap: 8px;">
                            <input type="text" id="dmInput" placeholder="Type a message..." style="flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none;" maxlength="500" autocomplete="off">
                            <button type="submit" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 16px;">‚û§</button>
                        </form>
                    </div>
                </div>

                <!-- New DM User Selector -->
                <div id="newDMSelector" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                    <div style="padding: 10px 15px; background: #f0f7ff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px;">
                        <button onclick="hideNewDMSelector()" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px;">‚Üê</button>
                        <span style="font-weight: 600; color: #1f4e79;">New Message</span>
                    </div>
                    <div style="padding: 15px;">
                        <input type="text" id="dmUserSearch" placeholder="Search users..." oninput="filterDMUsers()" style="width: 100%; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none; margin-bottom: 15px;">
                    </div>
                    <div id="dmUserList" style="flex: 1; overflow-y: auto; padding: 0 15px 15px 15px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== TOAST NOTIFICATION SYSTEM ==========
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content"><div class="toast-message">${message.replace(/\n/g, '<br>')}</div></div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, duration);
        }

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAmr2W8mekSPJ2pXM3gz1FvarfSBddpfLM",
            authDomain: "bendbsn-17377.firebaseapp.com",
            databaseURL: "https://bendbsn-17377-default-rtdb.firebaseio.com",
            projectId: "bendbsn-17377",
            storageBucket: "bendbsn-17377.firebasestorage.app",
            messagingSenderId: "762882187702",
            appId: "1:762882187702:web:81c97c9eae005666796117"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const postsRef = database.ref('community/posts');

        // ========== CHAT SYSTEM (INLINE FROM /app/) ==========
        const chatRef = database.ref('chat/messages');
        const presenceRef = database.ref('chat/presence');
        const bannedRef = database.ref('banned');
        const announcementsRef = database.ref('announcements');

        // Listen for announcements (alert/fyi banners - inside header)
        function setupAnnouncementListener() {
            announcementsRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                const alertBanner = document.getElementById('alertBanner');
                const fyiBanner = document.getElementById('fyiBanner');
                const alertText = document.getElementById('alertText');
                const fyiText = document.getElementById('fyiText');

                // Handle alert banner
                if (data.alert && data.alert.message) {
                    alertText.textContent = data.alert.message;
                    alertBanner.style.display = 'block';
                    document.body.classList.add('has-alert');
                } else {
                    alertBanner.style.display = 'none';
                    document.body.classList.remove('has-alert');
                }

                // Handle FYI banner (offset if alert is showing)
                if (data.fyi && data.fyi.message) {
                    fyiText.textContent = data.fyi.message;
                    fyiBanner.style.display = 'block';
                    fyiBanner.style.top = (data.alert && data.alert.message) ? '50px' : '0';
                    document.body.classList.add('has-fyi');
                } else {
                    fyiBanner.style.display = 'none';
                    document.body.classList.remove('has-fyi');
                }
            });
        }
        setupAnnouncementListener();
        console.log('Firebase initialized, chatRef path:', chatRef.toString());

        // Get display name (first name) - stored when user logs in
        const currentUsername = localStorage.getItem('bsn9b_user') || 'Anonymous';
        const displayName = localStorage.getItem('bsn9b_displayName') || currentUsername;

        // Verify Firebase Auth state and re-authenticate if needed
        let firebaseAuthReady = false;
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Firebase Auth: Logged in as', user.email);
                firebaseAuthReady = true;
            } else {
                console.log('Firebase Auth: Not logged in, attempting silent re-auth...');
                if (localStorage.getItem('bsn9b_auth') === 'true') {
                    console.warn('Session exists but Firebase auth lost - may need to re-login');
                }
            }
        });

        // Check if current user is banned
        function checkIfBanned() {
            bannedRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const banned = child.val();
                    if (banned.username === currentUsername || banned.username === displayName) {
                        showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                        localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                        setTimeout(() => { window.location.href = '/'; }, 2000);
                    }
                });
            });
        }
        checkIfBanned();

        // Listen for bans in real-time
        bannedRef.on('child_added', (snapshot) => {
            const banned = snapshot.val();
            if (banned.username === currentUsername || banned.username === displayName) {
                showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                setTimeout(() => { window.location.href = '/'; }, 2000);
            }
        });

        // Chat state
        let chatOpen = false;
        let unreadCount = 0;
        let lastReadTimestamp = parseInt(localStorage.getItem('chatLastRead') || '0');

        // Notification preferences (sound ON by default, browser notifications OFF by default)
        let soundEnabled = localStorage.getItem('chatSoundEnabled') !== 'false';
        let notificationsEnabled = localStorage.getItem('chatNotificationsEnabled') === 'true';

        // Audio notification using Web Audio API
        function playNotificationSound() {
            if (!soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio notification not available:', e);
            }
        }

        // Toggle sound notifications
        function toggleChatSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('chatSoundEnabled', soundEnabled.toString());
            updateSoundToggleUI();
        }

        function updateSoundToggleUI() {
            const btn = document.getElementById('soundToggleBtn');
            if (btn) {
                btn.innerHTML = soundEnabled ? 'üîî' : 'üîï';
                btn.title = soundEnabled ? 'Sound ON (click to mute)' : 'Sound OFF (click to unmute)';
            }
        }

        // Browser Notifications
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Browser does not support notifications');
                return false;
            }

            if (Notification.permission === 'granted') {
                notificationsEnabled = true;
                localStorage.setItem('chatNotificationsEnabled', 'true');
                updateNotificationToggleUI();
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationsEnabled = true;
                    localStorage.setItem('chatNotificationsEnabled', 'true');
                    updateNotificationToggleUI();
                    return true;
                }
            }

            notificationsEnabled = false;
            localStorage.setItem('chatNotificationsEnabled', 'false');
            updateNotificationToggleUI();
            return false;
        }

        function sendBrowserNotification(message) {
            if (!notificationsEnabled || Notification.permission !== 'granted') return;
            if (document.hasFocus() && chatOpen) return;

            try {
                const notification = new Notification('BSN9B Chat', {
                    body: `${message.user}: ${message.text.substring(0, 100)}${message.text.length > 100 ? '...' : ''}`,
                    tag: 'bsn9b-chat',
                    requireInteraction: false
                });

                notification.onclick = function() {
                    window.focus();
                    if (!chatOpen) toggleChat();
                    notification.close();
                };

                setTimeout(() => notification.close(), 5000);
            } catch (e) {
                console.log('Notification error:', e);
            }
        }

        function toggleBrowserNotifications() {
            if (notificationsEnabled) {
                notificationsEnabled = false;
                localStorage.setItem('chatNotificationsEnabled', 'false');
                updateNotificationToggleUI();
            } else {
                requestNotificationPermission();
            }
        }

        function updateNotificationToggleUI() {
            const btn = document.getElementById('notificationToggleBtn');
            if (btn) {
                btn.innerHTML = notificationsEnabled ? 'üì≤' : 'üìµ';
                btn.title = notificationsEnabled ? 'Browser notifications ON' : 'Browser notifications OFF (click to enable)';
            }
        }

        // Initialize notification UI on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSoundToggleUI();
            updateNotificationToggleUI();
        });

        // Toggle chat
        function toggleChat() {
            chatOpen = !chatOpen;
            const chatBox = document.getElementById('chatBox');
            const chatToggle = document.getElementById('chatToggle');
            if (chatOpen) {
                chatBox.style.display = 'flex';
                chatBox.style.flexDirection = 'column';
                unreadCount = 0;
                document.getElementById('chatBadge').style.display = 'none';
                lastReadTimestamp = Date.now();
                localStorage.setItem('chatLastRead', lastReadTimestamp.toString());
                document.getElementById('chatInput').focus();
                scrollToBottom();
            } else {
                chatBox.style.display = 'none';
            }
            chatToggle.style.transform = chatOpen ? 'scale(0.9)' : 'scale(1)';
            chatToggle.setAttribute('aria-expanded', chatOpen);
            chatToggle.setAttribute('aria-label', chatOpen ? 'Close chat' : 'Open chat');
        }

        // Send message
        function sendMessage(event) {
            event.preventDefault();
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Admin commands (admin emails only)
            const adminEmails = ['christiankholden@gmail.com', 'holdenc'];
            if (adminEmails.includes(currentUsername.toLowerCase())) {
                // Alert command: alert/message or alert/clear
                if (message.toLowerCase().startsWith('alert/')) {
                    const alertMsg = message.substring(6).trim();
                    if (alertMsg.toLowerCase() === 'clear') {
                        announcementsRef.child('alert').remove();
                    } else if (alertMsg) {
                        announcementsRef.child('alert').set({ message: alertMsg, timestamp: Date.now() });
                    }
                    input.value = '';
                    return;
                }
                // FYI command: fyi/message or fyi/clear
                if (message.toLowerCase().startsWith('fyi/')) {
                    const fyiMsg = message.substring(4).trim();
                    if (fyiMsg.toLowerCase() === 'clear') {
                        announcementsRef.child('fyi').remove();
                    } else if (fyiMsg) {
                        announcementsRef.child('fyi').set({ message: fyiMsg, timestamp: Date.now() });
                    }
                    input.value = '';
                    return;
                }
                // Chat clear command: chat/clear
                if (message.toLowerCase() === 'chat/clear') {
                    chatRef.remove();
                    input.value = '';
                    return;
                }
            }

            // Check Firebase Auth status
            const currentUser = auth.currentUser;
            console.log('Sending message, Firebase auth user:', currentUser ? currentUser.email : 'NOT AUTHENTICATED');

            if (!currentUser) {
                showToast('Chat requires authentication. Please refresh the page or log in again.', 'error');
                return;
            }

            chatRef.push({
                user: displayName,
                username: currentUsername,
                text: message,
                timestamp: Date.now()
            }).then(() => {
                console.log('Message sent successfully');
            }).catch((error) => {
                console.error('Failed to send message:', error);
                showToast('Failed to send message: ' + error.message + '. You may need to log in again.', 'error');
            });

            input.value = '';
            hideMentionDropdown();
        }

        // Format timestamp (with safety checks)
        function formatTime(timestamp) {
            try {
                if (!timestamp || typeof timestamp !== 'number') {
                    return 'Unknown time';
                }
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    return 'Invalid time';
                }
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();

                if (isToday) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            } catch (e) {
                console.error('formatTime error:', e);
                return 'Time error';
            }
        }

        // Format message text with @mention highlighting (with safety checks)
        function formatMessageWithMentions(text, isMe) {
            try {
                if (!text || typeof text !== 'string') {
                    return '';
                }
                // Escape HTML first
                let formatted = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                // Highlight @mentions with a styled span
                formatted = formatted.replace(/@(\w+)/g, function(match, name) {
                    const bgColor = isMe ? 'rgba(255,255,255,0.3)' : 'rgba(139, 92, 246, 0.2)';
                    const textColor = isMe ? '#fff' : '#7c3aed';
                    return `<span style="background: ${bgColor}; color: ${textColor}; padding: 1px 6px; border-radius: 10px; font-weight: 600;">@${name}</span>`;
                });

                return formatted;
            } catch (e) {
                console.error('formatMessageWithMentions error:', e);
                return text || '';
            }
        }

        // Scroll to bottom
        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        // 7-day threshold in milliseconds
        const MESSAGE_RETENTION_MS = 7 * 24 * 60 * 60 * 1000;

        // Clean up old messages (older than 7 days)
        function cleanupOldMessages() {
            const cutoff = Date.now() - MESSAGE_RETENTION_MS;
            chatRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const msg = child.val();
                    if (msg.timestamp && msg.timestamp < cutoff) {
                        child.ref.remove();
                    }
                });
            });
        }

        // Run cleanup on load and every hour
        cleanupOldMessages();
        setInterval(cleanupOldMessages, 60 * 60 * 1000);

        // Listen for messages
        function setupChatListener() {
            console.log('Setting up chat listener...');
            chatRef.on('value', (snapshot) => {
                console.log('=== CHAT LISTENER FIRED ===');
                console.log('Snapshot exists:', snapshot.exists());
                console.log('Snapshot numChildren:', snapshot.numChildren());

                const container = document.getElementById('chatMessages');
                if (!container) {
                    console.error('chatMessages container not found!');
                    return;
                }

                if (!snapshot.exists() || snapshot.numChildren() === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; margin-top: 20px;">No messages yet. Start the conversation!</p>';
                    return;
                }

                // Get ALL messages first, then filter
                const allMessages = [];
                snapshot.forEach((child) => {
                    const msg = child.val();
                    allMessages.push(msg);
                });

                // Filter by 7 days
                const cutoff = Date.now() - MESSAGE_RETENTION_MS;
                let messages = allMessages.filter(msg => msg.timestamp && msg.timestamp >= cutoff);

                // Sort by timestamp
                messages.sort((a, b) => a.timestamp - b.timestamp);

                // Limit to last 50 messages for performance
                const MAX_DISPLAY_MESSAGES = 50;
                const hasOlderMessages = messages.length > MAX_DISPLAY_MESSAGES;
                if (hasOlderMessages) {
                    messages = messages.slice(-MAX_DISPLAY_MESSAGES);
                }

                if (messages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; margin-top: 20px;">No messages yet. Start the conversation!</p>';
                    return;
                }

                let html = '';
                // Show indicator if older messages are hidden
                if (hasOlderMessages) {
                    html += '<p style="text-align: center; color: #888; font-size: 11px; padding: 8px; background: #f0f0f0; border-radius: 8px; margin-bottom: 10px;">Showing last 50 messages</p>';
                }
                let newMessages = 0;

                messages.forEach((msg) => {
                    const isMe = msg.user === displayName || msg.username === currentUsername;
                    const isNew = msg.timestamp > lastReadTimestamp;

                    if (isNew && !chatOpen) newMessages++;

                    // Format text with @mention highlighting
                    const formattedText = formatMessageWithMentions(msg.text, isMe);
                    // Check if this message mentions the current user
                    const mentionsMe = msg.text.toLowerCase().includes('@' + displayName.toLowerCase());

                    html += `
                        <div style="margin-bottom: 12px; display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'};">
                            <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${isMe ? 'You' : msg.user}</div>
                            <div style="background: ${mentionsMe && !isMe ? 'linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%)' : (isMe ? 'linear-gradient(135deg, #1f4e79 0%, #2d5a87 100%)' : '#e2e8f0')}; color: ${mentionsMe || isMe ? 'white' : '#333'}; padding: 10px 14px; border-radius: ${isMe ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 80%; word-wrap: break-word; font-size: 14px; ${mentionsMe && !isMe ? 'box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);' : ''}">
                                ${formattedText}
                            </div>
                            <div style="font-size: 9px; color: #aaa; margin-top: 3px;">
                                ${formatTime(msg.timestamp)}${isMe ? ' <span style="color: #4ade80;" title="Delivered">‚úì</span>' : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                scrollToBottom();

                // Update unread badge and send notifications
                if (newMessages > 0 && !chatOpen) {
                    const shouldNotify = unreadCount < newMessages;

                    unreadCount = newMessages;
                    const badge = document.getElementById('chatBadge');
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    badge.style.display = 'flex';

                    if (shouldNotify && messages.length > 0) {
                        const latestMessage = messages[messages.length - 1];
                        if (latestMessage.username !== currentUsername) {
                            playNotificationSound();
                            sendBrowserNotification(latestMessage);
                        }
                    }
                }
            }, (error) => {
                console.error('Chat listener error:', error);
                document.getElementById('chatMessages').innerHTML = '<p style="color: red; padding: 20px;">Chat error: ' + error.message + '</p>';
            });
        }

        // Initialize chat listener
        setupChatListener();

        // Monitor Firebase connection state
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            const connected = snap.val() === true;
            const onlineCountEl = document.getElementById('onlineCount');
            if (connected) {
                console.log('Firebase: Connected');
                if (onlineCountEl && onlineCountEl.textContent.includes('Disconnected')) {
                    onlineCountEl.textContent = 'Reconnected! Refreshing...';
                    setTimeout(() => setupChatListener(), 500);
                }
            } else {
                console.log('Firebase: Disconnected');
                if (onlineCountEl) {
                    onlineCountEl.innerHTML = '<span style="color: #fca5a5;">Disconnected - reconnecting...</span>';
                }
            }
        });

        // ========== DIRECT MESSAGES ==========
        let chatMode = 'group';
        let currentDMConversation = null;
        let dmConversations = [];
        let dmUnreadCount = 0;
        let dmLastReadTimestamps = JSON.parse(localStorage.getItem('dmLastRead') || '{}');
        const directMessagesRef = database.ref('directMessages');

        function getConversationId(email1, email2) {
            return [email1, email2].sort().join('_').replace(/[.@]/g, '_');
        }

        function switchChatMode(mode) {
            try {
                chatMode = mode;
                const groupView = document.getElementById('groupChatView');
                const dmView = document.getElementById('dmView');
                const tabGroup = document.getElementById('tabGroupChat');
                const tabDM = document.getElementById('tabDM');
                const chatTitle = document.getElementById('chatTitle');
                const onlineCount = document.getElementById('onlineCount');

                if (!groupView || !dmView) {
                    console.error('Chat views not found');
                    return;
                }

                if (mode === 'group') {
                    groupView.style.display = 'flex';
                    dmView.style.display = 'none';
                    tabGroup.style.background = 'rgba(255,255,255,0.3)';
                    tabDM.style.background = 'rgba(255,255,255,0.1)';
                    tabGroup.setAttribute('aria-selected', 'true');
                    tabDM.setAttribute('aria-selected', 'false');
                    chatTitle.textContent = 'BSN9B Chat';
                    onlineCount.style.display = 'block';

                    unreadCount = 0;
                    document.getElementById('chatBadge').style.display = 'none';
                    lastReadTimestamp = Date.now();
                    localStorage.setItem('chatLastRead', lastReadTimestamp.toString());
                } else {
                    groupView.style.display = 'none';
                    dmView.style.display = 'flex';
                    tabGroup.style.background = 'rgba(255,255,255,0.1)';
                    tabDM.style.background = 'rgba(255,255,255,0.3)';
                    tabGroup.setAttribute('aria-selected', 'false');
                    tabDM.setAttribute('aria-selected', 'true');
                    chatTitle.textContent = 'Direct Messages';
                    onlineCount.style.display = 'none';

                    showDMConversationList();
                    loadDMConversations();
                }
            } catch (e) {
                console.error('Error switching chat mode:', e);
            }
        }

        function showDMConversationList() {
            document.getElementById('dmConversationList').style.display = 'block';
            document.getElementById('dmMessageView').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'none';
            currentDMConversation = null;
        }

        function showNewDMSelector() {
            document.getElementById('dmConversationList').style.display = 'none';
            document.getElementById('dmMessageView').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'flex';
            document.getElementById('dmUserSearch').value = '';
            loadDMUserList();
        }

        function hideNewDMSelector() {
            showDMConversationList();
        }

        function loadDMUserList() {
            const container = document.getElementById('dmUserList');
            const onlineSet = new Set(onlineUsers.map(u => u.toLowerCase()));
            let users = [];

            onlineUsers.forEach(u => {
                if (u.toLowerCase() !== displayName.toLowerCase()) {
                    users.push({ name: u, online: true });
                }
            });

            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                if (!onlineSet.has(firstName.toLowerCase()) && firstName.toLowerCase() !== displayName.toLowerCase()) {
                    users.push({ name: firstName, fullName: u.name, email: u.email, online: false });
                }
            });

            renderDMUserList(users);
        }

        function filterDMUsers() {
            const search = document.getElementById('dmUserSearch').value.toLowerCase();
            const onlineSet = new Set(onlineUsers.map(u => u.toLowerCase()));
            let users = [];

            onlineUsers.forEach(u => {
                if (u.toLowerCase() !== displayName.toLowerCase() && u.toLowerCase().includes(search)) {
                    users.push({ name: u, online: true });
                }
            });

            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                if (!onlineSet.has(firstName.toLowerCase()) &&
                    firstName.toLowerCase() !== displayName.toLowerCase() &&
                    (firstName.toLowerCase().includes(search) || u.name.toLowerCase().includes(search))) {
                    users.push({ name: firstName, fullName: u.name, email: u.email, online: false });
                }
            });

            renderDMUserList(users);
        }

        function renderDMUserList(users) {
            const container = document.getElementById('dmUserList');

            if (users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px;">No users found</p>';
                return;
            }

            container.innerHTML = users.map(u => `
                <div onclick="startDMConversation('${u.name}')" style="padding: 12px; background: white; border-radius: 10px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div>
                        <div style="font-weight: 600; color: #1a1a2e;">${u.name}${u.fullName && u.fullName !== u.name ? ` <span style="color:#888;font-weight:normal;font-size:12px;">(${u.fullName})</span>` : ''}</div>
                    </div>
                    ${u.online ? '<span style="font-size: 10px; background: #22c55e; color: white; padding: 2px 8px; border-radius: 10px;">online</span>' : '<span style="font-size: 10px; color: #888;">offline</span>'}
                </div>
            `).join('');
        }

        function startDMConversation(partnerName) {
            currentDMConversation = {
                partnerName: partnerName,
                conversationId: getConversationId(displayName, partnerName)
            };

            document.getElementById('dmConversationList').style.display = 'none';
            document.getElementById('newDMSelector').style.display = 'none';
            document.getElementById('dmMessageView').style.display = 'flex';
            document.getElementById('dmPartnerName').textContent = partnerName;

            const isOnline = onlineUsers.some(u => u.toLowerCase() === partnerName.toLowerCase());
            const statusEl = document.getElementById('dmPartnerStatus');
            statusEl.textContent = isOnline ? 'online' : 'offline';
            statusEl.style.background = isOnline ? '#dcfce7' : '#e2e8f0';
            statusEl.style.color = isOnline ? '#16a34a' : '#666';

            loadDMMessages(currentDMConversation.conversationId);
            markDMAsRead(currentDMConversation.conversationId);
        }

        function closeDMConversation() {
            currentDMConversation = null;
            showDMConversationList();
            loadDMConversations();
        }

        function loadDMConversations() {
            const container = document.getElementById('dmConversations');
            if (!container) return;

            container.innerHTML = '<p style="color: #888; font-size: 12px;">Loading...</p>';

            directMessagesRef.once('value', (snapshot) => {
                dmConversations = [];

                snapshot.forEach((child) => {
                    const convId = child.key;
                    const data = child.val();

                    if (!data) return;

                    const participants = data.participants || {};
                    const isParticipant = Object.values(participants).some(p =>
                        p && (p.toLowerCase() === displayName.toLowerCase() ||
                        p.toLowerCase() === currentUsername.toLowerCase())
                    );

                    if (isParticipant && data.lastMessage) {
                        let partnerName = '';
                        Object.values(participants).forEach(p => {
                            if (p && p.toLowerCase() !== displayName.toLowerCase() &&
                                p.toLowerCase() !== currentUsername.toLowerCase()) {
                                partnerName = p;
                            }
                        });

                        dmConversations.push({
                            conversationId: convId,
                            partnerName: partnerName,
                            lastMessage: data.lastMessage,
                            unread: !dmLastReadTimestamps[convId] || data.lastMessage.timestamp > dmLastReadTimestamps[convId]
                        });
                    }
                });

                dmConversations.sort((a, b) => (b.lastMessage?.timestamp || 0) - (a.lastMessage?.timestamp || 0));
                renderDMConversations();
            });
        }

        function renderDMConversations() {
            const container = document.getElementById('dmConversations');

            if (dmConversations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; padding: 20px;">No conversations yet.<br>Start a new message!</p>';
                return;
            }

            let totalUnread = 0;
            container.innerHTML = dmConversations.map(conv => {
                const time = conv.lastMessage ? formatTime(conv.lastMessage.timestamp) : '';
                const preview = conv.lastMessage ? (conv.lastMessage.text || '').substring(0, 40) + (conv.lastMessage.text?.length > 40 ? '...' : '') : '';
                const isUnread = conv.unread && conv.lastMessage?.sender !== displayName;
                if (isUnread) totalUnread++;

                return `
                    <div onclick="startDMConversation('${conv.partnerName}')" style="padding: 12px; background: ${isUnread ? '#f0f7ff' : 'white'}; border-radius: 10px; margin-bottom: 8px; cursor: pointer; border: 1px solid ${isUnread ? '#8b5cf6' : '#e2e8f0'}; transition: all 0.2s;" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='${isUnread ? '#8b5cf6' : '#e2e8f0'}'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: ${isUnread ? '700' : '600'}; color: #1a1a2e; margin-bottom: 4px;">
                                    ${isUnread ? '‚óè ' : ''}${conv.partnerName}
                                </div>
                                <div style="font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${conv.lastMessage?.sender === displayName ? 'You: ' : ''}${preview}
                                </div>
                            </div>
                            <div style="font-size: 10px; color: #888; white-space: nowrap; margin-left: 10px;">
                                ${time}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateDMBadge(totalUnread);
        }

        function updateDMBadge(count) {
            dmUnreadCount = count;
            const badge = document.getElementById('dmBadge');
            const tabBadge = document.getElementById('dmTabBadge');

            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count;
                badge.style.display = 'flex';
                tabBadge.textContent = count;
                tabBadge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
                tabBadge.style.display = 'none';
            }
        }

        function loadDMMessages(conversationId) {
            const container = document.getElementById('dmMessages');
            container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px;">Loading messages...</p>';

            const messagesRef = directMessagesRef.child(conversationId + '/messages');
            messagesRef.orderByChild('timestamp').on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="text-align: center; color: #888; font-size: 12px; padding: 20px;">No messages yet. Say hello!</p>';
                    return;
                }

                const messages = [];
                snapshot.forEach((child) => {
                    messages.push(child.val());
                });

                let html = '';
                messages.forEach(msg => {
                    const isMe = msg.senderName === displayName || msg.sender === currentUsername;

                    html += `
                        <div style="margin-bottom: 12px; display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'};">
                            <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${isMe ? 'You' : msg.senderName}</div>
                            <div style="background: ${isMe ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' : '#e2e8f0'}; color: ${isMe ? 'white' : '#333'}; padding: 10px 14px; border-radius: ${isMe ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 80%; word-wrap: break-word; font-size: 14px;">
                                ${(msg.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            </div>
                            <div style="font-size: 9px; color: #aaa; margin-top: 3px;">
                                ${formatTime(msg.timestamp)}${isMe ? (msg.read ? ' <span style="color: #4ade80;" title="Seen">‚úì‚úì</span>' : ' <span style="color: #888;" title="Delivered">‚úì</span>') : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                container.scrollTop = container.scrollHeight;

                if (currentDMConversation && currentDMConversation.conversationId === conversationId) {
                    markDMAsRead(conversationId, snapshot);
                }
            });
        }

        function sendDM(event) {
            event.preventDefault();

            if (!currentDMConversation) return;

            const input = document.getElementById('dmInput');
            if (!input) return;

            const text = input.value.trim();
            if (!text) return;

            const currentUser = auth.currentUser;
            if (!currentUser) {
                showToast('Please log in to send messages.', 'warning');
                return;
            }

            const conversationId = currentDMConversation.conversationId;
            const partnerName = currentDMConversation.partnerName;

            const messageData = {
                sender: currentUsername,
                senderName: displayName,
                text: text,
                timestamp: Date.now(),
                read: false
            };

            try {
                directMessagesRef.child(conversationId + '/messages').push(messageData)
                    .catch(err => console.error('Error sending DM:', err));

                directMessagesRef.child(conversationId + '/participants').set({
                    user1: displayName,
                    user2: partnerName
                });

                directMessagesRef.child(conversationId + '/lastMessage').set({
                    text: text,
                    timestamp: Date.now(),
                    sender: displayName
                });

                input.value = '';
            } catch (e) {
                console.error('Error sending DM:', e);
                showToast('Failed to send message. Please try again.', 'error');
            }
        }

        function markDMAsRead(conversationId, snapshot) {
            dmLastReadTimestamps[conversationId] = Date.now();
            localStorage.setItem('dmLastRead', JSON.stringify(dmLastReadTimestamps));

            if (snapshot && snapshot.exists()) {
                snapshot.forEach((child) => {
                    const msg = child.val();
                    const msgKey = child.key;
                    if (msg && !msg.read && msg.senderName !== displayName && msg.sender !== currentUsername) {
                        directMessagesRef.child(conversationId + '/messages/' + msgKey + '/read').set(true)
                            .catch(err => console.error('Error marking message as read:', err));
                    }
                });
            }

            let totalUnread = 0;
            dmConversations.forEach(conv => {
                if (conv.conversationId !== conversationId) {
                    if (conv.unread && conv.lastMessage?.sender !== displayName) {
                        totalUnread++;
                    }
                }
            });
            updateDMBadge(totalUnread);
        }

        function setupDMListener() {
            try {
                directMessagesRef.on('child_changed', (snapshot) => {
                    try {
                        const convId = snapshot.key;
                        const data = snapshot.val();

                        if (!data) return;

                        const participants = data.participants || {};
                        const isParticipant = Object.values(participants).some(p =>
                            p && (p.toLowerCase() === displayName.toLowerCase() ||
                            p.toLowerCase() === currentUsername.toLowerCase())
                        );

                        if (!isParticipant) return;

                        if (data.lastMessage && data.lastMessage.sender !== displayName) {
                            const lastRead = dmLastReadTimestamps[convId] || 0;
                            if (data.lastMessage.timestamp > lastRead) {
                                if (!chatOpen || chatMode !== 'dm' || currentDMConversation?.conversationId !== convId) {
                                    playNotificationSound();

                                    if (notificationsEnabled && Notification.permission === 'granted') {
                                        try {
                                            const notification = new Notification('New DM from ' + data.lastMessage.sender, {
                                                body: (data.lastMessage.text || '').substring(0, 100),
                                                tag: 'bsn9b-dm-' + convId
                                            });
                                            notification.onclick = () => {
                                                window.focus();
                                                if (!chatOpen) toggleChat();
                                                switchChatMode('dm');
                                                startDMConversation(data.lastMessage.sender);
                                                notification.close();
                                            };
                                        } catch (notifErr) {
                                            console.log('Notification error:', notifErr);
                                        }
                                    }
                                }

                                if (chatOpen && chatMode === 'dm' && !currentDMConversation) {
                                    loadDMConversations();
                                }
                            }
                        }
                    } catch (innerErr) {
                        console.error('DM listener inner error:', innerErr);
                    }
                });
            } catch (e) {
                console.error('Error setting up DM listener:', e);
            }
        }

        setupDMListener();

        // Track online presence
        const myPresence = presenceRef.push();
        myPresence.set({
            user: displayName,
            username: currentUsername,
            online: true
        });
        myPresence.onDisconnect().remove();

        let userListVisible = false;
        function toggleUserList() {
            userListVisible = !userListVisible;
            document.getElementById('userList').style.display = userListVisible ? 'block' : 'none';
        }

        // Store online users for @mention autocomplete
        let onlineUsers = [];

        presenceRef.on('value', (snapshot) => {
            const count = snapshot.numChildren();
            document.getElementById('onlineCount').textContent = count + ' online (click to see)';

            onlineUsers = [];
            snapshot.forEach((child) => {
                const data = child.val();
                if (data.user) {
                    onlineUsers.push(data.user);
                }
            });

            document.getElementById('userListNames').innerHTML = onlineUsers.length > 0
                ? onlineUsers.map(u => `<div style="padding: 4px 0; cursor: pointer;" onclick="insertMention('${u}')" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">‚Ä¢ ${u} <span style="font-size:10px;opacity:0.6;">(click to @mention)</span></div>`).join('')
                : '<div style="opacity: 0.7;">No users online</div>';
        });

        function insertMention(username) {
            const input = document.getElementById('chatInput');
            input.value = '@' + username + ' ' + input.value;
            input.focus();
            document.getElementById('userList').style.display = 'none';
            userListVisible = false;
        }

        // ========== @MENTION AUTOCOMPLETE ==========
        let allRegisteredUsers = [];
        let mentionDropdownIndex = -1;
        const USER_CACHE_KEY = 'bsn9b_users_cache';
        const USER_CACHE_EXPIRY = 10 * 60 * 1000; // 10 minutes

        async function fetchAllUsers() {
            try {
                // Check cache first
                const cached = localStorage.getItem(USER_CACHE_KEY);
                if (cached) {
                    const { users, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < USER_CACHE_EXPIRY) {
                        allRegisteredUsers = users;
                        console.log('Loaded', allRegisteredUsers.length, 'users from cache');
                        return;
                    }
                }

                // Fetch fresh data
                const response = await fetch('https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec?action=getUsers');
                const data = await response.json();
                if (data.success && data.users) {
                    allRegisteredUsers = data.users
                        .filter(u => u.name && u.name.trim())
                        .map(u => ({
                            name: u.name.trim(),
                            firstName: u.name.trim().split(' ')[0],
                            email: u.email || ''
                        }));

                    // Cache the results
                    localStorage.setItem(USER_CACHE_KEY, JSON.stringify({
                        users: allRegisteredUsers,
                        timestamp: Date.now()
                    }));
                    console.log('Loaded', allRegisteredUsers.length, 'users from API, cached');
                }
            } catch (e) {
                console.log('Could not fetch users for @mention:', e);
                // Try to use expired cache as fallback
                const cached = localStorage.getItem(USER_CACHE_KEY);
                if (cached) {
                    allRegisteredUsers = JSON.parse(cached).users || [];
                    console.log('Using expired cache as fallback');
                }
            }
        }

        fetchAllUsers();

        const chatInput = document.getElementById('chatInput');
        const mentionDropdown = document.getElementById('mentionDropdown');

        if (chatInput) chatInput.addEventListener('input', function(e) {
            const value = this.value;
            const cursorPos = this.selectionStart;
            const textBeforeCursor = value.substring(0, cursorPos);
            const atMatch = textBeforeCursor.match(/@(\w*)$/);

            if (atMatch) {
                const searchTerm = atMatch[1].toLowerCase();
                showMentionDropdown(searchTerm);
            } else {
                hideMentionDropdown();
            }
        });

        if (chatInput) chatInput.addEventListener('keydown', function(e) {
            if (mentionDropdown.style.display === 'none') return;

            const items = mentionDropdown.querySelectorAll('.mention-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                mentionDropdownIndex = Math.min(mentionDropdownIndex + 1, items.length - 1);
                updateMentionHighlight(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                mentionDropdownIndex = Math.max(mentionDropdownIndex - 1, 0);
                updateMentionHighlight(items);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                if (mentionDropdownIndex >= 0 && items[mentionDropdownIndex]) {
                    e.preventDefault();
                    selectMention(items[mentionDropdownIndex].dataset.name);
                }
            } else if (e.key === 'Escape') {
                hideMentionDropdown();
            }
        });

        function showMentionDropdown(searchTerm) {
            const onlineSet = new Set(onlineUsers.map(u => u.toLowerCase()));
            let matches = [];

            onlineUsers.forEach(u => {
                if (u.toLowerCase().includes(searchTerm)) {
                    matches.push({ name: u, online: true });
                }
            });

            allRegisteredUsers.forEach(u => {
                const firstName = u.firstName;
                const fullName = u.name;
                if (!onlineSet.has(firstName.toLowerCase()) &&
                    (firstName.toLowerCase().includes(searchTerm) || fullName.toLowerCase().includes(searchTerm))) {
                    matches.push({ name: firstName, fullName: fullName, online: false });
                }
            });

            matches = matches.slice(0, 8);

            if (matches.length === 0) {
                hideMentionDropdown();
                return;
            }

            mentionDropdownIndex = 0;
            mentionDropdown.innerHTML = matches.map((m, i) => `
                <div class="mention-item" data-name="${m.name}"
                     style="padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; ${i === 0 ? 'background: #f0f7ff;' : ''}"
                     onclick="selectMention('${m.name}')"
                     onmouseover="this.style.background='#f0f7ff'"
                     onmouseout="this.style.background='${i === mentionDropdownIndex ? '#f0f7ff' : 'transparent'}'">
                    <span style="font-weight: 500;">@${m.name}${m.fullName && m.fullName !== m.name ? ' <span style="color:#888;font-weight:normal;">(' + m.fullName + ')</span>' : ''}</span>
                    ${m.online ? '<span style="font-size: 10px; background: #22c55e; color: white; padding: 2px 6px; border-radius: 10px;">online</span>' : ''}
                </div>
            `).join('');

            mentionDropdown.style.display = 'block';
        }

        function hideMentionDropdown() {
            mentionDropdown.style.display = 'none';
            mentionDropdownIndex = -1;
        }

        function updateMentionHighlight(items) {
            items.forEach((item, i) => {
                item.style.background = i === mentionDropdownIndex ? '#f0f7ff' : 'transparent';
            });
        }

        function selectMention(name) {
            const input = chatInput;
            const value = input.value;
            const cursorPos = input.selectionStart;

            const textBeforeCursor = value.substring(0, cursorPos);
            const atIndex = textBeforeCursor.lastIndexOf('@');

            if (atIndex !== -1) {
                const newValue = value.substring(0, atIndex) + '@' + name + ' ' + value.substring(cursorPos);
                input.value = newValue;

                const newCursorPos = atIndex + name.length + 2;
                input.setSelectionRange(newCursorPos, newCursorPos);
            }

            hideMentionDropdown();
            input.focus();
        }

        document.addEventListener('click', function(e) {
            if (chatInput && mentionDropdown && !chatInput.contains(e.target) && !mentionDropdown.contains(e.target)) {
                hideMentionDropdown();
            }
        });
        // ========== END CHAT SYSTEM ==========

        // Current filter
        let currentCategory = 'all';

        // Theme functions
        function initTheme() {
            const saved = localStorage.getItem('bsn9b_theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcon();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('bsn9b_theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const themeMenuIcon = document.getElementById('themeMenuIcon');
            const themeMenuText = document.getElementById('themeMenuText');
            if (themeMenuIcon) {
                themeMenuIcon.innerHTML = isDark ? '&#9728;&#65039;' : '&#127769;';
            }
            if (themeMenuText) {
                themeMenuText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            }
        }

        // More menu toggle
        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const isExpanded = menu.classList.toggle('show');
            if (moreBtn) {
                moreBtn.setAttribute('aria-expanded', isExpanded);
            }
        }

        // Close more menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const moreBtnClicked = e.target.closest('.toolbar-item');
            if (!menu.contains(e.target) && (!moreBtnClicked || !moreBtnClicked.onclick?.toString().includes('toggleMoreMenu'))) {
                menu.classList.remove('show');
                if (moreBtn) {
                    moreBtn.setAttribute('aria-expanded', 'false');
                }
            }
        });

        // Lock/Unlock
        function lockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'flex';
        }

        function unlockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'none';
        }

        // Logout
        function logout() {
            auth.signOut().then(() => {
                localStorage.removeItem('bsn9b_auth');
                localStorage.removeItem('bsn9b_user');
                localStorage.removeItem('bsn9b_displayName');
                localStorage.removeItem('bsn9b_uid');
                window.location.href = '/';
            });
        }

        // Posts functions
        function showCreatePostModal() {
            document.getElementById('createPostModal').classList.remove('hidden');
        }

        function hideCreatePostModal() {
            document.getElementById('createPostModal').classList.add('hidden');
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
        }

        function createPost(event) {
            event.preventDefault();
            const title = document.getElementById('postTitle').value.trim();
            const category = document.getElementById('postCategory').value;
            const content = document.getElementById('postContent').value.trim();

            if (!title || !content) return;

            postsRef.push({
                title: title,
                content: content,
                category: category,
                author: displayName,
                authorEmail: currentUsername,
                pinned: false,
                createdAt: Date.now(),
                likes: 0,
                comments: 0
            });

            hideCreatePostModal();
        }

        function filterCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderPosts();
        }

        function formatTimeAgo(timestamp) {
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return minutes + ' min ago';
            if (hours < 24) return hours + ' hr ago';
            return days + ' days ago';
        }

        function getCategoryBadge(category) {
            const badges = {
                announcement: '<span class="post-badge badge-announcement">Announcement</span>',
                blog: '<span class="post-badge badge-blog">Study Tips</span>',
                career: '<span class="post-badge badge-career">Career</span>',
                nclex: '<span class="post-badge badge-nclex">NCLEX</span>'
            };
            return badges[category] || '';
        }

        let allPosts = [];

        function renderPosts() {
            const pinnedContainer = document.getElementById('pinnedPosts');
            const feedContainer = document.getElementById('postsFeed');
            const pinnedSection = document.getElementById('pinnedSection');

            let filteredPosts = allPosts;
            if (currentCategory !== 'all') {
                filteredPosts = allPosts.filter(p => p.category === currentCategory);
            }

            const pinned = filteredPosts.filter(p => p.pinned);
            const regular = filteredPosts.filter(p => !p.pinned);

            // Pinned posts
            if (pinned.length > 0) {
                pinnedSection.style.display = 'block';
                pinnedContainer.innerHTML = pinned.map(post => createPostCard(post, true)).join('');
            } else {
                pinnedSection.style.display = 'none';
            }

            // Regular posts
            if (regular.length > 0) {
                feedContainer.innerHTML = regular.map(post => createPostCard(post, false)).join('');
            } else {
                feedContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">&#128221;</div>
                        <h3>No posts yet</h3>
                        <p>Be the first to share something with the community!</p>
                    </div>
                `;
            }
        }

        function createPostCard(post, isPinned) {
            return `
                <div class="post-card ${isPinned ? 'pinned' : ''}">
                    <div class="post-header">
                        <div>
                            <div class="post-title">${isPinned ? '&#128204; ' : ''}${escapeHtml(post.title)}</div>
                            <div class="post-meta">By ${escapeHtml(post.author)} - ${formatTimeAgo(post.createdAt)}</div>
                        </div>
                        ${getCategoryBadge(post.category)}
                    </div>
                    <div class="post-content">${escapeHtml(post.content).substring(0, 300)}${post.content.length > 300 ? '...' : ''}</div>
                    <div class="post-footer">
                        <div class="post-actions">
                            <button class="post-action" onclick="likePost('${post.id}')">
                                &#10084;&#65039; ${post.likes || 0}
                            </button>
                            <button class="post-action" onclick="toggleComments('${post.id}')">
                                &#128172; ${post.comments || 0}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function likePost(postId) {
            const postRef = database.ref('community/posts/' + postId + '/likes');
            postRef.transaction(current => (current || 0) + 1);
        }

        function toggleComments(postId) {
            // TODO: Implement comment expansion
            showToast('Comments coming soon!', 'info');
        }

        // Load posts
        postsRef.orderByChild('createdAt').on('value', (snapshot) => {
            allPosts = [];
            snapshot.forEach(child => {
                allPosts.push({ id: child.key, ...child.val() });
            });
            allPosts.reverse(); // Newest first
            renderPosts();
        });

        // ========== AI NURSING COMPANION ==========
        const AI_API_URL = 'https://script.google.com/macros/s/AKfycbwJZ_2LLB4omX9sGWy1HA_GZx71L_evx1UbKnnq0e4Hg4_-lHTN90iAcf0voB-lCbLd/exec';
        let aiOpen = false;
        let aiConversation = [];

        const AI_SYSTEM_PROMPT = `You are a helpful nursing education assistant for BSN nursing students. Your role is to:
- Explain nursing concepts, procedures, and pathophysiology clearly
- Provide drug information including mechanism, side effects, and nursing considerations
- Help develop care plans using NANDA-I diagnoses, NIC interventions, and NOC outcomes
- Generate NCLEX-style practice questions with detailed rationales
- Explain lab values and their clinical significance
- Guide through clinical scenarios and critical thinking

Important guidelines:
- Always emphasize this is for EDUCATIONAL purposes only, not actual patient care
- Encourage students to verify information with their instructors and official resources
- Be concise but thorough - nursing students are busy
- Use proper medical terminology while explaining in accessible terms
- When discussing medications, always mention common nursing considerations
- For NCLEX questions, provide the answer AND detailed rationales for all options`;

        function toggleAI() {
            aiOpen = !aiOpen;
            const aiBox = document.getElementById('aiBox');
            if (aiOpen) {
                aiBox.style.display = 'flex';
                document.getElementById('aiInput').focus();
            } else {
                aiBox.style.display = 'none';
            }
            document.getElementById('aiToggle').style.transform = aiOpen ? 'scale(0.9)' : 'scale(1)';
        }

        function aiQuickAction(type) {
            const input = document.getElementById('aiInput');
            switch(type) {
                case 'drug':
                    input.value = 'Tell me about the medication: ';
                    input.focus();
                    break;
                case 'careplan':
                    input.value = 'Help me create a care plan for a patient with: ';
                    input.focus();
                    break;
                case 'nclex':
                    input.value = 'Give me an NCLEX practice question about: ';
                    input.focus();
                    break;
                case 'labs':
                    input.value = 'Explain the lab value and nursing implications: ';
                    input.focus();
                    break;
            }
        }

        function addAIMessage(text, isUser) {
            const container = document.getElementById('aiMessages');
            const msgDiv = document.createElement('div');
            msgDiv.style.cssText = `
                margin-bottom: 12px;
                display: flex;
                flex-direction: column;
                align-items: ${isUser ? 'flex-end' : 'flex-start'};
            `;

            // Format AI responses with markdown-like styling
            let formattedText = text;
            if (!isUser) {
                // Convert **bold** to <strong>
                formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Convert bullet points
                formattedText = formattedText.replace(/^[\-\‚Ä¢]\s/gm, '‚Ä¢ ');
                // Convert newlines to <br>
                formattedText = formattedText.replace(/\n/g, '<br>');
            }

            msgDiv.innerHTML = `
                <div style="font-size: 10px; color: #888; margin-bottom: 3px;">${isUser ? 'You' : 'ü©∫ AI Assistant'}</div>
                <div style="background: ${isUser ? 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)' : 'linear-gradient(135deg, #0d9488 0%, #14b8a6 100%)'}; color: white; padding: 12px 16px; border-radius: ${isUser ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; max-width: 90%; word-wrap: break-word; font-size: 14px; line-height: 1.5;">
                    ${isUser ? text.replace(/</g, '&lt;').replace(/>/g, '&gt;') : formattedText}
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showAITyping() {
            const container = document.getElementById('aiMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'aiTyping';
            typingDiv.style.cssText = 'margin-bottom: 12px; display: flex; flex-direction: column; align-items: flex-start;';
            typingDiv.innerHTML = `
                <div style="font-size: 10px; color: #888; margin-bottom: 3px;">ü©∫ AI Assistant</div>
                <div style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white; padding: 12px 16px; border-radius: 16px 16px 16px 4px; font-size: 14px;">
                    <span class="typing-dots">Thinking<span>.</span><span>.</span><span>.</span></span>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function hideAITyping() {
            const typing = document.getElementById('aiTyping');
            if (typing) typing.remove();
        }

        async function sendAIMessage(event) {
            event.preventDefault();
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            const sendBtn = document.querySelector('#aiBox button[type="submit"]');

            if (!message) return;

            // Add user message to UI
            addAIMessage(message, true);
            input.value = '';
            if (sendBtn) sendBtn.disabled = true;

            // Add to conversation history
            aiConversation.push({ role: 'user', content: message });

            // Show typing indicator
            showAITyping();

            try {
                const response = await fetch(AI_API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        messages: aiConversation,
                        systemPrompt: AI_SYSTEM_PROMPT
                    })
                });

                const data = await response.json();
                hideAITyping();

                if (data.success && data.response) {
                    addAIMessage(data.response, false);
                    aiConversation.push({ role: 'assistant', content: data.response });

                    // Keep conversation history manageable (last 10 exchanges)
                    if (aiConversation.length > 20) {
                        aiConversation = aiConversation.slice(-20);
                    }
                } else {
                    addAIMessage('Sorry, I encountered an error. Please try again. ' + (data.error || ''), false);
                }
            } catch (error) {
                hideAITyping();
                console.error('AI API Error:', error);
                addAIMessage('Sorry, I could not connect to the AI service. Please check your connection and try again.', false);
            }

            if (sendBtn) sendBtn.disabled = false;
            input.focus();
        }

        // Add typing animation CSS
        const aiStyle = document.createElement('style');
        aiStyle.textContent = `
            .typing-dots span {
                animation: blink 1.4s infinite;
                animation-fill-mode: both;
            }
            .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
            .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
            @keyframes blink {
                0%, 80%, 100% { opacity: 0; }
                40% { opacity: 1; }
            }
        `;
        document.head.appendChild(aiStyle);

        // Initialize
        initTheme();

        // ========== FIREBASE LISTENER CLEANUP ==========
        function cleanupFirebaseListeners() {
            try {
                if (typeof announcementsRef !== 'undefined') announcementsRef.off();
                if (typeof bannedRef !== 'undefined') bannedRef.off();
                if (typeof chatRef !== 'undefined') chatRef.off();
                if (typeof connectedRef !== 'undefined') connectedRef.off();
                if (typeof directMessagesRef !== 'undefined') directMessagesRef.off();
                if (typeof presenceRef !== 'undefined') presenceRef.off();
                if (typeof postsRef !== 'undefined') postsRef.off();
                console.log('Firebase listeners cleaned up');
            } catch (e) {
                console.log('Error cleaning up listeners:', e);
            }
        }

        window.addEventListener('beforeunload', cleanupFirebaseListeners);
        window.addEventListener('pagehide', cleanupFirebaseListeners);

        // ========== KEYBOARD NAVIGATION ==========
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close modals
                document.querySelectorAll('.modal-overlay:not(.hidden)').forEach(m => m.classList.add('hidden'));
                // Close more menu
                const moreMenu = document.getElementById('moreMenu');
                if (moreMenu) moreMenu.classList.remove('show');
                // Close chat box
                const chatBox = document.getElementById('chatBox');
                if (chatBox && chatBox.style.display !== 'none') {
                    chatBox.style.display = 'none';
                    chatOpen = false;
                }
            }
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>

</body>
</html>
