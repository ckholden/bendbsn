<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com https://cdn.emailjs.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; connect-src 'self' https://script.google.com https://*.firebaseio.com https://*.googleapis.com https://formsubmit.co https://en.wikipedia.org wss://*.firebaseio.com; img-src 'self' data: blob: https:;">
    <script>if(location.protocol !== 'https:' && location.hostname !== 'localhost'){location.replace('https:' + location.href.substring(location.protocol.length));}</script>
    <script>
        if (localStorage.getItem('bsn9b_auth') !== 'true') {
            window.location.href = '/';
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#1f4e79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BSN9B">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="icon" type="image/png" href="/favicon.png?v=3">
    <link rel="shortcut icon" href="/favicon.png?v=3">
    <!-- Preconnect hints for faster external resource loading -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="stylesheet" href="/shared/header.css">
    <title>Community Hub - BSN9B</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-page: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #fafafa;
            --bg-input: #fafafa;
            --text-primary: #1a1a2e;
            --text-secondary: #666666;
            --accent: #1f4e79;
            --accent-light: #2d5a87;
            --shadow: rgba(0,0,0,0.4);
            --border: #e0e0e0;
        }

        [data-theme="dark"] {
            --bg-page: linear-gradient(135deg, #0a0a14 0%, #0d1117 50%, #161b22 100%);
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #1e2a3a;
            --bg-input: #16213e;
            --text-primary: #e6e6e6;
            --text-secondary: #aaaaaa;
            --accent: #4a90d9;
            --accent-light: #5a9fe8;
            --shadow: rgba(0,0,0,0.6);
            --border: #2d3748;
        }

        /* Status indicator colors for presence */
        .status-online { background: #22c55e; }  /* Green */
        .status-away { background: #eab308; }    /* Yellow */
        .status-offline { background: #6b7280; } /* Gray */

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }



        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-page);
            min-height: 100vh;
            min-height: 100dvh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }

        .header h1 { font-size: 26px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 13px; }

        .back-btn {
            display: inline-block;
            margin-top: 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        .content {
            background: var(--bg-primary);
            padding: 25px;
            border-radius: 0 0 16px 16px;
        }

        /* Category Tabs */
        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 10px 20px;
            border: 2px solid var(--border);
            background: var(--bg-secondary);
            border-radius: 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .category-tab:hover { border-color: var(--accent); }
        .category-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Post Card */
        .post-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.2s;
        }

        .post-card:hover { box-shadow: 0 4px 15px var(--shadow); }

        .post-card.pinned {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1) 0%, var(--bg-secondary) 100%);
        }

        .post-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .tag-chip {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            background: #eef2ff;
            color: #3730a3;
            font-weight: 600;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .post-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .post-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .post-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-announcement { background: #fef3c7; color: #92400e; }
        .badge-blog { background: #dbeafe; color: #1e40af; }
        .badge-career { background: #d1fae5; color: #065f46; }
        .badge-nclex { background: #fce7f3; color: #9d174d; }
        .badge-question { background: #e0e7ff; color: #3730a3; }
        .badge-general { background: #f3f4f6; color: #374151; }

        .tag-select {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .tag-select label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: #f1f5f9;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #e2e8f0;
        }
        .tag-select input { accent-color: #7c3aed; }

        /* Replies/Comments Section */
        .replies-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            display: none;
        }
        .replies-section.show { display: block; }

        .replies-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .replies-header h4 {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 600;
        }
        .replies-toggle {
            font-size: 12px;
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
        }

        .reply-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .reply-form input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            background: var(--bg-input);
            color: var(--text-primary);
        }
        .reply-form input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .reply-form button {
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .reply-form button:hover { background: var(--accent-light); }

        .reply-item {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent);
        }
        .reply-author {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 4px;
        }
        .reply-content {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.5;
        }
        .reply-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        .replies-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .no-replies {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Post Author Actions (Edit/Delete) */
        .post-author-actions {
            display: flex;
            gap: 4px;
        }
        .post-action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .edit-btn {
            background: #e3f2fd;
            color: #1976d2;
        }
        .edit-btn:hover {
            background: #1976d2;
            color: white;
        }
        .delete-btn {
            background: #ffebee;
            color: #c62828;
        }
        .delete-btn:hover {
            background: #c62828;
            color: white;
        }
        [data-theme="dark"] .edit-btn {
            background: #1e3a5f;
            color: #64b5f6;
        }
        [data-theme="dark"] .edit-btn:hover {
            background: #1976d2;
            color: white;
        }
        [data-theme="dark"] .delete-btn {
            background: #4a1c1c;
            color: #ef5350;
        }
        [data-theme="dark"] .delete-btn:hover {
            background: #c62828;
            color: white;
        }

        /* Confirm Delete Modal */
        .confirm-modal {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .confirm-modal h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        .confirm-modal p {
            margin-bottom: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .confirm-modal .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .confirm-modal .btn-cancel {
            padding: 10px 20px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .confirm-modal .btn-delete {
            padding: 10px 20px;
            background: #c62828;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .post-content {
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .post-actions {
            display: flex;
            gap: 15px;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
            transition: color 0.2s;
        }

        .post-action:hover { color: var(--accent); }

        /* Create Post Button */
        .create-post-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .create-post-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
        }

        .section-header h2 {
            font-size: 18px;
            color: var(--accent);
        }

        /* Bottom Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 10px;
            transition: color 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .toolbar-item:hover { color: var(--accent); }
        .toolbar-item.active { color: var(--accent); }
        .toolbar-item .icon { font-size: 24px; margin-bottom: 2px; }
        .toolbar-item .label { font-weight: 600; }

        /* More Menu */
        .more-menu {
            position: fixed;
            bottom: 70px;
            right: 10px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 8px 0;
            display: none;
            z-index: 1001;
            min-width: 160px;
            border: 1px solid var(--border);
        }

        .more-menu.show { display: block; }

        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
        }

        .more-menu-item:hover { background: var(--bg-secondary); }
        .more-menu-item .menu-icon { font-size: 18px; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.hidden { display: none; }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            color: var(--text-primary);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .modal-content textarea { min-height: 150px; resize: vertical; }

        /* Lock screen */
        #lockScreenOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 99999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon { font-size: 48px; margin-bottom: 15px; }
        .empty-state h3 { color: var(--text-primary); margin-bottom: 10px; }

        /* Comments */
        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .comment {
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .comment-author {
            font-weight: 600;
            font-size: 12px;
            color: var(--accent);
        }

        .comment-text {
            font-size: 13px;
            color: var(--text-primary);
            margin-top: 4px;
        }

        .comment-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        @media (max-width: 600px) {
            .category-tabs { gap: 6px; }
            .category-tab { padding: 8px 14px; font-size: 12px; }
            .post-title { font-size: 16px; }
        }

        /* Focus visible styles for keyboard navigation */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        button:focus-visible, a:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* ========== MOBILE RESPONSIVE STYLES ========== */

        /* Smooth scrolling and touch-friendly */
        html { scroll-behavior: smooth; }
        .posts-container {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* Minimum touch target size */
        @media (pointer: coarse) {
            button, .btn, .toolbar-item, .more-menu-item, .category-tab {
                min-height: 44px;
            }
        }



        /* Small phones */
        @media (max-width: 480px) {
            input, select, textarea {
                font-size: 16px !important;
            }

            .post-card { padding: 15px; }
            .category-tabs { flex-wrap: wrap; gap: 8px; }
        }

        /* Landscape orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .bottom-toolbar { height: 50px; }
            .toolbar-item .label { display: none; }
        }

        /* Safe area insets for bottom toolbar */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-toolbar {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(60px + env(safe-area-inset-bottom));
            }
        }

        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; max-width: 380px; }
        .toast { padding: 14px 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); display: flex; align-items: flex-start; gap: 12px; animation: toastSlideIn 0.3s ease; color: white; font-size: 14px; line-height: 1.4; }
        .toast.hiding { animation: toastSlideOut 0.3s ease forwards; }
        .toast-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .toast-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .toast-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .toast-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .toast-icon { font-size: 18px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-message { opacity: 0.95; }
        .toast-close { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; font-size: 18px; padding: 0; line-height: 1; }
        .toast-close:hover { opacity: 1; }
        @keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @media (max-width: 480px) { .toast-container { left: 10px; right: 10px; max-width: none; } }
    </style>
</head>
<body>
    <header class="site-header">
        <a href="/home/" class="logo-link"><img src="/logo.png" alt="BendBSN" class="site-logo"></a>
    </header>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Alert/FYI Banners - Fixed at top -->
    <div id="alertBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 10000; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5); animation: softFlashAlert 2s ease-in-out infinite;">
        <span id="alertText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.8;">‚ö†Ô∏è ALERT</span>
    </div>
    <div id="fyiBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a1a2e; padding: 12px 20px; text-align: center; font-weight: 600; font-size: 14px; z-index: 9999; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); animation: softFlashFyi 2s ease-in-out infinite;">
        <span id="fyiText"></span>
        <span style="position: absolute; right: 15px; font-size: 11px; opacity: 0.7;">‚ÑπÔ∏è FYI</span>
    </div>
    <style>
        @keyframes softFlashAlert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        @keyframes softFlashFyi {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        body.has-alert { padding-top: 50px; }
        body.has-fyi { padding-top: 50px; }
        body.has-alert.has-fyi { padding-top: 100px; }
    </style>

    <!-- Lock Screen Overlay -->
    <div id="lockScreenOverlay">
        <div style="text-align: center; color: white;">
            <div style="font-size: 80px; margin-bottom: 20px;">&#128274;</div>
            <h1 style="font-size: 42px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">BSN9B</h1>
            <p style="font-size: 18px; opacity: 0.8; margin-bottom: 40px;">Portal Locked</p>
            <button onclick="unlockScreen()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 18px 50px; border-radius: 30px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);">&#128275; Unlock Portal</button>
            <p style="margin-top: 30px; font-size: 12px; opacity: 0.5;">Click unlock to return to your session</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Community Hub</h1>
            <p>Announcements | Study Tips | Career Resources | NCLEX Prep</p>
            <a href="/home/" class="back-btn">Back to Home</a>
        </div>

        <div class="content">
            <!-- Search Bar -->
            <div class="search-bar" style="margin-bottom: 15px;">
                <input type="text" id="postSearchInput" placeholder="Search posts by title or content..."
                    oninput="searchPosts(this.value)"
                    style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 25px; font-size: 14px; background: var(--bg-input); color: var(--text-primary);">
            </div>

            <!-- Category Tabs -->
            <div class="category-tabs" role="tablist" aria-label="Post categories">
                <button class="category-tab active" role="tab" aria-selected="true" onclick="filterCategory('all')">All</button>
                <button class="category-tab" role="tab" aria-selected="false" onclick="filterCategory('announcement')">Announcements</button>
                <button class="category-tab" role="tab" aria-selected="false" onclick="filterCategory('blog')">Study Tips</button>
                <button class="category-tab" role="tab" aria-selected="false" onclick="filterCategory('career')">Career</button>
                <button class="category-tab" role="tab" aria-selected="false" onclick="filterCategory('nclex')">NCLEX</button>
                <button class="category-tab" role="tab" aria-selected="false" onclick="filterCategory('question')">Questions</button>
                <button class="category-tab" role="tab" aria-selected="false" onclick="filterCategory('general')">General</button>
            </div>

            <!-- Create Post Button -->
            <button class="create-post-btn" onclick="showCreatePostModal()">
                <span>+</span> Create Post
            </button>

            <!-- Bulletin Board Section -->
            <div id="pinnedSection" style="display: none;">
                <div class="section-header">
                    <span>&#128227;</span>
                    <h2>Bulletin Board</h2>
                </div>
                <div id="pinnedPosts"></div>
            </div>

            <!-- Posts Feed -->
            <div class="section-header">
                <span>&#128240;</span>
                <h2>Latest Posts</h2>
            </div>
            <div id="postsFeed">
                <div class="empty-state">
                    <div class="icon">&#128221;</div>
                    <h3>No posts yet</h3>
                    <p>Be the first to share something with the community!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 20px;">Create Post</h2>
                <button onclick="hideCreatePostModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
            </div>
            <form onsubmit="createPost(event)">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Title</label>
                <input type="text" id="postTitle" required placeholder="Enter post title">

                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Category</label>
                <select id="postCategory" required>
                    <option value="announcement">Announcements</option>
                    <option value="blog" selected>Study Tips</option>
                    <option value="career">Career</option>
                    <option value="nclex">NCLEX</option>
                    <option value="question">Questions</option>
                    <option value="general">General</option>
                </select>

                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Tags (optional)</label>
                <div class="tag-select" id="postTags">
                    <label><input type="checkbox" value="clinical"> Clinical</label>
                    <label><input type="checkbox" value="meds"> Meds</label>
                    <label><input type="checkbox" value="care-plans"> Care Plans</label>
                    <label><input type="checkbox" value="nclex"> NCLEX</label>
                    <label><input type="checkbox" value="skills"> Skills</label>
                    <label><input type="checkbox" value="documentation"> Documentation</label>
                    <label><input type="checkbox" value="rotations"> Rotations</label>
                    <label><input type="checkbox" value="study"> Study</label>
                </div>

                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Content</label>
                <textarea id="postContent" required placeholder="Share your thoughts, tips, or questions..."></textarea>

                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Publish Post</button>
            </form>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 20px;">Send Feedback</h2>
                <button onclick="document.getElementById('feedbackModal').classList.add('hidden')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
            </div>
            <form action="https://formsubmit.co/christiankholden@gmail.com" method="POST">
                <input type="hidden" name="_subject" value="BSN9B Feedback">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_template" value="table">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Type</label>
                <select name="type" required>
                    <option value="bug">Bug Report</option>
                    <option value="feature">Feature Request</option>
                    <option value="feedback" selected>General Feedback</option>
                </select>
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Your Name</label>
                <input type="text" name="name" required placeholder="Enter your name">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Message</label>
                <textarea name="message" required placeholder="Describe your feedback..."></textarea>
                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Send Feedback</button>
            </form>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div id="editPostModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 20px;">Edit Post</h2>
                <button onclick="hideEditPostModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
            </div>
            <form onsubmit="saveEditedPost(event)">
                <input type="hidden" id="editPostId">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Title</label>
                <input type="text" id="editPostTitle" required placeholder="Enter post title">

                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Category</label>
                <select id="editPostCategory" required>
                    <option value="announcement">Announcements</option>
                    <option value="blog">Study Tips</option>
                    <option value="career">Career</option>
                    <option value="nclex">NCLEX</option>
                    <option value="question">Questions</option>
                    <option value="general">General</option>
                </select>

                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Tags (optional)</label>
                <div class="tag-select" id="editPostTags">
                    <label><input type="checkbox" value="clinical"> Clinical</label>
                    <label><input type="checkbox" value="meds"> Meds</label>
                    <label><input type="checkbox" value="care-plans"> Care Plans</label>
                    <label><input type="checkbox" value="nclex"> NCLEX</label>
                    <label><input type="checkbox" value="skills"> Skills</label>
                    <label><input type="checkbox" value="documentation"> Documentation</label>
                    <label><input type="checkbox" value="rotations"> Rotations</label>
                    <label><input type="checkbox" value="study"> Study</label>
                </div>

                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Content</label>
                <textarea id="editPostContent" required placeholder="Share your thoughts, tips, or questions..."></textarea>

                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deletePostModal" class="modal-overlay hidden">
        <div class="confirm-modal">
            <h3>Delete Post?</h3>
            <p>This action cannot be undone. All replies will also be deleted.</p>
            <input type="hidden" id="deletePostId">
            <div class="btn-group">
                <button class="btn-cancel" onclick="hideDeletePostModal()">Cancel</button>
                <button class="btn-delete" onclick="confirmDeletePost()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Bottom Toolbar -->
    <nav class="bottom-toolbar" role="navigation" aria-label="Main navigation">
        <a href="/home/" class="toolbar-item" aria-label="Home">
            <span class="icon" aria-hidden="true">&#127968;</span>
            <span class="label">Home</span>
        </a>
        <a href="/app/" class="toolbar-item" aria-label="RN Notes">
            <span class="icon" aria-hidden="true">&#128221;</span>
            <span class="label">RN Notes</span>
        </a>
        <a href="/chat/" class="toolbar-item" aria-label="Chat" target="_blank" style="position:relative;">
            <span class="icon" aria-hidden="true">üí¨</span>
            <span class="label">Chat</span>
            <span id="chatNavBadge" style="display:none;position:absolute;top:2px;right:2px;background:#e94560;color:white;border-radius:50%;width:16px;height:16px;font-size:9px;font-weight:bold;line-height:16px;text-align:center;">0</span>
        </a>
        <a href="/ai/" class="toolbar-item" aria-label="AI Assistant" target="_blank">
            <span class="icon" aria-hidden="true">ü©∫</span>
            <span class="label">AI</span>
        </a>
        <a href="/community/" class="toolbar-item active" aria-label="Community" aria-current="page">
            <span class="icon" aria-hidden="true">&#128101;</span>
            <span class="label">Community</span>
        </a>
        <a href="/resources/" class="toolbar-item" aria-label="Resources">
            <span class="icon" aria-hidden="true">&#128218;</span>
            <span class="label">Resources</span>
        </a>
        <button class="toolbar-item" onclick="toggleMoreMenu()" aria-label="More options" aria-expanded="false" aria-controls="moreMenu">
            <span class="icon" aria-hidden="true">&#8943;</span>
            <span class="label">More</span>
        </button>
    </nav>

    <!-- More Menu -->
    <div id="moreMenu" class="more-menu" role="menu" aria-label="Additional options">
        <button class="more-menu-item" role="menuitem" onclick="toggleDarkMode(); toggleMoreMenu();">
            <span class="menu-icon" id="themeMenuIcon" aria-hidden="true">&#127769;</span>
            <span id="themeMenuText">Dark Mode</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="lockScreen(); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">&#128274;</span>
            <span>Lock Screen</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="toggleFullscreen(); toggleMoreMenu();" id="fullscreenBtn">
            <span class="menu-icon" aria-hidden="true" id="fullscreenIcon">‚õ∂</span>
            <span id="fullscreenText">Full Screen</span>
        </button>
        <a href="/labsched/" class="more-menu-item" role="menuitem" aria-label="Lab Schedule Generator" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">&#128197;</span>
            <span>Sched Generator</span>
        </a>
        <a href="/apa/" class="more-menu-item" role="menuitem" aria-label="APA Paper Generator" id="apaMenuLink" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">&#128196;</span>
            <span>APA Generator</span>
        </a>
        <a href="/clinical/" class="more-menu-item" role="menuitem" aria-label="Clinical Packet Builder" id="clinicalMenuLink" style="text-decoration: none; color: inherit;">
            <span class="menu-icon" aria-hidden="true">&#128203;</span>
            <span>Clinical Packet</span>
        </a>
        <button class="more-menu-item" role="menuitem" onclick="document.getElementById('feedbackModal').classList.remove('hidden'); toggleMoreMenu();">
            <span class="menu-icon" aria-hidden="true">&#128161;</span>
            <span>Feedback</span>
        </button>
        <button class="more-menu-item" role="menuitem" onclick="logout();">
            <span class="menu-icon" aria-hidden="true">&#128682;</span>
            <span>Logout</span>
        </button>
    </div>





    <script>
        // ========== FULLSCREEN MODE ==========
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                const elem = document.documentElement;
                if (elem.requestFullscreen) elem.requestFullscreen();
                else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                updateFullscreenUI(true);
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                updateFullscreenUI(false);
            }
        }
        function updateFullscreenUI(isFullscreen) {
            const text = document.getElementById('fullscreenText');
            if (text) text.textContent = isFullscreen ? 'Exit Full Screen' : 'Full Screen';
        }
        document.addEventListener('fullscreenchange', () => updateFullscreenUI(!!document.fullscreenElement));
        document.addEventListener('webkitfullscreenchange', () => updateFullscreenUI(!!document.webkitFullscreenElement));

        // ========== TOAST NOTIFICATION SYSTEM ==========
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content"><div class="toast-message">${message.replace(/\n/g, '<br>')}</div></div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, duration);
        }

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAmr2W8mekSPJ2pXM3gz1FvarfSBddpfLM",
            authDomain: "bendbsn-17377.firebaseapp.com",
            databaseURL: "https://bendbsn-17377-default-rtdb.firebaseio.com",
            projectId: "bendbsn-17377",
            storageBucket: "bendbsn-17377.firebasestorage.app",
            messagingSenderId: "762882187702",
            appId: "1:762882187702:web:81c97c9eae005666796117"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const postsRef = database.ref('community/posts');

        const SESSION_KEY = 'bsn9b_session_key';
        const SESSION_START_KEY = 'bsn9b_session_start';
        const SESSION_HEARTBEAT_MS = 60000;
        let sessionHeartbeatTimer = null;
        let sessionValidated = false;

        // Presence/Activity timeout constants
        const IDLE_TIMEOUT = 10 * 60 * 1000;   // 10 minutes ‚Üí Away
        const LOGOUT_TIMEOUT = 30 * 60 * 1000; // 30 minutes ‚Üí Logout
        const LOGOUT_WARNING_TIMEOUT = 25 * 60 * 1000; // 25 minutes ‚Üí Show warning
        const ACTIVITY_DEBOUNCE = 30000;       // Debounce Firebase updates
        let idleTimer = null;
        let logoutTimer = null;
        let logoutWarningTimer = null;
        let activityDebounceTimer = null;
        let lastActivityTime = Date.now();
        let currentPresenceStatus = 'online';
        let myPresenceRef = null;

        function updateSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey || !sessionValidated) return;
            database.ref('loginHistory/' + sessionKey).update({
                lastSeen: Date.now()
            }).catch(() => {});
        }

        function startSessionHeartbeat() {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey) return;
            database.ref('loginHistory/' + sessionKey).once('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val().timestamp) {
                    sessionValidated = true;
                    updateSessionHeartbeat();
                    if (sessionHeartbeatTimer) clearInterval(sessionHeartbeatTimer);
                    sessionHeartbeatTimer = setInterval(updateSessionHeartbeat, SESSION_HEARTBEAT_MS);
                } else {
                    clearSessionTracking();
                }
            }).catch(() => {});
        }

        function endSessionTracking(reason) {
            const sessionKey = localStorage.getItem(SESSION_KEY);
            if (!sessionKey || !sessionValidated) return;
            if (localStorage.getItem('bsn9b_session_end_sent') === 'true') return;
            const start = parseInt(localStorage.getItem(SESSION_START_KEY) || '0', 10);
            const end = Date.now();
            const durationSeconds = start ? Math.max(0, Math.round((end - start) / 1000)) : null;
            const durationMinutes = durationSeconds !== null ? Math.round(durationSeconds / 60) : null;
            localStorage.setItem('bsn9b_session_end_sent', 'true');
            database.ref('loginHistory/' + sessionKey).update({
                sessionEnd: end,
                durationSeconds: durationSeconds,
                durationMinutes: durationMinutes,
                endReason: reason || 'logout'
            }).catch(() => {});
        }

        function clearSessionTracking() {
            localStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(SESSION_START_KEY);
            localStorage.removeItem('bsn9b_session_end_sent');
        }

        // ========== CORE SYSTEM (Auth, Presence, Announcements) ==========
        const presenceRef = database.ref('chat/presence');
        const bannedRef = database.ref('banned');
        const announcementsRef = database.ref('announcements');
        const userProfilesRef = database.ref('userProfiles');

        // Listen for announcements (alert/fyi banners - inside header)
        function setupAnnouncementListener() {
            announcementsRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                const alertBanner = document.getElementById('alertBanner');
                const fyiBanner = document.getElementById('fyiBanner');
                const alertText = document.getElementById('alertText');
                const fyiText = document.getElementById('fyiText');

                // Handle alert banner
                if (data.alert && data.alert.message) {
                    alertText.textContent = data.alert.message;
                    alertBanner.style.display = 'block';
                    document.body.classList.add('has-alert');
                } else {
                    alertBanner.style.display = 'none';
                    document.body.classList.remove('has-alert');
                }

                // Handle FYI banner (offset if alert is showing)
                if (data.fyi && data.fyi.message) {
                    fyiText.textContent = data.fyi.message;
                    fyiBanner.style.display = 'block';
                    fyiBanner.style.top = (data.alert && data.alert.message) ? '50px' : '0';
                    document.body.classList.add('has-fyi');
                } else {
                    fyiBanner.style.display = 'none';
                    document.body.classList.remove('has-fyi');
                }
            });
        }
        setupAnnouncementListener();
        console.log('Firebase initialized for community page');

        // Get display name (first name) - stored when user logs in
        let currentUsername = localStorage.getItem('bsn9b_user') || 'Anonymous';
        let displayName = localStorage.getItem('bsn9b_displayName') || currentUsername;
        let currentUserUid = localStorage.getItem('bsn9b_uid') || '';

        function getCurrentUserEmail() {
            return currentUsername || auth.currentUser?.email || localStorage.getItem('bsn9b_user') || '';
        }

        function getCurrentUserUid() {
            return currentUserUid || auth.currentUser?.uid || localStorage.getItem('bsn9b_uid') || '';
        }

        function syncUserProfile(user) {
            if (!user) return;
            const email = user.email || getCurrentUserEmail();
            const name = displayName || user.displayName || (email ? email.split('@')[0] : 'User');
            const firstName = name.split(' ')[0] || name;
            userProfilesRef.child(user.uid).update({
                email: email,
                displayName: name,
                firstName: firstName,
                updatedAt: Date.now()
            });
        }

        // Verify Firebase Auth state and re-authenticate if needed
        let firebaseAuthReady = false;
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Firebase Auth: Logged in as', user.email);
                firebaseAuthReady = true;
                currentUserUid = user.uid;
                currentUsername = user.email || currentUsername;
                if (user.displayName) {
                    displayName = user.displayName;
                }
                localStorage.setItem('bsn9b_uid', currentUserUid);
                localStorage.setItem('bsn9b_user', currentUsername);
                localStorage.setItem('bsn9b_displayName', displayName);
                syncUserProfile(user);

                // Check user role and hide APA link for instructors
                userProfilesRef.child(user.uid).once('value').then((snap) => {
                    const profile = snap.val();
                    if (profile && profile.role === 'Instructor') {
                        const apaLink = document.getElementById('apaMenuLink');
                        if (apaLink) apaLink.style.display = 'none';
                    }
                });
            } else {
                console.log('Firebase Auth: Not logged in, attempting silent re-auth...');
                if (localStorage.getItem('bsn9b_auth') === 'true') {
                    console.warn('Session exists but Firebase auth lost - may need to re-login');
                }
            }
        });

        // Check if current user is banned
        function checkIfBanned() {
            bannedRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const banned = child.val();
                    if (banned.username === currentUsername || banned.username === displayName) {
                        showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                        localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                        setTimeout(() => { window.location.href = '/'; }, 2000);
                    }
                });
            });
        }
        checkIfBanned();

        // Listen for bans in real-time
        bannedRef.on('child_added', (snapshot) => {
            const banned = snapshot.val();
            if (banned.username === currentUsername || banned.username === displayName) {
                showToast('Your account has been suspended. Reason: ' + (banned.reason || 'Rule violation'), 'error', 5000);
                localStorage.removeItem('bsn9b_auth'); localStorage.removeItem('bsn9b_user'); localStorage.removeItem('bsn9b_displayName'); localStorage.removeItem('bsn9b_uid');
                setTimeout(() => { window.location.href = '/'; }, 2000);
            }
        });

        // ========== PRESENCE SYSTEM ==========
        // Set presence using UID as key (prevents duplicates across tabs)
        function setPresence(status = 'online') {
            const uid = getCurrentUserUid();
            if (!uid) return;

            myPresenceRef = presenceRef.child(uid);
            myPresenceRef.set({
                user: displayName,
                username: currentUsername,
                uid: uid,
                status: status,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
            myPresenceRef.onDisconnect().remove();
            currentPresenceStatus = status;
        }

        // Update status without full rewrite
        function updatePresenceStatus(status) {
            const uid = getCurrentUserUid();
            if (!uid) return;
            presenceRef.child(uid).update({
                status: status,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            }).catch(() => {});
            currentPresenceStatus = status;
        }

        // Activity detection - reset idle timers (debounced)
        function recordActivity() {
            lastActivityTime = Date.now();

            // Reset idle/logout/warning timers immediately (local)
            clearTimeout(idleTimer);
            clearTimeout(logoutTimer);
            clearTimeout(logoutWarningTimer);

            // Set idle timer (10 min)
            idleTimer = setTimeout(() => {
                updatePresenceStatus('away');

                // Set logout timer (additional 20 min = 30 min total)
                logoutTimer = setTimeout(() => {
                    logout(); // Full logout
                }, LOGOUT_TIMEOUT - IDLE_TIMEOUT);
            }, IDLE_TIMEOUT);

            // Set warning timer (25 min = 5 min before logout)
            logoutWarningTimer = setTimeout(() => {
                showToast('You will be logged out in 5 minutes due to inactivity. Move your mouse or press a key to stay logged in.', 'warning', 10000);
            }, LOGOUT_WARNING_TIMEOUT);

            // Debounce Firebase updates (don't spam on every mouse move)
            if (activityDebounceTimer) return;

            // If was away, go back online immediately
            if (currentPresenceStatus === 'away') {
                updatePresenceStatus('online');
            }

            activityDebounceTimer = setTimeout(() => {
                activityDebounceTimer = null;
                // Update lastActive timestamp periodically while active
                const uid = getCurrentUserUid();
                if (currentPresenceStatus === 'online' && uid) {
                    presenceRef.child(uid).update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    }).catch(() => {});
                }
            }, ACTIVITY_DEBOUNCE);
        }

        // Initialize activity listeners
        function initActivityTracking() {
            const events = ['mousedown', 'keydown', 'scroll', 'touchstart', 'mousemove'];
            events.forEach(event => {
                document.addEventListener(event, recordActivity, { passive: true });
            });

            // Also track visibility
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    recordActivity();
                }
            });

            // Start initial timer
            recordActivity();
        }

        // Initialize presence (called after auth check)
        setPresence('online');
        initActivityTracking();

        // Re-establish presence on reconnect (handles multi-tab onDisconnect conflicts)
        database.ref('.info/connected').on('value', (snap) => {
            if (snap.val() === true && currentUsername) setPresence(currentPresenceStatus || 'online');
        });

        // Current filter
        let currentCategory = 'all';

        // Theme functions
        function initTheme() {
            const saved = localStorage.getItem('bsn9b_theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcon();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('bsn9b_theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const themeMenuIcon = document.getElementById('themeMenuIcon');
            const themeMenuText = document.getElementById('themeMenuText');
            if (themeMenuIcon) {
                themeMenuIcon.innerHTML = isDark ? '&#9728;&#65039;' : '&#127769;';
            }
            if (themeMenuText) {
                themeMenuText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            }
        }

        // More menu toggle
        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const isExpanded = menu.classList.toggle('show');
            if (moreBtn) {
                moreBtn.setAttribute('aria-expanded', isExpanded);
            }
        }

        // Close more menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('moreMenu');
            const moreBtn = document.querySelector('[aria-controls="moreMenu"]');
            const moreBtnClicked = e.target.closest('.toolbar-item');
            if (!menu.contains(e.target) && (!moreBtnClicked || !moreBtnClicked.onclick?.toString().includes('toggleMoreMenu'))) {
                menu.classList.remove('show');
                if (moreBtn) {
                    moreBtn.setAttribute('aria-expanded', 'false');
                }
            }
        });

        // Lock/Unlock
        function lockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'flex';
        }

        function unlockScreen() {
            document.getElementById('lockScreenOverlay').style.display = 'none';
        }

        // Logout
        function logout() {
            endSessionTracking('logout');
            cleanupFirebaseListeners();
            // Clean presence before signing out
            const uid = getCurrentUserUid();
            if (uid) {
                presenceRef.child(uid).remove().catch(() => {});
            }
            // Clear idle/logout/warning timers
            clearTimeout(idleTimer);
            clearTimeout(logoutTimer);
            clearTimeout(logoutWarningTimer);
            clearTimeout(activityDebounceTimer);

            auth.signOut().then(() => {
                localStorage.removeItem('bsn9b_auth');
                localStorage.removeItem('bsn9b_user');
                localStorage.removeItem('bsn9b_displayName');
                localStorage.removeItem('bsn9b_uid');
                clearSessionTracking();
                window.location.href = '/';
            });
        }

        // Posts functions
        function showCreatePostModal() {
            document.getElementById('createPostModal').classList.remove('hidden');
        }

        function hideCreatePostModal() {
            document.getElementById('createPostModal').classList.add('hidden');
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            setSelectedTags('postTags', []);
        }

        function getSelectedTags(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
        }

        function setSelectedTags(containerId, tags) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const set = new Set((tags || []).map(t => t.toLowerCase()));
            container.querySelectorAll('input[type="checkbox"]').forEach(i => {
                i.checked = set.has(i.value.toLowerCase());
            });
        }

        function createPost(event) {
            event.preventDefault();
            const title = document.getElementById('postTitle').value.trim();
            const category = document.getElementById('postCategory').value;
            const content = document.getElementById('postContent').value.trim();
            const tags = getSelectedTags('postTags');

            if (!title || !content) return;

            postsRef.push({
                title: title,
                content: content,
                category: category,
                tags: tags,
                author: displayName,
                authorEmail: currentUsername,
                pinned: false,
                createdAt: Date.now(),
                likes: 0,
                comments: 0
            });

            hideCreatePostModal();
        }

        function filterCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderPosts();
        }

        function formatTimeAgo(timestamp) {
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return minutes + ' min ago';
            if (hours < 24) return hours + ' hr ago';
            return days + ' days ago';
        }

        function getCategoryBadge(category) {
            const badges = {
                announcement: '<span class="post-badge badge-announcement">Announcement</span>',
                blog: '<span class="post-badge badge-blog">Study Tips</span>',
                career: '<span class="post-badge badge-career">Career</span>',
                nclex: '<span class="post-badge badge-nclex">NCLEX</span>',
                question: '<span class="post-badge badge-question">Question</span>',
                general: '<span class="post-badge badge-general">General</span>'
            };
            return badges[category] || '<span class="post-badge badge-general">General</span>';
        }

        let allPosts = [];
        let searchTerm = '';

        function searchPosts(term) {
            searchTerm = term.toLowerCase().trim();
            renderPosts();
        }

        function renderPosts() {
            const pinnedContainer = document.getElementById('pinnedPosts');
            const feedContainer = document.getElementById('postsFeed');
            const pinnedSection = document.getElementById('pinnedSection');

            let filteredPosts = allPosts;

            // Filter by category
            if (currentCategory !== 'all') {
                filteredPosts = filteredPosts.filter(p => p.category === currentCategory);
            }

            // Filter by search term
            if (searchTerm) {
                filteredPosts = filteredPosts.filter(p => {
                    const tags = (p.tags || []).join(' ').toLowerCase();
                    return (
                        p.title.toLowerCase().includes(searchTerm) ||
                        p.content.toLowerCase().includes(searchTerm) ||
                        p.author.toLowerCase().includes(searchTerm) ||
                        tags.includes(searchTerm)
                    );
                });
            }

            const bulletin = filteredPosts.filter(p => p.pinned || p.category === 'announcement');
            const bulletinIds = new Set(bulletin.map(p => p.id));
            const regular = filteredPosts.filter(p => !bulletinIds.has(p.id));

            // Bulletin board (pinned + announcements)
            if (bulletin.length > 0) {
                const sorted = bulletin.sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return (b.createdAt || 0) - (a.createdAt || 0);
                });
                pinnedSection.style.display = 'block';
                pinnedContainer.innerHTML = sorted.map(post => createPostCard(post, post.pinned)).join('');
            } else {
                pinnedSection.style.display = 'none';
            }

            // Regular posts
            if (regular.length > 0) {
                feedContainer.innerHTML = regular.map(post => createPostCard(post, false)).join('');
            } else {
                feedContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">&#128221;</div>
                        <h3>No posts yet</h3>
                        <p>Be the first to share something with the community!</p>
                    </div>
                `;
            }
        }

        function createPostCard(post, isPinned) {
            const replyCount = post.replyCount || 0;
            const isAuthor = post.authorEmail === currentUsername;
            const tagsHtml = (post.tags || []).length
                ? `<div class="post-tags">${post.tags.map(t => `<span class="tag-chip">${escapeHtml(t)}</span>`).join('')}</div>`
                : '';
            const authorActions = isAuthor ? `
                <div class="post-author-actions">
                    <button class="post-action-btn edit-btn" onclick="editPost('${post.id}')" aria-label="Edit post" title="Edit">&#9998;</button>
                    <button class="post-action-btn delete-btn" onclick="deletePost('${post.id}')" aria-label="Delete post" title="Delete">&#128465;</button>
                </div>
            ` : '';
            return `
                <div class="post-card ${isPinned ? 'pinned' : ''}" id="post-${post.id}">
                    <div class="post-header">
                        <div style="flex: 1;">
                            <div class="post-title">${isPinned ? '&#128204; ' : ''}${escapeHtml(post.title)}</div>
                            <div class="post-meta">By ${escapeHtml(post.author)} - ${formatTimeAgo(post.createdAt)}${post.editedAt ? ' (edited)' : ''}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${getCategoryBadge(post.category)}
                            ${authorActions}
                        </div>
                    </div>
                    <div class="post-content" id="content-${post.id}">${escapeHtml(post.content).replace(/\n/g, '<br>')}</div>
                    ${tagsHtml}
                    <div class="post-footer">
                        <div class="post-actions">
                            <button class="post-action" onclick="likePost('${post.id}')" aria-label="Like post">
                                &#10084;&#65039; <span id="likes-${post.id}">${post.likes || 0}</span>
                            </button>
                            <button class="post-action" onclick="toggleReplies('${post.id}')" aria-label="View replies" aria-expanded="false">
                                &#128172; <span id="reply-count-${post.id}">${replyCount}</span> Replies
                            </button>
                        </div>
                    </div>
                    <!-- Replies Section -->
                    <div class="replies-section" id="replies-${post.id}">
                        <div class="replies-header">
                            <h4>Replies</h4>
                        </div>
                        <div class="reply-form">
                            <input type="text" id="reply-input-${post.id}" placeholder="Write a reply..." onkeypress="if(event.key==='Enter')submitReply('${post.id}')">
                            <button onclick="submitReply('${post.id}')">Reply</button>
                        </div>
                        <div class="replies-list" id="replies-list-${post.id}">
                            <div class="no-replies">Loading replies...</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function likePost(postId) {
            const postRef = database.ref('community/posts/' + postId + '/likes');
            postRef.transaction(current => (current || 0) + 1);
        }

        // Track which posts have replies expanded
        const expandedReplies = new Set();

        function toggleReplies(postId) {
            const repliesSection = document.getElementById('replies-' + postId);
            const btn = document.querySelector(`[onclick="toggleReplies('${postId}')"]`);

            if (repliesSection.classList.contains('show')) {
                repliesSection.classList.remove('show');
                expandedReplies.delete(postId);
                if (btn) btn.setAttribute('aria-expanded', 'false');
            } else {
                repliesSection.classList.add('show');
                expandedReplies.add(postId);
                if (btn) btn.setAttribute('aria-expanded', 'true');
                loadReplies(postId);
            }
        }

        function loadReplies(postId) {
            const repliesRef = database.ref('community/posts/' + postId + '/replies');
            const repliesList = document.getElementById('replies-list-' + postId);

            repliesRef.orderByChild('createdAt').on('value', (snapshot) => {
                const replies = [];
                snapshot.forEach(child => {
                    replies.push({ id: child.key, ...child.val() });
                });

                if (replies.length === 0) {
                    repliesList.innerHTML = '<div class="no-replies">No replies yet. Be the first to reply!</div>';
                } else {
                    repliesList.innerHTML = replies.map(reply => `
                        <div class="reply-item">
                            <div class="reply-author">${escapeHtml(reply.author)}</div>
                            <div class="reply-content">${escapeHtml(reply.content)}</div>
                            <div class="reply-time">${formatTimeAgo(reply.createdAt)}</div>
                        </div>
                    `).join('');
                }

                // Update reply count
                const countEl = document.getElementById('reply-count-' + postId);
                if (countEl) countEl.textContent = replies.length;

                // Update the post's replyCount in Firebase
                database.ref('community/posts/' + postId + '/replyCount').set(replies.length);
            });
        }

        function submitReply(postId) {
            const input = document.getElementById('reply-input-' + postId);
            const content = input.value.trim();

            if (!content) {
                showToast('Please enter a reply', 'warning');
                return;
            }

            const repliesRef = database.ref('community/posts/' + postId + '/replies');
            repliesRef.push({
                content: content,
                author: displayName,
                authorEmail: currentUsername,
                createdAt: Date.now()
            }).then(() => {
                input.value = '';
                showToast('Reply posted!', 'success');
            }).catch(err => {
                showToast('Failed to post reply', 'error');
                console.error(err);
            });
        }

        // Legacy function name for compatibility
        function toggleComments(postId) {
            toggleReplies(postId);
        }

        // ========== POST EDITING & DELETION ==========
        function editPost(postId) {
            const post = allPosts.find(p => p.id === postId);
            if (!post) {
                showToast('Post not found', 'error');
                return;
            }
            if (post.authorEmail !== currentUsername) {
                showToast('You can only edit your own posts', 'error');
                return;
            }

            document.getElementById('editPostId').value = postId;
            document.getElementById('editPostTitle').value = post.title;
            document.getElementById('editPostCategory').value = post.category;
            document.getElementById('editPostContent').value = post.content;
            setSelectedTags('editPostTags', post.tags || []);
            document.getElementById('editPostModal').classList.remove('hidden');
        }

        function hideEditPostModal() {
            document.getElementById('editPostModal').classList.add('hidden');
            setSelectedTags('editPostTags', []);
        }

        function saveEditedPost(event) {
            event.preventDefault();
            const postId = document.getElementById('editPostId').value;
            const title = document.getElementById('editPostTitle').value.trim();
            const category = document.getElementById('editPostCategory').value;
            const content = document.getElementById('editPostContent').value.trim();
            const tags = getSelectedTags('editPostTags');

            if (!title || !content) {
                showToast('Please fill in all fields', 'warning');
                return;
            }

            database.ref('community/posts/' + postId).update({
                title: title,
                category: category,
                content: content,
                tags: tags,
                editedAt: Date.now()
            }).then(() => {
                hideEditPostModal();
                showToast('Post updated successfully', 'success');
            }).catch(err => {
                showToast('Failed to update post', 'error');
                console.error(err);
            });
        }

        function deletePost(postId) {
            const post = allPosts.find(p => p.id === postId);
            if (!post) {
                showToast('Post not found', 'error');
                return;
            }
            if (post.authorEmail !== currentUsername) {
                showToast('You can only delete your own posts', 'error');
                return;
            }

            document.getElementById('deletePostId').value = postId;
            document.getElementById('deletePostModal').classList.remove('hidden');
        }

        function hideDeletePostModal() {
            document.getElementById('deletePostModal').classList.add('hidden');
        }

        function confirmDeletePost() {
            const postId = document.getElementById('deletePostId').value;

            database.ref('community/posts/' + postId).remove().then(() => {
                hideDeletePostModal();
                showToast('Post deleted', 'success');
            }).catch(err => {
                showToast('Failed to delete post', 'error');
                console.error(err);
            });
        }

        // Load posts
        postsRef.orderByChild('createdAt').on('value', (snapshot) => {
            allPosts = [];
            snapshot.forEach(child => {
                allPosts.push({ id: child.key, ...child.val() });
            });
            allPosts.reverse(); // Newest first
            renderPosts();
        });

        // Initialize
        initTheme();

        // ========== FIREBASE LISTENER CLEANUP ==========
        function cleanupFirebaseListeners() {
            try {
                if (typeof announcementsRef !== 'undefined') announcementsRef.off();
                if (typeof bannedRef !== 'undefined') bannedRef.off();
                if (typeof presenceRef !== 'undefined') presenceRef.off();
                if (typeof postsRef !== 'undefined') postsRef.off();
                console.log('Firebase listeners cleaned up');
            } catch (e) {
                console.log('Error cleaning up listeners:', e);
            }
        }

        window.addEventListener('beforeunload', cleanupFirebaseListeners);
        window.addEventListener('pagehide', cleanupFirebaseListeners);

        // ========== KEYBOARD NAVIGATION ==========
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close modals
                document.querySelectorAll('.modal-overlay:not(.hidden)').forEach(m => m.classList.add('hidden'));
                // Close more menu
                const moreMenu = document.getElementById('moreMenu');
                if (moreMenu) moreMenu.classList.remove('show');
            }
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>
    <script src="/shared/header.js"></script>


</body>
</html>
